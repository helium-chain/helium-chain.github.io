<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>GMP è°ƒåº¦æ¨¡å‹ | Helium</title>
<meta name="keywords" content="golang, Goroutine">
<meta name="description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬">
<meta name="author" content="helium">
<link rel="canonical" href="https://heliu.site/posts/golang/goroutine/mstart/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://heliu.site/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://heliu.site/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://heliu.site/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://heliu.site/apple-touch-icon.png">
<link rel="mask-icon" href="https://heliu.site/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://heliu.site/posts/golang/goroutine/mstart/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="GMP è°ƒåº¦æ¨¡å‹" />
<meta property="og:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://heliu.site/posts/golang/goroutine/mstart/" />
<meta property="og:image" content="https://heliu.site/favicon-32x32.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-07-30T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-07-30T00:00:00+00:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://heliu.site/favicon-32x32.png" />
<meta name="twitter:title" content="GMP è°ƒåº¦æ¨¡å‹"/>
<meta name="twitter:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://heliu.site/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Golang",
      "item": "https://heliu.site/posts/golang/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ç¬¬12ç«  Goroutine",
      "item": "https://heliu.site/posts/golang/goroutine/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "GMP è°ƒåº¦æ¨¡å‹",
      "item": "https://heliu.site/posts/golang/goroutine/mstart/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "GMP è°ƒåº¦æ¨¡å‹",
  "name": "GMP è°ƒåº¦æ¨¡å‹",
  "description": "ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18+ç‰ˆæœ¬",
  "keywords": [
    "golang", "Goroutine"
  ],
  "articleBody": " æœ¬ç¯‡ä»‹ç»Golangç›¸å…³è°ƒåº¦ä»£ç ï¼Œæœ¬ç¯‡ä¹Ÿæ˜¯ç†è§£GMPæ¨¡å‹çš„é‡ç‚¹ç¯‡èŠ‚ã€‚ runtimeÂ·mstart(SB) å·¥ä½œçº¿ç¨‹Mçš„è‡ªæ—‹çŠ¶æ€(spinning)è§£é‡Šï¼šå·¥ä½œçº¿ç¨‹åœ¨ä»å…¶å®ƒå·¥ä½œçº¿ç¨‹çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­ç›—å–goroutineæ—¶çš„çŠ¶æ€ç§°ä¸ºè‡ªæ—‹çŠ¶æ€ã€‚\nè¯¥å‡½æ•°æ˜¯æ‰€æœ‰æ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹éœ€è¦æ‰§è¡Œçš„å‡½æ•°ï¼Œä¹Ÿæ˜¯è°ƒåº¦å¾ªç¯çš„å…¥å£å‡½æ•°ã€‚ æ‰€æœ‰ã€æ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹ã€‘å¼€å§‹è¿è¡Œçš„å…¥å£éƒ½æ˜¯ä»è¿™ä¸ªå‡½æ•°å¼€å§‹è¿è¡Œçš„ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ 389 390 391 392 393 TEXT runtimeÂ·mstart(SB),NOSPLIT|TOPFRAME,$0 # è°ƒç”¨runtime.mstart0å‡½æ•°ï¼Œè¯¥å‡½æ•°æ°¸è¿œä¸ä¼šè¿”å› CALL runtimeÂ·mstart0(SB) # æœªè¾¾åˆ°ã€‚ä¸ä¼šåˆ°è¿™é‡Œæ¥ã€‚ RET # not reached mstart0() mstart0æ˜¯æ–°Msçš„Goå…¥å£ç‚¹ã€‚è¯¥å‡½æ•°æ˜¯ä¸å…è®¸æ ˆå¢é•¿æ£€æŸ¥çš„ï¼Œå› ä¸ºæˆ‘ä»¬ç”šè‡³å¯èƒ½è¿˜æ²¡æœ‰è®¾ç½®å †æ ˆè¾¹ç•Œã€‚ èƒ½åœ¨STWæœŸé—´è¿è¡Œï¼ˆå› ä¸ºå®ƒè¿˜æ²¡æœ‰Pï¼‰ï¼Œæ‰€ä»¥ä¸å…è®¸å†™å±éšœã€‚ åˆå§‹åŒ–g0æ ˆå¤§å°ï¼Œä»¥åŠè°ƒç”¨mstart1()å‡½æ•°å¼€å¯è°ƒåº¦å¾ªç¯ã€‚ å› ä¸ºå¯èƒ½å­˜åœ¨å…¶ä»–åˆšåˆ›å»ºçš„å·¥ä½œçº¿ç¨‹å¹¶æ²¡æœ‰åˆå§‹åŒ–g0æ ˆå¤§å°ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è®¾ç½®ä¸€ä¸‹ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 1347 1348 1349 1350 1351 1352 1353 1354 1355 1356 1357 1358 1359 1360 1361 1362 1363 1364 1365 1366 1367 1368 1369 1370 1371 1372 1373 1374 1375 1376 1377 1378 1379 1380 1381 1382 1383 1384 1385 1386 1387 1388 1389 1390 1391 1392 1393 1394 1395 1396 1397 1398 1399 1400 1401 1402 1403 1404 1405 1406 1407 1408 1409 1410 1411 1412 1413 1414 1415 1416 1417 1418 1419 1420 1421 1422 1423 1424 1425 1426 1427 1428 // mstart0 is the Go entry-point for new Ms. // This must not split the stack because we may not even have stack // bounds set up yet. // // May run during STW (because it doesn't have a P yet), so write // barriers are not allowed. // //go:nosplit //go:nowritebarrierrec func mstart0() { // è¯¥å‡½æ•°æ˜¯å·¥ä½œçº¿ç¨‹Mèµ·æ¥æ‰§è¡Œçš„å…¥å£å‡½æ•°ï¼Œè¿™é‡Œä¸€å®šæ˜¯g0æ ˆã€‚ _g_ := getg() // _g_ = g0 // å½“å‰gæ˜¯å¦å·²åˆ†é…æ ˆï¼š // 1. ç¨‹åºåˆšåˆå§‹åŒ–æ—¶å‰é¢æ˜¯åˆ†é…äº†å¤§çº¦64KBå¤§å°æ ˆã€‚ // 2. å¦‚æœæ˜¯é€šè¿‡wakeup()å‡½æ•°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹ï¼Œè¿™é‡Œå¯èƒ½æ˜¯æ²¡æœ‰åˆ†é…æ ˆå¤§å°çš„ã€‚ osStack := _g_.stack.lo == 0 // åˆ¤æ–­å½“å‰g0æ˜¯å¦åˆ†é…æ ˆ if osStack { // æ ˆæœªåˆ†é…å¤§å°æ—¶ï¼Œè¿™ä¹Ÿæ˜¯æ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹éœ€è¦å¤„ç†çš„gæ ˆæƒ…å†µ // Initialize stack bounds from system stack. // Cgo may have left stack size in stack.hi. // minit may update the stack bounds. // // ä»ç³»ç»Ÿæ ˆåˆå§‹åŒ–æ ˆè¾¹ç•Œã€‚Cgo å¯èƒ½åœ¨ stack.hi ä¸­ç•™ä¸‹äº†æ ˆå¤§å°ã€‚minit å¯èƒ½ä¼šæ›´æ–°æ ˆè¾¹ç•Œã€‚ // // Note: these bounds may not be very accurate. // We set hi to \u0026size, but there are things above // it. The 1024 is supposed to compensate this, // but is somewhat arbitrary. // // æ³¨æ„ï¼šè¿™äº›ç•Œé™å¯èƒ½ä¸æ˜¯å¾ˆå‡†ç¡®ã€‚ // æˆ‘ä»¬å°† hi è®¾ç½®ä¸º \u0026sizeï¼Œä½†æ˜¯ä¸Šé¢è¿˜æœ‰ä¸€äº›ä¸œè¥¿ã€‚ // 1024 åº”è¯¥å¯ä»¥å¼¥è¡¥è¿™ä¸€ç‚¹ï¼Œä½†æœ‰äº›æ­¦æ–­ã€‚ // ä»¥ä¸Šçš„æ„æ€æ˜¯ç›´æ¥åœ¨å½“å‰å·¥ä½œçº¿ç¨‹ç³»ç»Ÿæ ˆä¸Šç»™å½“å‰è¿™ä¸ªg0åˆ†é…æ ˆå¤§å°ã€‚ // å¯èƒ½ä¸Šé¢æœ‰æ ˆæ•°æ®ï¼Œåç§»1024å­—èŠ‚åº”è¯¥èƒ½å¼¥è¡¥è¿™äº›æ•°æ®ã€‚ size := _g_.stack.hi // size å¤šåŠæ˜¯0; size ä¸€å®šæ˜¯åˆ†é…åœ¨å½“å‰æ ˆä¸Šçš„ï¼Œå› æ­¤\u0026sizeå°±æ˜¯æ ˆåœ°å€ã€‚ if size == 0 {\t// sys.StackGuardMultiplier = 1; å¯è§å…¶ä»–å·¥ä½œçº¿ç¨‹çš„g0æ ˆå¤§çº¦ä¸º8KBã€‚ size = 8192 * sys.StackGuardMultiplier // è®¾ç½®sizeä¸ºæŒ‡å®šå€¼ } // noescapeå‡½æ•°å–sizeåœ°å€å¹¶ä¸0å¼‚æˆ–ï¼Œå®é™…ä½œç”¨æ˜¯éšè—(é˜²æ­¢)sizeå˜é‡é€ƒé€¸åˆ†ææŒ‡é’ˆ // é˜²æ­¢ç¼–è¯‘å™¨æŠŠsizeå˜é‡å †åˆ†é…ï¼Œè¿™é‡Œéœ€è¦çš„æ˜¯æ ˆåˆ†é… // å› æ­¤å½“å‰_g_çš„æ ˆå¤‡ä»½åˆ†é…åˆ°å½“å‰æ ˆçš„sizeå˜é‡ä½ç½® // noescapeå‡½æ•°ï¼š // func noescape(p unsafe.Pointer) unsafe.Pointer { // x := uintptr(p) // return unsafe.Pointer(x ^ 0) // é˜²æ­¢å˜é‡xé€ƒé€¸ // } // ä»¥\u0026sizeä¸ºèµ·ç‚¹è®¾ç½®g0æ ˆã€‚g0.stack -\u003e [\u0026size, \u0026size - 8192 + 1024] _g_.stack.hi = uintptr(noescape(unsafe.Pointer(\u0026size))) // hiå­˜å‚¨sizeçš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯rbp _g_.stack.lo = _g_.stack.hi - size + 1024 // loå­˜å‚¨æ ˆé¡¶ä½ç½®ï¼Œä¹Ÿå°±æ˜¯rsp } // Initialize stack guard so that we can start calling regular // Go code. // // åˆå§‹åŒ–æ ˆä¿æŠ¤ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å¼€å§‹è°ƒç”¨å¸¸è§„ Go ä»£ç ã€‚ // stackguard0 = _g_.stack.lo + 928; æ ˆæº¢å‡ºæ£€æŸ¥çš„é˜ˆå€¼ç‚¹ã€‚ _g_.stackguard0 = _g_.stack.lo + _StackGuard // This is the g0, so we can also call go:systemstack // functions, which check stackguard1. // // è¿™æ˜¯ g0ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥è°ƒç”¨ go:systemstack å‡½æ•°æ¥æ£€æŸ¥ stackguard1ã€‚ _g_.stackguard1 = _g_.stackguard0 mstart1() // è°ƒç”¨mstart1å¼€å¯è°ƒåº¦å¾ªç¯ï¼Œè¯¥å‡½æ•°æ°¸è¿œä¸ä¼šè¿”å› // Exit this thread.\t// // é€€å‡ºè¿™ä¸ªçº¿ç¨‹ï¼Œç¨‹åºä¸ä¼šåˆ°è¿™é‡Œã€‚ if mStackIsSystemAllocated() { // Windows, Solaris, illumos, Darwin, AIX and Plan 9 always system-allocate // the stack, but put it in _g_.stack before mstart, // so the logic above hasn't set osStack yet. // // Windowsã€Solarisã€illumosã€Darwinã€AIX å’ŒPlan 9 æ€»æ˜¯ç³»ç»Ÿåˆ†é…æ ˆï¼Œä½†æ˜¯åœ¨mstart ä¹‹å‰æ”¾åœ¨_g_.stack ä¸­ï¼Œ // æ‰€ä»¥ä¸Šé¢çš„é€»è¾‘è¿˜æ²¡æœ‰è®¾ç½®osStack osStack = true } mexit(osStack) // ç»“æŸå½“å‰çº¿ç¨‹ã€‚ } æ€»ç»“ï¼šå·¥ä½œçº¿ç¨‹å¼€å§‹æ‰§è¡Œä½¿ï¼Œå…ˆåˆ¤æ–­g0æ˜¯å¦åˆ†é…äº†æ ˆå¤§å°ï¼Œæ²¡æœ‰åˆ™åˆ†é…å¤§çº¦8KBå¤§å°æ ˆç©ºé—´ï¼Œç„¶åè®¾ç½®stackguard0ã€stackguard1ã€‚ mstart1() è®¾ç½®g0è¢«è°ƒåº¦æ—¶çš„è°ƒåº¦ä¿¡æ¯ï¼Œæ¯”å¦‚ä»å“ªé‡Œè¿›å…¥ï¼Œæ ˆä»å“ªé‡Œå¼€å§‹ç­‰ï¼Œä»¥åŠç»™å½“å‰å·¥ä½œçº¿ç¨‹Mç»‘å®šä¸ªPå¹¶å¼€å¯è°ƒåº¦å¾ªç¯ã€‚ è®¾ç½®g0çš„è°ƒåº¦ä¿¡æ¯æ˜¯åœ¨äºï¼Œåœ¨è°ƒåº¦å¾ªç¯è¿‡ç¨‹ä¸­ä¼šåˆ‡æ¢åˆ°g0æ ˆæ‰§è¡Œruntimeçš„ç›¸å…³å‡½æ•°ï¼Œä»¥å…æ ˆæ— é™æ‰©å¤§ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 1394 1395 1396 1397 1398 1399 1400 1401 1402 1403 1404 1405 1406 1407 1408 1409 1410 1411 1412 1413 1414 1415 1416 1417 1418 1419 1420 1421 1422 1423 1424 1425 1426 1427 1428 1429 1430 1431 1432 1433 1434 1435 1436 1437 1438 1439 1440 1441 1442 1443 1444 1445 1446 1447 1448 1449 1450 1451 1452 1453 1454 1455 1456 1457 1458 1459 // The go:noinline is to guarantee the getcallerpc/getcallersp below are safe, // so that we can set up g0.sched to return to the call of mstart1 above. //go:noinline func mstart1() { _g_ := getg() // _g_ = g0 // å½“å‰_g_ ä¸€å®šæ˜¯g0ï¼Œå› ä¸ºè¯¥å‡½æ•°åªæœ‰ç¨‹åºåˆå§‹åŒ–æˆ–çº¿ç¨‹åˆšå¯åŠ¨æ—¶æ‰ä¼šè°ƒç”¨ã€‚ if _g_ != _g_.m.g0 { throw(\"bad runtimeÂ·mstart\") } // Set up m.g0.sched as a label returning to just // after the mstart1 call in mstart0 above, for use by goexit0 and mcall. // We're never coming back to mstart1 after we call schedule, // so other calls can reuse the current frame. // And goexit0 does a gogo that needs to return from mstart1 // and let mstart0 exit the thread. // // å°† m.g0.sched è®¾ç½®ä¸ºä¸Šé¢ mstart0 ä¸­ mstart1 è°ƒç”¨åè¿”å›çš„æ ‡ç­¾ï¼Œä¾› goexit0 å’Œ mcall ä½¿ç”¨ // åœ¨è°ƒç”¨ schedule ä¹‹åï¼Œæˆ‘ä»¬æ°¸è¿œä¸ä¼šå›åˆ° mstart1ï¼Œå› æ­¤å…¶ä»–è°ƒç”¨å¯ä»¥é‡ç”¨å½“å‰å¸§ // è€Œgoexit0åšäº†ä¸€ä¸ªgogoï¼Œéœ€è¦ä»mstart1è¿”å›ï¼Œè®©mstart0é€€å‡ºçº¿ç¨‹ // g0.sched.g = g0 _g_.sched.g = guintptr(unsafe.Pointer(_g_)) // è®¾ç½®g0çš„è°ƒåº¦ä¿¡æ¯æ˜¯å½“å‰g // g0.sched.pc = getcallerpc() // getcallerpc()ï¼šè°ƒç”¨è€…å‡½æ•°çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯mstart0()å‡½æ•°è°ƒç”¨mstart1()å‡½æ•°åçš„ifåˆ¤æ–­æŒ‡ä»¤ä»£ç å¤„ã€‚ _g_.sched.pc = getcallerpc() // è¿™é‡Œæ˜¯ç†è§£è°ƒåº¦å¾ªç¯çš„å…³é”®ï¼Œè°ƒåº¦å¾ªç¯æ¯æ¬¡åˆ‡æ¢åˆ°g0æ ˆéƒ½ä»è¿™é‡Œ(æŒ‡å®šçš„å›ºå®šä½ç½®)è®¾ç½®çš„ä½ç½®å¼€å§‹ä½¿ç”¨æ ˆã€‚ // g0.sched.pc = getcallersp() // getcallersp()ï¼šè°ƒç”¨è€…å½“å‰çš„SPå¯„å­˜å™¨å€¼ï¼Œä¹Ÿå°±æ˜¯mstart0()å‡½æ•°è°ƒç”¨mstart1()å‡½æ•°æ—¶SPå¯„å­˜å™¨çš„å€¼ã€‚ // è®¾ç½®rspå¯„å­˜å™¨å€¼ä¸ºmaster0è°ƒç”¨master1æ—¶çš„æ ˆé¡¶å¤„ï¼Œè®¾ç½®åœ¨è¿™é‡Œä¾¿äºæ¯æ¬¡åˆ‡æ¢çš„g0æ ˆéƒ½æ˜¯ä»å›ºå®šä½ç½®å¼€å§‹ _g_.sched.sp = getcallersp() // go1.19.3/src/runtime/asm_amd64.s // TEXT runtimeÂ·asminit(SB),NOSPLIT,$0-0 // // No per-thread init. // RET // æ²¡æœ‰ä»€ä¹ˆå¯åšçš„ã€‚ asminit() // è¯¥å‡½æ•°çš„æ±‡ç¼–ä»£ç ä»€ä¹ˆéƒ½æ²¡åšï¼Œåˆå§‹åŒ–Må·¥ä½œçº¿ç¨‹ minit() // è°ƒç”¨ä»¥åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ mï¼ˆåŒ…æ‹¬å¼•å¯¼ç¨‹åº mï¼‰ï¼Œåœ¨æ–°çº¿ç¨‹ä¸Šè°ƒç”¨ï¼Œæ— æ³•åˆ†é…å†…å­˜ // Install signal handlers; after minit so that minit can // prepare the thread to be able to handle the signals. // // å®‰è£…ä¿¡å·å¤„ç†ç¨‹åºï¼› åœ¨ minit ä¹‹åï¼Œä»¥ä¾¿ minit å¯ä»¥å‡†å¤‡çº¿ç¨‹ä»¥å¤„ç†ä¿¡å· if _g_.m == \u0026m0 { // åˆ¤æ–­g0ç»‘å®šçš„mæ˜¯å¦æ˜¯m0ï¼Œm0æ˜¯main.goroutineä¹Ÿå°±æ˜¯ä¸»çº¿ç¨‹æ—¶æ‰§è¡Œä¸‹é¢æ–¹æ³• mstartm0() } // å¦‚æœ_g_.m.mstartfnå­˜åœ¨åˆ™æ‰§è¡Œè¯¥å‡½æ•°ï¼š // 1. ä¸€èˆ¬çš„æƒ…å†µä¸‹è¯¥å‡½æ•°æ˜¯ï¼Œmspinning()å‡½æ•°ã€‚è¯¥å‡½æ•°åªæœ‰ä¸€æ¡æŒ‡ä»¤ï¼Œæ ‡è®°mçš„mspiningå­—æ®µä¸ºtrueã€‚ // 2. å¦‚æœæ˜¯sysmonçº¿ç¨‹ä¸‹ï¼Œè¿™é‡Œæ˜¯ç›´æ¥è°ƒç”¨sysmon()å‡½æ•°ï¼Œè¯¥å‡½æ•°æ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œè¿™é‡Œä¸ä¼šè¿”å›ã€‚ if fn := _g_.m.mstartfn; fn != nil { fn() } // ç¨‹åºåˆšåˆå§‹åŒ–æ—¶ï¼Œä¸€å®šæ˜¯m0ï¼Œå› ä¸ºåœ¨å‰é¢m0å·²ç»ç»‘å®šäº†Pï¼Œæ‰€ä»¥æ˜¯m0éœ€è¦è·³è¿‡ã€‚ // é€šè¿‡wakeup()å‡½æ•°åˆ›å»ºçš„æ–°çš„å·¥ä½œçº¿ç¨‹mæ—¶ï¼Œè¿™é‡Œéœ€è¦ç»‘å®šä¸ªPã€‚ if _g_.m != \u0026m0 { // ä¸æ˜¯m0åˆ™éœ€è¦ç»™å·¥ä½œçº¿ç¨‹Mç»‘å®šä¸€ä¸ªP // _g_.m.nextp.ptr()è·å–ä¸‹ä¸€ä¸ªPï¼Œnextpåœ¨wakeup()å‡½æ•°ç›¸å…³è¢«èµ‹å€¼ã€‚ acquirep(_g_.m.nextp.ptr()) // è°ƒç”¨acquirep(_g_.m.nextp.ptr())ç»‘å®šp _g_.m.nextp = 0 } // å¼€å¯å¾ªç¯è°ƒåº¦ï¼Œè¯¥å‡½æ•°æ°¸è¿œä¸è¿”å› schedule() } minit() åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„mï¼ˆåŒ…æ‹¬å¼•å¯¼ç¨‹åºmï¼‰ã€‚åœ¨æ–°çº¿ç¨‹ä¸Šè°ƒç”¨ï¼Œæ— æ³•åˆ†é…å†…å­˜ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/os_linux.goã€‚ 390 391 392 393 394 395 396 397 398 399 400 // Called to initialize a new m (including the bootstrap m). // Called on the new thread, cannot allocate memory. func minit() { // åˆå§‹åŒ– Signals minitSignals() // Cgo-created threads and the bootstrap m are missing a // procid. We need this for asynchronous preemption and it's // useful in debuggers. getg().m.procid = uint64(gettid()) } æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/signal_unix.goã€‚ 1192 1193 1194 1195 1196 1197 // minitSignals is called when initializing a new m to set the // thread's alternate signal stack and signal mask. func minitSignals() { minitSignalStack() minitSignalMask() } acquirep() å‚æ•°_p_ *pï¼šç©ºé—²çš„påœ¨wakeup()å‡½æ•°æ—¶å­˜å…¥m.nextpå¤„ï¼Œä¾›å·¥ä½œçº¿ç¨‹å¯åŠ¨åç»‘å®šè¿™ä¸ªPã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 4938 4939 4940 4941 4942 4943 4944 4945 4946 4947 4948 4949 4950 4951 4952 4953 4954 4955 4956 4957 4958 4959 // Associate p and the current m. // // This function is allowed to have write barriers even if the caller // isn't because it immediately acquires _p_. // //go:yeswritebarrierrec func acquirep(_p_ *p) { // Do the part that isn't allowed to have write barriers. wirep(_p_)\t// ç»‘å®šPä¸å½“å‰å·¥ä½œçº¿ç¨‹M // Have p; write barriers now allowed. // Perform deferred mcache flush before this P can allocate // from a potentially stale mcache. // // åœ¨æ­¤ P å¯ä»¥ä»å¯èƒ½è¿‡æ—¶çš„ mcache åˆ†é…ä¹‹å‰æ‰§è¡Œå»¶è¿Ÿ mcache åˆ·æ–° _p_.mcache.prepareForSweep() if trace.enabled { traceProcStart() } } ç»‘å®šä¼ å…¥çš„Påœ¨å½“å‰å·¥ä½œçº¿ç¨‹ã€‚wirepæ˜¯acquirepçš„ç¬¬ä¸€æ­¥ï¼Œå®é™…ä¸Šæ˜¯å°†å½“å‰çš„Må…³è”åˆ°_p_ã€‚ è¿™æ˜¯è¢«æ‰“ç ´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç¦æ­¢è¿™éƒ¨åˆ†çš„å†™å±éšœï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰Pã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 4959 4960 4961 4962 4963 4964 4965 4966 4967 4968 4969 4970 4971 4972 4973 4974 4975 4976 4977 4978 4979 4980 4981 4982 4983 4984 4985 // wirep is the first step of acquirep, which actually associates the // current M to _p_. This is broken out so we can disallow write // barriers for this part, since we don't yet have a P. // //go:nowritebarrierrec //go:nosplit func wirep(_p_ *p) { _g_ := getg() // è·å–å½“å‰çš„g if _g_.m.p != 0 { // å½“å‰å·¥ä½œçº¿ç¨‹å¦‚æœç»‘å®šäº†Påˆ™æœ‰é—®é¢˜ throw(\"wirep: already in go\") } // å½“å‰Pç»‘å®šäº†å·¥ä½œçº¿ç¨‹å­˜åœ¨é—®é¢˜ï¼Œè¯¥Pä¸æ˜¯ç©ºé—²çš„ æˆ– å½“å‰Pä¸å¤„äºç©ºé—²çŠ¶æ€ if _p_.m != 0 || _p_.status != _Pidle { id := int64(0) if _p_.m != 0 { id = _p_.m.ptr().id } print(\"wirep: p-\u003em=\", _p_.m, \"(\", id, \") p-\u003estatus=\", _p_.status, \"\\n\") throw(\"wirep: invalid p state\") } // å½“å‰å·¥ä½œçº¿ç¨‹Mç»‘å®šP _g_.m.p.set(_p_) // m.p = _p_\t// å½“å‰Pç»‘å®šå·¥ä½œçº¿ç¨‹M _p_.m.set(_g_.m) // _p_.m = m _p_.status = _Prunning // æŠŠå½“å‰PçŠ¶æ€ä¿®æ”¹ä¸º_Prunning } schedule() å¾ªç¯è°ƒåº¦å¼€å§‹ã€‚æ¯è½®å¾ªç¯éƒ½ä»è¿™é‡Œå¼€å§‹ã€‚è¯¥å‡½æ•°ç®—æ˜¯è°ƒåº¦å™¨çš„æ ¸å¿ƒå‡½æ•°ï¼Œè¿è¡Œèµ·æ¥çš„çº¿ç¨‹ä¼šä¸€ç›´æ‰§è¡Œå®ƒã€‚ ä¸€è½®è°ƒåº¦å™¨ï¼šæ‰¾åˆ°ä¸€ä¸ªå¯è¿è¡Œçš„goroutineå¹¶æ‰§è¡Œå®ƒã€‚æ°¸ä¸è¿”å›ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 3183 3184 3185 3186 3187 3188 3189 3190 3191 3192 3193 3194 3195 3196 3197 3198 3199 3200 3201 3202 3203 3204 3205 3206 3207 3208 3209 3210 3211 3212 3213 3214 3215 3216 3217 3218 3219 3220 3221 3222 3223 3224 3225 3226 3227 3228 3229 3230 3231 3232 3233 3234 3235 3236 3237 3238 3239 3240 3241 3242 3243 3244 3245 3246 3247 3248 3249 3250 3251 3252 3253 3254 3255 3256 3257 3258 3259 3260 3261 3262 3263 3264 3265 3266 3267 3268 3269 3270 3271 3272 3273 3274 3275 3276 3277 3278 3279 3280 3281 3282 3283 3284 3285 3286 3287 3288 3289 3290 3291 3292 // One round of scheduler: find a runnable goroutine and execute it. // Never returns. func schedule() { // è·å–å½“å‰æ­£åœ¨è¿è¡Œçš„gï¼Œæ‰§è¡Œè¯¥å‡½æ•°æ—¶ä¸€èˆ¬éƒ½æ˜¯ç³»ç»Ÿæ ˆg0 _g_ := getg() // _g_ = g0 // è°ƒåº¦å¼€å§‹æ—¶ g0.m.locks = 0 // æ ¡éªŒå½“å‰çº¿ç¨‹æ²¡æœ‰é”ï¼Œä¸å…è®¸å†æŒæœ‰é”çš„æƒ…å†µä¸‹è¿›è¡Œè°ƒåº¦ï¼Œä»¥å…é€ æˆruntimeå†…éƒ¨é”™è¯¯ // å› ä¸ºm.locksçš„åŠ é”å’Œè§£é”æ—¶æˆå¯¹å‡ºç°çš„ï¼Œå› æ­¤è¿™é‡Œåº”è¯¥ä¸º0 if _g_.m.locks != 0 { throw(\"schedule: holding locks\") } // g0.m.lockedg = 0 // åˆ¤æ–­å½“å‰Mæœ‰æ²¡æœ‰å’ŒGç»‘å®šï¼Œå¦‚æœæœ‰ï¼Œè¿™ä¸ªMå°±ä¸èƒ½ç”¨æ¥æ‰§è¡Œå…¶ä»–çš„Gäº†, // åªèƒ½æŒ‚èµ·ç­‰å¾…ç»‘å®šçš„Gå¾—åˆ°è°ƒåº¦ã€‚ if _g_.m.lockedg != 0 { stoplockedm() execute(_g_.m.lockedg.ptr(), false) // Never returns. } // We should not schedule away from a g that is executing a cgo call, // since the cgo call is using the m's g0 stack. // // æˆ‘ä»¬ä¸åº”è¯¥å®‰æ’è¿œç¦»æ­£åœ¨æ‰§è¡Œ cgo è°ƒç”¨çš„ gï¼Œå› ä¸º cgo è°ƒç”¨æ­£åœ¨ä½¿ç”¨ m çš„ g0 å †æ ˆ // åˆ¤æ–­çº¿ç¨‹æ˜¯ä¸æ˜¯æ­£åœ¨è¿›è¡Œcgoå‡½æ•°è°ƒç”¨ï¼Œè¿™ç§æƒ…å†µä¸‹g0æ ˆæ­£åœ¨è¢«cgoä½¿ç”¨ï¼Œæ‰€ä»¥ä¹Ÿä¸å…è®¸è°ƒåº¦ã€‚ if _g_.m.incgo { throw(\"schedule: in cgo\") } top: pp := _g_.m.p.ptr() // pp = p // é€šè¿‡æŠŠpreemptå­—æ®µè®¾ç½®ä¸ºfalseï¼Œæ¥ç¦æ­¢å¯¹Pçš„æŠ¢å ã€‚ pp.preempt = false // Safety check: if we are spinning, the run queue should be empty. // Check this before calling checkTimers, as that might call // goready to put a ready goroutine on the local run queue. // // å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœæˆ‘ä»¬æ­£åœ¨è‡ªæ—‹ï¼Œé‚£ä¹ˆè¿è¡Œé˜Ÿåˆ—åº”è¯¥æ˜¯ç©ºçš„ã€‚ // åœ¨è°ƒç”¨checkTimersä¹‹å‰è¯·æ£€æŸ¥è¿™ä¸€ç‚¹ï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šè°ƒç”¨goreadyå°†å‡†å¤‡å¥½çš„goroutineæ”¾å…¥æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ã€‚ // å¯¹ spinning çš„åˆ¤æ–­å±äºä¸€è‡´æ€§æ£€éªŒï¼Œåœ¨Pæœ¬åœ°runqæœ‰ä»»åŠ¡çš„æƒ…å†µä¸‹ï¼ŒMä¸åº”è¯¥å¤„äºspinningçŠ¶æ€ã€‚ if _g_.m.spinning \u0026\u0026 (pp.runnext != 0 || pp.runqhead != pp.runqtail) { throw(\"schedule: spinning with local work\") } // å¯»æ‰¾ä¸€ä¸ªå¯ç”¨çš„ goroutine // inheritTimeï¼šæ˜¯å¦ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡ // 1. true ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡ // 2. false ä¸ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡ // tryWakePï¼šå½“å‰goroutineæ˜¯å¦æ˜¯æ™®é€šçš„ã€‚ä¹Ÿå°±æ˜¯user goroutineã€‚ // 1. false æ™®é€šçš„goroutineã€‚ // 2. true ä¸æ˜¯æ™®é€šçš„goroutineï¼Œå¯èƒ½æ˜¯GC workã€trace readeréœ€è¦å”¤é†’Pã€‚ // gpï¼šå½“å‰æ‰¾åˆ°çš„ goroutineã€‚ gp, inheritTime, tryWakeP := findRunnable() // blocks until work is available // This thread is going to run a goroutine and is not spinning anymore, // so if it was marked as spinning we need to reset it now and potentially // start a new spinning M. // // è¿™ä¸ªçº¿ç¨‹å°†è¿è¡Œä¸€ä¸ªgoroutineï¼Œä¸å†æ—‹è½¬ï¼Œæ‰€ä»¥å¦‚æœå®ƒè¢«æ ‡è®°ä¸ºæ—‹è½¬ï¼Œ // æˆ‘ä»¬ç°åœ¨éœ€è¦é‡ç½®å®ƒï¼Œå¹¶å¯èƒ½å¯åŠ¨ä¸€ä¸ªæ–°çš„æ—‹è½¬Mã€‚ if _g_.m.spinning { // é‡ç½®å½“å‰Mä½éæ—‹è½¬ï¼Œå¹¶å°è¯•é‡æ–°å¯åŠ¨ä¸€ä¸ªPæ ‡è®°ä¸ºæ—‹è½¬ã€‚ resetspinning() } // sched.disable.userï¼šç¦æ­¢è°ƒåº¦ç”¨æˆ·goroutineã€‚ // !schedEnabled(gp)ï¼šgpæ˜¯user goroutineã€‚ // å¯èƒ½æ¥è‡ªGCï¼Œå…¶ä¸­ä¸¤ç§æ¨¡å¼ä¸å…è®¸GCæœŸé—´è¿è¡Œuser goroutine if sched.disable.user \u0026\u0026 !schedEnabled(gp) { // Scheduling of this goroutine is disabled. Put it on // the list of pending runnable goroutines for when we // re-enable user scheduling and look again. // // æ­¤goroutineçš„è°ƒåº¦è¢«ç¦ç”¨ã€‚ // å½“æˆ‘ä»¬é‡æ–°å¯ç”¨ç”¨æˆ·è°ƒåº¦å¹¶å†æ¬¡æŸ¥çœ‹æ—¶ï¼Œå°†å®ƒæ”¾åœ¨æŒ‚èµ·çš„å¯è¿è¡Œgoroutineåˆ—è¡¨ä¸­ã€‚ lock(\u0026sched.lock) if schedEnabled(gp) { // Something re-enabled scheduling while we // were acquiring the lock. unlock(\u0026sched.lock) } else { // user goroutine æ—¶æŒ‚èµ· sched.disable.runnable.pushBack(gp) sched.disable.n++ unlock(\u0026sched.lock) goto top } } // If about to schedule a not-normal goroutine (a GCworker or tracereader), // wake a P if there is one. // // å¦‚æœè¦è°ƒåº¦ä¸€ä¸ªä¸æ­£å¸¸çš„goroutine (GCworkeræˆ–tracereader)ï¼Œå¦‚æœæœ‰Pï¼Œåˆ™å”¤é†’Pã€‚ // å°è¯•æ¢æ–°ä¸€ä¸ªæ–°çº¿ç¨‹ç»‘å®šPæ¥å·¥ä½œã€‚ if tryWakeP { wakep() } if gp.lockedm != 0 { // Hands off own p to the locked m, // then blocks waiting for a new p. // // æŠŠè‡ªå·±çš„päº¤ç»™é”ä½çš„mï¼Œç„¶åblockç­‰å¾…ä¸€ä¸ªæ–°çš„pã€‚ startlockedm(gp) goto top } execute(gp, inheritTime) } findRunnable()ğŸš€ æŸ¥æ‰¾è¦æ‰§è¡Œçš„å¯è¿è¡Œgoroutineã€‚è¯•å›¾ä»å…¶ä»–Pä¸­çªƒå–ï¼Œä»æœ¬åœ°æˆ–å…¨å±€é˜Ÿåˆ—ã€è½®è¯¢ç½‘ç»œä¸­è·å–gã€‚ tryWakePè¡¨ç¤ºè¿”å›çš„ä¸æ˜¯æ™®é€šçš„goroutineï¼ˆGCå·¥ä½œç¨‹åºã€è·Ÿè¸ªè¯»å–å™¨ï¼‰ï¼Œå› æ­¤è°ƒç”¨è€…åº”è¯¥å°è¯•å”¤é†’Pã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 2651 2652 2653 2654 2655 2656 2657 2658 2659 2660 2661 2662 2663 2664 2665 2666 2667 2668 2669 2670 2671 2672 2673 2674 2675 2676 2677 2678 2679 2680 2681 2682 2683 2684 2685 2686 2687 2688 2689 2690 2691 2692 2693 2694 2695 2696 2697 2698 2699 2700 2701 2702 2703 2704 2705 2706 2707 2708 2709 2710 2711 2712 2713 2714 2715 2716 2717 2718 2719 2720 2721 2722 2723 2724 2725 2726 2727 2728 2729 2730 2731 2732 2733 2734 2735 2736 2737 2738 2739 2740 2741 2742 2743 2744 2745 2746 2747 2748 2749 2750 2751 2752 2753 2754 2755 2756 2757 2758 2759 2760 2761 2762 2763 2764 2765 2766 2767 2768 2769 2770 2771 2772 2773 2774 2775 2776 2777 2778 2779 2780 2781 2782 2783 2784 2785 2786 2787 2788 2789 2790 2791 2792 2793 2794 2795 2796 2797 2798 2799 2800 2801 2802 2803 2804 2805 2806 2807 2808 2809 2810 2811 2812 2813 2814 2815 2816 2817 2818 2819 2820 2821 2822 2823 2824 2825 2826 2827 2828 2829 2830 2831 2832 2833 2834 2835 2836 2837 2838 2839 2840 2841 2842 2843 2844 2845 2846 2847 2848 2849 2850 2851 2852 2853 2854 2855 2856 2857 2858 2859 2860 2861 2862 2863 2864 2865 2866 2867 2868 2869 2870 2871 2872 2873 2874 2875 2876 2877 2878 2879 2880 2881 2882 2883 2884 2885 2886 2887 2888 2889 2890 2891 2892 2893 2894 2895 2896 2897 2898 2899 2900 2901 2902 2903 2904 2905 2906 2907 2908 2909 2910 2911 2912 2913 2914 2915 2916 2917 2918 2919 2920 2921 2922 2923 2924 2925 2926 2927 2928 2929 2930 2931 2932 2933 2934 2935 2936 2937 2938 2939 2940 2941 2942 2943 2944 2945 2946 2947 2948 2949 2950 2951 2952 2953 2954 2955 2956 2957 2958 2959 2960 2961 2962 2963 2964 2965 2966 2967 2968 2969 2970 2971 2972 2973 2974 2975 2976 2977 2978 2979 2980 2981 2982 2983 2984 2985 2986 2987 2988 2989 2990 2991 2992 2993 2994 2995 2996 2997 2998 2999 3000 3001 3002 3003 3004 3005 3006 3007 3008 3009 3010 3011 3012 3013 3014 3015 3016 3017 3018 3019 3020 3021 3022 3023 3024 3025 3026 3027 3028 3029 3030 3031 3032 3033 3034 3035 3036 3037 3038 3039 3040 3041 3042 3043 3044 3045 3046 3047 3048 3049 3050 3051 3052 3053 3054 3055 3056 3057 3058 3059 3060 3061 3062 3063 3064 3065 3066 3067 3068 3069 3070 3071 3072 3073 3074 3075 3076 3077 3078 3079 3080 3081 3082 3083 3084 3085 3086 3087 3088 3089 3090 3091 3092 3093 3094 3095 3096 3097 3098 3099 3100 3101 3102 3103 3104 3105 3106 3107 3108 3109 3110 3111 3112 3113 3114 3115 3116 3117 3118 3119 3120 3121 3122 // Finds a runnable goroutine to execute. // Tries to steal from other P's, get g from local or global queue, poll network. // tryWakeP indicates that the returned goroutine is not normal (GC worker, trace // reader) so the caller should try to wake a P. func findRunnable() (gp *g, inheritTime, tryWakeP bool) { _g_ := getg() // _g_ = g0 // The conditions here and in handoffp must agree: if // findrunnable would return a G to run, handoffp must start // an M. // // è¿™é‡Œå’Œhandoffpä¸­çš„æ¡ä»¶å¿…é¡»ä¸€è‡´ï¼šå¦‚æœfindrunnableå°†è¿”å›ä¸€ä¸ªGæ¥è¿è¡Œï¼Œåˆ™handoffpå¿…é¡»å¯åŠ¨ä¸€ä¸ªMã€‚ top: _p_ := _g_.m.p.ptr() // _p_ = p // 1) å¸®åŠ©STWï¼ŒæŠ¢å å½“å‰Pã€‚ // STW å³å°†å¼€å§‹è¦æ±‚ç­‰å¾…ï¼ŒæŒ‚èµ·å½“å‰Mã€‚ // æ£€æµ‹sched.gcwaitingï¼ŒæŒ‚èµ·è‡ªå·±ï¼Œä»¥ä¾¿åŠæ—¶å“åº”STWï¼Œ // è°ƒåº¦é€»è¾‘ä¸­å¾ˆå¤šåœ°æ–¹éƒ½æœ‰å¯¹gcwaitingçš„æ£€æµ‹ã€‚ if sched.gcwaiting != 0 { // åœ¨GCçš„STWæœŸé—´è¢«è®¾ç½® gcstopm() goto top } // 2) æ£€æŸ¥å½“å‰Pæ˜¯å¦åˆ°è¾¾å®‰å…¨ç‚¹ã€‚ // å¦‚æœå½“å‰Pè¦æ±‚è¿è¡Œ runSafePointFn() å‡½æ•°ã€‚ // runSafePointFn() å‡½æ•°è¢«GCç”¨æ¥åœ¨å®‰å…¨ç‚¹æ‰§è¡Œæ¸…ç©ºå·¥ä½œé˜Ÿåˆ—ä¹‹ç±»çš„æ“ä½œã€‚ if _p_.runSafePointFn != 0 { runSafePointFn() } // 3) å» timers é‡Œçœ‹çœ‹ï¼Œæ˜¯å¦æœ‰åˆ°ç‚¹çš„å®šæ—¶å™¨ã€‚ // è¿™é‡Œå¦‚æœæœ‰ timer åˆ°è§¦å‘ç‚¹äº†ï¼Œä¼šè§¦å‘å¹¶æ‰§è¡Œæ³¨å†Œå‡½æ•°ã€‚ // ç”±äºè°ƒåº¦å¾ªç¯æ˜¯ä»¥æ—¶é—´ç‰‡å½¢å¼è°ƒåº¦çš„ï¼Œå› æ­¤ timer çš„è§¦å‘æ—¶é—´ä¸Šçº¿å°±æ˜¯10msã€‚ // å› æ­¤æŠ¢å èƒ½æŠ¢å è¶…è¿‡10msä»¥ä¸Šçš„goroutine? // checkTimers ä¸ºå‡†å¤‡å¥½çš„ P è¿è¡Œä»»ä½•timers // å¦‚æœ now ä¸ä¸º 0ï¼Œåˆ™ä¸ºå½“å‰æ—¶é—´ï¼Œå¦‚æœ now è¢«ä¼ é€’ä¸º 0ï¼Œåˆ™è¿”å›ä¼ é€’çš„æ—¶é—´æˆ–å½“å‰æ—¶é—´ // ä»¥åŠä¸‹ä¸€ä¸ªtimeråº”è¯¥è¿è¡Œçš„æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰ä¸‹ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œåˆ™ä¸º 0ï¼Œå¹¶æŠ¥å‘Šå®ƒæ˜¯å¦è¿è¡Œäº†ä»»ä½•è®¡æ—¶å™¨ // å¦‚æœä¸‹ä¸€ä¸ªtimeråº”è¯¥è¿è¡Œçš„æ—¶é—´ä¸ä¸º0ï¼Œå®ƒæ€»æ˜¯å¤§äºè¿”å›çš„æ—¶é—´ // func checkTimers(pp *p, now int64) (rnow, pollUntil int64, ran bool) // å‚æ•°ï¼š // 1. pp *p å½“å‰éœ€è¦æ£€æŸ¥çš„P // 2. now int64 å½“å‰æ—¶é—´ï¼Œå¦‚æœä¸º0åˆ™å–å½“å‰æ—¶é—´ // è¿”å›å€¼ï¼š // 1. rnow int64ï¼šå‚æ•°nowçš„æ—¶é—´ã€‚ // 2. pollUntil int64ï¼š\u003e0.æœ€è¿‘timerè§¦å‘çš„æ—¶é—´ç‚¹ã€‚0.æ²¡æœ‰ä»»ä½•timerã€‚ // 3. ran bool timeré‡Œé¢æ˜¯å¦å­˜åœ¨å·²ç»å»¶è¿Ÿæ—¶é—´åˆ°ç‚¹çš„gï¼Œtrueå­˜åœ¨ï¼Œfalseä¸å­˜åœ¨ // now and pollUntil are saved for work stealing later, // which may steal timers. It's important that between now // and then, nothing blocks, so these numbers remain mostly // relevant. // // nowå’ŒpollUntilè¢«ä¿å­˜ä»¥å¤‡ä»¥åçªƒå–å·¥ä½œï¼Œè¿™å¯èƒ½ä¼šçªƒå–timersã€‚ // é‡è¦çš„æ˜¯ï¼Œä»ç°åœ¨åˆ°é‚£æ—¶ï¼Œæ²¡æœ‰ä»»ä½•é˜»ç¢ï¼Œæ‰€ä»¥è¿™äº›æ•°å­—ä»ç„¶å¾ˆé‡è¦ã€‚ // å¤„ç†å½“å‰Pç›¸å…³çš„timersï¼Œå¯èƒ½å­˜åœ¨ä¸€äº›åœ¨timerä¸­çš„gåˆ°æ—¶é—´ç‚¹äº†éœ€è¦æ”¾å›Pä¸­ç­‰å¾…è¢«æ‰§è¡Œ now, pollUntil, _ := checkTimers(_p_, 0) // 4) å°è¯•å®‰æ’ trace readerã€‚ // Try to schedule the trace reader. // // å°è¯•å®‰æ’ trace readerã€‚ if trace.enabled || trace.shutdown { gp = traceReader() if gp != nil { casgstatus(gp, _Gwaiting, _Grunnable) traceGoUnpark(gp, 0) return gp, false, true } } // 5) å†™æ ‡è®°æœŸé—´ï¼Œå°è¯•å®‰æ’ GC workerã€‚ // Try to schedule a GC worker. // å°è¯•å®‰æ’ GC workerã€‚ if gcBlackenEnabled != 0 { // åœ¨GCã€å¹¶å‘æ ‡è®°ã€‘æœŸé—´è¢«è®¾ç½® // å”¤é†’æ ‡è®°åç¨‹ï¼Œå‚çœ‹GCæ–‡æ¡£ gp, now = gcController.findRunnableGCWorker(_p_, now) // è·å–åˆ°æ ‡è®°åç¨‹ if gp != nil { return gp, false, true // è¿”å›æ ‡è®°åç¨‹ } } // 6) Pè°ƒåº¦æ¬¡æ•°æ¯æ»¡61æ¬¡éœ€è¦å»å…¨å±€é˜Ÿåˆ—æ‹¿å»goroutineï¼Œé˜²æ­¢å…¨å±€goroutineä¸€ç›´å¾—ä¸åˆ°è¿è¡Œã€‚ // Check the global runnable queue once in a while to ensure fairness. // Otherwise two goroutines can completely occupy the local runqueue // by constantly respawning each other. // // å¶å°”æ£€æŸ¥ä¸€æ¬¡å…¨å±€å¯è¿è¡Œé˜Ÿåˆ—ä»¥ç¡®ä¿å…¬å¹³æ€§ã€‚ // å¦åˆ™ï¼Œä¸¤ä¸ªgoroutineå¯ä»¥é€šè¿‡ä¸æ–­åœ°ç›¸äº’é‡æ–°éƒ¨ç½²æ¥å®Œå…¨å æ®æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ã€‚ // ä¸ºäº†ä¿è¯è°ƒåº¦çš„å…¬å¹³æ€§ï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹æ¯è¿›è¡Œ61æ¬¡è°ƒåº¦å°±éœ€è¦ä¼˜å…ˆä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­è·å–goroutineå‡ºæ¥è¿è¡Œã€‚ // å› ä¸ºå¦‚æœåªè°ƒåº¦æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­çš„goroutineï¼Œåˆ™å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­çš„goroutineæœ‰å¯èƒ½å¾—ä¸åˆ°è¿è¡Œã€‚ // p.schedtickï¼šè®°å½•è°ƒåº¦å‘ç”Ÿçš„æ¬¡æ•°ï¼Œå®é™…ä¸Šåœ¨æ¯å‘ç”Ÿä¸€æ¬¡goroutineåˆ‡æ¢ä¸”ä¸ç»§æ‰¿æ—¶é—´ç‰‡çš„æƒ…å†µä¸‹ï¼Œè¯¥å­—æ®µä¼šåŠ ä¸€ã€‚ // sched.runqsizeï¼šè®°å½•çš„æ˜¯å…¨å±€å°±ç»ªé˜Ÿåˆ—çš„é•¿åº¦ã€‚ä¹Ÿå°±æ˜¯å…¨å±€é˜Ÿåˆ—goroutineçš„ä¸ªæ•°ã€‚ if _p_.schedtick%61 == 0 \u0026\u0026 sched.runqsize \u003e 0 { lock(\u0026sched.lock) // ä»schedä¸­è·å–goroutineéœ€è¦æŒæœ‰locké”ã€‚ // ä»å…¨å±€é˜Ÿåˆ—ä¸­è·å–1ä¸ªgoroutineï¼Œç„¶åæ”¾å…¥Pçš„æœ¬åœ°é˜Ÿåˆ—ã€‚ gp = globrunqget(_p_, 1) // åªæ‹¿å–ä¸€ä¸ª unlock(\u0026sched.lock) // mutex è§£é” if gp != nil { return gp, false, false } } // 7) æ˜¯å¦æœ‰ finalizer Gã€‚ // Wake up the finalizer G. // // å”¤é†’ finalizer Gã€‚ // è¯¥goroutineç”±runtime.SetFinalizerå‡½æ•°åˆ›é€ ã€‚ // åªä¼šåˆ›å»ºä¸€ä¸ªgoroutineã€‚ if fingwait \u0026\u0026 fingwake { if gp := wakefing(); gp != nil { ready(gp, 0, true) } } if *cgo_yield != nil { asmcgocall(*cgo_yield, nil) } // 8) ä»Pçš„æœ¬åœ°é˜Ÿåˆ—æ‹¿å» goroutineã€‚ // local runq // ä»æœ¬åœ°Pçš„é˜Ÿåˆ—ä¸­è·å–goroutineã€‚ if gp, inheritTime := runqget(_p_); gp != nil { return gp, inheritTime, false } // 9) ä»å…¨å±€é˜Ÿåˆ—ä¸­æ‹¿å»goroutineã€‚ // global runq // ä»å…¨å±€é˜Ÿåˆ—ä¸­è·å–goroutineã€‚ if sched.runqsize != 0 { lock(\u0026sched.lock) gp := globrunqget(_p_, 0) // æ‹¿å–å¤šä¸ª unlock(\u0026sched.lock) if gp != nil { return gp, false, false } } // 10) netpoll æ˜¯å¦æœ‰å°±ç»ªçš„goroutineã€‚ // Poll network. // This netpoll is only an optimization before we resort to stealing. // We can safely skip it if there are no waiters or a thread is blocked // in netpoll already. If there is any kind of logical race with that // blocked thread (e.g. it has already returned from netpoll, but does // not set lastpoll yet), this thread will do blocking netpoll below // anyway. // // netpollinited()ï¼šåˆ¤æ–­netpollæ˜¯å¦å·²ç»åˆå§‹åŒ–ã€‚ // netpollWaitersï¼šæ˜¯å¦æœ‰ç­‰å¾…çš„goroutineã€‚ // sched.lastpollï¼šä¸Šæ¬¡ç½‘ç»œè½®è¯¢çš„æ—¶é—´ç‚¹ã€‚ä¸º0æ—¶è¡¨ç¤ºæœ‰çº¿ç¨‹æ­£åœ¨é˜»å¡å¼è°ƒç”¨netpollå‡½æ•° if netpollinited() \u0026\u0026 atomic.Load(\u0026netpollWaiters) \u003e 0 \u0026\u0026 atomic.Load64(\u0026sched.lastpoll) != 0 { // netpoll(0)ï¼šåˆ¤æ–­å½“å‰æ˜¯å¦æœ‰å°±ç»ªäº‹ä»¶ï¼Œ0è¡¨ç¤ºç«‹å³è¿”å›ã€‚éé˜»å¡ã€‚ if list := netpoll(0); !list.empty() { // non-blocking gp := list.pop() // å¼¹å‡ºä¸€ä¸ªgoroutineã€‚ injectglist(\u0026list) // å¤„ç†å‰©ä¸‹çš„goroutine casgstatus(gp, _Gwaiting, _Grunnable) // ä¿®æ”¹goroutineçŠ¶æ€ if trace.enabled { traceGoUnpark(gp, 0) } return gp, false, false } } // 11) ä»¥ä¸Šéƒ½æ²¡è·å–åˆ°goroutineã€‚æ ‡è®°è‡ªæ—‹å°è¯•ä»å…¶ä»–Pä¸­å·å–goroutineã€‚ // Spinning Ms: steal work from other Ps. // // Limit the number of spinning Ms to half the number of busy Ps. // This is necessary to prevent excessive CPU consumption when // GOMAXPROCS\u003e\u003e1 but the program parallelism is low. // // Spinning Ms:ä»å…¶ä»–Pé‚£é‡Œçªƒå–goroutineã€‚ // å°†è‡ªæ—‹çš„Mé™åˆ¶ä¸ºç¹å¿™Mçš„ä¸€åŠã€‚ // è¿™æ˜¯å¿…è¦çš„ï¼Œä»¥é˜²æ­¢åœ¨ GOMAXPROCS\u003e\u003e1 ä½†ç¨‹åºå¹¶è¡Œæ€§è¾ƒä½æ—¶è¿‡åº¦æ¶ˆè€—CPUã€‚ // å¦‚æœå½“å‰å¤„äºspinningçŠ¶æ€çš„Mçš„æ•°é‡å¤§äºå¿™ç¢Œçš„Pçš„æ•°é‡çš„ä¸€åŠï¼Œå°±è®©å½“å‰Mé˜»å¡(ä¼‘çœ )ã€‚ // ç›®çš„æ˜¯é¿å…åœ¨gomaxprocsè¾ƒå¤§è€Œç¨‹åºå®é™…çš„å¹¶å‘æ€§å¾ˆä½çš„æƒ…å†µä¸‹ï¼Œé€ æˆä¸å¿…è¦çš„CPUæ¶ˆè€—ã€‚ procs := uint32(gomaxprocs) // è·å–å½“å‰Pçš„æ•°é‡ // _g_.m.spinning == trueï¼šå½“å‰Må¤„äºè‡ªæ—‹ã€‚ // 2*atomic.Load(\u0026sched.nmspinning) \u003c procs-atomic.Load(\u0026sched.npidle)ï¼šè‡ªæ—‹æ˜¯ç¹å¿™çš„ä¸€åŠè¿˜å°æ—¶ï¼Œæ ‡è®°å½“å‰Mä¸ºè‡ªæ—‹ if _g_.m.spinning || 2*atomic.Load(\u0026sched.nmspinning) \u003c procs-atomic.Load(\u0026sched.npidle) { if !_g_.m.spinning { // æ»¡è¶³å·å–çš„æ—¶å€™æ‰ä¼šæ ‡è®°Mä¸ºè‡ªæ—‹çŠ¶æ€ _g_.m.spinning = true // æ ‡è®°ä¸ºè‡ªæ—‹çŠ¶æ€ atomic.Xadd(\u0026sched.nmspinning, 1) // ç´¯åŠ è‡ªæ—‹Mçš„æ•°é‡ } // å»å…¶ä»–Pä¸­å·å– goroutineã€‚å·å–å…¶ä»–Pä¸­goroutineçš„ä¸€åŠã€‚ // ä»p.runnextä¸­å·å–çš„goroutineæ—¶ï¼ŒinheritTimeè¯¥å€¼ä¸ºtrueï¼Œè¡¨ç¤ºç»§æ‰¿ä¸Šä¸ªæ—¶é—´ç‰‡ã€‚ gp, inheritTime, tnow, w, newWork := stealWork(now) now = tnow // æ›´æ–°å½“å‰æ—¶é—´ // æˆåŠŸå·å–åˆ°goroutine if gp != nil { // Successfully stole. return gp, inheritTime, false } // newWork æŸä¸ªPä¸­æœ‰timerè¢«è§¦å‘äº†ï¼Œåœ¨æ¥ä¸€æ¬¡è°ƒåº¦å¾ªç¯ if newWork { // There may be new timer or GC work; restart to // discover. goto top } // wä¸ä¸º0ï¼Œè¡¨ç¤ºæœ€è¿‘è§¦å‘çš„timerçš„æ—¶é—´ç‚¹ if w != 0 \u0026\u0026 (pollUntil == 0 || w \u003c pollUntil) { // Earlier timer to wait for. pollUntil = w // è®°å½•æœ€è¿‘è¦è§¦å‘çš„æ—¶é—´ç‚¹ } } // 12) æœ‰GCæ ‡è®°å·¥ä½œè¿™å»å¸®åŠ©GC // We have nothing to do. // // If we're in the GC mark phase, can safely scan and blacken objects, // and have work to do, run idle-time marking rather than give up the P. // // æˆ‘ä»¬æ— äº‹å¯åšã€‚ // å¦‚æœæˆ‘ä»¬åœ¨GCæ ‡è®°é˜¶æ®µï¼Œå¯ä»¥å®‰å…¨åœ°æ‰«æå’Œå˜é»‘å¯¹è±¡ï¼Œå¹¶ä¸”æœ‰å·¥ä½œè¦åšï¼Œè¿è¡Œç©ºé—²æ—¶é—´æ ‡è®°è€Œä¸æ˜¯æ”¾å¼ƒPã€‚ if gcBlackenEnabled != 0 \u0026\u0026 gcMarkWorkAvailable(_p_) \u0026\u0026 gcController.addIdleMarkWorker() { node := (*gcBgMarkWorkerNode)(gcBgMarkWorkerPool.pop()) if node != nil { _p_.gcMarkWorkerMode = gcMarkWorkerIdleMode gp := node.gp.ptr() casgstatus(gp, _Gwaiting, _Grunnable) if trace.enabled { traceGoUnpark(gp, 0) } return gp, false, false } gcController.removeIdleMarkWorker() } // wasm only: // If a callback returned and no other goroutine is awake, // then wake event handler goroutine which pauses execution // until a callback was triggered. gp, otherReady := beforeIdle(now, pollUntil) // åœ¨linuxä¸‹è¿”å› (nil, false) if gp != nil { casgstatus(gp, _Gwaiting, _Grunnable) if trace.enabled { traceGoUnpark(gp, 0) } return gp, false, false } if otherReady { goto top } // 13) ä¿å­˜allpã€idlepMaskå’ŒtimerpMaskçš„å¿«ç…§ // å½“å‰å·¥ä½œçº¿ç¨‹å³å°†ä¼‘çœ ï¼Œä¼‘çœ å‰å†æ¬¡å»å¿«ç…§é‡Œé¢çœ‹çœ‹æœ‰æ²¡æœ‰å·¥ä½œè¦åš // Before we drop our P, make a snapshot of the allp slice, // which can change underfoot once we no longer block // safe-points. We don't need to snapshot the contents because // everything up to cap(allp) is immutable. // // åœ¨æˆ‘ä»¬ä¸¢å¼ƒPä¹‹å‰ï¼Œåšä¸€ä¸ªallpåˆ‡ç‰‡çš„å¿«ç…§ï¼Œä¸€æ—¦æˆ‘ä»¬ä¸å†é˜»å¡safe-pointsï¼Œå®ƒå°±ä¼šæ”¹å˜ã€‚ // æˆ‘ä»¬ä¸éœ€è¦å¯¹å†…å®¹è¿›è¡Œå¿«ç…§ï¼Œå› ä¸ºcap(allp)ä¹‹å‰çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯ä¸å¯å˜çš„ã€‚ allpSnapshot := allp // Also snapshot masks. Value changes are OK, but we can't allow // len to change out from under us. // // è¿˜æœ‰å¿«ç…§æ©ç ã€‚å€¼æ›´æ”¹æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸èƒ½å…è®¸lenä»æˆ‘ä»¬ä¸‹é¢æ›´æ”¹ã€‚ idlepMaskSnapshot := idlepMask timerpMaskSnapshot := timerpMask // 14) åœ¨çœ‹ä¸€ä¸‹gcwaitingå’ŒrunSafePointFnï¼Œä»¥åŠå…¨å±€é˜Ÿåˆ—sched.runqsize // return P and block lock(\u0026sched.lock) // æœ‰GCç­‰å¾… æˆ– Pæœ‰å®‰å…¨ç‚¹å‡½æ•°æ‰§è¡Œ if sched.gcwaiting != 0 || _p_.runSafePointFn != 0 { unlock(\u0026sched.lock) goto top } // å…¨å±€é˜Ÿåˆ—æœ‰ goroutine if sched.runqsize != 0 { // å› ä¸º sched.lock é”å·²è¢«æŒæœ‰ï¼Œæ‰€ä»¥ä¸€å®šèƒ½å–å‡º gpã€‚ä¸ä¸º nilã€‚ gp := globrunqget(_p_, 0) unlock(\u0026sched.lock) return gp, false, false } // 15) è§£é™¤å½“å‰Mä¸Pçš„ç»‘å®šå…³ç³»ï¼Œå¹¶æŠŠPåŠ å…¥å…¨å±€ç©ºé—²é˜Ÿåˆ—ä¸­ // è§£é™¤mä¸pçš„ç»‘å®šå…³ç³»ï¼Œå¹¶è®¾ç½®pä¸ºç©ºé—²çŠ¶æ€ã€‚ if releasep() != _p_ { throw(\"findrunnable: wrong p\") } // æŠŠPåŠ å…¥ç©ºé—²é˜Ÿåˆ— now = pidleput(_p_, now) unlock(\u0026sched.lock) // 16) æ ¹æ®å‰é¢å¿«ç…§ä¿å­˜çš„ä¿¡æ¯ï¼Œå†æ¬¡æ£€æŸ¥å…¶ä»–Pæ˜¯å¦å¯å·å–ï¼ŒGCæœ‰æ²¡æ ‡è®°å·¥ä½œéœ€è¦ååŠ©ï¼Œtimeræœ‰æ²¡è§¦å‘ // Delicate dance: thread transitions from spinning to non-spinning // state, potentially concurrently with submission of new work. We must // drop nmspinning first and then check all sources again (with // #StoreLoad memory barrier in between). If we do it the other way // around, another thread can submit work after we've checked all // sources but before we drop nmspinning; as a result nobody will // unpark a thread to run the work. // // This applies to the following sources of work: // // * Goroutines added to a per-P run queue. // * New/modified-earlier timers on a per-P timer heap. // * Idle-priority GC work (barring golang.org/issue/19112). // // If we discover new work below, we need to restore m.spinning as a signal // for resetspinning to unpark a new worker thread (because there can be more // than one starving goroutine). However, if after discovering new work // we also observe no idle Ps it is OK to skip unparking a new worker // thread: the system is fully loaded so no spinning threads are required. // Also see \"Worker thread parking/unparking\" comment at the top of the file. wasSpinning := _g_.m.spinning // å¤„ç†å½“å‰Mæ˜¯è‡ªæ—‹çŠ¶æ€ if _g_.m.spinning { _g_.m.spinning = false // æ ‡è®°å½“å‰Mæœªéè‡ªæ—‹ if int32(atomic.Xadd(\u0026sched.nmspinning, -1)) \u003c 0 { throw(\"findrunnable: negative nmspinning\") } // Note the for correctness, only the last M transitioning from // spinning to non-spinning must perform these rechecks to // ensure no missed work. We are performing it on every M that // transitions as a conservative change to monitor effects on // latency. See golang.org/issue/43997. // Check all runqueues once again. // // å†æ¬¡æ£€æŸ¥æ‰€æœ‰è¿è¡Œé˜Ÿåˆ—ã€‚ // æ£€æŸ¥æ˜¯å¦æœ‰å¯å·å–çš„Pï¼Œå¦‚æœæœ‰åˆ™å–å‡ºä¸€ä¸ªç©ºé—²çš„Pç»‘å®šMã€‚ _p_ = checkRunqsNoP(allpSnapshot, idlepMaskSnapshot) if _p_ != nil { acquirep(_p_) // ç»‘å®šP _g_.m.spinning = true atomic.Xadd(\u0026sched.nmspinning, 1) goto top // æœ‰å·¥ä½œå¯åšå†è·‘ä¸€éè°ƒåº¦å¾ªç¯ } // Check for idle-priority GC work again. // // å†æ¬¡æ£€æŸ¥ç©ºé—²ä¼˜å…ˆçº§GCå·¥ä½œã€‚æ˜¯å¦æœ‰ç¼–è¾‘å·¥ä½œéœ€è¦åš _p_, gp = checkIdleGCNoP() if _p_ != nil { acquirep(_p_) // ç»‘å®šP _g_.m.spinning = true atomic.Xadd(\u0026sched.nmspinning, 1) // Run the idle worker. _p_.gcMarkWorkerMode = gcMarkWorkerIdleMode casgstatus(gp, _Gwaiting, _Grunnable) if trace.enabled { traceGoUnpark(gp, 0) } return gp, false, false } // Finally, check for timer creation or expiry concurrently with // transitioning from spinning to non-spinning. // // Note that we cannot use checkTimers here because it calls // adjusttimers which may need to allocate memory, and that isn't // allowed when we don't have an active P. // // æœ€åï¼Œå†çœ‹çœ‹timerã€‚ pollUntil = checkTimersNoP(allpSnapshot, timerpMaskSnapshot, pollUntil) } // 17) network æ˜¯å¦æœ‰éœ€è¦å¤„ç†çš„goroutineï¼Œæˆ–timeræ˜¯å¦å³å°†è§¦å‘ï¼Œ // æ ‡è®°sched.lastpollä¸º0ï¼Œé˜»å¡å¼ç­‰å¾…å§ã€‚netpollä¸­ä¸€äº›è¯»å†™è¶…æ—¶éœ€è¦ç”¨åˆ°timer // Poll network until next timer. // // Poll network ç›´åˆ°ä¸‹ä¸€ä¸ª timerã€‚ // netpollinited()ï¼šnetpoll å·²åˆå§‹åŒ–ã€‚ // netpollWaitersï¼šè®°å½•å½“å‰goroutineè¢«æŒ‚åœ¨epollä¸­çš„ç­‰å¾…æ•°é‡ã€‚ // pollUntilï¼š\u003e0.ä¸‹ä¸ªtimerè§¦å‘çš„è€Œæ—¶é—´ç‚¹ã€‚ // atomic.Xchg64(\u0026sched.lastpoll, 0)ï¼šè¿™é‡Œæ˜¯å”¯ä¸€çš„æŠŠsched.lastpollä¿®æ”¹ä¸º0çš„æƒ…å†µï¼Œ // è¡¨ç¤ºå½“å‰éœ€è¦é˜»å¡å¼çš„è°ƒç”¨netpollå‡½æ•°ã€‚ // è¿™é‡Œçš„atomic.Xchg64(\u0026sched.lastpoll, 0) != 0 å…·æœ‰æ’ä»–æ€§ã€‚åªèƒ½æœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹å¤„äºé˜»å¡ç­‰å¾…ä¸­ã€‚ if netpollinited() \u0026\u0026 (atomic.Load(\u0026netpollWaiters) \u003e 0 || pollUntil != 0) \u0026\u0026 atomic.Xchg64(\u0026sched.lastpoll, 0) != 0 { // sched.pollUntil = pollUntilï¼Œé¢„è®¡çš„é˜»å¡æ—¶é—´ç‚¹ã€‚ atomic.Store64(\u0026sched.pollUntil, uint64(pollUntil)) if _g_.m.p != 0 { throw(\"findrunnable: netpoll with p\") } if _g_.m.spinning { throw(\"findrunnable: netpoll with spinning\") } // Refresh now. now = nanotime() delay := int64(-1) if pollUntil != 0 { // è®¡ç®—é¢„è®¡é˜»å¡çš„æ—¶é—´ delay = pollUntil - now if delay \u003c 0 { // è§¦å‘æ—¶é—´ä»¥è¿‡ï¼Œè¦æ±‚ç«‹å³è¿”å› delay = 0 } } // faketimeæ˜¯è‡ª1970å¹´ä»¥æ¥æ¨¡æ‹Ÿçš„ä»¥çº³ç§’ä¸ºå•ä½çš„æ—¶é—´ã€‚ // 0å€¼æ„å‘³ç€ä¸ä½¿ç”¨faketimeã€‚ if faketime != 0 { // When using fake time, just poll. // å½“ä½¿ç”¨ fake timeï¼Œåªæ˜¯pollã€‚ delay = 0 } // é˜»å¡ç›´åˆ°æœ‰æ–°çš„workå¯ç”¨ï¼Œdelayæ˜¯ä¸€ä¸ªå…·ä½“çš„æ—¶é—´æ®µ list := netpoll(delay) // block until new work is available atomic.Store64(\u0026sched.pollUntil, 0) // sched.pollUntil = 0 atomic.Store64(\u0026sched.lastpoll, uint64(now)) // sched.lastpoll = now if faketime != 0 \u0026\u0026 list.empty() { // Using fake time and nothing is ready; stop M. // When all M's stop, checkdead will call timejump. stopm() goto top } lock(\u0026sched.lock) // ä»ç©ºé—²Pé“¾è¡¨ä¸­è·å–ä¸€ä¸ªP _p_, _ = pidleget(now) unlock(\u0026sched.lock) if _p_ == nil { // æ²¡æœ‰å¯ç”¨çš„ç©ºé—²Pæ—¶ã€‚ // å¦‚æœæœ‰å°±ç»ªçš„goroutineæ”¾å…¥å…¨å±€goroutineæ± ã€‚ injectglist(\u0026list) } else { acquirep(_p_) // ç»‘å®šP if !list.empty() { // å–å‡ºä¸€ä¸ªgoroutineï¼Œç”¨äºè¿”å› gp := list.pop() // å‰©ä½™çš„ä¼˜å…ˆåŠ å…¥å…¨å±€æ± ã€‚ injectglist(\u0026list) // ä¿®æ”¹goroutineçŠ¶æ€ä¸ºå¾…è¿è¡ŒçŠ¶æ€ casgstatus(gp, _Gwaiting, _Grunnable) if trace.enabled { traceGoUnpark(gp, 0) } // è¿”å›æ‰¾åˆ°çš„ goroutine return gp, false, false } // å¦‚æœä¹‹å‰Mæ˜¯è‡ªæ—‹ï¼Œåˆ™å†æ¬¡æ ‡è®°ä¸ºè‡ªæ—‹å¹¶ä»æ–°å†æ¥ä¸€æ¬¡ã€‚ if wasSpinning { _g_.m.spinning = true atomic.Xadd(\u0026sched.nmspinning, 1) } goto top } } else if pollUntil != 0 \u0026\u0026 netpollinited() { // æœ‰å…¶ä»–çš„çº¿ç¨‹åœ¨é˜»å¡ netpollã€‚ // sched.pollUntilï¼šä¸‹æ¬¡timeråº”è¯¥è¢«å”¤é†’æ—¶é—´ç‚¹ã€‚ pollerPollUntil := int64(atomic.Load64(\u0026sched.pollUntil)) // timerè§¦å‘äº† æˆ– è§¦å‘æ—¶é—´å·²åˆ° å«é†’é˜»å¡çš„netpoll if pollerPollUntil == 0 || pollerPollUntil \u003e pollUntil { netpollBreak() // å«é†’epoll } } // æŒ‚èµ·å½“å‰çº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹å”¤é†’ã€‚ stopm() goto top } gcstopm() ä¸ºstopTheWorldåœæ­¢å½“å‰Mã€‚ å½“TheWordStartæ—¶è¿”å›ã€‚è¾…åŠ©STWã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ è¯¥æ–¹æ³•åœ¨GCå‘èµ·æ—¶ï¼Œå…¶ä»–çº¿ç¨‹éƒ½åœ¨è¿™ä¸ªæ–¹æ³•ä¸ŠæŠŠè‡ªå·±æŒ‚èµ·ã€‚ 2481 2482 2483 2484 2485 2486 2487 2488 2489 2490 2491 2492 2493 2494 2495 2496 2497 2498 2499 2500 2501 2502 2503 2504 2505 2506 2507 2508 2509 2510 2511 2512 2513 2514 2515 // Stops the current m for stopTheWorld. // Returns when the world is restarted. func gcstopm() { _g_ := getg() // _g_ = g0 // sched.gcwaitingï¼šæ˜¯1ï¼Œè¡¨ç¤ºå½“å‰STWæ­£åœ¨ç­‰å¾…Påœä¸‹æ¥ã€‚ if sched.gcwaiting == 0 { throw(\"gcstopm: not waiting for gc\") } // å½“å‰Mæ­£å¤„äºè‡ªæ—‹çŠ¶æ€ä¸‹ã€‚ if _g_.m.spinning { _g_.m.spinning = false // æ¸…é™¤è‡ªæ—‹æ ‡è®° // OK to just drop nmspinning here, // startTheWorld will unpark threads as necessary. // // è‡ªæ—‹è®¡æ•°å‡ºç°é”™è¯¯ if int32(atomic.Xadd(\u0026sched.nmspinning, -1)) \u003c 0 { throw(\"gcstopm: negative nmspinning\") } } // è§£ç»‘å½“å‰Mä¸P _p_ := releasep() lock(\u0026sched.lock) // _Pgcstopï¼šGCåœæ­¢çŠ¶æ€ã€‚ // Pè¢«STWæŒ‚èµ·ä»¥æ‰§è¡ŒGCï¼Œæ‰€æœ‰æƒå½’æ‰§è¡ŒSTWçš„Mæ‰€æœ‰ï¼Œæ‰§è¡ŒSTWçš„Mä¼šç»§ç»­ä½¿ç”¨å¤„äº_PgcstopçŠ¶æ€çš„Pã€‚ _p_.status = _Pgcstop // sched.stopwaitï¼šè®°å½•äº†STWéœ€è¦åœæ­¢çš„Pçš„æ•°é‡ sched.stopwait-- // å·²ç»åœä¸‹äº†æ‰€æœ‰çš„Pï¼Œéœ€è¦å”¤é†’åœ¨ sched.stopnote ä¸Šå‘èµ·STWçš„å·¥ä½œçº¿ç¨‹ã€‚ if sched.stopwait == 0 { notewakeup(\u0026sched.stopnote) } unlock(\u0026sched.lock) stopm() // åœæ­¢å½“å‰å·¥ä½œçº¿ç¨‹ã€‚ } releasep() è§£é™¤på’Œå½“å‰mçš„å…³è”ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 4984 4985 4986 4987 4988 4989 4990 4991 4992 4993 4994 4995 4996 4997 4998 4999 5000 5001 5002 5003 5004 5005 5006 5007 // Disassociate p and the current m. func releasep() *p { _g_ := getg() // _g_ = g0 if _g_.m.p == 0 { throw(\"releasep: invalid arg\") } _p_ := _g_.m.p.ptr() // _p_ = p // _p_.m == _g_.m \u0026\u0026 _p_.status == _Prunning if _p_.m.ptr() != _g_.m || _p_.status != _Prunning { print(\"releasep: m=\", _g_.m, \" m-\u003ep=\", _g_.m.p.ptr(), \" p-\u003em=\", hex(_p_.m), \" p-\u003estatus=\", _p_.status, \"\\n\") throw(\"releasep: invalid p state\") } if trace.enabled { traceProcStop(_g_.m.p.ptr()) } // è§£é™¤ p ä¸ m ç›¸äº’ç»‘å®šçš„å…³ç³»ã€‚ _g_.m.p = 0 _p_.m = 0 // _Pidleï¼šç©ºé—²çŠ¶æ€ã€‚ // æ­¤æ—¶çš„Pæ²¡æœ‰è¢«ç”¨æ¥æ‰§è¡Œç”¨æˆ·ä»£ç æˆ–è°ƒåº¦å™¨ä»£ç ï¼Œé€šå¸¸ä½äºç©ºé—²é“¾è¡¨ä¸­ï¼Œèƒ½å¤Ÿè¢«è°ƒåº¦å™¨è·å–ã€‚ _p_.status = _Pidle return _p_ } stopm() åœæ­¢æ‰§è¡Œå½“å‰mï¼Œç›´åˆ°æœ‰æ–°çš„å·¥ä½œå¯ç”¨ã€‚è¿”å›è·å–çš„Pã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 2229 2230 2231 2232 2233 2234 2235 2236 2237 2238 2239 2240 2241 2242 2243 2244 2245 2246 2247 2248 2249 2250 2251 2252 // Stops execution of the current m until new work is available. // Returns with acquired P. func stopm() { _g_ := getg() // _g_ = g0 if _g_.m.locks != 0 { throw(\"stopm holding locks\") } if _g_.m.p != 0 { throw(\"stopm holding p\") } if _g_.m.spinning { throw(\"stopm spinning\") } lock(\u0026sched.lock) mput(_g_.m) // æŠŠå½“å‰måŠ å…¥sched.midleä¸­ã€‚ unlock(\u0026sched.lock) mPark() // å·¥ä½œçº¿ç¨‹sleepåœ¨m.parkä¸Š // å·¥ä½œçº¿ç¨‹å†æ¬¡è¢«wakeupæ—¶ï¼Œç»‘å®šPã€‚ acquirep(_g_.m.nextp.ptr()) // æ­¤å¤„pæ¥è‡ªm.nextpã€‚ _g_.m.nextp = 0 } mput() æŠŠmpåˆ—å…¥midleåˆ—è¡¨ä¸­ã€‚ sched.lock å¿…é¡»è¢«æŒæœ‰ã€‚ å¯èƒ½åœ¨STWæœŸé—´è¿è¡Œï¼Œå› æ­¤ä¸å…è®¸å‡ºç°å†™å±éšœã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5533 5534 5535 5536 5537 5538 5539 5540 5541 5542 5543 5544 5545 5546 // Put mp on midle list. // sched.lock must be held. // May run during STW, so write barriers are not allowed. // //go:nowritebarrierrec func mput(mp *m) { assertLockHeld(\u0026sched.lock) // æŠŠå½“å‰måŠ å…¥sched.midleã€‚ mp.schedlink = sched.midle sched.midle.set(mp) sched.nmidle++ checkdead() // æ£€æŸ¥æ­»é”ã€‚ } mPark() mParkä¼šå¯¼è‡´çº¿ç¨‹è‡ªè¡Œåœé©»ï¼Œä¸€æ—¦è¢«å”¤é†’å°±ä¼šè¿”å›ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 1452 1453 1454 1455 1456 1457 1458 1459 // mPark causes a thread to park itself, returning once woken. // //go:nosplit func mPark() { gp := getg() // gp = g0 notesleep(\u0026gp.m.park) // sleep noteclear(\u0026gp.m.park) // æ¸…é™¤ m.park } acquirep() å…³è”på’Œå½“å‰mã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 4938 4939 4940 4941 4942 4943 4944 4945 4946 4947 4948 4949 4950 4951 4952 4953 4954 4955 4956 4957 // Associate p and the current m. // // This function is allowed to have write barriers even if the caller // isn't because it immediately acquires _p_. // //go:yeswritebarrierrec func acquirep(_p_ *p) { // Do the part that isn't allowed to have write barriers. wirep(_p_) // Have p; write barriers now allowed. // Perform deferred mcache flush before this P can allocate // from a potentially stale mcache. _p_.mcache.prepareForSweep() if trace.enabled { traceProcStart() } } globrunqget() å°è¯•ä»å…¨å±€å¯è¿è¡Œé˜Ÿåˆ—ä¸­è·å–ä¸€æ‰¹Gï¼Œsched.lockå¿…é¡»è¢«æŒæœ‰ã€‚ å‚æ•°ï¼š _p_ *pï¼šå½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„Pã€‚ max int32ï¼šä»å…¨å±€é˜Ÿåˆ—ä¸­æ‹¿å¤šå°‘ä¸ªgåˆ°æœ¬åœ°Pä¸­ã€‚è¯¥å‚æ•°ä¸€èˆ¬æ˜¯1ï¼Œå¦‚æœæ˜¯å…¶ä»–På·å–åˆ™æ˜¯å¤§äº1ã€‚ è¿”å›å€¼*gï¼šä»å…¨å±€é˜Ÿåˆ—ä¸­é‚£åˆ°çš„goroutineã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5601 5602 5603 5604 5605 5606 5607 5608 5609 5610 5611 5612 5613 5614 5615 5616 5617 5618 5619 5620 5621 5622 5623 5624 5625 5626 5627 5628 5629 5630 5631 5632 5633 5634 5635 5636 5637 5638 5639 5640 5641 5642 5643 5644 // Try get a batch of G's from the global runnable queue. // sched.lock must be held. func globrunqget(_p_ *p, max int32) *g { assertLockHeld(\u0026sched.lock) // sched.runqsizeï¼šè®°å½•çš„æ˜¯å…¨å±€å°±ç»ªé˜Ÿåˆ—çš„é•¿åº¦ã€‚ // ä¹Ÿå°±æ˜¯å…¨å±€é˜Ÿåˆ—goroutineçš„ä¸ªæ•°ã€‚ if sched.runqsize == 0 { return nil } // æ ¹æ®pçš„æ•°é‡å¹³åˆ†å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­çš„goroutines n := sched.runqsize/gomaxprocs + 1 // ä¸Šé¢è®¡ç®—nçš„æ–¹æ³•å¯èƒ½å¯¼è‡´nå¤§äºå…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­çš„goroutineæ•°é‡ if n \u003e sched.runqsize { n = sched.runqsize } // maxï¼šè¡¨ç¤ºæœ€å¤šæ‹¿å»goroutineä¸ªæ•°ã€‚ if max \u003e 0 \u0026\u0026 n \u003e max { n = max } // æœ€å¤šåªèƒ½å–æœ¬åœ°é˜Ÿåˆ—å®¹é‡çš„ä¸€åŠã€‚ // _p_.runqï¼šæœ€å¤§256ã€‚ if n \u003e int32(len(_p_.runq))/2 { n = int32(len(_p_.runq)) / 2 } sched.runqsize -= n // å‡å»å–å‡ºçš„æ•°é‡ // popä»å…¨å±€è¿è¡Œé˜Ÿåˆ—çš„é˜Ÿåˆ—å¤´å–ä¸€ä¸ªgoroutineã€‚ // è¿™ä¸ªgoroutineç”¨äºè¿”å›ã€‚ gp := sched.runq.pop() n-- // éå†ä»å…¨å±€é˜Ÿåˆ—ä¸­æ‹¿å–goroutineåˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­ã€‚ for ; n \u003e 0; n-- { // ä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªgoroutine gp1 := sched.runq.pop() // æ”¾å…¥æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ï¼Œfalse.æ”¾å…¥å°¾éƒ¨ã€‚ // 1. goå…³é”®å­—æ—¶ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ä¼ å…¥çš„true // 2. ä»å…¨å±€æ‹¿å–æ—¶ï¼Œè¿™é‡Œä¼ å…¥çš„æ—¶false runqput(_p_, gp1, false) } return gp } runqput() æŠŠgpæ”¾å…¥_p_çš„å°¾éƒ¨ã€‚ å‚æ•°ï¼š _p_ *pï¼šæœ¬åœ°Pã€‚ gp *gï¼šéœ€è¦æ”¾å…¥_p_çš„goroutineã€‚ next boolï¼štrueæ”¾å…¥æœ¬åœ°_p_çš„å¼€å¤´ï¼Œfalseæ”¾å…¥æœ¬åœ°_p_çš„å°¾éƒ¨ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5780 5781 5782 5783 5784 5785 5786 5787 5788 5789 5790 5791 5792 5793 5794 5795 5796 5797 5798 5799 5800 5801 5802 5803 5804 5805 5806 5807 5808 5809 5810 5811 5812 5813 5814 5815 5816 5817 // runqput tries to put g on the local runnable queue. // If next is false, runqput adds g to the tail of the runnable queue. // If next is true, runqput puts g in the _p_.runnext slot. // If the run queue is full, runnext puts g on the global queue. // Executed only by the owner P. func runqput(_p_ *p, gp *g, next bool) { if randomizeScheduler \u0026\u0026 next \u0026\u0026 fastrandn(2) == 0 { next = false } if next { retryNext: oldnext := _p_.runnext if !_p_.runnext.cas(oldnext, guintptr(unsafe.Pointer(gp))) { goto retryNext } if oldnext == 0 { return } // Kick the old runnext out to the regular run queue. gp = oldnext.ptr() } retry: h := atomic.LoadAcq(\u0026_p_.runqhead) // load-acquire, synchronize with consumers t := _p_.runqtail if t-h \u003c uint32(len(_p_.runq)) { _p_.runq[t%uint32(len(_p_.runq))].set(gp) atomic.StoreRel(\u0026_p_.runqtail, t+1) // store-release, makes the item available for consumption return } // ä»_P_ä¸­ç§»é™¤ä¸€éƒ¨åˆ†åˆ°å…¨å±€ä¸­ï¼ŒåŒ…å«gpã€‚ if runqputslow(_p_, gp, h, t) { return } // the queue is not full, now the put above must succeed goto retry } runqget() ä»æœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ—ä¸­è·å–goroutineã€‚ å¦‚æœinheritTimeä¸ºtrueï¼Œåˆ™gpåº”ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡ä¸­çš„å‰©ä½™æ—¶é—´ã€‚å¦åˆ™ï¼Œå®ƒåº”è¯¥å¼€å§‹ä¸€ä¸ªæ–°çš„æ—¶é—´ç‰‡ã€‚ å¤šæœ‰è€…ç”±å½“å‰Pæ‹¥æœ‰ã€‚ å‚æ•°ï¼š_p_ *pï¼šå½“å‰æœ¬åœ°Pï¼Œå¯èƒ½å‡ºç°å…¶ä»–å·¥ä½œçº¿ç¨‹Må·å–Pçš„æƒ…å†µã€‚ è¿”å›å€¼ï¼š gp *gï¼šå½“å‰è·å–åˆ°çš„goroutineã€‚ inheritTime boolï¼šæ˜¯å¦ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5893 5894 5895 5896 5897 5898 5899 5900 5901 5902 5903 5904 5905 5906 5907 5908 5909 5910 5911 5912 5913 5914 5915 5916 5917 5918 5919 5920 5921 5922 5923 5924 5925 5926 5927 5928 5929 5930 5931 5932 5933 5934 5935 // Get g from local runnable queue. // If inheritTime is true, gp should inherit the remaining time in the // current time slice. Otherwise, it should start a new time slice. // Executed only by the owner P. func runqget(_p_ *p) (gp *g, inheritTime bool) { // If there's a runnext, it's the next G to run. // // å¦‚æœæœ‰ runnextï¼Œå®ƒå°±æ˜¯ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„ G next := _p_.runnext // If the runnext is non-0 and the CAS fails, it could only have been stolen by another P, // because other Ps can race to set runnext to 0, but only the current P can set it to non-0. // Hence, there's no need to retry this CAS if it falls. // // å¦‚æœ runnext æ˜¯ non-0 å¹¶ä¸” CAS å¤±è´¥ï¼Œå®ƒåªèƒ½è¢«å¦ä¸€ä¸ªPçªƒå–ï¼Œå› ä¸ºå…¶ä»–På¯ä»¥ç«ç›¸å°†runnextè®¾ç½®ä¸º0ï¼Œ // å½“å‰På¯ä»¥å°†å…¶è®¾ç½®ä¸ºé 0ã€‚ å› æ­¤ï¼Œå¦‚æœè¯¥ CAS å¤±è´¥ï¼Œåˆ™æ— éœ€é‡è¯•ã€‚ if next != 0 \u0026\u0026 _p_.runnext.cas(next, 0) { // ä» p.runnextä¸Šå–å‡ºçš„goroutineï¼Œéƒ½ç»§æ‰¿äº†ä¸Šæ¬¡çš„æ—¶é—´ç‰‡ // channel çš„sendå’Œrecvæ“ä½œéƒ½ä¼šæŠŠgoroutineæŒ‚åœ¨ p.runnext ä¸Š return next.ptr(), true } // p.runnext == 0 || å½“å‰goroutineå·²è¢«çªƒå–ã€‚ for { // åŸå­è¯»å– _p_.runqheadã€‚ // å½“å‰På’Œå…¶ä»–Pæ¥å·å–goroutineéƒ½æ˜¯ä»runqheadå¼€å§‹çš„ï¼Œå› æ­¤éœ€è¦åŸå­è¯»å–ã€‚ h := atomic.LoadAcq(\u0026_p_.runqhead) // load-acquire, synchronize with other consumers // runqtailï¼šåªæœ‰æœ¬åœ°Pä¼šä¿®æ”¹è¿™ä¸ªå€¼åŠ å…¥goroutineã€‚å½“å‰Påœ¨æ­¤æ“ä½œå› æ­¤runqtailä¸ä¼šæ”¹å˜ä¸éœ€åŸå­æ“ä½œã€‚ t := _p_.runqtail // æœ¬åœ°Pé˜Ÿåˆ—ä¸ºç©ºã€‚ if t == h { return nil, false } // å–å‡ºå½“å‰hä½ç½®ä¸Šçš„gï¼Œæ³¨æ„å¾ªç¯é˜Ÿåˆ—æ˜¯é€šè¿‡runqheadå’Œrunqtailä¸æ–­çš„ç´¯åŠ ç„¶åé€šè¿‡æ±‚ä½™åˆ¤æ–­ä½ç½®çš„ // ç”±äºrunqheadå’Œrunqtailéƒ½æ˜¯uint32ç±»å‹å¾ªç¯æ•°ç»„å¤§å°ä¸º256æ­£å¥½æ˜¯æ•´å€æ•°ï¼Œ // å› æ­¤uint32ä¸æ–­ç´¯è®¡æœ€åä¼šä»0åˆå¼€å§‹ï¼Œå½¢æˆä¸€ä¸ªå¾ªç¯ gp := _p_.runq[h%uint32(len(_p_.runq))].ptr() // CAS è®¾ç½® _p_.runqheadï¼Œè¿™æ®µæ—¶é—´å¯èƒ½ _p_.runqhead çš„å€¼å‘ç”Ÿå˜åŒ–è€Œå¤±è´¥ã€‚ if atomic.CasRel(\u0026_p_.runqhead, h, h+1) { // cas-release, commits consume return gp, false } } } injectglist() injectglist å°†åˆ—è¡¨ä¸Šçš„æ¯ä¸ªå¯è¿è¡Œçš„Gæ·»åŠ åˆ°æŸä¸ªè¿è¡Œé˜Ÿåˆ—ï¼Œå¹¶æ¸…é™¤glistã€‚ å¦‚æœå½“å‰ä¸å­˜åœ¨Pï¼Œåˆ™å°†å®ƒä»¬æ·»åŠ åˆ°å…¨å±€é˜Ÿåˆ—ï¼Œå¹¶å¯åŠ¨å¤šè¾¾npimä¸ªé˜Ÿåˆ—æ¥è¿è¡Œå®ƒä»¬ã€‚ å¦åˆ™ï¼Œå¯¹äºæ¯ä¸ªç©ºé—²çš„Pï¼Œå°†Gæ·»åŠ åˆ°å…¨å±€é˜Ÿåˆ—ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ªmã€‚å‰©ä½™çš„Gæ·»åŠ åˆ°å½“å‰Pçš„æœ¬åœ°å°±ç»ªé˜Ÿåˆ—ã€‚ è¿™å¯èƒ½ä¼šä¸´æ—¶è·å–sched.lockã€‚å¯ä»¥ä¸GCå¹¶å‘è¿è¡Œã€‚ è¯¥å‡½æ•°åœ¨netpollåè°ƒç”¨ï¼Œå¯ä»¥æ˜¯ç›‘æ§çº¿ç¨‹ä¸­è¿™ç§æƒ…å†µä¸‹æ²¡æœ‰Pï¼Œæˆ–åˆ™è°ƒåº¦å¾ªç¯ä¸­ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 3113 3114 3115 3116 3117 3118 3119 3120 3121 3122 3123 3124 3125 3126 3127 3128 3129 3130 3131 3132 3133 3134 3135 3136 3137 3138 3139 3140 3141 3142 3143 3144 3145 3146 3147 3148 3149 3150 3151 3152 3153 3154 3155 3156 3157 3158 3159 3160 3161 3162 3163 3164 3165 3166 3167 3168 3169 3170 3171 3172 3173 3174 3175 3176 3177 3178 3179 3180 3181 3182 3183 3184 3185 3186 3187 3188 3189 3190 3191 3192 3193 3194 3195 3196 3197 // injectglist adds each runnable G on the list to some run queue, // and clears glist. If there is no current P, they are added to the // global queue, and up to npidle M's are started to run them. // Otherwise, for each idle P, this adds a G to the global queue // and starts an M. Any remaining G's are added to the current P's // local run queue. // This may temporarily acquire sched.lock. // Can run concurrently with GC. func injectglist(glist *gList) { // goroutine ç©ºåˆ—è¡¨ if glist.empty() { return } if trace.enabled { for gp := glist.head.ptr(); gp != nil; gp = gp.schedlink.ptr() { traceGoUnpark(gp, 0) } } // Mark all the goroutines as runnable before we put them // on the run queues. head := glist.head.ptr() var tail *g // è·å–é˜Ÿåˆ—æœ€åä¸€ä¸ª goroutine qsize := 0 // è®°å½•goroutineæ•°é‡ // ä¿®æ”¹è¿™äº›goroutineçš„çŠ¶æ€ for gp := head; gp != nil; gp = gp.schedlink.ptr() { tail = gp qsize++ // _Gwaitingï¼šgoroutineé˜»å¡åœ¨runtimeä¸­ï¼Œæ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç ã€‚å®ƒä¸åœ¨ä»»ä½•runqä¸­ï¼Œä½†æ˜¯åº”è¯¥è¢«è®°å½•åœ¨å…¶ä»–åœ°æ–¹ã€‚ // _Grunnableï¼šgoroutineåº”è¯¥åœ¨æŸä¸ªrunqä¸­ï¼Œå½“å‰å¹¶æ²¡æœ‰åœ¨è¿è¡Œç”¨æˆ·ä»£ç ï¼Œå®ƒçš„æ ˆä¸å½’è‡ªå·±æ‰€æœ‰ã€‚ casgstatus(gp, _Gwaiting, _Grunnable) } // Turn the gList into a gQueue. // å°†è¿™ä¸ªgListè½¬æ¢ä¸ºä¸€ä¸ªgQueueã€‚ var q gQueue // åŒå‘é“¾è¡¨ q.head.set(head) q.tail.set(tail) *glist = gList{} startIdle := func(n int) { // æŒ‡å®šæ•°é‡çš„ç©ºé—²Pèµ·æ¥å·¥ä½œ for ; n != 0 \u0026\u0026 sched.npidle != 0; n-- { startm(nil, false) } } pp := getg().m.p.ptr() // pp // å¦‚æœæ¥è‡ªsysmonç›‘æ§çº¿ç¨‹ï¼Œpp = nilã€‚ if pp == nil { lock(\u0026sched.lock) // æ”¾å…¥å…¨å±€ sched.runq æ± ä¸­ globrunqputbatch(\u0026q, int32(qsize)) unlock(\u0026sched.lock) // å”¤é†’qsizeå¤šä¸ªç©ºé—²Pæ¥å¤„ç†è¿™äº›goroutine startIdle(qsize) return } // ä»¥ä¸‹æ˜¯å­˜åœ¨Pçš„æƒ…å†µ // ç©ºé—²çš„Pçš„æ•°é‡ npidle := int(atomic.Load(\u0026sched.npidle)) var globq gQueue var n int // æŠŠç©ºé—²Pæ•°é‡ä¸ªæ•°çš„goroutineæ”¾å…¥å…¨å±€æ± ä¸­ï¼Œç„¶åå”¤é†’Pèµ·æ¥å·¥ä½œ for n = 0; n \u003c npidle \u0026\u0026 !q.empty(); n++ { g := q.pop() globq.pushBack(g) } if n \u003e 0 { lock(\u0026sched.lock) // æ”¾å…¥å…¨å±€ sched.runq æ± ä¸­ globrunqputbatch(\u0026globq, int32(n)) unlock(\u0026sched.lock) // å”¤é†’qsizeå¤šä¸ªç©ºé—²Pæ¥å¤„ç†è¿™äº›goroutine startIdle(n) qsize -= n } if !q.empty() { // è¿˜å‰©çš„goroutineæ”¾å…¥æœ¬åœ°é˜Ÿåˆ—ä¸­ runqputbatch(pp, \u0026q, qsize) } } stealWork() stealWorkè¯•å›¾ä»ä»»ä½•Pä¸­çªƒå–ä¸€ä¸ªå¯è¿è¡Œçš„goroutineæˆ–timerã€‚ å¦‚æœè¿”å›å€¼newWorkä¸ºtrueï¼Œåˆ™æ–°å·¥ä½œå¯èƒ½å·²ç»å‡†å¤‡å¥½äº†ã€‚ å¦‚æœnowä¸æ˜¯0ï¼Œåˆ™ä¸ºå½“å‰æ—¶é—´ã€‚stealWorkè¿”å›ç»è¿‡çš„æ—¶é—´ï¼Œå¦‚æœnowè¢«ä¼ é€’ä¸º0ï¼Œåˆ™è¿”å›å½“å‰æ—¶é—´ã€‚ å‚æ•°now int64ï¼šä¸æ˜¯ 0ï¼Œåˆ™ä¸ºå½“å‰æ—¶é—´ã€‚ è¿”å›å€¼ï¼š gp *gï¼šè·å–åˆ°çš„goroutineã€‚ inheritTime boolï¼šæ˜¯å¦ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡ã€‚ rnow int64ï¼šè·å–æ—¶é—´ç‚¹ã€‚ pollUntil int64ï¼štimerçš„è§¦å‘æ—¶é—´ç‚¹ã€‚ newWork boolï¼šä¸º trueï¼Œåˆ™æ–°å·¥ä½œå¯èƒ½å·²ç»å‡†å¤‡å¥½äº†ã€‚ä¼šè·³è½¬åˆ°findRunnableå‡½æ•°topæ ‡ç­¾å¤„ä»æ–°å¼€å§‹ã€‚ çªƒå–é€»è¾‘ä¼šå¾ªç¯å°è¯•4æ¬¡ï¼Œæœ€åä¸€æ¬¡æ‰ä¼šçªƒå–runnextå’Œtimerï¼Œä¹Ÿå°±æ˜¯è¯´å‰3æ¬¡åªä¼šä»å…¶ä»–Pçš„æœ¬åœ°runqä¸­çªƒå–ã€‚ stealOrderç”¨æ¥å®ç°ä¸€ä¸ªå…¬å¹³çš„éšæœºçªƒå–é¡ºåºï¼ŒtimerpMaskå’ŒidlepMaskç”¨æ¥å¿«é€Ÿåˆ¤æ–­æŒ‡å®šä½ç½®çš„Pæ˜¯å¦æœ‰timeræˆ–æ˜¯ç©ºé—²ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 2899 2900 2901 2902 2903 2904 2905 2906 2907 2908 2909 2910 2911 2912 2913 2914 2915 2916 2917 2918 2919 2920 2921 2922 2923 2924 2925 2926 2927 2928 2929 2930 2931 2932 2933 2934 2935 2936 2937 2938 2939 2940 2941 2942 2943 2944 2945 2946 2947 2948 2949 2950 2951 2952 2953 2954 2955 2956 2957 2958 2959 2960 2961 2962 2963 2964 2965 2966 2967 2968 2969 2970 2971 2972 2973 2974 2975 2976 2977 2978 2979 2980 2981 2982 2983 2984 2985 2986 2987 2988 2989 2990 2991 2992 2993 2994 2995 2996 2997 2998 2999 3000 3001 3002 3003 3004 3005 3006 3007 3008 3009 3010 3011 3012 3013 3014 3015 3016 3017 // stealWork attempts to steal a runnable goroutine or timer from any P. // // If newWork is true, new work may have been readied. // // If now is not 0 it is the current time. stealWork returns the passed time or // the current time if now was passed as 0. func stealWork(now int64) (gp *g, inheritTime bool, rnow, pollUntil int64, newWork bool) { pp := getg().m.p.ptr() // pp = p ranTimer := false // newWork çš„è¿”å›å€¼ // å°è¯•å·å–æœ€å¤§æ¬¡æ•° const stealTries = 4 // æ‰§è¡Œå››æ¬¡éå†ï¼Œå°±æ˜¯å°½æœ€å¤§åŠªåŠ›å»å…¶ä»–Pä¸­æŸ¥çœ‹ for i := 0; i \u003c stealTries; i++ { // æœ€åä¸€æ¬¡æ—¶ï¼š // 1. å‰ä¸‰æ¬¡å°è¯•å»Pçš„runqæœ¬åœ°é˜Ÿåˆ—ä¸­å·å–goroutineã€‚ // 2. æœ€åä¸€æ¬¡å…ˆå»å„ä¸ªPçš„timersé‡Œçœ‹çœ‹ï¼Œç„¶åå½“å·å–çš„Pçš„runqä¸ºç©ºæ—¶ï¼Œ // å°è¯•å·å–P.runnextä¸Šçš„goroutineã€‚ stealTimersOrRunNextG := i == stealTries-1 // randomOrder/randomEnum æ˜¯éšæœºå·¥ä½œçªƒå–çš„è¾…åŠ©ç±»å‹ï¼Œä¸€è½®allpéå†å¼€å§‹ã€‚ // å®ƒä»¬å…è®¸ä»¥ä¸åŒçš„ä¼ªéšæœºé¡ºåºæšä¸¾æ‰€æœ‰ P è€Œä¸é‡å¤ã€‚ // è¯¥ç®—æ³•åŸºäºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼š // å¦‚æœæˆ‘ä»¬æœ‰Xä½¿å¾—Xå’ŒGOMAXPROCSäº’è´¨ï¼Œé‚£ä¹ˆ(i + X)%GOMAXPROCSçš„åºåˆ—ç»™å‡ºæ‰€éœ€çš„æšä¸¾ã€‚ // stealOrder.start(fastrand())ï¼šä»ä¸€ä¸ªéšæœºä½ç½®å¼€å§‹ã€‚ // !enum.done()ï¼šå½“å‰æ˜¯å¦å·²ç»éå†ä¸€åœˆäº†ã€‚ // enum.next()ï¼šè·³è½¬åˆ°ä¸‹ä¸€ä¸ªä½ç½®ã€‚ for enum := stealOrder.start(fastrand()); !enum.done(); enum.next() { // æœ‰STWæ­£åœ¨ç­‰å¾…PæŒ‚èµ·ã€‚ç›´æ¥è¿”å›ã€‚ // è·³è½¬åˆ°findRunnableå‡½æ•°topæ ‡ç­¾å¤„ä»æ–°å¼€å§‹ã€‚ if sched.gcwaiting != 0 { // GC work may be available. return nil, false, now, pollUntil, true } // éšæœºé€‰çš„pï¼Œå¦‚æœæ˜¯å½“å‰çš„è·³è¿‡ã€‚ // enum.position()ï¼šå½“å‰å·å–Pçš„ä¸‹æ ‡ã€‚ p2 := allp[enum.position()] if pp == p2 { continue } // Steal timers from p2. This call to checkTimers is the only place // where we might hold a lock on a different P's timers. We do this // once on the last pass before checking runnext because stealing // from the other P's runnext should be the last resort, so if there // are timers to steal do that first. // // We only check timers on one of the stealing iterations because // the time stored in now doesn't change in this loop and checking // the timers for each P more than once with the same value of now // is probably a waste of time. // // timerpMask tells us whether the P may have timers at all. If it // can't, no need to check at all. // // ä»p2ä¸­çªƒå– timersã€‚å¯¹checkTimersçš„è°ƒç”¨æ˜¯å”¯ä¸€å¯ä»¥å¯¹ä¸åŒPçš„timersæŒæœ‰é”çš„åœ°æ–¹ã€‚ // æˆ‘ä»¬åœ¨æ£€æŸ¥runnextä¹‹å‰çš„æœ€åä¸€éæ‰§è¡Œæ­¤æ“ä½œï¼Œå› ä¸ºä»å¦ä¸€ä¸ªPçš„runnextä¸­çªƒå–è®¡æ—¶å™¨åº”è¯¥æ˜¯æœ€åçš„æ‰‹æ®µï¼Œ // æ‰€ä»¥å¦‚æœæœ‰timerså¯ä»¥çªƒå–ï¼Œè¯·å…ˆçªƒå–ã€‚ // æˆ‘ä»¬åªæ£€æŸ¥å…¶ä¸­ä¸€ä¸ªçªƒå–è¿­ä»£çš„å®šæ—¶å™¨ï¼Œå› ä¸ºå­˜å‚¨åœ¨nowä¸­çš„æ—¶é—´åœ¨è¿™ä¸ªå¾ªç¯ä¸­ä¸ä¼šæ”¹å˜ï¼Œ // å¦‚æœç”¨ç›¸åŒçš„nowå€¼å¤šæ¬¡æ£€æŸ¥æ¯ä¸ªPçš„å®šæ—¶å™¨ï¼Œå¯èƒ½å°±æ˜¯æµªè´¹æ—¶é—´ã€‚ // timerpMaskå‘Šè¯‰æˆ‘ä»¬Pæ˜¯å¦æœ‰å®šæ—¶å™¨ã€‚å¦‚æœå®ƒä¸èƒ½ï¼Œæ ¹æœ¬ä¸éœ€è¦æ£€æŸ¥ã€‚ // timerpMask æ˜¯Pçš„ä½å›¾è®°å½•å½“å‰Pä¸Šæ˜¯å¦æœ‰ timerã€‚ if stealTimersOrRunNextG \u0026\u0026 timerpMask.read(enum.position()) { // å†æ¬¡çœ‹çœ‹ timersï¼Œæ˜¯å¦æœ‰åˆ°ç‚¹éœ€è¦æ‰§è¡Œçš„timerã€‚ // tnowï¼šè¿”å›çš„now // wï¼šè§¦å‘æ—¶é—´ç‚¹ // ranï¼štimeræ˜¯å¦å·²ç»è¿è¡Œäº† // å¦‚æœranä¸ºtrueï¼Œè¡¨ç¤ºcheckTimers()æ‰§è¡Œäº†p2çš„timerï¼Œ // å¯èƒ½ä¼šä½¿æŸäº›goroutineå˜æˆ_GrunnableçŠ¶æ€ï¼Œ // æ‰€ä»¥å…ˆæ£€æŸ¥å½“å‰Pçš„æœ¬åœ°runqï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ç»§ç»­å»å·å–ã€‚ tnow, w, ran := checkTimers(p2, now) now = tnow // w != 0ï¼šè¿˜æœªè§¦å‘çš„æ—¶é—´ç‚¹ // pollUntil == 0ï¼šä¸Šæ¬¡æ£€æŸ¥æ²¡æœ‰timer // w \u003c pollUntilï¼šè§¦å‘æ—¶é—´ç‚¹ç¼©å° if w != 0 \u0026\u0026 (pollUntil == 0 || w \u003c pollUntil) { pollUntil = w // æœ€è¿‘çš„timerè§¦å‘çš„æ—¶é—´ç‚¹ } // æœ‰è§¦å‘timerè¿è¡Œï¼Œéœ€è¦å»Pçš„æœ¬åœ°runqä¸­å»æ‰¾æ‰¾å¯èƒ½æœ‰goroutineè¢«æ”¾é‡Œé¢äº†ã€‚ // æ¯”å¦‚time.Sleepã€‚ if ran { // Running the timers may have // made an arbitrary number of G's // ready and added them to this P's // local run queue. That invalidates // the assumption of runqsteal // that it always has room to add // stolen G's. So check now if there // is a local G to run. if gp, inheritTime := runqget(pp); gp != nil { return gp, inheritTime, now, pollUntil, ranTimer } // æ ‡è®°ä¸ºtrueï¼Œå†æ¬¡è·‘ä¸€è¾¹è°ƒåº¦å¾ªç¯ ranTimer = true } } // Don't bother to attempt to steal if p2 is idle. // // å¦‚æœp2æ˜¯ç©ºé—²çš„ä¸è¦å°è¯•å·å–ã€‚ // åœ¨åˆ›å»ºgoroutineæ—¶å€™æˆ‘ä»¬é‡è§è¿‡idlepMaskï¼Œè¯¥å€¼æ˜¯Pçš„ä½å›¾ï¼Œè®°å½•äº†æ‰€æœ‰ç©ºé—²çš„Pçš„bitä½(åŸå­æ›´æ–°)ã€‚ // idlepMask.read(enum.position())ï¼štrue.å½“å‰Pæ˜¯ç©ºé—²çš„ï¼Œfalse.å½“å‰Pä¸æ˜¯ç©ºé—²çš„ã€‚ if !idlepMask.read(enum.position()) { // runqsteal å‡½æ•°ä»p2ä¸­å·å–goroutineåˆ°ppä¸­ã€‚ // stealTimersOrRunNextGè¡¨ç¤ºæœ€å¤§ç¨‹åº¦å·å–runnextã€‚ if gp := runqsteal(pp, p2, stealTimersOrRunNextG); gp != nil { return gp, false, now, pollUntil, ranTimer } } } } // No goroutines found to steal. Regardless, running a timer may have // made some goroutine ready that we missed. Indicate the next timer to // wait for. return nil, false, now, pollUntil, ranTimer } runqsteal() ä»p2çš„æœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ—ä¸­çªƒå–ä¸€åŠçš„gï¼Œå¹¶æ”¾å…¥pçš„æœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ—ä¸­ã€‚ è¿”å›ä¸€ä¸ªè¢«çªƒå–çš„g(å¦‚æœå¤±è´¥åˆ™è¿”å›nil)ã€‚ å‚æ•°ï¼š _p_ *pï¼šå½“å‰çªƒå–å…¶ä»–Pçš„å·¥ä½œçº¿ç¨‹ç»‘å®šçš„Pã€‚ p2 *pï¼šè¢«çªƒå–çš„Pã€‚ stealRunNextG boolï¼štrueå°½æœ€å¤§åŠªåŠ›å»p.runnextä¸Šå·å–ï¼Œfalseä¸å·å–p.runnextçš„goroutineã€‚ è¿”å›å€¼*gï¼šå·å–åˆ°çš„goroutineã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 6015 6016 6017 6018 6019 6020 6021 6022 6023 6024 6025 6026 6027 6028 6029 6030 6031 6032 6033 6034 6035 6036 6037 6038 6039 6040 6041 6042 6043 // Steal half of elements from local runnable queue of p2 // and put onto local runnable queue of p. // Returns one of the stolen elements (or nil if failed). func runqsteal(_p_, p2 *p, stealRunNextG bool) *g { t := _p_.runqtail // å°è¯•ä»p2ä¸­å·å–ä¸€åŠçš„goroutineã€‚ n := runqgrab(p2, \u0026_p_.runq, t, stealRunNextG) // p2ä¸­ä¹Ÿæ²¡æœ‰ if n == 0 { return nil } // ä»pçš„æœ¬åœ°runqä¸­å–å‡ºä¸€ä¸ªgoroutineï¼Œç”¨äºè¿”å›ç»™è°ƒåº¦å™¨è°ƒåº¦èµ·æ¥ã€‚ n-- // å› ä¸ºå·å–æ˜¯ä»runqtailå¼€å§‹çš„ï¼Œå› æ­¤runqtailå¤„ä¹Ÿæ˜¯headå¤´å¤„ã€‚ // å…¶å®æ˜¯å–çš„é˜Ÿåˆ—ä¸­çš„æœ€åä¸€ä¸ªï¼Œæ–¹ä¾¿åé¢ StoreRel åŸå­æ“ä½œè®¾ç½® runqtail å€¼ã€‚ gp := _p_.runq[(t+n)%uint32(len(_p_.runq))].ptr() if n == 0 { return gp } // è¿˜æœ‰å…¶ä»–çš„éœ€è¦å¤„ç†ï¼ŒåŸå­è¯»å– _p_.runqhead h := atomic.LoadAcq(\u0026_p_.runqhead) // load-acquire, synchronize with consumers // è¿™é‡Œåˆ¤æ–­å·å–çš„gæ˜¯å¦å¤§äºPæœ¬åœ°çš„ä¸€åŠæ•°é‡ï¼Œåˆ™æ˜¯æº¢å‡ºäº† if t-h+n \u003e= uint32(len(_p_.runq)) { throw(\"runqsteal: runq overflow\") } // åŸå­è®¾ç½® _p_.runqtail = t+n atomic.StoreRel(\u0026_p_.runqtail, t+n) // store-release, makes the item available for consumption return gp } runqgrab() ä»_p_çš„å¯è¿è¡Œé˜Ÿåˆ—ä¸­è·å–ä¸€æ‰¹goroutinesåˆ°batchã€‚ Batchæ˜¯ä¸€ä¸ªä»batchHeadå¼€å§‹çš„ç¯å½¢ç¼“å†²åŒºã€‚ è¿”å›æŠ“å–çš„goroutinesçš„æ•°é‡ã€‚å¯ä»¥è¢«ä»»æ„Pæ‰§è¡Œã€‚ å‚æ•°ï¼šå‡è®¾ä»p2å·å–åˆ°pã€‚ _p_ *pï¼šå·å–ç›®æ ‡çš„Pã€‚å°±æ˜¯p2. batch *[256]guintptrï¼šä»_p_å·å–goroutineéœ€è¦æ”¾åˆ°çš„Pçš„runqæœ¬åœ°é˜Ÿåˆ—æ± ã€‚å°±æ˜¯pçš„æœ¬åœ°runqæ± ã€‚ batchHead uint32ï¼špçš„runqtailå¤„ã€‚ stealRunNextG boolï¼šæ˜¯å¦è¿‘æœ€å¤§åŠªåŠ›å»runnextä¸Šå·å–ã€‚ è¿”å›å€¼ï¼šuint32ï¼šå·å–goroutineçš„æ•°é‡ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5959 5960 5961 5962 5963 5964 5965 5966 5967 5968 5969 5970 5971 5972 5973 5974 5975 5976 5977 5978 5979 5980 5981 5982 5983 5984 5985 5986 5987 5988 5989 5990 5991 5992 5993 5994 5995 5996 5997 5998 5999 6000 6001 6002 6003 6004 6005 6006 6007 6008 6009 6010 6011 6012 6013 6014 6015 6016 6017 6018 6019 6020 6021 6022 6023 6024 6025 6026 6027 6028 6029 6030 6031 6032 6033 6034 6035 6036 6037 6038 6039 6040 6041 6042 6043 6044 6045 6046 6047 6048 // Grabs a batch of goroutines from _p_'s runnable queue into batch. // Batch is a ring buffer starting at batchHead. // Returns number of grabbed goroutines. // Can be executed by any P. func runqgrab(_p_ *p, batch *[256]guintptr, batchHead uint32, stealRunNextG bool) uint32 { // å·å–goroutineçš„ä»£ç é‡‡ç”¨çš„æ˜¯è‡ªæ—‹æ–¹å¼ï¼Œè€Œæ²¡æœ‰é‡‡ç”¨é”æ¥å®ç°ã€‚ for { // _p_ æ˜¯ p2ï¼Œä¹‹æ‰€ä»¥éœ€è¦åŸå­è¯»å–å› ä¸ºp2æ­£åœ¨è¿è¡Œæœ‰å¹¶å‘çš„å¯èƒ½ã€‚ h := atomic.LoadAcq(\u0026_p_.runqhead) // load-acquire, synchronize with other consumers t := atomic.LoadAcq(\u0026_p_.runqtail) // load-acquire, synchronize with the producer // ä¸ºä»€ä¹ˆä¸æ‹…å¿ƒ runqtail æº¢å‡ºï¼Ÿ // å› ä¸ºï¼Œrunqtailå’Œrunqheadéƒ½æ˜¯uint32ç±»å‹ï¼Œå°±ç®—æº¢å‡ºä¹Ÿèƒ½ä¿è¯è®¡ç®—æ­£ç¡®ã€‚æ¯”å¦‚ 0 - 3 ä¹Ÿèƒ½å¾—åˆ°æ­£ç¡®å€¼ n := t - h n = n - n/2 // è®¡ç®—å·å–çš„æ•°é‡ï¼Œä¸ºå½“å‰å®¹é‡çš„ä¸€åŠã€‚ // p2 ä¸­æœ¬åœ°runqæ± ä¸­æ²¡æœ‰goroutineã€‚ if n == 0 { // p2æœ¬åœ°runqæ± ä¸ºç©ºï¼Œå°è¯•å» runnext è·å–goroutineã€‚ if stealRunNextG { // Try to steal from _p_.runnext. // // å°è¯•ä» _p_.runnext ä¸­å·å–ã€‚ if next := _p_.runnext; next != 0 { // _p_.runnext ä¸Šæœ‰goroutineã€‚ if _p_.status == _Prunning { // å½“å‰Pæ­£åœ¨è¿è¡Œä¸­ // Sleep to ensure that _p_ isn't about to run the g // we are about to steal. // The important use case here is when the g running // on _p_ ready()s another g and then almost // immediately blocks. Instead of stealing runnext // in this window, back off to give _p_ a chance to // schedule runnext. This will avoid thrashing gs // between different Ps. // A sync chan send/recv takes ~50ns as of time of // writing, so 3us gives ~50x overshoot. // // Sleep å·²ç¡®ä¿ _p_ ä¸ä¼šè¿è¡Œæˆ‘ä»¬å°†è¦åˆ‡å–çš„gã€‚ // è¿™é‡Œçš„é‡è¦ç”¨ä¾‹æ˜¯å½“ g åœ¨ _p_ ready() ä¸Šè¿è¡Œæ—¶ï¼Œå¦ä¸€ä¸ª g ç„¶åå‡ ä¹ç«‹å³é˜»å¡ã€‚ // ä¸è¦åœ¨è¿™ä¸ªçª—å£æœŸåˆ‡å– runnextï¼Œè€Œæ˜¯é€€è€Œæ±‚å…¶æ¬¡ï¼Œè®©_p_æœ‰æœºä¼šè°ƒåº¦runnextã€‚ // è¿™å°†é¿å…gåœ¨ä¸åŒçš„Psä¹‹é—´çš„æŠ–åŠ¨ã€‚ // sync chan çš„ send/recv å¤§çº¦éœ€è¦ ~50nsï¼Œæ‰€ä»¥ç»™å‡º 3us å¤§çº¦æ˜¯å®ƒçš„ 50x å€ã€‚ if GOOS != \"windows\" \u0026\u0026 GOOS != \"openbsd\" \u0026\u0026 GOOS != \"netbsd\" { usleep(3) // sleep 3us } else { // On some platforms system timer granularity is // 1-15ms, which is way too much for this // optimization. So just yield. // // åœ¨æŸäº›å¹³å°ä¸Šï¼Œç³»ç»Ÿè®¡æ—¶å™¨ç²’åº¦ä¸º1-15msï¼Œè¿™å¯¹äºè¿™ç§ä¼˜åŒ–æ¥è¯´å¤ªè¿‡äº†ã€‚æ‰€ä»¥å°±å±ˆæœå§ã€‚ osyield() // åœ¨semaphoreä¸­æœ‰ç›¸å…³çš„ä»‹ç»ã€‚ä¼šå°è¯•è®©å‡ºCPUï¼Œè®©å…¶ä»–ä¼˜å…ˆçº§æ›´é«˜çš„çº¿ç¨‹æ‰§è¡Œã€‚ } } // CAS æ“ä½œäº¤æ¢ _p_.runnext å°è¯•å·å– goroutineã€‚ // å¤§æ¦‚ç‡ä¼šå¤±è´¥ä»è¿™é‡Œç›´æ¥é€€å‡ºã€‚ if !_p_.runnext.cas(next, 0) { continue } // å·å–åˆ°goroutineæŠŠå®ƒæ”¾å…¥Pçš„æœ¬åœ°runqæ± ã€‚ batch[batchHead%uint32(len(batch))] = next return 1 } } return 0 } // è¯»å–ä¸ä¸€è‡´çš„ h å’Œ t å€¼ã€‚ // å°ç»†èŠ‚ï¼šæŒ‰ç†è¯´é˜Ÿåˆ—ä¸­çš„goroutineä¸ªæ•°æœ€å¤šå°±æ˜¯len(_p_.runq)ï¼Œæ‰€ä»¥nçš„æœ€å¤§å€¼ä¹Ÿå°±æ˜¯len(_p_.runq)/2ï¼Œ // é‚£ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªåˆ¤æ–­å‘¢ï¼Ÿ // åŸå› ï¼šè¯»å–runqheadå’Œrunqtailæ˜¯ä¸¤ä¸ªæ“ä½œè€Œéä¸€ä¸ªåŸå­æ“ä½œï¼Œå½“æˆ‘ä»¬è¯»å–runqheadä¹‹åä½†è¿˜æœªè¯»å–runqtailä¹‹å‰ï¼Œ // å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹å¿«é€Ÿçš„åœ¨å¢åŠ ï¼ˆè¿™æ˜¯å®Œå…¨æœ‰å¯èƒ½çš„ï¼Œå…¶å®ƒå·å–è€…ä»é˜Ÿåˆ—ä¸­å·å–goroutineä¼šå¢åŠ runqheadï¼Œ // è€Œé˜Ÿåˆ—çš„æ‰€æœ‰è€…å¾€é˜Ÿåˆ—ä¸­æ·»åŠ goroutineä¼š å¢åŠ runqtailï¼‰è¿™ä¸¤ä¸ªå€¼ï¼Œåˆ™ä¼šå¯¼è‡´æˆ‘ä»¬è¯»å–å‡ºæ¥çš„runqtailå·²ç»è¿œè¿œå¤§äº // æˆ‘ä»¬ä¹‹å‰è¯»å–å‡ºæ¥æ”¾åœ¨å±€éƒ¨å˜é‡hé‡Œé¢çš„runqheadäº†ã€‚ // ä¹Ÿå°±æ˜¯ä»£ç æ³¨é‡Šä¸­æ‰€è¯´çš„hå’Œtå·²ç»ä¸ä¸€è‡´äº†ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è¿™ä¸ªifåˆ¤æ–­æ¥æ£€æµ‹å¼‚å¸¸æƒ…å†µã€‚ // å¦‚æœ n \u003e uint32(len(_p_.runq)/2) æˆç«‹è¯´æ˜åœ¨t := atomic.LoadAcq(\u0026_p_.runqtail)ä»£ç årunqtailå‘ç”Ÿäº†å˜åŒ–ã€‚ if n \u003e uint32(len(_p_.runq)/2) { // read inconsistent h and t continue } // ä»p2ä¸­æ‹·è´goroutineåˆ°pçš„runqæœ¬åœ°æ±  for i := uint32(0); i \u003c n; i++ { g := _p_.runq[(h+i)%uint32(len(_p_.runq))] // ä»p2çš„hå¤„å¾€åå–goroutine batch[(batchHead+i)%uint32(len(batch))] = g// ä»p.runqtailå¾€åæœ€åŠ  } // CAS åŸå­äº¤æ¢ p2.runqhead ä» h ä¿®æ”¹ä¸º h+nï¼Œå¦‚æœå¤±è´¥è¯´æ˜hè¢«ä¿®æ”¹äº† // 1. å¯èƒ½å…¶ä»–Pä¹Ÿåœ¨å·å–è¿™ä¸ªPçš„goroutineå¹¶ä¸”å·å–æˆåŠŸäº†ã€‚ // 2. å½“å‰è¢«å·å–çš„è¿™ä¸ªPå¯èƒ½ä¹Ÿåœ¨å–runqheadå‡ºçš„goroutineæ¥è¿è¡Œã€‚å¯¼è‡´runqheadå˜åŒ–ã€‚ // ä¸ºä»€ä¹ˆä¸æ‹…å¿ƒ runqtail çš„å€¼å‘¢ï¼Ÿè€Œæ˜¯åªéœ€è¦ä¿è¯ runqhead å’Œ runqtail ä¸€èµ·æ˜¯åŸå­çš„å‘¢ï¼Ÿ // å› ä¸ºï¼Œrunqtail åªæœ‰å½“å‰Pæ­£æœ€åŠ ï¼Œå¹¶ä¸”æ˜¯é€’å¢çš„ï¼Œèƒ½ä¿è¯æˆ‘ä»¬è¦å»çš„æ•°æ®nã€‚ if atomic.CasRel(\u0026_p_.runqhead, h, h+n) { // cas-release, commits consume return n } } } type randomOrder struct stealOrderç”¨æ¥å®ç°ä¸€ä¸ªå…¬å¹³çš„éšæœºçªƒå–é¡ºåºã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ // å…³äºå–På¾—ç®—æ³• var stealOrder randomOrder // randomOrder/randomEnum are helper types for randomized work stealing. // They allow to enumerate all Ps in different pseudo-random orders without repetitions. // The algorithm is based on the fact that if we have X such that X and GOMAXPROCS // are coprime, then a sequences of (i + X) % GOMAXPROCS gives the required enumeration. // // randomOrder/randomEnum æ˜¯éšæœºå·¥ä½œçªƒå–çš„è¾…åŠ©ç±»å‹ // å®ƒä»¬å…è®¸ä»¥ä¸åŒçš„ä¼ªéšæœºé¡ºåºæšä¸¾æ‰€æœ‰ P è€Œä¸é‡å¤ // è¯¥ç®—æ³•åŸºäºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼š // å¦‚æœæˆ‘ä»¬æœ‰ X ä½¿å¾— X å’Œ GOMAXPROCS äº’è´¨ï¼Œé‚£ä¹ˆ (i + X) %GOMAXPROCS çš„åºåˆ—ç»™å‡ºæ‰€éœ€çš„æšä¸¾ type randomOrder struct { count uint32 // å­˜å‚¨å½“å‰æ‰€æœ‰çš„Pæ•°é‡ï¼Œä¹Ÿæ˜¯CPUçš„æ ¸æ•° coprimes []uint32 // å­˜å‚¨ä¸countäº’è´¨æ•°é›† } type randomEnum struct { i uint32 // ä»0å¼€å§‹è®°å½•éå†çš„æ¬¡æ•° count uint32 // randomOrder.count pos uint32 // å½“å‰åœ¨[0, count-1]èŒƒå›´çš„ä¸‹æ ‡ä½ç½® inc uint32 // å½“å‰åœ¨randomOrder.coprimesä¸­é€‰å–çš„å€¼ } // é‡ç½®randomOrder func (ord *randomOrder) reset(count uint32) { ord.count = count\t// è®°å½•æ€»ä¸ªæ•° ord.coprimes = ord.coprimes[:0] // æ¸…ç©ºcoprimes for i := uint32(1); i \u003c= count; i++ { if gcd(i, count) == 1 { ord.coprimes = append(ord.coprimes, i) } } } // ç”Ÿæˆäº’è´¨æ•°å‡½æ•° func gcd(a, b uint32) uint32 { for b != 0 { a, b = b, a%b } return a } // å¼€å§‹ func (ord *randomOrder) start(i uint32) randomEnum { return randomEnum{ count: ord.count, pos: i % ord.count, inc: ord.coprimes[i%uint32(len(ord.coprimes))], } } // å½“å‰æ˜¯å¦éå†ä¸€åœˆäº† func (enum *randomEnum) done() bool { return enum.i == enum.count } // ä¸‹ä¸€ä¸ªäº’è´¨æ•° func (enum *randomEnum) next() { enum.i++ enum.pos = (enum.pos + enum.inc) % enum.count\t// è¿™é‡Œæ˜¯éšæœºçš„é€‰å–ä¸‹ä¸€ä¸ªéšæœºå¤„ } // è·å–å½“å‰ä½ç½® func (enum *randomEnum) position() uint32 { return enum.pos } // ç›—å–ç®—æ³•è§£é‡Š // 1. ç›—å–è¿‡ç¨‹ç”¨äº†ä¸¤ä¸ªåµŒå¥—forå¾ªç¯ã€‚ // 2. å†…å±‚å¾ªç¯å®ç°äº†ç›—å–é€»è¾‘ï¼Œä»ä»£ç å¯ä»¥çœ‹å‡ºç›—å–çš„å®è´¨å°±æ˜¯éå†allpä¸­çš„æ‰€æœ‰pï¼ŒæŸ¥çœ‹å…¶è¿è¡Œé˜Ÿåˆ—æ˜¯å¦æœ‰goroutineï¼Œå¦‚æœæœ‰ï¼Œ // åˆ™å–å…¶ä¸€åŠåˆ°å½“å‰å·¥ä½œçº¿ç¨‹çš„è¿è¡Œé˜Ÿåˆ—ï¼Œç„¶åä»findrunnableè¿”å›ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç»§ç»­éå†ä¸‹ä¸€ä¸ªp // 3. ä½†è¿™é‡Œä¸ºäº†ä¿è¯å…¬å¹³æ€§ï¼Œéå†allpæ—¶å¹¶ä¸æ˜¯å›ºå®šçš„ä»allp[0]å³ç¬¬ä¸€ä¸ªpå¼€å§‹ï¼Œè€Œæ˜¯ä»éšæœºä½ç½®ä¸Šçš„på¼€å§‹ï¼Œ // è€Œä¸”éå†çš„é¡ºåºä¹ŸéšæœºåŒ–äº†ï¼Œå¹¶ä¸æ˜¯ç°åœ¨è®¿é—®äº†ç¬¬iä¸ªpä¸‹ä¸€æ¬¡å°±è®¿é—®ç¬¬i+1ä¸ªpï¼Œ // è€Œæ˜¯ä½¿ç”¨äº†ä¸€ç§ä¼ªéšæœºçš„æ–¹å¼éå†allpä¸­çš„æ¯ä¸ªpï¼Œé˜²æ­¢æ¯æ¬¡éå†æ—¶ä½¿ç”¨åŒæ ·çš„é¡ºåºè®¿é—®allpä¸­çš„å…ƒç´  // ä¸‹é¢æ˜¯è¿™ä¸ªç®—æ³•çš„ä¼ªä»£ç ï¼š // offset := uint32(random()) % nprocs // coprime := éšæœºé€‰å–ä¸€ä¸ªå°äºnprocsä¸”ä¸nprocsäº’è´¨çš„æ•° // for i := 0; i \u003c nprocs; i++ { // p := allp[offset] // ä»pçš„è¿è¡Œé˜Ÿåˆ—å·å–goroutine // if å·å–æˆåŠŸ { // break // } // offset += coprime // offset = offset % nprocs // } // // ä¸‹é¢ä¸¾ä¾‹è¯´æ˜ä¸€ä¸‹ä¸Šè¿°ç®—æ³•è¿‡ç¨‹ï¼Œç°å‡è®¾nprocsä¸º8ï¼Œä¹Ÿå°±æ˜¯ä¸€å…±æœ‰8ä¸ªp // å¦‚æœç¬¬ä¸€æ¬¡éšæœºé€‰æ‹©çš„offset = 6ï¼Œcoprime = 3(3ä¸8äº’è´¨ï¼Œæ»¡è¶³ç®—æ³•è¦æ±‚)çš„è¯ï¼Œåˆ™ä»allpåˆ‡ç‰‡ä¸­å·å–çš„ä¸‹æ ‡é¡ºåºä¸º // 6, 1, 4, 7, 2, 5, 0, 3ï¼Œè®¡ç®—è¿‡ç¨‹ï¼š // 6ï¼Œ(6+3)%8=1ï¼Œ(1+3)%8=4, (4+3)%8=7, (7+3)%8=2, (2+3)%8=5, (5+3)%8=0, (0+3)%8=3 // å¦‚æœç¬¬äºŒæ¬¡éšæœºé€‰æ‹©çš„offset = 4ï¼Œcoprime = 5çš„è¯ï¼Œåˆ™ä»allpåˆ‡ç‰‡ä¸­å·å–çš„ä¸‹æ ‡é¡ºåºä¸º // 1, 6, 3, 0, 5, 2, 7, 4ï¼Œè®¡ç®—è¿‡ç¨‹ï¼š // 1ï¼Œ(1+5)%8=6ï¼Œ(6+5)%8=3, (3+5)%8=0, (0+5)%8=5, (5+5)%8=2, (2+5)%8=7, (7+5)%8=4 releasep() è§£é™¤å½“å‰Må’ŒPçš„ç»‘å®šå…³ç³»ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 4984 4985 4986 4987 4988 4989 4990 4991 4992 4993 4994 4995 4996 4997 4998 4999 5000 5001 5002 5003 5004 5005 5006 5007 5008 5009 5010 // Disassociate p and the current m. func releasep() *p { _g_ := getg() // è·å–å½“å‰è¿è¡Œçš„gï¼Œè¿™é‡Œæ˜¯g0 if _g_.m.p == 0 { // å½“å‰è¦è§£ç»‘çš„Pä¸å­˜åœ¨ï¼Œç³»ç»Ÿä»£ç æœ‰é€»è¾‘é—®é¢˜ throw(\"releasep: invalid arg\") } _p_ := _g_.m.p.ptr() // è·å–å½“å‰å·¥ä½œçº¿ç¨‹Mç»‘å®šçš„Pï¼Œä¹Ÿå°±æ˜¯éœ€è¦è§£ç»‘çš„P // _Prunning è¡¨ç¤º P ç”± M æ‹¥æœ‰å¹¶ç”¨äºè¿è¡Œç”¨æˆ·ä»£ç æˆ–è°ƒåº¦ç¨‹åº // åªæœ‰æ‹¥æœ‰è¿™ä¸ª P çš„ M æ‰å…è®¸ä» _Prunning æ›´æ”¹ P çš„çŠ¶æ€ // M å¯ä»¥å°† P è½¬æ¢ä¸º _Pidleï¼ˆå¦‚æœå®ƒæ²¡æœ‰æ›´å¤šå·¥ä½œè¦åšï¼‰ã€_Psyscallï¼ˆå½“è¿›å…¥ç³»ç»Ÿè°ƒç”¨æ—¶ï¼‰æˆ– _Pgcstopï¼ˆåœæ­¢ GCï¼‰ // M ä¹Ÿå¯ä»¥å°† P çš„æ‰€æœ‰æƒç›´æ¥äº¤ç»™å¦ä¸€ä¸ª Mï¼ˆä¾‹å¦‚ï¼Œå®‰æ’é”å®šçš„ Gï¼‰ if _p_.m.ptr() != _g_.m || _p_.status != _Prunning { // å½“å‰Pç»‘å®šçš„mä¸gç»‘å®šçš„mä¸æ˜¯åŒä¸€ä¸ª æˆ– å½“å‰Pä¸æ˜¯_PrunningçŠ¶æ€ print(\"releasep: m=\", _g_.m, \" m-\u003ep=\", _g_.m.p.ptr(), \" p-\u003em=\", hex(_p_.m), \" p-\u003estatus=\", _p_.status, \"\\n\") throw(\"releasep: invalid p state\") } if trace.enabled { traceProcStop(_g_.m.p.ptr()) } _g_.m.p = 0\t// è§£ç»‘å·¥ä½œçº¿ç¨‹Mä¸Pçš„å…³è” _p_.m = 0\t// è§£ç»‘Pä¸Mçš„å…³è” // _Pidle è¡¨ç¤º P æœªç”¨äºè¿è¡Œç”¨æˆ·ä»£ç æˆ–è°ƒåº¦ç¨‹åº // é€šå¸¸ï¼Œå®ƒä½äºç©ºé—² P åˆ—è¡¨ä¸­å¹¶ä¸”å¯ä¾›è°ƒåº¦ç¨‹åºä½¿ç”¨ï¼Œä½†å®ƒå¯èƒ½åªæ˜¯åœ¨å…¶ä»–çŠ¶æ€ä¹‹é—´è½¬æ¢ // P ç”±ç©ºé—²åˆ—è¡¨æˆ–æ­£åœ¨è½¬æ¢å…¶çŠ¶æ€çš„ä»»ä½•ä¸œè¥¿æ‹¥æœ‰ã€‚ å®ƒçš„è¿è¡Œé˜Ÿåˆ—æ˜¯ç©ºçš„ _p_.status = _Pidle return _p_\t// è¿”å›å½“å‰P } pidleput() pidleput å°†pæ”¾åˆ°_Pidleåˆ—è¡¨ä¸­ã€‚ è¿™é‡Šæ”¾äº†pçš„æ‰€æœ‰æƒã€‚ä¸€æ—¦sched.lockè¢«é‡Šæ”¾ï¼Œä½¿ç”¨på°±ä¸å†å®‰å…¨äº†ã€‚ sched.lockå¿…é¡»è¢«æŒæœ‰ï¼Œå¯ä»¥åœ¨STWæœŸé—´è¿è¡Œï¼Œå› æ­¤ä¸å…è®¸å†™å…¥å±éšœã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5696 5697 5698 5699 5700 5701 5702 5703 5704 5705 5706 5707 5708 5709 5710 5711 5712 5713 5714 5715 5716 5717 5718 5719 // pidleput puts p to on the _Pidle list. // // This releases ownership of p. Once sched.lock is released it is no longer // safe to use p. // // sched.lock must be held. // // May run during STW, so write barriers are not allowed. //go:nowritebarrierrec func pidleput(_p_ *p) { assertLockHeld(\u0026sched.lock) // åˆ¤æ–­Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸åº”è¯¥è¿˜æœ‰goroutineï¼Œåˆ¤æ–­ä¸‹ if !runqempty(_p_) { throw(\"pidleput: P has non-empty run queue\") } // å¦‚æœPæ²¡æœ‰timerï¼Œå°†æ¸…é™¤timerpMaskä½ä¸Šå¯¹åº”çš„æ©ç ä½ï¼ŒtimerpMaskæ˜¯è®°å½•å¿™ç¢Œçš„ updateTimerPMask(_p_) // clear if there are no timers. idlepMask.set(_p_.id) // è®¾ç½®idlepMaskå¯¹åº”çš„Pçš„æ©ç ä½ï¼ŒidlepMaskæ˜¯è®°å½•ç©ºé—²çš„ _p_.link = sched.pidle // å½“å‰Pè®°å½•å…¨å±€çš„ç©ºé—²é“¾è¡¨ sched.pidle.set(_p_) // æŠŠå½“å‰Pé“¾æ¥åˆ°å…¨å±€ç©ºé—²é“¾è¡¨å // ä½¿ç”¨åŸå­é”æŠŠå½“å‰schedç©ºé—²çš„Pæ•°é‡åŠ 1 atomic.Xadd(\u0026sched.npidle, 1) // TODO: fast atomic } runqempty() runqempty æŠ¥å‘Š_p_åœ¨å…¶æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­æ˜¯å¦æ²¡æœ‰ Gsã€‚ å®ƒæ°¸è¿œä¸ä¼šè™šå‡åœ°è¿”å›trueã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5752 5753 5754 5755 5756 5757 5758 5759 5760 5761 5762 5763 5764 5765 5766 5767 5768 5769 5770 5771 5772 5773 // runqempty reports whether _p_ has no Gs on its local run queue. // It never returns true spuriously. func runqempty(_p_ *p) bool { // Defend against a race where 1) _p_ has G1 in runqnext but runqhead == runqtail, // 2) runqput on _p_ kicks G1 to the runq, 3) runqget on _p_ empties runqnext. // Simply observing that runqhead == runqtail and then observing that runqnext == nil // does not mean the queue is empty. // // ä»¥ä¸‹æƒ…å†µï¼š // 1. _p_ åœ¨ runqnext ä¸­æœ‰ G1 ä½† runqhead == runqtail // 2. _p_ ä¸Šçš„ runqput å°† G1 è¸¢åˆ° runq // 3. _p_ ä¸Šçš„ runqget æ¸…ç©º runqnext // ç®€å•åœ°è§‚å¯Ÿ runqhead == runqtail ç„¶åè§‚å¯Ÿ runqnext == nil å¹¶ä¸æ„å‘³ç€é˜Ÿåˆ—æ˜¯ç©ºçš„ for { head := atomic.Load(\u0026_p_.runqhead)\ttail := atomic.Load(\u0026_p_.runqtail) runnext := atomic.Loaduintptr((*uintptr)(unsafe.Pointer(\u0026_p_.runnext))) if tail == atomic.Load(\u0026_p_.runqtail) { return head == tail \u0026\u0026 runnext == 0 } } } pidleget() ç›¸å…³è”å‡½æ•°pidlegetä»ç©ºé—²åˆ—è¡¨ä¸­è·å–ä¸€ä¸ªPã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5727 5728 5729 5730 5731 5732 5733 5734 5735 5736 5737 5738 5739 5740 5741 5742 5743 5744 5745 5746 5747 5748 5749 5750 // pidleget tries to get a p from the _Pidle list, acquiring ownership. // // sched.lock must be held. // // May run during STW, so write barriers are not allowed. // //go:nowritebarrierrec func pidleget(now int64) (*p, int64) { assertLockHeld(\u0026sched.lock) _p_ := sched.pidle.ptr() if _p_ != nil { // Timer may get added at any time now. if now == 0 { now = nanotime() } timerpMask.set(_p_.id) idlepMask.clear(_p_.id) sched.pidle = _p_.link atomic.Xadd(\u0026sched.npidle, -1) _p_.limiterEvent.stop(limiterEventIdle, now) } return _p_, now } checkRunqsNoP() æ£€æŸ¥å¿«ç…§ä¸­æ‰€æœ‰çš„Pæ˜¯å¦æœ‰å¯ä»¥å·å–çš„Gã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 2974 2975 2976 2977 2978 2979 2980 2981 2982 2983 2984 2985 2986 2987 2988 2989 2990 2991 2992 2993 2994 2995 2996 2997 2998 2999 // Check all Ps for a runnable G to steal. // // On entry we have no P. If a G is available to steal and a P is available, // the P is returned which the caller should acquire and attempt to steal the // work to. func checkRunqsNoP(allpSnapshot []*p, idlepMaskSnapshot pMask) *p { // å˜é‡allpçš„å¿«ç…§ï¼Œallpè®°å½•äº†æ‰€æœ‰çš„Påˆ—è¡¨ for id, p2 := range allpSnapshot {\t// ä¼‘çœ ä¹‹å‰åœ¨çœ‹ä¸€ä¸‹æ˜¯å¦æœ‰å·¥ä½œè¦åš // idlepMaskSnapshot å¿«ç…§è®°å½•ç€å½“å‰Pçš„çŠ¶æ€ // !idlepMaskSnapshot.read(uint32(id)) å½“å‰PçŠ¶æ€ä¸ä¸ºç©ºçš„ å¹¶ä¸” å½“å‰På­˜å‚¨groutineçš„ if !idlepMaskSnapshot.read(uint32(id)) \u0026\u0026 !runqempty(p2) { lock(\u0026sched.lock) pp := pidleget()\t// ä»ç©ºé—²çš„Pä¸­æ‹¿å»ä¸€ä¸ªPï¼Œä¸ºåç»­Mç»‘å®šPåšå‡†å¤‡ï¼Œå› ä¸ºæœ‰å…¨å±€çš„På­˜åœ¨gå¯ä»¥èµ·å»æ‹¿æ¥ç”¨ unlock(\u0026sched.lock) if pp != nil { return pp } // Can't get a P, don't bother checking remaining Ps. // æ‹¿ä¸åˆ°Pï¼Œåˆ«è´¹å¿ƒæ£€æŸ¥å‰©ä½™çš„P break } } return nil } checkIdleGCNoP() æ£€æŸ¥æ˜¯å¦æœ‰GCéœ€è¦å¸®åŠ©ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 3013 3014 3015 3016 3017 3018 3019 3020 3021 3022 3023 3024 3025 3026 3027 3028 3029 3030 3031 3032 3033 3034 3035 3036 3037 3038 3039 3040 3041 3042 3043 3044 3045 3046 3047 3048 3049 3050 3051 3052 3053 3054 3055 3056 3057 3058 3059 3060 3061 3062 3063 3064 3065 3066 3067 3068 3069 3070 3071 3072 3073 // Check for idle-priority GC, without a P on entry. // // If some GC work, a P, and a worker G are all available, the P and G will be // returned. The returned P has not been wired yet. func checkIdleGCNoP() (*p, *g) { // N.B. Since we have no P, gcBlackenEnabled may change at any time; we // must check again after acquiring a P. As an optimization, we also check // if an idle mark worker is needed at all. This is OK here, because if we // observe that one isn't needed, at least one is currently running. Even if // it stops running, its own journey into the scheduler should schedule it // again, if need be (at which point, this check will pass, if relevant). if atomic.Load(\u0026gcBlackenEnabled) == 0 || !gcController.needIdleMarkWorker() { return nil, nil } if !gcMarkWorkAvailable(nil) { return nil, nil } // Work is available; we can start an idle GC worker only if there is // an available P and available worker G. // // We can attempt to acquire these in either order, though both have // synchronization concerns (see below). Workers are almost always // available (see comment in findRunnableGCWorker for the one case // there may be none). Since we're slightly less likely to find a P, // check for that first. // // Synchronization: note that we must hold sched.lock until we are // committed to keeping it. Otherwise we cannot put the unnecessary P // back in sched.pidle without performing the full set of idle // transition checks. // // If we were to check gcBgMarkWorkerPool first, we must somehow handle // the assumption in gcControllerState.findRunnableGCWorker that an // empty gcBgMarkWorkerPool is only possible if gcMarkDone is running. lock(\u0026sched.lock) pp, now := pidlegetSpinning(0) if pp == nil { unlock(\u0026sched.lock) return nil, nil } // Now that we own a P, gcBlackenEnabled can't change (as it requires STW). if gcBlackenEnabled == 0 || !gcController.addIdleMarkWorker() { pidleput(pp, now) unlock(\u0026sched.lock) return nil, nil } node := (*gcBgMarkWorkerNode)(gcBgMarkWorkerPool.pop()) if node == nil { pidleput(pp, now) unlock(\u0026sched.lock) gcController.removeIdleMarkWorker() return nil, nil } unlock(\u0026sched.lock) return pp, node.gp.ptr() } checkTimersNoP() æ£€æŸ¥å¿«ç…§ä¸­æ‰€æœ‰çš„Pæ˜¯å¦æœ‰timerè¦è§¦å‘äº†ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 2997 2998 2999 3000 3001 3002 3003 3004 3005 3006 3007 3008 3009 3010 3011 // Check all Ps for a timer expiring sooner than pollUntil. // // Returns updated pollUntil value. func checkTimersNoP(allpSnapshot []*p, timerpMaskSnapshot pMask, pollUntil int64) int64 { for id, p2 := range allpSnapshot { if timerpMaskSnapshot.read(uint32(id)) { w := nobarrierWakeTime(p2) if w != 0 \u0026\u0026 (pollUntil == 0 || w \u003c pollUntil) { pollUntil = w } } } return pollUntil } stopm() å·¥ä½œçº¿ç¨‹è¿›å…¥ä¼‘çœ ï¼Œç­‰å¾…è¢«å…¶ä»–å·¥ä½œçº¿ç¨‹å”¤é†’ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 2229 2230 2231 2232 2233 2234 2235 2236 2237 2238 2239 2240 2241 2242 2243 2244 2245 2246 2247 2248 2249 2250 // Stops execution of the current m until new work is available. // Returns with acquired P. func stopm() { _g_ := getg() // è·å–å½“å‰å·¥ä½œçº¿ç¨‹Mç»‘å®šçš„g if _g_.m.locks != 0 { // åˆ¤æ–­å½“å‰å·¥ä½œçº¿ç¨‹æ˜¯å¦æœ‰é”ä¸ºè§£é” throw(\"stopm holding locks\") } if _g_.m.p != 0 { // åˆ¤æ–­å½“å‰å·¥ä½œçº¿ç¨‹æ˜¯å¦è¿˜ç»‘å®šäº†Pï¼Œå› ä¸ºå‰é¢Mä¸På·²ç»è§£ç»‘äº† throw(\"stopm holding p\") } if _g_.m.spinning { // åˆ¤æ–­å½“å‰å·¥ä½œçº¿ç¨‹æ˜¯å¦è¿˜å¤„äºè‡ªæ—‹çŠ¶æ€æ ‡è®°ï¼Œåº”ä¸ºå‰é¢å·²ç»å–æ¶ˆäº†è¯¥æ ‡è®° throw(\"stopm spinning\") } lock(\u0026sched.lock) // é”ä½å…¨å±€sched mput(_g_.m) // æŠŠmç»“æ„ä½“å¯¹è±¡æ”¾å…¥sched.midleç©ºé—²é˜Ÿåˆ— unlock(\u0026sched.lock) // è§£é” mPark() // è¿›å…¥ç³»ç»Ÿè°ƒç”¨è¿›å…¥ç¡çœ  acquirep(_g_.m.nextp.ptr()) // å·¥ä½œçº¿ç¨‹è¢«å”¤é†’åä»è¿™é‡Œå¼€å§‹æ‰§è¡Œï¼Œç»™Mç»‘å®šP _g_.m.nextp = 0 } mput() å½“å·¥ä½œçº¿ç¨‹ç©ºé—²æ—¶å³å°†è¿›å…¥ä¼‘çœ çŠ¶æ€æ—¶ä¼šåˆ¤æ–­ä¸€æ¬¡checkdead()ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5533 5534 5535 5536 5537 5538 5539 5540 5541 5542 5543 5544 5545 5546 5547 // Put mp on midle list. // sched.lock must be held. // May run during STW, so write barriers are not allowed. //go:nowritebarrierrec func mput(mp *m) { assertLockHeld(\u0026sched.lock) // æ£€æŸ¥sched.locké” mp.schedlink = sched.midle // å½“å‰Mè®°å½•å…¨å±€ç©ºé—²Mé“¾è¡¨ sched.midle.set(mp) // æŠŠå½“å‰Mè¿½åŠ åˆ°å…¨å±€ç©ºé—²é“¾è¡¨ä¸­å» sched.nmidle++ // å…¨å±€ç©ºé—²Mæ•°é‡åŠ ä¸€ // æ£€æŸ¥æ­»é”æƒ…å†µ // æ£€æŸ¥åŸºäºè¿è¡Œ M çš„æ•°é‡ï¼Œå¦‚æœ 0 -\u003e æ­»é” // sched.lock å¿…é¡»è¢«æŒæœ‰ checkdead() } mget() æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5547 5548 5549 5550 5551 5552 5553 5554 5555 5556 5557 5558 5559 5560 // Try to get an m from midle list. // sched.lock must be held. // May run during STW, so write barriers are not allowed. //go:nowritebarrierrec func mget() *m { assertLockHeld(\u0026sched.lock) mp := sched.midle.ptr() if mp != nil { sched.midle = mp.schedlink sched.nmidle-- } return mp } mPark() ç¡çœ å‡½æ•°ï¼ŒmPark()å¯¼è‡´çº¿ç¨‹è‡ªè¡Œåœæ”¾ï¼Œä¸€æ—¦å”¤é†’å°±è¿”å›ã€‚ stopmçš„æ ¸å¿ƒæ˜¯è°ƒç”¨mputæŠŠmç»“æ„ä½“å¯¹è±¡æ”¾å…¥schedçš„midleç©ºé—²é˜Ÿåˆ—ï¼Œç„¶åé€šè¿‡notesleep(\u0026m.park)å‡½æ•°è®©è‡ªå·±è¿›å…¥ç¡çœ çŠ¶æ€ã€‚ noteæ˜¯go runtimeå®ç°çš„ä¸€æ¬¡æ€§ç¡çœ å’Œå”¤é†’æœºåˆ¶ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥é€šè¿‡è°ƒç”¨notesleep(*note)è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œè€Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹åˆ™å¯ä»¥é€šè¿‡notewakeup(*note)æŠŠå…¶å”¤é†’ã€‚ noteçš„åº•å±‚å®ç°æœºåˆ¶è·Ÿæ“ä½œç³»ç»Ÿç›¸å…³ï¼Œä¸åŒç³»ç»Ÿä½¿ç”¨ä¸åŒçš„æœºåˆ¶ï¼š æ¯”å¦‚linuxä¸‹ä½¿ç”¨çš„futexç³»ç»Ÿè°ƒç”¨ã€‚ è€Œmacä¸‹åˆ™æ˜¯ä½¿ç”¨çš„pthread_cond_tæ¡ä»¶å˜é‡ã€‚ noteå¯¹è¿™äº›åº•å±‚æœºåˆ¶åšäº†ä¸€ä¸ªæŠ½è±¡å’Œå°è£…ï¼Œè¿™ç§å°è£…ç»™æ‰©å±•æ€§å¸¦æ¥äº†å¾ˆå¤§çš„å¥½å¤„ï¼Œæ¯”å¦‚å½“ç¡çœ å’Œå”¤é†’åŠŸèƒ½éœ€è¦æ”¯æŒæ–°å¹³å°æ—¶ï¼Œåªéœ€è¦åœ¨noteå±‚å¢åŠ å¯¹ç‰¹å®šå¹³å°çš„æ”¯æŒå³å¯ï¼Œä¸éœ€è¦ä¿®æ”¹ä¸Šå±‚çš„ä»»ä½•ä»£ç ã€‚ å›åˆ°stopmï¼Œå½“ä»notesleepå‡½æ•°è¿”å›åï¼Œéœ€è¦å†æ¬¡ç»‘å®šä¸€ä¸ªpï¼Œç„¶åè¿”å›åˆ°findrunnableå‡½æ•°ç»§ç»­é‡æ–°å¯»æ‰¾å¯è¿è¡Œçš„goroutineï¼Œä¸€æ—¦æ‰¾åˆ°å¯è¿è¡Œçš„goroutineå°±ä¼šè¿”å›åˆ°scheduleå‡½æ•°ï¼Œå¹¶æŠŠæ‰¾åˆ°çš„goroutineè°ƒåº¦èµ·æ¥è¿è¡Œï¼Œå¦‚ä½•æŠŠgoroutineè°ƒåº¦èµ·æ¥è¿è¡Œçš„ä»£ç æˆ‘ä»¬å·²ç»åˆ†æè¿‡äº†ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 1452 1453 1454 1455 1456 1457 1458 // mPark causes a thread to park itself, returning once woken. //go:nosplit func mPark() { gp := getg() notesleep(\u0026gp.m.park) // è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œè¿™é‡Œä¼ å…¥Mçš„parkï¼Œç¡çœ åœ¨è¿™ä¸ªä¸Šé¢ noteclear(\u0026gp.m.park) // è¢«å…¶ä»–å·¥ä½œçº¿ç¨‹å”¤é†’ï¼Œä»£ç ä»è¿™é‡Œå¼€å§‹æ‰§è¡Œ } notesleep() å®ç°ä¼‘çœ çš„å‡½æ•°ã€‚ notesleepå‡½æ•°è°ƒç”¨futexsleepè¿›å…¥ç¡çœ ï¼Œè¿™é‡Œä¹‹æ‰€ä»¥éœ€è¦ç”¨ä¸€ä¸ªå¾ªç¯ï¼Œæ˜¯å› ä¸ºfutexsleepæœ‰å¯èƒ½æ„å¤–ä»ç¡çœ ä¸­è¿”å›ï¼Œæ‰€ä»¥ä»futexsleepå‡½æ•°è¿”å›åè¿˜éœ€è¦æ£€æŸ¥note.keyæ˜¯å¦è¿˜æ˜¯0ã€‚ å¦‚æœæ˜¯0åˆ™è¡¨ç¤ºå¹¶ä¸æ˜¯å…¶å®ƒå·¥ä½œçº¿ç¨‹å”¤é†’äº†æˆ‘ä»¬ï¼Œåªæ˜¯futexsleepæ„å¤–è¿”å›äº†ï¼Œéœ€è¦å†æ¬¡è°ƒç”¨futexsleepè¿›å…¥ç¡çœ ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/lock_futex.goã€‚ 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 func notesleep(n *note) { gp := getg() // è·å–å½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„gï¼Œåº”è¯¥æ˜¯g0åœ¨è°ƒåº¦å¾ªç¯è¿‡ç¨‹ä¸­è¢«åˆ‡æ¢åˆ°g0äº† if gp != gp.m.g0 { throw(\"notesleep not on g0\") } ns := int64(-1) // è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º-1ï¼Œè¡¨ç¤ºæ— é™æœŸç­‰å¾… if *cgo_yield != nil { // Sleep for an arbitrary-but-moderate interval to poll libc interceptors. // ä¼‘çœ ä¸€ä¸ªä»»æ„ä½†é€‚ä¸­çš„é—´éš”æ¥è½®è¯¢ libc æ‹¦æˆªå™¨cgoç›¸å…³çš„ ns = 10e6 } // ä½¿ç”¨å¾ªç¯ï¼Œä¿è¯ä¸æ˜¯æ„å¤–è¢«å”¤é†’ for atomic.Load(key32(\u0026n.key)) == 0 { gp.m.blocked = true // blockedè¡¨ç¤ºMåœ¨å½“å‰çš„noteä¸Šè¢«å±è”½ futexsleep(key32(\u0026n.key), 0, ns) // è¿›å…¥ä¼‘çœ å‡½æ•° if *cgo_yield != nil { asmcgocall(*cgo_yield, nil) } gp.m.blocked = false } } futexsleep() åŸå­çš„if(*addr == val)ä¼‘çœ ï¼Œå¯èƒ½ä¼šè¢«è™šå‡å”¤é†’ï¼› è¿™æ˜¯å…è®¸çš„ç¡çœ æ—¶é—´ä¸è¦è¶…è¿‡nsï¼›ns \u003c 0æ„å‘³ç€æ°¸è¿œã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/os_linux.goã€‚ 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 // Atomically, //\tif(*addr == val) sleep // Might be woken up spuriously; that's allowed. // Don't sleep longer than ns; ns \u003c 0 means forever. // //go:nosplit func futexsleep(addr *uint32, val uint32, ns int64) { // Some Linux kernels have a bug where futex of // FUTEX_WAIT returns an internal error code // as an errno. Libpthread ignores the return value // here, and so can we: as it says a few lines up, // spurious wakeups are allowed. // // ä¸€äº› Linux å†…æ ¸å­˜åœ¨ä¸€ä¸ªé”™è¯¯ï¼Œå³ FUTEX_WAIT çš„ futex è¿”å›å†…éƒ¨é”™è¯¯ä»£ç ä½œä¸º errno // Libpthread å¿½ç•¥äº†è¿™é‡Œçš„è¿”å›å€¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ï¼šæ­£å¦‚å®ƒæ‰€è¯´çš„å‡ è¡Œï¼Œè™šå‡å”¤é†’æ˜¯å…è®¸çš„ if ns \u003c 0 {\t// æ°¸ä¹…ç¡çœ  futex(unsafe.Pointer(addr), _FUTEX_WAIT_PRIVATE, val, nil, nil, 0) return } var ts timespec ts.setNsec(ns) // è®¾ç½®æ—¶é—´ futex(unsafe.Pointer(addr), _FUTEX_WAIT_PRIVATE, val, unsafe.Pointer(\u0026ts), nil, 0) } futex() å‡½æ•°åŸå‹ï¼šfunc futex(addr unsafe.Pointer, op int32, val uint32, ts, addr2 unsafe.Pointer, val3 uint32) int32ç”±æ±‡ç¼–å®ç°ã€‚ futexç³»ç»Ÿè°ƒç”¨ä¸ºæˆ‘ä»¬æä¾›çš„åŠŸèƒ½ä¸ºå¦‚æœ*addr == valåˆ™è¿›å…¥ç¡çœ ï¼Œå¦åˆ™ç›´æ¥è¿”å›ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/sys_linux_amd64.sã€‚ 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 # int64 futex(int32 *uaddr, int32 op, int32 val, #\tstruct timespec *timeout, int32 *uaddr2, int32 val2); TEXT runtimeÂ·futex(SB),NOSPLIT,$0 # ä¸‹é¢çš„6æ¡æŒ‡ä»¤åœ¨ä¸ºfutexç³»ç»Ÿè°ƒç”¨å‡†å¤‡å‚æ•° MOVQ addr+0(FP), DI MOVL op+8(FP), SI MOVL val+12(FP), DX MOVQ ts+16(FP), R10 MOVQ addr2+24(FP), R8 MOVL val3+32(FP), R9 MOVL $SYS_futex, AX # ç³»ç»Ÿè°ƒç”¨ç¼–å·æ”¾å…¥AXå¯„å­˜å™¨ SYSCALL # æ‰§è¡Œfutexç³»ç»Ÿè°ƒç”¨è¿›å…¥ç¡çœ ï¼Œä»ç¡çœ ä¸­è¢«å”¤é†’åæ¥ç€æ‰§è¡Œä¸‹ä¸€æ¡MOVLæŒ‡ä»¤ MOVL AX, ret+40(FP) # ä¿å­˜ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ RET execute() ğŸš€ gpæ”¾åˆ°å½“å‰Mä¸Šå–è¿è¡Œã€‚è¯¥å‡½æ•°ä»g0æ ˆåˆ‡æ¢åˆ°æ™®é€šgoroutineæ ˆä¸Šã€‚ å¦‚æœinheritTimeä¸ºtrueï¼Œåˆ™gpå°†ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡ä¸­çš„å‰©ä½™æ—¶é—´ã€‚å¦åˆ™ï¼Œå®ƒå°†å¯åŠ¨ä¸€ä¸ªæ–°çš„æ—¶é—´ç‰‡ã€‚æ°¸è¿œä¸è¿”å›ã€‚ å†™å±éšœæ˜¯å…è®¸çš„ï¼Œå› ä¸ºè¿™æ˜¯åœ¨å‡ ä¸ªåœ°æ–¹è·å¾—Påç«‹å³è°ƒç”¨çš„ã€‚ å‚æ•°ï¼š gp *gï¼šå½“å‰è°ƒåº¦çš„goroutineã€‚ inheritTime boolï¼štrue.ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡ï¼Œfalse.ä¸ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 2508 2509 2510 2511 2512 2513 2514 2515 2516 2517 2518 2519 2520 2521 2522 2523 2524 2525 2526 2527 2528 2529 2530 2531 2532 2533 2534 2535 2536 2537 2538 2539 2540 2541 2542 2543 2544 2545 2546 2547 2548 2549 2550 2551 2552 2553 2554 2555 2556 2557 2558 2559 2560 2561 2562 2563 2564 2565 2566 2567 2568 // Schedules gp to run on the current M. // If inheritTime is true, gp inherits the remaining time in the // current time slice. Otherwise, it starts a new time slice. // Never returns. // // Write barriers are allowed because this is called immediately after // acquiring a P in several places. // //go:yeswritebarrierrec func execute(gp *g, inheritTime bool) { // å½“å‰æ˜¯åœ¨ç³»ç»Ÿg0æ ˆ _g_ := getg() // _g_ = g0 if goroutineProfile.active { // Make sure that gp has had its stack written out to the goroutine // profile, exactly as it was when the goroutine profiler first stopped // the world. tryRecordGoroutineProfile(gp, osyield) } // Assign gp.m before entering _Grunning so running Gs have an // M. // // åœ¨è¾“å…¥_Grunningä¹‹å‰æŒ‡å®šgp.mï¼Œä»¥ä¾¿è¿è¡ŒGså…·æœ‰mã€‚ _g_.m.curg = gp // m.curg = gp gp.m = _g_.m // gp.m = m // _Grunnableï¼šå®ƒå½“å‰æ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç ã€‚ // _Grunningï¼šè¡¨ç¤ºè¿™ä¸ªgoroutineå¯ä»¥æ‰§è¡Œç”¨æˆ·ä»£ç ã€‚ casgstatus(gp, _Grunnable, _Grunning) // ä¿®æ”¹å½“å‰gçš„çŠ¶æ€ä¸ºè¿è¡Œä¸­ gp.waitsince = 0 // è®¾ç½®gè¢«é˜»å¡çš„å¤§çº¦æ—¶é—´ // æŠ¢å ä¿¡å·ï¼Œé‡å¤stackguard0 = stackpreempt gp.preempt = false // const _StackGuard = 928; // è®¾ç½®å½“å‰gæ ˆæ‰©å®¹é˜ˆå€¼ç‚¹ã€‚ gp.stackguard0 = gp.stack.lo + _StackGuard // æ˜¯å¦ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡ã€‚å…·ä½“çš„æŠ¢å åœ¨sysmonç›‘æ§çº¿ç¨‹ä¸­ã€‚ if !inheritTime { // ä¸ç»§æ‰¿ä¸Šä¸€ä¸ªæ—¶é—´ç‰‡æ—¶ï¼Œè°ƒåº¦æ¬¡æ•°ä¼šåŠ ä¸€ _g_.m.p.ptr().schedtick++ // è°ƒåº¦æ¬¡æ•°åŠ ä¸€ } // Check whether the profiler needs to be turned on or off. // // æ£€æŸ¥åˆ†æå™¨æ˜¯å¦éœ€è¦æ‰“å¼€æˆ–å…³é—­ hz := sched.profilehz // sched.profilehzï¼šç”¨æ¥è®¾ç½®æ€§èƒ½åˆ†æçš„é‡‡æ ·é¢‘ç‡ã€‚ if _g_.m.profilehz != hz { setThreadCPUProfiler(hz) } if trace.enabled { // GoSysExit has to happen when we have a P, but before GoStart. // So we emit it here. if gp.syscallsp != 0 \u0026\u0026 gp.sysblocktraced { traceGoSysExit(gp.sysexitticks) } traceGoStart() } // gogoå®Œæˆä»g0åˆ°gpçœŸæ­£çš„åˆ‡æ¢ gogo(\u0026gp.sched) } gogo() gogo()å‡½æ•°å®Œæˆä»g0åˆ°gpçš„çš„åˆ‡æ¢ï¼šCPUæ‰§è¡Œæƒçš„è½¬è®©ä»¥åŠæ ˆçš„åˆ‡æ¢ã€‚ å‡½æ•°åŸå‹ï¼šfunc gogo(buf *gobuf)ã€‚ å‚æ•°buf *gobufï¼šéœ€è¦åˆ‡æ¢çš„goroutineçš„è°ƒåº¦ä¿¡æ¯ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 # func gogo(buf *gobuf) # restore state from Gobuf; longjmp TEXT runtimeÂ·gogo(SB), NOSPLIT, $0-8 # 1) å–å‡ºgobufä¿¡æ¯ï¼Œé‡Œé¢åŒ…å«éœ€è¦è°ƒåº¦çš„ä¿¡æ¯ # å–å‡ºéœ€è¦è°ƒåº¦çš„goroutineï¼Œgp.sched.gï¼Œåˆ¤æ–­è¿™ä¸ªgoroutineä¸ä¸ºnil # executeå‡½æ•°åœ¨è°ƒç”¨gogoæ—¶æŠŠgpçš„schedæˆå‘˜çš„åœ°å€ä½œä¸ºå®å‚ï¼ˆå‹å‚bufï¼‰ä¼ é€’äº†è¿‡æ¥ # è¯¥å‚æ•°ä½äºFPå¯„å­˜å™¨æ‰€æŒ‡çš„ä½ç½®ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯è·å–å‚æ•° # buf = \u0026gp.sched; BX = *gobuf MOVQ buf+0(FP), BX # *gobuf # æŠŠbufçš„å€¼ä¹Ÿå°±æ˜¯gp.schedçš„åœ°å€æ”¾åœ¨äº†BXå¯„å­˜å™¨ä¹‹ä¸­ # è¿™æ ·ä¾¿äºåé¢çš„æŒ‡ä»¤ä¾é BXå¯„å­˜å™¨æ¥å­˜å–gp.schedçš„æˆå‘˜ # æ³¨æ„è¿™é‡Œæ˜¯é—´æ¥å¯»å€æ–¹å¼ # gobuf-\u003eg --\u003e dx register MOVQ gobuf_g(BX), DX\t# DX = gp.sched.g; *g # ä¸‹é¢è¿™è¡Œä»£ç æ²¡æœ‰å®è´¨ä½œç”¨ï¼Œæ£€æŸ¥gp.sched.gæ˜¯å¦æ˜¯nilï¼Œå¦‚æœæ˜¯nilè¿›ç¨‹ä¼šcrashæ­»æ‰ # å¦‚æœDXä¸ºç©ºä½¿ç”¨0(DX)å½¢å¼ç®€ä»‹å¯»å€ä¼šæŠ¥é”™ã€‚ç¡®ä¿ g ä¸æ˜¯ nilã€‚ MOVQ 0(DX), CX # make sure g != nil # 2) ä½¿ç”¨JMPæŒ‡ä»¤è·³è½¬åˆ°gogoå‡½æ•° JMP gogo\u003c\u003e(SB) # æ³¨æ„è¿™é‡Œä½¿ç”¨çš„æ˜¯JMP 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 TEXT gogo\u003c\u003e(SB), NOSPLIT, $0 # 3) æŠŠgpæ”¾å…¥TLSä¸­å’ŒR14å¯„å­˜å™¨ä¸­ # è·å–å½“å‰å·¥ä½œçº¿ç¨‹Mçš„fsæ®µåŸºå€ï¼Œå‰é¢æŠŠfsæ®µåŸºå€è®¾ç½®æˆäº†\u0026m.tls[1]çš„åœ°å€ get_tls(CX) # CX = \u0026m.tls[1] = TLS # æŠŠDXå€¼ä¹Ÿå°±æ˜¯éœ€è¦è¿è¡Œçš„goroutineçš„æŒ‡é’ˆå†™å…¥çº¿ç¨‹æœ¬åœ°å­˜å‚¨ä¹‹ä¸­ # è¿è¡Œè¿™æ¡æŒ‡ä»¤ä¹‹å‰ï¼Œçº¿ç¨‹æœ¬åœ°å­˜å‚¨å­˜æ”¾çš„æ˜¯g0çš„åœ°å€ MOVQ DX, g(CX) # TLS = gp.sched.g # åœ¨g1.17å’Œ1.18ç‰ˆæœ¬ä¸­ R14å¯„å­˜å™¨è¢«ç”¨æ¥æŒ‡å‘å½“å‰goroutineçš„runtime.gç»“æ„ # R14 = gp.sched.g MOVQ DX, R14 # set the g register # 4) è®¾ç½®æ ˆé¡¶SPå¯„å­˜å™¨ï¼Œåˆ‡gpçš„æ ˆï¼Œåˆ‡æ¢æ ˆ # æŠŠCPUçš„SPå¯„å­˜å™¨è®¾ç½®ä¸ºsched.spï¼Œå®Œæˆäº†æ ˆçš„åˆ‡æ¢ï¼Œgp.sched.spè®°å½•ç€gçš„æ ˆé¡¶ä½ç½® # è®¾ç½®CPUçš„æ ˆé¡¶å¯„å­˜å™¨SPä¸ºgp.sched.spï¼Œè¿™æ¡æŒ‡ä»¤å®Œæˆäº†æ ˆçš„åˆ‡æ¢ï¼Œä»g0çš„æ ˆåˆ‡æ¢åˆ°äº†gpçš„æ ˆ # rsp = gp.sched.sp MOVQ gobuf_sp(BX), SP # restore SP # 5) è®¾ç½® AX = gp.sched.ret # è®¾ç½® DX = gp.sched.ctxt é—­åŒ…ä¸Šä¸‹æ–‡ # è®¾ç½® BP = BP = gp.sched.bp æ ˆåº•å¯„å­˜å™¨ # ä¸‹é¢ä¸‰æ¡åŒæ ·æ˜¯æ¢å¤è°ƒåº¦ä¸Šä¸‹æ–‡åˆ°CPUç›¸å…³å¯„å­˜å™¨ # éœ€è¦è¿”å›çš„åœ°å€ MOVQ gobuf_ret(BX), AX # AX = gp.sched.ret\t# ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä¹Ÿå°±æ˜¯å½“å‰æ³¨å†Œå‡½æ•°çš„é—­åŒ…æ•è·å±‚ï¼Œfuncvalåœ°å€å¤„ MOVQ gobuf_ctxt(BX), DX # DX = gp.sched.ctxt\t# è®¾ç½®æ ˆåŸºåœ°å€ MOVQ gobuf_bp(BX), BP # BP = gp.sched.bp\t# 6) æ¸…ç©ºgpçš„gobuf.spã€gobuf.retã€gobuf.ctxtã€gobuf.bp # æ¸…ç©ºgp.schedä¸­ä¸å†éœ€è¦çš„å€¼ï¼Œå› ä¸ºæˆ‘ä»¬å·²æŠŠç›¸å…³å€¼æ”¾å…¥CPUå¯¹åº”çš„å¯„å­˜å™¨äº† # clear to help garbage collector MOVQ $0, gobuf_sp(BX) # g.gobuf.sp = 0 MOVQ $0, gobuf_ret(BX) # g.gobuf.ret = 0 MOVQ $0, gobuf_ctxt(BX) # g.gobuf.ctxt = 0 MOVQ $0, gobuf_bp(BX) # g.gobuf.bp = 0 # 7) è·³è½¬åˆ°g.gobuf.pcæ‰§è¡Œgpçš„ç›¸å…³ä»£ç  # æ³¨æ„ï¼šä»g0åˆ‡æ¢çš„gpè¿‡ç¨‹ä¸­ï¼Œå¹¶æ²¡æœ‰ä¿å­˜g0çš„ç›¸å…³æ ˆä¿¡æ¯ # gp.sched.pc è®°å½•ç€æ³¨å†Œå‡½æ•°å¼€å§‹çš„ä»£ç åœ°å€ # æŠŠgp.sched.pcçš„å€¼è¯»å–åˆ°BXå¯„å­˜å™¨ï¼Œè¿™ä¸ªpcå€¼æ˜¯gpè¿™ä¸ªgoroutineé©¬ä¸Šéœ€è¦æ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ # å¯¹äºruntime.mainè¿™ä¸ªåœºæ™¯æ¥è¯´å®ƒç°åœ¨å°±æ˜¯runtime.mainå‡½æ•°çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Œç°åœ¨è¿™æ¡æŒ‡ä»¤çš„åœ°å€å°±æ”¾åœ¨BXå¯„å­˜å™¨é‡Œé¢ # DXå¯„å­˜å™¨ä½œä¸ºä¸Šä¸‹æ–‡ï¼Œè®°å½•ç€é—­åŒ…å‡½æ•°çš„ç›¸å…³æ•è·å˜é‡ MOVQ gobuf_pc(BX), BX # BX = g.gobuf.pc # è¿™é‡Œçš„JMP BXæŒ‡ä»¤æŠŠBXå¯„å­˜å™¨é‡Œé¢çš„æŒ‡ä»¤åœ°å€æ”¾å…¥CPUçš„ripå¯„å­˜å™¨ # äºæ˜¯ï¼ŒCPUå°±ä¼šè·³è½¬åˆ°è¯¥åœ°å€ç»§ç»­æ‰§è¡Œå±äºgpè¿™ä¸ªgoroutineçš„ä»£ç ï¼Œè¿™æ ·å°±å®Œæˆäº†goroutineçš„åˆ‡æ¢ # è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼šDXå¯„å­˜å™¨çš„å€¼ gp.sched.ctxt å­˜å‚¨çš„æ˜¯é—­åŒ…çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¦‚æœé—­åŒ…æ•è·äº†å˜é‡åˆ™ä¼šä½¿ç”¨å®ƒã€‚ JMP BX # è·³è½¬åˆ°æ³¨å†Œçš„goroutineå»æ‰§è¡Œäº† æ€»ç»“ï¼š execute()å‡½æ•°å®Œæˆä»ç³»ç»Ÿæ ˆg0åˆ‡æ¢åˆ°æ™®é€šgoroutineçš„è¿‡ç¨‹ï¼ˆè¿™é‡Œæ˜¯å‚æ•°gpï¼‰ã€‚ è¯¥å‡½æ•°å°†å·¥ä½œçº¿ç¨‹mä¸gpç›¸äº’ç»‘å®šï¼Œç„¶ååˆ‡æ¢gpçš„çŠ¶æ€å¹¶è®¾ç½®æ ˆæº¢å‡ºç›¸å…³å‚æ•°ï¼Œä»¥åŠè®¾ç½®è°ƒåº¦æ¬¡æ•°ï¼Œ æ¥ç€è°ƒç”¨gogo()å‡½æ•°æŠŠæ ˆä»g0åˆ‡æ¢æˆgpçš„æ ˆï¼Œå¹¶æŠŠgpçš„è°ƒåº¦ä¿¡æ¯ä¿å­˜åœ¨ç›¸å…³å¯„å­˜å™¨ä¸­ï¼Œç„¶ååˆ‡æ¢åˆ°gpå¼€å§‹æ‰§è¡Œç›¸å…³ä»£ç ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»g0åˆ‡æ¢åˆ°gpè¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰ä¿å­˜g0çš„ç›¸å…³æ ˆé¡¶SPç›¸å…³ä¿¡æ¯ï¼Œå› æ­¤g0æ ˆæ€»æ˜¯ä»ä¸€ä¸ªå›ºå®šçš„å¼€å§‹çš„ä½ç½®å¼€å§‹çš„ã€‚ å…¶ä»–ç›¸å…³å‡½æ•° checkTimers() è¯¥å‡½æ•°æ˜¯å”¤é†’time.Sleepã€time.Timerç­‰çš„ç›¸å…³å‡½æ•°ï¼ŒæŸ¥çœ‹runtime.timeræ–‡æ¡£ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 3269 3270 3271 3272 3273 3274 3275 3276 3277 3278 3279 3280 3281 3282 3283 3284 3285 3286 3287 3288 3289 3290 3291 3292 3293 3294 3295 3296 3297 3298 3299 3300 3301 3302 3303 3304 3305 3306 3307 3308 3309 3310 3311 3312 3313 3314 3315 3316 3317 3318 3319 3320 3321 3322 3323 3324 3325 3326 3327 3328 3329 3330 3331 3332 3333 3334 3335 3336 3337 3338 3339 3340 3341 3342 3343 3344 // checkTimers runs any timers for the P that are ready. // If now is not 0 it is the current time. // It returns the passed time or the current time if now was passed as 0. // and the time when the next timer should run or 0 if there is no next timer, // and reports whether it ran any timers. // If the time when the next timer should run is not 0, // it is always larger than the returned time. // We pass now in and out to avoid extra calls of nanotime. // //go:yeswritebarrierrec func checkTimers(pp *p, now int64) (rnow, pollUntil int64, ran bool) { // If it's not yet time for the first timer, or the first adjusted // timer, then there is nothing to do. next := int64(atomic.Load64(\u0026pp.timer0When)) nextAdj := int64(atomic.Load64(\u0026pp.timerModifiedEarliest)) if next == 0 || (nextAdj != 0 \u0026\u0026 nextAdj \u003c next) { next = nextAdj } if next == 0 { // No timers to run or adjust. // æ— éœ€è¿è¡Œæˆ–è°ƒæ•´è®¡æ—¶å™¨ return now, 0, false } if now == 0 { now = nanotime() } if now \u003c next { // Next timer is not ready to run, but keep going // if we would clear deleted timers. // This corresponds to the condition below where // we decide whether to call clearDeletedTimers. if pp != getg().m.p.ptr() || int(atomic.Load(\u0026pp.deletedTimers)) \u003c= int(atomic.Load(\u0026pp.numTimers)/4) { return now, next, false } } lock(\u0026pp.timersLock) // å¦‚æœå½“å‰Pçš„timerså­˜åœ¨æ•°æ® if len(pp.timers) \u003e 0 {\t// pp.timersè®°å½•ç€å½“å‰Pä¸­æ‰€æœ‰ç›¸å…³çš„timer // adjusttimers åœ¨å½“å‰ P çš„å †ä¸­æŸ¥æ‰¾ä»»ä½•å·²ä¿®æ”¹ä¸ºæ›´æ—©è¿è¡Œçš„å®šæ—¶å™¨ï¼Œå¹¶å°†å®ƒä»¬æ”¾åœ¨å †ä¸­çš„æ­£ç¡®ä½ç½® // åœ¨æŸ¥æ‰¾è¿™äº›è®¡æ—¶å™¨æ—¶ï¼Œå®ƒè¿˜ä¼šç§»åŠ¨å·²ä¿®æ”¹ä¸ºç¨åè¿è¡Œçš„è®¡æ—¶å™¨ï¼Œå¹¶åˆ é™¤å·²åˆ é™¤çš„è®¡æ—¶å™¨ // è°ƒç”¨è€…å¿…é¡»é”å®š pp çš„è®¡æ—¶å™¨ adjusttimers(pp, now) for len(pp.timers) \u003e 0 { // Note that runtimer may temporarily unlock // pp.timersLock. // è¯·æ³¨æ„ï¼Œruntimer å¯èƒ½ä¼šæš‚æ—¶è§£é” pp.timersLock // runtimerå‡½æ•° // runtimer æ£€æŸ¥timersä¸­çš„ç¬¬ä¸€ä¸ªtimerã€‚ å¦‚æœå®ƒåŸºäºnowå‡†å¤‡å¥½ï¼Œå®ƒä¼šè¿è¡Œtimerå¹¶åˆ é™¤æˆ–æ›´æ–°å®ƒ // å¦‚æœå®ƒè¿è¡Œäº†ä¸€ä¸ªtimerï¼Œåˆ™è¿”å› 0ï¼Œå¦‚æœæ²¡æœ‰æ›´å¤šçš„timerï¼Œåˆ™è¿”å› -1ï¼Œæˆ–è€…ç¬¬ä¸€ä¸ªtimeråº”è¯¥è¿è¡Œçš„æ—¶é—´ if tw := runtimer(pp, now); tw != 0 { if tw \u003e 0 { pollUntil = tw } break } ran = true } } // If this is the local P, and there are a lot of deleted timers, // clear them out. We only do this for the local P to reduce // lock contention on timersLock. // å¦‚æœå½“å‰Pæ˜¯å½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„Pï¼Œå¹¶ä¸”æœ‰å¾ˆå¤šè¢«åˆ é™¤çš„timerï¼Œæ¸…é™¤å®ƒä»¬ // æˆ‘ä»¬åªå¯¹æœ¬åœ° P è¿™æ ·åšï¼Œä»¥å‡å°‘ timersLock ä¸Šçš„é”äº‰ç”¨ if pp == getg().m.p.ptr() \u0026\u0026 int(atomic.Load(\u0026pp.deletedTimers)) \u003e len(pp.timers)/4 { clearDeletedTimers(pp) } unlock(\u0026pp.timersLock) return now, pollUntil, ran } checkdead() æ£€æŸ¥æ­»é”æƒ…å†µã€‚æ£€æŸ¥åŸºäºæ­£åœ¨è¿è¡Œçš„Mçš„æ•°é‡ï¼Œå¦‚æœ0 -\u003e deadlockã€‚ sched.lockå¿…é¡»è¢«æŒæœ‰ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5017 5018 5019 5020 5021 5022 5023 5024 5025 5026 5027 5028 5029 5030 5031 5032 5033 5034 5035 5036 5037 5038 5039 5040 5041 5042 5043 5044 5045 5046 5047 5048 5049 5050 5051 5052 5053 5054 5055 5056 5057 5058 5059 5060 5061 5062 5063 5064 5065 5066 5067 5068 5069 5070 5071 5072 5073 5074 5075 5076 5077 5078 5079 5080 5081 5082 5083 5084 5085 5086 5087 5088 5089 5090 5091 5092 5093 5094 5095 5096 5097 5098 5099 5100 5101 5102 5103 5104 5105 5106 5107 5108 5109 5110 5111 5112 5113 5114 5115 5116 5117 5118 5119 5120 5121 5122 5123 5124 5125 5126 // Check for deadlock situation. // The check is based on number of running M's, if 0 -\u003e deadlock. // sched.lock must be held. func checkdead() { // sched.lock å¿…é¡»è¢«æŒæœ‰ assertLockHeld(\u0026sched.lock) // For -buildmode=c-shared or -buildmode=c-archive it's OK if // there are no running goroutines. The calling program is // assumed to be running. if islibrary || isarchive { return } // If we are dying because of a signal caught on an already idle thread, // freezetheworld will cause all running threads to block. // And runtime will essentially enter into deadlock state, // except that there is a thread that will call exit soon. if panicking.Load() \u003e 0 { return } // If we are not running under cgo, but we have an extra M then account // for it. (It is possible to have an extra M on Windows without cgo to // accommodate callbacks created by syscall.NewCallback. See issue #6751 // for details.) var run0 int32 if !iscgo \u0026\u0026 cgoHasExtraM { mp := lockextra(true) haveExtraM := extraMCount \u003e 0 unlockextra(mp) if haveExtraM { run0 = 1 } } //func mcount() int32 { // return int32(sched.mnext - sched.nmfreed) //} run := mcount() - sched.nmidle - sched.nmidlelocked - sched.nmsys if run \u003e run0 { return } if run \u003c 0 { print(\"runtime: checkdead: nmidle=\", sched.nmidle, \" nmidlelocked=\", sched.nmidlelocked, \" mcount=\", mcount(), \" nmsys=\", sched.nmsys, \"\\n\") throw(\"checkdead: inconsistent counts\") } grunning := 0 forEachG(func(gp *g) { if isSystemGoroutine(gp, false) { return } s := readgstatus(gp) switch s \u0026^ _Gscan { case _Gwaiting, _Gpreempted: grunning++ case _Grunnable, _Grunning, _Gsyscall: print(\"runtime: checkdead: find g \", gp.goid, \" in status \", s, \"\\n\") throw(\"checkdead: runnable g\") } }) if grunning == 0 { // possible if main goroutine calls runtimeÂ·Goexit() unlock(\u0026sched.lock) // unlock so that GODEBUG=scheddetail=1 doesn't hang fatal(\"no goroutines (main called runtime.Goexit) - deadlock!\") } // Maybe jump time forward for playground. if faketime != 0 { if when := timeSleepUntil(); when \u003c maxWhen { faketime = when // Start an M to steal the timer. pp, _ := pidleget(faketime) if pp == nil { // There should always be a free P since // nothing is running. throw(\"checkdead: no p for timer\") } mp := mget() if mp == nil { // There should always be a free M since // nothing is running. throw(\"checkdead: no m for timer\") } // M must be spinning to steal. We set this to be // explicit, but since this is the only M it would // become spinning on its own anyways. sched.nmspinning.Add(1) mp.spinning = true mp.nextp.set(pp) notewakeup(\u0026mp.park) return } } // There are no goroutines running, so we can look at the P's. for _, pp := range allp { // å½“æŸä¸ªPä¸­å­˜åœ¨timerï¼Œå³ä½¿å…¨éƒ¨Péƒ½ç¡çœ äº†ä¹Ÿä¸ä¼šæŠ¥é”™ if len(pp.timers) \u003e 0 { return } } unlock(\u0026sched.lock) // unlock so that GODEBUG=scheddetail=1 doesn't hang fatal(\"all goroutines are asleep - deadlock!\") } ",
  "wordCount" : "10915",
  "inLanguage": "zh",
  "image": "https://heliu.site/favicon-32x32.png","datePublished": "2024-07-30T00:00:00Z",
  "dateModified": "2024-07-30T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://heliu.site/posts/golang/goroutine/mstart/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://heliu.site/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://heliu.site/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://heliu.site/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://heliu.site/" title="ä¸»é¡µ">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/posts" title="æ–‡ç« ">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/archives" title="æ—¶é—´è½´">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/tags/" title="æ ‡ç­¾">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/search/" title="æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/support" title="æ‰“èµ">
                    <span>ğŸ«¶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://heliu.site/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/">Article</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/golang/">Golang</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/golang/goroutine/">ç¬¬12ç«  Goroutine</a></div>
    <h1 class="post-title entry-hint-parent">
      GMP è°ƒåº¦æ¨¡å‹
    </h1>
    <div class="post-description">
      ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬
    </div>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2024-07-30</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2024-07-30</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>10915å­—</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>52åˆ†é’Ÿ</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &nbsp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://heliu.site/tags/golang/" target="_blank" rel="noopener">Golang</a>
            <a href="https://heliu.site/tags/goroutine/" target="_blank" rel="noopener">Goroutine</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &nbsp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#runtimemstartsb" aria-label="runtimeÂ·mstart(SB)">runtimeÂ·mstart(SB)</a><ul>
                            
                    <li>
                        <a href="#mstart0" aria-label="mstart0()">mstart0()</a></li>
                    <li>
                        <a href="#mstart1" aria-label="mstart1()">mstart1()</a></li></ul>
                    </li>
                    <li>
                        <a href="#schedule" aria-label="schedule()">schedule()</a><ul>
                            
                    <li>
                        <a href="#findrunnable" aria-label="findRunnable()ğŸš€">findRunnable()ğŸš€</a></li>
                    <li>
                        <a href="#gcstopm" aria-label="gcstopm()">gcstopm()</a><ul>
                            
                    <li>
                        <a href="#releasep" aria-label="releasep()">releasep()</a></li>
                    <li>
                        <a href="#stopm" aria-label="stopm()">stopm()</a></li>
                    <li>
                        <a href="#mput" aria-label="mput()">mput()</a></li>
                    <li>
                        <a href="#mpark" aria-label="mPark()">mPark()</a></li>
                    <li>
                        <a href="#acquirep" aria-label="acquirep()">acquirep()</a></li></ul>
                    </li>
                    <li>
                        <a href="#globrunqget" aria-label="globrunqget()">globrunqget()</a><ul>
                            
                    <li>
                        <a href="#runqput" aria-label="runqput()">runqput()</a></li></ul>
                    </li>
                    <li>
                        <a href="#runqget" aria-label="runqget()">runqget()</a></li>
                    <li>
                        <a href="#injectglist" aria-label="injectglist()">injectglist()</a></li>
                    <li>
                        <a href="#stealwork" aria-label="stealWork()">stealWork()</a><ul>
                            
                    <li>
                        <a href="#runqsteal" aria-label="runqsteal()">runqsteal()</a></li>
                    <li>
                        <a href="#runqgrab" aria-label="runqgrab()">runqgrab()</a></li></ul>
                    </li>
                    <li>
                        <a href="#releasep-1" aria-label="releasep()">releasep()</a></li>
                    <li>
                        <a href="#pidleput" aria-label="pidleput()">pidleput()</a><ul>
                            
                    <li>
                        <a href="#runqempty" aria-label="runqempty()">runqempty()</a></li>
                    <li>
                        <a href="#pidleget" aria-label="pidleget()">pidleget()</a></li></ul>
                    </li>
                    <li>
                        <a href="#checkrunqsnop" aria-label="checkRunqsNoP()">checkRunqsNoP()</a></li>
                    <li>
                        <a href="#checkidlegcnop" aria-label="checkIdleGCNoP()">checkIdleGCNoP()</a></li>
                    <li>
                        <a href="#checktimersnop" aria-label="checkTimersNoP()">checkTimersNoP()</a></li>
                    <li>
                        <a href="#stopm-1" aria-label="stopm()">stopm()</a><ul>
                            
                    <li>
                        <a href="#mput-1" aria-label="mput()">mput()</a></li>
                    <li>
                        <a href="#mget" aria-label="mget()">mget()</a></li>
                    <li>
                        <a href="#mpark-1" aria-label="mPark()">mPark()</a></li>
                    <li>
                        <a href="#notesleep" aria-label="notesleep()">notesleep()</a></li>
                    <li>
                        <a href="#futexsleep" aria-label="futexsleep()">futexsleep()</a></li>
                    <li>
                        <a href="#futex" aria-label="futex()">futex()</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#execute-" aria-label="execute() ğŸš€">execute() ğŸš€</a><ul>
                            
                    <li>
                        <a href="#gogo" aria-label="gogo()">gogo()</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%85%b6%e4%bb%96%e7%9b%b8%e5%85%b3%e5%87%bd%e6%95%b0" aria-label="å…¶ä»–ç›¸å…³å‡½æ•°">å…¶ä»–ç›¸å…³å‡½æ•°</a><ul>
                            
                    <li>
                        <a href="#checktimers" aria-label="checkTimers()">checkTimers()</a></li>
                    <li>
                        <a href="#checkdead" aria-label="checkdead()">checkdead()</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><ul>
<li>æœ¬ç¯‡ä»‹ç»Golangç›¸å…³è°ƒåº¦ä»£ç ï¼Œæœ¬ç¯‡ä¹Ÿæ˜¯ç†è§£GMPæ¨¡å‹çš„é‡ç‚¹ç¯‡èŠ‚ã€‚</li>
</ul>
<h2 id="runtimemstartsb">runtimeÂ·mstart(SB)<a hidden class="anchor" aria-hidden="true" href="#runtimemstartsb">#</a></h2>
<p>å·¥ä½œçº¿ç¨‹<code>M</code>çš„è‡ªæ—‹çŠ¶æ€(<code>spinning</code>)è§£é‡Šï¼š<strong>å·¥ä½œçº¿ç¨‹åœ¨ä»å…¶å®ƒå·¥ä½œçº¿ç¨‹çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­ç›—å–<code>goroutine</code>æ—¶çš„çŠ¶æ€ç§°ä¸ºè‡ªæ—‹çŠ¶æ€</strong>ã€‚</p>
<ol>
<li>è¯¥å‡½æ•°æ˜¯æ‰€æœ‰æ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹éœ€è¦æ‰§è¡Œçš„å‡½æ•°ï¼Œä¹Ÿæ˜¯è°ƒåº¦å¾ªç¯çš„å…¥å£å‡½æ•°ã€‚</li>
<li>æ‰€æœ‰ã€æ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹ã€‘å¼€å§‹è¿è¡Œçš„å…¥å£éƒ½æ˜¯ä»è¿™ä¸ªå‡½æ•°å¼€å§‹è¿è¡Œçš„ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/asm_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">mstart</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="err">|</span><span class="no">TOPFRAME</span><span class="p">,</span><span class="no">$0</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è°ƒç”¨runtime.mstart0å‡½æ•°ï¼Œè¯¥å‡½æ•°æ°¸è¿œä¸ä¼šè¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">mstart0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="c1"># æœªè¾¾åˆ°ã€‚ä¸ä¼šåˆ°è¿™é‡Œæ¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">RET</span> <span class="c1"># not reached
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="mstart0">mstart0()<a hidden class="anchor" aria-hidden="true" href="#mstart0">#</a></h3>
<ol>
<li><code>mstart0</code>æ˜¯æ–°<code>Ms</code>çš„<code>Go</code>å…¥å£ç‚¹ã€‚è¯¥å‡½æ•°æ˜¯ä¸å…è®¸æ ˆå¢é•¿æ£€æŸ¥çš„ï¼Œå› ä¸ºæˆ‘ä»¬ç”šè‡³å¯èƒ½è¿˜æ²¡æœ‰è®¾ç½®å †æ ˆè¾¹ç•Œã€‚</li>
<li>èƒ½åœ¨<code>STW</code>æœŸé—´è¿è¡Œï¼ˆå› ä¸ºå®ƒè¿˜æ²¡æœ‰<code>P</code>ï¼‰ï¼Œæ‰€ä»¥ä¸å…è®¸å†™å±éšœã€‚</li>
<li>åˆå§‹åŒ–<code>g0</code>æ ˆå¤§å°ï¼Œä»¥åŠè°ƒç”¨<code>mstart1()</code>å‡½æ•°å¼€å¯è°ƒåº¦å¾ªç¯ã€‚</li>
<li>å› ä¸ºå¯èƒ½å­˜åœ¨å…¶ä»–åˆšåˆ›å»ºçš„å·¥ä½œçº¿ç¨‹å¹¶æ²¡æœ‰åˆå§‹åŒ–<code>g0</code>æ ˆå¤§å°ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è®¾ç½®ä¸€ä¸‹ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1347
</span><span class="lnt">1348
</span><span class="lnt">1349
</span><span class="lnt">1350
</span><span class="lnt">1351
</span><span class="lnt">1352
</span><span class="lnt">1353
</span><span class="lnt">1354
</span><span class="lnt">1355
</span><span class="lnt">1356
</span><span class="lnt">1357
</span><span class="lnt">1358
</span><span class="lnt">1359
</span><span class="lnt">1360
</span><span class="lnt">1361
</span><span class="lnt">1362
</span><span class="lnt">1363
</span><span class="lnt">1364
</span><span class="lnt">1365
</span><span class="lnt">1366
</span><span class="lnt">1367
</span><span class="lnt">1368
</span><span class="lnt">1369
</span><span class="lnt">1370
</span><span class="lnt">1371
</span><span class="lnt">1372
</span><span class="lnt">1373
</span><span class="lnt">1374
</span><span class="lnt">1375
</span><span class="lnt">1376
</span><span class="lnt">1377
</span><span class="lnt">1378
</span><span class="lnt">1379
</span><span class="lnt">1380
</span><span class="lnt">1381
</span><span class="lnt">1382
</span><span class="lnt">1383
</span><span class="lnt">1384
</span><span class="lnt">1385
</span><span class="lnt">1386
</span><span class="lnt">1387
</span><span class="lnt">1388
</span><span class="lnt">1389
</span><span class="lnt">1390
</span><span class="lnt">1391
</span><span class="lnt">1392
</span><span class="lnt">1393
</span><span class="lnt">1394
</span><span class="lnt">1395
</span><span class="lnt">1396
</span><span class="lnt">1397
</span><span class="lnt">1398
</span><span class="lnt">1399
</span><span class="lnt">1400
</span><span class="lnt">1401
</span><span class="lnt">1402
</span><span class="lnt">1403
</span><span class="lnt">1404
</span><span class="lnt">1405
</span><span class="lnt">1406
</span><span class="lnt">1407
</span><span class="lnt">1408
</span><span class="lnt">1409
</span><span class="lnt">1410
</span><span class="lnt">1411
</span><span class="lnt">1412
</span><span class="lnt">1413
</span><span class="lnt">1414
</span><span class="lnt">1415
</span><span class="lnt">1416
</span><span class="lnt">1417
</span><span class="lnt">1418
</span><span class="lnt">1419
</span><span class="lnt">1420
</span><span class="lnt">1421
</span><span class="lnt">1422
</span><span class="lnt">1423
</span><span class="lnt">1424
</span><span class="lnt">1425
</span><span class="lnt">1426
</span><span class="lnt">1427
</span><span class="lnt">1428
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// mstart0 is the Go entry-point for new Ms.
</span></span></span><span class="line"><span class="cl"><span class="c1">// This must not split the stack because we may not even have stack
</span></span></span><span class="line"><span class="cl"><span class="c1">// bounds set up yet.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// May run during STW (because it doesn&#39;t have a P yet), so write
</span></span></span><span class="line"><span class="cl"><span class="c1">// barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mstart0</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¯¥å‡½æ•°æ˜¯å·¥ä½œçº¿ç¨‹Mèµ·æ¥æ‰§è¡Œçš„å…¥å£å‡½æ•°ï¼Œè¿™é‡Œä¸€å®šæ˜¯g0æ ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>   <span class="c1">// _g_ = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰gæ˜¯å¦å·²åˆ†é…æ ˆï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. ç¨‹åºåˆšåˆå§‹åŒ–æ—¶å‰é¢æ˜¯åˆ†é…äº†å¤§çº¦64KBå¤§å°æ ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. å¦‚æœæ˜¯é€šè¿‡wakeup()å‡½æ•°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹ï¼Œè¿™é‡Œå¯èƒ½æ˜¯æ²¡æœ‰åˆ†é…æ ˆå¤§å°çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">osStack</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">==</span> <span class="mi">0</span>    <span class="c1">// åˆ¤æ–­å½“å‰g0æ˜¯å¦åˆ†é…æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">osStack</span> <span class="p">{</span> <span class="c1">// æ ˆæœªåˆ†é…å¤§å°æ—¶ï¼Œè¿™ä¹Ÿæ˜¯æ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹éœ€è¦å¤„ç†çš„gæ ˆæƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Initialize stack bounds from system stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Cgo may have left stack size in stack.hi.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// minit may update the stack bounds.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä»ç³»ç»Ÿæ ˆåˆå§‹åŒ–æ ˆè¾¹ç•Œã€‚Cgo å¯èƒ½åœ¨ stack.hi ä¸­ç•™ä¸‹äº†æ ˆå¤§å°ã€‚minit å¯èƒ½ä¼šæ›´æ–°æ ˆè¾¹ç•Œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Note: these bounds may not be very accurate.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// We set hi to &amp;size, but there are things above
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// it. The 1024 is supposed to compensate this,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// but is somewhat arbitrary.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ³¨æ„ï¼šè¿™äº›ç•Œé™å¯èƒ½ä¸æ˜¯å¾ˆå‡†ç¡®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æˆ‘ä»¬å°† hi è®¾ç½®ä¸º &amp;sizeï¼Œä½†æ˜¯ä¸Šé¢è¿˜æœ‰ä¸€äº›ä¸œè¥¿ã€‚ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 1024 åº”è¯¥å¯ä»¥å¼¥è¡¥è¿™ä¸€ç‚¹ï¼Œä½†æœ‰äº›æ­¦æ–­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1">// ä»¥ä¸Šçš„æ„æ€æ˜¯ç›´æ¥åœ¨å½“å‰å·¥ä½œçº¿ç¨‹ç³»ç»Ÿæ ˆä¸Šç»™å½“å‰è¿™ä¸ªg0åˆ†é…æ ˆå¤§å°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å¯èƒ½ä¸Šé¢æœ‰æ ˆæ•°æ®ï¼Œåç§»1024å­—èŠ‚åº”è¯¥èƒ½å¼¥è¡¥è¿™äº›æ•°æ®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">size</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span> <span class="c1">// size å¤šåŠæ˜¯0; size ä¸€å®šæ˜¯åˆ†é…åœ¨å½“å‰æ ˆä¸Šçš„ï¼Œå› æ­¤&amp;sizeå°±æ˜¯æ ˆåœ°å€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">            <span class="c1">// sys.StackGuardMultiplier = 1; å¯è§å…¶ä»–å·¥ä½œçº¿ç¨‹çš„g0æ ˆå¤§çº¦ä¸º8KBã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">size</span> <span class="p">=</span> <span class="mi">8192</span> <span class="o">*</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">StackGuardMultiplier</span>  <span class="c1">// è®¾ç½®sizeä¸ºæŒ‡å®šå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// noescapeå‡½æ•°å–sizeåœ°å€å¹¶ä¸0å¼‚æˆ–ï¼Œå®é™…ä½œç”¨æ˜¯éšè—(é˜²æ­¢)sizeå˜é‡é€ƒé€¸åˆ†ææŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// é˜²æ­¢ç¼–è¯‘å™¨æŠŠsizeå˜é‡å †åˆ†é…ï¼Œè¿™é‡Œéœ€è¦çš„æ˜¯æ ˆåˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å› æ­¤å½“å‰_g_çš„æ ˆå¤‡ä»½åˆ†é…åˆ°å½“å‰æ ˆçš„sizeå˜é‡ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// noescapeå‡½æ•°ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// func noescape(p unsafe.Pointer) unsafe.Pointer {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//      x := uintptr(p)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//      return unsafe.Pointer(x ^ 0)    // é˜²æ­¢å˜é‡xé€ƒé€¸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä»¥&amp;sizeä¸ºèµ·ç‚¹è®¾ç½®g0æ ˆã€‚g0.stack -&gt; [&amp;size, &amp;size - 8192 + 1024]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span> <span class="p">=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nf">noescape</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">size</span><span class="p">)))</span> <span class="c1">// hiå­˜å‚¨sizeçš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯rbp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="p">=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span> <span class="o">-</span> <span class="nx">size</span> <span class="o">+</span> <span class="mi">1024</span>   <span class="c1">// loå­˜å‚¨æ ˆé¡¶ä½ç½®ï¼Œä¹Ÿå°±æ˜¯rsp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Initialize stack guard so that we can start calling regular
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Go code.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åˆå§‹åŒ–æ ˆä¿æŠ¤ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å¼€å§‹è°ƒç”¨å¸¸è§„ Go ä»£ç ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// stackguard0 = _g_.stack.lo + 928; æ ˆæº¢å‡ºæ£€æŸ¥çš„é˜ˆå€¼ç‚¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">+</span> <span class="nx">_StackGuard</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// This is the g0, so we can also call go:systemstack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// functions, which check stackguard1.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™æ˜¯ g0ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥è°ƒç”¨ go:systemstack å‡½æ•°æ¥æ£€æŸ¥ stackguard1ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">stackguard1</span> <span class="p">=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">stackguard0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">mstart1</span><span class="p">()</span> <span class="c1">// è°ƒç”¨mstart1å¼€å¯è°ƒåº¦å¾ªç¯ï¼Œè¯¥å‡½æ•°æ°¸è¿œä¸ä¼šè¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Exit this thread.	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é€€å‡ºè¿™ä¸ªçº¿ç¨‹ï¼Œç¨‹åºä¸ä¼šåˆ°è¿™é‡Œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">mStackIsSystemAllocated</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Windows, Solaris, illumos, Darwin, AIX and Plan 9 always system-allocate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// the stack, but put it in _g_.stack before mstart,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// so the logic above hasn&#39;t set osStack yet.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Windowsã€Solarisã€illumosã€Darwinã€AIX å’ŒPlan 9 æ€»æ˜¯ç³»ç»Ÿåˆ†é…æ ˆï¼Œä½†æ˜¯åœ¨mstart ä¹‹å‰æ”¾åœ¨_g_.stack ä¸­ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ‰€ä»¥ä¸Šé¢çš„é€»è¾‘è¿˜æ²¡æœ‰è®¾ç½®osStack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">osStack</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">mexit</span><span class="p">(</span><span class="nx">osStack</span><span class="p">)</span> <span class="c1">// ç»“æŸå½“å‰çº¿ç¨‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>æ€»ç»“ï¼šå·¥ä½œçº¿ç¨‹å¼€å§‹æ‰§è¡Œä½¿ï¼Œå…ˆåˆ¤æ–­<code>g0</code>æ˜¯å¦åˆ†é…äº†æ ˆå¤§å°ï¼Œæ²¡æœ‰åˆ™åˆ†é…å¤§çº¦<code>8KB</code>å¤§å°æ ˆç©ºé—´ï¼Œç„¶åè®¾ç½®<code>stackguard0</code>ã€<code>stackguard1</code>ã€‚</li>
</ol>
<h3 id="mstart1">mstart1()<a hidden class="anchor" aria-hidden="true" href="#mstart1">#</a></h3>
<ol>
<li>è®¾ç½®<code>g0</code>è¢«è°ƒåº¦æ—¶çš„è°ƒåº¦ä¿¡æ¯ï¼Œæ¯”å¦‚ä»å“ªé‡Œè¿›å…¥ï¼Œæ ˆä»å“ªé‡Œå¼€å§‹ç­‰ï¼Œä»¥åŠç»™å½“å‰å·¥ä½œçº¿ç¨‹<code>M</code>ç»‘å®šä¸ª<code>P</code>å¹¶å¼€å¯è°ƒåº¦å¾ªç¯ã€‚</li>
<li>è®¾ç½®<code>g0</code>çš„è°ƒåº¦ä¿¡æ¯æ˜¯åœ¨äºï¼Œåœ¨è°ƒåº¦å¾ªç¯è¿‡ç¨‹ä¸­ä¼šåˆ‡æ¢åˆ°<code>g0</code>æ ˆæ‰§è¡Œ<code>runtime</code>çš„ç›¸å…³å‡½æ•°ï¼Œä»¥å…æ ˆæ— é™æ‰©å¤§ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1394
</span><span class="lnt">1395
</span><span class="lnt">1396
</span><span class="lnt">1397
</span><span class="lnt">1398
</span><span class="lnt">1399
</span><span class="lnt">1400
</span><span class="lnt">1401
</span><span class="lnt">1402
</span><span class="lnt">1403
</span><span class="lnt">1404
</span><span class="lnt">1405
</span><span class="lnt">1406
</span><span class="lnt">1407
</span><span class="lnt">1408
</span><span class="lnt">1409
</span><span class="lnt">1410
</span><span class="lnt">1411
</span><span class="lnt">1412
</span><span class="lnt">1413
</span><span class="lnt">1414
</span><span class="lnt">1415
</span><span class="lnt">1416
</span><span class="lnt">1417
</span><span class="lnt">1418
</span><span class="lnt">1419
</span><span class="lnt">1420
</span><span class="lnt">1421
</span><span class="lnt">1422
</span><span class="lnt">1423
</span><span class="lnt">1424
</span><span class="lnt">1425
</span><span class="lnt">1426
</span><span class="lnt">1427
</span><span class="lnt">1428
</span><span class="lnt">1429
</span><span class="lnt">1430
</span><span class="lnt">1431
</span><span class="lnt">1432
</span><span class="lnt">1433
</span><span class="lnt">1434
</span><span class="lnt">1435
</span><span class="lnt">1436
</span><span class="lnt">1437
</span><span class="lnt">1438
</span><span class="lnt">1439
</span><span class="lnt">1440
</span><span class="lnt">1441
</span><span class="lnt">1442
</span><span class="lnt">1443
</span><span class="lnt">1444
</span><span class="lnt">1445
</span><span class="lnt">1446
</span><span class="lnt">1447
</span><span class="lnt">1448
</span><span class="lnt">1449
</span><span class="lnt">1450
</span><span class="lnt">1451
</span><span class="lnt">1452
</span><span class="lnt">1453
</span><span class="lnt">1454
</span><span class="lnt">1455
</span><span class="lnt">1456
</span><span class="lnt">1457
</span><span class="lnt">1458
</span><span class="lnt">1459
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// The go:noinline is to guarantee the getcallerpc/getcallersp below are safe,
</span></span></span><span class="line"><span class="cl"><span class="c1">// so that we can set up g0.sched to return to the call of mstart1 above.
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mstart1</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>   <span class="c1">// _g_ = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰_g_ ä¸€å®šæ˜¯g0ï¼Œå› ä¸ºè¯¥å‡½æ•°åªæœ‰ç¨‹åºåˆå§‹åŒ–æˆ–çº¿ç¨‹åˆšå¯åŠ¨æ—¶æ‰ä¼šè°ƒç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span> <span class="o">!=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">g0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad runtimeÂ·mstart&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Set up m.g0.sched as a label returning to just
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// after the mstart1 call in mstart0 above, for use by goexit0 and mcall.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// We&#39;re never coming back to mstart1 after we call schedule,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// so other calls can reuse the current frame.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// And goexit0 does a gogo that needs to return from mstart1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// and let mstart0 exit the thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å°† m.g0.sched è®¾ç½®ä¸ºä¸Šé¢ mstart0 ä¸­ mstart1 è°ƒç”¨åè¿”å›çš„æ ‡ç­¾ï¼Œä¾› goexit0 å’Œ mcall ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨è°ƒç”¨ schedule ä¹‹åï¼Œæˆ‘ä»¬æ°¸è¿œä¸ä¼šå›åˆ° mstart1ï¼Œå› æ­¤å…¶ä»–è°ƒç”¨å¯ä»¥é‡ç”¨å½“å‰å¸§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è€Œgoexit0åšäº†ä¸€ä¸ªgogoï¼Œéœ€è¦ä»mstart1è¿”å›ï¼Œè®©mstart0é€€å‡ºçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// g0.sched.g = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">g</span> <span class="p">=</span> <span class="nf">guintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">_g_</span><span class="p">))</span> <span class="c1">// è®¾ç½®g0çš„è°ƒåº¦ä¿¡æ¯æ˜¯å½“å‰g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// g0.sched.pc = getcallerpc()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// getcallerpc()ï¼šè°ƒç”¨è€…å‡½æ•°çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯mstart0()å‡½æ•°è°ƒç”¨mstart1()å‡½æ•°åçš„ifåˆ¤æ–­æŒ‡ä»¤ä»£ç å¤„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">pc</span> <span class="p">=</span> <span class="nf">getcallerpc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿™é‡Œæ˜¯ç†è§£è°ƒåº¦å¾ªç¯çš„å…³é”®ï¼Œè°ƒåº¦å¾ªç¯æ¯æ¬¡åˆ‡æ¢åˆ°g0æ ˆéƒ½ä»è¿™é‡Œ(æŒ‡å®šçš„å›ºå®šä½ç½®)è®¾ç½®çš„ä½ç½®å¼€å§‹ä½¿ç”¨æ ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// g0.sched.pc = getcallersp()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// getcallersp()ï¼šè°ƒç”¨è€…å½“å‰çš„SPå¯„å­˜å™¨å€¼ï¼Œä¹Ÿå°±æ˜¯mstart0()å‡½æ•°è°ƒç”¨mstart1()å‡½æ•°æ—¶SPå¯„å­˜å™¨çš„å€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è®¾ç½®rspå¯„å­˜å™¨å€¼ä¸ºmaster0è°ƒç”¨master1æ—¶çš„æ ˆé¡¶å¤„ï¼Œè®¾ç½®åœ¨è¿™é‡Œä¾¿äºæ¯æ¬¡åˆ‡æ¢çš„g0æ ˆéƒ½æ˜¯ä»å›ºå®šä½ç½®å¼€å§‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sp</span> <span class="p">=</span> <span class="nf">getcallersp</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// go1.19.3/src/runtime/asm_amd64.s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// TEXT runtimeÂ·asminit(SB),NOSPLIT,$0-0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   // No per-thread init.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   RET
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ²¡æœ‰ä»€ä¹ˆå¯åšçš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">asminit</span><span class="p">()</span>   <span class="c1">// è¯¥å‡½æ•°çš„æ±‡ç¼–ä»£ç ä»€ä¹ˆéƒ½æ²¡åšï¼Œåˆå§‹åŒ–Må·¥ä½œçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">minit</span><span class="p">()</span>     <span class="c1">// è°ƒç”¨ä»¥åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ mï¼ˆåŒ…æ‹¬å¼•å¯¼ç¨‹åº mï¼‰ï¼Œåœ¨æ–°çº¿ç¨‹ä¸Šè°ƒç”¨ï¼Œæ— æ³•åˆ†é…å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Install signal handlers; after minit so that minit can
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// prepare the thread to be able to handle the signals.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å®‰è£…ä¿¡å·å¤„ç†ç¨‹åºï¼› åœ¨ minit ä¹‹åï¼Œä»¥ä¾¿ minit å¯ä»¥å‡†å¤‡çº¿ç¨‹ä»¥å¤„ç†ä¿¡å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span> <span class="o">==</span> <span class="o">&amp;</span><span class="nx">m0</span> <span class="p">{</span>   <span class="c1">// åˆ¤æ–­g0ç»‘å®šçš„mæ˜¯å¦æ˜¯m0ï¼Œm0æ˜¯main.goroutineä¹Ÿå°±æ˜¯ä¸»çº¿ç¨‹æ—¶æ‰§è¡Œä¸‹é¢æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">mstartm0</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœ_g_.m.mstartfnå­˜åœ¨åˆ™æ‰§è¡Œè¯¥å‡½æ•°ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. ä¸€èˆ¬çš„æƒ…å†µä¸‹è¯¥å‡½æ•°æ˜¯ï¼Œmspinning()å‡½æ•°ã€‚è¯¥å‡½æ•°åªæœ‰ä¸€æ¡æŒ‡ä»¤ï¼Œæ ‡è®°mçš„mspiningå­—æ®µä¸ºtrueã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. å¦‚æœæ˜¯sysmonçº¿ç¨‹ä¸‹ï¼Œè¿™é‡Œæ˜¯ç›´æ¥è°ƒç”¨sysmon()å‡½æ•°ï¼Œè¯¥å‡½æ•°æ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œè¿™é‡Œä¸ä¼šè¿”å›ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">fn</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">mstartfn</span><span class="p">;</span> <span class="nx">fn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ç¨‹åºåˆšåˆå§‹åŒ–æ—¶ï¼Œä¸€å®šæ˜¯m0ï¼Œå› ä¸ºåœ¨å‰é¢m0å·²ç»ç»‘å®šäº†Pï¼Œæ‰€ä»¥æ˜¯m0éœ€è¦è·³è¿‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é€šè¿‡wakeup()å‡½æ•°åˆ›å»ºçš„æ–°çš„å·¥ä½œçº¿ç¨‹mæ—¶ï¼Œè¿™é‡Œéœ€è¦ç»‘å®šä¸ªPã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="nx">m0</span> <span class="p">{</span> <span class="c1">// ä¸æ˜¯m0åˆ™éœ€è¦ç»™å·¥ä½œçº¿ç¨‹Mç»‘å®šä¸€ä¸ªP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// _g_.m.nextp.ptr()è·å–ä¸‹ä¸€ä¸ªPï¼Œnextpåœ¨wakeup()å‡½æ•°ç›¸å…³è¢«èµ‹å€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">nextp</span><span class="p">.</span><span class="nf">ptr</span><span class="p">())</span> <span class="c1">// è°ƒç”¨acquirep(_g_.m.nextp.ptr())ç»‘å®šp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">nextp</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¼€å¯å¾ªç¯è°ƒåº¦ï¼Œè¯¥å‡½æ•°æ°¸è¿œä¸è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">schedule</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

<p><details >
  <summary markdown="span">minit()</summary>
  <blockquote>
<ol>
<li>åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„<code>m</code>ï¼ˆåŒ…æ‹¬å¼•å¯¼ç¨‹åº<code>m</code>ï¼‰ã€‚åœ¨æ–°çº¿ç¨‹ä¸Šè°ƒç”¨ï¼Œæ— æ³•åˆ†é…å†…å­˜ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/os_linux.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Called to initialize a new m (including the bootstrap m).
</span></span></span><span class="line"><span class="cl"><span class="c1">// Called on the new thread, cannot allocate memory.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">minit</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆå§‹åŒ– Signals
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">minitSignals</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Cgo-created threads and the bootstrap m are missing a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// procid. We need this for asynchronous preemption and it&#39;s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// useful in debuggers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">getg</span><span class="p">().</span><span class="nx">m</span><span class="p">.</span><span class="nx">procid</span> <span class="p">=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nf">gettid</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/signal_unix.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1192
</span><span class="lnt">1193
</span><span class="lnt">1194
</span><span class="lnt">1195
</span><span class="lnt">1196
</span><span class="lnt">1197
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// minitSignals is called when initializing a new m to set the
</span></span></span><span class="line"><span class="cl"><span class="c1">// thread&#39;s alternate signal stack and signal mask.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">minitSignals</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">minitSignalStack</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">minitSignalMask</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>

</details></p>



<p><details >
  <summary markdown="span">acquirep()</summary>
  <blockquote>
<ol>
<li>å‚æ•°<code>_p_ *p</code>ï¼šç©ºé—²çš„<code>p</code>åœ¨<code>wakeup()</code>å‡½æ•°æ—¶å­˜å…¥<code>m.nextp</code>å¤„ï¼Œä¾›å·¥ä½œçº¿ç¨‹å¯åŠ¨åç»‘å®šè¿™ä¸ª<code>P</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">4938
</span><span class="lnt">4939
</span><span class="lnt">4940
</span><span class="lnt">4941
</span><span class="lnt">4942
</span><span class="lnt">4943
</span><span class="lnt">4944
</span><span class="lnt">4945
</span><span class="lnt">4946
</span><span class="lnt">4947
</span><span class="lnt">4948
</span><span class="lnt">4949
</span><span class="lnt">4950
</span><span class="lnt">4951
</span><span class="lnt">4952
</span><span class="lnt">4953
</span><span class="lnt">4954
</span><span class="lnt">4955
</span><span class="lnt">4956
</span><span class="lnt">4957
</span><span class="lnt">4958
</span><span class="lnt">4959
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Associate p and the current m.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// This function is allowed to have write barriers even if the caller
</span></span></span><span class="line"><span class="cl"><span class="c1">// isn&#39;t because it immediately acquires _p_.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:yeswritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Do the part that isn&#39;t allowed to have write barriers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">wirep</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>	<span class="c1">// ç»‘å®šPä¸å½“å‰å·¥ä½œçº¿ç¨‹M
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Have p; write barriers now allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Perform deferred mcache flush before this P can allocate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// from a potentially stale mcache.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨æ­¤ P å¯ä»¥ä»å¯èƒ½è¿‡æ—¶çš„ mcache åˆ†é…ä¹‹å‰æ‰§è¡Œå»¶è¿Ÿ mcache åˆ·æ–°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">mcache</span><span class="p">.</span><span class="nf">prepareForSweep</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceProcStart</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>ç»‘å®šä¼ å…¥çš„Påœ¨å½“å‰å·¥ä½œçº¿ç¨‹ã€‚<code>wirep</code>æ˜¯<code>acquirep</code>çš„ç¬¬ä¸€æ­¥ï¼Œå®é™…ä¸Šæ˜¯å°†å½“å‰çš„<code>M</code>å…³è”åˆ°<code>_p_</code>ã€‚</li>
<li>è¿™æ˜¯è¢«æ‰“ç ´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç¦æ­¢è¿™éƒ¨åˆ†çš„å†™å±éšœï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰<code>P</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">4959
</span><span class="lnt">4960
</span><span class="lnt">4961
</span><span class="lnt">4962
</span><span class="lnt">4963
</span><span class="lnt">4964
</span><span class="lnt">4965
</span><span class="lnt">4966
</span><span class="lnt">4967
</span><span class="lnt">4968
</span><span class="lnt">4969
</span><span class="lnt">4970
</span><span class="lnt">4971
</span><span class="lnt">4972
</span><span class="lnt">4973
</span><span class="lnt">4974
</span><span class="lnt">4975
</span><span class="lnt">4976
</span><span class="lnt">4977
</span><span class="lnt">4978
</span><span class="lnt">4979
</span><span class="lnt">4980
</span><span class="lnt">4981
</span><span class="lnt">4982
</span><span class="lnt">4983
</span><span class="lnt">4984
</span><span class="lnt">4985
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// wirep is the first step of acquirep, which actually associates the
</span></span></span><span class="line"><span class="cl"><span class="c1">// current M to _p_. This is broken out so we can disallow write
</span></span></span><span class="line"><span class="cl"><span class="c1">// barriers for this part, since we don&#39;t yet have a P.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">wirep</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>     <span class="c1">// è·å–å½“å‰çš„g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// å½“å‰å·¥ä½œçº¿ç¨‹å¦‚æœç»‘å®šäº†Påˆ™æœ‰é—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;wirep: already in go&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰Pç»‘å®šäº†å·¥ä½œçº¿ç¨‹å­˜åœ¨é—®é¢˜ï¼Œè¯¥Pä¸æ˜¯ç©ºé—²çš„ æˆ– å½“å‰Pä¸å¤„äºç©ºé—²çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="nx">_Pidle</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">id</span> <span class="p">=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">id</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;wirep: p-&gt;m=&#34;</span><span class="p">,</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span> <span class="s">&#34;(&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&#34;) p-&gt;status=&#34;</span><span class="p">,</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;wirep: invalid p state&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰å·¥ä½œçº¿ç¨‹Mç»‘å®šP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>  <span class="c1">// m.p = _p_		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰Pç»‘å®šå·¥ä½œçº¿ç¨‹M
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span>  <span class="c1">// _p_.m = m  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span> <span class="p">=</span> <span class="nx">_Prunning</span>    <span class="c1">// æŠŠå½“å‰PçŠ¶æ€ä¿®æ”¹ä¸º_Prunning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>

</details></p>

<h2 id="schedule">schedule()<a hidden class="anchor" aria-hidden="true" href="#schedule">#</a></h2>
<ol>
<li>å¾ªç¯è°ƒåº¦å¼€å§‹ã€‚æ¯è½®å¾ªç¯éƒ½ä»è¿™é‡Œå¼€å§‹ã€‚è¯¥å‡½æ•°ç®—æ˜¯è°ƒåº¦å™¨çš„<strong>æ ¸å¿ƒå‡½æ•°</strong>ï¼Œè¿è¡Œèµ·æ¥çš„çº¿ç¨‹ä¼šä¸€ç›´æ‰§è¡Œå®ƒã€‚</li>
<li>ä¸€è½®è°ƒåº¦å™¨ï¼šæ‰¾åˆ°ä¸€ä¸ªå¯è¿è¡Œçš„<code>goroutine</code>å¹¶æ‰§è¡Œå®ƒã€‚æ°¸ä¸è¿”å›ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">3183
</span><span class="lnt">3184
</span><span class="lnt">3185
</span><span class="lnt">3186
</span><span class="lnt">3187
</span><span class="lnt">3188
</span><span class="lnt">3189
</span><span class="lnt">3190
</span><span class="lnt">3191
</span><span class="lnt">3192
</span><span class="lnt">3193
</span><span class="lnt">3194
</span><span class="lnt">3195
</span><span class="lnt">3196
</span><span class="lnt">3197
</span><span class="lnt">3198
</span><span class="lnt">3199
</span><span class="lnt">3200
</span><span class="lnt">3201
</span><span class="lnt">3202
</span><span class="lnt">3203
</span><span class="lnt">3204
</span><span class="lnt">3205
</span><span class="lnt">3206
</span><span class="lnt">3207
</span><span class="lnt">3208
</span><span class="lnt">3209
</span><span class="lnt">3210
</span><span class="lnt">3211
</span><span class="lnt">3212
</span><span class="lnt">3213
</span><span class="lnt">3214
</span><span class="lnt">3215
</span><span class="lnt">3216
</span><span class="lnt">3217
</span><span class="lnt">3218
</span><span class="lnt">3219
</span><span class="lnt">3220
</span><span class="lnt">3221
</span><span class="lnt">3222
</span><span class="lnt">3223
</span><span class="lnt">3224
</span><span class="lnt">3225
</span><span class="lnt">3226
</span><span class="lnt">3227
</span><span class="lnt">3228
</span><span class="lnt">3229
</span><span class="lnt">3230
</span><span class="lnt">3231
</span><span class="lnt">3232
</span><span class="lnt">3233
</span><span class="lnt">3234
</span><span class="lnt">3235
</span><span class="lnt">3236
</span><span class="lnt">3237
</span><span class="lnt">3238
</span><span class="lnt">3239
</span><span class="lnt">3240
</span><span class="lnt">3241
</span><span class="lnt">3242
</span><span class="lnt">3243
</span><span class="lnt">3244
</span><span class="lnt">3245
</span><span class="lnt">3246
</span><span class="lnt">3247
</span><span class="lnt">3248
</span><span class="lnt">3249
</span><span class="lnt">3250
</span><span class="lnt">3251
</span><span class="lnt">3252
</span><span class="lnt">3253
</span><span class="lnt">3254
</span><span class="lnt">3255
</span><span class="lnt">3256
</span><span class="lnt">3257
</span><span class="lnt">3258
</span><span class="lnt">3259
</span><span class="lnt">3260
</span><span class="lnt">3261
</span><span class="lnt">3262
</span><span class="lnt">3263
</span><span class="lnt">3264
</span><span class="lnt">3265
</span><span class="lnt">3266
</span><span class="lnt">3267
</span><span class="lnt">3268
</span><span class="lnt">3269
</span><span class="lnt">3270
</span><span class="lnt">3271
</span><span class="lnt">3272
</span><span class="lnt">3273
</span><span class="lnt">3274
</span><span class="lnt">3275
</span><span class="lnt">3276
</span><span class="lnt">3277
</span><span class="lnt">3278
</span><span class="lnt">3279
</span><span class="lnt">3280
</span><span class="lnt">3281
</span><span class="lnt">3282
</span><span class="lnt">3283
</span><span class="lnt">3284
</span><span class="lnt">3285
</span><span class="lnt">3286
</span><span class="lnt">3287
</span><span class="lnt">3288
</span><span class="lnt">3289
</span><span class="lnt">3290
</span><span class="lnt">3291
</span><span class="lnt">3292
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// One round of scheduler: find a runnable goroutine and execute it.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Never returns.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">schedule</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å–å½“å‰æ­£åœ¨è¿è¡Œçš„gï¼Œæ‰§è¡Œè¯¥å‡½æ•°æ—¶ä¸€èˆ¬éƒ½æ˜¯ç³»ç»Ÿæ ˆg0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// _g_ = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒåº¦å¼€å§‹æ—¶ g0.m.locks = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ ¡éªŒå½“å‰çº¿ç¨‹æ²¡æœ‰é”ï¼Œä¸å…è®¸å†æŒæœ‰é”çš„æƒ…å†µä¸‹è¿›è¡Œè°ƒåº¦ï¼Œä»¥å…é€ æˆruntimeå†…éƒ¨é”™è¯¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› ä¸ºm.locksçš„åŠ é”å’Œè§£é”æ—¶æˆå¯¹å‡ºç°çš„ï¼Œå› æ­¤è¿™é‡Œåº”è¯¥ä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">locks</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;schedule: holding locks&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// g0.m.lockedg = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åˆ¤æ–­å½“å‰Mæœ‰æ²¡æœ‰å’ŒGç»‘å®šï¼Œå¦‚æœæœ‰ï¼Œè¿™ä¸ªMå°±ä¸èƒ½ç”¨æ¥æ‰§è¡Œå…¶ä»–çš„Gäº†,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åªèƒ½æŒ‚èµ·ç­‰å¾…ç»‘å®šçš„Gå¾—åˆ°è°ƒåº¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">lockedg</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">stoplockedm</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nf">execute</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">lockedg</span><span class="p">.</span><span class="nf">ptr</span><span class="p">(),</span> <span class="kc">false</span><span class="p">)</span> <span class="c1">// Never returns.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// We should not schedule away from a g that is executing a cgo call,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// since the cgo call is using the m&#39;s g0 stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æˆ‘ä»¬ä¸åº”è¯¥å®‰æ’è¿œç¦»æ­£åœ¨æ‰§è¡Œ cgo è°ƒç”¨çš„ gï¼Œå› ä¸º cgo è°ƒç”¨æ­£åœ¨ä½¿ç”¨ m çš„ g0 å †æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åˆ¤æ–­çº¿ç¨‹æ˜¯ä¸æ˜¯æ­£åœ¨è¿›è¡Œcgoå‡½æ•°è°ƒç”¨ï¼Œè¿™ç§æƒ…å†µä¸‹g0æ ˆæ­£åœ¨è¢«cgoä½¿ç”¨ï¼Œæ‰€ä»¥ä¹Ÿä¸å…è®¸è°ƒåº¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">incgo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;schedule: in cgo&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">top</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pp</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span> <span class="c1">// pp = p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é€šè¿‡æŠŠpreemptå­—æ®µè®¾ç½®ä¸ºfalseï¼Œæ¥ç¦æ­¢å¯¹Pçš„æŠ¢å ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">pp</span><span class="p">.</span><span class="nx">preempt</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Safety check: if we are spinning, the run queue should be empty.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Check this before calling checkTimers, as that might call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// goready to put a ready goroutine on the local run queue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å®‰å…¨æ£€æŸ¥ï¼šå¦‚æœæˆ‘ä»¬æ­£åœ¨è‡ªæ—‹ï¼Œé‚£ä¹ˆè¿è¡Œé˜Ÿåˆ—åº”è¯¥æ˜¯ç©ºçš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨è°ƒç”¨checkTimersä¹‹å‰è¯·æ£€æŸ¥è¿™ä¸€ç‚¹ï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šè°ƒç”¨goreadyå°†å‡†å¤‡å¥½çš„goroutineæ”¾å…¥æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯¹ spinning çš„åˆ¤æ–­å±äºä¸€è‡´æ€§æ£€éªŒï¼Œåœ¨Pæœ¬åœ°runqæœ‰ä»»åŠ¡çš„æƒ…å†µä¸‹ï¼ŒMä¸åº”è¯¥å¤„äºspinningçŠ¶æ€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">spinning</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">pp</span><span class="p">.</span><span class="nx">runnext</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">pp</span><span class="p">.</span><span class="nx">runqhead</span> <span class="o">!=</span> <span class="nx">pp</span><span class="p">.</span><span class="nx">runqtail</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;schedule: spinning with local work&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¯»æ‰¾ä¸€ä¸ªå¯ç”¨çš„ goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// inheritTimeï¼šæ˜¯å¦ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. true  ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. false ä¸ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// tryWakePï¼šå½“å‰goroutineæ˜¯å¦æ˜¯æ™®é€šçš„ã€‚ä¹Ÿå°±æ˜¯user goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. false æ™®é€šçš„goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. true  ä¸æ˜¯æ™®é€šçš„goroutineï¼Œå¯èƒ½æ˜¯GC workã€trace readeréœ€è¦å”¤é†’Pã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// gpï¼šå½“å‰æ‰¾åˆ°çš„ goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">,</span> <span class="nx">inheritTime</span><span class="p">,</span> <span class="nx">tryWakeP</span> <span class="o">:=</span> <span class="nf">findRunnable</span><span class="p">()</span> <span class="c1">// blocks until work is available
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// This thread is going to run a goroutine and is not spinning anymore,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// so if it was marked as spinning we need to reset it now and potentially
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// start a new spinning M.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™ä¸ªçº¿ç¨‹å°†è¿è¡Œä¸€ä¸ªgoroutineï¼Œä¸å†æ—‹è½¬ï¼Œæ‰€ä»¥å¦‚æœå®ƒè¢«æ ‡è®°ä¸ºæ—‹è½¬ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æˆ‘ä»¬ç°åœ¨éœ€è¦é‡ç½®å®ƒï¼Œå¹¶å¯èƒ½å¯åŠ¨ä¸€ä¸ªæ–°çš„æ—‹è½¬Mã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">spinning</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// é‡ç½®å½“å‰Mä½éæ—‹è½¬ï¼Œå¹¶å°è¯•é‡æ–°å¯åŠ¨ä¸€ä¸ªPæ ‡è®°ä¸ºæ—‹è½¬ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">resetspinning</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// sched.disable.userï¼šç¦æ­¢è°ƒåº¦ç”¨æˆ·goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// !schedEnabled(gp)ï¼šgpæ˜¯user goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯èƒ½æ¥è‡ªGCï¼Œå…¶ä¸­ä¸¤ç§æ¨¡å¼ä¸å…è®¸GCæœŸé—´è¿è¡Œuser goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">disable</span><span class="p">.</span><span class="nx">user</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nf">schedEnabled</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Scheduling of this goroutine is disabled. Put it on
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// the list of pending runnable goroutines for when we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// re-enable user scheduling and look again.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ­¤goroutineçš„è°ƒåº¦è¢«ç¦ç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å½“æˆ‘ä»¬é‡æ–°å¯ç”¨ç”¨æˆ·è°ƒåº¦å¹¶å†æ¬¡æŸ¥çœ‹æ—¶ï¼Œå°†å®ƒæ”¾åœ¨æŒ‚èµ·çš„å¯è¿è¡Œgoroutineåˆ—è¡¨ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nf">schedEnabled</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Something re-enabled scheduling while we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// were acquiring the lock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// user goroutine æ—¶æŒ‚èµ·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">sched</span><span class="p">.</span><span class="nx">disable</span><span class="p">.</span><span class="nx">runnable</span><span class="p">.</span><span class="nf">pushBack</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sched</span><span class="p">.</span><span class="nx">disable</span><span class="p">.</span><span class="nx">n</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">            <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="nx">top</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// If about to schedule a not-normal goroutine (a GCworker or tracereader),
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// wake a P if there is one.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœè¦è°ƒåº¦ä¸€ä¸ªä¸æ­£å¸¸çš„goroutine (GCworkeræˆ–tracereader)ï¼Œå¦‚æœæœ‰Pï¼Œåˆ™å”¤é†’Pã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å°è¯•æ¢æ–°ä¸€ä¸ªæ–°çº¿ç¨‹ç»‘å®šPæ¥å·¥ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">tryWakeP</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">wakep</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">lockedm</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Hands off own p to the locked m,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// then blocks waiting for a new p.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æŠŠè‡ªå·±çš„päº¤ç»™é”ä½çš„mï¼Œç„¶åblockç­‰å¾…ä¸€ä¸ªæ–°çš„pã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">startlockedm</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="nx">top</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">execute</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">inheritTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="findrunnable">findRunnable()ğŸš€<a hidden class="anchor" aria-hidden="true" href="#findrunnable">#</a></h3>
<ol>
<li>æŸ¥æ‰¾è¦æ‰§è¡Œçš„å¯è¿è¡Œ<code>goroutine</code>ã€‚è¯•å›¾ä»å…¶ä»–<code>P</code>ä¸­çªƒå–ï¼Œä»æœ¬åœ°æˆ–å…¨å±€é˜Ÿåˆ—ã€è½®è¯¢ç½‘ç»œä¸­è·å–gã€‚</li>
<li><code>tryWakeP</code>è¡¨ç¤ºè¿”å›çš„ä¸æ˜¯æ™®é€šçš„<code>goroutine</code>ï¼ˆ<code>GC</code>å·¥ä½œç¨‹åºã€è·Ÿè¸ªè¯»å–å™¨ï¼‰ï¼Œå› æ­¤è°ƒç”¨è€…åº”è¯¥å°è¯•å”¤é†’<code>P</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2651
</span><span class="lnt">2652
</span><span class="lnt">2653
</span><span class="lnt">2654
</span><span class="lnt">2655
</span><span class="lnt">2656
</span><span class="lnt">2657
</span><span class="lnt">2658
</span><span class="lnt">2659
</span><span class="lnt">2660
</span><span class="lnt">2661
</span><span class="lnt">2662
</span><span class="lnt">2663
</span><span class="lnt">2664
</span><span class="lnt">2665
</span><span class="lnt">2666
</span><span class="lnt">2667
</span><span class="lnt">2668
</span><span class="lnt">2669
</span><span class="lnt">2670
</span><span class="lnt">2671
</span><span class="lnt">2672
</span><span class="lnt">2673
</span><span class="lnt">2674
</span><span class="lnt">2675
</span><span class="lnt">2676
</span><span class="lnt">2677
</span><span class="lnt">2678
</span><span class="lnt">2679
</span><span class="lnt">2680
</span><span class="lnt">2681
</span><span class="lnt">2682
</span><span class="lnt">2683
</span><span class="lnt">2684
</span><span class="lnt">2685
</span><span class="lnt">2686
</span><span class="lnt">2687
</span><span class="lnt">2688
</span><span class="lnt">2689
</span><span class="lnt">2690
</span><span class="lnt">2691
</span><span class="lnt">2692
</span><span class="lnt">2693
</span><span class="lnt">2694
</span><span class="lnt">2695
</span><span class="lnt">2696
</span><span class="lnt">2697
</span><span class="lnt">2698
</span><span class="lnt">2699
</span><span class="lnt">2700
</span><span class="lnt">2701
</span><span class="lnt">2702
</span><span class="lnt">2703
</span><span class="lnt">2704
</span><span class="lnt">2705
</span><span class="lnt">2706
</span><span class="lnt">2707
</span><span class="lnt">2708
</span><span class="lnt">2709
</span><span class="lnt">2710
</span><span class="lnt">2711
</span><span class="lnt">2712
</span><span class="lnt">2713
</span><span class="lnt">2714
</span><span class="lnt">2715
</span><span class="lnt">2716
</span><span class="lnt">2717
</span><span class="lnt">2718
</span><span class="lnt">2719
</span><span class="lnt">2720
</span><span class="lnt">2721
</span><span class="lnt">2722
</span><span class="lnt">2723
</span><span class="lnt">2724
</span><span class="lnt">2725
</span><span class="lnt">2726
</span><span class="lnt">2727
</span><span class="lnt">2728
</span><span class="lnt">2729
</span><span class="lnt">2730
</span><span class="lnt">2731
</span><span class="lnt">2732
</span><span class="lnt">2733
</span><span class="lnt">2734
</span><span class="lnt">2735
</span><span class="lnt">2736
</span><span class="lnt">2737
</span><span class="lnt">2738
</span><span class="lnt">2739
</span><span class="lnt">2740
</span><span class="lnt">2741
</span><span class="lnt">2742
</span><span class="lnt">2743
</span><span class="lnt">2744
</span><span class="lnt">2745
</span><span class="lnt">2746
</span><span class="lnt">2747
</span><span class="lnt">2748
</span><span class="lnt">2749
</span><span class="lnt">2750
</span><span class="lnt">2751
</span><span class="lnt">2752
</span><span class="lnt">2753
</span><span class="lnt">2754
</span><span class="lnt">2755
</span><span class="lnt">2756
</span><span class="lnt">2757
</span><span class="lnt">2758
</span><span class="lnt">2759
</span><span class="lnt">2760
</span><span class="lnt">2761
</span><span class="lnt">2762
</span><span class="lnt">2763
</span><span class="lnt">2764
</span><span class="lnt">2765
</span><span class="lnt">2766
</span><span class="lnt">2767
</span><span class="lnt">2768
</span><span class="lnt">2769
</span><span class="lnt">2770
</span><span class="lnt">2771
</span><span class="lnt">2772
</span><span class="lnt">2773
</span><span class="lnt">2774
</span><span class="lnt">2775
</span><span class="lnt">2776
</span><span class="lnt">2777
</span><span class="lnt">2778
</span><span class="lnt">2779
</span><span class="lnt">2780
</span><span class="lnt">2781
</span><span class="lnt">2782
</span><span class="lnt">2783
</span><span class="lnt">2784
</span><span class="lnt">2785
</span><span class="lnt">2786
</span><span class="lnt">2787
</span><span class="lnt">2788
</span><span class="lnt">2789
</span><span class="lnt">2790
</span><span class="lnt">2791
</span><span class="lnt">2792
</span><span class="lnt">2793
</span><span class="lnt">2794
</span><span class="lnt">2795
</span><span class="lnt">2796
</span><span class="lnt">2797
</span><span class="lnt">2798
</span><span class="lnt">2799
</span><span class="lnt">2800
</span><span class="lnt">2801
</span><span class="lnt">2802
</span><span class="lnt">2803
</span><span class="lnt">2804
</span><span class="lnt">2805
</span><span class="lnt">2806
</span><span class="lnt">2807
</span><span class="lnt">2808
</span><span class="lnt">2809
</span><span class="lnt">2810
</span><span class="lnt">2811
</span><span class="lnt">2812
</span><span class="lnt">2813
</span><span class="lnt">2814
</span><span class="lnt">2815
</span><span class="lnt">2816
</span><span class="lnt">2817
</span><span class="lnt">2818
</span><span class="lnt">2819
</span><span class="lnt">2820
</span><span class="lnt">2821
</span><span class="lnt">2822
</span><span class="lnt">2823
</span><span class="lnt">2824
</span><span class="lnt">2825
</span><span class="lnt">2826
</span><span class="lnt">2827
</span><span class="lnt">2828
</span><span class="lnt">2829
</span><span class="lnt">2830
</span><span class="lnt">2831
</span><span class="lnt">2832
</span><span class="lnt">2833
</span><span class="lnt">2834
</span><span class="lnt">2835
</span><span class="lnt">2836
</span><span class="lnt">2837
</span><span class="lnt">2838
</span><span class="lnt">2839
</span><span class="lnt">2840
</span><span class="lnt">2841
</span><span class="lnt">2842
</span><span class="lnt">2843
</span><span class="lnt">2844
</span><span class="lnt">2845
</span><span class="lnt">2846
</span><span class="lnt">2847
</span><span class="lnt">2848
</span><span class="lnt">2849
</span><span class="lnt">2850
</span><span class="lnt">2851
</span><span class="lnt">2852
</span><span class="lnt">2853
</span><span class="lnt">2854
</span><span class="lnt">2855
</span><span class="lnt">2856
</span><span class="lnt">2857
</span><span class="lnt">2858
</span><span class="lnt">2859
</span><span class="lnt">2860
</span><span class="lnt">2861
</span><span class="lnt">2862
</span><span class="lnt">2863
</span><span class="lnt">2864
</span><span class="lnt">2865
</span><span class="lnt">2866
</span><span class="lnt">2867
</span><span class="lnt">2868
</span><span class="lnt">2869
</span><span class="lnt">2870
</span><span class="lnt">2871
</span><span class="lnt">2872
</span><span class="lnt">2873
</span><span class="lnt">2874
</span><span class="lnt">2875
</span><span class="lnt">2876
</span><span class="lnt">2877
</span><span class="lnt">2878
</span><span class="lnt">2879
</span><span class="lnt">2880
</span><span class="lnt">2881
</span><span class="lnt">2882
</span><span class="lnt">2883
</span><span class="lnt">2884
</span><span class="lnt">2885
</span><span class="lnt">2886
</span><span class="lnt">2887
</span><span class="lnt">2888
</span><span class="lnt">2889
</span><span class="lnt">2890
</span><span class="lnt">2891
</span><span class="lnt">2892
</span><span class="lnt">2893
</span><span class="lnt">2894
</span><span class="lnt">2895
</span><span class="lnt">2896
</span><span class="lnt">2897
</span><span class="lnt">2898
</span><span class="lnt">2899
</span><span class="lnt">2900
</span><span class="lnt">2901
</span><span class="lnt">2902
</span><span class="lnt">2903
</span><span class="lnt">2904
</span><span class="lnt">2905
</span><span class="lnt">2906
</span><span class="lnt">2907
</span><span class="lnt">2908
</span><span class="lnt">2909
</span><span class="lnt">2910
</span><span class="lnt">2911
</span><span class="lnt">2912
</span><span class="lnt">2913
</span><span class="lnt">2914
</span><span class="lnt">2915
</span><span class="lnt">2916
</span><span class="lnt">2917
</span><span class="lnt">2918
</span><span class="lnt">2919
</span><span class="lnt">2920
</span><span class="lnt">2921
</span><span class="lnt">2922
</span><span class="lnt">2923
</span><span class="lnt">2924
</span><span class="lnt">2925
</span><span class="lnt">2926
</span><span class="lnt">2927
</span><span class="lnt">2928
</span><span class="lnt">2929
</span><span class="lnt">2930
</span><span class="lnt">2931
</span><span class="lnt">2932
</span><span class="lnt">2933
</span><span class="lnt">2934
</span><span class="lnt">2935
</span><span class="lnt">2936
</span><span class="lnt">2937
</span><span class="lnt">2938
</span><span class="lnt">2939
</span><span class="lnt">2940
</span><span class="lnt">2941
</span><span class="lnt">2942
</span><span class="lnt">2943
</span><span class="lnt">2944
</span><span class="lnt">2945
</span><span class="lnt">2946
</span><span class="lnt">2947
</span><span class="lnt">2948
</span><span class="lnt">2949
</span><span class="lnt">2950
</span><span class="lnt">2951
</span><span class="lnt">2952
</span><span class="lnt">2953
</span><span class="lnt">2954
</span><span class="lnt">2955
</span><span class="lnt">2956
</span><span class="lnt">2957
</span><span class="lnt">2958
</span><span class="lnt">2959
</span><span class="lnt">2960
</span><span class="lnt">2961
</span><span class="lnt">2962
</span><span class="lnt">2963
</span><span class="lnt">2964
</span><span class="lnt">2965
</span><span class="lnt">2966
</span><span class="lnt">2967
</span><span class="lnt">2968
</span><span class="lnt">2969
</span><span class="lnt">2970
</span><span class="lnt">2971
</span><span class="lnt">2972
</span><span class="lnt">2973
</span><span class="lnt">2974
</span><span class="lnt">2975
</span><span class="lnt">2976
</span><span class="lnt">2977
</span><span class="lnt">2978
</span><span class="lnt">2979
</span><span class="lnt">2980
</span><span class="lnt">2981
</span><span class="lnt">2982
</span><span class="lnt">2983
</span><span class="lnt">2984
</span><span class="lnt">2985
</span><span class="lnt">2986
</span><span class="lnt">2987
</span><span class="lnt">2988
</span><span class="lnt">2989
</span><span class="lnt">2990
</span><span class="lnt">2991
</span><span class="lnt">2992
</span><span class="lnt">2993
</span><span class="lnt">2994
</span><span class="lnt">2995
</span><span class="lnt">2996
</span><span class="lnt">2997
</span><span class="lnt">2998
</span><span class="lnt">2999
</span><span class="lnt">3000
</span><span class="lnt">3001
</span><span class="lnt">3002
</span><span class="lnt">3003
</span><span class="lnt">3004
</span><span class="lnt">3005
</span><span class="lnt">3006
</span><span class="lnt">3007
</span><span class="lnt">3008
</span><span class="lnt">3009
</span><span class="lnt">3010
</span><span class="lnt">3011
</span><span class="lnt">3012
</span><span class="lnt">3013
</span><span class="lnt">3014
</span><span class="lnt">3015
</span><span class="lnt">3016
</span><span class="lnt">3017
</span><span class="lnt">3018
</span><span class="lnt">3019
</span><span class="lnt">3020
</span><span class="lnt">3021
</span><span class="lnt">3022
</span><span class="lnt">3023
</span><span class="lnt">3024
</span><span class="lnt">3025
</span><span class="lnt">3026
</span><span class="lnt">3027
</span><span class="lnt">3028
</span><span class="lnt">3029
</span><span class="lnt">3030
</span><span class="lnt">3031
</span><span class="lnt">3032
</span><span class="lnt">3033
</span><span class="lnt">3034
</span><span class="lnt">3035
</span><span class="lnt">3036
</span><span class="lnt">3037
</span><span class="lnt">3038
</span><span class="lnt">3039
</span><span class="lnt">3040
</span><span class="lnt">3041
</span><span class="lnt">3042
</span><span class="lnt">3043
</span><span class="lnt">3044
</span><span class="lnt">3045
</span><span class="lnt">3046
</span><span class="lnt">3047
</span><span class="lnt">3048
</span><span class="lnt">3049
</span><span class="lnt">3050
</span><span class="lnt">3051
</span><span class="lnt">3052
</span><span class="lnt">3053
</span><span class="lnt">3054
</span><span class="lnt">3055
</span><span class="lnt">3056
</span><span class="lnt">3057
</span><span class="lnt">3058
</span><span class="lnt">3059
</span><span class="lnt">3060
</span><span class="lnt">3061
</span><span class="lnt">3062
</span><span class="lnt">3063
</span><span class="lnt">3064
</span><span class="lnt">3065
</span><span class="lnt">3066
</span><span class="lnt">3067
</span><span class="lnt">3068
</span><span class="lnt">3069
</span><span class="lnt">3070
</span><span class="lnt">3071
</span><span class="lnt">3072
</span><span class="lnt">3073
</span><span class="lnt">3074
</span><span class="lnt">3075
</span><span class="lnt">3076
</span><span class="lnt">3077
</span><span class="lnt">3078
</span><span class="lnt">3079
</span><span class="lnt">3080
</span><span class="lnt">3081
</span><span class="lnt">3082
</span><span class="lnt">3083
</span><span class="lnt">3084
</span><span class="lnt">3085
</span><span class="lnt">3086
</span><span class="lnt">3087
</span><span class="lnt">3088
</span><span class="lnt">3089
</span><span class="lnt">3090
</span><span class="lnt">3091
</span><span class="lnt">3092
</span><span class="lnt">3093
</span><span class="lnt">3094
</span><span class="lnt">3095
</span><span class="lnt">3096
</span><span class="lnt">3097
</span><span class="lnt">3098
</span><span class="lnt">3099
</span><span class="lnt">3100
</span><span class="lnt">3101
</span><span class="lnt">3102
</span><span class="lnt">3103
</span><span class="lnt">3104
</span><span class="lnt">3105
</span><span class="lnt">3106
</span><span class="lnt">3107
</span><span class="lnt">3108
</span><span class="lnt">3109
</span><span class="lnt">3110
</span><span class="lnt">3111
</span><span class="lnt">3112
</span><span class="lnt">3113
</span><span class="lnt">3114
</span><span class="lnt">3115
</span><span class="lnt">3116
</span><span class="lnt">3117
</span><span class="lnt">3118
</span><span class="lnt">3119
</span><span class="lnt">3120
</span><span class="lnt">3121
</span><span class="lnt">3122
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Finds a runnable goroutine to execute.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Tries to steal from other P&#39;s, get g from local or global queue, poll network.
</span></span></span><span class="line"><span class="cl"><span class="c1">// tryWakeP indicates that the returned goroutine is not normal (GC worker, trace
</span></span></span><span class="line"><span class="cl"><span class="c1">// reader) so the caller should try to wake a P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">findRunnable</span><span class="p">()</span> <span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">inheritTime</span><span class="p">,</span> <span class="nx">tryWakeP</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// _g_ = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The conditions here and in handoffp must agree: if
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// findrunnable would return a G to run, handoffp must start
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// an M.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œå’Œhandoffpä¸­çš„æ¡ä»¶å¿…é¡»ä¸€è‡´ï¼šå¦‚æœfindrunnableå°†è¿”å›ä¸€ä¸ªGæ¥è¿è¡Œï¼Œåˆ™handoffpå¿…é¡»å¯åŠ¨ä¸€ä¸ªMã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nx">top</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_p_</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span> <span class="c1">// _p_ = p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) å¸®åŠ©STWï¼ŒæŠ¢å å½“å‰Pã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// STW å³å°†å¼€å§‹è¦æ±‚ç­‰å¾…ï¼ŒæŒ‚èµ·å½“å‰Mã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ£€æµ‹sched.gcwaitingï¼ŒæŒ‚èµ·è‡ªå·±ï¼Œä»¥ä¾¿åŠæ—¶å“åº”STWï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è°ƒåº¦é€»è¾‘ä¸­å¾ˆå¤šåœ°æ–¹éƒ½æœ‰å¯¹gcwaitingçš„æ£€æµ‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">gcwaiting</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// åœ¨GCçš„STWæœŸé—´è¢«è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">gcstopm</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="nx">top</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 2) æ£€æŸ¥å½“å‰Pæ˜¯å¦åˆ°è¾¾å®‰å…¨ç‚¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœå½“å‰Pè¦æ±‚è¿è¡Œ runSafePointFn() å‡½æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// runSafePointFn() å‡½æ•°è¢«GCç”¨æ¥åœ¨å®‰å…¨ç‚¹æ‰§è¡Œæ¸…ç©ºå·¥ä½œé˜Ÿåˆ—ä¹‹ç±»çš„æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runSafePointFn</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">runSafePointFn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3) å» timers é‡Œçœ‹çœ‹ï¼Œæ˜¯å¦æœ‰åˆ°ç‚¹çš„å®šæ—¶å™¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œå¦‚æœæœ‰ timer åˆ°è§¦å‘ç‚¹äº†ï¼Œä¼šè§¦å‘å¹¶æ‰§è¡Œæ³¨å†Œå‡½æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç”±äºè°ƒåº¦å¾ªç¯æ˜¯ä»¥æ—¶é—´ç‰‡å½¢å¼è°ƒåº¦çš„ï¼Œå› æ­¤ timer çš„è§¦å‘æ—¶é—´ä¸Šçº¿å°±æ˜¯10msã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› æ­¤æŠ¢å èƒ½æŠ¢å è¶…è¿‡10msä»¥ä¸Šçš„goroutine?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// checkTimers ä¸ºå‡†å¤‡å¥½çš„ P è¿è¡Œä»»ä½•timers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœ now ä¸ä¸º 0ï¼Œåˆ™ä¸ºå½“å‰æ—¶é—´ï¼Œå¦‚æœ now è¢«ä¼ é€’ä¸º 0ï¼Œåˆ™è¿”å›ä¼ é€’çš„æ—¶é—´æˆ–å½“å‰æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä»¥åŠä¸‹ä¸€ä¸ªtimeråº”è¯¥è¿è¡Œçš„æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰ä¸‹ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œåˆ™ä¸º 0ï¼Œå¹¶æŠ¥å‘Šå®ƒæ˜¯å¦è¿è¡Œäº†ä»»ä½•è®¡æ—¶å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœä¸‹ä¸€ä¸ªtimeråº”è¯¥è¿è¡Œçš„æ—¶é—´ä¸ä¸º0ï¼Œå®ƒæ€»æ˜¯å¤§äºè¿”å›çš„æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// func checkTimers(pp *p, now int64) (rnow, pollUntil int64, ran bool)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  å‚æ•°ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    1. pp *p      å½“å‰éœ€è¦æ£€æŸ¥çš„P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    2. now int64  å½“å‰æ—¶é—´ï¼Œå¦‚æœä¸º0åˆ™å–å½“å‰æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  è¿”å›å€¼ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    1. rnow int64ï¼šå‚æ•°nowçš„æ—¶é—´ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    2. pollUntil int64ï¼š&gt;0.æœ€è¿‘timerè§¦å‘çš„æ—¶é—´ç‚¹ã€‚0.æ²¡æœ‰ä»»ä½•timerã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    3. ran bool   timeré‡Œé¢æ˜¯å¦å­˜åœ¨å·²ç»å»¶è¿Ÿæ—¶é—´åˆ°ç‚¹çš„gï¼Œtrueå­˜åœ¨ï¼Œfalseä¸å­˜åœ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// now and pollUntil are saved for work stealing later,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// which may steal timers. It&#39;s important that between now
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// and then, nothing blocks, so these numbers remain mostly
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// relevant.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// nowå’ŒpollUntilè¢«ä¿å­˜ä»¥å¤‡ä»¥åçªƒå–å·¥ä½œï¼Œè¿™å¯èƒ½ä¼šçªƒå–timersã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é‡è¦çš„æ˜¯ï¼Œä»ç°åœ¨åˆ°é‚£æ—¶ï¼Œæ²¡æœ‰ä»»ä½•é˜»ç¢ï¼Œæ‰€ä»¥è¿™äº›æ•°å­—ä»ç„¶å¾ˆé‡è¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¤„ç†å½“å‰Pç›¸å…³çš„timersï¼Œå¯èƒ½å­˜åœ¨ä¸€äº›åœ¨timerä¸­çš„gåˆ°æ—¶é—´ç‚¹äº†éœ€è¦æ”¾å›Pä¸­ç­‰å¾…è¢«æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">now</span><span class="p">,</span> <span class="nx">pollUntil</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nf">checkTimers</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 4) å°è¯•å®‰æ’ trace readerã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Try to schedule the trace reader.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å°è¯•å®‰æ’ trace readerã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">||</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">shutdown</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span> <span class="p">=</span> <span class="nf">traceReader</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">gp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Gwaiting</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">traceGoUnpark</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">gp</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 5) å†™æ ‡è®°æœŸé—´ï¼Œå°è¯•å®‰æ’ GC workerã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Try to schedule a GC worker.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å°è¯•å®‰æ’ GC workerã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gcBlackenEnabled</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// åœ¨GCã€å¹¶å‘æ ‡è®°ã€‘æœŸé—´è¢«è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å”¤é†’æ ‡è®°åç¨‹ï¼Œå‚çœ‹GCæ–‡æ¡£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">gp</span><span class="p">,</span> <span class="nx">now</span> <span class="p">=</span> <span class="nx">gcController</span><span class="p">.</span><span class="nf">findRunnableGCWorker</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">now</span><span class="p">)</span> <span class="c1">// è·å–åˆ°æ ‡è®°åç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">gp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">gp</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">true</span> <span class="c1">// è¿”å›æ ‡è®°åç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 6) Pè°ƒåº¦æ¬¡æ•°æ¯æ»¡61æ¬¡éœ€è¦å»å…¨å±€é˜Ÿåˆ—æ‹¿å»goroutineï¼Œé˜²æ­¢å…¨å±€goroutineä¸€ç›´å¾—ä¸åˆ°è¿è¡Œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Check the global runnable queue once in a while to ensure fairness.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Otherwise two goroutines can completely occupy the local runqueue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// by constantly respawning each other.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¶å°”æ£€æŸ¥ä¸€æ¬¡å…¨å±€å¯è¿è¡Œé˜Ÿåˆ—ä»¥ç¡®ä¿å…¬å¹³æ€§ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦åˆ™ï¼Œä¸¤ä¸ªgoroutineå¯ä»¥é€šè¿‡ä¸æ–­åœ°ç›¸äº’é‡æ–°éƒ¨ç½²æ¥å®Œå…¨å æ®æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸ºäº†ä¿è¯è°ƒåº¦çš„å…¬å¹³æ€§ï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹æ¯è¿›è¡Œ61æ¬¡è°ƒåº¦å°±éœ€è¦ä¼˜å…ˆä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­è·å–goroutineå‡ºæ¥è¿è¡Œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› ä¸ºå¦‚æœåªè°ƒåº¦æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­çš„goroutineï¼Œåˆ™å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­çš„goroutineæœ‰å¯èƒ½å¾—ä¸åˆ°è¿è¡Œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// p.schedtickï¼šè®°å½•è°ƒåº¦å‘ç”Ÿçš„æ¬¡æ•°ï¼Œå®é™…ä¸Šåœ¨æ¯å‘ç”Ÿä¸€æ¬¡goroutineåˆ‡æ¢ä¸”ä¸ç»§æ‰¿æ—¶é—´ç‰‡çš„æƒ…å†µä¸‹ï¼Œè¯¥å­—æ®µä¼šåŠ ä¸€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sched.runqsizeï¼šè®°å½•çš„æ˜¯å…¨å±€å°±ç»ªé˜Ÿåˆ—çš„é•¿åº¦ã€‚ä¹Ÿå°±æ˜¯å…¨å±€é˜Ÿåˆ—goroutineçš„ä¸ªæ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">schedtick</span><span class="o">%</span><span class="mi">61</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">runqsize</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>        <span class="c1">// ä»schedä¸­è·å–goroutineéœ€è¦æŒæœ‰locké”ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä»å…¨å±€é˜Ÿåˆ—ä¸­è·å–1ä¸ªgoroutineï¼Œç„¶åæ”¾å…¥Pçš„æœ¬åœ°é˜Ÿåˆ—ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">gp</span> <span class="p">=</span> <span class="nf">globrunqget</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// åªæ‹¿å–ä¸€ä¸ª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>      <span class="c1">// mutex è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">gp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">gp</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 7) æ˜¯å¦æœ‰ finalizer Gã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Wake up the finalizer G.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å”¤é†’ finalizer Gã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¯¥goroutineç”±runtime.SetFinalizerå‡½æ•°åˆ›é€ ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åªä¼šåˆ›å»ºä¸€ä¸ªgoroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">fingwait</span> <span class="o">&amp;&amp;</span> <span class="nx">fingwake</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">wakefing</span><span class="p">();</span> <span class="nx">gp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">ready</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">*</span><span class="nx">cgo_yield</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">asmcgocall</span><span class="p">(</span><span class="o">*</span><span class="nx">cgo_yield</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 8) ä»Pçš„æœ¬åœ°é˜Ÿåˆ—æ‹¿å» goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// local runq
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä»æœ¬åœ°Pçš„é˜Ÿåˆ—ä¸­è·å–goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">inheritTime</span> <span class="o">:=</span> <span class="nf">runqget</span><span class="p">(</span><span class="nx">_p_</span><span class="p">);</span> <span class="nx">gp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">inheritTime</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 9) ä»å…¨å±€é˜Ÿåˆ—ä¸­æ‹¿å»goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// global runq
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä»å…¨å±€é˜Ÿåˆ—ä¸­è·å–goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">runqsize</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">globrunqget</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// æ‹¿å–å¤šä¸ª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">gp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">gp</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 10) netpoll æ˜¯å¦æœ‰å°±ç»ªçš„goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Poll network.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This netpoll is only an optimization before we resort to stealing.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// We can safely skip it if there are no waiters or a thread is blocked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// in netpoll already. If there is any kind of logical race with that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// blocked thread (e.g. it has already returned from netpoll, but does
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// not set lastpoll yet), this thread will do blocking netpoll below
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// anyway.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// netpollinited()ï¼šåˆ¤æ–­netpollæ˜¯å¦å·²ç»åˆå§‹åŒ–ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// netpollWaitersï¼šæ˜¯å¦æœ‰ç­‰å¾…çš„goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sched.lastpollï¼šä¸Šæ¬¡ç½‘ç»œè½®è¯¢çš„æ—¶é—´ç‚¹ã€‚ä¸º0æ—¶è¡¨ç¤ºæœ‰çº¿ç¨‹æ­£åœ¨é˜»å¡å¼è°ƒç”¨netpollå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">netpollinited</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">netpollWaiters</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lastpoll</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// netpoll(0)ï¼šåˆ¤æ–­å½“å‰æ˜¯å¦æœ‰å°±ç»ªäº‹ä»¶ï¼Œ0è¡¨ç¤ºç«‹å³è¿”å›ã€‚éé˜»å¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">list</span> <span class="o">:=</span> <span class="nf">netpoll</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="p">!</span><span class="nx">list</span><span class="p">.</span><span class="nf">empty</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// non-blocking
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">list</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span> <span class="c1">// å¼¹å‡ºä¸€ä¸ªgoroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">injectglist</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">list</span><span class="p">)</span> <span class="c1">// å¤„ç†å‰©ä¸‹çš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Gwaiting</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span> <span class="c1">// ä¿®æ”¹goroutineçŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">traceGoUnpark</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">gp</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 11) ä»¥ä¸Šéƒ½æ²¡è·å–åˆ°goroutineã€‚æ ‡è®°è‡ªæ—‹å°è¯•ä»å…¶ä»–Pä¸­å·å–goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Spinning Ms: steal work from other Ps.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Limit the number of spinning Ms to half the number of busy Ps.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This is necessary to prevent excessive CPU consumption when
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// GOMAXPROCS&gt;&gt;1 but the program parallelism is low.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Spinning Ms:ä»å…¶ä»–Pé‚£é‡Œçªƒå–goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å°†è‡ªæ—‹çš„Mé™åˆ¶ä¸ºç¹å¿™Mçš„ä¸€åŠã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™æ˜¯å¿…è¦çš„ï¼Œä»¥é˜²æ­¢åœ¨ GOMAXPROCS&gt;&gt;1 ä½†ç¨‹åºå¹¶è¡Œæ€§è¾ƒä½æ—¶è¿‡åº¦æ¶ˆè€—CPUã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœå½“å‰å¤„äºspinningçŠ¶æ€çš„Mçš„æ•°é‡å¤§äºå¿™ç¢Œçš„Pçš„æ•°é‡çš„ä¸€åŠï¼Œå°±è®©å½“å‰Mé˜»å¡(ä¼‘çœ )ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç›®çš„æ˜¯é¿å…åœ¨gomaxprocsè¾ƒå¤§è€Œç¨‹åºå®é™…çš„å¹¶å‘æ€§å¾ˆä½çš„æƒ…å†µä¸‹ï¼Œé€ æˆä¸å¿…è¦çš„CPUæ¶ˆè€—ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">procs</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">gomaxprocs</span><span class="p">)</span> <span class="c1">// è·å–å½“å‰Pçš„æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _g_.m.spinning == trueï¼šå½“å‰Må¤„äºè‡ªæ—‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2*atomic.Load(&amp;sched.nmspinning) &lt; procs-atomic.Load(&amp;sched.npidle)ï¼šè‡ªæ—‹æ˜¯ç¹å¿™çš„ä¸€åŠè¿˜å°æ—¶ï¼Œæ ‡è®°å½“å‰Mä¸ºè‡ªæ—‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">spinning</span> <span class="o">||</span> <span class="mi">2</span><span class="o">*</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">)</span> <span class="p">&lt;</span> <span class="nx">procs</span><span class="o">-</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">npidle</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">spinning</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æ»¡è¶³å·å–çš„æ—¶å€™æ‰ä¼šæ ‡è®°Mä¸ºè‡ªæ—‹çŠ¶æ€            
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">spinning</span> <span class="p">=</span> <span class="kc">true</span> <span class="c1">// æ ‡è®°ä¸ºè‡ªæ—‹çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// ç´¯åŠ è‡ªæ—‹Mçš„æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// å»å…¶ä»–Pä¸­å·å– goroutineã€‚å·å–å…¶ä»–Pä¸­goroutineçš„ä¸€åŠã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä»p.runnextä¸­å·å–çš„goroutineæ—¶ï¼ŒinheritTimeè¯¥å€¼ä¸ºtrueï¼Œè¡¨ç¤ºç»§æ‰¿ä¸Šä¸ªæ—¶é—´ç‰‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">gp</span><span class="p">,</span> <span class="nx">inheritTime</span><span class="p">,</span> <span class="nx">tnow</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">newWork</span> <span class="o">:=</span> <span class="nf">stealWork</span><span class="p">(</span><span class="nx">now</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">now</span> <span class="p">=</span> <span class="nx">tnow</span> <span class="c1">// æ›´æ–°å½“å‰æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æˆåŠŸå·å–åˆ°goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">gp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Successfully stole.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">inheritTime</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// newWork æŸä¸ªPä¸­æœ‰timerè¢«è§¦å‘äº†ï¼Œåœ¨æ¥ä¸€æ¬¡è°ƒåº¦å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">newWork</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// There may be new timer or GC work; restart to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// discover.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">goto</span> <span class="nx">top</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// wä¸ä¸º0ï¼Œè¡¨ç¤ºæœ€è¿‘è§¦å‘çš„timerçš„æ—¶é—´ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">w</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">pollUntil</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">w</span> <span class="p">&lt;</span> <span class="nx">pollUntil</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Earlier timer to wait for.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">pollUntil</span> <span class="p">=</span> <span class="nx">w</span> <span class="c1">// è®°å½•æœ€è¿‘è¦è§¦å‘çš„æ—¶é—´ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 12) æœ‰GCæ ‡è®°å·¥ä½œè¿™å»å¸®åŠ©GC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// We have nothing to do.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// If we&#39;re in the GC mark phase, can safely scan and blacken objects,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// and have work to do, run idle-time marking rather than give up the P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æˆ‘ä»¬æ— äº‹å¯åšã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœæˆ‘ä»¬åœ¨GCæ ‡è®°é˜¶æ®µï¼Œå¯ä»¥å®‰å…¨åœ°æ‰«æå’Œå˜é»‘å¯¹è±¡ï¼Œå¹¶ä¸”æœ‰å·¥ä½œè¦åšï¼Œè¿è¡Œç©ºé—²æ—¶é—´æ ‡è®°è€Œä¸æ˜¯æ”¾å¼ƒPã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gcBlackenEnabled</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nf">gcMarkWorkAvailable</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">gcController</span><span class="p">.</span><span class="nf">addIdleMarkWorker</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">node</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">gcBgMarkWorkerNode</span><span class="p">)(</span><span class="nx">gcBgMarkWorkerPool</span><span class="p">.</span><span class="nf">pop</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">node</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">_p_</span><span class="p">.</span><span class="nx">gcMarkWorkerMode</span> <span class="p">=</span> <span class="nx">gcMarkWorkerIdleMode</span>
</span></span><span class="line"><span class="cl">            <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">gp</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Gwaiting</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">traceGoUnpark</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">gp</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gcController</span><span class="p">.</span><span class="nf">removeIdleMarkWorker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// wasm only:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// If a callback returned and no other goroutine is awake,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// then wake event handler goroutine which pauses execution
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// until a callback was triggered.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">,</span> <span class="nx">otherReady</span> <span class="o">:=</span> <span class="nf">beforeIdle</span><span class="p">(</span><span class="nx">now</span><span class="p">,</span> <span class="nx">pollUntil</span><span class="p">)</span> <span class="c1">// åœ¨linuxä¸‹è¿”å› (nil, false)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Gwaiting</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">traceGoUnpark</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">gp</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">otherReady</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="nx">top</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 13) ä¿å­˜allpã€idlepMaskå’ŒtimerpMaskçš„å¿«ç…§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰å·¥ä½œçº¿ç¨‹å³å°†ä¼‘çœ ï¼Œä¼‘çœ å‰å†æ¬¡å»å¿«ç…§é‡Œé¢çœ‹çœ‹æœ‰æ²¡æœ‰å·¥ä½œè¦åš
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Before we drop our P, make a snapshot of the allp slice,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// which can change underfoot once we no longer block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// safe-points. We don&#39;t need to snapshot the contents because
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// everything up to cap(allp) is immutable.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨æˆ‘ä»¬ä¸¢å¼ƒPä¹‹å‰ï¼Œåšä¸€ä¸ªallpåˆ‡ç‰‡çš„å¿«ç…§ï¼Œä¸€æ—¦æˆ‘ä»¬ä¸å†é˜»å¡safe-pointsï¼Œå®ƒå°±ä¼šæ”¹å˜ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æˆ‘ä»¬ä¸éœ€è¦å¯¹å†…å®¹è¿›è¡Œå¿«ç…§ï¼Œå› ä¸ºcap(allp)ä¹‹å‰çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯ä¸å¯å˜çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">allpSnapshot</span> <span class="o">:=</span> <span class="nx">allp</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Also snapshot masks. Value changes are OK, but we can&#39;t allow
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// len to change out from under us.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿˜æœ‰å¿«ç…§æ©ç ã€‚å€¼æ›´æ”¹æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸èƒ½å…è®¸lenä»æˆ‘ä»¬ä¸‹é¢æ›´æ”¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">idlepMaskSnapshot</span> <span class="o">:=</span> <span class="nx">idlepMask</span>
</span></span><span class="line"><span class="cl">    <span class="nx">timerpMaskSnapshot</span> <span class="o">:=</span> <span class="nx">timerpMask</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 14) åœ¨çœ‹ä¸€ä¸‹gcwaitingå’ŒrunSafePointFnï¼Œä»¥åŠå…¨å±€é˜Ÿåˆ—sched.runqsize
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// return P and block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æœ‰GCç­‰å¾… æˆ– Pæœ‰å®‰å…¨ç‚¹å‡½æ•°æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">gcwaiting</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runSafePointFn</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="nx">top</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å…¨å±€é˜Ÿåˆ—æœ‰ goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">runqsize</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å› ä¸º sched.lock é”å·²è¢«æŒæœ‰ï¼Œæ‰€ä»¥ä¸€å®šèƒ½å–å‡º gpã€‚ä¸ä¸º nilã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">globrunqget</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">gp</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 15) è§£é™¤å½“å‰Mä¸Pçš„ç»‘å®šå…³ç³»ï¼Œå¹¶æŠŠPåŠ å…¥å…¨å±€ç©ºé—²é˜Ÿåˆ—ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// è§£é™¤mä¸pçš„ç»‘å®šå…³ç³»ï¼Œå¹¶è®¾ç½®pä¸ºç©ºé—²çŠ¶æ€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">releasep</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">_p_</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;findrunnable: wrong p&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æŠŠPåŠ å…¥ç©ºé—²é˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">now</span> <span class="p">=</span> <span class="nf">pidleput</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">now</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 16) æ ¹æ®å‰é¢å¿«ç…§ä¿å­˜çš„ä¿¡æ¯ï¼Œå†æ¬¡æ£€æŸ¥å…¶ä»–Pæ˜¯å¦å¯å·å–ï¼ŒGCæœ‰æ²¡æ ‡è®°å·¥ä½œéœ€è¦ååŠ©ï¼Œtimeræœ‰æ²¡è§¦å‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Delicate dance: thread transitions from spinning to non-spinning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// state, potentially concurrently with submission of new work. We must
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// drop nmspinning first and then check all sources again (with
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// #StoreLoad memory barrier in between). If we do it the other way
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// around, another thread can submit work after we&#39;ve checked all
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sources but before we drop nmspinning; as a result nobody will
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// unpark a thread to run the work.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This applies to the following sources of work:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// * Goroutines added to a per-P run queue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// * New/modified-earlier timers on a per-P timer heap.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// * Idle-priority GC work (barring golang.org/issue/19112).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// If we discover new work below, we need to restore m.spinning as a signal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// for resetspinning to unpark a new worker thread (because there can be more
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// than one starving goroutine). However, if after discovering new work
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// we also observe no idle Ps it is OK to skip unparking a new worker
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// thread: the system is fully loaded so no spinning threads are required.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Also see &#34;Worker thread parking/unparking&#34; comment at the top of the file.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">wasSpinning</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">spinning</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¤„ç†å½“å‰Mæ˜¯è‡ªæ—‹çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">spinning</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">spinning</span> <span class="p">=</span> <span class="kc">false</span> <span class="c1">// æ ‡è®°å½“å‰Mæœªéè‡ªæ—‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;findrunnable: negative nmspinning&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Note the for correctness, only the last M transitioning from
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// spinning to non-spinning must perform these rechecks to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ensure no missed work. We are performing it on every M that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// transitions as a conservative change to monitor effects on
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// latency. See golang.org/issue/43997.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Check all runqueues once again.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å†æ¬¡æ£€æŸ¥æ‰€æœ‰è¿è¡Œé˜Ÿåˆ—ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ£€æŸ¥æ˜¯å¦æœ‰å¯å·å–çš„Pï¼Œå¦‚æœæœ‰åˆ™å–å‡ºä¸€ä¸ªç©ºé—²çš„Pç»‘å®šMã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_p_</span> <span class="p">=</span> <span class="nf">checkRunqsNoP</span><span class="p">(</span><span class="nx">allpSnapshot</span><span class="p">,</span> <span class="nx">idlepMaskSnapshot</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">_p_</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="c1">// ç»‘å®šP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">spinning</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">            <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="nx">top</span> <span class="c1">// æœ‰å·¥ä½œå¯åšå†è·‘ä¸€éè°ƒåº¦å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Check for idle-priority GC work again.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å†æ¬¡æ£€æŸ¥ç©ºé—²ä¼˜å…ˆçº§GCå·¥ä½œã€‚æ˜¯å¦æœ‰ç¼–è¾‘å·¥ä½œéœ€è¦åš
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_p_</span><span class="p">,</span> <span class="nx">gp</span> <span class="p">=</span> <span class="nf">checkIdleGCNoP</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">_p_</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="c1">// ç»‘å®šP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">spinning</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">            <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Run the idle worker.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">_p_</span><span class="p">.</span><span class="nx">gcMarkWorkerMode</span> <span class="p">=</span> <span class="nx">gcMarkWorkerIdleMode</span>
</span></span><span class="line"><span class="cl">            <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Gwaiting</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">traceGoUnpark</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">gp</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Finally, check for timer creation or expiry concurrently with
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// transitioning from spinning to non-spinning.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Note that we cannot use checkTimers here because it calls
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// adjusttimers which may need to allocate memory, and that isn&#39;t
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// allowed when we don&#39;t have an active P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æœ€åï¼Œå†çœ‹çœ‹timerã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">pollUntil</span> <span class="p">=</span> <span class="nf">checkTimersNoP</span><span class="p">(</span><span class="nx">allpSnapshot</span><span class="p">,</span> <span class="nx">timerpMaskSnapshot</span><span class="p">,</span> <span class="nx">pollUntil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 17) network æ˜¯å¦æœ‰éœ€è¦å¤„ç†çš„goroutineï¼Œæˆ–timeræ˜¯å¦å³å°†è§¦å‘ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ ‡è®°sched.lastpollä¸º0ï¼Œé˜»å¡å¼ç­‰å¾…å§ã€‚netpollä¸­ä¸€äº›è¯»å†™è¶…æ—¶éœ€è¦ç”¨åˆ°timer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Poll network until next timer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Poll network ç›´åˆ°ä¸‹ä¸€ä¸ª timerã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  netpollinited()ï¼šnetpoll å·²åˆå§‹åŒ–ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  netpollWaitersï¼šè®°å½•å½“å‰goroutineè¢«æŒ‚åœ¨epollä¸­çš„ç­‰å¾…æ•°é‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  pollUntilï¼š&gt;0.ä¸‹ä¸ªtimerè§¦å‘çš„è€Œæ—¶é—´ç‚¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  atomic.Xchg64(&amp;sched.lastpoll, 0)ï¼šè¿™é‡Œæ˜¯å”¯ä¸€çš„æŠŠsched.lastpollä¿®æ”¹ä¸º0çš„æƒ…å†µï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  è¡¨ç¤ºå½“å‰éœ€è¦é˜»å¡å¼çš„è°ƒç”¨netpollå‡½æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œçš„atomic.Xchg64(&amp;sched.lastpoll, 0) != 0 å…·æœ‰æ’ä»–æ€§ã€‚åªèƒ½æœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹å¤„äºé˜»å¡ç­‰å¾…ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">netpollinited</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">netpollWaiters</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">pollUntil</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xchg64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lastpoll</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// sched.pollUntil = pollUntilï¼Œé¢„è®¡çš„é˜»å¡æ—¶é—´ç‚¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">pollUntil</span><span class="p">,</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">pollUntil</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;findrunnable: netpoll with p&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">spinning</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;findrunnable: netpoll with spinning&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Refresh now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">now</span> <span class="p">=</span> <span class="nf">nanotime</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">delay</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">pollUntil</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// è®¡ç®—é¢„è®¡é˜»å¡çš„æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">delay</span> <span class="p">=</span> <span class="nx">pollUntil</span> <span class="o">-</span> <span class="nx">now</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">delay</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// è§¦å‘æ—¶é—´ä»¥è¿‡ï¼Œè¦æ±‚ç«‹å³è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">delay</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// faketimeæ˜¯è‡ª1970å¹´ä»¥æ¥æ¨¡æ‹Ÿçš„ä»¥çº³ç§’ä¸ºå•ä½çš„æ—¶é—´ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 0å€¼æ„å‘³ç€ä¸ä½¿ç”¨faketimeã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">faketime</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// When using fake time, just poll.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å½“ä½¿ç”¨ fake timeï¼Œåªæ˜¯pollã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">delay</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// é˜»å¡ç›´åˆ°æœ‰æ–°çš„workå¯ç”¨ï¼Œdelayæ˜¯ä¸€ä¸ªå…·ä½“çš„æ—¶é—´æ®µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">list</span> <span class="o">:=</span> <span class="nf">netpoll</span><span class="p">(</span><span class="nx">delay</span><span class="p">)</span> <span class="c1">// block until new work is available
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">pollUntil</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// sched.pollUntil = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lastpoll</span><span class="p">,</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">now</span><span class="p">))</span> <span class="c1">// sched.lastpoll = now
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">faketime</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">list</span><span class="p">.</span><span class="nf">empty</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Using fake time and nothing is ready; stop M.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// When all M&#39;s stop, checkdead will call timejump.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">stopm</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="nx">top</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä»ç©ºé—²Pé“¾è¡¨ä¸­è·å–ä¸€ä¸ªP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_p_</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nf">pidleget</span><span class="p">(</span><span class="nx">now</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">_p_</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æ²¡æœ‰å¯ç”¨çš„ç©ºé—²Pæ—¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦‚æœæœ‰å°±ç»ªçš„goroutineæ”¾å…¥å…¨å±€goroutineæ± ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">injectglist</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="c1">// ç»‘å®šP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">!</span><span class="nx">list</span><span class="p">.</span><span class="nf">empty</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// å–å‡ºä¸€ä¸ªgoroutineï¼Œç”¨äºè¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">list</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// å‰©ä½™çš„ä¼˜å…ˆåŠ å…¥å…¨å±€æ± ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">injectglist</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ä¿®æ”¹goroutineçŠ¶æ€ä¸ºå¾…è¿è¡ŒçŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Gwaiting</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">traceGoUnpark</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// è¿”å›æ‰¾åˆ°çš„ goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span> <span class="nx">gp</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å¦‚æœä¹‹å‰Mæ˜¯è‡ªæ—‹ï¼Œåˆ™å†æ¬¡æ ‡è®°ä¸ºè‡ªæ—‹å¹¶ä»æ–°å†æ¥ä¸€æ¬¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">wasSpinning</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">spinning</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">                <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="nx">top</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">pollUntil</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nf">netpollinited</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æœ‰å…¶ä»–çš„çº¿ç¨‹åœ¨é˜»å¡ netpollã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// sched.pollUntilï¼šä¸‹æ¬¡timeråº”è¯¥è¢«å”¤é†’æ—¶é—´ç‚¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">pollerPollUntil</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Load64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">pollUntil</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// timerè§¦å‘äº† æˆ– è§¦å‘æ—¶é—´å·²åˆ° å«é†’é˜»å¡çš„netpoll
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">pollerPollUntil</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">pollerPollUntil</span> <span class="p">&gt;</span> <span class="nx">pollUntil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">netpollBreak</span><span class="p">()</span> <span class="c1">// å«é†’epoll
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// æŒ‚èµ·å½“å‰çº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹å”¤é†’ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">stopm</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="nx">top</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="gcstopm">gcstopm()<a hidden class="anchor" aria-hidden="true" href="#gcstopm">#</a></h3>
<ol>
<li>ä¸º<code>stopTheWorld</code>åœæ­¢å½“å‰<code>M</code>ã€‚</li>
<li>å½“<code>TheWordStart</code>æ—¶è¿”å›ã€‚è¾…åŠ©<code>STW</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
<li>è¯¥æ–¹æ³•åœ¨GCå‘èµ·æ—¶ï¼Œå…¶ä»–çº¿ç¨‹éƒ½åœ¨è¿™ä¸ªæ–¹æ³•ä¸ŠæŠŠè‡ªå·±æŒ‚èµ·ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2481
</span><span class="lnt">2482
</span><span class="lnt">2483
</span><span class="lnt">2484
</span><span class="lnt">2485
</span><span class="lnt">2486
</span><span class="lnt">2487
</span><span class="lnt">2488
</span><span class="lnt">2489
</span><span class="lnt">2490
</span><span class="lnt">2491
</span><span class="lnt">2492
</span><span class="lnt">2493
</span><span class="lnt">2494
</span><span class="lnt">2495
</span><span class="lnt">2496
</span><span class="lnt">2497
</span><span class="lnt">2498
</span><span class="lnt">2499
</span><span class="lnt">2500
</span><span class="lnt">2501
</span><span class="lnt">2502
</span><span class="lnt">2503
</span><span class="lnt">2504
</span><span class="lnt">2505
</span><span class="lnt">2506
</span><span class="lnt">2507
</span><span class="lnt">2508
</span><span class="lnt">2509
</span><span class="lnt">2510
</span><span class="lnt">2511
</span><span class="lnt">2512
</span><span class="lnt">2513
</span><span class="lnt">2514
</span><span class="lnt">2515
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Stops the current m for stopTheWorld.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Returns when the world is restarted.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">gcstopm</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// _g_ = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// sched.gcwaitingï¼šæ˜¯1ï¼Œè¡¨ç¤ºå½“å‰STWæ­£åœ¨ç­‰å¾…Påœä¸‹æ¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">gcwaiting</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;gcstopm: not waiting for gc&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰Mæ­£å¤„äºè‡ªæ—‹çŠ¶æ€ä¸‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">spinning</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">spinning</span> <span class="p">=</span> <span class="kc">false</span> <span class="c1">// æ¸…é™¤è‡ªæ—‹æ ‡è®°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// OK to just drop nmspinning here,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// startTheWorld will unpark threads as necessary.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è‡ªæ—‹è®¡æ•°å‡ºç°é”™è¯¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;gcstopm: negative nmspinning&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è§£ç»‘å½“å‰Mä¸P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span> <span class="o">:=</span> <span class="nf">releasep</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _Pgcstopï¼šGCåœæ­¢çŠ¶æ€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Pè¢«STWæŒ‚èµ·ä»¥æ‰§è¡ŒGCï¼Œæ‰€æœ‰æƒå½’æ‰§è¡ŒSTWçš„Mæ‰€æœ‰ï¼Œæ‰§è¡ŒSTWçš„Mä¼šç»§ç»­ä½¿ç”¨å¤„äº_PgcstopçŠ¶æ€çš„Pã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span> <span class="p">=</span> <span class="nx">_Pgcstop</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// sched.stopwaitï¼šè®°å½•äº†STWéœ€è¦åœæ­¢çš„Pçš„æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sched</span><span class="p">.</span><span class="nx">stopwait</span><span class="o">--</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// å·²ç»åœä¸‹äº†æ‰€æœ‰çš„Pï¼Œéœ€è¦å”¤é†’åœ¨ sched.stopnote ä¸Šå‘èµ·STWçš„å·¥ä½œçº¿ç¨‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">stopwait</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">notewakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">stopnote</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">stopm</span><span class="p">()</span> <span class="c1">// åœæ­¢å½“å‰å·¥ä½œçº¿ç¨‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="releasep">releasep()<a hidden class="anchor" aria-hidden="true" href="#releasep">#</a></h4>
<ol>
<li>è§£é™¤<code>p</code>å’Œå½“å‰<code>m</code>çš„å…³è”ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">4984
</span><span class="lnt">4985
</span><span class="lnt">4986
</span><span class="lnt">4987
</span><span class="lnt">4988
</span><span class="lnt">4989
</span><span class="lnt">4990
</span><span class="lnt">4991
</span><span class="lnt">4992
</span><span class="lnt">4993
</span><span class="lnt">4994
</span><span class="lnt">4995
</span><span class="lnt">4996
</span><span class="lnt">4997
</span><span class="lnt">4998
</span><span class="lnt">4999
</span><span class="lnt">5000
</span><span class="lnt">5001
</span><span class="lnt">5002
</span><span class="lnt">5003
</span><span class="lnt">5004
</span><span class="lnt">5005
</span><span class="lnt">5006
</span><span class="lnt">5007
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Disassociate p and the current m.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">releasep</span><span class="p">()</span> <span class="o">*</span><span class="nx">p</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// _g_ = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;releasep: invalid arg&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_p_</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span> <span class="c1">// _p_ = p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _p_.m == _g_.m &amp;&amp; _p_.status == _Prunning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span> <span class="o">||</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="nx">_Prunning</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;releasep: m=&#34;</span><span class="p">,</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span> <span class="s">&#34; m-&gt;p=&#34;</span><span class="p">,</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">(),</span> <span class="s">&#34; p-&gt;m=&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">),</span> <span class="s">&#34; p-&gt;status=&#34;</span><span class="p">,</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;releasep: invalid p state&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceProcStop</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è§£é™¤ p ä¸ m ç›¸äº’ç»‘å®šçš„å…³ç³»ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _Pidleï¼šç©ºé—²çŠ¶æ€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ­¤æ—¶çš„Pæ²¡æœ‰è¢«ç”¨æ¥æ‰§è¡Œç”¨æˆ·ä»£ç æˆ–è°ƒåº¦å™¨ä»£ç ï¼Œé€šå¸¸ä½äºç©ºé—²é“¾è¡¨ä¸­ï¼Œèƒ½å¤Ÿè¢«è°ƒåº¦å™¨è·å–ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span> <span class="p">=</span> <span class="nx">_Pidle</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">_p_</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="stopm">stopm()<a hidden class="anchor" aria-hidden="true" href="#stopm">#</a></h4>
<ol>
<li>åœæ­¢æ‰§è¡Œå½“å‰<code>m</code>ï¼Œç›´åˆ°æœ‰æ–°çš„å·¥ä½œå¯ç”¨ã€‚è¿”å›è·å–çš„<code>P</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2229
</span><span class="lnt">2230
</span><span class="lnt">2231
</span><span class="lnt">2232
</span><span class="lnt">2233
</span><span class="lnt">2234
</span><span class="lnt">2235
</span><span class="lnt">2236
</span><span class="lnt">2237
</span><span class="lnt">2238
</span><span class="lnt">2239
</span><span class="lnt">2240
</span><span class="lnt">2241
</span><span class="lnt">2242
</span><span class="lnt">2243
</span><span class="lnt">2244
</span><span class="lnt">2245
</span><span class="lnt">2246
</span><span class="lnt">2247
</span><span class="lnt">2248
</span><span class="lnt">2249
</span><span class="lnt">2250
</span><span class="lnt">2251
</span><span class="lnt">2252
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Stops execution of the current m until new work is available.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Returns with acquired P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">stopm</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// _g_ = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">locks</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;stopm holding locks&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;stopm holding p&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">spinning</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;stopm spinning&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">mput</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span> <span class="c1">// æŠŠå½“å‰måŠ å…¥sched.midleä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">mPark</span><span class="p">()</span> <span class="c1">// å·¥ä½œçº¿ç¨‹sleepåœ¨m.parkä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// å·¥ä½œçº¿ç¨‹å†æ¬¡è¢«wakeupæ—¶ï¼Œç»‘å®šPã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">nextp</span><span class="p">.</span><span class="nf">ptr</span><span class="p">())</span> <span class="c1">// æ­¤å¤„pæ¥è‡ªm.nextpã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">nextp</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="mput">mput()<a hidden class="anchor" aria-hidden="true" href="#mput">#</a></h4>
<ol>
<li>æŠŠ<code>mp</code>åˆ—å…¥<code>midle</code>åˆ—è¡¨ä¸­ã€‚</li>
<li><code>sched.lock</code> å¿…é¡»è¢«æŒæœ‰ã€‚</li>
<li>å¯èƒ½åœ¨<code>STW</code>æœŸé—´è¿è¡Œï¼Œå› æ­¤ä¸å…è®¸å‡ºç°å†™å±éšœã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5533
</span><span class="lnt">5534
</span><span class="lnt">5535
</span><span class="lnt">5536
</span><span class="lnt">5537
</span><span class="lnt">5538
</span><span class="lnt">5539
</span><span class="lnt">5540
</span><span class="lnt">5541
</span><span class="lnt">5542
</span><span class="lnt">5543
</span><span class="lnt">5544
</span><span class="lnt">5545
</span><span class="lnt">5546
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Put mp on midle list.
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held.
</span></span></span><span class="line"><span class="cl"><span class="c1">// May run during STW, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mput</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æŠŠå½“å‰måŠ å…¥sched.midleã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mp</span><span class="p">.</span><span class="nx">schedlink</span> <span class="p">=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">midle</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sched</span><span class="p">.</span><span class="nx">midle</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sched</span><span class="p">.</span><span class="nx">nmidle</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="nf">checkdead</span><span class="p">()</span> <span class="c1">// æ£€æŸ¥æ­»é”ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="mpark">mPark()<a hidden class="anchor" aria-hidden="true" href="#mpark">#</a></h4>
<ol>
<li><code>mPark</code>ä¼šå¯¼è‡´çº¿ç¨‹è‡ªè¡Œåœé©»ï¼Œä¸€æ—¦è¢«å”¤é†’å°±ä¼šè¿”å›ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1452
</span><span class="lnt">1453
</span><span class="lnt">1454
</span><span class="lnt">1455
</span><span class="lnt">1456
</span><span class="lnt">1457
</span><span class="lnt">1458
</span><span class="lnt">1459
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// mPark causes a thread to park itself, returning once woken.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mPark</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// gp = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">notesleep</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">park</span><span class="p">)</span> <span class="c1">// sleep
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">noteclear</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">park</span><span class="p">)</span> <span class="c1">// æ¸…é™¤ m.park
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="acquirep">acquirep()<a hidden class="anchor" aria-hidden="true" href="#acquirep">#</a></h4>
<ol>
<li>å…³è”<code>p</code>å’Œå½“å‰<code>m</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">4938
</span><span class="lnt">4939
</span><span class="lnt">4940
</span><span class="lnt">4941
</span><span class="lnt">4942
</span><span class="lnt">4943
</span><span class="lnt">4944
</span><span class="lnt">4945
</span><span class="lnt">4946
</span><span class="lnt">4947
</span><span class="lnt">4948
</span><span class="lnt">4949
</span><span class="lnt">4950
</span><span class="lnt">4951
</span><span class="lnt">4952
</span><span class="lnt">4953
</span><span class="lnt">4954
</span><span class="lnt">4955
</span><span class="lnt">4956
</span><span class="lnt">4957
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Associate p and the current m.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// This function is allowed to have write barriers even if the caller
</span></span></span><span class="line"><span class="cl"><span class="c1">// isn&#39;t because it immediately acquires _p_.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:yeswritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Do the part that isn&#39;t allowed to have write barriers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">wirep</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Have p; write barriers now allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Perform deferred mcache flush before this P can allocate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// from a potentially stale mcache.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">mcache</span><span class="p">.</span><span class="nf">prepareForSweep</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceProcStart</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="globrunqget">globrunqget()<a hidden class="anchor" aria-hidden="true" href="#globrunqget">#</a></h3>
<ol>
<li>å°è¯•ä»å…¨å±€å¯è¿è¡Œé˜Ÿåˆ—ä¸­è·å–ä¸€æ‰¹<code>G</code>ï¼Œ<code>sched.lock</code>å¿…é¡»è¢«æŒæœ‰ã€‚</li>
<li>å‚æ•°ï¼š
<ol>
<li><code>_p_ *p</code>ï¼šå½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„<code>P</code>ã€‚</li>
<li><code>max int32</code>ï¼šä»å…¨å±€é˜Ÿåˆ—ä¸­æ‹¿å¤šå°‘ä¸ª<code>g</code>åˆ°æœ¬åœ°<code>P</code>ä¸­ã€‚è¯¥å‚æ•°ä¸€èˆ¬æ˜¯1ï¼Œå¦‚æœæ˜¯å…¶ä»–<code>P</code>å·å–åˆ™æ˜¯å¤§äº1ã€‚</li>
</ol>
</li>
<li>è¿”å›å€¼<code>*g</code>ï¼šä»å…¨å±€é˜Ÿåˆ—ä¸­é‚£åˆ°çš„<code>goroutine</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5601
</span><span class="lnt">5602
</span><span class="lnt">5603
</span><span class="lnt">5604
</span><span class="lnt">5605
</span><span class="lnt">5606
</span><span class="lnt">5607
</span><span class="lnt">5608
</span><span class="lnt">5609
</span><span class="lnt">5610
</span><span class="lnt">5611
</span><span class="lnt">5612
</span><span class="lnt">5613
</span><span class="lnt">5614
</span><span class="lnt">5615
</span><span class="lnt">5616
</span><span class="lnt">5617
</span><span class="lnt">5618
</span><span class="lnt">5619
</span><span class="lnt">5620
</span><span class="lnt">5621
</span><span class="lnt">5622
</span><span class="lnt">5623
</span><span class="lnt">5624
</span><span class="lnt">5625
</span><span class="lnt">5626
</span><span class="lnt">5627
</span><span class="lnt">5628
</span><span class="lnt">5629
</span><span class="lnt">5630
</span><span class="lnt">5631
</span><span class="lnt">5632
</span><span class="lnt">5633
</span><span class="lnt">5634
</span><span class="lnt">5635
</span><span class="lnt">5636
</span><span class="lnt">5637
</span><span class="lnt">5638
</span><span class="lnt">5639
</span><span class="lnt">5640
</span><span class="lnt">5641
</span><span class="lnt">5642
</span><span class="lnt">5643
</span><span class="lnt">5644
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Try get a batch of G&#39;s from the global runnable queue.
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">globrunqget</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">max</span> <span class="kt">int32</span><span class="p">)</span> <span class="o">*</span><span class="nx">g</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// sched.runqsizeï¼šè®°å½•çš„æ˜¯å…¨å±€å°±ç»ªé˜Ÿåˆ—çš„é•¿åº¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¹Ÿå°±æ˜¯å…¨å±€é˜Ÿåˆ—goroutineçš„ä¸ªæ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">runqsize</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ ¹æ®pçš„æ•°é‡å¹³åˆ†å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­çš„goroutines
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">n</span> <span class="o">:=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">runqsize</span><span class="o">/</span><span class="nx">gomaxprocs</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¸Šé¢è®¡ç®—nçš„æ–¹æ³•å¯èƒ½å¯¼è‡´nå¤§äºå…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­çš„goroutineæ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">runqsize</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">n</span> <span class="p">=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">runqsize</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// maxï¼šè¡¨ç¤ºæœ€å¤šæ‹¿å»goroutineä¸ªæ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">max</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="nx">max</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">n</span> <span class="p">=</span> <span class="nx">max</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æœ€å¤šåªèƒ½å–æœ¬åœ°é˜Ÿåˆ—å®¹é‡çš„ä¸€åŠã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _p_.runqï¼šæœ€å¤§256ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="nb">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">n</span> <span class="p">=</span> <span class="nb">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">sched</span><span class="p">.</span><span class="nx">runqsize</span> <span class="o">-=</span> <span class="nx">n</span> <span class="c1">// å‡å»å–å‡ºçš„æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// popä»å…¨å±€è¿è¡Œé˜Ÿåˆ—çš„é˜Ÿåˆ—å¤´å–ä¸€ä¸ªgoroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™ä¸ªgoroutineç”¨äºè¿”å›ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">runq</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">n</span><span class="o">--</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// éå†ä»å…¨å±€é˜Ÿåˆ—ä¸­æ‹¿å–goroutineåˆ°Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">;</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">n</span><span class="o">--</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªgoroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">gp1</span> <span class="o">:=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">runq</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ”¾å…¥æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ï¼Œfalse.æ”¾å…¥å°¾éƒ¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  1. goå…³é”®å­—æ—¶ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ä¼ å…¥çš„true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  2. ä»å…¨å±€æ‹¿å–æ—¶ï¼Œè¿™é‡Œä¼ å…¥çš„æ—¶false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">runqput</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">gp1</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">gp</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="runqput">runqput()<a hidden class="anchor" aria-hidden="true" href="#runqput">#</a></h4>
<ol>
<li>æŠŠ<code>gp</code>æ”¾å…¥<code>_p_</code>çš„å°¾éƒ¨ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>_p_ *p</code>ï¼šæœ¬åœ°<code>P</code>ã€‚</li>
<li><code>gp *g</code>ï¼šéœ€è¦æ”¾å…¥<code>_p_</code>çš„<code>goroutine</code>ã€‚</li>
<li><code>next bool</code>ï¼š<code>true</code>æ”¾å…¥æœ¬åœ°<code>_p_</code>çš„å¼€å¤´ï¼Œ<code>false</code>æ”¾å…¥æœ¬åœ°<code>_p_</code>çš„å°¾éƒ¨ã€‚</li>
</ul>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5780
</span><span class="lnt">5781
</span><span class="lnt">5782
</span><span class="lnt">5783
</span><span class="lnt">5784
</span><span class="lnt">5785
</span><span class="lnt">5786
</span><span class="lnt">5787
</span><span class="lnt">5788
</span><span class="lnt">5789
</span><span class="lnt">5790
</span><span class="lnt">5791
</span><span class="lnt">5792
</span><span class="lnt">5793
</span><span class="lnt">5794
</span><span class="lnt">5795
</span><span class="lnt">5796
</span><span class="lnt">5797
</span><span class="lnt">5798
</span><span class="lnt">5799
</span><span class="lnt">5800
</span><span class="lnt">5801
</span><span class="lnt">5802
</span><span class="lnt">5803
</span><span class="lnt">5804
</span><span class="lnt">5805
</span><span class="lnt">5806
</span><span class="lnt">5807
</span><span class="lnt">5808
</span><span class="lnt">5809
</span><span class="lnt">5810
</span><span class="lnt">5811
</span><span class="lnt">5812
</span><span class="lnt">5813
</span><span class="lnt">5814
</span><span class="lnt">5815
</span><span class="lnt">5816
</span><span class="lnt">5817
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// runqput tries to put g on the local runnable queue.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If next is false, runqput adds g to the tail of the runnable queue.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If next is true, runqput puts g in the _p_.runnext slot.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If the run queue is full, runnext puts g on the global queue.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Executed only by the owner P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">runqput</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">next</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">randomizeScheduler</span> <span class="o">&amp;&amp;</span> <span class="nx">next</span> <span class="o">&amp;&amp;</span> <span class="nf">fastrandn</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">next</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">next</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">retryNext</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">oldnext</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runnext</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runnext</span><span class="p">.</span><span class="nf">cas</span><span class="p">(</span><span class="nx">oldnext</span><span class="p">,</span> <span class="nf">guintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">gp</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="nx">retryNext</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">oldnext</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Kick the old runnext out to the regular run queue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">gp</span> <span class="p">=</span> <span class="nx">oldnext</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">retry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nx">h</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadAcq</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqhead</span><span class="p">)</span> <span class="c1">// load-acquire, synchronize with consumers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">t</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runqtail</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">t</span><span class="o">-</span><span class="nx">h</span> <span class="p">&lt;</span> <span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">[</span><span class="nx">t</span><span class="o">%</span><span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">))].</span><span class="nf">set</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">atomic</span><span class="p">.</span><span class="nf">StoreRel</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqtail</span><span class="p">,</span> <span class="nx">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1">// store-release, makes the item available for consumption
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»_P_ä¸­ç§»é™¤ä¸€éƒ¨åˆ†åˆ°å…¨å±€ä¸­ï¼ŒåŒ…å«gpã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">runqputslow</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// the queue is not full, now the put above must succeed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">goto</span> <span class="nx">retry</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="runqget">runqget()<a hidden class="anchor" aria-hidden="true" href="#runqget">#</a></h3>
<ol>
<li>ä»æœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ—ä¸­è·å–<code>goroutine</code>ã€‚</li>
<li>å¦‚æœ<code>inheritTime</code>ä¸º<code>true</code>ï¼Œåˆ™<code>gp</code>åº”ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡ä¸­çš„å‰©ä½™æ—¶é—´ã€‚å¦åˆ™ï¼Œå®ƒåº”è¯¥å¼€å§‹ä¸€ä¸ªæ–°çš„æ—¶é—´ç‰‡ã€‚</li>
<li>å¤šæœ‰è€…ç”±å½“å‰Pæ‹¥æœ‰ã€‚</li>
<li>å‚æ•°ï¼š<code>_p_ *p</code>ï¼šå½“å‰æœ¬åœ°<code>P</code>ï¼Œå¯èƒ½å‡ºç°å…¶ä»–å·¥ä½œçº¿ç¨‹<code>M</code>å·å–<code>P</code>çš„æƒ…å†µã€‚</li>
<li>è¿”å›å€¼ï¼š
<ol>
<li><code>gp *g</code>ï¼šå½“å‰è·å–åˆ°çš„<code>goroutine</code>ã€‚</li>
<li><code>inheritTime bool</code>ï¼šæ˜¯å¦ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡ã€‚</li>
</ol>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5893
</span><span class="lnt">5894
</span><span class="lnt">5895
</span><span class="lnt">5896
</span><span class="lnt">5897
</span><span class="lnt">5898
</span><span class="lnt">5899
</span><span class="lnt">5900
</span><span class="lnt">5901
</span><span class="lnt">5902
</span><span class="lnt">5903
</span><span class="lnt">5904
</span><span class="lnt">5905
</span><span class="lnt">5906
</span><span class="lnt">5907
</span><span class="lnt">5908
</span><span class="lnt">5909
</span><span class="lnt">5910
</span><span class="lnt">5911
</span><span class="lnt">5912
</span><span class="lnt">5913
</span><span class="lnt">5914
</span><span class="lnt">5915
</span><span class="lnt">5916
</span><span class="lnt">5917
</span><span class="lnt">5918
</span><span class="lnt">5919
</span><span class="lnt">5920
</span><span class="lnt">5921
</span><span class="lnt">5922
</span><span class="lnt">5923
</span><span class="lnt">5924
</span><span class="lnt">5925
</span><span class="lnt">5926
</span><span class="lnt">5927
</span><span class="lnt">5928
</span><span class="lnt">5929
</span><span class="lnt">5930
</span><span class="lnt">5931
</span><span class="lnt">5932
</span><span class="lnt">5933
</span><span class="lnt">5934
</span><span class="lnt">5935
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Get g from local runnable queue.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If inheritTime is true, gp should inherit the remaining time in the
</span></span></span><span class="line"><span class="cl"><span class="c1">// current time slice. Otherwise, it should start a new time slice.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Executed only by the owner P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">runqget</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">inheritTime</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// If there&#39;s a runnext, it&#39;s the next G to run.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœæœ‰ runnextï¼Œå®ƒå°±æ˜¯ä¸‹ä¸€ä¸ªè¦è¿è¡Œçš„ G
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">next</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runnext</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// If the runnext is non-0 and the CAS fails, it could only have been stolen by another P,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// because other Ps can race to set runnext to 0, but only the current P can set it to non-0.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Hence, there&#39;s no need to retry this CAS if it falls.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœ runnext æ˜¯ non-0 å¹¶ä¸” CAS å¤±è´¥ï¼Œå®ƒåªèƒ½è¢«å¦ä¸€ä¸ªPçªƒå–ï¼Œå› ä¸ºå…¶ä»–På¯ä»¥ç«ç›¸å°†runnextè®¾ç½®ä¸º0ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰På¯ä»¥å°†å…¶è®¾ç½®ä¸ºé 0ã€‚ å› æ­¤ï¼Œå¦‚æœè¯¥ CAS å¤±è´¥ï¼Œåˆ™æ— éœ€é‡è¯•ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">next</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runnext</span><span class="p">.</span><span class="nf">cas</span><span class="p">(</span><span class="nx">next</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä» p.runnextä¸Šå–å‡ºçš„goroutineï¼Œéƒ½ç»§æ‰¿äº†ä¸Šæ¬¡çš„æ—¶é—´ç‰‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// channel çš„sendå’Œrecvæ“ä½œéƒ½ä¼šæŠŠgoroutineæŒ‚åœ¨ p.runnext ä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">next</span><span class="p">.</span><span class="nf">ptr</span><span class="p">(),</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// p.runnext == 0 || å½“å‰goroutineå·²è¢«çªƒå–ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åŸå­è¯»å– _p_.runqheadã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å½“å‰På’Œå…¶ä»–Pæ¥å·å–goroutineéƒ½æ˜¯ä»runqheadå¼€å§‹çš„ï¼Œå› æ­¤éœ€è¦åŸå­è¯»å–ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">h</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadAcq</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqhead</span><span class="p">)</span> <span class="c1">// load-acquire, synchronize with other consumers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// runqtailï¼šåªæœ‰æœ¬åœ°Pä¼šä¿®æ”¹è¿™ä¸ªå€¼åŠ å…¥goroutineã€‚å½“å‰Påœ¨æ­¤æ“ä½œå› æ­¤runqtailä¸ä¼šæ”¹å˜ä¸éœ€åŸå­æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">t</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runqtail</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æœ¬åœ°Pé˜Ÿåˆ—ä¸ºç©ºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">t</span> <span class="o">==</span> <span class="nx">h</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//  å–å‡ºå½“å‰hä½ç½®ä¸Šçš„gï¼Œæ³¨æ„å¾ªç¯é˜Ÿåˆ—æ˜¯é€šè¿‡runqheadå’Œrunqtailä¸æ–­çš„ç´¯åŠ ç„¶åé€šè¿‡æ±‚ä½™åˆ¤æ–­ä½ç½®çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ç”±äºrunqheadå’Œrunqtailéƒ½æ˜¯uint32ç±»å‹å¾ªç¯æ•°ç»„å¤§å°ä¸º256æ­£å¥½æ˜¯æ•´å€æ•°ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å› æ­¤uint32ä¸æ–­ç´¯è®¡æœ€åä¼šä»0åˆå¼€å§‹ï¼Œå½¢æˆä¸€ä¸ªå¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">[</span><span class="nx">h</span><span class="o">%</span><span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">))].</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// CAS è®¾ç½® _p_.runqheadï¼Œè¿™æ®µæ—¶é—´å¯èƒ½ _p_.runqhead çš„å€¼å‘ç”Ÿå˜åŒ–è€Œå¤±è´¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">CasRel</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqhead</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">h</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// cas-release, commits consume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="nx">gp</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="injectglist">injectglist()<a hidden class="anchor" aria-hidden="true" href="#injectglist">#</a></h3>
<ol>
<li><code>injectglist</code> å°†åˆ—è¡¨ä¸Šçš„æ¯ä¸ªå¯è¿è¡Œçš„<code>G</code>æ·»åŠ åˆ°æŸä¸ªè¿è¡Œé˜Ÿåˆ—ï¼Œå¹¶æ¸…é™¤<code>glist</code>ã€‚</li>
<li>å¦‚æœå½“å‰ä¸å­˜åœ¨<code>P</code>ï¼Œåˆ™å°†å®ƒä»¬æ·»åŠ åˆ°å…¨å±€é˜Ÿåˆ—ï¼Œå¹¶å¯åŠ¨å¤šè¾¾<code>npim</code>ä¸ªé˜Ÿåˆ—æ¥è¿è¡Œå®ƒä»¬ã€‚</li>
<li>å¦åˆ™ï¼Œå¯¹äºæ¯ä¸ªç©ºé—²çš„<code>P</code>ï¼Œå°†<code>G</code>æ·»åŠ åˆ°å…¨å±€é˜Ÿåˆ—ï¼Œå¹¶å¯åŠ¨ä¸€ä¸ª<code>m</code>ã€‚å‰©ä½™çš„<code>G</code>æ·»åŠ åˆ°å½“å‰<code>P</code>çš„æœ¬åœ°å°±ç»ªé˜Ÿåˆ—ã€‚</li>
<li>è¿™å¯èƒ½ä¼šä¸´æ—¶è·å–<code>sched.lock</code>ã€‚å¯ä»¥ä¸<code>GC</code>å¹¶å‘è¿è¡Œã€‚</li>
<li>è¯¥å‡½æ•°åœ¨<code>netpoll</code>åè°ƒç”¨ï¼Œå¯ä»¥æ˜¯ç›‘æ§çº¿ç¨‹ä¸­è¿™ç§æƒ…å†µä¸‹æ²¡æœ‰<code>P</code>ï¼Œæˆ–åˆ™è°ƒåº¦å¾ªç¯ä¸­ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">3113
</span><span class="lnt">3114
</span><span class="lnt">3115
</span><span class="lnt">3116
</span><span class="lnt">3117
</span><span class="lnt">3118
</span><span class="lnt">3119
</span><span class="lnt">3120
</span><span class="lnt">3121
</span><span class="lnt">3122
</span><span class="lnt">3123
</span><span class="lnt">3124
</span><span class="lnt">3125
</span><span class="lnt">3126
</span><span class="lnt">3127
</span><span class="lnt">3128
</span><span class="lnt">3129
</span><span class="lnt">3130
</span><span class="lnt">3131
</span><span class="lnt">3132
</span><span class="lnt">3133
</span><span class="lnt">3134
</span><span class="lnt">3135
</span><span class="lnt">3136
</span><span class="lnt">3137
</span><span class="lnt">3138
</span><span class="lnt">3139
</span><span class="lnt">3140
</span><span class="lnt">3141
</span><span class="lnt">3142
</span><span class="lnt">3143
</span><span class="lnt">3144
</span><span class="lnt">3145
</span><span class="lnt">3146
</span><span class="lnt">3147
</span><span class="lnt">3148
</span><span class="lnt">3149
</span><span class="lnt">3150
</span><span class="lnt">3151
</span><span class="lnt">3152
</span><span class="lnt">3153
</span><span class="lnt">3154
</span><span class="lnt">3155
</span><span class="lnt">3156
</span><span class="lnt">3157
</span><span class="lnt">3158
</span><span class="lnt">3159
</span><span class="lnt">3160
</span><span class="lnt">3161
</span><span class="lnt">3162
</span><span class="lnt">3163
</span><span class="lnt">3164
</span><span class="lnt">3165
</span><span class="lnt">3166
</span><span class="lnt">3167
</span><span class="lnt">3168
</span><span class="lnt">3169
</span><span class="lnt">3170
</span><span class="lnt">3171
</span><span class="lnt">3172
</span><span class="lnt">3173
</span><span class="lnt">3174
</span><span class="lnt">3175
</span><span class="lnt">3176
</span><span class="lnt">3177
</span><span class="lnt">3178
</span><span class="lnt">3179
</span><span class="lnt">3180
</span><span class="lnt">3181
</span><span class="lnt">3182
</span><span class="lnt">3183
</span><span class="lnt">3184
</span><span class="lnt">3185
</span><span class="lnt">3186
</span><span class="lnt">3187
</span><span class="lnt">3188
</span><span class="lnt">3189
</span><span class="lnt">3190
</span><span class="lnt">3191
</span><span class="lnt">3192
</span><span class="lnt">3193
</span><span class="lnt">3194
</span><span class="lnt">3195
</span><span class="lnt">3196
</span><span class="lnt">3197
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// injectglist adds each runnable G on the list to some run queue,
</span></span></span><span class="line"><span class="cl"><span class="c1">// and clears glist. If there is no current P, they are added to the
</span></span></span><span class="line"><span class="cl"><span class="c1">// global queue, and up to npidle M&#39;s are started to run them.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Otherwise, for each idle P, this adds a G to the global queue
</span></span></span><span class="line"><span class="cl"><span class="c1">// and starts an M. Any remaining G&#39;s are added to the current P&#39;s
</span></span></span><span class="line"><span class="cl"><span class="c1">// local run queue.
</span></span></span><span class="line"><span class="cl"><span class="c1">// This may temporarily acquire sched.lock.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Can run concurrently with GC.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">injectglist</span><span class="p">(</span><span class="nx">glist</span> <span class="o">*</span><span class="nx">gList</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// goroutine ç©ºåˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">glist</span><span class="p">.</span><span class="nf">empty</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">glist</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nf">ptr</span><span class="p">();</span> <span class="nx">gp</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">gp</span> <span class="p">=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">schedlink</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">traceGoUnpark</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Mark all the goroutines as runnable before we put them
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// on the run queues.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">head</span> <span class="o">:=</span> <span class="nx">glist</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">tail</span> <span class="o">*</span><span class="nx">g</span> <span class="c1">// è·å–é˜Ÿåˆ—æœ€åä¸€ä¸ª goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">qsize</span> <span class="o">:=</span> <span class="mi">0</span> <span class="c1">// è®°å½•goroutineæ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¿®æ”¹è¿™äº›goroutineçš„çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">head</span><span class="p">;</span> <span class="nx">gp</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">gp</span> <span class="p">=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">schedlink</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">tail</span> <span class="p">=</span> <span class="nx">gp</span>
</span></span><span class="line"><span class="cl">        <span class="nx">qsize</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// _Gwaitingï¼šgoroutineé˜»å¡åœ¨runtimeä¸­ï¼Œæ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç ã€‚å®ƒä¸åœ¨ä»»ä½•runqä¸­ï¼Œä½†æ˜¯åº”è¯¥è¢«è®°å½•åœ¨å…¶ä»–åœ°æ–¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// _Grunnableï¼šgoroutineåº”è¯¥åœ¨æŸä¸ªrunqä¸­ï¼Œå½“å‰å¹¶æ²¡æœ‰åœ¨è¿è¡Œç”¨æˆ·ä»£ç ï¼Œå®ƒçš„æ ˆä¸å½’è‡ªå·±æ‰€æœ‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Gwaiting</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Turn the gList into a gQueue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å°†è¿™ä¸ªgListè½¬æ¢ä¸ºä¸€ä¸ªgQueueã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">q</span> <span class="nx">gQueue</span> <span class="c1">// åŒå‘é“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">q</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">head</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">q</span><span class="p">.</span><span class="nx">tail</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">tail</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="nx">glist</span> <span class="p">=</span> <span class="nx">gList</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">startIdle</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æŒ‡å®šæ•°é‡çš„ç©ºé—²Pèµ·æ¥å·¥ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">;</span> <span class="nx">n</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">npidle</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">n</span><span class="o">--</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">startm</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">pp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">().</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span> <span class="c1">// pp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœæ¥è‡ªsysmonç›‘æ§çº¿ç¨‹ï¼Œpp = nilã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">pp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ”¾å…¥å…¨å±€ sched.runq æ± ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">globrunqputbatch</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">q</span><span class="p">,</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">qsize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å”¤é†’qsizeå¤šä¸ªç©ºé—²Pæ¥å¤„ç†è¿™äº›goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">startIdle</span><span class="p">(</span><span class="nx">qsize</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»¥ä¸‹æ˜¯å­˜åœ¨Pçš„æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// ç©ºé—²çš„Pçš„æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">npidle</span> <span class="o">:=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">npidle</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">globq</span> <span class="nx">gQueue</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">n</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æŠŠç©ºé—²Pæ•°é‡ä¸ªæ•°çš„goroutineæ”¾å…¥å…¨å±€æ± ä¸­ï¼Œç„¶åå”¤é†’Pèµ·æ¥å·¥ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">n</span> <span class="p">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="nx">npidle</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">q</span><span class="p">.</span><span class="nf">empty</span><span class="p">();</span> <span class="nx">n</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">g</span> <span class="o">:=</span> <span class="nx">q</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">globq</span><span class="p">.</span><span class="nf">pushBack</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ”¾å…¥å…¨å±€ sched.runq æ± ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">globrunqputbatch</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">globq</span><span class="p">,</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å”¤é†’qsizeå¤šä¸ªç©ºé—²Pæ¥å¤„ç†è¿™äº›goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">startIdle</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">qsize</span> <span class="o">-=</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">q</span><span class="p">.</span><span class="nf">empty</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è¿˜å‰©çš„goroutineæ”¾å…¥æœ¬åœ°é˜Ÿåˆ—ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">runqputbatch</span><span class="p">(</span><span class="nx">pp</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">q</span><span class="p">,</span> <span class="nx">qsize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="stealwork">stealWork()<a hidden class="anchor" aria-hidden="true" href="#stealwork">#</a></h3>
<ol>
<li><code>stealWork</code>è¯•å›¾ä»ä»»ä½•<code>P</code>ä¸­çªƒå–ä¸€ä¸ªå¯è¿è¡Œçš„<code>goroutine</code>æˆ–<code>timer</code>ã€‚</li>
<li>å¦‚æœè¿”å›å€¼<code>newWork</code>ä¸º<code>true</code>ï¼Œåˆ™æ–°å·¥ä½œå¯èƒ½å·²ç»å‡†å¤‡å¥½äº†ã€‚</li>
<li>å¦‚æœ<code>now</code>ä¸æ˜¯0ï¼Œåˆ™ä¸ºå½“å‰æ—¶é—´ã€‚<code>stealWork</code>è¿”å›ç»è¿‡çš„æ—¶é—´ï¼Œå¦‚æœ<code>now</code>è¢«ä¼ é€’ä¸º0ï¼Œåˆ™è¿”å›å½“å‰æ—¶é—´ã€‚</li>
<li>å‚æ•°<code>now int64</code>ï¼šä¸æ˜¯ 0ï¼Œåˆ™ä¸ºå½“å‰æ—¶é—´ã€‚</li>
<li>è¿”å›å€¼ï¼š
<ol>
<li><code>gp *g</code>ï¼šè·å–åˆ°çš„<code>goroutine</code>ã€‚</li>
<li><code>inheritTime bool</code>ï¼šæ˜¯å¦ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡ã€‚</li>
<li><code>rnow int64</code>ï¼šè·å–æ—¶é—´ç‚¹ã€‚</li>
<li><code>pollUntil int64</code>ï¼š<code>timer</code>çš„è§¦å‘æ—¶é—´ç‚¹ã€‚</li>
<li><code>newWork bool</code>ï¼šä¸º trueï¼Œåˆ™æ–°å·¥ä½œå¯èƒ½å·²ç»å‡†å¤‡å¥½äº†ã€‚ä¼šè·³è½¬åˆ°findRunnableå‡½æ•°topæ ‡ç­¾å¤„ä»æ–°å¼€å§‹ã€‚</li>
</ol>
</li>
<li>çªƒå–é€»è¾‘ä¼šå¾ªç¯å°è¯•4æ¬¡ï¼Œæœ€åä¸€æ¬¡æ‰ä¼šçªƒå–<code>runnext</code>å’Œ<code>timer</code>ï¼Œä¹Ÿå°±æ˜¯è¯´å‰3æ¬¡åªä¼šä»å…¶ä»–<code>P</code>çš„æœ¬åœ°<code>runq</code>ä¸­çªƒå–ã€‚</li>
<li><code>stealOrder</code>ç”¨æ¥å®ç°ä¸€ä¸ªå…¬å¹³çš„éšæœºçªƒå–é¡ºåºï¼Œ<code>timerpMask</code>å’Œ<code>idlepMask</code>ç”¨æ¥å¿«é€Ÿåˆ¤æ–­æŒ‡å®šä½ç½®çš„<code>P</code>æ˜¯å¦æœ‰<code>timer</code>æˆ–æ˜¯ç©ºé—²ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2899
</span><span class="lnt">2900
</span><span class="lnt">2901
</span><span class="lnt">2902
</span><span class="lnt">2903
</span><span class="lnt">2904
</span><span class="lnt">2905
</span><span class="lnt">2906
</span><span class="lnt">2907
</span><span class="lnt">2908
</span><span class="lnt">2909
</span><span class="lnt">2910
</span><span class="lnt">2911
</span><span class="lnt">2912
</span><span class="lnt">2913
</span><span class="lnt">2914
</span><span class="lnt">2915
</span><span class="lnt">2916
</span><span class="lnt">2917
</span><span class="lnt">2918
</span><span class="lnt">2919
</span><span class="lnt">2920
</span><span class="lnt">2921
</span><span class="lnt">2922
</span><span class="lnt">2923
</span><span class="lnt">2924
</span><span class="lnt">2925
</span><span class="lnt">2926
</span><span class="lnt">2927
</span><span class="lnt">2928
</span><span class="lnt">2929
</span><span class="lnt">2930
</span><span class="lnt">2931
</span><span class="lnt">2932
</span><span class="lnt">2933
</span><span class="lnt">2934
</span><span class="lnt">2935
</span><span class="lnt">2936
</span><span class="lnt">2937
</span><span class="lnt">2938
</span><span class="lnt">2939
</span><span class="lnt">2940
</span><span class="lnt">2941
</span><span class="lnt">2942
</span><span class="lnt">2943
</span><span class="lnt">2944
</span><span class="lnt">2945
</span><span class="lnt">2946
</span><span class="lnt">2947
</span><span class="lnt">2948
</span><span class="lnt">2949
</span><span class="lnt">2950
</span><span class="lnt">2951
</span><span class="lnt">2952
</span><span class="lnt">2953
</span><span class="lnt">2954
</span><span class="lnt">2955
</span><span class="lnt">2956
</span><span class="lnt">2957
</span><span class="lnt">2958
</span><span class="lnt">2959
</span><span class="lnt">2960
</span><span class="lnt">2961
</span><span class="lnt">2962
</span><span class="lnt">2963
</span><span class="lnt">2964
</span><span class="lnt">2965
</span><span class="lnt">2966
</span><span class="lnt">2967
</span><span class="lnt">2968
</span><span class="lnt">2969
</span><span class="lnt">2970
</span><span class="lnt">2971
</span><span class="lnt">2972
</span><span class="lnt">2973
</span><span class="lnt">2974
</span><span class="lnt">2975
</span><span class="lnt">2976
</span><span class="lnt">2977
</span><span class="lnt">2978
</span><span class="lnt">2979
</span><span class="lnt">2980
</span><span class="lnt">2981
</span><span class="lnt">2982
</span><span class="lnt">2983
</span><span class="lnt">2984
</span><span class="lnt">2985
</span><span class="lnt">2986
</span><span class="lnt">2987
</span><span class="lnt">2988
</span><span class="lnt">2989
</span><span class="lnt">2990
</span><span class="lnt">2991
</span><span class="lnt">2992
</span><span class="lnt">2993
</span><span class="lnt">2994
</span><span class="lnt">2995
</span><span class="lnt">2996
</span><span class="lnt">2997
</span><span class="lnt">2998
</span><span class="lnt">2999
</span><span class="lnt">3000
</span><span class="lnt">3001
</span><span class="lnt">3002
</span><span class="lnt">3003
</span><span class="lnt">3004
</span><span class="lnt">3005
</span><span class="lnt">3006
</span><span class="lnt">3007
</span><span class="lnt">3008
</span><span class="lnt">3009
</span><span class="lnt">3010
</span><span class="lnt">3011
</span><span class="lnt">3012
</span><span class="lnt">3013
</span><span class="lnt">3014
</span><span class="lnt">3015
</span><span class="lnt">3016
</span><span class="lnt">3017
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// stealWork attempts to steal a runnable goroutine or timer from any P.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// If newWork is true, new work may have been readied.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// If now is not 0 it is the current time. stealWork returns the passed time or
</span></span></span><span class="line"><span class="cl"><span class="c1">// the current time if now was passed as 0.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">stealWork</span><span class="p">(</span><span class="nx">now</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">inheritTime</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">rnow</span><span class="p">,</span> <span class="nx">pollUntil</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">newWork</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">().</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span> <span class="c1">// pp = p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">ranTimer</span> <span class="o">:=</span> <span class="kc">false</span> <span class="c1">// newWork çš„è¿”å›å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å°è¯•å·å–æœ€å¤§æ¬¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">const</span> <span class="nx">stealTries</span> <span class="p">=</span> <span class="mi">4</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// æ‰§è¡Œå››æ¬¡éå†ï¼Œå°±æ˜¯å°½æœ€å¤§åŠªåŠ›å»å…¶ä»–Pä¸­æŸ¥çœ‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">stealTries</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æœ€åä¸€æ¬¡æ—¶ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  1. å‰ä¸‰æ¬¡å°è¯•å»Pçš„runqæœ¬åœ°é˜Ÿåˆ—ä¸­å·å–goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  2. æœ€åä¸€æ¬¡å…ˆå»å„ä¸ªPçš„timersé‡Œçœ‹çœ‹ï¼Œç„¶åå½“å·å–çš„Pçš„runqä¸ºç©ºæ—¶ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//     å°è¯•å·å–P.runnextä¸Šçš„goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">stealTimersOrRunNextG</span> <span class="o">:=</span> <span class="nx">i</span> <span class="o">==</span> <span class="nx">stealTries</span><span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// randomOrder/randomEnum æ˜¯éšæœºå·¥ä½œçªƒå–çš„è¾…åŠ©ç±»å‹ï¼Œä¸€è½®allpéå†å¼€å§‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å®ƒä»¬å…è®¸ä»¥ä¸åŒçš„ä¼ªéšæœºé¡ºåºæšä¸¾æ‰€æœ‰ P è€Œä¸é‡å¤ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¯¥ç®—æ³•åŸºäºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//   å¦‚æœæˆ‘ä»¬æœ‰Xä½¿å¾—Xå’ŒGOMAXPROCSäº’è´¨ï¼Œé‚£ä¹ˆ(i + X)%GOMAXPROCSçš„åºåˆ—ç»™å‡ºæ‰€éœ€çš„æšä¸¾ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// stealOrder.start(fastrand())ï¼šä»ä¸€ä¸ªéšæœºä½ç½®å¼€å§‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// !enum.done()ï¼šå½“å‰æ˜¯å¦å·²ç»éå†ä¸€åœˆäº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// enum.next()ï¼šè·³è½¬åˆ°ä¸‹ä¸€ä¸ªä½ç½®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="nx">enum</span> <span class="o">:=</span> <span class="nx">stealOrder</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="nf">fastrand</span><span class="p">());</span> <span class="p">!</span><span class="nx">enum</span><span class="p">.</span><span class="nf">done</span><span class="p">();</span> <span class="nx">enum</span><span class="p">.</span><span class="nf">next</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æœ‰STWæ­£åœ¨ç­‰å¾…PæŒ‚èµ·ã€‚ç›´æ¥è¿”å›ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è·³è½¬åˆ°findRunnableå‡½æ•°topæ ‡ç­¾å¤„ä»æ–°å¼€å§‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">gcwaiting</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// GC work may be available.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">now</span><span class="p">,</span> <span class="nx">pollUntil</span><span class="p">,</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// éšæœºé€‰çš„pï¼Œå¦‚æœæ˜¯å½“å‰çš„è·³è¿‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// enum.position()ï¼šå½“å‰å·å–Pçš„ä¸‹æ ‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">p2</span> <span class="o">:=</span> <span class="nx">allp</span><span class="p">[</span><span class="nx">enum</span><span class="p">.</span><span class="nf">position</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">pp</span> <span class="o">==</span> <span class="nx">p2</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Steal timers from p2. This call to checkTimers is the only place
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// where we might hold a lock on a different P&#39;s timers. We do this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// once on the last pass before checking runnext because stealing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// from the other P&#39;s runnext should be the last resort, so if there
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// are timers to steal do that first.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// We only check timers on one of the stealing iterations because
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// the time stored in now doesn&#39;t change in this loop and checking
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// the timers for each P more than once with the same value of now
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// is probably a waste of time.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// timerpMask tells us whether the P may have timers at all. If it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// can&#39;t, no need to check at all.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ä»p2ä¸­çªƒå– timersã€‚å¯¹checkTimersçš„è°ƒç”¨æ˜¯å”¯ä¸€å¯ä»¥å¯¹ä¸åŒPçš„timersæŒæœ‰é”çš„åœ°æ–¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æˆ‘ä»¬åœ¨æ£€æŸ¥runnextä¹‹å‰çš„æœ€åä¸€éæ‰§è¡Œæ­¤æ“ä½œï¼Œå› ä¸ºä»å¦ä¸€ä¸ªPçš„runnextä¸­çªƒå–è®¡æ—¶å™¨åº”è¯¥æ˜¯æœ€åçš„æ‰‹æ®µï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æ‰€ä»¥å¦‚æœæœ‰timerså¯ä»¥çªƒå–ï¼Œè¯·å…ˆçªƒå–ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æˆ‘ä»¬åªæ£€æŸ¥å…¶ä¸­ä¸€ä¸ªçªƒå–è¿­ä»£çš„å®šæ—¶å™¨ï¼Œå› ä¸ºå­˜å‚¨åœ¨nowä¸­çš„æ—¶é—´åœ¨è¿™ä¸ªå¾ªç¯ä¸­ä¸ä¼šæ”¹å˜ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦‚æœç”¨ç›¸åŒçš„nowå€¼å¤šæ¬¡æ£€æŸ¥æ¯ä¸ªPçš„å®šæ—¶å™¨ï¼Œå¯èƒ½å°±æ˜¯æµªè´¹æ—¶é—´ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// timerpMaskå‘Šè¯‰æˆ‘ä»¬Pæ˜¯å¦æœ‰å®šæ—¶å™¨ã€‚å¦‚æœå®ƒä¸èƒ½ï¼Œæ ¹æœ¬ä¸éœ€è¦æ£€æŸ¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// timerpMask æ˜¯Pçš„ä½å›¾è®°å½•å½“å‰Pä¸Šæ˜¯å¦æœ‰ timerã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">stealTimersOrRunNextG</span> <span class="o">&amp;&amp;</span> <span class="nx">timerpMask</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="nx">enum</span><span class="p">.</span><span class="nf">position</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// å†æ¬¡çœ‹çœ‹ timersï¼Œæ˜¯å¦æœ‰åˆ°ç‚¹éœ€è¦æ‰§è¡Œçš„timerã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//   tnowï¼šè¿”å›çš„now
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//   wï¼šè§¦å‘æ—¶é—´ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//   ranï¼štimeræ˜¯å¦å·²ç»è¿è¡Œäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// å¦‚æœranä¸ºtrueï¼Œè¡¨ç¤ºcheckTimers()æ‰§è¡Œäº†p2çš„timerï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// å¯èƒ½ä¼šä½¿æŸäº›goroutineå˜æˆ_GrunnableçŠ¶æ€ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// æ‰€ä»¥å…ˆæ£€æŸ¥å½“å‰Pçš„æœ¬åœ°runqï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ç»§ç»­å»å·å–ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">tnow</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">ran</span> <span class="o">:=</span> <span class="nf">checkTimers</span><span class="p">(</span><span class="nx">p2</span><span class="p">,</span> <span class="nx">now</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nx">now</span> <span class="p">=</span> <span class="nx">tnow</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// w != 0ï¼šè¿˜æœªè§¦å‘çš„æ—¶é—´ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// pollUntil == 0ï¼šä¸Šæ¬¡æ£€æŸ¥æ²¡æœ‰timer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// w &lt; pollUntilï¼šè§¦å‘æ—¶é—´ç‚¹ç¼©å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">w</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">pollUntil</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">w</span> <span class="p">&lt;</span> <span class="nx">pollUntil</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">pollUntil</span> <span class="p">=</span> <span class="nx">w</span> <span class="c1">// æœ€è¿‘çš„timerè§¦å‘çš„æ—¶é—´ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// æœ‰è§¦å‘timerè¿è¡Œï¼Œéœ€è¦å»Pçš„æœ¬åœ°runqä¸­å»æ‰¾æ‰¾å¯èƒ½æœ‰goroutineè¢«æ”¾é‡Œé¢äº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// æ¯”å¦‚time.Sleepã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">ran</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Running the timers may have
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// made an arbitrary number of G&#39;s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// ready and added them to this P&#39;s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// local run queue. That invalidates
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// the assumption of runqsteal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// that it always has room to add
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// stolen G&#39;s. So check now if there
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// is a local G to run.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">inheritTime</span> <span class="o">:=</span> <span class="nf">runqget</span><span class="p">(</span><span class="nx">pp</span><span class="p">);</span> <span class="nx">gp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">return</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">inheritTime</span><span class="p">,</span> <span class="nx">now</span><span class="p">,</span> <span class="nx">pollUntil</span><span class="p">,</span> <span class="nx">ranTimer</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// æ ‡è®°ä¸ºtrueï¼Œå†æ¬¡è·‘ä¸€è¾¹è°ƒåº¦å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nx">ranTimer</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Don&#39;t bother to attempt to steal if p2 is idle.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦‚æœp2æ˜¯ç©ºé—²çš„ä¸è¦å°è¯•å·å–ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// åœ¨åˆ›å»ºgoroutineæ—¶å€™æˆ‘ä»¬é‡è§è¿‡idlepMaskï¼Œè¯¥å€¼æ˜¯Pçš„ä½å›¾ï¼Œè®°å½•äº†æ‰€æœ‰ç©ºé—²çš„Pçš„bitä½(åŸå­æ›´æ–°)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// idlepMask.read(enum.position())ï¼štrue.å½“å‰Pæ˜¯ç©ºé—²çš„ï¼Œfalse.å½“å‰Pä¸æ˜¯ç©ºé—²çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">!</span><span class="nx">idlepMask</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="nx">enum</span><span class="p">.</span><span class="nf">position</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// runqsteal å‡½æ•°ä»p2ä¸­å·å–goroutineåˆ°ppä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// stealTimersOrRunNextGè¡¨ç¤ºæœ€å¤§ç¨‹åº¦å·å–runnextã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">runqsteal</span><span class="p">(</span><span class="nx">pp</span><span class="p">,</span> <span class="nx">p2</span><span class="p">,</span> <span class="nx">stealTimersOrRunNextG</span><span class="p">);</span> <span class="nx">gp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="nx">gp</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">now</span><span class="p">,</span> <span class="nx">pollUntil</span><span class="p">,</span> <span class="nx">ranTimer</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// No goroutines found to steal. Regardless, running a timer may have
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// made some goroutine ready that we missed. Indicate the next timer to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// wait for.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">now</span><span class="p">,</span> <span class="nx">pollUntil</span><span class="p">,</span> <span class="nx">ranTimer</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="runqsteal">runqsteal()<a hidden class="anchor" aria-hidden="true" href="#runqsteal">#</a></h4>
<ol>
<li>ä»<code>p2</code>çš„æœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ—ä¸­çªƒå–ä¸€åŠçš„<code>g</code>ï¼Œå¹¶æ”¾å…¥<code>p</code>çš„æœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ—ä¸­ã€‚</li>
<li>è¿”å›ä¸€ä¸ªè¢«çªƒå–çš„<code>g</code>(å¦‚æœå¤±è´¥åˆ™è¿”å›<code>nil</code>)ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>_p_ *p</code>ï¼šå½“å‰çªƒå–å…¶ä»–<code>P</code>çš„å·¥ä½œçº¿ç¨‹ç»‘å®šçš„<code>P</code>ã€‚</li>
<li><code>p2 *p</code>ï¼šè¢«çªƒå–çš„<code>P</code>ã€‚</li>
<li><code>stealRunNextG bool</code>ï¼š<code>true</code>å°½æœ€å¤§åŠªåŠ›å»<code>p.runnext</code>ä¸Šå·å–ï¼Œ<code>false</code>ä¸å·å–<code>p.runnext</code>çš„<code>goroutine</code>ã€‚</li>
</ul>
</li>
<li>è¿”å›å€¼<code>*g</code>ï¼šå·å–åˆ°çš„<code>goroutine</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">6015
</span><span class="lnt">6016
</span><span class="lnt">6017
</span><span class="lnt">6018
</span><span class="lnt">6019
</span><span class="lnt">6020
</span><span class="lnt">6021
</span><span class="lnt">6022
</span><span class="lnt">6023
</span><span class="lnt">6024
</span><span class="lnt">6025
</span><span class="lnt">6026
</span><span class="lnt">6027
</span><span class="lnt">6028
</span><span class="lnt">6029
</span><span class="lnt">6030
</span><span class="lnt">6031
</span><span class="lnt">6032
</span><span class="lnt">6033
</span><span class="lnt">6034
</span><span class="lnt">6035
</span><span class="lnt">6036
</span><span class="lnt">6037
</span><span class="lnt">6038
</span><span class="lnt">6039
</span><span class="lnt">6040
</span><span class="lnt">6041
</span><span class="lnt">6042
</span><span class="lnt">6043
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Steal half of elements from local runnable queue of p2
</span></span></span><span class="line"><span class="cl"><span class="c1">// and put onto local runnable queue of p.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Returns one of the stolen elements (or nil if failed).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">runqsteal</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">p2</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">stealRunNextG</span> <span class="kt">bool</span><span class="p">)</span> <span class="o">*</span><span class="nx">g</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">t</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runqtail</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å°è¯•ä»p2ä¸­å·å–ä¸€åŠçš„goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">n</span> <span class="o">:=</span> <span class="nf">runqgrab</span><span class="p">(</span><span class="nx">p2</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">stealRunNextG</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// p2ä¸­ä¹Ÿæ²¡æœ‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»pçš„æœ¬åœ°runqä¸­å–å‡ºä¸€ä¸ªgoroutineï¼Œç”¨äºè¿”å›ç»™è°ƒåº¦å™¨è°ƒåº¦èµ·æ¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">n</span><span class="o">--</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å› ä¸ºå·å–æ˜¯ä»runqtailå¼€å§‹çš„ï¼Œå› æ­¤runqtailå¤„ä¹Ÿæ˜¯headå¤´å¤„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å…¶å®æ˜¯å–çš„é˜Ÿåˆ—ä¸­çš„æœ€åä¸€ä¸ªï¼Œæ–¹ä¾¿åé¢ StoreRel åŸå­æ“ä½œè®¾ç½® runqtail å€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">[(</span><span class="nx">t</span><span class="o">+</span><span class="nx">n</span><span class="p">)</span><span class="o">%</span><span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">))].</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">gp</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿˜æœ‰å…¶ä»–çš„éœ€è¦å¤„ç†ï¼ŒåŸå­è¯»å– _p_.runqhead
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">h</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadAcq</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqhead</span><span class="p">)</span> <span class="c1">// load-acquire, synchronize with consumers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œåˆ¤æ–­å·å–çš„gæ˜¯å¦å¤§äºPæœ¬åœ°çš„ä¸€åŠæ•°é‡ï¼Œåˆ™æ˜¯æº¢å‡ºäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">t</span><span class="o">-</span><span class="nx">h</span><span class="o">+</span><span class="nx">n</span> <span class="o">&gt;=</span> <span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runqsteal: runq overflow&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åŸå­è®¾ç½® _p_.runqtail = t+n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">atomic</span><span class="p">.</span><span class="nf">StoreRel</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqtail</span><span class="p">,</span> <span class="nx">t</span><span class="o">+</span><span class="nx">n</span><span class="p">)</span> <span class="c1">// store-release, makes the item available for consumption
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">gp</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="runqgrab">runqgrab()<a hidden class="anchor" aria-hidden="true" href="#runqgrab">#</a></h4>
<ol>
<li>ä»<code>_p_</code>çš„å¯è¿è¡Œé˜Ÿåˆ—ä¸­è·å–ä¸€æ‰¹<code>goroutines</code>åˆ°<code>batch</code>ã€‚</li>
<li><code>Batch</code>æ˜¯ä¸€ä¸ªä»<code>batchHead</code>å¼€å§‹çš„ç¯å½¢ç¼“å†²åŒºã€‚</li>
<li>è¿”å›æŠ“å–çš„<code>goroutines</code>çš„æ•°é‡ã€‚å¯ä»¥è¢«ä»»æ„<code>P</code>æ‰§è¡Œã€‚</li>
<li>å‚æ•°ï¼šå‡è®¾ä»<code>p2</code>å·å–åˆ°<code>p</code>ã€‚
<ol>
<li><code>_p_ *p</code>ï¼šå·å–ç›®æ ‡çš„Pã€‚å°±æ˜¯p2.</li>
<li><code>batch *[256]guintptr</code>ï¼šä»<code>_p_</code>å·å–<code>goroutine</code>éœ€è¦æ”¾åˆ°çš„<code>P</code>çš„<code>runq</code>æœ¬åœ°é˜Ÿåˆ—æ± ã€‚å°±æ˜¯pçš„æœ¬åœ°<code>runq</code>æ± ã€‚</li>
<li><code>batchHead uint32</code>ï¼š<code>p</code>çš„<code>runqtail</code>å¤„ã€‚</li>
<li><code>stealRunNextG bool</code>ï¼šæ˜¯å¦è¿‘æœ€å¤§åŠªåŠ›å»<code>runnext</code>ä¸Šå·å–ã€‚</li>
</ol>
</li>
<li>è¿”å›å€¼ï¼š<code>uint32</code>ï¼šå·å–<code>goroutine</code>çš„æ•°é‡ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5959
</span><span class="lnt">5960
</span><span class="lnt">5961
</span><span class="lnt">5962
</span><span class="lnt">5963
</span><span class="lnt">5964
</span><span class="lnt">5965
</span><span class="lnt">5966
</span><span class="lnt">5967
</span><span class="lnt">5968
</span><span class="lnt">5969
</span><span class="lnt">5970
</span><span class="lnt">5971
</span><span class="lnt">5972
</span><span class="lnt">5973
</span><span class="lnt">5974
</span><span class="lnt">5975
</span><span class="lnt">5976
</span><span class="lnt">5977
</span><span class="lnt">5978
</span><span class="lnt">5979
</span><span class="lnt">5980
</span><span class="lnt">5981
</span><span class="lnt">5982
</span><span class="lnt">5983
</span><span class="lnt">5984
</span><span class="lnt">5985
</span><span class="lnt">5986
</span><span class="lnt">5987
</span><span class="lnt">5988
</span><span class="lnt">5989
</span><span class="lnt">5990
</span><span class="lnt">5991
</span><span class="lnt">5992
</span><span class="lnt">5993
</span><span class="lnt">5994
</span><span class="lnt">5995
</span><span class="lnt">5996
</span><span class="lnt">5997
</span><span class="lnt">5998
</span><span class="lnt">5999
</span><span class="lnt">6000
</span><span class="lnt">6001
</span><span class="lnt">6002
</span><span class="lnt">6003
</span><span class="lnt">6004
</span><span class="lnt">6005
</span><span class="lnt">6006
</span><span class="lnt">6007
</span><span class="lnt">6008
</span><span class="lnt">6009
</span><span class="lnt">6010
</span><span class="lnt">6011
</span><span class="lnt">6012
</span><span class="lnt">6013
</span><span class="lnt">6014
</span><span class="lnt">6015
</span><span class="lnt">6016
</span><span class="lnt">6017
</span><span class="lnt">6018
</span><span class="lnt">6019
</span><span class="lnt">6020
</span><span class="lnt">6021
</span><span class="lnt">6022
</span><span class="lnt">6023
</span><span class="lnt">6024
</span><span class="lnt">6025
</span><span class="lnt">6026
</span><span class="lnt">6027
</span><span class="lnt">6028
</span><span class="lnt">6029
</span><span class="lnt">6030
</span><span class="lnt">6031
</span><span class="lnt">6032
</span><span class="lnt">6033
</span><span class="lnt">6034
</span><span class="lnt">6035
</span><span class="lnt">6036
</span><span class="lnt">6037
</span><span class="lnt">6038
</span><span class="lnt">6039
</span><span class="lnt">6040
</span><span class="lnt">6041
</span><span class="lnt">6042
</span><span class="lnt">6043
</span><span class="lnt">6044
</span><span class="lnt">6045
</span><span class="lnt">6046
</span><span class="lnt">6047
</span><span class="lnt">6048
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Grabs a batch of goroutines from _p_&#39;s runnable queue into batch.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Batch is a ring buffer starting at batchHead.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Returns number of grabbed goroutines.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Can be executed by any P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">runqgrab</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">batch</span> <span class="o">*</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span><span class="nx">guintptr</span><span class="p">,</span> <span class="nx">batchHead</span> <span class="kt">uint32</span><span class="p">,</span> <span class="nx">stealRunNextG</span> <span class="kt">bool</span><span class="p">)</span> <span class="kt">uint32</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å·å–goroutineçš„ä»£ç é‡‡ç”¨çš„æ˜¯è‡ªæ—‹æ–¹å¼ï¼Œè€Œæ²¡æœ‰é‡‡ç”¨é”æ¥å®ç°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// _p_ æ˜¯ p2ï¼Œä¹‹æ‰€ä»¥éœ€è¦åŸå­è¯»å–å› ä¸ºp2æ­£åœ¨è¿è¡Œæœ‰å¹¶å‘çš„å¯èƒ½ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">h</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadAcq</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqhead</span><span class="p">)</span> <span class="c1">// load-acquire, synchronize with other consumers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">t</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadAcq</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqtail</span><span class="p">)</span> <span class="c1">// load-acquire, synchronize with the producer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä¸ºä»€ä¹ˆä¸æ‹…å¿ƒ runqtail æº¢å‡ºï¼Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  å› ä¸ºï¼Œrunqtailå’Œrunqheadéƒ½æ˜¯uint32ç±»å‹ï¼Œå°±ç®—æº¢å‡ºä¹Ÿèƒ½ä¿è¯è®¡ç®—æ­£ç¡®ã€‚æ¯”å¦‚ 0 - 3 ä¹Ÿèƒ½å¾—åˆ°æ­£ç¡®å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">n</span> <span class="o">:=</span> <span class="nx">t</span> <span class="o">-</span> <span class="nx">h</span>
</span></span><span class="line"><span class="cl">        <span class="nx">n</span> <span class="p">=</span> <span class="nx">n</span> <span class="o">-</span> <span class="nx">n</span><span class="o">/</span><span class="mi">2</span> <span class="c1">// è®¡ç®—å·å–çš„æ•°é‡ï¼Œä¸ºå½“å‰å®¹é‡çš„ä¸€åŠã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// p2 ä¸­æœ¬åœ°runqæ± ä¸­æ²¡æœ‰goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// p2æœ¬åœ°runqæ± ä¸ºç©ºï¼Œå°è¯•å» runnext è·å–goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">stealRunNextG</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Try to steal from _p_.runnext.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// å°è¯•ä» _p_.runnext ä¸­å·å–ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">next</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runnext</span><span class="p">;</span> <span class="nx">next</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// _p_.runnext ä¸Šæœ‰goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="nx">_Prunning</span> <span class="p">{</span> <span class="c1">// å½“å‰Pæ­£åœ¨è¿è¡Œä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// Sleep to ensure that _p_ isn&#39;t about to run the g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// we are about to steal.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// The important use case here is when the g running
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// on _p_ ready()s another g and then almost
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// immediately blocks. Instead of stealing runnext
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// in this window, back off to give _p_ a chance to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// schedule runnext. This will avoid thrashing gs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// between different Ps.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// A sync chan send/recv takes ~50ns as of time of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// writing, so 3us gives ~50x overshoot.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// Sleep å·²ç¡®ä¿ _p_ ä¸ä¼šè¿è¡Œæˆ‘ä»¬å°†è¦åˆ‡å–çš„gã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// è¿™é‡Œçš„é‡è¦ç”¨ä¾‹æ˜¯å½“ g åœ¨ _p_ ready() ä¸Šè¿è¡Œæ—¶ï¼Œå¦ä¸€ä¸ª g ç„¶åå‡ ä¹ç«‹å³é˜»å¡ã€‚ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// ä¸è¦åœ¨è¿™ä¸ªçª—å£æœŸåˆ‡å– runnextï¼Œè€Œæ˜¯é€€è€Œæ±‚å…¶æ¬¡ï¼Œè®©_p_æœ‰æœºä¼šè°ƒåº¦runnextã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// è¿™å°†é¿å…gåœ¨ä¸åŒçš„Psä¹‹é—´çš„æŠ–åŠ¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// sync chan çš„ send/recv å¤§çº¦éœ€è¦ ~50nsï¼Œæ‰€ä»¥ç»™å‡º 3us å¤§çº¦æ˜¯å®ƒçš„ 50x å€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="k">if</span> <span class="nx">GOOS</span> <span class="o">!=</span> <span class="s">&#34;windows&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">GOOS</span> <span class="o">!=</span> <span class="s">&#34;openbsd&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">GOOS</span> <span class="o">!=</span> <span class="s">&#34;netbsd&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="nf">usleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="c1">// sleep 3us
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="c1">// On some platforms system timer granularity is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="c1">// 1-15ms, which is way too much for this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="c1">// optimization. So just yield.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="c1">// åœ¨æŸäº›å¹³å°ä¸Šï¼Œç³»ç»Ÿè®¡æ—¶å™¨ç²’åº¦ä¸º1-15msï¼Œè¿™å¯¹äºè¿™ç§ä¼˜åŒ–æ¥è¯´å¤ªè¿‡äº†ã€‚æ‰€ä»¥å°±å±ˆæœå§ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                            <span class="nf">osyield</span><span class="p">()</span> <span class="c1">// åœ¨semaphoreä¸­æœ‰ç›¸å…³çš„ä»‹ç»ã€‚ä¼šå°è¯•è®©å‡ºCPUï¼Œè®©å…¶ä»–ä¼˜å…ˆçº§æ›´é«˜çš„çº¿ç¨‹æ‰§è¡Œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// CAS æ“ä½œäº¤æ¢ _p_.runnext å°è¯•å·å– goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// å¤§æ¦‚ç‡ä¼šå¤±è´¥ä»è¿™é‡Œç›´æ¥é€€å‡ºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="p">!</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runnext</span><span class="p">.</span><span class="nf">cas</span><span class="p">(</span><span class="nx">next</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// å·å–åˆ°goroutineæŠŠå®ƒæ”¾å…¥Pçš„æœ¬åœ°runqæ± ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nx">batch</span><span class="p">[</span><span class="nx">batchHead</span><span class="o">%</span><span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">batch</span><span class="p">))]</span> <span class="p">=</span> <span class="nx">next</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// è¯»å–ä¸ä¸€è‡´çš„ h å’Œ t å€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  å°ç»†èŠ‚ï¼šæŒ‰ç†è¯´é˜Ÿåˆ—ä¸­çš„goroutineä¸ªæ•°æœ€å¤šå°±æ˜¯len(_p_.runq)ï¼Œæ‰€ä»¥nçš„æœ€å¤§å€¼ä¹Ÿå°±æ˜¯len(_p_.runq)/2ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// é‚£ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªåˆ¤æ–­å‘¢ï¼Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 	åŸå› ï¼šè¯»å–runqheadå’Œrunqtailæ˜¯ä¸¤ä¸ªæ“ä½œè€Œéä¸€ä¸ªåŸå­æ“ä½œï¼Œå½“æˆ‘ä»¬è¯»å–runqheadä¹‹åä½†è¿˜æœªè¯»å–runqtailä¹‹å‰ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹å¿«é€Ÿçš„åœ¨å¢åŠ ï¼ˆè¿™æ˜¯å®Œå…¨æœ‰å¯èƒ½çš„ï¼Œå…¶å®ƒå·å–è€…ä»é˜Ÿåˆ—ä¸­å·å–goroutineä¼šå¢åŠ runqheadï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è€Œé˜Ÿåˆ—çš„æ‰€æœ‰è€…å¾€é˜Ÿåˆ—ä¸­æ·»åŠ goroutineä¼š å¢åŠ runqtailï¼‰è¿™ä¸¤ä¸ªå€¼ï¼Œåˆ™ä¼šå¯¼è‡´æˆ‘ä»¬è¯»å–å‡ºæ¥çš„runqtailå·²ç»è¿œè¿œå¤§äº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æˆ‘ä»¬ä¹‹å‰è¯»å–å‡ºæ¥æ”¾åœ¨å±€éƒ¨å˜é‡hé‡Œé¢çš„runqheadäº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä¹Ÿå°±æ˜¯ä»£ç æ³¨é‡Šä¸­æ‰€è¯´çš„hå’Œtå·²ç»ä¸ä¸€è‡´äº†ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è¿™ä¸ªifåˆ¤æ–­æ¥æ£€æµ‹å¼‚å¸¸æƒ…å†µã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å¦‚æœ n &gt; uint32(len(_p_.runq)/2) æˆç«‹è¯´æ˜åœ¨t := atomic.LoadAcq(&amp;_p_.runqtail)ä»£ç årunqtailå‘ç”Ÿäº†å˜åŒ–ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// read inconsistent h and t
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä»p2ä¸­æ‹·è´goroutineåˆ°pçš„runqæœ¬åœ°æ± 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">g</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">[(</span><span class="nx">h</span><span class="o">+</span><span class="nx">i</span><span class="p">)</span><span class="o">%</span><span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">))]</span> <span class="c1">// ä»p2çš„hå¤„å¾€åå–goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">batch</span><span class="p">[(</span><span class="nx">batchHead</span><span class="o">+</span><span class="nx">i</span><span class="p">)</span><span class="o">%</span><span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">batch</span><span class="p">))]</span> <span class="p">=</span> <span class="nx">g</span><span class="c1">// ä»p.runqtailå¾€åæœ€åŠ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// CAS åŸå­äº¤æ¢ p2.runqhead ä» h ä¿®æ”¹ä¸º h+nï¼Œå¦‚æœå¤±è´¥è¯´æ˜hè¢«ä¿®æ”¹äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  1. å¯èƒ½å…¶ä»–Pä¹Ÿåœ¨å·å–è¿™ä¸ªPçš„goroutineå¹¶ä¸”å·å–æˆåŠŸäº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  2. å½“å‰è¢«å·å–çš„è¿™ä¸ªPå¯èƒ½ä¹Ÿåœ¨å–runqheadå‡ºçš„goroutineæ¥è¿è¡Œã€‚å¯¼è‡´runqheadå˜åŒ–ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä¸ºä»€ä¹ˆä¸æ‹…å¿ƒ runqtail çš„å€¼å‘¢ï¼Ÿè€Œæ˜¯åªéœ€è¦ä¿è¯ runqhead å’Œ runqtail ä¸€èµ·æ˜¯åŸå­çš„å‘¢ï¼Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  å› ä¸ºï¼Œrunqtail åªæœ‰å½“å‰Pæ­£æœ€åŠ ï¼Œå¹¶ä¸”æ˜¯é€’å¢çš„ï¼Œèƒ½ä¿è¯æˆ‘ä»¬è¦å»çš„æ•°æ®nã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">CasRel</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqhead</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">h</span><span class="o">+</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// cas-release, commits consume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

<p><details >
  <summary markdown="span">type randomOrder struct</summary>
  <blockquote>
<ol>
<li><code>stealOrder</code>ç”¨æ¥å®ç°ä¸€ä¸ªå…¬å¹³çš„éšæœºçªƒå–é¡ºåºã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// å…³äºå–På¾—ç®—æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">stealOrder</span> <span class="nx">randomOrder</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// randomOrder/randomEnum are helper types for randomized work stealing.
</span></span></span><span class="line"><span class="cl"><span class="c1">// They allow to enumerate all Ps in different pseudo-random orders without repetitions.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The algorithm is based on the fact that if we have X such that X and GOMAXPROCS
</span></span></span><span class="line"><span class="cl"><span class="c1">// are coprime, then a sequences of (i + X) % GOMAXPROCS gives the required enumeration.
</span></span></span><span class="line"><span class="cl"><span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1">// randomOrder/randomEnum æ˜¯éšæœºå·¥ä½œçªƒå–çš„è¾…åŠ©ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1">// å®ƒä»¬å…è®¸ä»¥ä¸åŒçš„ä¼ªéšæœºé¡ºåºæšä¸¾æ‰€æœ‰ P è€Œä¸é‡å¤
</span></span></span><span class="line"><span class="cl"><span class="c1">// è¯¥ç®—æ³•åŸºäºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1">//    å¦‚æœæˆ‘ä»¬æœ‰ X ä½¿å¾— X å’Œ GOMAXPROCS äº’è´¨ï¼Œé‚£ä¹ˆ (i + X) %GOMAXPROCS çš„åºåˆ—ç»™å‡ºæ‰€éœ€çš„æšä¸¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">randomOrder</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">count</span>    <span class="kt">uint32</span>       <span class="c1">// å­˜å‚¨å½“å‰æ‰€æœ‰çš„Pæ•°é‡ï¼Œä¹Ÿæ˜¯CPUçš„æ ¸æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">coprimes</span> <span class="p">[]</span><span class="kt">uint32</span>     <span class="c1">// å­˜å‚¨ä¸countäº’è´¨æ•°é›†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">randomEnum</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">i</span>     <span class="kt">uint32</span>  <span class="c1">// ä»0å¼€å§‹è®°å½•éå†çš„æ¬¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">count</span> <span class="kt">uint32</span>  <span class="c1">// randomOrder.count
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">pos</span>   <span class="kt">uint32</span>  <span class="c1">// å½“å‰åœ¨[0, count-1]èŒƒå›´çš„ä¸‹æ ‡ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">inc</span>   <span class="kt">uint32</span>  <span class="c1">// å½“å‰åœ¨randomOrder.coprimesä¸­é€‰å–çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// é‡ç½®randomOrder
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ord</span> <span class="o">*</span><span class="nx">randomOrder</span><span class="p">)</span> <span class="nf">reset</span><span class="p">(</span><span class="nx">count</span> <span class="kt">uint32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ord</span><span class="p">.</span><span class="nx">count</span> <span class="p">=</span> <span class="nx">count</span>	                <span class="c1">// è®°å½•æ€»ä¸ªæ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ord</span><span class="p">.</span><span class="nx">coprimes</span> <span class="p">=</span> <span class="nx">ord</span><span class="p">.</span><span class="nx">coprimes</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span>   <span class="c1">// æ¸…ç©ºcoprimes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">count</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nf">gcd</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ord</span><span class="p">.</span><span class="nx">coprimes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">ord</span><span class="p">.</span><span class="nx">coprimes</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ç”Ÿæˆäº’è´¨æ•°å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">gcd</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">uint32</span><span class="p">)</span> <span class="kt">uint32</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">b</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span><span class="o">%</span><span class="nx">b</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">a</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// å¼€å§‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ord</span> <span class="o">*</span><span class="nx">randomOrder</span><span class="p">)</span> <span class="nf">start</span><span class="p">(</span><span class="nx">i</span> <span class="kt">uint32</span><span class="p">)</span> <span class="nx">randomEnum</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">randomEnum</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">count</span><span class="p">:</span> <span class="nx">ord</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pos</span><span class="p">:</span>   <span class="nx">i</span> <span class="o">%</span> <span class="nx">ord</span><span class="p">.</span><span class="nx">count</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">inc</span><span class="p">:</span>   <span class="nx">ord</span><span class="p">.</span><span class="nx">coprimes</span><span class="p">[</span><span class="nx">i</span><span class="o">%</span><span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">ord</span><span class="p">.</span><span class="nx">coprimes</span><span class="p">))],</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// å½“å‰æ˜¯å¦éå†ä¸€åœˆäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">enum</span> <span class="o">*</span><span class="nx">randomEnum</span><span class="p">)</span> <span class="nf">done</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">enum</span><span class="p">.</span><span class="nx">i</span> <span class="o">==</span> <span class="nx">enum</span><span class="p">.</span><span class="nx">count</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ä¸‹ä¸€ä¸ªäº’è´¨æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">enum</span> <span class="o">*</span><span class="nx">randomEnum</span><span class="p">)</span> <span class="nf">next</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">enum</span><span class="p">.</span><span class="nx">i</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="nx">enum</span><span class="p">.</span><span class="nx">pos</span> <span class="p">=</span> <span class="p">(</span><span class="nx">enum</span><span class="p">.</span><span class="nx">pos</span> <span class="o">+</span> <span class="nx">enum</span><span class="p">.</span><span class="nx">inc</span><span class="p">)</span> <span class="o">%</span> <span class="nx">enum</span><span class="p">.</span><span class="nx">count</span>	<span class="c1">// è¿™é‡Œæ˜¯éšæœºçš„é€‰å–ä¸‹ä¸€ä¸ªéšæœºå¤„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// è·å–å½“å‰ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">enum</span> <span class="o">*</span><span class="nx">randomEnum</span><span class="p">)</span> <span class="nf">position</span><span class="p">()</span> <span class="kt">uint32</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">enum</span><span class="p">.</span><span class="nx">pos</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ç›—å–ç®—æ³•è§£é‡Š
</span></span></span><span class="line"><span class="cl"><span class="c1">//  1. ç›—å–è¿‡ç¨‹ç”¨äº†ä¸¤ä¸ªåµŒå¥—forå¾ªç¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">//  2. å†…å±‚å¾ªç¯å®ç°äº†ç›—å–é€»è¾‘ï¼Œä»ä»£ç å¯ä»¥çœ‹å‡ºç›—å–çš„å®è´¨å°±æ˜¯éå†allpä¸­çš„æ‰€æœ‰pï¼ŒæŸ¥çœ‹å…¶è¿è¡Œé˜Ÿåˆ—æ˜¯å¦æœ‰goroutineï¼Œå¦‚æœæœ‰ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1">//     åˆ™å–å…¶ä¸€åŠåˆ°å½“å‰å·¥ä½œçº¿ç¨‹çš„è¿è¡Œé˜Ÿåˆ—ï¼Œç„¶åä»findrunnableè¿”å›ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç»§ç»­éå†ä¸‹ä¸€ä¸ªp
</span></span></span><span class="line"><span class="cl"><span class="c1">//  3. ä½†è¿™é‡Œä¸ºäº†ä¿è¯å…¬å¹³æ€§ï¼Œéå†allpæ—¶å¹¶ä¸æ˜¯å›ºå®šçš„ä»allp[0]å³ç¬¬ä¸€ä¸ªpå¼€å§‹ï¼Œè€Œæ˜¯ä»éšæœºä½ç½®ä¸Šçš„på¼€å§‹ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1">//     è€Œä¸”éå†çš„é¡ºåºä¹ŸéšæœºåŒ–äº†ï¼Œå¹¶ä¸æ˜¯ç°åœ¨è®¿é—®äº†ç¬¬iä¸ªpä¸‹ä¸€æ¬¡å°±è®¿é—®ç¬¬i+1ä¸ªpï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1">//     è€Œæ˜¯ä½¿ç”¨äº†ä¸€ç§ä¼ªéšæœºçš„æ–¹å¼éå†allpä¸­çš„æ¯ä¸ªpï¼Œé˜²æ­¢æ¯æ¬¡éå†æ—¶ä½¿ç”¨åŒæ ·çš„é¡ºåºè®¿é—®allpä¸­çš„å…ƒç´ 
</span></span></span><span class="line"><span class="cl"><span class="c1">// ä¸‹é¢æ˜¯è¿™ä¸ªç®—æ³•çš„ä¼ªä»£ç ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1">// offset := uint32(random()) % nprocs
</span></span></span><span class="line"><span class="cl"><span class="c1">// coprime := éšæœºé€‰å–ä¸€ä¸ªå°äºnprocsä¸”ä¸nprocsäº’è´¨çš„æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1">// for i := 0; i &lt; nprocs; i++ {
</span></span></span><span class="line"><span class="cl"><span class="c1">//     p := allp[offset]
</span></span></span><span class="line"><span class="cl"><span class="c1">//     ä»pçš„è¿è¡Œé˜Ÿåˆ—å·å–goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1">//     if å·å–æˆåŠŸ {
</span></span></span><span class="line"><span class="cl"><span class="c1">//         break
</span></span></span><span class="line"><span class="cl"><span class="c1">//     }
</span></span></span><span class="line"><span class="cl"><span class="c1">//     offset += coprime
</span></span></span><span class="line"><span class="cl"><span class="c1">//     offset = offset % nprocs
</span></span></span><span class="line"><span class="cl"><span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// ä¸‹é¢ä¸¾ä¾‹è¯´æ˜ä¸€ä¸‹ä¸Šè¿°ç®—æ³•è¿‡ç¨‹ï¼Œç°å‡è®¾nprocsä¸º8ï¼Œä¹Ÿå°±æ˜¯ä¸€å…±æœ‰8ä¸ªp
</span></span></span><span class="line"><span class="cl"><span class="c1">//    å¦‚æœç¬¬ä¸€æ¬¡éšæœºé€‰æ‹©çš„offset = 6ï¼Œcoprime = 3(3ä¸8äº’è´¨ï¼Œæ»¡è¶³ç®—æ³•è¦æ±‚)çš„è¯ï¼Œåˆ™ä»allpåˆ‡ç‰‡ä¸­å·å–çš„ä¸‹æ ‡é¡ºåºä¸º
</span></span></span><span class="line"><span class="cl"><span class="c1">//    6, 1, 4, 7, 2, 5, 0, 3ï¼Œè®¡ç®—è¿‡ç¨‹ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1">//        6ï¼Œ(6+3)%8=1ï¼Œ(1+3)%8=4, (4+3)%8=7, (7+3)%8=2, (2+3)%8=5, (5+3)%8=0, (0+3)%8=3
</span></span></span><span class="line"><span class="cl"><span class="c1">//  å¦‚æœç¬¬äºŒæ¬¡éšæœºé€‰æ‹©çš„offset = 4ï¼Œcoprime = 5çš„è¯ï¼Œåˆ™ä»allpåˆ‡ç‰‡ä¸­å·å–çš„ä¸‹æ ‡é¡ºåºä¸º
</span></span></span><span class="line"><span class="cl"><span class="c1">//    1, 6, 3, 0, 5, 2, 7, 4ï¼Œè®¡ç®—è¿‡ç¨‹ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1">//        1ï¼Œ(1+5)%8=6ï¼Œ(6+5)%8=3, (3+5)%8=0, (0+5)%8=5, (5+5)%8=2, (2+5)%8=7, (7+5)%8=4
</span></span></span></code></pre></div></blockquote>
<pre tabindex="0"><code></code></pre>
</details></p>

<h3 id="releasep-1">releasep()<a hidden class="anchor" aria-hidden="true" href="#releasep-1">#</a></h3>
<ol>
<li>è§£é™¤å½“å‰<code>M</code>å’Œ<code>P</code>çš„ç»‘å®šå…³ç³»ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">4984
</span><span class="lnt">4985
</span><span class="lnt">4986
</span><span class="lnt">4987
</span><span class="lnt">4988
</span><span class="lnt">4989
</span><span class="lnt">4990
</span><span class="lnt">4991
</span><span class="lnt">4992
</span><span class="lnt">4993
</span><span class="lnt">4994
</span><span class="lnt">4995
</span><span class="lnt">4996
</span><span class="lnt">4997
</span><span class="lnt">4998
</span><span class="lnt">4999
</span><span class="lnt">5000
</span><span class="lnt">5001
</span><span class="lnt">5002
</span><span class="lnt">5003
</span><span class="lnt">5004
</span><span class="lnt">5005
</span><span class="lnt">5006
</span><span class="lnt">5007
</span><span class="lnt">5008
</span><span class="lnt">5009
</span><span class="lnt">5010
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Disassociate p and the current m.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">releasep</span><span class="p">()</span> <span class="o">*</span><span class="nx">p</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// è·å–å½“å‰è¿è¡Œçš„gï¼Œè¿™é‡Œæ˜¯g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// å½“å‰è¦è§£ç»‘çš„Pä¸å­˜åœ¨ï¼Œç³»ç»Ÿä»£ç æœ‰é€»è¾‘é—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;releasep: invalid arg&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_p_</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span> <span class="c1">// è·å–å½“å‰å·¥ä½œçº¿ç¨‹Mç»‘å®šçš„Pï¼Œä¹Ÿå°±æ˜¯éœ€è¦è§£ç»‘çš„P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _Prunning è¡¨ç¤º P ç”± M æ‹¥æœ‰å¹¶ç”¨äºè¿è¡Œç”¨æˆ·ä»£ç æˆ–è°ƒåº¦ç¨‹åº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åªæœ‰æ‹¥æœ‰è¿™ä¸ª P çš„ M æ‰å…è®¸ä» _Prunning æ›´æ”¹ P çš„çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// M å¯ä»¥å°† P è½¬æ¢ä¸º _Pidleï¼ˆå¦‚æœå®ƒæ²¡æœ‰æ›´å¤šå·¥ä½œè¦åšï¼‰ã€_Psyscallï¼ˆå½“è¿›å…¥ç³»ç»Ÿè°ƒç”¨æ—¶ï¼‰æˆ– _Pgcstopï¼ˆåœæ­¢ GCï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// M ä¹Ÿå¯ä»¥å°† P çš„æ‰€æœ‰æƒç›´æ¥äº¤ç»™å¦ä¸€ä¸ª Mï¼ˆä¾‹å¦‚ï¼Œå®‰æ’é”å®šçš„ Gï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span> <span class="o">||</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="nx">_Prunning</span> <span class="p">{</span> <span class="c1">// å½“å‰Pç»‘å®šçš„mä¸gç»‘å®šçš„mä¸æ˜¯åŒä¸€ä¸ª æˆ– å½“å‰Pä¸æ˜¯_PrunningçŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;releasep: m=&#34;</span><span class="p">,</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span> <span class="s">&#34; m-&gt;p=&#34;</span><span class="p">,</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">(),</span> <span class="s">&#34; p-&gt;m=&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">),</span> <span class="s">&#34; p-&gt;status=&#34;</span><span class="p">,</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;releasep: invalid p state&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceProcStop</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="p">=</span> <span class="mi">0</span>		<span class="c1">// è§£ç»‘å·¥ä½œçº¿ç¨‹Mä¸Pçš„å…³è”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span> <span class="p">=</span> <span class="mi">0</span>		<span class="c1">// è§£ç»‘Pä¸Mçš„å…³è”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _Pidle è¡¨ç¤º P æœªç”¨äºè¿è¡Œç”¨æˆ·ä»£ç æˆ–è°ƒåº¦ç¨‹åº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é€šå¸¸ï¼Œå®ƒä½äºç©ºé—² P åˆ—è¡¨ä¸­å¹¶ä¸”å¯ä¾›è°ƒåº¦ç¨‹åºä½¿ç”¨ï¼Œä½†å®ƒå¯èƒ½åªæ˜¯åœ¨å…¶ä»–çŠ¶æ€ä¹‹é—´è½¬æ¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// P ç”±ç©ºé—²åˆ—è¡¨æˆ–æ­£åœ¨è½¬æ¢å…¶çŠ¶æ€çš„ä»»ä½•ä¸œè¥¿æ‹¥æœ‰ã€‚ å®ƒçš„è¿è¡Œé˜Ÿåˆ—æ˜¯ç©ºçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span> <span class="p">=</span> <span class="nx">_Pidle</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">_p_</span>	<span class="c1">// è¿”å›å½“å‰P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="pidleput">pidleput()<a hidden class="anchor" aria-hidden="true" href="#pidleput">#</a></h3>
<ol>
<li>pidleput å°†pæ”¾åˆ°_Pidleåˆ—è¡¨ä¸­ã€‚</li>
<li>è¿™é‡Šæ”¾äº†pçš„æ‰€æœ‰æƒã€‚ä¸€æ—¦sched.lockè¢«é‡Šæ”¾ï¼Œä½¿ç”¨på°±ä¸å†å®‰å…¨äº†ã€‚</li>
<li>sched.lockå¿…é¡»è¢«æŒæœ‰ï¼Œå¯ä»¥åœ¨STWæœŸé—´è¿è¡Œï¼Œå› æ­¤ä¸å…è®¸å†™å…¥å±éšœã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5696
</span><span class="lnt">5697
</span><span class="lnt">5698
</span><span class="lnt">5699
</span><span class="lnt">5700
</span><span class="lnt">5701
</span><span class="lnt">5702
</span><span class="lnt">5703
</span><span class="lnt">5704
</span><span class="lnt">5705
</span><span class="lnt">5706
</span><span class="lnt">5707
</span><span class="lnt">5708
</span><span class="lnt">5709
</span><span class="lnt">5710
</span><span class="lnt">5711
</span><span class="lnt">5712
</span><span class="lnt">5713
</span><span class="lnt">5714
</span><span class="lnt">5715
</span><span class="lnt">5716
</span><span class="lnt">5717
</span><span class="lnt">5718
</span><span class="lnt">5719
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pidleput puts p to on the _Pidle list.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// This releases ownership of p. Once sched.lock is released it is no longer
</span></span></span><span class="line"><span class="cl"><span class="c1">// safe to use p.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// May run during STW, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">pidleput</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ¤æ–­Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸åº”è¯¥è¿˜æœ‰goroutineï¼Œåˆ¤æ–­ä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nf">runqempty</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;pidleput: P has non-empty run queue&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœPæ²¡æœ‰timerï¼Œå°†æ¸…é™¤timerpMaskä½ä¸Šå¯¹åº”çš„æ©ç ä½ï¼ŒtimerpMaskæ˜¯è®°å½•å¿™ç¢Œçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">updateTimerPMask</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>   <span class="c1">// clear if there are no timers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">idlepMask</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>   <span class="c1">// è®¾ç½®idlepMaskå¯¹åº”çš„Pçš„æ©ç ä½ï¼ŒidlepMaskæ˜¯è®°å½•ç©ºé—²çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">link</span> <span class="p">=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">pidle</span>  <span class="c1">// å½“å‰Pè®°å½•å…¨å±€çš„ç©ºé—²é“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sched</span><span class="p">.</span><span class="nx">pidle</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>    <span class="c1">// æŠŠå½“å‰Pé“¾æ¥åˆ°å…¨å±€ç©ºé—²é“¾è¡¨å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä½¿ç”¨åŸå­é”æŠŠå½“å‰schedç©ºé—²çš„Pæ•°é‡åŠ 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">npidle</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// TODO: fast atomic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="runqempty">runqempty()<a hidden class="anchor" aria-hidden="true" href="#runqempty">#</a></h4>
<ol>
<li>runqempty æŠ¥å‘Š<code>_p_</code>åœ¨å…¶æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­æ˜¯å¦æ²¡æœ‰ Gsã€‚</li>
<li>å®ƒæ°¸è¿œä¸ä¼šè™šå‡åœ°è¿”å›trueã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5752
</span><span class="lnt">5753
</span><span class="lnt">5754
</span><span class="lnt">5755
</span><span class="lnt">5756
</span><span class="lnt">5757
</span><span class="lnt">5758
</span><span class="lnt">5759
</span><span class="lnt">5760
</span><span class="lnt">5761
</span><span class="lnt">5762
</span><span class="lnt">5763
</span><span class="lnt">5764
</span><span class="lnt">5765
</span><span class="lnt">5766
</span><span class="lnt">5767
</span><span class="lnt">5768
</span><span class="lnt">5769
</span><span class="lnt">5770
</span><span class="lnt">5771
</span><span class="lnt">5772
</span><span class="lnt">5773
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// runqempty reports whether _p_ has no Gs on its local run queue.
</span></span></span><span class="line"><span class="cl"><span class="c1">// It never returns true spuriously.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">runqempty</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Defend against a race where 1) _p_ has G1 in runqnext but runqhead == runqtail,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2) runqput on _p_ kicks G1 to the runq, 3) runqget on _p_ empties runqnext.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Simply observing that runqhead == runqtail and then observing that runqnext == nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// does not mean the queue is empty.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä»¥ä¸‹æƒ…å†µï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. _p_ åœ¨ runqnext ä¸­æœ‰ G1 ä½† runqhead == runqtail
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. _p_ ä¸Šçš„ runqput å°† G1 è¸¢åˆ° runq
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  3. _p_ ä¸Šçš„ runqget æ¸…ç©º runqnext
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç®€å•åœ°è§‚å¯Ÿ runqhead == runqtail ç„¶åè§‚å¯Ÿ runqnext == nil å¹¶ä¸æ„å‘³ç€é˜Ÿåˆ—æ˜¯ç©ºçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">head</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqhead</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">        <span class="nx">tail</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqtail</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">runnext</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Loaduintptr</span><span class="p">((</span><span class="o">*</span><span class="kt">uintptr</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runnext</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">tail</span> <span class="o">==</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqtail</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">head</span> <span class="o">==</span> <span class="nx">tail</span> <span class="o">&amp;&amp;</span> <span class="nx">runnext</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="pidleget">pidleget()<a hidden class="anchor" aria-hidden="true" href="#pidleget">#</a></h4>
<ol>
<li>ç›¸å…³è”å‡½æ•°pidlegetä»ç©ºé—²åˆ—è¡¨ä¸­è·å–ä¸€ä¸ªPã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5727
</span><span class="lnt">5728
</span><span class="lnt">5729
</span><span class="lnt">5730
</span><span class="lnt">5731
</span><span class="lnt">5732
</span><span class="lnt">5733
</span><span class="lnt">5734
</span><span class="lnt">5735
</span><span class="lnt">5736
</span><span class="lnt">5737
</span><span class="lnt">5738
</span><span class="lnt">5739
</span><span class="lnt">5740
</span><span class="lnt">5741
</span><span class="lnt">5742
</span><span class="lnt">5743
</span><span class="lnt">5744
</span><span class="lnt">5745
</span><span class="lnt">5746
</span><span class="lnt">5747
</span><span class="lnt">5748
</span><span class="lnt">5749
</span><span class="lnt">5750
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pidleget tries to get a p from the _Pidle list, acquiring ownership.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// May run during STW, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">pidleget</span><span class="p">(</span><span class="nx">now</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">_p_</span> <span class="o">:=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">pidle</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_p_</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Timer may get added at any time now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">now</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">now</span> <span class="p">=</span> <span class="nf">nanotime</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">timerpMask</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">idlepMask</span><span class="p">.</span><span class="nb">clear</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sched</span><span class="p">.</span><span class="nx">pidle</span> <span class="p">=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">link</span>
</span></span><span class="line"><span class="cl">        <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">npidle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_p_</span><span class="p">.</span><span class="nx">limiterEvent</span><span class="p">.</span><span class="nf">stop</span><span class="p">(</span><span class="nx">limiterEventIdle</span><span class="p">,</span> <span class="nx">now</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">_p_</span><span class="p">,</span> <span class="nx">now</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="checkrunqsnop">checkRunqsNoP()<a hidden class="anchor" aria-hidden="true" href="#checkrunqsnop">#</a></h3>
<ol>
<li>æ£€æŸ¥å¿«ç…§ä¸­æ‰€æœ‰çš„<code>P</code>æ˜¯å¦æœ‰å¯ä»¥å·å–çš„<code>G</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2974
</span><span class="lnt">2975
</span><span class="lnt">2976
</span><span class="lnt">2977
</span><span class="lnt">2978
</span><span class="lnt">2979
</span><span class="lnt">2980
</span><span class="lnt">2981
</span><span class="lnt">2982
</span><span class="lnt">2983
</span><span class="lnt">2984
</span><span class="lnt">2985
</span><span class="lnt">2986
</span><span class="lnt">2987
</span><span class="lnt">2988
</span><span class="lnt">2989
</span><span class="lnt">2990
</span><span class="lnt">2991
</span><span class="lnt">2992
</span><span class="lnt">2993
</span><span class="lnt">2994
</span><span class="lnt">2995
</span><span class="lnt">2996
</span><span class="lnt">2997
</span><span class="lnt">2998
</span><span class="lnt">2999
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Check all Ps for a runnable G to steal.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// On entry we have no P. If a G is available to steal and a P is available,
</span></span></span><span class="line"><span class="cl"><span class="c1">// the P is returned which the caller should acquire and attempt to steal the
</span></span></span><span class="line"><span class="cl"><span class="c1">// work to.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">checkRunqsNoP</span><span class="p">(</span><span class="nx">allpSnapshot</span> <span class="p">[]</span><span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">idlepMaskSnapshot</span> <span class="nx">pMask</span><span class="p">)</span> <span class="o">*</span><span class="nx">p</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å˜é‡allpçš„å¿«ç…§ï¼Œallpè®°å½•äº†æ‰€æœ‰çš„Påˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">p2</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">allpSnapshot</span> <span class="p">{</span>	<span class="c1">// ä¼‘çœ ä¹‹å‰åœ¨çœ‹ä¸€ä¸‹æ˜¯å¦æœ‰å·¥ä½œè¦åš
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// idlepMaskSnapshot å¿«ç…§è®°å½•ç€å½“å‰Pçš„çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// !idlepMaskSnapshot.read(uint32(id)) å½“å‰PçŠ¶æ€ä¸ä¸ºç©ºçš„ å¹¶ä¸” å½“å‰På­˜å‚¨groutineçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nx">idlepMaskSnapshot</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="nb">uint32</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nf">runqempty</span><span class="p">(</span><span class="nx">p2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">pp</span> <span class="o">:=</span> <span class="nf">pidleget</span><span class="p">()</span>	<span class="c1">// ä»ç©ºé—²çš„Pä¸­æ‹¿å»ä¸€ä¸ªPï¼Œä¸ºåç»­Mç»‘å®šPåšå‡†å¤‡ï¼Œå› ä¸ºæœ‰å…¨å±€çš„På­˜åœ¨gå¯ä»¥èµ·å»æ‹¿æ¥ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">pp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">pp</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Can&#39;t get a P, don&#39;t bother checking remaining Ps.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æ‹¿ä¸åˆ°Pï¼Œåˆ«è´¹å¿ƒæ£€æŸ¥å‰©ä½™çš„P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="checkidlegcnop">checkIdleGCNoP()<a hidden class="anchor" aria-hidden="true" href="#checkidlegcnop">#</a></h3>
<ol>
<li>æ£€æŸ¥æ˜¯å¦æœ‰GCéœ€è¦å¸®åŠ©ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">3013
</span><span class="lnt">3014
</span><span class="lnt">3015
</span><span class="lnt">3016
</span><span class="lnt">3017
</span><span class="lnt">3018
</span><span class="lnt">3019
</span><span class="lnt">3020
</span><span class="lnt">3021
</span><span class="lnt">3022
</span><span class="lnt">3023
</span><span class="lnt">3024
</span><span class="lnt">3025
</span><span class="lnt">3026
</span><span class="lnt">3027
</span><span class="lnt">3028
</span><span class="lnt">3029
</span><span class="lnt">3030
</span><span class="lnt">3031
</span><span class="lnt">3032
</span><span class="lnt">3033
</span><span class="lnt">3034
</span><span class="lnt">3035
</span><span class="lnt">3036
</span><span class="lnt">3037
</span><span class="lnt">3038
</span><span class="lnt">3039
</span><span class="lnt">3040
</span><span class="lnt">3041
</span><span class="lnt">3042
</span><span class="lnt">3043
</span><span class="lnt">3044
</span><span class="lnt">3045
</span><span class="lnt">3046
</span><span class="lnt">3047
</span><span class="lnt">3048
</span><span class="lnt">3049
</span><span class="lnt">3050
</span><span class="lnt">3051
</span><span class="lnt">3052
</span><span class="lnt">3053
</span><span class="lnt">3054
</span><span class="lnt">3055
</span><span class="lnt">3056
</span><span class="lnt">3057
</span><span class="lnt">3058
</span><span class="lnt">3059
</span><span class="lnt">3060
</span><span class="lnt">3061
</span><span class="lnt">3062
</span><span class="lnt">3063
</span><span class="lnt">3064
</span><span class="lnt">3065
</span><span class="lnt">3066
</span><span class="lnt">3067
</span><span class="lnt">3068
</span><span class="lnt">3069
</span><span class="lnt">3070
</span><span class="lnt">3071
</span><span class="lnt">3072
</span><span class="lnt">3073
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Check for idle-priority GC, without a P on entry.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// If some GC work, a P, and a worker G are all available, the P and G will be
</span></span></span><span class="line"><span class="cl"><span class="c1">// returned. The returned P has not been wired yet.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">checkIdleGCNoP</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// N.B. Since we have no P, gcBlackenEnabled may change at any time; we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// must check again after acquiring a P. As an optimization, we also check
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// if an idle mark worker is needed at all. This is OK here, because if we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// observe that one isn&#39;t needed, at least one is currently running. Even if
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// it stops running, its own journey into the scheduler should schedule it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// again, if need be (at which point, this check will pass, if relevant).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gcBlackenEnabled</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">!</span><span class="nx">gcController</span><span class="p">.</span><span class="nf">needIdleMarkWorker</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nf">gcMarkWorkAvailable</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Work is available; we can start an idle GC worker only if there is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// an available P and available worker G.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// We can attempt to acquire these in either order, though both have
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// synchronization concerns (see below). Workers are almost always
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// available (see comment in findRunnableGCWorker for the one case
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// there may be none). Since we&#39;re slightly less likely to find a P,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// check for that first.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Synchronization: note that we must hold sched.lock until we are
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// committed to keeping it. Otherwise we cannot put the unnecessary P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// back in sched.pidle without performing the full set of idle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// transition checks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// If we were to check gcBgMarkWorkerPool first, we must somehow handle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the assumption in gcControllerState.findRunnableGCWorker that an
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// empty gcBgMarkWorkerPool is only possible if gcMarkDone is running.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pp</span><span class="p">,</span> <span class="nx">now</span> <span class="o">:=</span> <span class="nf">pidlegetSpinning</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">pp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Now that we own a P, gcBlackenEnabled can&#39;t change (as it requires STW).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gcBlackenEnabled</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">!</span><span class="nx">gcController</span><span class="p">.</span><span class="nf">addIdleMarkWorker</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pidleput</span><span class="p">(</span><span class="nx">pp</span><span class="p">,</span> <span class="nx">now</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">node</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">gcBgMarkWorkerNode</span><span class="p">)(</span><span class="nx">gcBgMarkWorkerPool</span><span class="p">.</span><span class="nf">pop</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">node</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">pidleput</span><span class="p">(</span><span class="nx">pp</span><span class="p">,</span> <span class="nx">now</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gcController</span><span class="p">.</span><span class="nf">removeIdleMarkWorker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">pp</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">gp</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="checktimersnop">checkTimersNoP()<a hidden class="anchor" aria-hidden="true" href="#checktimersnop">#</a></h3>
<ol>
<li>æ£€æŸ¥å¿«ç…§ä¸­æ‰€æœ‰çš„Pæ˜¯å¦æœ‰timerè¦è§¦å‘äº†ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2997
</span><span class="lnt">2998
</span><span class="lnt">2999
</span><span class="lnt">3000
</span><span class="lnt">3001
</span><span class="lnt">3002
</span><span class="lnt">3003
</span><span class="lnt">3004
</span><span class="lnt">3005
</span><span class="lnt">3006
</span><span class="lnt">3007
</span><span class="lnt">3008
</span><span class="lnt">3009
</span><span class="lnt">3010
</span><span class="lnt">3011
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Check all Ps for a timer expiring sooner than pollUntil.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Returns updated pollUntil value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">checkTimersNoP</span><span class="p">(</span><span class="nx">allpSnapshot</span> <span class="p">[]</span><span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">timerpMaskSnapshot</span> <span class="nx">pMask</span><span class="p">,</span> <span class="nx">pollUntil</span> <span class="kt">int64</span><span class="p">)</span> <span class="kt">int64</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">p2</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">allpSnapshot</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">timerpMaskSnapshot</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="nb">uint32</span><span class="p">(</span><span class="nx">id</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">w</span> <span class="o">:=</span> <span class="nf">nobarrierWakeTime</span><span class="p">(</span><span class="nx">p2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">w</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">pollUntil</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">w</span> <span class="p">&lt;</span> <span class="nx">pollUntil</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">pollUntil</span> <span class="p">=</span> <span class="nx">w</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">pollUntil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="stopm-1">stopm()<a hidden class="anchor" aria-hidden="true" href="#stopm-1">#</a></h3>
<ol>
<li>å·¥ä½œçº¿ç¨‹è¿›å…¥ä¼‘çœ ï¼Œç­‰å¾…è¢«å…¶ä»–å·¥ä½œçº¿ç¨‹å”¤é†’ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2229
</span><span class="lnt">2230
</span><span class="lnt">2231
</span><span class="lnt">2232
</span><span class="lnt">2233
</span><span class="lnt">2234
</span><span class="lnt">2235
</span><span class="lnt">2236
</span><span class="lnt">2237
</span><span class="lnt">2238
</span><span class="lnt">2239
</span><span class="lnt">2240
</span><span class="lnt">2241
</span><span class="lnt">2242
</span><span class="lnt">2243
</span><span class="lnt">2244
</span><span class="lnt">2245
</span><span class="lnt">2246
</span><span class="lnt">2247
</span><span class="lnt">2248
</span><span class="lnt">2249
</span><span class="lnt">2250
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Stops execution of the current m until new work is available.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Returns with acquired P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">stopm</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>           <span class="c1">// è·å–å½“å‰å·¥ä½œçº¿ç¨‹Mç»‘å®šçš„g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">locks</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>   <span class="c1">// åˆ¤æ–­å½“å‰å·¥ä½œçº¿ç¨‹æ˜¯å¦æœ‰é”ä¸ºè§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;stopm holding locks&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>       <span class="c1">// åˆ¤æ–­å½“å‰å·¥ä½œçº¿ç¨‹æ˜¯å¦è¿˜ç»‘å®šäº†Pï¼Œå› ä¸ºå‰é¢Mä¸På·²ç»è§£ç»‘äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;stopm holding p&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">spinning</span> <span class="p">{</span>     <span class="c1">// åˆ¤æ–­å½“å‰å·¥ä½œçº¿ç¨‹æ˜¯å¦è¿˜å¤„äºè‡ªæ—‹çŠ¶æ€æ ‡è®°ï¼Œåº”ä¸ºå‰é¢å·²ç»å–æ¶ˆäº†è¯¥æ ‡è®°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;stopm spinning&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>       <span class="c1">// é”ä½å…¨å±€sched
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">mput</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span>             <span class="c1">// æŠŠmç»“æ„ä½“å¯¹è±¡æ”¾å…¥sched.midleç©ºé—²é˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>     <span class="c1">// è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">mPark</span><span class="p">()</span>                 <span class="c1">// è¿›å…¥ç³»ç»Ÿè°ƒç”¨è¿›å…¥ç¡çœ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">nextp</span><span class="p">.</span><span class="nf">ptr</span><span class="p">())</span> <span class="c1">// å·¥ä½œçº¿ç¨‹è¢«å”¤é†’åä»è¿™é‡Œå¼€å§‹æ‰§è¡Œï¼Œç»™Mç»‘å®šP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">nextp</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="mput-1">mput()<a hidden class="anchor" aria-hidden="true" href="#mput-1">#</a></h4>
<ol>
<li>å½“å·¥ä½œçº¿ç¨‹ç©ºé—²æ—¶å³å°†è¿›å…¥ä¼‘çœ çŠ¶æ€æ—¶ä¼šåˆ¤æ–­ä¸€æ¬¡<code>checkdead()</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5533
</span><span class="lnt">5534
</span><span class="lnt">5535
</span><span class="lnt">5536
</span><span class="lnt">5537
</span><span class="lnt">5538
</span><span class="lnt">5539
</span><span class="lnt">5540
</span><span class="lnt">5541
</span><span class="lnt">5542
</span><span class="lnt">5543
</span><span class="lnt">5544
</span><span class="lnt">5545
</span><span class="lnt">5546
</span><span class="lnt">5547
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Put mp on midle list.
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held.
</span></span></span><span class="line"><span class="cl"><span class="c1">// May run during STW, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mput</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span> <span class="c1">// æ£€æŸ¥sched.locké”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">schedlink</span> <span class="p">=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">midle</span>  <span class="c1">// å½“å‰Mè®°å½•å…¨å±€ç©ºé—²Mé“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sched</span><span class="p">.</span><span class="nx">midle</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>         <span class="c1">// æŠŠå½“å‰Mè¿½åŠ åˆ°å…¨å±€ç©ºé—²é“¾è¡¨ä¸­å»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sched</span><span class="p">.</span><span class="nx">nmidle</span><span class="o">++</span>              <span class="c1">// å…¨å±€ç©ºé—²Mæ•°é‡åŠ ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ£€æŸ¥æ­»é”æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ£€æŸ¥åŸºäºè¿è¡Œ M çš„æ•°é‡ï¼Œå¦‚æœ 0 -&gt; æ­»é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sched.lock å¿…é¡»è¢«æŒæœ‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">checkdead</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="mget">mget()<a hidden class="anchor" aria-hidden="true" href="#mget">#</a></h4>
<ol>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5547
</span><span class="lnt">5548
</span><span class="lnt">5549
</span><span class="lnt">5550
</span><span class="lnt">5551
</span><span class="lnt">5552
</span><span class="lnt">5553
</span><span class="lnt">5554
</span><span class="lnt">5555
</span><span class="lnt">5556
</span><span class="lnt">5557
</span><span class="lnt">5558
</span><span class="lnt">5559
</span><span class="lnt">5560
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Try to get an m from midle list.
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held.
</span></span></span><span class="line"><span class="cl"><span class="c1">// May run during STW, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mget</span><span class="p">()</span> <span class="o">*</span><span class="nx">m</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span> <span class="o">:=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">midle</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">mp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sched</span><span class="p">.</span><span class="nx">midle</span> <span class="p">=</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">schedlink</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sched</span><span class="p">.</span><span class="nx">nmidle</span><span class="o">--</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">mp</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="mpark-1">mPark()<a hidden class="anchor" aria-hidden="true" href="#mpark-1">#</a></h4>
<ol>
<li>ç¡çœ å‡½æ•°ï¼ŒmPark()å¯¼è‡´çº¿ç¨‹è‡ªè¡Œåœæ”¾ï¼Œä¸€æ—¦å”¤é†’å°±è¿”å›ã€‚</li>
<li><strong>stopmçš„æ ¸å¿ƒæ˜¯è°ƒç”¨mputæŠŠmç»“æ„ä½“å¯¹è±¡æ”¾å…¥schedçš„midleç©ºé—²é˜Ÿåˆ—ï¼Œç„¶åé€šè¿‡notesleep(&amp;m.park)å‡½æ•°è®©è‡ªå·±è¿›å…¥ç¡çœ çŠ¶æ€</strong>ã€‚</li>
<li><strong>noteæ˜¯go runtimeå®ç°çš„ä¸€æ¬¡æ€§ç¡çœ å’Œå”¤é†’æœºåˆ¶ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥é€šè¿‡è°ƒç”¨notesleep(*note)è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œè€Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹åˆ™å¯ä»¥é€šè¿‡notewakeup(*note)æŠŠå…¶å”¤é†’</strong>ã€‚</li>
<li><code>note</code>çš„åº•å±‚å®ç°æœºåˆ¶è·Ÿæ“ä½œç³»ç»Ÿç›¸å…³ï¼Œä¸åŒç³»ç»Ÿä½¿ç”¨ä¸åŒçš„æœºåˆ¶ï¼š
<ul>
<li>æ¯”å¦‚<code>linux</code>ä¸‹ä½¿ç”¨çš„<code>futex</code>ç³»ç»Ÿè°ƒç”¨ã€‚</li>
<li>è€Œ<code>mac</code>ä¸‹åˆ™æ˜¯ä½¿ç”¨çš„<code>pthread_cond_t</code>æ¡ä»¶å˜é‡ã€‚</li>
</ul>
</li>
<li><code>note</code>å¯¹è¿™äº›åº•å±‚æœºåˆ¶åšäº†ä¸€ä¸ªæŠ½è±¡å’Œå°è£…ï¼Œè¿™ç§å°è£…ç»™æ‰©å±•æ€§å¸¦æ¥äº†å¾ˆå¤§çš„å¥½å¤„ï¼Œæ¯”å¦‚å½“ç¡çœ å’Œå”¤é†’åŠŸèƒ½éœ€è¦æ”¯æŒæ–°å¹³å°æ—¶ï¼Œåªéœ€è¦åœ¨<code>note</code>å±‚å¢åŠ å¯¹ç‰¹å®šå¹³å°çš„æ”¯æŒå³å¯ï¼Œä¸éœ€è¦ä¿®æ”¹ä¸Šå±‚çš„ä»»ä½•ä»£ç ã€‚</li>
<li>å›åˆ°<code>stopm</code>ï¼Œå½“ä»<code>notesleep</code>å‡½æ•°è¿”å›åï¼Œéœ€è¦å†æ¬¡ç»‘å®šä¸€ä¸ª<code>p</code>ï¼Œç„¶åè¿”å›åˆ°<code>findrunnable</code>å‡½æ•°ç»§ç»­é‡æ–°å¯»æ‰¾å¯è¿è¡Œçš„<code>goroutine</code>ï¼Œä¸€æ—¦æ‰¾åˆ°å¯è¿è¡Œçš„<code>goroutine</code>å°±ä¼šè¿”å›åˆ°<code>schedule</code>å‡½æ•°ï¼Œå¹¶æŠŠæ‰¾åˆ°çš„<code>goroutine</code>è°ƒåº¦èµ·æ¥è¿è¡Œï¼Œå¦‚ä½•æŠŠ<code>goroutine</code>è°ƒåº¦èµ·æ¥è¿è¡Œçš„ä»£ç æˆ‘ä»¬å·²ç»åˆ†æè¿‡äº†ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1452
</span><span class="lnt">1453
</span><span class="lnt">1454
</span><span class="lnt">1455
</span><span class="lnt">1456
</span><span class="lnt">1457
</span><span class="lnt">1458
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// mPark causes a thread to park itself, returning once woken.
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mPark</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">notesleep</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">park</span><span class="p">)</span>   <span class="c1">// è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œè¿™é‡Œä¼ å…¥Mçš„parkï¼Œç¡çœ åœ¨è¿™ä¸ªä¸Šé¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">noteclear</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">park</span><span class="p">)</span>   <span class="c1">// è¢«å…¶ä»–å·¥ä½œçº¿ç¨‹å”¤é†’ï¼Œä»£ç ä»è¿™é‡Œå¼€å§‹æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="notesleep">notesleep()<a hidden class="anchor" aria-hidden="true" href="#notesleep">#</a></h4>
<ol>
<li>å®ç°ä¼‘çœ çš„å‡½æ•°ã€‚</li>
<li><code>notesleep</code>å‡½æ•°è°ƒç”¨<code>futexsleep</code>è¿›å…¥ç¡çœ ï¼Œè¿™é‡Œä¹‹æ‰€ä»¥éœ€è¦ç”¨ä¸€ä¸ªå¾ªç¯ï¼Œæ˜¯å› ä¸º<strong>futexsleepæœ‰å¯èƒ½æ„å¤–ä»ç¡çœ ä¸­è¿”å›</strong>ï¼Œæ‰€ä»¥ä»<code>futexsleep</code>å‡½æ•°è¿”å›åè¿˜éœ€è¦æ£€æŸ¥<code>note.key</code>æ˜¯å¦è¿˜æ˜¯0ã€‚</li>
<li>å¦‚æœæ˜¯0åˆ™è¡¨ç¤ºå¹¶ä¸æ˜¯å…¶å®ƒå·¥ä½œçº¿ç¨‹å”¤é†’äº†æˆ‘ä»¬ï¼Œåªæ˜¯<code>futexsleep</code>æ„å¤–è¿”å›äº†ï¼Œéœ€è¦å†æ¬¡è°ƒç”¨<code>futexsleep</code>è¿›å…¥ç¡çœ ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/lock_futex.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">notesleep</span><span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">note</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>    <span class="c1">// è·å–å½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„gï¼Œåº”è¯¥æ˜¯g0åœ¨è°ƒåº¦å¾ªç¯è¿‡ç¨‹ä¸­è¢«åˆ‡æ¢åˆ°g0äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gp</span> <span class="o">!=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">g0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;notesleep not on g0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ns</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1">// è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º-1ï¼Œè¡¨ç¤ºæ— é™æœŸç­‰å¾…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="o">*</span><span class="nx">cgo_yield</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Sleep for an arbitrary-but-moderate interval to poll libc interceptors.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä¼‘çœ ä¸€ä¸ªä»»æ„ä½†é€‚ä¸­çš„é—´éš”æ¥è½®è¯¢ libc æ‹¦æˆªå™¨cgoç›¸å…³çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">ns</span> <span class="p">=</span> <span class="mf">10e6</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä½¿ç”¨å¾ªç¯ï¼Œä¿è¯ä¸æ˜¯æ„å¤–è¢«å”¤é†’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="nf">key32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">n</span><span class="p">.</span><span class="nx">key</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">blocked</span> <span class="p">=</span> <span class="kc">true</span>                 <span class="c1">// blockedè¡¨ç¤ºMåœ¨å½“å‰çš„noteä¸Šè¢«å±è”½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">futexsleep</span><span class="p">(</span><span class="nf">key32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">n</span><span class="p">.</span><span class="nx">key</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ns</span><span class="p">)</span>    <span class="c1">// è¿›å…¥ä¼‘çœ å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">*</span><span class="nx">cgo_yield</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">asmcgocall</span><span class="p">(</span><span class="o">*</span><span class="nx">cgo_yield</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">blocked</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="futexsleep">futexsleep()<a hidden class="anchor" aria-hidden="true" href="#futexsleep">#</a></h4>
<ol>
<li>åŸå­çš„<code>if(*addr == val)</code>ä¼‘çœ ï¼Œå¯èƒ½ä¼šè¢«è™šå‡å”¤é†’ï¼› è¿™æ˜¯å…è®¸çš„ç¡çœ æ—¶é—´ä¸è¦è¶…è¿‡nsï¼›ns &lt; 0æ„å‘³ç€æ°¸è¿œã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/os_linux.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Atomically,
</span></span></span><span class="line"><span class="cl"><span class="c1">//	if(*addr == val) sleep
</span></span></span><span class="line"><span class="cl"><span class="c1">// Might be woken up spuriously; that&#39;s allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Don&#39;t sleep longer than ns; ns &lt; 0 means forever.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">futexsleep</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">uint32</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">uint32</span><span class="p">,</span> <span class="nx">ns</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Some Linux kernels have a bug where futex of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// FUTEX_WAIT returns an internal error code
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// as an errno. Libpthread ignores the return value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// here, and so can we: as it says a few lines up,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// spurious wakeups are allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸€äº› Linux å†…æ ¸å­˜åœ¨ä¸€ä¸ªé”™è¯¯ï¼Œå³ FUTEX_WAIT çš„ futex è¿”å›å†…éƒ¨é”™è¯¯ä»£ç ä½œä¸º errno
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Libpthread å¿½ç•¥äº†è¿™é‡Œçš„è¿”å›å€¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ï¼šæ­£å¦‚å®ƒæ‰€è¯´çš„å‡ è¡Œï¼Œè™šå‡å”¤é†’æ˜¯å…è®¸çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">ns</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>	<span class="c1">// æ°¸ä¹…ç¡çœ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">futex</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">addr</span><span class="p">),</span> <span class="nx">_FUTEX_WAIT_PRIVATE</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">ts</span> <span class="nx">timespec</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ts</span><span class="p">.</span><span class="nf">setNsec</span><span class="p">(</span><span class="nx">ns</span><span class="p">)</span>  <span class="c1">// è®¾ç½®æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">futex</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">addr</span><span class="p">),</span> <span class="nx">_FUTEX_WAIT_PRIVATE</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ts</span><span class="p">),</span> <span class="kc">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="futex">futex()<a hidden class="anchor" aria-hidden="true" href="#futex">#</a></h4>
<ol>
<li>å‡½æ•°åŸå‹ï¼š<code>func futex(addr unsafe.Pointer, op int32, val uint32, ts, addr2 unsafe.Pointer, val3 uint32) int32</code>ç”±æ±‡ç¼–å®ç°ã€‚</li>
<li><strong>futexç³»ç»Ÿè°ƒç”¨ä¸ºæˆ‘ä»¬æä¾›çš„åŠŸèƒ½ä¸ºå¦‚æœ<code>*addr == val</code>åˆ™è¿›å…¥ç¡çœ ï¼Œå¦åˆ™ç›´æ¥è¿”å›</strong>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/sys_linux_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1"># int64 futex(int32 *uaddr, int32 op, int32 val,
</span></span></span><span class="line"><span class="cl"><span class="c1">#	struct timespec *timeout, int32 *uaddr2, int32 val2);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">futex</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="p">,</span><span class="no">$0</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ä¸‹é¢çš„6æ¡æŒ‡ä»¤åœ¨ä¸ºfutexç³»ç»Ÿè°ƒç”¨å‡†å¤‡å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">addr</span><span class="err">+</span><span class="mi">0</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">DI</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">op</span><span class="err">+</span><span class="mi">8</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">SI</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">val</span><span class="err">+</span><span class="mi">12</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">DX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">ts</span><span class="err">+</span><span class="mi">16</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">R10</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">addr2</span><span class="err">+</span><span class="mi">24</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">R8</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">val3</span><span class="err">+</span><span class="mi">32</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">R9</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">$SYS_futex</span><span class="p">,</span> <span class="no">AX</span> <span class="c1"># ç³»ç»Ÿè°ƒç”¨ç¼–å·æ”¾å…¥AXå¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">SYSCALL</span> <span class="c1"># æ‰§è¡Œfutexç³»ç»Ÿè°ƒç”¨è¿›å…¥ç¡çœ ï¼Œä»ç¡çœ ä¸­è¢«å”¤é†’åæ¥ç€æ‰§è¡Œä¸‹ä¸€æ¡MOVLæŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVL</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">ret</span><span class="err">+</span><span class="mi">40</span><span class="p">(</span><span class="no">FP</span><span class="p">)</span> <span class="c1"># ä¿å­˜ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="execute-">execute() ğŸš€<a hidden class="anchor" aria-hidden="true" href="#execute-">#</a></h2>
<ol>
<li><code>gp</code>æ”¾åˆ°å½“å‰<code>M</code>ä¸Šå–è¿è¡Œã€‚è¯¥å‡½æ•°ä»<code>g0</code>æ ˆåˆ‡æ¢åˆ°æ™®é€š<code>goroutine</code>æ ˆä¸Šã€‚</li>
<li>å¦‚æœ<code>inheritTime</code>ä¸º<code>true</code>ï¼Œåˆ™<code>gp</code>å°†ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡ä¸­çš„å‰©ä½™æ—¶é—´ã€‚å¦åˆ™ï¼Œå®ƒå°†å¯åŠ¨ä¸€ä¸ªæ–°çš„æ—¶é—´ç‰‡ã€‚æ°¸è¿œä¸è¿”å›ã€‚</li>
<li>å†™å±éšœæ˜¯å…è®¸çš„ï¼Œå› ä¸ºè¿™æ˜¯åœ¨å‡ ä¸ªåœ°æ–¹è·å¾—<code>P</code>åç«‹å³è°ƒç”¨çš„ã€‚</li>
<li>å‚æ•°ï¼š
<ol>
<li><code>gp *g</code>ï¼šå½“å‰è°ƒåº¦çš„<code>goroutine</code>ã€‚</li>
<li><code>inheritTime bool</code>ï¼š<code>true</code>.ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡ï¼Œ<code>false</code>.ä¸ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡ã€‚</li>
</ol>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2508
</span><span class="lnt">2509
</span><span class="lnt">2510
</span><span class="lnt">2511
</span><span class="lnt">2512
</span><span class="lnt">2513
</span><span class="lnt">2514
</span><span class="lnt">2515
</span><span class="lnt">2516
</span><span class="lnt">2517
</span><span class="lnt">2518
</span><span class="lnt">2519
</span><span class="lnt">2520
</span><span class="lnt">2521
</span><span class="lnt">2522
</span><span class="lnt">2523
</span><span class="lnt">2524
</span><span class="lnt">2525
</span><span class="lnt">2526
</span><span class="lnt">2527
</span><span class="lnt">2528
</span><span class="lnt">2529
</span><span class="lnt">2530
</span><span class="lnt">2531
</span><span class="lnt">2532
</span><span class="lnt">2533
</span><span class="lnt">2534
</span><span class="lnt">2535
</span><span class="lnt">2536
</span><span class="lnt">2537
</span><span class="lnt">2538
</span><span class="lnt">2539
</span><span class="lnt">2540
</span><span class="lnt">2541
</span><span class="lnt">2542
</span><span class="lnt">2543
</span><span class="lnt">2544
</span><span class="lnt">2545
</span><span class="lnt">2546
</span><span class="lnt">2547
</span><span class="lnt">2548
</span><span class="lnt">2549
</span><span class="lnt">2550
</span><span class="lnt">2551
</span><span class="lnt">2552
</span><span class="lnt">2553
</span><span class="lnt">2554
</span><span class="lnt">2555
</span><span class="lnt">2556
</span><span class="lnt">2557
</span><span class="lnt">2558
</span><span class="lnt">2559
</span><span class="lnt">2560
</span><span class="lnt">2561
</span><span class="lnt">2562
</span><span class="lnt">2563
</span><span class="lnt">2564
</span><span class="lnt">2565
</span><span class="lnt">2566
</span><span class="lnt">2567
</span><span class="lnt">2568
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Schedules gp to run on the current M.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If inheritTime is true, gp inherits the remaining time in the
</span></span></span><span class="line"><span class="cl"><span class="c1">// current time slice. Otherwise, it starts a new time slice.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Never returns.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Write barriers are allowed because this is called immediately after
</span></span></span><span class="line"><span class="cl"><span class="c1">// acquiring a P in several places.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:yeswritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">execute</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">inheritTime</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰æ˜¯åœ¨ç³»ç»Ÿg0æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// _g_ = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">goroutineProfile</span><span class="p">.</span><span class="nx">active</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Make sure that gp has had its stack written out to the goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// profile, exactly as it was when the goroutine profiler first stopped
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// the world.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">tryRecordGoroutineProfile</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">osyield</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Assign gp.m before entering _Grunning so running Gs have an
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// M.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨è¾“å…¥_Grunningä¹‹å‰æŒ‡å®šgp.mï¼Œä»¥ä¾¿è¿è¡ŒGså…·æœ‰mã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">curg</span> <span class="p">=</span> <span class="nx">gp</span> <span class="c1">// m.curg = gp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span> <span class="p">=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span>    <span class="c1">// gp.m = m
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _Grunnableï¼šå®ƒå½“å‰æ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _Grunningï¼šè¡¨ç¤ºè¿™ä¸ªgoroutineå¯ä»¥æ‰§è¡Œç”¨æˆ·ä»£ç ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">)</span> <span class="c1">// ä¿®æ”¹å½“å‰gçš„çŠ¶æ€ä¸ºè¿è¡Œä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">waitsince</span> <span class="p">=</span> <span class="mi">0</span>    <span class="c1">// è®¾ç½®gè¢«é˜»å¡çš„å¤§çº¦æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æŠ¢å ä¿¡å·ï¼Œé‡å¤stackguard0 = stackpreempt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">preempt</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// const _StackGuard = 928; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è®¾ç½®å½“å‰gæ ˆæ‰©å®¹é˜ˆå€¼ç‚¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">+</span> <span class="nx">_StackGuard</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ˜¯å¦ç»§æ‰¿å½“å‰æ—¶é—´ç‰‡ã€‚å…·ä½“çš„æŠ¢å åœ¨sysmonç›‘æ§çº¿ç¨‹ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nx">inheritTime</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä¸ç»§æ‰¿ä¸Šä¸€ä¸ªæ—¶é—´ç‰‡æ—¶ï¼Œè°ƒåº¦æ¬¡æ•°ä¼šåŠ ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">schedtick</span><span class="o">++</span> <span class="c1">// è°ƒåº¦æ¬¡æ•°åŠ ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Check whether the profiler needs to be turned on or off.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ£€æŸ¥åˆ†æå™¨æ˜¯å¦éœ€è¦æ‰“å¼€æˆ–å…³é—­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">hz</span> <span class="o">:=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">profilehz</span> <span class="c1">// sched.profilehzï¼šç”¨æ¥è®¾ç½®æ€§èƒ½åˆ†æçš„é‡‡æ ·é¢‘ç‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">profilehz</span> <span class="o">!=</span> <span class="nx">hz</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">setThreadCPUProfiler</span><span class="p">(</span><span class="nx">hz</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// GoSysExit has to happen when we have a P, but before GoStart.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// So we emit it here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">syscallsp</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">sysblocktraced</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">traceGoSysExit</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">sysexitticks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceGoStart</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// gogoå®Œæˆä»g0åˆ°gpçœŸæ­£çš„åˆ‡æ¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">gogo</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="gogo">gogo()<a hidden class="anchor" aria-hidden="true" href="#gogo">#</a></h3>
<ol>
<li><code>gogo()</code>å‡½æ•°å®Œæˆä»<code>g0</code>åˆ°<code>gp</code>çš„çš„åˆ‡æ¢ï¼š<strong>CPUæ‰§è¡Œæƒçš„è½¬è®©ä»¥åŠæ ˆçš„åˆ‡æ¢</strong>ã€‚</li>
<li>å‡½æ•°åŸå‹ï¼š<code>func gogo(buf *gobuf)</code>ã€‚</li>
<li>å‚æ•°<code>buf *gobuf</code>ï¼šéœ€è¦åˆ‡æ¢çš„<code>goroutine</code>çš„è°ƒåº¦ä¿¡æ¯ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/asm_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1"># func gogo(buf *gobuf)
</span></span></span><span class="line"><span class="cl"><span class="c1"># restore state from Gobuf; longjmp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">gogo</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">NOSPLIT</span><span class="p">,</span> <span class="no">$0-8</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 1) å–å‡ºgobufä¿¡æ¯ï¼Œé‡Œé¢åŒ…å«éœ€è¦è°ƒåº¦çš„ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å–å‡ºéœ€è¦è°ƒåº¦çš„goroutineï¼Œgp.sched.gï¼Œåˆ¤æ–­è¿™ä¸ªgoroutineä¸ä¸ºnil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># executeå‡½æ•°åœ¨è°ƒç”¨gogoæ—¶æŠŠgpçš„schedæˆå‘˜çš„åœ°å€ä½œä¸ºå®å‚ï¼ˆå‹å‚bufï¼‰ä¼ é€’äº†è¿‡æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è¯¥å‚æ•°ä½äºFPå¯„å­˜å™¨æ‰€æŒ‡çš„ä½ç½®ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯è·å–å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># buf = &amp;gp.sched; BX = *gobuf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">buf</span><span class="err">+</span><span class="mi">0</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">BX</span> <span class="c1"># *gobuf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1"># æŠŠbufçš„å€¼ä¹Ÿå°±æ˜¯gp.schedçš„åœ°å€æ”¾åœ¨äº†BXå¯„å­˜å™¨ä¹‹ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è¿™æ ·ä¾¿äºåé¢çš„æŒ‡ä»¤ä¾é BXå¯„å­˜å™¨æ¥å­˜å–gp.schedçš„æˆå‘˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æ³¨æ„è¿™é‡Œæ˜¯é—´æ¥å¯»å€æ–¹å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># gobuf-&gt;g --&gt; dx register
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">gobuf_g</span><span class="p">(</span><span class="no">BX</span><span class="p">),</span> <span class="no">DX</span>	<span class="c1"># DX = gp.sched.g; *g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1"># ä¸‹é¢è¿™è¡Œä»£ç æ²¡æœ‰å®è´¨ä½œç”¨ï¼Œæ£€æŸ¥gp.sched.gæ˜¯å¦æ˜¯nilï¼Œå¦‚æœæ˜¯nilè¿›ç¨‹ä¼šcrashæ­»æ‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å¦‚æœDXä¸ºç©ºä½¿ç”¨0(DX)å½¢å¼ç®€ä»‹å¯»å€ä¼šæŠ¥é”™ã€‚ç¡®ä¿ g ä¸æ˜¯ nilã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">CX</span> <span class="c1"># make sure g != nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1"># 2) ä½¿ç”¨JMPæŒ‡ä»¤è·³è½¬åˆ°gogoå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JMP</span> <span class="no">gogo</span><span class="err">&lt;&gt;</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="c1"># æ³¨æ„è¿™é‡Œä½¿ç”¨çš„æ˜¯JMP
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">gogo</span><span class="err">&lt;&gt;</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">NOSPLIT</span><span class="p">,</span> <span class="no">$0</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 3) æŠŠgpæ”¾å…¥TLSä¸­å’ŒR14å¯„å­˜å™¨ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è·å–å½“å‰å·¥ä½œçº¿ç¨‹Mçš„fsæ®µåŸºå€ï¼Œå‰é¢æŠŠfsæ®µåŸºå€è®¾ç½®æˆäº†&amp;m.tls[1]çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">get_tls</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>         <span class="c1"># CX = &amp;m.tls[1] = TLS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æŠŠDXå€¼ä¹Ÿå°±æ˜¯éœ€è¦è¿è¡Œçš„goroutineçš„æŒ‡é’ˆå†™å…¥çº¿ç¨‹æœ¬åœ°å­˜å‚¨ä¹‹ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è¿è¡Œè¿™æ¡æŒ‡ä»¤ä¹‹å‰ï¼Œçº¿ç¨‹æœ¬åœ°å­˜å‚¨å­˜æ”¾çš„æ˜¯g0çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">DX</span><span class="p">,</span> <span class="no">g</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>   <span class="c1"># TLS = gp.sched.g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># åœ¨g1.17å’Œ1.18ç‰ˆæœ¬ä¸­ R14å¯„å­˜å™¨è¢«ç”¨æ¥æŒ‡å‘å½“å‰goroutineçš„runtime.gç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># R14 = gp.sched.g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">DX</span><span class="p">,</span> <span class="no">R14</span>     <span class="c1"># set the g register
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 4) è®¾ç½®æ ˆé¡¶SPå¯„å­˜å™¨ï¼Œåˆ‡gpçš„æ ˆï¼Œåˆ‡æ¢æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æŠŠCPUçš„SPå¯„å­˜å™¨è®¾ç½®ä¸ºsched.spï¼Œå®Œæˆäº†æ ˆçš„åˆ‡æ¢ï¼Œgp.sched.spè®°å½•ç€gçš„æ ˆé¡¶ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è®¾ç½®CPUçš„æ ˆé¡¶å¯„å­˜å™¨SPä¸ºgp.sched.spï¼Œè¿™æ¡æŒ‡ä»¤å®Œæˆäº†æ ˆçš„åˆ‡æ¢ï¼Œä»g0çš„æ ˆåˆ‡æ¢åˆ°äº†gpçš„æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># rsp = gp.sched.sp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">gobuf_sp</span><span class="p">(</span><span class="no">BX</span><span class="p">),</span> <span class="no">SP</span>    <span class="c1"># restore SP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 5) è®¾ç½® AX = gp.sched.ret
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#    è®¾ç½® DX = gp.sched.ctxt    é—­åŒ…ä¸Šä¸‹æ–‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#    è®¾ç½® BP = BP = gp.sched.bp æ ˆåº•å¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ä¸‹é¢ä¸‰æ¡åŒæ ·æ˜¯æ¢å¤è°ƒåº¦ä¸Šä¸‹æ–‡åˆ°CPUç›¸å…³å¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># éœ€è¦è¿”å›çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">gobuf_ret</span><span class="p">(</span><span class="no">BX</span><span class="p">),</span> <span class="no">AX</span>   <span class="c1"># AX = gp.sched.ret		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä¹Ÿå°±æ˜¯å½“å‰æ³¨å†Œå‡½æ•°çš„é—­åŒ…æ•è·å±‚ï¼Œfuncvalåœ°å€å¤„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">gobuf_ctxt</span><span class="p">(</span><span class="no">BX</span><span class="p">),</span> <span class="no">DX</span>  <span class="c1"># DX = gp.sched.ctxt	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è®¾ç½®æ ˆåŸºåœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">gobuf_bp</span><span class="p">(</span><span class="no">BX</span><span class="p">),</span> <span class="no">BP</span>    <span class="c1"># BP = gp.sched.bp		
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 6) æ¸…ç©ºgpçš„gobuf.spã€gobuf.retã€gobuf.ctxtã€gobuf.bp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># æ¸…ç©ºgp.schedä¸­ä¸å†éœ€è¦çš„å€¼ï¼Œå› ä¸ºæˆ‘ä»¬å·²æŠŠç›¸å…³å€¼æ”¾å…¥CPUå¯¹åº”çš„å¯„å­˜å™¨äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># clear to help garbage collector
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$0</span><span class="p">,</span> <span class="no">gobuf_sp</span><span class="p">(</span><span class="no">BX</span><span class="p">)</span>    <span class="c1"># g.gobuf.sp = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$0</span><span class="p">,</span> <span class="no">gobuf_ret</span><span class="p">(</span><span class="no">BX</span><span class="p">)</span>   <span class="c1"># g.gobuf.ret = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$0</span><span class="p">,</span> <span class="no">gobuf_ctxt</span><span class="p">(</span><span class="no">BX</span><span class="p">)</span>  <span class="c1"># g.gobuf.ctxt = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$0</span><span class="p">,</span> <span class="no">gobuf_bp</span><span class="p">(</span><span class="no">BX</span><span class="p">)</span>    <span class="c1"># g.gobuf.bp = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 7) è·³è½¬åˆ°g.gobuf.pcæ‰§è¡Œgpçš„ç›¸å…³ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æ³¨æ„ï¼šä»g0åˆ‡æ¢çš„gpè¿‡ç¨‹ä¸­ï¼Œå¹¶æ²¡æœ‰ä¿å­˜g0çš„ç›¸å…³æ ˆä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># gp.sched.pc è®°å½•ç€æ³¨å†Œå‡½æ•°å¼€å§‹çš„ä»£ç åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æŠŠgp.sched.pcçš„å€¼è¯»å–åˆ°BXå¯„å­˜å™¨ï¼Œè¿™ä¸ªpcå€¼æ˜¯gpè¿™ä¸ªgoroutineé©¬ä¸Šéœ€è¦æ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å¯¹äºruntime.mainè¿™ä¸ªåœºæ™¯æ¥è¯´å®ƒç°åœ¨å°±æ˜¯runtime.mainå‡½æ•°çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Œç°åœ¨è¿™æ¡æŒ‡ä»¤çš„åœ°å€å°±æ”¾åœ¨BXå¯„å­˜å™¨é‡Œé¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># DXå¯„å­˜å™¨ä½œä¸ºä¸Šä¸‹æ–‡ï¼Œè®°å½•ç€é—­åŒ…å‡½æ•°çš„ç›¸å…³æ•è·å˜é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">gobuf_pc</span><span class="p">(</span><span class="no">BX</span><span class="p">),</span> <span class="no">BX</span>    <span class="c1"># BX = g.gobuf.pc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è¿™é‡Œçš„JMP BXæŒ‡ä»¤æŠŠBXå¯„å­˜å™¨é‡Œé¢çš„æŒ‡ä»¤åœ°å€æ”¾å…¥CPUçš„ripå¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># äºæ˜¯ï¼ŒCPUå°±ä¼šè·³è½¬åˆ°è¯¥åœ°å€ç»§ç»­æ‰§è¡Œå±äºgpè¿™ä¸ªgoroutineçš„ä»£ç ï¼Œè¿™æ ·å°±å®Œæˆäº†goroutineçš„åˆ‡æ¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼šDXå¯„å­˜å™¨çš„å€¼ gp.sched.ctxt å­˜å‚¨çš„æ˜¯é—­åŒ…çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¦‚æœé—­åŒ…æ•è·äº†å˜é‡åˆ™ä¼šä½¿ç”¨å®ƒã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JMP</span> <span class="no">BX</span>  <span class="c1"># è·³è½¬åˆ°æ³¨å†Œçš„goroutineå»æ‰§è¡Œäº†
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>æ€»ç»“ï¼š
<ol>
<li><code>execute()</code>å‡½æ•°å®Œæˆä»ç³»ç»Ÿæ ˆ<code>g0</code>åˆ‡æ¢åˆ°æ™®é€š<code>goroutine</code>çš„è¿‡ç¨‹ï¼ˆè¿™é‡Œæ˜¯å‚æ•°<code>gp</code>ï¼‰ã€‚</li>
<li>è¯¥å‡½æ•°å°†å·¥ä½œçº¿ç¨‹<code>m</code>ä¸<code>gp</code>ç›¸äº’ç»‘å®šï¼Œç„¶ååˆ‡æ¢<code>gp</code>çš„çŠ¶æ€å¹¶è®¾ç½®æ ˆæº¢å‡ºç›¸å…³å‚æ•°ï¼Œä»¥åŠè®¾ç½®è°ƒåº¦æ¬¡æ•°ï¼Œ</li>
<li>æ¥ç€è°ƒç”¨<code>gogo()</code>å‡½æ•°æŠŠæ ˆä»<code>g0</code>åˆ‡æ¢æˆ<code>gp</code>çš„æ ˆï¼Œå¹¶æŠŠ<code>gp</code>çš„è°ƒåº¦ä¿¡æ¯ä¿å­˜åœ¨ç›¸å…³å¯„å­˜å™¨ä¸­ï¼Œç„¶ååˆ‡æ¢åˆ°<code>gp</code>å¼€å§‹æ‰§è¡Œç›¸å…³ä»£ç ã€‚</li>
<li>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»<code>g0</code>åˆ‡æ¢åˆ°<code>gp</code>è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰ä¿å­˜<code>g0</code>çš„ç›¸å…³æ ˆé¡¶<code>SP</code>ç›¸å…³ä¿¡æ¯ï¼Œå› æ­¤<code>g0</code>æ ˆæ€»æ˜¯ä»ä¸€ä¸ªå›ºå®šçš„å¼€å§‹çš„ä½ç½®å¼€å§‹çš„ã€‚</li>
</ol>
</li>
</ul>
<h2 id="å…¶ä»–ç›¸å…³å‡½æ•°">å…¶ä»–ç›¸å…³å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#å…¶ä»–ç›¸å…³å‡½æ•°">#</a></h2>
<h3 id="checktimers">checkTimers()<a hidden class="anchor" aria-hidden="true" href="#checktimers">#</a></h3>
<ol>
<li>è¯¥å‡½æ•°æ˜¯å”¤é†’<code>time.Sleep</code>ã€<code>time.Timer</code>ç­‰çš„ç›¸å…³å‡½æ•°ï¼ŒæŸ¥çœ‹<code>runtime.timer</code>æ–‡æ¡£ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">3269
</span><span class="lnt">3270
</span><span class="lnt">3271
</span><span class="lnt">3272
</span><span class="lnt">3273
</span><span class="lnt">3274
</span><span class="lnt">3275
</span><span class="lnt">3276
</span><span class="lnt">3277
</span><span class="lnt">3278
</span><span class="lnt">3279
</span><span class="lnt">3280
</span><span class="lnt">3281
</span><span class="lnt">3282
</span><span class="lnt">3283
</span><span class="lnt">3284
</span><span class="lnt">3285
</span><span class="lnt">3286
</span><span class="lnt">3287
</span><span class="lnt">3288
</span><span class="lnt">3289
</span><span class="lnt">3290
</span><span class="lnt">3291
</span><span class="lnt">3292
</span><span class="lnt">3293
</span><span class="lnt">3294
</span><span class="lnt">3295
</span><span class="lnt">3296
</span><span class="lnt">3297
</span><span class="lnt">3298
</span><span class="lnt">3299
</span><span class="lnt">3300
</span><span class="lnt">3301
</span><span class="lnt">3302
</span><span class="lnt">3303
</span><span class="lnt">3304
</span><span class="lnt">3305
</span><span class="lnt">3306
</span><span class="lnt">3307
</span><span class="lnt">3308
</span><span class="lnt">3309
</span><span class="lnt">3310
</span><span class="lnt">3311
</span><span class="lnt">3312
</span><span class="lnt">3313
</span><span class="lnt">3314
</span><span class="lnt">3315
</span><span class="lnt">3316
</span><span class="lnt">3317
</span><span class="lnt">3318
</span><span class="lnt">3319
</span><span class="lnt">3320
</span><span class="lnt">3321
</span><span class="lnt">3322
</span><span class="lnt">3323
</span><span class="lnt">3324
</span><span class="lnt">3325
</span><span class="lnt">3326
</span><span class="lnt">3327
</span><span class="lnt">3328
</span><span class="lnt">3329
</span><span class="lnt">3330
</span><span class="lnt">3331
</span><span class="lnt">3332
</span><span class="lnt">3333
</span><span class="lnt">3334
</span><span class="lnt">3335
</span><span class="lnt">3336
</span><span class="lnt">3337
</span><span class="lnt">3338
</span><span class="lnt">3339
</span><span class="lnt">3340
</span><span class="lnt">3341
</span><span class="lnt">3342
</span><span class="lnt">3343
</span><span class="lnt">3344
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// checkTimers runs any timers for the P that are ready.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If now is not 0 it is the current time.
</span></span></span><span class="line"><span class="cl"><span class="c1">// It returns the passed time or the current time if now was passed as 0.
</span></span></span><span class="line"><span class="cl"><span class="c1">// and the time when the next timer should run or 0 if there is no next timer,
</span></span></span><span class="line"><span class="cl"><span class="c1">// and reports whether it ran any timers.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If the time when the next timer should run is not 0,
</span></span></span><span class="line"><span class="cl"><span class="c1">// it is always larger than the returned time.
</span></span></span><span class="line"><span class="cl"><span class="c1">// We pass now in and out to avoid extra calls of nanotime.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:yeswritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">checkTimers</span><span class="p">(</span><span class="nx">pp</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">now</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="nx">rnow</span><span class="p">,</span> <span class="nx">pollUntil</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">ran</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// If it&#39;s not yet time for the first timer, or the first adjusted
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// timer, then there is nothing to do.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">next</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Load64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pp</span><span class="p">.</span><span class="nx">timer0When</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nextAdj</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Load64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pp</span><span class="p">.</span><span class="nx">timerModifiedEarliest</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">next</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="nx">nextAdj</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">nextAdj</span> <span class="p">&lt;</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">next</span> <span class="p">=</span> <span class="nx">nextAdj</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">next</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// No timers to run or adjust.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ— éœ€è¿è¡Œæˆ–è°ƒæ•´è®¡æ—¶å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">now</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">now</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">now</span> <span class="p">=</span> <span class="nf">nanotime</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">now</span> <span class="p">&lt;</span> <span class="nx">next</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Next timer is not ready to run, but keep going
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// if we would clear deleted timers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// This corresponds to the condition below where
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// we decide whether to call clearDeletedTimers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">pp</span> <span class="o">!=</span> <span class="nf">getg</span><span class="p">().</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span> <span class="o">||</span> <span class="nb">int</span><span class="p">(</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pp</span><span class="p">.</span><span class="nx">deletedTimers</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pp</span><span class="p">.</span><span class="nx">numTimers</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">now</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pp</span><span class="p">.</span><span class="nx">timersLock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœå½“å‰Pçš„timerså­˜åœ¨æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">pp</span><span class="p">.</span><span class="nx">timers</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>	<span class="c1">// pp.timersè®°å½•ç€å½“å‰Pä¸­æ‰€æœ‰ç›¸å…³çš„timer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// adjusttimers åœ¨å½“å‰ P çš„å †ä¸­æŸ¥æ‰¾ä»»ä½•å·²ä¿®æ”¹ä¸ºæ›´æ—©è¿è¡Œçš„å®šæ—¶å™¨ï¼Œå¹¶å°†å®ƒä»¬æ”¾åœ¨å †ä¸­çš„æ­£ç¡®ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åœ¨æŸ¥æ‰¾è¿™äº›è®¡æ—¶å™¨æ—¶ï¼Œå®ƒè¿˜ä¼šç§»åŠ¨å·²ä¿®æ”¹ä¸ºç¨åè¿è¡Œçš„è®¡æ—¶å™¨ï¼Œå¹¶åˆ é™¤å·²åˆ é™¤çš„è®¡æ—¶å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è°ƒç”¨è€…å¿…é¡»é”å®š pp çš„è®¡æ—¶å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">adjusttimers</span><span class="p">(</span><span class="nx">pp</span><span class="p">,</span> <span class="nx">now</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nb">len</span><span class="p">(</span><span class="nx">pp</span><span class="p">.</span><span class="nx">timers</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Note that runtimer may temporarily unlock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// pp.timersLock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¯·æ³¨æ„ï¼Œruntimer å¯èƒ½ä¼šæš‚æ—¶è§£é” pp.timersLock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// runtimerå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// runtimer æ£€æŸ¥timersä¸­çš„ç¬¬ä¸€ä¸ªtimerã€‚ å¦‚æœå®ƒåŸºäºnowå‡†å¤‡å¥½ï¼Œå®ƒä¼šè¿è¡Œtimerå¹¶åˆ é™¤æˆ–æ›´æ–°å®ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦‚æœå®ƒè¿è¡Œäº†ä¸€ä¸ªtimerï¼Œåˆ™è¿”å› 0ï¼Œå¦‚æœæ²¡æœ‰æ›´å¤šçš„timerï¼Œåˆ™è¿”å› -1ï¼Œæˆ–è€…ç¬¬ä¸€ä¸ªtimeråº”è¯¥è¿è¡Œçš„æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">tw</span> <span class="o">:=</span> <span class="nf">runtimer</span><span class="p">(</span><span class="nx">pp</span><span class="p">,</span> <span class="nx">now</span><span class="p">);</span> <span class="nx">tw</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">tw</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">pollUntil</span> <span class="p">=</span> <span class="nx">tw</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ran</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// If this is the local P, and there are a lot of deleted timers,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// clear them out. We only do this for the local P to reduce
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// lock contention on timersLock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœå½“å‰Pæ˜¯å½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„Pï¼Œå¹¶ä¸”æœ‰å¾ˆå¤šè¢«åˆ é™¤çš„timerï¼Œæ¸…é™¤å®ƒä»¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æˆ‘ä»¬åªå¯¹æœ¬åœ° P è¿™æ ·åšï¼Œä»¥å‡å°‘ timersLock ä¸Šçš„é”äº‰ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">pp</span> <span class="o">==</span> <span class="nf">getg</span><span class="p">().</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nb">int</span><span class="p">(</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pp</span><span class="p">.</span><span class="nx">deletedTimers</span><span class="p">))</span> <span class="p">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">pp</span><span class="p">.</span><span class="nx">timers</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">clearDeletedTimers</span><span class="p">(</span><span class="nx">pp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pp</span><span class="p">.</span><span class="nx">timersLock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">now</span><span class="p">,</span> <span class="nx">pollUntil</span><span class="p">,</span> <span class="nx">ran</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="checkdead">checkdead()<a hidden class="anchor" aria-hidden="true" href="#checkdead">#</a></h3>
<ol>
<li>æ£€æŸ¥æ­»é”æƒ…å†µã€‚æ£€æŸ¥åŸºäºæ­£åœ¨è¿è¡Œçš„Mçš„æ•°é‡ï¼Œå¦‚æœ<code>0 -&gt; deadlock</code>ã€‚</li>
<li><code>sched.lock</code>å¿…é¡»è¢«æŒæœ‰ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5017
</span><span class="lnt">5018
</span><span class="lnt">5019
</span><span class="lnt">5020
</span><span class="lnt">5021
</span><span class="lnt">5022
</span><span class="lnt">5023
</span><span class="lnt">5024
</span><span class="lnt">5025
</span><span class="lnt">5026
</span><span class="lnt">5027
</span><span class="lnt">5028
</span><span class="lnt">5029
</span><span class="lnt">5030
</span><span class="lnt">5031
</span><span class="lnt">5032
</span><span class="lnt">5033
</span><span class="lnt">5034
</span><span class="lnt">5035
</span><span class="lnt">5036
</span><span class="lnt">5037
</span><span class="lnt">5038
</span><span class="lnt">5039
</span><span class="lnt">5040
</span><span class="lnt">5041
</span><span class="lnt">5042
</span><span class="lnt">5043
</span><span class="lnt">5044
</span><span class="lnt">5045
</span><span class="lnt">5046
</span><span class="lnt">5047
</span><span class="lnt">5048
</span><span class="lnt">5049
</span><span class="lnt">5050
</span><span class="lnt">5051
</span><span class="lnt">5052
</span><span class="lnt">5053
</span><span class="lnt">5054
</span><span class="lnt">5055
</span><span class="lnt">5056
</span><span class="lnt">5057
</span><span class="lnt">5058
</span><span class="lnt">5059
</span><span class="lnt">5060
</span><span class="lnt">5061
</span><span class="lnt">5062
</span><span class="lnt">5063
</span><span class="lnt">5064
</span><span class="lnt">5065
</span><span class="lnt">5066
</span><span class="lnt">5067
</span><span class="lnt">5068
</span><span class="lnt">5069
</span><span class="lnt">5070
</span><span class="lnt">5071
</span><span class="lnt">5072
</span><span class="lnt">5073
</span><span class="lnt">5074
</span><span class="lnt">5075
</span><span class="lnt">5076
</span><span class="lnt">5077
</span><span class="lnt">5078
</span><span class="lnt">5079
</span><span class="lnt">5080
</span><span class="lnt">5081
</span><span class="lnt">5082
</span><span class="lnt">5083
</span><span class="lnt">5084
</span><span class="lnt">5085
</span><span class="lnt">5086
</span><span class="lnt">5087
</span><span class="lnt">5088
</span><span class="lnt">5089
</span><span class="lnt">5090
</span><span class="lnt">5091
</span><span class="lnt">5092
</span><span class="lnt">5093
</span><span class="lnt">5094
</span><span class="lnt">5095
</span><span class="lnt">5096
</span><span class="lnt">5097
</span><span class="lnt">5098
</span><span class="lnt">5099
</span><span class="lnt">5100
</span><span class="lnt">5101
</span><span class="lnt">5102
</span><span class="lnt">5103
</span><span class="lnt">5104
</span><span class="lnt">5105
</span><span class="lnt">5106
</span><span class="lnt">5107
</span><span class="lnt">5108
</span><span class="lnt">5109
</span><span class="lnt">5110
</span><span class="lnt">5111
</span><span class="lnt">5112
</span><span class="lnt">5113
</span><span class="lnt">5114
</span><span class="lnt">5115
</span><span class="lnt">5116
</span><span class="lnt">5117
</span><span class="lnt">5118
</span><span class="lnt">5119
</span><span class="lnt">5120
</span><span class="lnt">5121
</span><span class="lnt">5122
</span><span class="lnt">5123
</span><span class="lnt">5124
</span><span class="lnt">5125
</span><span class="lnt">5126
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Check for deadlock situation.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The check is based on number of running M&#39;s, if 0 -&gt; deadlock.
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">checkdead</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// sched.lock å¿…é¡»è¢«æŒæœ‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// For -buildmode=c-shared or -buildmode=c-archive it&#39;s OK if
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// there are no running goroutines. The calling program is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// assumed to be running.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">islibrary</span> <span class="o">||</span> <span class="nx">isarchive</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// If we are dying because of a signal caught on an already idle thread,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// freezetheworld will cause all running threads to block.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// And runtime will essentially enter into deadlock state,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// except that there is a thread that will call exit soon.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">panicking</span><span class="p">.</span><span class="nf">Load</span><span class="p">()</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// If we are not running under cgo, but we have an extra M then account
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// for it. (It is possible to have an extra M on Windows without cgo to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// accommodate callbacks created by syscall.NewCallback. See issue #6751
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// for details.)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">run0</span> <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">iscgo</span> <span class="o">&amp;&amp;</span> <span class="nx">cgoHasExtraM</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">lockextra</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">haveExtraM</span> <span class="o">:=</span> <span class="nx">extraMCount</span> <span class="p">&gt;</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlockextra</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">haveExtraM</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">run0</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//func mcount() int32 {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    return int32(sched.mnext - sched.nmfreed)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">run</span> <span class="o">:=</span> <span class="nf">mcount</span><span class="p">()</span> <span class="o">-</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">nmidle</span> <span class="o">-</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">nmidlelocked</span> <span class="o">-</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">nmsys</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">run</span> <span class="p">&gt;</span> <span class="nx">run0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">run</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;runtime: checkdead: nmidle=&#34;</span><span class="p">,</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">nmidle</span><span class="p">,</span> <span class="s">&#34; nmidlelocked=&#34;</span><span class="p">,</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">nmidlelocked</span><span class="p">,</span> <span class="s">&#34; mcount=&#34;</span><span class="p">,</span> <span class="nf">mcount</span><span class="p">(),</span> <span class="s">&#34; nmsys=&#34;</span><span class="p">,</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">nmsys</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;checkdead: inconsistent counts&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">grunning</span> <span class="o">:=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">forEachG</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nf">isSystemGoroutine</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">s</span> <span class="o">:=</span> <span class="nf">readgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="nx">s</span> <span class="o">&amp;^</span> <span class="nx">_Gscan</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">_Gwaiting</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">_Gpreempted</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">grunning</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">_Grunnable</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">_Grunning</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">_Gsyscall</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s">&#34;runtime: checkdead: find g &#34;</span><span class="p">,</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">goid</span><span class="p">,</span> <span class="s">&#34; in status &#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;checkdead: runnable g&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">grunning</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// possible if main goroutine calls runtimeÂ·Goexit()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span> <span class="c1">// unlock so that GODEBUG=scheddetail=1 doesn&#39;t hang
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">fatal</span><span class="p">(</span><span class="s">&#34;no goroutines (main called runtime.Goexit) - deadlock!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Maybe jump time forward for playground.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">faketime</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">when</span> <span class="o">:=</span> <span class="nf">timeSleepUntil</span><span class="p">();</span> <span class="nx">when</span> <span class="p">&lt;</span> <span class="nx">maxWhen</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">faketime</span> <span class="p">=</span> <span class="nx">when</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// Start an M to steal the timer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">pp</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nf">pidleget</span><span class="p">(</span><span class="nx">faketime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">pp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// There should always be a free P since
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// nothing is running.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;checkdead: no p for timer&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">mget</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">mp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// There should always be a free M since
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// nothing is running.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;checkdead: no m for timer&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// M must be spinning to steal. We set this to be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// explicit, but since this is the only M it would
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// become spinning on its own anyways.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">mp</span><span class="p">.</span><span class="nx">spinning</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">            <span class="nx">mp</span><span class="p">.</span><span class="nx">nextp</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">pp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">notewakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mp</span><span class="p">.</span><span class="nx">park</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// There are no goroutines running, so we can look at the P&#39;s.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">pp</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">allp</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å½“æŸä¸ªPä¸­å­˜åœ¨timerï¼Œå³ä½¿å…¨éƒ¨Péƒ½ç¡çœ äº†ä¹Ÿä¸ä¼šæŠ¥é”™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">pp</span><span class="p">.</span><span class="nx">timers</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span> <span class="c1">// unlock so that GODEBUG=scheddetail=1 doesn&#39;t hang
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">fatal</span><span class="p">(</span><span class="s">&#34;all goroutines are asleep - deadlock!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://heliu.site/tags/golang/">Golang</a></li>
      <li><a href="https://heliu.site/tags/goroutine/">Goroutine</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://heliu.site/posts/golang/goroutine/main/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>main goroutine</span>
  </a>
  <a class="next" href="https://heliu.site/posts/golang/goroutine/sysmon/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>sysmon ç›‘æ§çº¿ç¨‹</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
    </span>
    <span id="busuanzi_container_site_uv">
        æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
    </span>
    </div>
        <span>Copyright Â© 2024 èœ€ICPå¤‡2024091074å· <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
