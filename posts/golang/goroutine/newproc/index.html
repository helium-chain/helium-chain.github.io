<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>go å…³é”®å­— | Helium</title>
<meta name="keywords" content="golang, Goroutine">
<meta name="description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬">
<meta name="author" content="helium">
<link rel="canonical" href="https://helium.github.io/posts/golang/goroutine/newproc/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://helium.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://helium.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://helium.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://helium.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://helium.github.io/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://helium.github.io/posts/golang/goroutine/newproc/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="go å…³é”®å­—" />
<meta property="og:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://helium.github.io/posts/golang/goroutine/newproc/" />
<meta property="og:image" content="https://helium.github.io/favicon-32x32.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-07-29T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-07-29T00:00:00+00:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://helium.github.io/favicon-32x32.png" />
<meta name="twitter:title" content="go å…³é”®å­—"/>
<meta name="twitter:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://helium.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Golang",
      "item": "https://helium.github.io/posts/golang/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ç¬¬12ç«  Goroutine",
      "item": "https://helium.github.io/posts/golang/goroutine/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "go å…³é”®å­—",
      "item": "https://helium.github.io/posts/golang/goroutine/newproc/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "go å…³é”®å­—",
  "name": "go å…³é”®å­—",
  "description": "ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18+ç‰ˆæœ¬",
  "keywords": [
    "golang", "Goroutine"
  ],
  "articleBody": " goå…³é”®å­—æµç¨‹ï¼š newproc()å‡½æ•°æ˜¯goå…³é”®å­—åˆ›å»ºgoroutineçš„åˆå§‹åŒ–å‡½æ•°ã€‚ ä¹Ÿæ˜¯åˆ›å»ºç¬¬ä¸€ä¸ªgoroutine(runtime.main)çš„å‡½æ•°ã€‚ newproc() è¯¥å‡½æ•°æ˜¯æ•´ä¸ªgoå…³é”®å­—çš„æ‰§è¡Œæµç¨‹ä»£ç ï¼Œå…¶ä¸­åŒ…æ‹¬newgçš„åˆ›å»ºï¼Œnewgæ”¾å…¥Pä¸­ï¼Œå”¤é†’å…¶ä»–Pèµ·æ¥å·¥ä½œç­‰ã€‚ åˆ›å»ºä¸€ä¸ªæ–°çš„goroutineè¿è¡Œfnã€‚æŠŠå®ƒæ”¾åˆ°ç­‰å¾…è¿è¡Œçš„gé˜Ÿåˆ—ä¸­ã€‚ç¼–è¯‘å™¨å°†goè¯­å¥è½¬æ¢ä¸ºå¯¹thisçš„è°ƒç”¨ã€‚ å…³äºå‚æ•°çš„è¯´æ˜ï¼š fn *funcvalï¼šfnæ˜¯ä¸€ä¸ªé—­åŒ…å˜é‡ã€‚çœ‹è¿‡ä¹‹å‰ç‰ˆæœ¬çš„è¯¥å‡½æ•°å°±ä¼šå‘ç°go A(1,2)è¿™ç§å½¢å¼çš„å‚æ•°æ€ä¹ˆå¤„ç†çš„ï¼Ÿ åœ¨ä¹‹å‰ç‰ˆæœ¬ä¸­è¯¥å‡½æ•°çš„å½¢å¼å¦‚è¿™func newproc(siz int32, fn *funcval)ï¼Œå¤šäº†ä¸€ä¸ªsizå‚æ•°è¡¨ç¤ºå‚æ•°å…±å å¤šå°‘å­—èŠ‚ã€‚ åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­Goçš„ä¼ å‚æ˜¯å…¥æ ˆå½¢å¼çš„ï¼Œåœ¨1.18ä¸­å·²ç»æ”¹æˆäº†å¯„å­˜å™¨ä¼ å‚å½¢å¼ã€‚ åœ¨1.18ä¸­åœ¨Aå‡½æ•°çš„å¤–å±‚åœ¨å°è£…äº†ä¸€å±‚é—­åŒ…æ‰€ä»¥å°‘ä¼ ä¸€ä¸ªå‚æ•°ï¼Œgo A(1,2) -\u003e go func() {A(1,2)}ä½œä¸ºå‚æ•°ä¼ å…¥newprocå‡½æ•°ã€‚ fn *funcvalï¼šè¿™é‡Œçš„å‡½æ•°åŸå‹æ˜¯ func()ï¼Œæ²¡æœ‰å‚æ•°å’Œè¿”å›å€¼ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 4091 4092 4093 4094 4095 4096 4097 4098 4099 4100 4101 4102 4103 4104 4105 4106 4107 4108 4109 4110 4111 4112 4113 4114 4115 4116 4117 4118 4119 4120 4121 4122 4123 4124 4125 4126 4127 4128 // Create a new g running fn. // Put it on the queue of g's waiting to run. // The compiler turns a go statement into a call to this. func newproc(fn *funcval) { // getgå‡½æ•°åœ¨æºä»£ç ä¸­æ²¡æœ‰å¯¹åº”çš„å®šä¹‰ï¼Œç”±ç¼–è¯‘å™¨æ’å…¥ç±»ä¼¼ä¸‹é¢ä¸¤è¡Œä»£ç  // get_tls(CX); # è·å–fså¯„å­˜å™¨åœ°å€ï¼Œæ”¾å…¥å¯„å­˜å™¨CXä¸­ï¼Œfsåœ°å€è¢«è®¾ç½®æˆ\u0026m.tls[1]å¤„åœ°å€ // MOVQ g(CX), BX; # BXå­˜å™¨é‡Œé¢ç°åœ¨æ”¾çš„æ˜¯å½“å‰gçš„åœ°å€ï¼Œg(CX)è·å–fs-8ä½ç½®å­˜å‚¨æ•°æ®,ä¹Ÿå°±æ˜¯å½“å‰æ‰§è¡Œçš„gï¼Œä¹Ÿå°±æ˜¯m.tls[0]åœ°å€ gp := getg() // è·å–å½“å‰è¿è¡Œçš„gï¼Œm.tls[0]å­˜å‚¨çš„å°±æ˜¯å½“å‰å·¥ä½œçº¿ç¨‹Mç»‘å®šçš„gï¼Œä¹Ÿå°±æ˜¯å½“å‰æ­£åœ¨è¿è¡Œçš„g // getcallerpc()è¿”å›ä¸€ä¸ªåœ°å€ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨newprocæ—¶ç”±callæŒ‡ä»¤å‹æ ˆçš„å‡½æ•°è¿”å›åœ°å€ // å¯¹äºæˆ‘ä»¬ç°åœ¨è¿™ä¸ªåœºæ™¯æ¥è¯´ï¼Œpcå°±æ˜¯CALL runtimeÂ·newproc(SB)æŒ‡ä»¤åé¢çš„POPQ AXè¿™æ¡æŒ‡ä»¤çš„åœ°å€ // ä¸»è¦ç”¨äºæ–°åˆ›å»ºçš„ goroutine è®°å½•è‡ªå·±æ˜¯åœ¨å“ªé‡Œè¢«åˆ›å»ºçš„ã€‚ pc := getcallerpc() // systemstackçš„ä½œç”¨æ˜¯åˆ‡æ¢åˆ°g0æ ˆæ‰§è¡Œä½œä¸ºå‚æ•°çš„å‡½æ•° // æˆ‘ä»¬è¿™ä¸ªåœºæ™¯ç°åœ¨æœ¬èº«å°±åœ¨g0æ ˆï¼Œå› æ­¤ä»€ä¹ˆä¹Ÿä¸åšï¼Œç›´æ¥è°ƒç”¨ä½œä¸ºå‚æ•°çš„å‡½æ•° systemstack(func() { // åˆ›å»ºä¸€ä¸ªæ–°çš„goroutineå¹¶åˆå§‹åŒ–ï¼Œè®¾ç½®å¥½æ ˆå¤§å°æ‰§è¡Œåœ°å€å’Œæ‰§è¡Œå®Œè¿”å›åœ°å€ // è¯¥é—­åŒ…å‡½æ•°æ•è·fnã€gpã€pcä¸‰ä¸ªå˜é‡ // ç”±äºfnå’Œgpéƒ½æ˜¯æŒ‡é’ˆï¼Œæ•è·å€¼å³å¯ï¼Œè€Œpcæ˜¯uintptrç±»å‹ï¼Œä¹Ÿæ˜¯æ•è·çš„å€¼ newg := newproc1(fn, gp, pc) // ç”±äºå½“å‰åœ¨g0æ ˆä¸Šï¼Œå› æ­¤getg()è·å–çš„æ˜¯g0 // getg().m è·å–çš„æ˜¯å½“å‰çš„å·¥ä½œçº¿ç¨‹M // è·å–å½“å‰mç»‘å®šçš„P _p_ := getg().m.p.ptr() // æŠŠnewgæ”¾å…¥_p_çš„è¿è¡Œé˜Ÿåˆ—ï¼Œåˆå§‹åŒ–çš„æ—¶å€™ä¸€å®šæ˜¯pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ— // å…¶å®ƒgoroutineçš„æ—¶å€™å¯èƒ½å› ä¸ºæœ¬åœ°é˜Ÿåˆ—æ»¡äº†è€Œæ”¾å…¥å…¨å±€é˜Ÿåˆ— runqput(_p_, newg, true) // true.æ”¾å…¥Pçš„ç¬¬ä¸€ä½ï¼Œfalse.æ”¾å…¥Pçš„æœ€åä¸€ä½ // mainStartedå…¨å±€å˜é‡æ ‡è®°ä¸»çº¿ç¨‹runtime.mainæ˜¯å¦å·²ç»å¯åŠ¨ // å³ä¸»goroutineå·²ç»å¼€å§‹æ‰§è¡Œï¼Œæ­¤åæ‰ä¼šé€šè¿‡wakeup()å‡½æ•°å¯åŠ¨æ–°çš„å·¥ä½œçº¿ç¨‹ï¼Œ // ä»¥ä¿è¯main()å‡½æ•°æ€»ä¼šè¢«ä¸»çº¿ç¨‹è°ƒåº¦æ‰§è¡Œã€‚ if mainStarted { wakep()\t// å”¤é†’P } }) } systemstack() systemstackåœ¨ç³»ç»Ÿæ ˆä¸Šè¿è¡Œfnã€‚ å¦‚æœä»per-OS-thread (g0)æ ˆè°ƒç”¨systemstackï¼Œæˆ–è€…ä»ä¿¡å·å¤„ç†(gsignal)æ ˆè°ƒç”¨systemstackï¼Œåˆ™systemstackç›´æ¥è°ƒç”¨fnå¹¶ä¸”è¿”å›ã€‚ å¦åˆ™ï¼Œsystemstackå°†ä»æ™®é€šgoroutineçš„æœ‰é™æ ˆä¸­è°ƒç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œsystemstackåˆ‡æ¢åˆ°per-OS-threadæ ˆï¼Œè°ƒç”¨fnç„¶ååˆ‡æ¢å›æ¥ã€‚ é€šå¸¸ä½¿ç”¨ fn å­—é¢é‡ä½œä¸ºå‚æ•°ï¼Œä»¥ä¾¿äºç³»ç»Ÿæ ˆè°ƒç”¨å‘¨å›´çš„ä»£ç è´¡çŒ®è¾“å…¥å’Œè¾“å‡ºï¼š // ... set up y ... systemstack(func() { x = bigcall(y) }) // ... use x ... go:noescapeï¼šæŒ‡ç¤ºç¼–è¯‘å™¨åœ¨ç¼–è¯‘ä»£ç æ—¶ä¸å¯¹å‡½æ•°è¿›è¡Œé€ƒé€¸åˆ†æã€‚ å‘Šè¯‰ç¼–è¯‘å™¨è¯¥å‡½æ•°ä¸ä¼šå°†å…¶å‚æ•°çš„åœ°å€æ³„éœ²åˆ°å‡½æ•°å¤–éƒ¨ï¼Œå› æ­¤å¯ä»¥é¿å…é€ƒé€¸åˆ†æå’Œå †åˆ†é…ï¼Œä»è€Œæé«˜ä»£ç çš„æ€§èƒ½ã€‚ è¿™ä¸ªæŒ‡ä»¤é€šå¸¸åœ¨ä¸€äº›éœ€è¦é«˜æ€§èƒ½çš„å‡½æ•°ä¸­ä½¿ç”¨ï¼Œå¦‚ä¸€äº›å¸¸ç”¨çš„å†…ç½®å‡½æ•°æˆ–ä¸€äº›ç‰¹å®šçš„åº“å‡½æ•°ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/stubs.goã€‚ 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 // systemstack runs fn on a system stack. // If systemstack is called from the per-OS-thread (g0) stack, or // if systemstack is called from the signal handling (gsignal) stack, // systemstack calls fn directly and returns. // Otherwise, systemstack is being called from the limited stack // of an ordinary goroutine. In this case, systemstack switches // to the per-OS-thread stack, calls fn, and switches back. // It is common to use a func literal as the argument, in order // to share inputs and outputs with the code around the call // to system stack: // // ... set up y ... // systemstack(func() { // x = bigcall(y) // }) // ... use x ... // //go:noescape func systemstack(fn func()) runtimeÂ·systemstack() systemstackå‡½æ•°è¢«è®¾è®¡ç”¨æ¥ä¸´æ—¶æ€§çš„åˆ‡æ¢è‡³å½“å‰Mçš„g0æ ˆï¼Œå®ŒæˆæŸäº›æ“ä½œåå†åˆ‡æ¢å›åŸæ¥goroutineçš„æ ˆã€‚ è¯¥å‡½æ•°ä¸»è¦ç”¨äºæ‰§è¡Œruntimeä¸­ä¸€äº›ä¼šè§¦å‘æ ˆå¢é•¿çš„å‡½æ•°ï¼Œå› ä¸ºgoroutineçš„æ ˆæ˜¯è¢«runtimeç®¡ç†çš„ï¼Œæ‰€ä»¥runtimeä¸­è¿™äº›é€»è¾‘å°±ä¸èƒ½åœ¨æ™®é€šçš„gorooutineä¸Šæ‰§è¡Œï¼Œä»¥å…é™·å…¥é€’å½’ã€‚ g0çš„æ ˆæ˜¯ç”±æ“ä½œç³»ç»Ÿåˆ†é…çš„ï¼Œå¯ä»¥è®¤ä¸ºç©ºé—´è¶³å¤Ÿå¤§ï¼Œè¢«runtimeç”¨æ¥æ‰§è¡Œè‡ªèº«é€»è¾‘éå¸¸å®‰å…¨ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 # func systemstack(fn func()) TEXT runtimeÂ·systemstack(SB), NOSPLIT, $0-8 # é—­åŒ…å‚æ•° fn func()ï¼ŒæŠŠfnå­˜å…¥DIå¯„å­˜å™¨ MOVQ fn+0(FP), DI # DI = fn get_tls(CX) # CX = \u0026m.tls[1]; TLS # è¿™é‡Œè·å–çš„gæ˜¯å½“å‰æ­£åœ¨è¿è¡Œçš„gï¼Œå¯èƒ½æ˜¯g0ä¹Ÿå¯èƒ½ä¸æ˜¯ # ä»TLSè·å–å½“å‰gï¼Œå­˜å…¥AXå¯„å­˜å™¨ MOVQ g(CX), AX # AX = g # å½“å‰æ­£åœ¨è¿è¡Œçš„å·¥ä½œçº¿ç¨‹mï¼Œå°†g.må­˜å…¥BXå¯„å­˜å™¨ä¸­ MOVQ g_m(AX), BX # BX = m # 1) éªŒè¯æ•°æ® # å¦‚æœå½“å‰ g æ˜¯ m.gsignal # è·³è½¬ noswitch æ²¡æœ‰ä»€ä¹ˆå¯åšç›´æ¥è°ƒç”¨ fn å³å¯ # å¯çŸ¥m.gsignalçš„æ ˆæ˜¯g0æ ˆ CMPQ AX, m_gsignal(BX) JEQ noswitch # gsignal ä¹Ÿæ˜¯ç³»ç»Ÿæ ˆï¼Œä¸ç”¨åˆ‡æ¢ # å°†m.g0å­˜å…¥DXå¯„å­˜å™¨ MOVQ m_g0(BX), DX # DX = g0 # æ¯”è¾ƒ g å’Œ g0ï¼Œæ˜¯å¦æ˜¯ä¸€ä¸ªï¼Œå¦‚æœæ˜¯ç›´æ¥è·³è½¬ noswitch # æ¯”è¾ƒå½“å‰gæ˜¯ä¸æ˜¯g0 CMPQ AX, DX JEQ\tnoswitch # å·²ç»åœ¨g0ä¸Šï¼Œä¸éœ€è¦åˆ‡æ¢ # æ¯”è¾ƒå½“å‰gæ˜¯å¦å’Œm.curgä¸ä¸€è‡´ # æ¯”è¾ƒ g å’Œ m.curgï¼Œå¦‚æœä¸ç›¸ç­‰è·³è½¬ bad # ç¨‹åºåˆšå¯åŠ¨åˆå§‹åŒ–æ—¶m.curgä¸ºnilï¼Œä¼šåœ¨å‰é¢çš„g0åˆ¤æ–­å¤„ç›´æ¥è·³è½¬äº†ï¼Œä¸ä¼šèµ°åˆ°è¿™é‡Œ # ä¸ºä»€ä¹ˆè¦æ¯”è¾ƒcrugæ˜¯å¦æ˜¯å½“å‰g?æ˜¯å› ä¸ºä»g0åˆ‡æ¢å›å½“å‰géœ€è¦m.curgè¿™ä¸ªå‚æ•°ã€‚ # è¿™ç§æƒ…å†µåœ¨æ™®é€š goroutine åˆ‡æ¢ g0 æ ˆæ—¶ç”¨åˆ° CMPQ AX, m_curg(BX) JNE\tbad # 2) å­˜å‚¨gä¿¡æ¯ # switch stacks # save our state in g-\u003esched. Pretend to # be systemstack_switch if the G stack is scanned. # # å°†å½“å‰gçš„ä¿¡æ¯ä¿å­˜åˆ° g-\u003esched ä¸­ã€‚å¦‚æœGæ ˆå·²è¢«æ‰«æï¼Œåˆ™å‡è£…æ˜¯ systemstack_switch è°ƒç”¨çš„ã€‚ # ä¿å­˜ goroutine çš„è°ƒåº¦ä¿¡æ¯ã€‚ CALL gosave_systemstack_switch\u003c\u003e(SB) # 3) åˆ‡æ¢åˆ°g0æ ˆ # g0å†™å…¥TLSã€g0å†™å…¥R14å¯„å­˜å™¨ä¸­ã€g0çš„æ ˆé¡¶å€¼å†™å…¥SPå¯„å­˜å™¨ä¸­ # switch to g0 MOVQ DX, g(CX) # g0å†™å…¥TLSä¸­ # R14 = g0 MOVQ DX, R14 # set the g register # BX = g0.sched.gobuf.sp MOVQ (g_sched+gobuf_sp)(DX), BX # SP = g0.sched.gobuf.sp MOVQ BX, SP # æ¢å¤g0çš„SP # 4) è°ƒç”¨ fn å‡½æ•°ï¼Œæ­¤æ—¶å·²ç»åˆ‡æ¢åˆ°g0æ ˆ # ä¸Šä¸‹æ–‡ä¿¡æ¯åœ¨DXå¯„å­˜å™¨ä¸­ï¼ŒåŒ…å«é—­åŒ…æ•è·çš„å˜é‡åˆ—è¡¨ # call target function MOVQ DI, DX # DX = fn = \u0026funcval MOVQ 0(DI), DI # DI = funcval.fn CALL DI # fn() # 5) åˆ‡æ¢å›gæ ˆ # æ³¨æ„ï¼šå½“ä»g0åˆ‡æ¢å›gçš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰å°†g0çš„çŠ¶æ€ä¿å­˜åˆ°g0.schedä¸­ # ä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡ä»g0åˆ‡æ¢è‡³å…¶ä»–çš„goroutineåï¼Œg0æ ˆä¸Šçš„å†…å®¹å°±è¢«æŠ›å¼ƒäº† # ä¸‹æ¬¡åˆ‡æ¢è‡³g0è¿˜æ˜¯ä»å¤´å¼€å§‹ã€‚ # ä»m.curgä¸­å–å‡ºgï¼Œç„¶åå†™å…¥TLSä¸­ï¼Œæ¢å¤SPå¯„å­˜å™¨çš„å€¼ # è¿™é‡Œæ²¡æœ‰æ¢å¤PCå¯„å­˜å™¨å’ŒBPå¯„å­˜å™¨çš„å€¼ï¼Œå› ä¸ºPCå¯„å­˜å™¨çš„å€¼è¿™é‡Œä¸éœ€è¦æ¢å¤é¡ºåºæ‰§è¡Œä»£ç å³å¯ï¼Œ # BPå¯„å­˜å™¨çš„å€¼åœ¨è°ƒç”¨systemstack()å‡½æ•°çš„æ•´ä¸ªè¿‡ç¨‹ä¸­éƒ½æ²¡æœ‰ä¿®æ”¹ï¼Œå› æ­¤ä¹Ÿä¸éœ€è¦æ¢å¤ã€‚ # switch back to g get_tls(CX) # CX = \u0026m.tls[1] MOVQ g(CX), AX # AX = g0 MOVQ g_m(AX), BX # BX = m MOVQ m_curg(BX), AX # AX = m.curg; å½“å‰g MOVQ AX, g(CX) # gå­˜å…¥TLS # è°ƒç”¨ systemstack å‡½æ•°å‰çš„ SP; # R14å¯„å­˜å™¨åœ¨è¿™ä¸ªå‡½æ•°ä¸­æ²¡æœ‰è¢«è®¾ç½®å›æ¥ï¼Œåº”è¯¥æ˜¯ç¼–è¯‘å™¨è´Ÿè´£è®¾ç½®å›æ¥å§ã€‚ MOVQ (g_sched+gobuf_sp)(AX), SP # æ¢å¤SP; SP = g.sched.gobuf.sp MOVQ $0, (g_sched+gobuf_sp)(AX) # æ¸…é™¤ g.sched.gobuf.sp = 0 RET noswitch: # already on m stack; tail call the function # Using a tail call here cleans up tracebacks since we won't stop # at an intermediate systemstack. # # å·²ç»åœ¨mæ ˆä¸Šï¼›ç”±äºæˆ‘ä»¬ä¸ä¼šåœ¨ä¸­é—´ç³»ç»Ÿæ ˆä¸Šåœæ­¢ï¼Œå› æ­¤åœ¨è¿™é‡Œç›´æ¥è°ƒç”¨fn MOVQ DI, DX # DX = \u0026funcval MOVQ 0(DI), DI # DI = funcval.fn JMP\tDI # è°ƒç”¨fnå‡½æ•° bad: # Bad: g is not gsignal, not g0, not curg. What is it? # Badï¼šg ä¸æ˜¯ gsignalï¼Œä¹Ÿä¸æ˜¯ g0ï¼Œä¸æ˜¯ curgã€‚å®ƒæ˜¯ä»€ä¹ˆï¼Ÿ MOVQ $runtimeÂ·badsystemstack(SB), AX CALL AX INT\t$3 # è°ƒè¯•é”™è¯¯ gosave_systemstack_switch() ä¿å­˜è°ƒç”¨è€…çŠ¶æ€åˆ°g-\u003eschedï¼Œä½†æ˜¯ä¼ªè£…PCå€¼ä»systemstack_switchå‡½æ•°è°ƒç”¨çš„ã€‚ è¯¥å‡½æ•°åªèƒ½ä»æ²¡æœ‰å±€éƒ¨å˜é‡çš„ï¼ˆ$0ï¼‰çš„å‡½æ•°è°ƒç”¨ï¼Œå¦åˆ™systemstack_switchæ˜¯ä¸æ­£ç¡®çš„ã€‚ R9å¯„å­˜å™¨çš„å€¼è¢«è¦†ç›–ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 791 792 793 794 795 # Save state of caller into g-\u003esched, # but using fake PC from systemstack_switch. # Must only be called from functions with no locals ($0) # or else unwinding from systemstack_switch is incorrect. # Smashes R9. TEXT gosave_systemstack_switch\u003c\u003e(SB),NOSPLIT,$0 MOVQ $runtimeÂ·systemstack_switch(SB), R9 # g.sched.gobuf.pc = $runtimeÂ·systemstack_switch # ä¼ªè£…å½“å‰è°ƒç”¨æ˜¯ä» runtimeÂ·systemstack_switch å‡½æ•°å¼€å§‹çš„ã€‚ # ä»systemstack()åé¢çš„ä»£ç çœ‹å‡ºï¼Œè¿™é‡Œçš„PCå€¼æ²¡æœ‰è¢«ä½¿ç”¨ï¼ŒåŸå› æ˜¯PCä¸éœ€è¦è¿˜åŸè®¾ç½®ã€‚ # å› ä¸ºsystemstack()å‡½æ•°æ˜¯é—­åŒ…è°ƒç”¨fn()å‡½æ•°ï¼Œå› æ­¤æ‰§è¡Œå®Œåè¿˜åœ¨è°ƒç”¨è€…çš„ä»£ç ä¸­ã€‚ MOVQ R9, (g_sched+gobuf_pc)(R14) # g.sched.gobuf.pc = runtimeÂ·systemstack_switch # å› ä¸ºè°ƒç”¨gosave_systemstack_switch()å‡½æ•°ä½¿ç”¨äº†CALLæŒ‡ä»¤ï¼Œæ‰€ä»¥ä¼šæŠŠè¿”å›åœ°å€å‹å…¥æ ˆä¸­ # å› æ­¤ 8(SP)çš„ä½ç½®æ­£å¥½æ˜¯è°ƒç”¨è€…å‡½æ•°çš„æ ˆï¼Œä¹Ÿå°±æ˜¯systemstack()å‡½æ•°çš„æ ˆ # ä»systemstack()å‡½æ•°çš„å‡½æ•°åŸå‹å¯çŸ¥ï¼Œè¯¥å‡½æ•°æ²¡æœ‰åˆ†é…æ ˆå¤§å°ä¸º0ï¼Œå› æ­¤ä¹Ÿæ˜¯è°ƒç”¨systemstack()å‡½æ•°çš„SPå€¼ # è¿™é‡Œæ˜¯newproc()å‡½æ•°çš„çš„æ ˆé¡¶çš„å€¼ LEAQ 8(SP), R9 # 8(SP) æ˜¯è°ƒç”¨è€…å‰çš„SPæŒ‡å‘çš„å€¼ MOVQ R9, (g_sched+gobuf_sp)(R14) # g.sched.gobuf.sp æŒ‡å‘è°ƒç”¨è€…SP MOVQ $0, (g_sched+gobuf_ret)(R14) # g.sched.gobuf.ret = 0 # BPå¯„å­˜å™¨ä¸SPä¸€æ ·ï¼Œè¿™é‡Œä¹Ÿæ˜¯newproc()å‡½æ•°çš„æ ˆåº•çš„å€¼ MOVQ BP, (g_sched+gobuf_bp)(R14) # g.sched.gobuf.bp = BP; è°ƒç”¨è€…BP # Assert ctxt is zero. See func save. # # æ–­è¨€ ctxt æ˜¯0ã€‚å‚çœ‹ func saveã€‚ # g.sched.gobuf.ctxt å­˜å‚¨çš„æ˜¯é—­åŒ…çš„ä¸Šä¸‹æ–‡ï¼Œä¹Ÿå°±æ˜¯DXå¯„å­˜å™¨çš„å€¼æ˜¯å‡½æ•°çš„\u0026funcval MOVQ (g_sched+gobuf_ctxt)(R14), R9 # R9 = g.sched.gobuf.ctxt TESTQ R9, R9 JZ\t2(PC) # åˆ¤æ–­ç»“æœä¸º0åˆ™è·³è¿‡abort()å‡½æ•° CALL runtimeÂ·abort(SB) RET systemstack_switch() æ–‡ä»¶ä½ç½®ï¼šï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ 453 454 455 456 457 458 459 # systemstack_switch is a dummy routine that systemstack leaves at the bottom # of the G stack. We need to distinguish the routine that # lives at the bottom of the G stack from the one that lives # at the top of the system stack because the one at the top of # the system stack terminates the stack walk (see topofstack()). TEXT runtimeÂ·systemstack_switch(SB), NOSPLIT, $0-0 RET newproc1() è¯¥å‡½æ•°ä¸»è¦æ˜¯åˆ›å»ºnew goroutineï¼Œå¹¶è®¾ç½®new goroutineè¯¥ä»å“ªé‡Œè¿›å…¥å“ªé‡Œé€€å‡ºã€‚ ä»fnå¼€å§‹ï¼Œåˆ›å»ºä¸€ä¸ªçŠ¶æ€ä¸º_Grunnableçš„æ–°gã€‚ callerpc æ˜¯åˆ›å»ºè¿™ä¸ªgoè¯­å¥çš„åœ°å€ï¼ˆä¹Ÿå°±æ˜¯goå…³é”®å­—ä»£ç çš„ä¸‹ä¸€æ¡æŒ‡é’ˆï¼‰ã€‚ è°ƒç”¨è€…è´Ÿè´£å°†æ–°çš„gæ·»åŠ åˆ°è°ƒåº¦å™¨ã€‚ å‚æ•°ï¼š fn *funcvalï¼šè¦æ‰§è¡Œå‡½æ•°çš„é—­åŒ…ã€‚ä¹Ÿå°±æ˜¯goå…³é”®å­—åé¢çš„å‡½æ•°é—­åŒ…ï¼Œä¸è¿‡å‡½æ•°é—­åŒ…åŸå‹æ˜¯func()ã€‚ callergp *gï¼šå½“å‰æ­£åœ¨è¿è¡Œçš„goroutineã€‚ä¹Ÿå°±æ˜¯è°ƒç”¨goå…³é”®å­—çš„goroutineã€‚ callerpc uintptrï¼šgoå…³é”®å­—çš„ä¸‹ä¸€è¡ŒæŒ‡ä»¤åœ°å€ã€‚ä¹Ÿå°±æ˜¯è°ƒç”¨goå…³é”®å­—åçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚ è¿”å›å€¼ï¼š*gï¼šæ–°åˆ›å»ºçš„goroutineã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 4109 4110 4111 4112 4113 4114 4115 4116 4117 4118 4119 4120 4121 4122 4123 4124 4125 4126 4127 4128 4129 4130 4131 4132 4133 4134 4135 4136 4137 4138 4139 4140 4141 4142 4143 4144 4145 4146 4147 4148 4149 4150 4151 4152 4153 4154 4155 4156 4157 4158 4159 4160 4161 4162 4163 4164 4165 4166 4167 4168 4169 4170 4171 4172 4173 4174 4175 4176 4177 4178 4179 4180 4181 4182 4183 4184 4185 4186 4187 4188 4189 4190 4191 4192 4193 4194 4195 4196 4197 4198 4199 4200 4201 4202 4203 4204 4205 4206 4207 4208 4209 4210 4211 4212 4213 4214 4215 4216 4217 4218 4219 4220 4221 4222 4223 4224 4225 4226 4227 4228 4229 4230 4231 // Create a new g in state _Grunnable, starting at fn. callerpc is the // address of the go statement that created this. The caller is responsible // for adding the new g to the scheduler. func newproc1(fn *funcval, callergp *g, callerpc uintptr) *g { // è·å–å½“å‰å·¥ä½œçº¿ç¨‹æ­£åœ¨è¿è¡Œçš„gï¼Œè¯¥gæ˜¯g0ï¼Œ // å› ä¸ºnewproc1()å‡½æ•°åªä¼šåœ¨g0æ ˆä¸­è¢«è°ƒç”¨ã€‚ _g_ := getg() // g0 // \"go nil\" è¿™ç§å½¢å¼æ˜¯ä¸ä¼šå…è®¸çš„ã€‚ // var fn func() // nil // go fn() if fn == nil { _g_.m.throwing = -1 // do not dump full stacks throw(\"go of nil func value\") } // ç¦ç”¨æŠ¢å ï¼Œå› ä¸ºå®ƒå¯ä»¥åœ¨æœ¬åœ°å˜é‡ä¸­æŒæœ‰p // å°†å½“å‰g.m.locks++ï¼Œå½“å‰gæ˜¯g0ã€‚ acquirem() // disable preemption because it can be holding p in a local var // è·å–å½“å‰å·¥ä½œçº¿ç¨‹Mç»‘å®šçš„P _p_ := _g_.m.p.ptr() // åˆå§‹åŒ–æ—¶_p_ = g0.m.pï¼Œä»å‰é¢çš„åˆ†æå¯ä»¥çŸ¥é“å…¶å®å°±æ˜¯allp[0] newg := gfget(_p_) // ä»Pçš„æœ¬åœ°ç¼“å†²é‡Œè·å–ä¸€ä¸ªæ²¡æœ‰ä½¿ç”¨çš„gï¼Œåˆå§‹åŒ–æ—¶æ²¡æœ‰ï¼Œè¿”å›nil // å¦‚æœä»å½“å‰Pçš„ç©ºé—²gé“¾è¡¨ä¸­æ²¡æœ‰è·å–åˆ°gï¼Œåˆ™åˆ›å»ºä¸€ä¸ª if newg == nil { // newä¸€ä¸ªgç»“æ„ä½“å¯¹è±¡ï¼Œç„¶åä»å †ä¸Šä¸ºå…¶åˆ†é…æ ˆï¼Œå¹¶è®¾ç½®gçš„stackæˆå‘˜å’Œä¸¤ä¸ªstackgardæˆå‘˜ newg = malg(_StackMin) // _StackMin = 2048 // _Gidle = 0ï¼šè¯¥çŠ¶æ€æ˜¯Gåˆšåˆšè¢«åˆ†é…è¿˜æ²¡åˆå§‹åŒ–æ—¶ // _Gdead = 6ï¼šè¯¥çŠ¶æ€è¡¨ç¤ºå½“å‰æ²¡æœ‰è¢«ç”¨åˆ°ï¼Œå®ƒå¯èƒ½åˆšåˆšå®Œæˆåˆå§‹åŒ–æˆ–åˆšåˆšé€€å‡ºè¿è¡Œï¼Œåœ¨ä¸€ä¸ªç©ºé—²é“¾è¡¨ä¸­ã€‚ // æ³¨æ„è¿™é‡Œæ˜¯CASæ“ä½œ casgstatus(newg, _Gidle, _Gdead) // åˆå§‹åŒ–gçš„çŠ¶æ€ä¸º_Gdead // æ”¾å…¥å…¨å±€å˜é‡ã€allgsåˆ‡ç‰‡ã€‘ä¸­ï¼Œæ–°å¢çš„gå…¨éƒ¨éƒ½ä¼šåŠ å…¥è¿™é‡Œï¼Œå¹¶ä¸”ä¸ä¼šç§»é™¤ï¼Œè¿™ä¹Ÿç¡®ä¿GCä¸ä¼šå»é‡Šæ”¾å®ƒä»¬ allgadd(newg) // publishes with a g-\u003estatus of Gdead so GC scanner doesn't look at uninitialized stack. } // newg ç¼ºå°‘æ ˆ if newg.stack.hi == 0 { throw(\"newproc1: newg missing stack\") } // newg çš„çŠ¶æ€åº”è¯¥æ˜¯ _Gdeadï¼šgoroutineå½“å‰æ²¡æœ‰è¢«ç”¨åˆ° if readgstatus(newg) != _Gdead { throw(\"newproc1: new g is not Gdead\") } // è°ƒæ•´goroutineçš„æ ˆhiï¼Œç”¨äº usesLR ä¸ºtrueæ—¶ // sys.MinFrameSize = 0; goarch.PtrSize = 8; totalSize = 32; // extra space in case of reads slightly beyond frame totalSize := uintptr(4*goarch.PtrSize + sys.MinFrameSize) // sys.StackAlign = 8; totalSize = 32; totalSize = alignUp(totalSize, sys.StackAlign) // æ³¨æ„é¢„ç•™è¿™32å­—èŠ‚æ˜¯ä»æ ˆé«˜åœ°å€å¼€å§‹çš„ sp := newg.stack.hi - totalSize // é¢„ç•™32å­—èŠ‚ï¼Œä¸»è¦ç”¨äºä¸‹é¢usesLR spArg := sp if usesLR { // caller's LR *(*uintptr)(unsafe.Pointer(sp)) = 0 prepGoExitFrame(sp) spArg += sys.MinFrameSize } // æŠŠnewg.schedç»“æ„ä½“æˆå‘˜çš„æ‰€æœ‰æˆå‘˜è®¾ç½®ä¸º0 // newg.schedæ˜¯ä¸€ä¸ªgobufç»“æ„ä½“ï¼Œä¿å­˜çš„CPUä¸»è¦çš„å‡ ä¸ªå¯„å­˜å™¨çš„å€¼ memclrNoHeapPointers(unsafe.Pointer(\u0026newg.sched), unsafe.Sizeof(newg.sched)) newg.sched.sp = sp // newg.sched.spå¯„å­˜å™¨rspå¾—å€¼ï¼Œä¹Ÿå°±æ˜¯newgçš„æ ˆé¡¶ï¼Œæ³¨æ„è¿™é‡Œå…¶å®æŒ‡å‘çš„æ˜¯rbpå­˜å‚¨çš„å€¼ newg.stktopsp = sp // æ ˆé¡¶ä½ç½®ï¼Œè¯¥å€¼ç”¨äºå›æº¯ // newg.sched.pc ä¿å­˜çš„æ˜¯ripå¯„å­˜å™¨çš„å€¼ï¼Œnewg.sched.pc è¡¨ç¤ºå½“newgè¢«è°ƒåº¦èµ·æ¥è¿è¡Œæ—¶ä»è¿™ä¸ªåœ°å€å¼€å§‹æ‰§è¡ŒæŒ‡ä»¤ // æŠŠpcè®¾ç½®æˆäº†goexitè¿™ä¸ªå‡½æ•°åç§»1ï¼ˆsys.PCQuantumç­‰äº1ï¼‰çš„ä½ç½®ï¼Œ // è¿™é‡Œè®¾ç½®goroutineçš„æ‰§è¡Œåœ°å€ä¸ºgoexitå‡½æ•°çš„ç¬¬äºŒæ¡æŒ‡ä»¤çš„ä»£ç åœ°å€è€Œä¸æ˜¯fn.fn // è‡³äºä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšéœ€è¦ç­‰åˆ°åˆ†æå®Œgostartcallfnå‡½æ•°æ‰çŸ¥é“ // +PCQuantum so that previous instruction is in same function newg.sched.pc = abi.FuncPCABI0(goexit) + sys.PCQuantum newg.sched.g = guintptr(unsafe.Pointer(newg)) // è®°å½•å½“å‰çš„gobufæ˜¯æ¥è‡ªnewgè¿™ä¸ªgoroutine gostartcallfn(\u0026newg.sched, fn) // è¯¥å‡½æ•°å¤„ç†newgä»å“ªé‡Œè¿›å…¥ä»å“ªé‡Œé€€å‡º newg.gopc = callerpc // ä¿å­˜goå…³é”®å­—åçš„ä¸‹ä¸€æ¡ä»£ç åœ°å€ï¼Œä¸»è¦ç”¨äºtraceback newg.ancestors = saveAncestors(callergp) // ä¿å­˜å½“å‰åˆ›å»ºgoå…³é”®çš„çš„goroutine // è®¾ç½®newgçš„startpcä¸ºfn.fnï¼Œè¯¥æˆå‘˜ä¸»è¦ç”¨äºå‡½æ•°è°ƒç”¨æ ˆçš„tracebackå’Œæ ˆæ”¶ç¼© // newgçœŸæ­£ä»å“ªé‡Œå¼€å§‹æ‰§è¡Œå¹¶ä¸ä¾èµ–äºè¿™ä¸ªæˆå‘˜ï¼Œè€Œæ˜¯sched.pc newg.startpc = fn.fn // åœ¨isSystemGoroutineä¸­è¢«ç”¨åˆ° // åˆ¤æ–­å½“å‰goroutineæ˜¯å¦æ˜¯ç³»ç»Ÿgoroutine // runtime.mainè¢«è®¤ä¸ºä¸æ˜¯ç³»ç»Ÿgoroutineã€‚ if isSystemGoroutine(newg, false) { // sched.ngsysï¼šè®°å½•çš„æ˜¯ç³»ç»Ÿgoroutineçš„æ•°é‡ï¼Œä¼šè¢«åŸå­æ€§çš„æ›´æ–°ã€‚ atomic.Xadd(\u0026sched.ngsys, +1) } else { // Only user goroutines inherit pprof labels. // user goroutine ç»§æ‰¿ labels if _g_.m.curg != nil { newg.labels = _g_.m.curg.labels } } // Track initial transition? // ç”¨äºç¡®å®æ˜¯å¦è·Ÿè¸ªè¿™ä¸ªG newg.trackingSeq = uint8(fastrand()) // gTrackingPeriod = 8 if newg.trackingSeq%gTrackingPeriod == 0 { newg.tracking = true } // è®¾ç½®gçš„çŠ¶æ€ä¸º_Grunnableï¼Œè¡¨ç¤ºè¿™ä¸ªgä»£è¡¨çš„goroutineå¯ä»¥è¿è¡Œäº† // _Gdead = 6ï¼šè¯¥çŠ¶æ€è¡¨ç¤ºå½“å‰æ²¡æœ‰è¢«ç”¨åˆ°ï¼Œå®ƒå¯èƒ½åˆšåˆšå®Œæˆåˆå§‹åŒ–æˆ–åˆšåˆšé€€å‡ºè¿è¡Œï¼Œåœ¨ä¸€ä¸ªç©ºé—²é“¾è¡¨ä¸­ã€‚ // _Grunnable = 1ï¼šgoroutineåº”è¯¥åœ¨æŸä¸ªrunqä¸­ï¼Œå½“å‰å¹¶æ²¡æœ‰åœ¨è¿è¡Œç”¨æˆ·ä»£ç ï¼Œå®ƒçš„æ ˆä¸å½’è‡ªå·±æ‰€æœ‰ã€‚ casgstatus(newg, _Gdead, _Grunnable) gcController.addScannableStack(_p_, int64(newg.stack.hi-newg.stack.lo)) if _p_.goidcache == _p_.goidcacheend { // Sched.goidgen is the last allocated id, // this batch must be [sched.goidgen+1, sched.goidgen+GoidCacheBatch]. // At startup sched.goidgen=0, so main goroutine receives goid=1. _p_.goidcache = atomic.Xadd64(\u0026sched.goidgen, _GoidCacheBatch) _p_.goidcache -= _GoidCacheBatch - 1 _p_.goidcacheend = _p_.goidcache + _GoidCacheBatch } // goid è¡¨ç¤ºGçš„å”¯ä¸€ID newg.goid = int64(_p_.goidcache) // è®¾ç½®å½“å‰goåœ¨Pä¸­çš„ä½ç½® _p_.goidcache++ if raceenabled { newg.racectx = racegostart(callerpc) } if trace.enabled { traceGoCreate(newg, newg.startpc) } releasem(_g_.m) // å…è®¸å½“å‰Mè¢«æŠ¢å  return newg } gfget() è¯¥å‡½æ•°ä¸»è¦æ˜¯ä»å½“å‰Pç©ºé—²çš„Gé“¾è¡¨ä¸­è·å–Gï¼Œæˆ–è€…ä»å…¨å±€çš„Pé“¾è¡¨ä¸­è·å–Gï¼Œå¦‚æœæœ¬åœ°Pä¸­æ²¡æœ‰ç©ºé—²çš„Gåˆ™ä»å…¨å±€çš„Pä¸­è¿ç§»éƒ¨åˆ†Gæ”¾å…¥æœ¬åœ°éPä¸­ã€‚ ä»gfreeåˆ—è¡¨è·å–ã€‚å¦‚æœå±€éƒ¨åˆ—è¡¨ä¸ºç©ºï¼Œåˆ™ä»å…¨å±€åˆ—è¡¨ä¸­è·å–ä¸€éƒ¨åˆ†åˆ°æœ¬åœ°ã€‚ å‚çœ‹ä¸‹é¢\"ç©ºé—²çš„gé“¾è¡¨\"ä¸­çš„gfgetå‡½æ•°æ³¨é‡Šï¼Œæœ‰äº›å˜åŒ–ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 4282 4283 4284 4285 4286 4287 4288 4289 4290 4291 4292 4293 4294 4295 4296 4297 4298 4299 4300 4301 4302 4303 4304 4305 4306 4307 4308 4309 4310 4311 4312 4313 4314 4315 4316 4317 4318 4319 4320 4321 4322 4323 4324 4325 4326 4327 4328 4329 4330 4331 4332 // Get from gfree list. // If local list is empty, grab a batch from global list. func gfget(_p_ *p) *g { retry: // å¦‚æœå½“å‰Pçš„gFreeä¸ºç©º å¹¶ä¸” å…¨å±€çš„gFree.stackæˆ–gFree.noStackä¸ä¸ºç©º // sched.gFree.stack è¡¨ç¤ºè¿™é‡Œçš„goroutineå¸¦æœ‰æ ˆå¤§å°çš„é»˜è®¤æ˜¯2KB // sched.gFree.noStack è¡¨ç¤ºè¿™é‡Œçš„goroutineæ²¡æœ‰åˆ†é…æ ˆå¤§å°ï¼Œé»˜è®¤æ˜¯0KB if _p_.gFree.empty() \u0026\u0026 (!sched.gFree.stack.empty() || !sched.gFree.noStack.empty()) { lock(\u0026sched.gFree.lock) // Move a batch of free Gs to the P. for _p_.gFree.n \u003c 32 { // å½“å‰Pçš„gFreeçš„æ•°é‡å°äº32ï¼Œä»sched.gFreeä¸­ç§»åŠ¨ä¸€éƒ¨åˆ†åˆ°Pçš„gFreeä¸­ // Prefer Gs with stacks. gp := sched.gFree.stack.pop() // ä»ched.gFree.stackå–ä¸€ä¸ªG if gp == nil { // å–ä¸åˆ°ï¼Œåˆ™ä»sched.gFree.noStackå–ä¸€ä¸ªG gp = sched.gFree.noStack.pop() if gp == nil { break } } sched.gFree.n-- // è®°å½•å½“å‰sched.gFreeå‡ä¸€ _p_.gFree.push(gp) // æŠŠå½“å‰å–åˆ°çš„GåŠ å…¥Pçš„gFreeä¸­ _p_.gFree.n++ // æŠŠPçš„gFreeçš„æ•°é‡åŠ ä¸€ } unlock(\u0026sched.gFree.lock) goto retry } gp := _p_.gFree.pop() // ä»Pä¸­å–å‡ºä¸€ä¸ªG if gp == nil { return nil } _p_.gFree.n-- // æ ‡è®°å½“å‰Pçš„gFreeå‡ä¸€ if gp.stack.lo == 0 { // å¦‚æœå½“å‰Gçš„æ ˆé¡¶ä¸º0ï¼Œè¯´æ˜æ ˆè¢«é‡Šæ”¾äº† // Stack was deallocated in gfput. Allocate a new one. // å †æ ˆåœ¨gfput()å‡½æ•°ä¸­è¢«é‡Šæ”¾ åˆ†é…ä¸€ä¸ªæ–°çš„ systemstack(func() { gp.stack = stackalloc(_FixedStack) // é‡æ–°åˆ†é…æ ˆä¿¡æ¯ }) gp.stackguard0 = gp.stack.lo + _StackGuard // æŠŠgp.stackguard0ä¹Ÿæ‰§è¡Œè¯¥ä½ç½® } else { if raceenabled { racemalloc(unsafe.Pointer(gp.stack.lo), gp.stack.hi-gp.stack.lo) } if msanenabled { msanmalloc(unsafe.Pointer(gp.stack.lo), gp.stack.hi-gp.stack.lo) } if asanenabled { asanunpoison(unsafe.Pointer(gp.stack.lo), gp.stack.hi-gp.stack.lo) } } return gp } malg() è¯¥å‡½æ•°ä¸»è¦æ˜¯å¦‚æœä»gfget()å‡½æ•°ä¸­è·å–ä¸åˆ°ç©ºé—²çš„gï¼Œé‚£ä¹ˆå°±è‡ªå·±åˆ†é…ä¸€ä¸ªï¼Œå¹¶è®¾ç½®æ ˆç©ºé—´ åˆ†é…ä¸€ä¸ªæ–°çš„gï¼Œå®ƒçš„å †æ ˆè¶³å¤Ÿå¤§ï¼Œå¯ä»¥å®¹çº³stacksizeå­—èŠ‚ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 4074 4075 4076 4077 4078 4079 4080 4081 4082 4083 4084 4085 4086 4087 4088 4089 4090 4091 4092 4093 4094 4095 4096 4097 // Allocate a new g, with a stack big enough for stacksize bytes. func malg(stacksize int32) *g { newg := new(g) // åˆ›å»ºä¸€ä¸ªGï¼Œè¿™é‡Œæ˜¯å †åˆ†é…çš„ // éœ€è¦åˆ†é…æ ˆå¤§å° if stacksize \u003e= 0 { // _StackSystem = 0ï¼Œround2å‡½æ•°å‘ä¸Šå–æˆ2çš„å¹‚æ¬¡æ–¹ï¼Œstacksizeæ˜¯2KB stacksize = round2(_StackSystem + stacksize) // è®¡ç®—å¤§å°2çš„å¹‚æ¬¡æ–¹ // åˆ‡æ¢åˆ°g0æ ˆï¼Œå»åˆ†é…æ ˆ systemstack(func() {\t// åˆ†é…æ ˆï¼Œgoroutineåœ¨linuxä¸Šé»˜è®¤æ˜¯2KBå¤§å° newg.stack = stackalloc(uint32(stacksize)) }) // æ³¨æ„ï¼šstackguard0 = newg.stack.lo + _StackGuard æº¢å‡ºè­¦æˆ’çº¿ newg.stackguard0 = newg.stack.lo + _StackGuard // è®¾ç½®newg.stackguard0 newg.stackguard1 = ^uintptr(0) // Clear the bottom word of the stack. We record g // there on gsignal stack during VDSO on ARM and ARM64. // // æ¸…é™¤å †æ ˆçš„åº•éƒ¨å•è¯ã€‚åœ¨ARMå’ŒARM64ä¸Šè¿›è¡ŒVDSOæ—¶ï¼Œæˆ‘ä»¬åœ¨gsignalå †æ ˆä¸Šè®°å½•gã€‚ // è¿™é‡Œä¿®æ”¹çš„æ˜¯ newg.stack.lo åœ°å€æŒ‡å‘çš„å€¼ä¸º0ï¼Œä¸æ˜¯ newg.stack.lo = 0ã€‚ *(*uintptr)(unsafe.Pointer(newg.stack.lo)) = 0 } return newg } gostartcallfn() è¯¥å‡½æ•°ä¸»è¦ä½œç”¨æ˜¯å¤„ç†goå…³é”®æ³¨å†Œçš„é—­åŒ…ï¼Œä»¥åŠnewgä»å“ªé‡Œè¿›å…¥ä»å“ªé‡Œé€€å‡ºç­‰ã€‚ è°ƒæ•´gobufï¼Œè®©å®ƒåƒæ‰§è¡Œäº†å¯¹fnçš„è°ƒç”¨ä¸€æ ·ï¼Œç„¶ååœ¨fnä¸­çš„ç¬¬ä¸€ä¸ªæŒ‡ä»¤ä¹‹å‰åœæ­¢ã€‚ å‚æ•°ï¼š gobuf *gobufï¼šgoroutineçš„è°ƒåº¦ä¿¡æ¯ã€‚ fv *funcvalï¼šgoroutineè¦æ‰§è¡Œçš„é—­åŒ…ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/stack.goã€‚ 1125 1126 1127 1128 1129 1130 1131 1132 1133 1134 1135 1136 1137 1138 1139 1140 1141 1142 1143 1144 // adjust Gobuf as if it executed a call to fn // and then stopped before the first instruction in fn. func gostartcallfn(gobuf *gobuf, fv *funcval) { var fn unsafe.Pointer\tif fv != nil { // çŸ¥é“é—­åŒ…çš„ç»“æ„ï¼ŒçŸ¥é“fv.fnä¸ºæ³¨å†Œå‡½æ•°çš„åœ°å€ // fn: gorotineçš„å…¥å£åœ°å€ï¼Œåˆå§‹åŒ–æ—¶å¯¹åº”çš„æ˜¯runtime.main fn = unsafe.Pointer(fv.fn)\t} else { // //go:nosplit // func nilfunc() { // *(*uint8)(nil) = 0 // } // å¦‚æœä¼ å…¥ã€nilã€‘çš„å‡½æ•°é—­åŒ…ï¼Œåˆ™å°è£…nilfuncå‡½æ•°ï¼Œè¿è¡Œèµ·æ¥è¯¥å‡½æ•°ä¼šæŠ¥é”™ã€‚ fn = unsafe.Pointer(abi.FuncPCABIInternal(nilfunc)) } // unsafe.Pointer(fv) ä½œä¸ºfnçš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¼ å…¥ // unsafe.Pointer(fv) ä¼šä¼ å…¥DXå¯„å­˜å™¨ï¼ŒDXå¯„å­˜å™¨ç”¨äºé—­åŒ…è°ƒç”¨éšè—ä¼ å€¼ gostartcall(gobuf, fn, unsafe.Pointer(fv))\t} gostartcall() è¯¥å‡½æ•°ä¸»è¦æ•°å¤„ç†newgä»å“ªé‡Œè¿›å…¥ä»å“ªé‡Œé€€å‡ºã€‚ ä¼ªè£…newgæ³¨å†Œçš„å‡½æ•°æ˜¯ä»goexit+1ä»£ç å¤„è°ƒç”¨fnå‡½æ•°ï¼Œè¯¥newgæ‰§è¡Œå®Œåä¼šæ¥åˆ°æ‰§è¡Œgoexit+1åé¢ä»£ç ã€‚ è¯¥å‡½æ•°æ˜¯è®¾ç½®goroutineä»å“ªé‡Œè¿›å…¥ä»å“ªé‡Œå‡ºå»çš„å…³é”®ã€‚ å‚æ•°ï¼š buf *gobufï¼šgoroutineçš„è°ƒåº¦ä¿¡æ¯ã€‚ fn unsafe.Pointerï¼šé—­åŒ…å‡½æ•°funcval.fnçš„å€¼ã€‚ ctxt unsafe.Pointerï¼šé—­åŒ…å‡½æ•°funcvalçš„åœ°å€ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/sys_x86.goã€‚ 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 // adjust Gobuf as if it executed a call to fn with context ctxt // and then stopped before the first instruction in fn. func gostartcall(buf *gobuf, fn, ctxt unsafe.Pointer) { sp := buf.sp // buf.sp æ ˆå¼€å§‹çš„ä½ç½® sp -= goarch.PtrSize // ä¸ºè¿”å›åœ°å€é¢„ç•™8Bç©ºé—´ // è¿™é‡Œåœ¨ä¼ªè£…fnæ˜¯è¢«goexit()å‡½æ•°è°ƒç”¨çš„ï¼Œä½¿å¾—fnæ‰§è¡Œå®Œåè¿”å›åˆ°goexitç»§ç»­æ‰§è¡Œï¼Œä»è€Œå®Œæˆæ¸…ç†å·¥ä½œ *(*uintptr)(unsafe.Pointer(sp)) = buf.pc // æŠŠgoexit+1ä»£ç åœ°å€æ”¾å…¥è¯¥å¤„ï¼Œæ¨¡æ‹Ÿæ˜¯è¢«goexitå‡½æ•°è°ƒç”¨çš„ buf.sp = sp // é‡æ–°è®¾ç½®newgçš„æ ˆé¡¶å¯„å­˜å™¨ // è¿™é‡Œæ‰çœŸæ­£è®©newgçš„ipå¯„å­˜å™¨æŒ‡å‘fnå‡½æ•°ï¼Œæ³¨æ„ï¼Œè¿™é‡Œåªæ˜¯åœ¨è®¾ç½®newgçš„ä¸€äº›ä¿¡æ¯ï¼Œnewgè¿˜æœªæ‰§è¡Œï¼Œ // ç­‰åˆ°newgè¢«è°ƒåº¦èµ·æ¥è¿è¡Œæ—¶ï¼Œè°ƒåº¦å™¨ä¼šæŠŠbuf.pcæ”¾å…¥cpuçš„IPå¯„å­˜å™¨ï¼Œ // ä»è€Œä½¿newgå¾—ä»¥åœ¨cpuä¸ŠçœŸæ­£çš„è¿è¡Œèµ·æ¥ buf.pc = uintptr(fn) // è¯¥å€¼ç”¨åœ¨é—­åŒ…çš„è°ƒç”¨ DX å¯„å­˜å™¨éœ€è¦çš„ä¸Šä¸‹æ–‡ï¼Œè¯¥å€¼æ˜¯è°ƒåº¦èµ·fnå‡½æ•°çš„å…³é”® buf.ctxt = ctxt // ä¿å­˜å½“å‰goroutineä¸Šä¸‹ç¯å¢ƒä¿¡æ¯ } runtime.gpexit() å½“goroutineè¿è¡Œå®Œæ—¶ä¼šè¿”å›åˆ°è¯¥å‡½æ•°å¤„ç»§ç»­è¿è¡Œåç»­æ”¶å°¾å·¥ä½œã€‚ éƒ¨åˆ†äººå¯èƒ½æ‹…å¿ƒgoexit()å‡½æ•°åŠ ä¸€ä¼šé€ æˆæŒ‡ä»¤é”™ä¹±ï¼Œå®é™…ä¸ä¼šæœ‰é—®é¢˜ï¼Œå› ä¸ºgoexit()å‡½æ•°çš„ä»£ç å·²ç»è€ƒè™‘åˆ°è¿™ä¸€å±‚äº†ã€‚ é¦–ä½å„æœ‰ä¸€æ¡NOPæŒ‡ä»¤å ä½ï¼Œæ‰€ä»¥å…¥å£åœ°å€åŠ ä¸€åä¸ä¼šå½±å“ï¼Œæ­£å¥½å¯¹å…¶åˆ°äº†æ¥ä¸‹æ¥çš„CALLæŒ‡ä»¤ã€‚ pcçš„å€¼ä¹‹æ‰€ä»¥éœ€è¦æ˜¯goexit()å‡½æ•°çš„åœ°å€åŠ ä¸€ï¼Œæ˜¯å› ä¸ºè¿™æ ·æ‰åƒæ˜¯goexit()å‡½æ•°è°ƒç”¨äº†fn()å‡½æ•°ï¼Œ å¦‚æœæŒ‡å‘goexit()å‡½æ•°çš„èµ·å§‹åœ°å€å°±ä¸åˆé€‚äº†ï¼Œé‚£æ ·goexit()å‡½æ•°çœ‹èµ·æ¥è¿˜æ²¡æœ‰æ‰§è¡Œã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ 1591 1592 1593 1594 1595 1596 1597 // The top-most function running on a goroutine // returns to goexit+PCQuantum. TEXT runtimeÂ·goexit(SB),NOSPLIT|TOPFRAME,$0-0 BYTE $0x90 // NOP CALL runtimeÂ·goexit1(SB) // does not return // traceback from goexit1 must hit code range of goexit BYTE $0x90 // NOP runqput() è¯¥å‡½æ•°ä¸»è¦æ˜¯æŠŠè®¾ç½®å¥½çš„newgæ”¾å…¥Må…³è”çš„Pçš„é¦–ä½ç½®æˆ–å…¨å±€Pä¸­ç­‰å¾…è¢«è°ƒåº¦å™¨è°ƒåº¦èµ·æ¥æ‰§è¡Œã€‚ è¯¥å‡½æ•°ä¹Ÿæ˜¯è°ƒåº¦å¾ªç¯ä¸­ä»å…¨å±€è¿è¡Œgé“¾è¡¨ä¸­å–å‡ºgæ”¾å…¥æœ¬åœ°Pè°ƒç”¨çš„å‡½æ•°ã€‚ å‚æ•°ï¼š _p_ *pï¼šå½“å‰å·¥ä½œçº¿ç¨‹mç»‘å®šçš„Pã€‚ gp *gï¼šæ–°åˆ›å»ºçš„goroutineã€‚ next boolï¼štrue.è¡¨ç¤ºè¿½åŠ åˆ°Pçš„é¦–ä½ç½® false.è¡¨ç¤ºè¿½åŠ åˆ°Pçš„æœ«å°¾ä½ç½®ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5780 5781 5782 5783 5784 5785 5786 5787 5788 5789 5790 5791 5792 5793 5794 5795 5796 5797 5798 5799 5800 5801 5802 5803 5804 5805 5806 5807 5808 5809 5810 5811 5812 5813 5814 5815 5816 5817 5818 5819 5820 5821 5822 5823 5824 5825 5826 5827 5828 5829 5830 5831 5832 5833 5834 5835 5836 5837 // runqput tries to put g on the local runnable queue. // If next is false, runqput adds g to the tail of the runnable queue. // If next is true, runqput puts g in the _p_.runnext slot. // If the run queue is full, runnext puts g on the global queue. // Executed only by the owner P. func runqput(_p_ *p, gp *g, next bool) { // è¿™é‡Œæ˜¯ä¸ºäº†æ›¾åŠ éšæœºæ€§ï¼Œnewgä¸æ˜¯æ€»å­˜å…¥æŒ‡å®šä½ç½®,fastrandn(2) å–éšæœºæ•°å¯¹2æ±‚ä½™ if randomizeScheduler \u0026\u0026 next \u0026\u0026 fastrandn(2) == 0 { next = false } // å¦‚æœæ˜¯è¿½åŠ åˆ°Pçš„é¦–ä½ç½®å¤„ if next { retryNext: // æŠŠgpæ”¾åœ¨_p_.runnextæˆå‘˜é‡Œï¼Œrunnextæˆå‘˜ä¸­çš„goroutineä¼šè¢«ä¼˜å…ˆè°ƒåº¦èµ·æ¥è¿è¡Œ oldnext := _p_.runnext // å¤„ç†æ—§çš„å°†è¦è¢«æ‰§è¡Œçš„goroutine // ä½¿ç”¨é”çš„å½¢å¼æ›¿æ¢_p_.runnextçš„å€¼ä¸ºgpæ–°å€¼ï¼Œå¦‚æœå­˜åœ¨å…¶ä»–goroutineåœ¨æ“ä½œrunnextæˆå‘˜åˆ™éœ€è¦é‡è¯• if !_p_.runnext.cas(oldnext, guintptr(unsafe.Pointer(gp))) { goto retryNext } // å¦‚æœä¹‹å‰éœ€è¦å¤„ç†çš„goroutineä¸ºç©ºåˆ™è¿”å›å³å¯ if oldnext == 0 { return } // Kick the old runnext out to the regular run queue. gp = oldnext.ptr() // è·å–æ—§çš„goroutineåœ°å€ } retry: // P.runqhead uint32 è®°å½•ç€å½“å‰goroutineé˜Ÿåˆ—çš„é˜Ÿåˆ—å¤´ä½ç½® ä¸€ç›´å¾€ä¸ŠåŠ ï¼Œåˆ°æœ€å¤§å€¼å˜ä¸º0 // P.runqtail uint32 è®°å½•ç€å½“å‰goroutineé˜Ÿåˆ—çš„é˜Ÿåˆ—å°¾ä½ç½® ä¸€ç›´å¾€ä¸ŠåŠ ï¼Œåˆ°æœ€å¤§å€¼å˜ä¸º0 // P.runq [256]guintptr ä½¿ç”¨æ•°ç»„å®ç°çš„å¾ªç¯é˜Ÿåˆ— // å¯èƒ½æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨å¹¶å‘å–runqheadæˆå‘˜ï¼Œæ‰€ä»¥éœ€è¦è·Ÿå…¶å®ƒçº¿ç¨‹åŒæ­¥ // è¿™é‡Œä¸ºä»€ä¹ˆåªåˆ¤æ–­_p_.runqheadé‚£æ˜¯å› ä¸ºæ‰€ä»¥å…¥æ•°æ®çš„éƒ½æ˜¯ä»é¦–å–èµ°çš„ h := atomic.LoadAcq(\u0026_p_.runqhead) // load-acquire, synchronize with consumers t := _p_.runqtail // å¦‚æœt-h \u003c 256åˆ™æ˜¯æ²¡æœ‰å­˜æ»¡ï¼Œå¯ä»¥æ¥åˆ°å­˜å‚¨g if t-h \u003c uint32(len(_p_.runq)) { // åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦æ»¡äº† // é˜Ÿåˆ—è¿˜æ²¡å­˜æ»¡å¯ä»¥æ”¾å…¥æœ¬åœ°Pçš„é˜Ÿåˆ—ä¸­ï¼Œè¿™é‡Œæ”¾å…¥çš„æ˜¯tçš„ä½ç½®å¤„ _p_.runq[t%uint32(len(_p_.runq))].set(gp) // è™½ç„¶æ²¡æœ‰å…¶ä»–çº¿ç¨‹å¹¶å‘ä¿®æ”¹è¿™ä¸ªrunqtailï¼Œä½†å…¶ä»–çº¿ç¨‹ä¼šå¹¶å‘è¯»å–è¯¥å€¼ä»¥åŠpçš„runqæˆå‘˜ // è¿™é‡Œä½¿ç”¨StoreRelæ˜¯ä¸ºäº†ï¼š // 1. åŸå­å†™å…¥runqtail // 2. é˜²æ­¢ç¼–è¯‘å™¨å’ŒCPUä¹±åºï¼Œä¿è¯ä¸Šä¸€è¡Œä»£ç å¯¹runqçš„ä¿®æ”¹å‘ç”Ÿåœ¨ä¿®æ”¹runqtailä¹‹å‰ // 3. å¯è§è¡Œå±éšœï¼Œä¿è¯å½“å‰çº¿ç¨‹å¯¹è¿è¡Œé˜Ÿåˆ—çš„ä¿®æ”¹å¯¹å…¶ä»–çº¿ç¨‹ç«‹é©¬å¯è§ atomic.StoreRel(\u0026_p_.runqtail, t+1) // store-release, makes the item available for consumption return } // Pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—å·²æ»¡ï¼Œéœ€è¦æ”¾å…¥å…¨å±€è¿è¡Œé˜Ÿåˆ— // å¦‚æœè¿™é‡Œè¿”å›falseï¼Œåˆ™è¯´æ˜Pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—Gä¸­éƒ¨åˆ†Gè¢«å…¶ä»–Må·èµ°äº†ï¼Œç»§ç»­æ‰§è¡Œgoto retry if runqputslow(_p_, gp, h, t) { return } // the queue is not full, now the put above must succeed // é˜Ÿåˆ—æœªæ»¡ï¼Œç°åœ¨ä¸Šé¢çš„ put å¿…é¡»æˆåŠŸ goto retry } runqputslow() å°†På¾—æœ¬åœ°é˜Ÿåˆ—çš„gè¿ç§»éƒ¨åˆ†åˆ°å…¨å±€é˜Ÿåˆ—ä¸­ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5818 5819 5820 5821 5822 5823 5824 5825 5826 5827 5828 5829 5830 5831 5832 5833 5834 5835 5836 5837 5838 5839 5840 5841 5842 5843 5844 5845 5846 5847 5848 5849 5850 5851 5852 5853 5854 5855 5856 5857 5858 5859 5860 5861 5862 5863 5864 5865 5866 5867 5868 5869 5870 // Put g and a batch of work from local runnable queue on global queue. // Executed only by the owner P. func runqputslow(_p_ *p, gp *g, h, t uint32) bool { var batch [len(_p_.runq)/2 + 1]*g // gpåŠ ä¸Š_p_æœ¬åœ°é˜Ÿåˆ—çš„ä¸€åŠ // First, grab a batch from local queue. n := t - h // è®¡ç®—å½“å‰Pä¸­å­˜å‚¨çš„æ•°é‡n n = n / 2 // å–ä¸€åŠ if n != uint32(len(_p_.runq)/2) { // åˆ¤æ–­Pæ˜¯å¦å·²æ»¡ throw(\"runqputslow: queue is not full\") } // å¤åˆ¶Pæœ¬åœ°é˜Ÿåˆ—Gçš„ä¸€åŠï¼Œæ”¾å…¥batchä¸­ for i := uint32(0); i \u003c n; i++ { // ä»Pçš„æœ¬åœ°é˜Ÿåˆ—headå¼€å¤´å¼€å§‹å¤åˆ¶ä¸€åŠå­˜å…¥batchä¸­ batch[i] = _p_.runq[(h+i)%uint32(len(_p_.runq))].ptr() } // è¿™é‡ŒæŠŠ_p_.runqheadå€¼è®¾ç½®æˆh+nï¼Œå¹¶åˆ¤æ–­æ—§å€¼hæ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–åˆ™è¯´æ˜å…¶ä»–goroutineæ­£åœ¨å·å–g if !atomic.CasRel(\u0026_p_.runqhead, h, h+n) { // cas-release, commits consume // å¦‚æœcasæ“ä½œå¤±è´¥ï¼Œè¯´æ˜å·²ç»æœ‰å…¶ä»–å·¥ä½œçº¿ç¨‹ä»_p_çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—å·èµ°ä¸€äº›goroutineï¼Œæ‰€ä»¥ç›´æ¥è¿”å› return false } batch[n] = gp // æœ€åä¸€ä¸ªä½ç½®å¤„è¿½åŠ gp // å¢åŠ éšæœºæ€§ æ‰“ä¹±batch if randomizeScheduler { for i := uint32(1); i \u003c= n; i++ { j := fastrandn(i + 1)\t// fastrand()%n batch[i], batch[j] = batch[j], batch[i] } } // Link the goroutines. // å…¨å±€è¿è¡Œé˜Ÿåˆ—æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œè¿™é‡Œé¦–å…ˆæŠŠæ‰€æœ‰éœ€è¦æ”¾å…¥å…¨å±€è¿è¡Œé˜Ÿåˆ—çš„gé“¾æ¥èµ·æ¥ // å‡å°‘åé¢å¯¹è¿å±…é“¾è¡¨çš„é”ä½æ—¶é—´ï¼Œä»è€Œé™ä½é”å†²çª // å‰ä¸€ä¸ªå’Œåä¸€ä¸ªé“¾æ¥èµ·æ¥ for i := uint32(0); i \u003c n; i++ { batch[i].schedlink.set(batch[i+1]) } // type gQueue struct { // head guintptr // tail guintptr // } var q gQueue q.head.set(batch[0]) // è®¾ç½®å¼€å¤´ q.tail.set(batch[n]) // è®¾ç½®ç»“å°¾ // Now put the batch on global queue. lock(\u0026sched.lock) // é”ä½å½“å‰sched globrunqputbatch(\u0026q, int32(n+1)) // æ‹¼æ¥åˆ°å…¨å±€sched.runqä¸Šå» unlock(\u0026sched.lock) // è§£é”å½“å‰sched return true } globrunqputbatch() æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5587 5588 5589 5590 5591 5592 5593 5594 5595 5596 5597 5598 // Put a batch of runnable goroutines on the global runnable queue. // This clears *batch. // sched.lock must be held. // May run during STW, so write barriers are not allowed. //go:nowritebarrierrec func globrunqputbatch(batch *gQueue, n int32) { assertLockHeld(\u0026sched.lock) sched.runq.pushBackAll(*batch) // æŠŠå½“å‰batché“¾æ¥åˆ°å…¨å±€sched.runqä¸Šå» sched.runqsize += n // ç´¯åŠ å½“å‰sched.runqsizeæ•°é‡ *batch = gQueue{} // æ¸…ç©º } acquirem() æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/runtime1.goã€‚ 473 474 475 476 477 478 //go:nosplit func acquirem() *m { _g_ := getg() _g_.m.locks++ return _g_.m } ",
  "wordCount" : "2970",
  "inLanguage": "zh",
  "image": "https://helium.github.io/favicon-32x32.png","datePublished": "2024-07-29T00:00:00Z",
  "dateModified": "2024-07-29T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://helium.github.io/posts/golang/goroutine/newproc/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://helium.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://helium.github.io/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://helium.github.io/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://helium.github.io/" title="ä¸»é¡µ">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/posts" title="æ–‡ç« ">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/archives" title="æ—¶é—´è½´">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/tags/" title="æ ‡ç­¾">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/search/" title="æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/support" title="æ‰“èµ">
                    <span>ğŸ«¶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://helium.github.io/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://helium.github.io/posts/">Article</a>&nbsp;Â»&nbsp;<a href="https://helium.github.io/posts/golang/">Golang</a>&nbsp;Â»&nbsp;<a href="https://helium.github.io/posts/golang/goroutine/">ç¬¬12ç«  Goroutine</a></div>
    <h1 class="post-title entry-hint-parent">
      go å…³é”®å­—
    </h1>
    <div class="post-description">
      ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬
    </div>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2024-07-29</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2024-07-29</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>2970å­—</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>14åˆ†é’Ÿ</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &nbsp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://helium.github.io/tags/golang/" target="_blank" rel="noopener">Golang</a>
            <a href="https://helium.github.io/tags/goroutine/" target="_blank" rel="noopener">Goroutine</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &nbsp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#newproc" aria-label="newproc()">newproc()</a><ul>
                            
                    <li>
                        <a href="#systemstack" aria-label="systemstack()">systemstack()</a></li>
                    <li>
                        <a href="#runtimesystemstack" aria-label="runtimeÂ·systemstack()">runtimeÂ·systemstack()</a></li>
                    <li>
                        <a href="#gosave_systemstack_switch" aria-label="gosave_systemstack_switch()">gosave_systemstack_switch()</a></li>
                    <li>
                        <a href="#systemstack_switch" aria-label="systemstack_switch()">systemstack_switch()</a></li></ul>
                    </li>
                    <li>
                        <a href="#newproc1" aria-label="newproc1()">newproc1()</a><ul>
                            
                    <li>
                        <a href="#gfget" aria-label="gfget()">gfget()</a></li>
                    <li>
                        <a href="#malg" aria-label="malg()">malg()</a></li>
                    <li>
                        <a href="#gostartcallfn" aria-label="gostartcallfn()">gostartcallfn()</a></li>
                    <li>
                        <a href="#runtimegpexit" aria-label="runtime.gpexit()">runtime.gpexit()</a></li></ul>
                    </li>
                    <li>
                        <a href="#runqput" aria-label="runqput()">runqput()</a><ul>
                            
                    <li>
                        <a href="#runqputslow" aria-label="runqputslow()">runqputslow()</a></li>
                    <li>
                        <a href="#globrunqputbatch" aria-label="globrunqputbatch()">globrunqputbatch()</a></li>
                    <li>
                        <a href="#acquirem" aria-label="acquirem()">acquirem()</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><ul>
<li><code>go</code>å…³é”®å­—æµç¨‹ï¼š
<ul>
<li><code>newproc()</code>å‡½æ•°æ˜¯<code>go</code>å…³é”®å­—åˆ›å»º<code>goroutine</code>çš„åˆå§‹åŒ–å‡½æ•°ã€‚</li>
<li>ä¹Ÿæ˜¯åˆ›å»ºç¬¬ä¸€ä¸ª<code>goroutine(runtime.main)</code>çš„å‡½æ•°ã€‚</li>
</ul>
</li>
</ul>
<h2 id="newproc">newproc()<a hidden class="anchor" aria-hidden="true" href="#newproc">#</a></h2>
<ol>
<li>è¯¥å‡½æ•°æ˜¯æ•´ä¸ª<code>go</code>å…³é”®å­—çš„æ‰§è¡Œæµç¨‹ä»£ç ï¼Œå…¶ä¸­åŒ…æ‹¬<code>newg</code>çš„åˆ›å»ºï¼Œ<code>newg</code>æ”¾å…¥<code>P</code>ä¸­ï¼Œå”¤é†’å…¶ä»–<code>P</code>èµ·æ¥å·¥ä½œç­‰ã€‚</li>
<li>åˆ›å»ºä¸€ä¸ªæ–°çš„<code>goroutine</code>è¿è¡Œ<code>fn</code>ã€‚æŠŠå®ƒæ”¾åˆ°ç­‰å¾…è¿è¡Œçš„<code>g</code>é˜Ÿåˆ—ä¸­ã€‚ç¼–è¯‘å™¨å°†<code>go</code>è¯­å¥è½¬æ¢ä¸ºå¯¹<code>this</code>çš„è°ƒç”¨ã€‚</li>
<li>å…³äºå‚æ•°çš„è¯´æ˜ï¼š
<ol>
<li><strong><code>fn *funcval</code></strong>ï¼š<code>fn</code>æ˜¯ä¸€ä¸ªé—­åŒ…å˜é‡ã€‚çœ‹è¿‡ä¹‹å‰ç‰ˆæœ¬çš„è¯¥å‡½æ•°å°±ä¼šå‘ç°<code>go A(1,2)</code>è¿™ç§å½¢å¼çš„å‚æ•°æ€ä¹ˆå¤„ç†çš„ï¼Ÿ</li>
<li>åœ¨ä¹‹å‰ç‰ˆæœ¬ä¸­è¯¥å‡½æ•°çš„å½¢å¼å¦‚è¿™<code>func newproc(siz int32, fn *funcval)</code>ï¼Œå¤šäº†ä¸€ä¸ª<code>siz</code>å‚æ•°è¡¨ç¤ºå‚æ•°å…±å å¤šå°‘å­—èŠ‚ã€‚</li>
<li>åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­<code>Go</code>çš„ä¼ å‚æ˜¯å…¥æ ˆå½¢å¼çš„ï¼Œåœ¨1.18ä¸­å·²ç»æ”¹æˆäº†å¯„å­˜å™¨ä¼ å‚å½¢å¼ã€‚</li>
<li>åœ¨1.18ä¸­åœ¨<code>A</code>å‡½æ•°çš„å¤–å±‚åœ¨å°è£…äº†ä¸€å±‚é—­åŒ…æ‰€ä»¥å°‘ä¼ ä¸€ä¸ªå‚æ•°ï¼Œ<code>go A(1,2) -&gt; go func() {A(1,2)}</code>ä½œä¸ºå‚æ•°ä¼ å…¥<code>newproc</code>å‡½æ•°ã€‚</li>
</ol>
</li>
<li><code>fn *funcval</code>ï¼šè¿™é‡Œçš„å‡½æ•°åŸå‹æ˜¯ <strong><code>func()</code></strong>ï¼Œæ²¡æœ‰å‚æ•°å’Œè¿”å›å€¼ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">4091
</span><span class="lnt">4092
</span><span class="lnt">4093
</span><span class="lnt">4094
</span><span class="lnt">4095
</span><span class="lnt">4096
</span><span class="lnt">4097
</span><span class="lnt">4098
</span><span class="lnt">4099
</span><span class="lnt">4100
</span><span class="lnt">4101
</span><span class="lnt">4102
</span><span class="lnt">4103
</span><span class="lnt">4104
</span><span class="lnt">4105
</span><span class="lnt">4106
</span><span class="lnt">4107
</span><span class="lnt">4108
</span><span class="lnt">4109
</span><span class="lnt">4110
</span><span class="lnt">4111
</span><span class="lnt">4112
</span><span class="lnt">4113
</span><span class="lnt">4114
</span><span class="lnt">4115
</span><span class="lnt">4116
</span><span class="lnt">4117
</span><span class="lnt">4118
</span><span class="lnt">4119
</span><span class="lnt">4120
</span><span class="lnt">4121
</span><span class="lnt">4122
</span><span class="lnt">4123
</span><span class="lnt">4124
</span><span class="lnt">4125
</span><span class="lnt">4126
</span><span class="lnt">4127
</span><span class="lnt">4128
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Create a new g running fn.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Put it on the queue of g&#39;s waiting to run.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The compiler turns a go statement into a call to this.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newproc</span><span class="p">(</span><span class="nx">fn</span> <span class="o">*</span><span class="nx">funcval</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// getgå‡½æ•°åœ¨æºä»£ç ä¸­æ²¡æœ‰å¯¹åº”çš„å®šä¹‰ï¼Œç”±ç¼–è¯‘å™¨æ’å…¥ç±»ä¼¼ä¸‹é¢ä¸¤è¡Œä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// get_tls(CX);    # è·å–fså¯„å­˜å™¨åœ°å€ï¼Œæ”¾å…¥å¯„å­˜å™¨CXä¸­ï¼Œfsåœ°å€è¢«è®¾ç½®æˆ&amp;m.tls[1]å¤„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// MOVQ g(CX), BX; # BXå­˜å™¨é‡Œé¢ç°åœ¨æ”¾çš„æ˜¯å½“å‰gçš„åœ°å€ï¼Œg(CX)è·å–fs-8ä½ç½®å­˜å‚¨æ•°æ®,ä¹Ÿå°±æ˜¯å½“å‰æ‰§è¡Œçš„gï¼Œä¹Ÿå°±æ˜¯m.tls[0]åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// è·å–å½“å‰è¿è¡Œçš„gï¼Œm.tls[0]å­˜å‚¨çš„å°±æ˜¯å½“å‰å·¥ä½œçº¿ç¨‹Mç»‘å®šçš„gï¼Œä¹Ÿå°±æ˜¯å½“å‰æ­£åœ¨è¿è¡Œçš„g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// getcallerpc()è¿”å›ä¸€ä¸ªåœ°å€ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨newprocæ—¶ç”±callæŒ‡ä»¤å‹æ ˆçš„å‡½æ•°è¿”å›åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯¹äºæˆ‘ä»¬ç°åœ¨è¿™ä¸ªåœºæ™¯æ¥è¯´ï¼Œpcå°±æ˜¯CALL runtimeÂ·newproc(SB)æŒ‡ä»¤åé¢çš„POPQ AXè¿™æ¡æŒ‡ä»¤çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸»è¦ç”¨äºæ–°åˆ›å»ºçš„ goroutine è®°å½•è‡ªå·±æ˜¯åœ¨å“ªé‡Œè¢«åˆ›å»ºçš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">pc</span> <span class="o">:=</span> <span class="nf">getcallerpc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// systemstackçš„ä½œç”¨æ˜¯åˆ‡æ¢åˆ°g0æ ˆæ‰§è¡Œä½œä¸ºå‚æ•°çš„å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æˆ‘ä»¬è¿™ä¸ªåœºæ™¯ç°åœ¨æœ¬èº«å°±åœ¨g0æ ˆï¼Œå› æ­¤ä»€ä¹ˆä¹Ÿä¸åšï¼Œç›´æ¥è°ƒç”¨ä½œä¸ºå‚æ•°çš„å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆ›å»ºä¸€ä¸ªæ–°çš„goroutineå¹¶åˆå§‹åŒ–ï¼Œè®¾ç½®å¥½æ ˆå¤§å°æ‰§è¡Œåœ°å€å’Œæ‰§è¡Œå®Œè¿”å›åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¯¥é—­åŒ…å‡½æ•°æ•è·fnã€gpã€pcä¸‰ä¸ªå˜é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ç”±äºfnå’Œgpéƒ½æ˜¯æŒ‡é’ˆï¼Œæ•è·å€¼å³å¯ï¼Œè€Œpcæ˜¯uintptrç±»å‹ï¼Œä¹Ÿæ˜¯æ•è·çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">newg</span> <span class="o">:=</span> <span class="nf">newproc1</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">pc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// ç”±äºå½“å‰åœ¨g0æ ˆä¸Šï¼Œå› æ­¤getg()è·å–çš„æ˜¯g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// getg().m è·å–çš„æ˜¯å½“å‰çš„å·¥ä½œçº¿ç¨‹M
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è·å–å½“å‰mç»‘å®šçš„P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_p_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">().</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æŠŠnewgæ”¾å…¥_p_çš„è¿è¡Œé˜Ÿåˆ—ï¼Œåˆå§‹åŒ–çš„æ—¶å€™ä¸€å®šæ˜¯pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å…¶å®ƒgoroutineçš„æ—¶å€™å¯èƒ½å› ä¸ºæœ¬åœ°é˜Ÿåˆ—æ»¡äº†è€Œæ”¾å…¥å…¨å±€é˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">runqput</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">newg</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="c1">// true.æ”¾å…¥Pçš„ç¬¬ä¸€ä½ï¼Œfalse.æ”¾å…¥Pçš„æœ€åä¸€ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">// mainStartedå…¨å±€å˜é‡æ ‡è®°ä¸»çº¿ç¨‹runtime.mainæ˜¯å¦å·²ç»å¯åŠ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å³ä¸»goroutineå·²ç»å¼€å§‹æ‰§è¡Œï¼Œæ­¤åæ‰ä¼šé€šè¿‡wakeup()å‡½æ•°å¯åŠ¨æ–°çš„å·¥ä½œçº¿ç¨‹ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä»¥ä¿è¯main()å‡½æ•°æ€»ä¼šè¢«ä¸»çº¿ç¨‹è°ƒåº¦æ‰§è¡Œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">mainStarted</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">wakep</span><span class="p">()</span>	<span class="c1">// å”¤é†’P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="systemstack">systemstack()<a hidden class="anchor" aria-hidden="true" href="#systemstack">#</a></h3>
<ol>
<li><code>systemstack</code>åœ¨ç³»ç»Ÿæ ˆä¸Šè¿è¡Œ<code>fn</code>ã€‚</li>
<li>å¦‚æœä»<code>per-OS-thread (g0)</code>æ ˆè°ƒç”¨<code>systemstack</code>ï¼Œæˆ–è€…ä»ä¿¡å·å¤„ç†(<code>gsignal</code>)æ ˆè°ƒç”¨<code>systemstack</code>ï¼Œåˆ™<code>systemstack</code>ç›´æ¥è°ƒç”¨<code>fn</code>å¹¶ä¸”è¿”å›ã€‚</li>
<li>å¦åˆ™ï¼Œ<code>systemstack</code>å°†ä»æ™®é€š<code>goroutine</code>çš„æœ‰é™æ ˆä¸­è°ƒç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>systemstack</code>åˆ‡æ¢åˆ°<code>per-OS-thread</code>æ ˆï¼Œè°ƒç”¨<code>fn</code>ç„¶ååˆ‡æ¢å›æ¥ã€‚</li>
<li>é€šå¸¸ä½¿ç”¨ <code>fn</code> å­—é¢é‡ä½œä¸ºå‚æ•°ï¼Œä»¥ä¾¿äºç³»ç»Ÿæ ˆè°ƒç”¨å‘¨å›´çš„ä»£ç è´¡çŒ®è¾“å…¥å’Œè¾“å‡ºï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//  ... set up y ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">x</span> <span class="p">=</span> <span class="nf">bigcall</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="c1">//  ... use x ...
</span></span></span></code></pre></div><ol start="5">
<li><code>go:noescape</code>ï¼šæŒ‡ç¤ºç¼–è¯‘å™¨åœ¨ç¼–è¯‘ä»£ç æ—¶ä¸å¯¹å‡½æ•°è¿›è¡Œé€ƒé€¸åˆ†æã€‚</li>
<li>å‘Šè¯‰ç¼–è¯‘å™¨è¯¥å‡½æ•°ä¸ä¼šå°†å…¶å‚æ•°çš„åœ°å€æ³„éœ²åˆ°å‡½æ•°å¤–éƒ¨ï¼Œå› æ­¤å¯ä»¥é¿å…é€ƒé€¸åˆ†æå’Œå †åˆ†é…ï¼Œä»è€Œæé«˜ä»£ç çš„æ€§èƒ½ã€‚</li>
<li>è¿™ä¸ªæŒ‡ä»¤é€šå¸¸åœ¨ä¸€äº›éœ€è¦é«˜æ€§èƒ½çš„å‡½æ•°ä¸­ä½¿ç”¨ï¼Œå¦‚ä¸€äº›å¸¸ç”¨çš„å†…ç½®å‡½æ•°æˆ–ä¸€äº›ç‰¹å®šçš„åº“å‡½æ•°ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/stubs.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// systemstack runs fn on a system stack.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If systemstack is called from the per-OS-thread (g0) stack, or
</span></span></span><span class="line"><span class="cl"><span class="c1">// if systemstack is called from the signal handling (gsignal) stack,
</span></span></span><span class="line"><span class="cl"><span class="c1">// systemstack calls fn directly and returns.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Otherwise, systemstack is being called from the limited stack
</span></span></span><span class="line"><span class="cl"><span class="c1">// of an ordinary goroutine. In this case, systemstack switches
</span></span></span><span class="line"><span class="cl"><span class="c1">// to the per-OS-thread stack, calls fn, and switches back.
</span></span></span><span class="line"><span class="cl"><span class="c1">// It is common to use a func literal as the argument, in order
</span></span></span><span class="line"><span class="cl"><span class="c1">// to share inputs and outputs with the code around the call
</span></span></span><span class="line"><span class="cl"><span class="c1">// to system stack:
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//  ... set up y ...
</span></span></span><span class="line"><span class="cl"><span class="c1">//  systemstack(func() {
</span></span></span><span class="line"><span class="cl"><span class="c1">//      x = bigcall(y)
</span></span></span><span class="line"><span class="cl"><span class="c1">//  })
</span></span></span><span class="line"><span class="cl"><span class="c1">//  ... use x ...
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:noescape
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">systemstack</span><span class="p">(</span><span class="nx">fn</span> <span class="kd">func</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="runtimesystemstack">runtimeÂ·systemstack()<a hidden class="anchor" aria-hidden="true" href="#runtimesystemstack">#</a></h3>
<ol>
<li><code>systemstack</code>å‡½æ•°è¢«è®¾è®¡ç”¨æ¥ä¸´æ—¶æ€§çš„åˆ‡æ¢è‡³å½“å‰<code>M</code>çš„<code>g0</code>æ ˆï¼Œå®ŒæˆæŸäº›æ“ä½œåå†åˆ‡æ¢å›åŸæ¥<code>goroutine</code>çš„æ ˆã€‚</li>
<li>è¯¥å‡½æ•°ä¸»è¦ç”¨äºæ‰§è¡Œ<code>runtime</code>ä¸­ä¸€äº›ä¼šè§¦å‘<strong>æ ˆå¢é•¿</strong>çš„å‡½æ•°ï¼Œå› ä¸º<code>goroutine</code>çš„æ ˆæ˜¯è¢«<code>runtime</code>ç®¡ç†çš„ï¼Œæ‰€ä»¥<code>runtime</code>ä¸­è¿™äº›é€»è¾‘å°±ä¸èƒ½åœ¨æ™®é€šçš„<code>gorooutine</code>ä¸Šæ‰§è¡Œï¼Œä»¥å…é™·å…¥é€’å½’ã€‚</li>
<li><code>g0</code>çš„æ ˆæ˜¯ç”±æ“ä½œç³»ç»Ÿåˆ†é…çš„ï¼Œå¯ä»¥è®¤ä¸ºç©ºé—´è¶³å¤Ÿå¤§ï¼Œè¢«<code>runtime</code>ç”¨æ¥æ‰§è¡Œè‡ªèº«é€»è¾‘éå¸¸å®‰å…¨ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/asm_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1"># func systemstack(fn func())
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">systemstack</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">NOSPLIT</span><span class="p">,</span> <span class="no">$0-8</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># é—­åŒ…å‚æ•° fn func()ï¼ŒæŠŠfnå­˜å…¥DIå¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">fn</span><span class="err">+</span><span class="mi">0</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">DI</span>    <span class="c1"># DI = fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">get_tls</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>             <span class="c1"># CX = &amp;m.tls[1]; TLS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è¿™é‡Œè·å–çš„gæ˜¯å½“å‰æ­£åœ¨è¿è¡Œçš„gï¼Œå¯èƒ½æ˜¯g0ä¹Ÿå¯èƒ½ä¸æ˜¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä»TLSè·å–å½“å‰gï¼Œå­˜å…¥AXå¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">g</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">AX</span>       <span class="c1"># AX = g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å½“å‰æ­£åœ¨è¿è¡Œçš„å·¥ä½œçº¿ç¨‹mï¼Œå°†g.må­˜å…¥BXå¯„å­˜å™¨ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">g_m</span><span class="p">(</span><span class="no">AX</span><span class="p">),</span> <span class="no">BX</span>     <span class="c1"># BX = m
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1"># 1) éªŒè¯æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1"># å¦‚æœå½“å‰ g æ˜¯ m.gsignal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è·³è½¬ noswitch æ²¡æœ‰ä»€ä¹ˆå¯åšç›´æ¥è°ƒç”¨ fn å³å¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å¯çŸ¥m.gsignalçš„æ ˆæ˜¯g0æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">m_gsignal</span><span class="p">(</span><span class="no">BX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JEQ</span> <span class="no">noswitch</span> <span class="c1"># gsignal ä¹Ÿæ˜¯ç³»ç»Ÿæ ˆï¼Œä¸ç”¨åˆ‡æ¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å°†m.g0å­˜å…¥DXå¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">m_g0</span><span class="p">(</span><span class="no">BX</span><span class="p">),</span> <span class="no">DX</span>    <span class="c1"># DX = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æ¯”è¾ƒ g å’Œ g0ï¼Œæ˜¯å¦æ˜¯ä¸€ä¸ªï¼Œå¦‚æœæ˜¯ç›´æ¥è·³è½¬ noswitch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æ¯”è¾ƒå½“å‰gæ˜¯ä¸æ˜¯g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">DX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JEQ</span>	<span class="no">noswitch</span> <span class="c1"># å·²ç»åœ¨g0ä¸Šï¼Œä¸éœ€è¦åˆ‡æ¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1"># æ¯”è¾ƒå½“å‰gæ˜¯å¦å’Œm.curgä¸ä¸€è‡´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æ¯”è¾ƒ g å’Œ m.curgï¼Œå¦‚æœä¸ç›¸ç­‰è·³è½¬ bad
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ç¨‹åºåˆšå¯åŠ¨åˆå§‹åŒ–æ—¶m.curgä¸ºnilï¼Œä¼šåœ¨å‰é¢çš„g0åˆ¤æ–­å¤„ç›´æ¥è·³è½¬äº†ï¼Œä¸ä¼šèµ°åˆ°è¿™é‡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä¸ºä»€ä¹ˆè¦æ¯”è¾ƒcrugæ˜¯å¦æ˜¯å½“å‰g?æ˜¯å› ä¸ºä»g0åˆ‡æ¢å›å½“å‰géœ€è¦m.curgè¿™ä¸ªå‚æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è¿™ç§æƒ…å†µåœ¨æ™®é€š goroutine åˆ‡æ¢ g0 æ ˆæ—¶ç”¨åˆ°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">m_curg</span><span class="p">(</span><span class="no">BX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JNE</span>	<span class="no">bad</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 2) å­˜å‚¨gä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># switch stacks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># save our state in g-&gt;sched. Pretend to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># be systemstack_switch if the G stack is scanned.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å°†å½“å‰gçš„ä¿¡æ¯ä¿å­˜åˆ° g-&gt;sched ä¸­ã€‚å¦‚æœGæ ˆå·²è¢«æ‰«æï¼Œåˆ™å‡è£…æ˜¯ systemstack_switch è°ƒç”¨çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä¿å­˜ goroutine çš„è°ƒåº¦ä¿¡æ¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">gosave_systemstack_switch</span><span class="err">&lt;&gt;</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 3) åˆ‡æ¢åˆ°g0æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># g0å†™å…¥TLSã€g0å†™å…¥R14å¯„å­˜å™¨ä¸­ã€g0çš„æ ˆé¡¶å€¼å†™å…¥SPå¯„å­˜å™¨ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># switch to g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">DX</span><span class="p">,</span> <span class="no">g</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>  <span class="c1"># g0å†™å…¥TLSä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># R14 = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">DX</span><span class="p">,</span> <span class="no">R14</span> <span class="c1"># set the g register
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># BX = g0.sched.gobuf.sp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="p">(</span><span class="no">g_sched</span><span class="err">+</span><span class="no">gobuf_sp</span><span class="p">)(</span><span class="no">DX</span><span class="p">),</span> <span class="no">BX</span> 
</span></span><span class="line"><span class="cl">    <span class="c1"># SP = g0.sched.gobuf.sp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">BX</span><span class="p">,</span> <span class="no">SP</span> <span class="c1"># æ¢å¤g0çš„SP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 4) è°ƒç”¨ fn å‡½æ•°ï¼Œæ­¤æ—¶å·²ç»åˆ‡æ¢åˆ°g0æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä¸Šä¸‹æ–‡ä¿¡æ¯åœ¨DXå¯„å­˜å™¨ä¸­ï¼ŒåŒ…å«é—­åŒ…æ•è·çš„å˜é‡åˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># call target function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">DI</span><span class="p">,</span> <span class="no">DX</span>      <span class="c1"># DX = fn = &amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="mi">0</span><span class="p">(</span><span class="no">DI</span><span class="p">),</span> <span class="no">DI</span>   <span class="c1"># DI = funcval.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">DI</span>          <span class="c1"># fn()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 5) åˆ‡æ¢å›gæ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æ³¨æ„ï¼šå½“ä»g0åˆ‡æ¢å›gçš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰å°†g0çš„çŠ¶æ€ä¿å­˜åˆ°g0.schedä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡ä»g0åˆ‡æ¢è‡³å…¶ä»–çš„goroutineåï¼Œg0æ ˆä¸Šçš„å†…å®¹å°±è¢«æŠ›å¼ƒäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä¸‹æ¬¡åˆ‡æ¢è‡³g0è¿˜æ˜¯ä»å¤´å¼€å§‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä»m.curgä¸­å–å‡ºgï¼Œç„¶åå†™å…¥TLSä¸­ï¼Œæ¢å¤SPå¯„å­˜å™¨çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è¿™é‡Œæ²¡æœ‰æ¢å¤PCå¯„å­˜å™¨å’ŒBPå¯„å­˜å™¨çš„å€¼ï¼Œå› ä¸ºPCå¯„å­˜å™¨çš„å€¼è¿™é‡Œä¸éœ€è¦æ¢å¤é¡ºåºæ‰§è¡Œä»£ç å³å¯ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># BPå¯„å­˜å™¨çš„å€¼åœ¨è°ƒç”¨systemstack()å‡½æ•°çš„æ•´ä¸ªè¿‡ç¨‹ä¸­éƒ½æ²¡æœ‰ä¿®æ”¹ï¼Œå› æ­¤ä¹Ÿä¸éœ€è¦æ¢å¤ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># switch back to g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">get_tls</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>             <span class="c1"># CX = &amp;m.tls[1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">g</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">AX</span>       <span class="c1"># AX = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">g_m</span><span class="p">(</span><span class="no">AX</span><span class="p">),</span> <span class="no">BX</span>     <span class="c1"># BX = m
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">m_curg</span><span class="p">(</span><span class="no">BX</span><span class="p">),</span> <span class="no">AX</span>  <span class="c1"># AX = m.curg; å½“å‰g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">g</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>       <span class="c1"># gå­˜å…¥TLS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è°ƒç”¨ systemstack å‡½æ•°å‰çš„ SP;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># R14å¯„å­˜å™¨åœ¨è¿™ä¸ªå‡½æ•°ä¸­æ²¡æœ‰è¢«è®¾ç½®å›æ¥ï¼Œåº”è¯¥æ˜¯ç¼–è¯‘å™¨è´Ÿè´£è®¾ç½®å›æ¥å§ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="p">(</span><span class="no">g_sched</span><span class="err">+</span><span class="no">gobuf_sp</span><span class="p">)(</span><span class="no">AX</span><span class="p">),</span> <span class="no">SP</span> <span class="c1"># æ¢å¤SP; SP = g.sched.gobuf.sp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$0</span><span class="p">,</span> <span class="p">(</span><span class="no">g_sched</span><span class="err">+</span><span class="no">gobuf_sp</span><span class="p">)(</span><span class="no">AX</span><span class="p">)</span> <span class="c1"># æ¸…é™¤ g.sched.gobuf.sp = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">RET</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">noswitch:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># already on m stack; tail call the function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># Using a tail call here cleans up tracebacks since we won&#39;t stop
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># at an intermediate systemstack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å·²ç»åœ¨mæ ˆä¸Šï¼›ç”±äºæˆ‘ä»¬ä¸ä¼šåœ¨ä¸­é—´ç³»ç»Ÿæ ˆä¸Šåœæ­¢ï¼Œå› æ­¤åœ¨è¿™é‡Œç›´æ¥è°ƒç”¨fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">DI</span><span class="p">,</span> <span class="no">DX</span>      <span class="c1"># DX = &amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="mi">0</span><span class="p">(</span><span class="no">DI</span><span class="p">),</span> <span class="no">DI</span>   <span class="c1"># DI = funcval.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JMP</span>	<span class="no">DI</span> <span class="c1"># è°ƒç”¨fnå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nl">bad:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Bad: g is not gsignal, not g0, not curg. What is it?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># Badï¼šg ä¸æ˜¯ gsignalï¼Œä¹Ÿä¸æ˜¯ g0ï¼Œä¸æ˜¯ curgã€‚å®ƒæ˜¯ä»€ä¹ˆï¼Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$runtime</span><span class="err">Â·</span><span class="no">badsystemstack</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CALL</span>    <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">INT</span>	<span class="no">$3</span>  <span class="c1"># è°ƒè¯•é”™è¯¯
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/goroutine-011.png" alt=""  />
</p>
<h3 id="gosave_systemstack_switch">gosave_systemstack_switch()<a hidden class="anchor" aria-hidden="true" href="#gosave_systemstack_switch">#</a></h3>
<ol>
<li>ä¿å­˜è°ƒç”¨è€…çŠ¶æ€åˆ°<code>g-&gt;sched</code>ï¼Œä½†æ˜¯ä¼ªè£…<code>PC</code>å€¼ä»<code>systemstack_switch</code>å‡½æ•°è°ƒç”¨çš„ã€‚</li>
<li>è¯¥å‡½æ•°åªèƒ½ä»æ²¡æœ‰å±€éƒ¨å˜é‡çš„ï¼ˆ<code>$0</code>ï¼‰çš„å‡½æ•°è°ƒç”¨ï¼Œå¦åˆ™<code>systemstack_switch</code>æ˜¯ä¸æ­£ç¡®çš„ã€‚</li>
<li><code>R9</code>å¯„å­˜å™¨çš„å€¼è¢«è¦†ç›–ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/asm_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">766
</span><span class="lnt">767
</span><span class="lnt">768
</span><span class="lnt">769
</span><span class="lnt">770
</span><span class="lnt">771
</span><span class="lnt">772
</span><span class="lnt">773
</span><span class="lnt">774
</span><span class="lnt">775
</span><span class="lnt">776
</span><span class="lnt">777
</span><span class="lnt">778
</span><span class="lnt">779
</span><span class="lnt">780
</span><span class="lnt">781
</span><span class="lnt">782
</span><span class="lnt">783
</span><span class="lnt">784
</span><span class="lnt">785
</span><span class="lnt">786
</span><span class="lnt">787
</span><span class="lnt">788
</span><span class="lnt">789
</span><span class="lnt">790
</span><span class="lnt">791
</span><span class="lnt">792
</span><span class="lnt">793
</span><span class="lnt">794
</span><span class="lnt">795
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1"># Save state of caller into g-&gt;sched,
</span></span></span><span class="line"><span class="cl"><span class="c1"># but using fake PC from systemstack_switch.
</span></span></span><span class="line"><span class="cl"><span class="c1"># Must only be called from functions with no locals ($0)
</span></span></span><span class="line"><span class="cl"><span class="c1"># or else unwinding from systemstack_switch is incorrect.
</span></span></span><span class="line"><span class="cl"><span class="c1"># Smashes R9.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">gosave_systemstack_switch</span><span class="err">&lt;&gt;</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="p">,</span><span class="no">$0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">$runtime</span><span class="err">Â·</span><span class="no">systemstack_switch</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">R9</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># g.sched.gobuf.pc = $runtimeÂ·systemstack_switch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä¼ªè£…å½“å‰è°ƒç”¨æ˜¯ä» runtimeÂ·systemstack_switch å‡½æ•°å¼€å§‹çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä»systemstack()åé¢çš„ä»£ç çœ‹å‡ºï¼Œè¿™é‡Œçš„PCå€¼æ²¡æœ‰è¢«ä½¿ç”¨ï¼ŒåŸå› æ˜¯PCä¸éœ€è¦è¿˜åŸè®¾ç½®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å› ä¸ºsystemstack()å‡½æ•°æ˜¯é—­åŒ…è°ƒç”¨fn()å‡½æ•°ï¼Œå› æ­¤æ‰§è¡Œå®Œåè¿˜åœ¨è°ƒç”¨è€…çš„ä»£ç ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">R9</span><span class="p">,</span> <span class="p">(</span><span class="no">g_sched</span><span class="err">+</span><span class="no">gobuf_pc</span><span class="p">)(</span><span class="no">R14</span><span class="p">)</span> <span class="c1"># g.sched.gobuf.pc = runtimeÂ·systemstack_switch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å› ä¸ºè°ƒç”¨gosave_systemstack_switch()å‡½æ•°ä½¿ç”¨äº†CALLæŒ‡ä»¤ï¼Œæ‰€ä»¥ä¼šæŠŠè¿”å›åœ°å€å‹å…¥æ ˆä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å› æ­¤ 8(SP)çš„ä½ç½®æ­£å¥½æ˜¯è°ƒç”¨è€…å‡½æ•°çš„æ ˆï¼Œä¹Ÿå°±æ˜¯systemstack()å‡½æ•°çš„æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä»systemstack()å‡½æ•°çš„å‡½æ•°åŸå‹å¯çŸ¥ï¼Œè¯¥å‡½æ•°æ²¡æœ‰åˆ†é…æ ˆå¤§å°ä¸º0ï¼Œå› æ­¤ä¹Ÿæ˜¯è°ƒç”¨systemstack()å‡½æ•°çš„SPå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è¿™é‡Œæ˜¯newproc()å‡½æ•°çš„çš„æ ˆé¡¶çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">LEAQ</span>    <span class="mi">8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">R9</span> <span class="c1"># 8(SP) æ˜¯è°ƒç”¨è€…å‰çš„SPæŒ‡å‘çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">R9</span><span class="p">,</span> <span class="p">(</span><span class="no">g_sched</span><span class="err">+</span><span class="no">gobuf_sp</span><span class="p">)(</span><span class="no">R14</span><span class="p">)</span>     <span class="c1"># g.sched.gobuf.sp æŒ‡å‘è°ƒç”¨è€…SP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$0</span><span class="p">,</span> <span class="p">(</span><span class="no">g_sched</span><span class="err">+</span><span class="no">gobuf_ret</span><span class="p">)(</span><span class="no">R14</span><span class="p">)</span>    <span class="c1"># g.sched.gobuf.ret = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># BPå¯„å­˜å™¨ä¸SPä¸€æ ·ï¼Œè¿™é‡Œä¹Ÿæ˜¯newproc()å‡½æ•°çš„æ ˆåº•çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">BP</span><span class="p">,</span> <span class="p">(</span><span class="no">g_sched</span><span class="err">+</span><span class="no">gobuf_bp</span><span class="p">)(</span><span class="no">R14</span><span class="p">)</span>     <span class="c1"># g.sched.gobuf.bp = BP; è°ƒç”¨è€…BP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># Assert ctxt is zero. See func save.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æ–­è¨€ ctxt æ˜¯0ã€‚å‚çœ‹ func saveã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># g.sched.gobuf.ctxt å­˜å‚¨çš„æ˜¯é—­åŒ…çš„ä¸Šä¸‹æ–‡ï¼Œä¹Ÿå°±æ˜¯DXå¯„å­˜å™¨çš„å€¼æ˜¯å‡½æ•°çš„&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="p">(</span><span class="no">g_sched</span><span class="err">+</span><span class="no">gobuf_ctxt</span><span class="p">)(</span><span class="no">R14</span><span class="p">),</span> <span class="no">R9</span>   <span class="c1"># R9 = g.sched.gobuf.ctxt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">TESTQ</span>   <span class="no">R9</span><span class="p">,</span> <span class="no">R9</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JZ</span>	<span class="mi">2</span><span class="p">(</span><span class="no">PC</span><span class="p">)</span>   <span class="c1"># åˆ¤æ–­ç»“æœä¸º0åˆ™è·³è¿‡abort()å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">abort</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="systemstack_switch">systemstack_switch()<a hidden class="anchor" aria-hidden="true" href="#systemstack_switch">#</a></h3>
<ol>
<li>æ–‡ä»¶ä½ç½®ï¼šï¼š<code>go1.19.3/src/runtime/asm_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1"># systemstack_switch is a dummy routine that systemstack leaves at the bottom
</span></span></span><span class="line"><span class="cl"><span class="c1"># of the G stack. We need to distinguish the routine that
</span></span></span><span class="line"><span class="cl"><span class="c1"># lives at the bottom of the G stack from the one that lives
</span></span></span><span class="line"><span class="cl"><span class="c1"># at the top of the system stack because the one at the top of
</span></span></span><span class="line"><span class="cl"><span class="c1"># the system stack terminates the stack walk (see topofstack()).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">systemstack_switch</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">NOSPLIT</span><span class="p">,</span> <span class="no">$0-0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="newproc1">newproc1()<a hidden class="anchor" aria-hidden="true" href="#newproc1">#</a></h2>
<ol>
<li>è¯¥å‡½æ•°ä¸»è¦æ˜¯åˆ›å»º<code>new goroutine</code>ï¼Œå¹¶è®¾ç½®<code>new goroutine</code>è¯¥ä»å“ªé‡Œè¿›å…¥å“ªé‡Œé€€å‡ºã€‚</li>
<li>ä»<code>fn</code>å¼€å§‹ï¼Œåˆ›å»ºä¸€ä¸ªçŠ¶æ€ä¸º<code>_Grunnable</code>çš„æ–°<code>g</code>ã€‚</li>
<li><code>callerpc</code> æ˜¯åˆ›å»ºè¿™ä¸ª<code>go</code>è¯­å¥çš„åœ°å€ï¼ˆä¹Ÿå°±æ˜¯<code>go</code>å…³é”®å­—ä»£ç çš„ä¸‹ä¸€æ¡æŒ‡é’ˆï¼‰ã€‚</li>
<li>è°ƒç”¨è€…è´Ÿè´£å°†æ–°çš„<code>g</code>æ·»åŠ åˆ°è°ƒåº¦å™¨ã€‚</li>
<li>å‚æ•°ï¼š
<ol>
<li><strong><code>fn *funcval</code></strong>ï¼šè¦æ‰§è¡Œå‡½æ•°çš„é—­åŒ…ã€‚ä¹Ÿå°±æ˜¯<code>go</code>å…³é”®å­—åé¢çš„å‡½æ•°é—­åŒ…ï¼Œä¸è¿‡å‡½æ•°é—­åŒ…åŸå‹æ˜¯<code>func()</code>ã€‚</li>
<li><strong><code>callergp *g</code></strong>ï¼šå½“å‰æ­£åœ¨è¿è¡Œçš„<code>goroutine</code>ã€‚ä¹Ÿå°±æ˜¯è°ƒç”¨<code>go</code>å…³é”®å­—çš„<code>goroutine</code>ã€‚</li>
<li><strong><code>callerpc uintptr</code></strong>ï¼š<code>go</code>å…³é”®å­—çš„ä¸‹ä¸€è¡ŒæŒ‡ä»¤åœ°å€ã€‚ä¹Ÿå°±æ˜¯è°ƒç”¨<code>go</code>å…³é”®å­—åçš„ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</li>
</ol>
</li>
<li>è¿”å›å€¼ï¼š<strong><code>*g</code></strong>ï¼šæ–°åˆ›å»ºçš„<code>goroutine</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">4109
</span><span class="lnt">4110
</span><span class="lnt">4111
</span><span class="lnt">4112
</span><span class="lnt">4113
</span><span class="lnt">4114
</span><span class="lnt">4115
</span><span class="lnt">4116
</span><span class="lnt">4117
</span><span class="lnt">4118
</span><span class="lnt">4119
</span><span class="lnt">4120
</span><span class="lnt">4121
</span><span class="lnt">4122
</span><span class="lnt">4123
</span><span class="lnt">4124
</span><span class="lnt">4125
</span><span class="lnt">4126
</span><span class="lnt">4127
</span><span class="lnt">4128
</span><span class="lnt">4129
</span><span class="lnt">4130
</span><span class="lnt">4131
</span><span class="lnt">4132
</span><span class="lnt">4133
</span><span class="lnt">4134
</span><span class="lnt">4135
</span><span class="lnt">4136
</span><span class="lnt">4137
</span><span class="lnt">4138
</span><span class="lnt">4139
</span><span class="lnt">4140
</span><span class="lnt">4141
</span><span class="lnt">4142
</span><span class="lnt">4143
</span><span class="lnt">4144
</span><span class="lnt">4145
</span><span class="lnt">4146
</span><span class="lnt">4147
</span><span class="lnt">4148
</span><span class="lnt">4149
</span><span class="lnt">4150
</span><span class="lnt">4151
</span><span class="lnt">4152
</span><span class="lnt">4153
</span><span class="lnt">4154
</span><span class="lnt">4155
</span><span class="lnt">4156
</span><span class="lnt">4157
</span><span class="lnt">4158
</span><span class="lnt">4159
</span><span class="lnt">4160
</span><span class="lnt">4161
</span><span class="lnt">4162
</span><span class="lnt">4163
</span><span class="lnt">4164
</span><span class="lnt">4165
</span><span class="lnt">4166
</span><span class="lnt">4167
</span><span class="lnt">4168
</span><span class="lnt">4169
</span><span class="lnt">4170
</span><span class="lnt">4171
</span><span class="lnt">4172
</span><span class="lnt">4173
</span><span class="lnt">4174
</span><span class="lnt">4175
</span><span class="lnt">4176
</span><span class="lnt">4177
</span><span class="lnt">4178
</span><span class="lnt">4179
</span><span class="lnt">4180
</span><span class="lnt">4181
</span><span class="lnt">4182
</span><span class="lnt">4183
</span><span class="lnt">4184
</span><span class="lnt">4185
</span><span class="lnt">4186
</span><span class="lnt">4187
</span><span class="lnt">4188
</span><span class="lnt">4189
</span><span class="lnt">4190
</span><span class="lnt">4191
</span><span class="lnt">4192
</span><span class="lnt">4193
</span><span class="lnt">4194
</span><span class="lnt">4195
</span><span class="lnt">4196
</span><span class="lnt">4197
</span><span class="lnt">4198
</span><span class="lnt">4199
</span><span class="lnt">4200
</span><span class="lnt">4201
</span><span class="lnt">4202
</span><span class="lnt">4203
</span><span class="lnt">4204
</span><span class="lnt">4205
</span><span class="lnt">4206
</span><span class="lnt">4207
</span><span class="lnt">4208
</span><span class="lnt">4209
</span><span class="lnt">4210
</span><span class="lnt">4211
</span><span class="lnt">4212
</span><span class="lnt">4213
</span><span class="lnt">4214
</span><span class="lnt">4215
</span><span class="lnt">4216
</span><span class="lnt">4217
</span><span class="lnt">4218
</span><span class="lnt">4219
</span><span class="lnt">4220
</span><span class="lnt">4221
</span><span class="lnt">4222
</span><span class="lnt">4223
</span><span class="lnt">4224
</span><span class="lnt">4225
</span><span class="lnt">4226
</span><span class="lnt">4227
</span><span class="lnt">4228
</span><span class="lnt">4229
</span><span class="lnt">4230
</span><span class="lnt">4231
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Create a new g in state _Grunnable, starting at fn. callerpc is the
</span></span></span><span class="line"><span class="cl"><span class="c1">// address of the go statement that created this. The caller is responsible
</span></span></span><span class="line"><span class="cl"><span class="c1">// for adding the new g to the scheduler.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newproc1</span><span class="p">(</span><span class="nx">fn</span> <span class="o">*</span><span class="nx">funcval</span><span class="p">,</span> <span class="nx">callergp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">callerpc</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="o">*</span><span class="nx">g</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å–å½“å‰å·¥ä½œçº¿ç¨‹æ­£åœ¨è¿è¡Œçš„gï¼Œè¯¥gæ˜¯g0ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› ä¸ºnewproc1()å‡½æ•°åªä¼šåœ¨g0æ ˆä¸­è¢«è°ƒç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>   <span class="c1">// g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// &#34;go nil&#34; è¿™ç§å½¢å¼æ˜¯ä¸ä¼šå…è®¸çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// var fn func() // nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// go fn()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">fn</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">throwing</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">// do not dump full stacks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;go of nil func value&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// ç¦ç”¨æŠ¢å ï¼Œå› ä¸ºå®ƒå¯ä»¥åœ¨æœ¬åœ°å˜é‡ä¸­æŒæœ‰p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å°†å½“å‰g.m.locks++ï¼Œå½“å‰gæ˜¯g0ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">acquirem</span><span class="p">()</span> <span class="c1">// disable preemption because it can be holding p in a local var
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å–å½“å‰å·¥ä½œçº¿ç¨‹Mç»‘å®šçš„P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span> <span class="c1">// åˆå§‹åŒ–æ—¶_p_ = g0.m.pï¼Œä»å‰é¢çš„åˆ†æå¯ä»¥çŸ¥é“å…¶å®å°±æ˜¯allp[0]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">newg</span> <span class="o">:=</span> <span class="nf">gfget</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>   <span class="c1">// ä»Pçš„æœ¬åœ°ç¼“å†²é‡Œè·å–ä¸€ä¸ªæ²¡æœ‰ä½¿ç”¨çš„gï¼Œåˆå§‹åŒ–æ—¶æ²¡æœ‰ï¼Œè¿”å›nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœä»å½“å‰Pçš„ç©ºé—²gé“¾è¡¨ä¸­æ²¡æœ‰è·å–åˆ°gï¼Œåˆ™åˆ›å»ºä¸€ä¸ª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">newg</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// newä¸€ä¸ªgç»“æ„ä½“å¯¹è±¡ï¼Œç„¶åä»å †ä¸Šä¸ºå…¶åˆ†é…æ ˆï¼Œå¹¶è®¾ç½®gçš„stackæˆå‘˜å’Œä¸¤ä¸ªstackgardæˆå‘˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">newg</span> <span class="p">=</span> <span class="nf">malg</span><span class="p">(</span><span class="nx">_StackMin</span><span class="p">)</span>  <span class="c1">// _StackMin = 2048
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// _Gidle = 0ï¼šè¯¥çŠ¶æ€æ˜¯Gåˆšåˆšè¢«åˆ†é…è¿˜æ²¡åˆå§‹åŒ–æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// _Gdead = 6ï¼šè¯¥çŠ¶æ€è¡¨ç¤ºå½“å‰æ²¡æœ‰è¢«ç”¨åˆ°ï¼Œå®ƒå¯èƒ½åˆšåˆšå®Œæˆåˆå§‹åŒ–æˆ–åˆšåˆšé€€å‡ºè¿è¡Œï¼Œåœ¨ä¸€ä¸ªç©ºé—²é“¾è¡¨ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ³¨æ„è¿™é‡Œæ˜¯CASæ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">newg</span><span class="p">,</span> <span class="nx">_Gidle</span><span class="p">,</span> <span class="nx">_Gdead</span><span class="p">)</span> <span class="c1">// åˆå§‹åŒ–gçš„çŠ¶æ€ä¸º_Gdead
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ”¾å…¥å…¨å±€å˜é‡ã€allgsåˆ‡ç‰‡ã€‘ä¸­ï¼Œæ–°å¢çš„gå…¨éƒ¨éƒ½ä¼šåŠ å…¥è¿™é‡Œï¼Œå¹¶ä¸”ä¸ä¼šç§»é™¤ï¼Œè¿™ä¹Ÿç¡®ä¿GCä¸ä¼šå»é‡Šæ”¾å®ƒä»¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">allgadd</span><span class="p">(</span><span class="nx">newg</span><span class="p">)</span> <span class="c1">// publishes with a g-&gt;status of Gdead so GC scanner doesn&#39;t look at uninitialized stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// newg ç¼ºå°‘æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">newg</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;newproc1: newg missing stack&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// newg çš„çŠ¶æ€åº”è¯¥æ˜¯ _Gdeadï¼šgoroutineå½“å‰æ²¡æœ‰è¢«ç”¨åˆ°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">readgstatus</span><span class="p">(</span><span class="nx">newg</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">_Gdead</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;newproc1: new g is not Gdead&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒæ•´goroutineçš„æ ˆhiï¼Œç”¨äº usesLR ä¸ºtrueæ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sys.MinFrameSize = 0; goarch.PtrSize = 8; totalSize = 32;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// extra space in case of reads slightly beyond frame
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">totalSize</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="nx">goarch</span><span class="p">.</span><span class="nx">PtrSize</span> <span class="o">+</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">MinFrameSize</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// sys.StackAlign = 8; totalSize = 32;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">totalSize</span> <span class="p">=</span> <span class="nf">alignUp</span><span class="p">(</span><span class="nx">totalSize</span><span class="p">,</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">StackAlign</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ³¨æ„é¢„ç•™è¿™32å­—èŠ‚æ˜¯ä»æ ˆé«˜åœ°å€å¼€å§‹çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sp</span> <span class="o">:=</span> <span class="nx">newg</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span> <span class="o">-</span> <span class="nx">totalSize</span> <span class="c1">// é¢„ç•™32å­—èŠ‚ï¼Œä¸»è¦ç”¨äºä¸‹é¢usesLR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">spArg</span> <span class="o">:=</span> <span class="nx">sp</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">usesLR</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// caller&#39;s LR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">uintptr</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">sp</span><span class="p">))</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="nf">prepGoExitFrame</span><span class="p">(</span><span class="nx">sp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">spArg</span> <span class="o">+=</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">MinFrameSize</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æŠŠnewg.schedç»“æ„ä½“æˆå‘˜çš„æ‰€æœ‰æˆå‘˜è®¾ç½®ä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// newg.schedæ˜¯ä¸€ä¸ªgobufç»“æ„ä½“ï¼Œä¿å­˜çš„CPUä¸»è¦çš„å‡ ä¸ªå¯„å­˜å™¨çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memclrNoHeapPointers</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">newg</span><span class="p">.</span><span class="nx">sched</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">newg</span><span class="p">.</span><span class="nx">sched</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sp</span> <span class="p">=</span> <span class="nx">sp</span>  <span class="c1">// newg.sched.spå¯„å­˜å™¨rspå¾—å€¼ï¼Œä¹Ÿå°±æ˜¯newgçš„æ ˆé¡¶ï¼Œæ³¨æ„è¿™é‡Œå…¶å®æŒ‡å‘çš„æ˜¯rbpå­˜å‚¨çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">newg</span><span class="p">.</span><span class="nx">stktopsp</span> <span class="p">=</span> <span class="nx">sp</span>  <span class="c1">// æ ˆé¡¶ä½ç½®ï¼Œè¯¥å€¼ç”¨äºå›æº¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// newg.sched.pc ä¿å­˜çš„æ˜¯ripå¯„å­˜å™¨çš„å€¼ï¼Œnewg.sched.pc è¡¨ç¤ºå½“newgè¢«è°ƒåº¦èµ·æ¥è¿è¡Œæ—¶ä»è¿™ä¸ªåœ°å€å¼€å§‹æ‰§è¡ŒæŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æŠŠpcè®¾ç½®æˆäº†goexitè¿™ä¸ªå‡½æ•°åç§»1ï¼ˆsys.PCQuantumç­‰äº1ï¼‰çš„ä½ç½®ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œè®¾ç½®goroutineçš„æ‰§è¡Œåœ°å€ä¸ºgoexitå‡½æ•°çš„ç¬¬äºŒæ¡æŒ‡ä»¤çš„ä»£ç åœ°å€è€Œä¸æ˜¯fn.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è‡³äºä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšéœ€è¦ç­‰åˆ°åˆ†æå®Œgostartcallfnå‡½æ•°æ‰çŸ¥é“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// +PCQuantum so that previous instruction is in same function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">newg</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">pc</span> <span class="p">=</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABI0</span><span class="p">(</span><span class="nx">goexit</span><span class="p">)</span> <span class="o">+</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">PCQuantum</span> 
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">g</span> <span class="p">=</span> <span class="nf">guintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">newg</span><span class="p">))</span>   <span class="c1">// è®°å½•å½“å‰çš„gobufæ˜¯æ¥è‡ªnewgè¿™ä¸ªgoroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">gostartcallfn</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">newg</span><span class="p">.</span><span class="nx">sched</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span>  <span class="c1">// è¯¥å‡½æ•°å¤„ç†newgä»å“ªé‡Œè¿›å…¥ä»å“ªé‡Œé€€å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">newg</span><span class="p">.</span><span class="nx">gopc</span> <span class="p">=</span> <span class="nx">callerpc</span>            <span class="c1">// ä¿å­˜goå…³é”®å­—åçš„ä¸‹ä¸€æ¡ä»£ç åœ°å€ï¼Œä¸»è¦ç”¨äºtraceback
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">newg</span><span class="p">.</span><span class="nx">ancestors</span> <span class="p">=</span> <span class="nf">saveAncestors</span><span class="p">(</span><span class="nx">callergp</span><span class="p">)</span>    <span class="c1">// ä¿å­˜å½“å‰åˆ›å»ºgoå…³é”®çš„çš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è®¾ç½®newgçš„startpcä¸ºfn.fnï¼Œè¯¥æˆå‘˜ä¸»è¦ç”¨äºå‡½æ•°è°ƒç”¨æ ˆçš„tracebackå’Œæ ˆæ”¶ç¼©
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// newgçœŸæ­£ä»å“ªé‡Œå¼€å§‹æ‰§è¡Œå¹¶ä¸ä¾èµ–äºè¿™ä¸ªæˆå‘˜ï¼Œè€Œæ˜¯sched.pc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">newg</span><span class="p">.</span><span class="nx">startpc</span> <span class="p">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">fn</span> <span class="c1">// åœ¨isSystemGoroutineä¸­è¢«ç”¨åˆ°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åˆ¤æ–­å½“å‰goroutineæ˜¯å¦æ˜¯ç³»ç»Ÿgoroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// runtime.mainè¢«è®¤ä¸ºä¸æ˜¯ç³»ç»Ÿgoroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">isSystemGoroutine</span><span class="p">(</span><span class="nx">newg</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// sched.ngsysï¼šè®°å½•çš„æ˜¯ç³»ç»Ÿgoroutineçš„æ•°é‡ï¼Œä¼šè¢«åŸå­æ€§çš„æ›´æ–°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">ngsys</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Only user goroutines inherit pprof labels.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// user goroutine ç»§æ‰¿ labels
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">curg</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">newg</span><span class="p">.</span><span class="nx">labels</span> <span class="p">=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">curg</span><span class="p">.</span><span class="nx">labels</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Track initial transition?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç”¨äºç¡®å®æ˜¯å¦è·Ÿè¸ªè¿™ä¸ªG
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">newg</span><span class="p">.</span><span class="nx">trackingSeq</span> <span class="p">=</span> <span class="nb">uint8</span><span class="p">(</span><span class="nf">fastrand</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// gTrackingPeriod = 8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">newg</span><span class="p">.</span><span class="nx">trackingSeq</span><span class="o">%</span><span class="nx">gTrackingPeriod</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">newg</span><span class="p">.</span><span class="nx">tracking</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è®¾ç½®gçš„çŠ¶æ€ä¸º_Grunnableï¼Œè¡¨ç¤ºè¿™ä¸ªgä»£è¡¨çš„goroutineå¯ä»¥è¿è¡Œäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _Gdead = 6ï¼šè¯¥çŠ¶æ€è¡¨ç¤ºå½“å‰æ²¡æœ‰è¢«ç”¨åˆ°ï¼Œå®ƒå¯èƒ½åˆšåˆšå®Œæˆåˆå§‹åŒ–æˆ–åˆšåˆšé€€å‡ºè¿è¡Œï¼Œåœ¨ä¸€ä¸ªç©ºé—²é“¾è¡¨ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _Grunnable = 1ï¼šgoroutineåº”è¯¥åœ¨æŸä¸ªrunqä¸­ï¼Œå½“å‰å¹¶æ²¡æœ‰åœ¨è¿è¡Œç”¨æˆ·ä»£ç ï¼Œå®ƒçš„æ ˆä¸å½’è‡ªå·±æ‰€æœ‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">newg</span><span class="p">,</span> <span class="nx">_Gdead</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gcController</span><span class="p">.</span><span class="nf">addScannableStack</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">newg</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span><span class="o">-</span><span class="nx">newg</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">goidcache</span> <span class="o">==</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">goidcacheend</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Sched.goidgen is the last allocated id,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// this batch must be [sched.goidgen+1, sched.goidgen+GoidCacheBatch].
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// At startup sched.goidgen=0, so main goroutine receives goid=1.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_p_</span><span class="p">.</span><span class="nx">goidcache</span> <span class="p">=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">goidgen</span><span class="p">,</span> <span class="nx">_GoidCacheBatch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_p_</span><span class="p">.</span><span class="nx">goidcache</span> <span class="o">-=</span> <span class="nx">_GoidCacheBatch</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_p_</span><span class="p">.</span><span class="nx">goidcacheend</span> <span class="p">=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">goidcache</span> <span class="o">+</span> <span class="nx">_GoidCacheBatch</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// goid è¡¨ç¤ºGçš„å”¯ä¸€ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">newg</span><span class="p">.</span><span class="nx">goid</span> <span class="p">=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">goidcache</span><span class="p">)</span>    <span class="c1">// è®¾ç½®å½“å‰goåœ¨Pä¸­çš„ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">goidcache</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">newg</span><span class="p">.</span><span class="nx">racectx</span> <span class="p">=</span> <span class="nf">racegostart</span><span class="p">(</span><span class="nx">callerpc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceGoCreate</span><span class="p">(</span><span class="nx">newg</span><span class="p">,</span> <span class="nx">newg</span><span class="p">.</span><span class="nx">startpc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">releasem</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span> <span class="c1">// å…è®¸å½“å‰Mè¢«æŠ¢å 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">newg</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="gfget">gfget()<a hidden class="anchor" aria-hidden="true" href="#gfget">#</a></h3>
<ol>
<li>è¯¥å‡½æ•°ä¸»è¦æ˜¯ä»å½“å‰<code>P</code>ç©ºé—²çš„<code>G</code>é“¾è¡¨ä¸­è·å–<code>G</code>ï¼Œæˆ–è€…ä»å…¨å±€çš„<code>P</code>é“¾è¡¨ä¸­è·å–<code>G</code>ï¼Œå¦‚æœæœ¬åœ°<code>P</code>ä¸­æ²¡æœ‰ç©ºé—²çš„<code>G</code>åˆ™ä»å…¨å±€çš„<code>P</code>ä¸­è¿ç§»éƒ¨åˆ†<code>G</code>æ”¾å…¥æœ¬åœ°é<code>P</code>ä¸­ã€‚</li>
<li>ä»<code>gfree</code>åˆ—è¡¨è·å–ã€‚å¦‚æœå±€éƒ¨åˆ—è¡¨ä¸ºç©ºï¼Œåˆ™ä»å…¨å±€åˆ—è¡¨ä¸­è·å–ä¸€éƒ¨åˆ†åˆ°æœ¬åœ°ã€‚</li>
<li>å‚çœ‹ä¸‹é¢&quot;ç©ºé—²çš„gé“¾è¡¨&quot;ä¸­çš„<code>gfget</code>å‡½æ•°æ³¨é‡Šï¼Œæœ‰äº›å˜åŒ–ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">4282
</span><span class="lnt">4283
</span><span class="lnt">4284
</span><span class="lnt">4285
</span><span class="lnt">4286
</span><span class="lnt">4287
</span><span class="lnt">4288
</span><span class="lnt">4289
</span><span class="lnt">4290
</span><span class="lnt">4291
</span><span class="lnt">4292
</span><span class="lnt">4293
</span><span class="lnt">4294
</span><span class="lnt">4295
</span><span class="lnt">4296
</span><span class="lnt">4297
</span><span class="lnt">4298
</span><span class="lnt">4299
</span><span class="lnt">4300
</span><span class="lnt">4301
</span><span class="lnt">4302
</span><span class="lnt">4303
</span><span class="lnt">4304
</span><span class="lnt">4305
</span><span class="lnt">4306
</span><span class="lnt">4307
</span><span class="lnt">4308
</span><span class="lnt">4309
</span><span class="lnt">4310
</span><span class="lnt">4311
</span><span class="lnt">4312
</span><span class="lnt">4313
</span><span class="lnt">4314
</span><span class="lnt">4315
</span><span class="lnt">4316
</span><span class="lnt">4317
</span><span class="lnt">4318
</span><span class="lnt">4319
</span><span class="lnt">4320
</span><span class="lnt">4321
</span><span class="lnt">4322
</span><span class="lnt">4323
</span><span class="lnt">4324
</span><span class="lnt">4325
</span><span class="lnt">4326
</span><span class="lnt">4327
</span><span class="lnt">4328
</span><span class="lnt">4329
</span><span class="lnt">4330
</span><span class="lnt">4331
</span><span class="lnt">4332
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Get from gfree list.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If local list is empty, grab a batch from global list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">gfget</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="o">*</span><span class="nx">g</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nx">retry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœå½“å‰Pçš„gFreeä¸ºç©º å¹¶ä¸” å…¨å±€çš„gFree.stackæˆ–gFree.noStackä¸ä¸ºç©º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sched.gFree.stack è¡¨ç¤ºè¿™é‡Œçš„goroutineå¸¦æœ‰æ ˆå¤§å°çš„é»˜è®¤æ˜¯2KB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sched.gFree.noStack è¡¨ç¤ºè¿™é‡Œçš„goroutineæ²¡æœ‰åˆ†é…æ ˆå¤§å°ï¼Œé»˜è®¤æ˜¯0KB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nf">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(!</span><span class="nx">sched</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nf">empty</span><span class="p">()</span> <span class="o">||</span> <span class="p">!</span><span class="nx">sched</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">noStack</span><span class="p">.</span><span class="nf">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Move a batch of free Gs to the P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">n</span> <span class="p">&lt;</span> <span class="mi">32</span> <span class="p">{</span>  <span class="c1">// å½“å‰Pçš„gFreeçš„æ•°é‡å°äº32ï¼Œä»sched.gFreeä¸­ç§»åŠ¨ä¸€éƒ¨åˆ†åˆ°Pçš„gFreeä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Prefer Gs with stacks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>   <span class="c1">// ä»ched.gFree.stackå–ä¸€ä¸ªG
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>  <span class="c1">// å–ä¸åˆ°ï¼Œåˆ™ä»sched.gFree.noStackå–ä¸€ä¸ªG
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">gp</span> <span class="p">=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">noStack</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sched</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">n</span><span class="o">--</span>     <span class="c1">// è®°å½•å½“å‰sched.gFreeå‡ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">_p_</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>  <span class="c1">// æŠŠå½“å‰å–åˆ°çš„GåŠ å…¥Pçš„gFreeä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">_p_</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">n</span><span class="o">++</span>       <span class="c1">// æŠŠPçš„gFreeçš„æ•°é‡åŠ ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="nx">retry</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>       <span class="c1">// ä»Pä¸­å–å‡ºä¸€ä¸ªG
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_p_</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">n</span><span class="o">--</span>           <span class="c1">// æ ‡è®°å½“å‰Pçš„gFreeå‡ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>   <span class="c1">// å¦‚æœå½“å‰Gçš„æ ˆé¡¶ä¸º0ï¼Œè¯´æ˜æ ˆè¢«é‡Šæ”¾äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Stack was deallocated in gfput. Allocate a new one.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å †æ ˆåœ¨gfput()å‡½æ•°ä¸­è¢«é‡Šæ”¾ åˆ†é…ä¸€ä¸ªæ–°çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span> <span class="p">=</span> <span class="nf">stackalloc</span><span class="p">(</span><span class="nx">_FixedStack</span><span class="p">)</span>  <span class="c1">// é‡æ–°åˆ†é…æ ˆä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">+</span> <span class="nx">_StackGuard</span>  <span class="c1">// æŠŠgp.stackguard0ä¹Ÿæ‰§è¡Œè¯¥ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">racemalloc</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span><span class="p">),</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span><span class="o">-</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">msanenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">msanmalloc</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span><span class="p">),</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span><span class="o">-</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">asanenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">asanunpoison</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span><span class="p">),</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span><span class="o">-</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">gp</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="malg">malg()<a hidden class="anchor" aria-hidden="true" href="#malg">#</a></h3>
<ol>
<li>è¯¥å‡½æ•°ä¸»è¦æ˜¯å¦‚æœä»<code>gfget()</code>å‡½æ•°ä¸­è·å–ä¸åˆ°ç©ºé—²çš„<code>g</code>ï¼Œé‚£ä¹ˆå°±è‡ªå·±åˆ†é…ä¸€ä¸ªï¼Œå¹¶è®¾ç½®æ ˆç©ºé—´</li>
<li>åˆ†é…ä¸€ä¸ªæ–°çš„<code>g</code>ï¼Œå®ƒçš„å †æ ˆè¶³å¤Ÿå¤§ï¼Œå¯ä»¥å®¹çº³<code>stacksize</code>å­—èŠ‚ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">4074
</span><span class="lnt">4075
</span><span class="lnt">4076
</span><span class="lnt">4077
</span><span class="lnt">4078
</span><span class="lnt">4079
</span><span class="lnt">4080
</span><span class="lnt">4081
</span><span class="lnt">4082
</span><span class="lnt">4083
</span><span class="lnt">4084
</span><span class="lnt">4085
</span><span class="lnt">4086
</span><span class="lnt">4087
</span><span class="lnt">4088
</span><span class="lnt">4089
</span><span class="lnt">4090
</span><span class="lnt">4091
</span><span class="lnt">4092
</span><span class="lnt">4093
</span><span class="lnt">4094
</span><span class="lnt">4095
</span><span class="lnt">4096
</span><span class="lnt">4097
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Allocate a new g, with a stack big enough for stacksize bytes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">malg</span><span class="p">(</span><span class="nx">stacksize</span> <span class="kt">int32</span><span class="p">)</span> <span class="o">*</span><span class="nx">g</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span>  <span class="c1">// åˆ›å»ºä¸€ä¸ªGï¼Œè¿™é‡Œæ˜¯å †åˆ†é…çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// éœ€è¦åˆ†é…æ ˆå¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">stacksize</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// _StackSystem = 0ï¼Œround2å‡½æ•°å‘ä¸Šå–æˆ2çš„å¹‚æ¬¡æ–¹ï¼Œstacksizeæ˜¯2KB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">stacksize</span> <span class="p">=</span> <span class="nf">round2</span><span class="p">(</span><span class="nx">_StackSystem</span> <span class="o">+</span> <span class="nx">stacksize</span><span class="p">)</span>    <span class="c1">// è®¡ç®—å¤§å°2çš„å¹‚æ¬¡æ–¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åˆ‡æ¢åˆ°g0æ ˆï¼Œå»åˆ†é…æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">            <span class="c1">// åˆ†é…æ ˆï¼Œgoroutineåœ¨linuxä¸Šé»˜è®¤æ˜¯2KBå¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">newg</span><span class="p">.</span><span class="nx">stack</span> <span class="p">=</span> <span class="nf">stackalloc</span><span class="p">(</span><span class="nb">uint32</span><span class="p">(</span><span class="nx">stacksize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ³¨æ„ï¼šstackguard0 = newg.stack.lo + _StackGuard æº¢å‡ºè­¦æˆ’çº¿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">newg</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">newg</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">+</span> <span class="nx">_StackGuard</span>  <span class="c1">// è®¾ç½®newg.stackguard0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">newg</span><span class="p">.</span><span class="nx">stackguard1</span> <span class="p">=</span> <span class="p">^</span><span class="nb">uintptr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Clear the bottom word of the stack. We record g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// there on gsignal stack during VDSO on ARM and ARM64.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ¸…é™¤å †æ ˆçš„åº•éƒ¨å•è¯ã€‚åœ¨ARMå’ŒARM64ä¸Šè¿›è¡ŒVDSOæ—¶ï¼Œæˆ‘ä»¬åœ¨gsignalå †æ ˆä¸Šè®°å½•gã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿™é‡Œä¿®æ”¹çš„æ˜¯ newg.stack.lo åœ°å€æŒ‡å‘çš„å€¼ä¸º0ï¼Œä¸æ˜¯ newg.stack.lo = 0ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">uintptr</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">newg</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span><span class="p">))</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">newg</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="gostartcallfn">gostartcallfn()<a hidden class="anchor" aria-hidden="true" href="#gostartcallfn">#</a></h3>
<ol>
<li>è¯¥å‡½æ•°ä¸»è¦ä½œç”¨æ˜¯å¤„ç†<code>go</code>å…³é”®æ³¨å†Œçš„é—­åŒ…ï¼Œä»¥åŠ<code>newg</code>ä»å“ªé‡Œè¿›å…¥ä»å“ªé‡Œé€€å‡ºç­‰ã€‚</li>
<li>è°ƒæ•´<code>gobuf</code>ï¼Œè®©å®ƒåƒæ‰§è¡Œäº†å¯¹<code>fn</code>çš„è°ƒç”¨ä¸€æ ·ï¼Œç„¶ååœ¨<code>fn</code>ä¸­çš„ç¬¬ä¸€ä¸ªæŒ‡ä»¤ä¹‹å‰åœæ­¢ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>gobuf *gobuf</code>ï¼š<code>goroutine</code>çš„è°ƒåº¦ä¿¡æ¯ã€‚</li>
<li><code>fv *funcval</code>ï¼š<code>goroutine</code>è¦æ‰§è¡Œçš„é—­åŒ…ã€‚</li>
</ul>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/stack.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1125
</span><span class="lnt">1126
</span><span class="lnt">1127
</span><span class="lnt">1128
</span><span class="lnt">1129
</span><span class="lnt">1130
</span><span class="lnt">1131
</span><span class="lnt">1132
</span><span class="lnt">1133
</span><span class="lnt">1134
</span><span class="lnt">1135
</span><span class="lnt">1136
</span><span class="lnt">1137
</span><span class="lnt">1138
</span><span class="lnt">1139
</span><span class="lnt">1140
</span><span class="lnt">1141
</span><span class="lnt">1142
</span><span class="lnt">1143
</span><span class="lnt">1144
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// adjust Gobuf as if it executed a call to fn
</span></span></span><span class="line"><span class="cl"><span class="c1">// and then stopped before the first instruction in fn.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">gostartcallfn</span><span class="p">(</span><span class="nx">gobuf</span> <span class="o">*</span><span class="nx">gobuf</span><span class="p">,</span> <span class="nx">fv</span> <span class="o">*</span><span class="nx">funcval</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">fn</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>	
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">fv</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// çŸ¥é“é—­åŒ…çš„ç»“æ„ï¼ŒçŸ¥é“fv.fnä¸ºæ³¨å†Œå‡½æ•°çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// fn: gorotineçš„å…¥å£åœ°å€ï¼Œåˆå§‹åŒ–æ—¶å¯¹åº”çš„æ˜¯runtime.main
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">fn</span> <span class="p">=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">fv</span><span class="p">.</span><span class="nx">fn</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// //go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// func nilfunc() {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  *(*uint8)(nil) = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å¦‚æœä¼ å…¥ã€nilã€‘çš„å‡½æ•°é—­åŒ…ï¼Œåˆ™å°è£…nilfuncå‡½æ•°ï¼Œè¿è¡Œèµ·æ¥è¯¥å‡½æ•°ä¼šæŠ¥é”™ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">fn</span> <span class="p">=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABIInternal</span><span class="p">(</span><span class="nx">nilfunc</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// unsafe.Pointer(fv) ä½œä¸ºfnçš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¼ å…¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// unsafe.Pointer(fv) ä¼šä¼ å…¥DXå¯„å­˜å™¨ï¼ŒDXå¯„å­˜å™¨ç”¨äºé—­åŒ…è°ƒç”¨éšè—ä¼ å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">gostartcall</span><span class="p">(</span><span class="nx">gobuf</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">fv</span><span class="p">))</span>	
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

<p><details >
  <summary markdown="span">gostartcall()</summary>
  <blockquote>
<ol>
<li>è¯¥å‡½æ•°ä¸»è¦æ•°å¤„ç†<code>newg</code>ä»å“ªé‡Œè¿›å…¥ä»å“ªé‡Œé€€å‡ºã€‚</li>
<li>ä¼ªè£…<code>newg</code>æ³¨å†Œçš„å‡½æ•°æ˜¯ä»<code>goexit+1</code>ä»£ç å¤„è°ƒç”¨<code>fn</code>å‡½æ•°ï¼Œè¯¥<code>newg</code>æ‰§è¡Œå®Œåä¼šæ¥åˆ°æ‰§è¡Œ<code>goexit+1</code>åé¢ä»£ç ã€‚</li>
<li>è¯¥å‡½æ•°æ˜¯è®¾ç½®<code>goroutine</code>ä»å“ªé‡Œè¿›å…¥ä»å“ªé‡Œå‡ºå»çš„å…³é”®ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>buf *gobuf</code>ï¼š<code>goroutine</code>çš„è°ƒåº¦ä¿¡æ¯ã€‚</li>
<li><code>fn unsafe.Pointer</code>ï¼šé—­åŒ…å‡½æ•°<code>funcval.fn</code>çš„å€¼ã€‚</li>
<li><code>ctxt unsafe.Pointer</code>ï¼šé—­åŒ…å‡½æ•°<code>funcval</code>çš„åœ°å€ã€‚</li>
</ul>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/sys_x86.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// adjust Gobuf as if it executed a call to fn with context ctxt
</span></span></span><span class="line"><span class="cl"><span class="c1">// and then stopped before the first instruction in fn.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">gostartcall</span><span class="p">(</span><span class="nx">buf</span> <span class="o">*</span><span class="nx">gobuf</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">ctxt</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sp</span> <span class="o">:=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">sp</span>              <span class="c1">// buf.sp æ ˆå¼€å§‹çš„ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sp</span> <span class="o">-=</span> <span class="nx">goarch</span><span class="p">.</span><span class="nx">PtrSize</span>      <span class="c1">// ä¸ºè¿”å›åœ°å€é¢„ç•™8Bç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œåœ¨ä¼ªè£…fnæ˜¯è¢«goexit()å‡½æ•°è°ƒç”¨çš„ï¼Œä½¿å¾—fnæ‰§è¡Œå®Œåè¿”å›åˆ°goexitç»§ç»­æ‰§è¡Œï¼Œä»è€Œå®Œæˆæ¸…ç†å·¥ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">uintptr</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">sp</span><span class="p">))</span> <span class="p">=</span> <span class="nx">buf</span><span class="p">.</span><span class="nx">pc</span>  <span class="c1">// æŠŠgoexit+1ä»£ç åœ°å€æ”¾å…¥è¯¥å¤„ï¼Œæ¨¡æ‹Ÿæ˜¯è¢«goexitå‡½æ•°è°ƒç”¨çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">buf</span><span class="p">.</span><span class="nx">sp</span> <span class="p">=</span> <span class="nx">sp</span>               <span class="c1">// é‡æ–°è®¾ç½®newgçš„æ ˆé¡¶å¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œæ‰çœŸæ­£è®©newgçš„ipå¯„å­˜å™¨æŒ‡å‘fnå‡½æ•°ï¼Œæ³¨æ„ï¼Œè¿™é‡Œåªæ˜¯åœ¨è®¾ç½®newgçš„ä¸€äº›ä¿¡æ¯ï¼Œnewgè¿˜æœªæ‰§è¡Œï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç­‰åˆ°newgè¢«è°ƒåº¦èµ·æ¥è¿è¡Œæ—¶ï¼Œè°ƒåº¦å™¨ä¼šæŠŠbuf.pcæ”¾å…¥cpuçš„IPå¯„å­˜å™¨ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä»è€Œä½¿newgå¾—ä»¥åœ¨cpuä¸ŠçœŸæ­£çš„è¿è¡Œèµ·æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">buf</span><span class="p">.</span><span class="nx">pc</span> <span class="p">=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¯¥å€¼ç”¨åœ¨é—­åŒ…çš„è°ƒç”¨ DX å¯„å­˜å™¨éœ€è¦çš„ä¸Šä¸‹æ–‡ï¼Œè¯¥å€¼æ˜¯è°ƒåº¦èµ·fnå‡½æ•°çš„å…³é”®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">buf</span><span class="p">.</span><span class="nx">ctxt</span> <span class="p">=</span> <span class="nx">ctxt</span>           <span class="c1">// ä¿å­˜å½“å‰goroutineä¸Šä¸‹ç¯å¢ƒä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>

</details></p>

<h3 id="runtimegpexit">runtime.gpexit()<a hidden class="anchor" aria-hidden="true" href="#runtimegpexit">#</a></h3>
<ol>
<li>å½“<code>goroutine</code>è¿è¡Œå®Œæ—¶ä¼šè¿”å›åˆ°è¯¥å‡½æ•°å¤„ç»§ç»­è¿è¡Œåç»­æ”¶å°¾å·¥ä½œã€‚</li>
<li>éƒ¨åˆ†äººå¯èƒ½æ‹…å¿ƒ<code>goexit()</code>å‡½æ•°åŠ ä¸€ä¼šé€ æˆæŒ‡ä»¤é”™ä¹±ï¼Œå®é™…ä¸ä¼šæœ‰é—®é¢˜ï¼Œå› ä¸º<code>goexit()</code>å‡½æ•°çš„ä»£ç å·²ç»è€ƒè™‘åˆ°è¿™ä¸€å±‚äº†ã€‚</li>
<li>é¦–ä½å„æœ‰ä¸€æ¡<code>NOP</code>æŒ‡ä»¤å ä½ï¼Œæ‰€ä»¥å…¥å£åœ°å€åŠ ä¸€åä¸ä¼šå½±å“ï¼Œæ­£å¥½å¯¹å…¶åˆ°äº†æ¥ä¸‹æ¥çš„<code>CALL</code>æŒ‡ä»¤ã€‚</li>
<li><code>pc</code>çš„å€¼ä¹‹æ‰€ä»¥éœ€è¦æ˜¯<code>goexit()</code>å‡½æ•°çš„åœ°å€åŠ ä¸€ï¼Œæ˜¯å› ä¸ºè¿™æ ·æ‰åƒæ˜¯<code>goexit()</code>å‡½æ•°è°ƒç”¨äº†<code>fn()</code>å‡½æ•°ï¼Œ</li>
<li>å¦‚æœæŒ‡å‘<code>goexit()</code>å‡½æ•°çš„èµ·å§‹åœ°å€å°±ä¸åˆé€‚äº†ï¼Œé‚£æ ·<code>goexit()</code>å‡½æ•°çœ‹èµ·æ¥è¿˜æ²¡æœ‰æ‰§è¡Œã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/asm_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1591
</span><span class="lnt">1592
</span><span class="lnt">1593
</span><span class="lnt">1594
</span><span class="lnt">1595
</span><span class="lnt">1596
</span><span class="lnt">1597
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1">// The top-most function running on a goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1">// returns to goexit+PCQuantum.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">goexit</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="err">|</span><span class="no">TOPFRAME</span><span class="p">,</span><span class="no">$0-0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">BYTE</span>    <span class="no">$0x90</span>   <span class="c1">// NOP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">goexit1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="c1">// does not return
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// traceback from goexit1 must hit code range of goexit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">BYTE</span>    <span class="no">$0x90</span>   <span class="c1">// NOP
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/goroutine-012.png" alt=""  />
</p>
<h2 id="runqput">runqput()<a hidden class="anchor" aria-hidden="true" href="#runqput">#</a></h2>
<ol>
<li>è¯¥å‡½æ•°ä¸»è¦æ˜¯æŠŠè®¾ç½®å¥½çš„<code>newg</code>æ”¾å…¥<code>M</code>å…³è”çš„<code>P</code>çš„é¦–ä½ç½®æˆ–å…¨å±€<code>P</code>ä¸­ç­‰å¾…è¢«è°ƒåº¦å™¨è°ƒåº¦èµ·æ¥æ‰§è¡Œã€‚</li>
<li>è¯¥å‡½æ•°ä¹Ÿæ˜¯è°ƒåº¦å¾ªç¯ä¸­ä»å…¨å±€è¿è¡Œ<code>g</code>é“¾è¡¨ä¸­å–å‡º<code>g</code>æ”¾å…¥æœ¬åœ°<code>P</code>è°ƒç”¨çš„å‡½æ•°ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>_p_ *p</code>ï¼šå½“å‰å·¥ä½œçº¿ç¨‹<code>m</code>ç»‘å®šçš„<code>P</code>ã€‚</li>
<li><code>gp *g</code>ï¼šæ–°åˆ›å»ºçš„<code>goroutine</code>ã€‚</li>
<li><code>next bool</code>ï¼š<code>true</code>.è¡¨ç¤ºè¿½åŠ åˆ°<code>P</code>çš„é¦–ä½ç½® <code>false</code>.è¡¨ç¤ºè¿½åŠ åˆ°<code>P</code>çš„æœ«å°¾ä½ç½®ã€‚</li>
</ul>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5780
</span><span class="lnt">5781
</span><span class="lnt">5782
</span><span class="lnt">5783
</span><span class="lnt">5784
</span><span class="lnt">5785
</span><span class="lnt">5786
</span><span class="lnt">5787
</span><span class="lnt">5788
</span><span class="lnt">5789
</span><span class="lnt">5790
</span><span class="lnt">5791
</span><span class="lnt">5792
</span><span class="lnt">5793
</span><span class="lnt">5794
</span><span class="lnt">5795
</span><span class="lnt">5796
</span><span class="lnt">5797
</span><span class="lnt">5798
</span><span class="lnt">5799
</span><span class="lnt">5800
</span><span class="lnt">5801
</span><span class="lnt">5802
</span><span class="lnt">5803
</span><span class="lnt">5804
</span><span class="lnt">5805
</span><span class="lnt">5806
</span><span class="lnt">5807
</span><span class="lnt">5808
</span><span class="lnt">5809
</span><span class="lnt">5810
</span><span class="lnt">5811
</span><span class="lnt">5812
</span><span class="lnt">5813
</span><span class="lnt">5814
</span><span class="lnt">5815
</span><span class="lnt">5816
</span><span class="lnt">5817
</span><span class="lnt">5818
</span><span class="lnt">5819
</span><span class="lnt">5820
</span><span class="lnt">5821
</span><span class="lnt">5822
</span><span class="lnt">5823
</span><span class="lnt">5824
</span><span class="lnt">5825
</span><span class="lnt">5826
</span><span class="lnt">5827
</span><span class="lnt">5828
</span><span class="lnt">5829
</span><span class="lnt">5830
</span><span class="lnt">5831
</span><span class="lnt">5832
</span><span class="lnt">5833
</span><span class="lnt">5834
</span><span class="lnt">5835
</span><span class="lnt">5836
</span><span class="lnt">5837
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// runqput tries to put g on the local runnable queue.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If next is false, runqput adds g to the tail of the runnable queue.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If next is true, runqput puts g in the _p_.runnext slot.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If the run queue is full, runnext puts g on the global queue.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Executed only by the owner P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">runqput</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">next</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿™é‡Œæ˜¯ä¸ºäº†æ›¾åŠ éšæœºæ€§ï¼Œnewgä¸æ˜¯æ€»å­˜å…¥æŒ‡å®šä½ç½®,fastrandn(2) å–éšæœºæ•°å¯¹2æ±‚ä½™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">randomizeScheduler</span> <span class="o">&amp;&amp;</span> <span class="nx">next</span> <span class="o">&amp;&amp;</span> <span class="nf">fastrandn</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">next</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœæ˜¯è¿½åŠ åˆ°Pçš„é¦–ä½ç½®å¤„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">next</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">retryNext</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æŠŠgpæ”¾åœ¨_p_.runnextæˆå‘˜é‡Œï¼Œrunnextæˆå‘˜ä¸­çš„goroutineä¼šè¢«ä¼˜å…ˆè°ƒåº¦èµ·æ¥è¿è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">oldnext</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runnext</span>  <span class="c1">// å¤„ç†æ—§çš„å°†è¦è¢«æ‰§è¡Œçš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä½¿ç”¨é”çš„å½¢å¼æ›¿æ¢_p_.runnextçš„å€¼ä¸ºgpæ–°å€¼ï¼Œå¦‚æœå­˜åœ¨å…¶ä»–goroutineåœ¨æ“ä½œrunnextæˆå‘˜åˆ™éœ€è¦é‡è¯•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runnext</span><span class="p">.</span><span class="nf">cas</span><span class="p">(</span><span class="nx">oldnext</span><span class="p">,</span> <span class="nf">guintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">gp</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="nx">retryNext</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœä¹‹å‰éœ€è¦å¤„ç†çš„goroutineä¸ºç©ºåˆ™è¿”å›å³å¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">oldnext</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Kick the old runnext out to the regular run queue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">gp</span> <span class="p">=</span> <span class="nx">oldnext</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>  <span class="c1">// è·å–æ—§çš„goroutineåœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">retry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// P.runqhead uint32 è®°å½•ç€å½“å‰goroutineé˜Ÿåˆ—çš„é˜Ÿåˆ—å¤´ä½ç½® ä¸€ç›´å¾€ä¸ŠåŠ ï¼Œåˆ°æœ€å¤§å€¼å˜ä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// P.runqtail uint32 è®°å½•ç€å½“å‰goroutineé˜Ÿåˆ—çš„é˜Ÿåˆ—å°¾ä½ç½® ä¸€ç›´å¾€ä¸ŠåŠ ï¼Œåˆ°æœ€å¤§å€¼å˜ä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// P.runq [256]guintptr ä½¿ç”¨æ•°ç»„å®ç°çš„å¾ªç¯é˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯èƒ½æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨å¹¶å‘å–runqheadæˆå‘˜ï¼Œæ‰€ä»¥éœ€è¦è·Ÿå…¶å®ƒçº¿ç¨‹åŒæ­¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œä¸ºä»€ä¹ˆåªåˆ¤æ–­_p_.runqheadé‚£æ˜¯å› ä¸ºæ‰€ä»¥å…¥æ•°æ®çš„éƒ½æ˜¯ä»é¦–å–èµ°çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">h</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadAcq</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqhead</span><span class="p">)</span> <span class="c1">// load-acquire, synchronize with consumers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">t</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runqtail</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœt-h &lt; 256åˆ™æ˜¯æ²¡æœ‰å­˜æ»¡ï¼Œå¯ä»¥æ¥åˆ°å­˜å‚¨g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">t</span><span class="o">-</span><span class="nx">h</span> <span class="p">&lt;</span> <span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">))</span> <span class="p">{</span>    <span class="c1">// åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦æ»¡äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// é˜Ÿåˆ—è¿˜æ²¡å­˜æ»¡å¯ä»¥æ”¾å…¥æœ¬åœ°Pçš„é˜Ÿåˆ—ä¸­ï¼Œè¿™é‡Œæ”¾å…¥çš„æ˜¯tçš„ä½ç½®å¤„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">[</span><span class="nx">t</span><span class="o">%</span><span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">))].</span><span class="nf">set</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// è™½ç„¶æ²¡æœ‰å…¶ä»–çº¿ç¨‹å¹¶å‘ä¿®æ”¹è¿™ä¸ªrunqtailï¼Œä½†å…¶ä»–çº¿ç¨‹ä¼šå¹¶å‘è¯»å–è¯¥å€¼ä»¥åŠpçš„runqæˆå‘˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿™é‡Œä½¿ç”¨StoreRelæ˜¯ä¸ºäº†ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 1. åŸå­å†™å…¥runqtail
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 2. é˜²æ­¢ç¼–è¯‘å™¨å’ŒCPUä¹±åºï¼Œä¿è¯ä¸Šä¸€è¡Œä»£ç å¯¹runqçš„ä¿®æ”¹å‘ç”Ÿåœ¨ä¿®æ”¹runqtailä¹‹å‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 3. å¯è§è¡Œå±éšœï¼Œä¿è¯å½“å‰çº¿ç¨‹å¯¹è¿è¡Œé˜Ÿåˆ—çš„ä¿®æ”¹å¯¹å…¶ä»–çº¿ç¨‹ç«‹é©¬å¯è§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">atomic</span><span class="p">.</span><span class="nf">StoreRel</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqtail</span><span class="p">,</span> <span class="nx">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1">// store-release, makes the item available for consumption
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—å·²æ»¡ï¼Œéœ€è¦æ”¾å…¥å…¨å±€è¿è¡Œé˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœè¿™é‡Œè¿”å›falseï¼Œåˆ™è¯´æ˜Pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—Gä¸­éƒ¨åˆ†Gè¢«å…¶ä»–Må·èµ°äº†ï¼Œç»§ç»­æ‰§è¡Œgoto retry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">runqputslow</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// the queue is not full, now the put above must succeed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é˜Ÿåˆ—æœªæ»¡ï¼Œç°åœ¨ä¸Šé¢çš„ put å¿…é¡»æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">goto</span> <span class="nx">retry</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="runqputslow">runqputslow()<a hidden class="anchor" aria-hidden="true" href="#runqputslow">#</a></h3>
<ol>
<li>å°†<code>P</code>å¾—æœ¬åœ°é˜Ÿåˆ—çš„<code>g</code>è¿ç§»éƒ¨åˆ†åˆ°å…¨å±€é˜Ÿåˆ—ä¸­ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5818
</span><span class="lnt">5819
</span><span class="lnt">5820
</span><span class="lnt">5821
</span><span class="lnt">5822
</span><span class="lnt">5823
</span><span class="lnt">5824
</span><span class="lnt">5825
</span><span class="lnt">5826
</span><span class="lnt">5827
</span><span class="lnt">5828
</span><span class="lnt">5829
</span><span class="lnt">5830
</span><span class="lnt">5831
</span><span class="lnt">5832
</span><span class="lnt">5833
</span><span class="lnt">5834
</span><span class="lnt">5835
</span><span class="lnt">5836
</span><span class="lnt">5837
</span><span class="lnt">5838
</span><span class="lnt">5839
</span><span class="lnt">5840
</span><span class="lnt">5841
</span><span class="lnt">5842
</span><span class="lnt">5843
</span><span class="lnt">5844
</span><span class="lnt">5845
</span><span class="lnt">5846
</span><span class="lnt">5847
</span><span class="lnt">5848
</span><span class="lnt">5849
</span><span class="lnt">5850
</span><span class="lnt">5851
</span><span class="lnt">5852
</span><span class="lnt">5853
</span><span class="lnt">5854
</span><span class="lnt">5855
</span><span class="lnt">5856
</span><span class="lnt">5857
</span><span class="lnt">5858
</span><span class="lnt">5859
</span><span class="lnt">5860
</span><span class="lnt">5861
</span><span class="lnt">5862
</span><span class="lnt">5863
</span><span class="lnt">5864
</span><span class="lnt">5865
</span><span class="lnt">5866
</span><span class="lnt">5867
</span><span class="lnt">5868
</span><span class="lnt">5869
</span><span class="lnt">5870
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Put g and a batch of work from local runnable queue on global queue.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Executed only by the owner P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">runqputslow</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">t</span> <span class="kt">uint32</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">batch</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nx">g</span>   <span class="c1">// gpåŠ ä¸Š_p_æœ¬åœ°é˜Ÿåˆ—çš„ä¸€åŠ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// First, grab a batch from local queue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">n</span> <span class="o">:=</span> <span class="nx">t</span> <span class="o">-</span> <span class="nx">h</span>      <span class="c1">// è®¡ç®—å½“å‰Pä¸­å­˜å‚¨çš„æ•°é‡n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">n</span> <span class="p">=</span> <span class="nx">n</span> <span class="o">/</span> <span class="mi">2</span>       <span class="c1">// å–ä¸€åŠ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">n</span> <span class="o">!=</span> <span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">// åˆ¤æ–­Pæ˜¯å¦å·²æ»¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runqputslow: queue is not full&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¤åˆ¶Pæœ¬åœ°é˜Ÿåˆ—Gçš„ä¸€åŠï¼Œæ”¾å…¥batchä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä»Pçš„æœ¬åœ°é˜Ÿåˆ—headå¼€å¤´å¼€å§‹å¤åˆ¶ä¸€åŠå­˜å…¥batchä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">batch</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">[(</span><span class="nx">h</span><span class="o">+</span><span class="nx">i</span><span class="p">)</span><span class="o">%</span><span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">))].</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿™é‡ŒæŠŠ_p_.runqheadå€¼è®¾ç½®æˆh+nï¼Œå¹¶åˆ¤æ–­æ—§å€¼hæ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–åˆ™è¯´æ˜å…¶ä»–goroutineæ­£åœ¨å·å–g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">CasRel</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqhead</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">h</span><span class="o">+</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// cas-release, commits consume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å¦‚æœcasæ“ä½œå¤±è´¥ï¼Œè¯´æ˜å·²ç»æœ‰å…¶ä»–å·¥ä½œçº¿ç¨‹ä»_p_çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—å·èµ°ä¸€äº›goroutineï¼Œæ‰€ä»¥ç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">batch</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="p">=</span> <span class="nx">gp</span>   <span class="c1">// æœ€åä¸€ä¸ªä½ç½®å¤„è¿½åŠ gp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¢åŠ éšæœºæ€§ æ‰“ä¹±batch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">randomizeScheduler</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">j</span> <span class="o">:=</span> <span class="nf">fastrandn</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>	<span class="c1">// fastrand()%n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">batch</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">batch</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">batch</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">batch</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Link the goroutines.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å…¨å±€è¿è¡Œé˜Ÿåˆ—æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œè¿™é‡Œé¦–å…ˆæŠŠæ‰€æœ‰éœ€è¦æ”¾å…¥å…¨å±€è¿è¡Œé˜Ÿåˆ—çš„gé“¾æ¥èµ·æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å‡å°‘åé¢å¯¹è¿å±…é“¾è¡¨çš„é”ä½æ—¶é—´ï¼Œä»è€Œé™ä½é”å†²çª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å‰ä¸€ä¸ªå’Œåä¸€ä¸ªé“¾æ¥èµ·æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">batch</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">schedlink</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">batch</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// type gQueue struct {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     head guintptr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     tail guintptr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">q</span> <span class="nx">gQueue</span>
</span></span><span class="line"><span class="cl">    <span class="nx">q</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>    <span class="c1">// è®¾ç½®å¼€å¤´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">q</span><span class="p">.</span><span class="nx">tail</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">batch</span><span class="p">[</span><span class="nx">n</span><span class="p">])</span>    <span class="c1">// è®¾ç½®ç»“å°¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Now put the batch on global queue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>                   <span class="c1">// é”ä½å½“å‰sched
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">globrunqputbatch</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">q</span><span class="p">,</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>    <span class="c1">// æ‹¼æ¥åˆ°å…¨å±€sched.runqä¸Šå»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>                 <span class="c1">// è§£é”å½“å‰sched
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="globrunqputbatch">globrunqputbatch()<a hidden class="anchor" aria-hidden="true" href="#globrunqputbatch">#</a></h3>
<ol>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5587
</span><span class="lnt">5588
</span><span class="lnt">5589
</span><span class="lnt">5590
</span><span class="lnt">5591
</span><span class="lnt">5592
</span><span class="lnt">5593
</span><span class="lnt">5594
</span><span class="lnt">5595
</span><span class="lnt">5596
</span><span class="lnt">5597
</span><span class="lnt">5598
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Put a batch of runnable goroutines on the global runnable queue.
</span></span></span><span class="line"><span class="cl"><span class="c1">// This clears *batch.
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held.
</span></span></span><span class="line"><span class="cl"><span class="c1">// May run during STW, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">globrunqputbatch</span><span class="p">(</span><span class="nx">batch</span> <span class="o">*</span><span class="nx">gQueue</span><span class="p">,</span> <span class="nx">n</span> <span class="kt">int32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">sched</span><span class="p">.</span><span class="nx">runq</span><span class="p">.</span><span class="nf">pushBackAll</span><span class="p">(</span><span class="o">*</span><span class="nx">batch</span><span class="p">)</span>  <span class="c1">// æŠŠå½“å‰batché“¾æ¥åˆ°å…¨å±€sched.runqä¸Šå»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sched</span><span class="p">.</span><span class="nx">runqsize</span> <span class="o">+=</span> <span class="nx">n</span>             <span class="c1">// ç´¯åŠ å½“å‰sched.runqsizeæ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="nx">batch</span> <span class="p">=</span> <span class="nx">gQueue</span><span class="p">{}</span>               <span class="c1">// æ¸…ç©º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="acquirem">acquirem()<a hidden class="anchor" aria-hidden="true" href="#acquirem">#</a></h3>
<ol>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/runtime1.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">acquirem</span><span class="p">()</span> <span class="o">*</span><span class="nx">m</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">locks</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/goroutine-013.png" alt=""  />
</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://helium.github.io/tags/golang/">Golang</a></li>
      <li><a href="https://helium.github.io/tags/goroutine/">Goroutine</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://helium.github.io/posts/golang/goroutine/flow/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Go æ‰§è¡Œæµç¨‹</span>
  </a>
  <a class="next" href="https://helium.github.io/posts/golang/goroutine/user/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>user goroutine</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
    </span>
    <span id="busuanzi_container_site_uv">
        æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
    </span>
    </div>
        <span>Copyright Â© 2024 èœ€ICPå¤‡2024091074å· <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
