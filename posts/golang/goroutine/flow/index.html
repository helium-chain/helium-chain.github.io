<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Go æ‰§è¡Œæµç¨‹ | Helium</title>
<meta name="keywords" content="golang, Goroutine">
<meta name="description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬">
<meta name="author" content="helium">
<link rel="canonical" href="https://helium.github.io/posts/golang/goroutine/flow/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://helium.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://helium.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://helium.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://helium.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://helium.github.io/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://helium.github.io/posts/golang/goroutine/flow/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="Go æ‰§è¡Œæµç¨‹" />
<meta property="og:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://helium.github.io/posts/golang/goroutine/flow/" />
<meta property="og:image" content="https://helium.github.io/favicon-32x32.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-07-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-07-27T00:00:00+00:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://helium.github.io/favicon-32x32.png" />
<meta name="twitter:title" content="Go æ‰§è¡Œæµç¨‹"/>
<meta name="twitter:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://helium.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Golang",
      "item": "https://helium.github.io/posts/golang/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ç¬¬12ç«  Goroutine",
      "item": "https://helium.github.io/posts/golang/goroutine/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Go æ‰§è¡Œæµç¨‹",
      "item": "https://helium.github.io/posts/golang/goroutine/flow/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Go æ‰§è¡Œæµç¨‹",
  "name": "Go æ‰§è¡Œæµç¨‹",
  "description": "ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18+ç‰ˆæœ¬",
  "keywords": [
    "golang", "Goroutine"
  ],
  "articleBody": " ç¤ºä¾‹ä»£ç ã€‚ 1 2 3 4 5 6 7 package main import \"fmt\" func main() { fmt.Println(\"Hello World!\") } ç¨‹åºåŠ è½½é˜¶æ®µ ç¨‹åºåœ¨è¢«æ“ä½œç³»ç»ŸåŠ è½½èµ·æ¥è¿è¡Œæ—¶éƒ½ä¼šä¾æ¬¡ç»è¿‡å¦‚ä¸‹é˜¶æ®µï¼š ä»ç£ç›˜ä¸ŠæŠŠå¯æ‰§è¡Œç¨‹åºè¯»å…¥å†…å­˜ã€‚ åˆ›å»ºè¿›ç¨‹å’Œä¸»çº¿ç¨‹ã€‚ ä¸ºä¸»çº¿ç¨‹åˆ†é…æ ˆç©ºé—´ã€‚ æŠŠç”±ç”¨æˆ·åœ¨å‘½ä»¤è¡Œè¾“å…¥çš„å‚æ•°æ‹·è´åˆ°ä¸»çº¿ç¨‹çš„æ ˆã€‚ æŠŠä¸»çº¿ç¨‹æ”¾å…¥æ“ä½œç³»ç»Ÿçš„è¿è¡Œé˜Ÿåˆ—ç­‰å¾…è¢«è°ƒåº¦æ‰§è¡Œèµ·æ¥è¿è¡Œã€‚ åœ¨ä¸»çº¿ç¨‹ç¬¬ä¸€æ¬¡è¢«è°ƒåº¦èµ·æ¥æ‰§è¡Œç¬¬ä¸€æ¡æŒ‡ä»¤ä¹‹å‰ï¼Œä¸»çº¿ç¨‹çš„å‡½æ•°æ ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼šspæŒ‡å‘æ ˆé¡¶ã€‚ ç›¸å…³æ¦‚å¿µï¼š rspï¼šæŒ‡å‘å½“å‰æ ˆçš„æ ˆé¡¶ï¼Œè¡¨ç¤ºå½“å‰æ ˆå·²ç»ç”¨åˆ°ä»€ä¹ˆä½ç½®ã€‚ rbpï¼šæŒ‡å‘å½“å‰æ ˆçš„æ ˆåº•ï¼Œè¡¨ç¤ºå½“å‰æ ˆçš„èµ·ç‚¹ä½ç½®ã€‚ ripï¼šCPUå³å°†æ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œæ§åˆ¶ç€ç¨‹åºçš„æµç¨‹ã€‚ SBï¼šGOæ±‡ç¼–ç›¸å…³çš„è™šæ‹Ÿå¯„å­˜å™¨ï¼Œä¿å­˜ç¨‹åºåœ°å€ç©ºé—´çš„èµ·å§‹åœ°å€ã€‚ SBå¯„å­˜å™¨ä¿å­˜çš„æ˜¯å½“å‰å‡½æ•°åœ¨ä»£ç åŒºçš„èµ·å§‹ä½ç½®ã€‚ å‡ºç°åœ¨GOæ±‡ç¼–çš„å‡½æ•°å®šä¹‰ã€å‡½æ•°è°ƒç”¨ã€å…¨å±€å˜é‡å®šä¹‰ä»¥åŠå¯¹å…¶å¼•ç”¨ä¼šç”¨åˆ°è¿™ä¸ªSBè™šæ‹Ÿå¯„å­˜å™¨ã€‚ FPï¼šGOæ±‡ç¼–ç›¸å…³çš„è™šæ‹Ÿå¯„å­˜å™¨ï¼Œä¸»è¦ç”¨æ¥å¼•ç”¨å‡½æ•°å‚æ•°ã€‚ Goè¯­è¨€è§„å®šå‡½æ•°è°ƒç”¨æ—¶å‚æ•°éƒ½å¿…é¡»æ”¾åœ¨æ ˆä¸Šï¼Œæ¯”å¦‚è¢«è°ƒç”¨å‡½æ•°ä½¿ç”¨first_arg+0(FP)æ¥å¼•ç”¨è°ƒç”¨è€…ä¼ é€’è¿›æ¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚ ç”¨second_arg+8(FP)æ¥å¼•ç”¨ç¬¬äºŒä¸ªå‚æ•°ç­‰ã€‚è¿™é‡Œçš„first_argå’Œsecond_argä»…ä»…æ˜¯ä¸€ä¸ªå¸®åŠ©æˆ‘ä»¬é˜…è¯»æºä»£ç çš„ç¬¦å·ã€‚ å¯¹ç¼–è¯‘å™¨æ¥è¯´æ— å®é™…æ„ä¹‰ï¼Œ+0å’Œ+8è¡¨ç¤ºç›¸å¯¹äºFPå¯„å­˜å™¨çš„åç§»é‡ã€‚ $16-8ï¼šæ•°å­—16è¯´æ˜æ­¤å‡½æ•°çš„æ ˆå¸§å¤§å°ä¸º16å­—èŠ‚ï¼Œ8è¯´æ˜æ­¤å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ä¸€å…±éœ€è¦å ç”¨8å­—èŠ‚å†…å­˜ã€‚ ç¨‹åºå…¥å£ ç¬¬ä¸€è¡Œä»£ç ï¼šå®šä¹‰äº†_rt0_amd64_linuxè¿™ä¸ªç¬¦å·ï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„CPUæŒ‡ä»¤ã€‚ NOSPLITå‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦åœ¨è¿™ä¸ªå‡½æ•°ä¸­æ’å…¥æ£€æŸ¥æ ˆæ˜¯å¦æº¢å‡ºçš„ä»£ç ã€‚ ç¬¬äºŒè¡Œçš„JMPæŒ‡ä»¤ï¼šæ‰æ˜¯ä¸»çº¿ç¨‹çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ã€‚ è¿™æ¡æŒ‡ä»¤ç®€å•çš„è·³è½¬åˆ°ï¼ˆç›¸å½“äºgoè¯­è¨€æˆ–cä¸­çš„gotoå…³é”®å­—ï¼‰_rt0_amd64 è¿™ä¸ªç¬¦å·å¤„ç»§ç»­æ‰§è¡Œã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/rt0_linux_amd64.sã€‚ 7 8 TEXT _rt0_amd64_linux(SB),NOSPLIT,$-8 JMP _rt0_amd64(SB) å‰ä¸¤è¡ŒæŒ‡ä»¤ï¼šæŠŠæ“ä½œç³»ç»Ÿå†…æ ¸ä¼ é€’è¿‡æ¥çš„å‚æ•°argcå’Œargvæ•°ç»„çš„åœ°å€åˆ†åˆ«æ”¾åœ¨DIå’ŒSIå¯„å­˜å™¨ä¸­ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼šã€MOVQ 0(SP), DIã€‘æ‹·è´çš„æ˜¯argcçš„å€¼æ˜¯ä¸ª8å­—èŠ‚çš„å­˜å‚¨çš„æ˜¯å‚æ•°çš„ä¸ªæ•°ï¼Œæ˜¯ä¸ªæ•°å­—ã€‚ ã€LEAQ 8(SP), SIã€‘åˆ™æ˜¯å–çš„argvçš„åœ°å€ï¼Œæ˜¯ä¸ªæŒ‡é’ˆ*argvï¼Œä¹Ÿæ˜¯8å­—èŠ‚ã€‚ ç¬¬ä¸‰è¡ŒæŒ‡ä»¤ï¼šè·³è½¬åˆ° rt0_go å»æ‰§è¡Œã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ 11 12 13 14 15 16 17 18 19 # _rt0_amd64 is common startup code for most amd64 systems when using # internal linking. This is the entry point for the program from the # kernel for an ordinary -buildmode=exe program. The stack holds the # number of arguments and the C-style argv. TEXT _rt0_amd64(SB),NOSPLIT,$-8 MOVQ 0(SP), DI # DI = argc # å‡è®¾SPå­˜å‚¨å€¼ä¸º0x00ff00ï¼Œåˆ™SI=0x00ff08ï¼ŒæŒ‡å‘çš„æ˜¯ *argv LEAQ 8(SP), SI # SI = 8(SP); *argv JMP\truntimeÂ·rt0_go(SB) rt0_goå‡½æ•°å®Œæˆäº†goç¨‹åºå¯åŠ¨æ—¶çš„æ‰€æœ‰åˆå§‹åŒ–å·¥ä½œã€‚ ç¬¬4æ¡æŒ‡ä»¤ï¼ˆANDQ $~15, SPï¼‰ï¼š ç”¨äºè°ƒæ•´æ ˆé¡¶å¯„å­˜å™¨çš„å€¼ä½¿å…¶æŒ‰16å­—èŠ‚å¯¹é½ï¼Œä¹Ÿå°±æ˜¯è®©æ ˆé¡¶å¯„å­˜å™¨SPæŒ‡å‘çš„å†…å­˜çš„åœ°å€ä¸º16çš„å€æ•°ã€‚ ä¹‹æ‰€ä»¥è¦æŒ‰16å­—èŠ‚å¯¹é½ï¼Œæ˜¯å› ä¸ºCPUæœ‰ä¸€ç»„SSEæŒ‡ä»¤ï¼Œè¿™äº›æŒ‡ä»¤ä¸­å‡ºç°çš„å†…å­˜åœ°å€å¿…é¡»æ˜¯16çš„å€æ•°ã€‚ æœ€åä¸¤æ¡æŒ‡ä»¤ï¼šæŠŠargcå’Œargvæ¬åˆ°æ–°çš„ä½ç½®ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ 159 160 161 162 163 164 165 166 167 168 169 170 171 172 TEXT runtimeÂ·rt0_go(SB),NOSPLIT|TOPFRAME,$0 # copy arguments forward on an even stack # # åœ¨å¶æ•°æ ˆä¸Šå‘å‰å¤åˆ¶å‚æ•° # argcæ˜¯ä¸ª8å­—èŠ‚çš„æ•°å€¼ï¼Œå› æ­¤AXå­˜å‚¨çš„æ˜¯æ‹·è´çš„å€¼ # argvæ ¹æ®å‰é¢å¯çŸ¥ï¼Œè¿™é‡ŒBXå­˜å‚¨çš„æ˜¯argvçš„åœ°å€ï¼Œå› æ­¤åŸæ•°æ®è¿˜åœ¨8(SP)çš„ä½ç½® MOVQ DI, AX # AX=argc MOVQ SI, BX # BX=*argv SUBQ $(5*8), SP # 3args 2auto # $~15ï¼š0000_1111 -\u003e 1111_0000 # ç»è¿‡ ANDQ è°ƒæ•´åï¼Œä¸€å®šæ˜¯å¤§äºç­‰äº40byte ANDQ $~15, SP # è°ƒæ•´æ ˆé¡¶å¯„å­˜å™¨ä½¿å…¶æŒ‰16å­—èŠ‚å¯¹é½ MOVQ AX, 24(SP) # argcæ”¾åœ¨SP+24å­—èŠ‚å¤„ MOVQ BX, 32(SP) # argvæ”¾åœ¨SP+32å­—èŠ‚å¤„ï¼Œæ­¤æ—¶æ˜¯argvçš„åœ°å€ï¼Œ*argv æ€»ç»“ï¼šè¿™éƒ¨åˆ†ä»£ç å®Œæˆäº†argcå’Œargvçš„æ‹·è´ï¼ˆargvæ˜¯æ‹·è´äº†åœ°å€ï¼Œargvåˆ™æ˜¯æ‹·è´äº†å‰¯æœ¬å€¼ï¼‰ï¼Œæ ˆæŒ‰ç…§16å­—èŠ‚å¯¹é½äº†ã€‚ åˆå§‹åŒ–g0 g0çš„ä¸»è¦ä½œç”¨æ˜¯æä¾›ä¸€ä¸ªæ ˆä¾›runtimeä»£ç æ‰§è¡Œï¼Œå› æ­¤è¿™é‡Œä¸»è¦å¯¹g0çš„å‡ ä¸ªä¸æ ˆæœ‰å…³çš„æˆå‘˜è¿›è¡Œäº†åˆå§‹åŒ–ã€‚ ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºg0çš„æ ˆå¤§çº¦æœ‰64KBï¼Œåœ°å€èŒƒå›´ä¸ºSP - 64*1024 + 104 ï½ SPã€‚ æ³¨æ„ï¼šè™½ç„¶è¿™é‡Œç»™g0æŒ‡å®šäº†å¤§æ¦‚64KBå¤§å°çš„æ ˆç©ºé—´å¤§å°ï¼Œä½†æ˜¯SPå¯„å­˜å™¨çš„å€¼å´æ²¡æœ‰å‡å»64KBå¤§å°ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ 168 169 170 171 172 173 174 175 176 177 178 179 180 181 # create istack out of the given (operating system) stack. # _cgo_init may update stackguard. # ä»ç»™å®šçš„æ“ä½œç³»ç»Ÿæ ˆä¸­åˆ›å»º istack (è‡ªå·±çš„æ ˆ)ã€‚_cgo_init å¯èƒ½ä¼šæ›´æ–° stackguardã€‚ # ä¸‹é¢è¿™æ®µä»£ç ä»ç³»ç»Ÿçº¿ç¨‹çš„æ ˆç©ºåˆ†å‡ºä¸€éƒ¨åˆ†å½“åšg0çš„æ ˆï¼Œç„¶ååˆå§‹åŒ–g0çš„æ ˆä¿¡æ¯å’Œstackgard MOVQ $runtimeÂ·g0(SB), DI # DI = \u0026g0 LEAQ (-64*1024+104)(SP), BX # BX = SP - 64*1024 + 104 # g0.stackguard0å’Œg0.stackguard1ç”¨äºæ ˆæº¢å‡ºæ£€æŸ¥ï¼Œå®ç°æ ˆçš„è‡ªåŠ¨ä¼¸ç¼©ï¼ŒæŠ¢å è°ƒåº¦ä¹Ÿä¼šç”¨åˆ°stackguard0 MOVQ BX, g_stackguard0(DI) # g0.stackguard0 = SP - 64*1024 + 104 MOVQ BX, g_stackguard1(DI) # g0.stackguard1 = SP - 64*1024 + 104 # g0.stack ä¸»è¦ç”¨æ¥è®°å½•goroutineæ‰€ä½¿ç”¨çš„æ ˆï¼Œ[lo, hi) # g0.stack.lo æ ˆé¡¶ï¼ŒæŒ‡å‘å†…å­˜ä½åœ°å€ # g0.stack.hi æ ˆåº•ï¼ŒæŒ‡å‘å†…å­˜é«˜åœ°å€ MOVQ BX, (g_stack+stack_lo)(DI) # g0.stack.lo = SP - 64*1024 + 104 lo MOVQ SP, (g_stack+stack_hi)(DI) # g0.stack.hi = SP hi è¿è¡Œå®Œä¸Šé¢è¿™å‡ è¡ŒæŒ‡ä»¤åg0ä¸æ ˆä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ€»ç»“ï¼šè¿™éƒ¨åˆ†ä»£ç ç»™g0é¢„ç•™äº†å¤§çº¦64KBçš„å°çš„æ ˆç©ºé—´ï¼ˆæ³¨æ„è¿™é‡Œçš„SPå¯„å­˜å™¨å€¼å¹¶æ²¡æœ‰è¢«ä¿®æ”¹ï¼‰ï¼Œè®¾ç½®äº†stackã€stackguard0ã€stackguard1å­—æ®µï¼Œè¿™äº›å­—æ®µéƒ½æ˜¯ä¸g0æ ˆç›¸å…³çš„ã€‚ CPU ç›¸å…³ è°ƒç”¨CPUç›¸å…³æŒ‡ä»¤ï¼Œå°è¯•è·å–CPUç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚CPUçš„å‚å•†ã€å¤„ç†å™¨å‹å·ç­‰ï¼Œå¦‚æœè·å–æˆåŠŸåˆ™è®°å½•åœ¨å…¨å±€å˜é‡ä¸­ã€‚ åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨åˆå§‹åŒ–CGOç›¸å…³å‡½æ•°ï¼ˆç¨‹åºä¸­æœ‰ç›¸å…³Cä»£ç åˆ™ä¼šè°ƒç”¨ï¼Œæ²¡æœ‰åˆ™ä¸ä¼šè°ƒç”¨ï¼‰ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 # find out information about the processor we're on # # æ‰¾å‡ºæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨çš„å¤„ç†å™¨ä¿¡æ¯ # EAXå¯„å­˜å™¨è®¾ç½®ä¸ºç¼–å·0ï¼Œå› ä¸ºCPUIDæŒ‡ä»¤ä¼šä½¿ç”¨åˆ°è¯¥å¯„å­˜å™¨ã€‚ MOVL $0, AX # EAX = 0 # CPUID æ˜¯ä¸€ç§ç”¨äºæŸ¥è¯¢å¤„ç†å™¨ä¿¡æ¯çš„æŒ‡ä»¤ï¼Œå®ƒå¯ä»¥è¿”å›å¤„ç†å™¨æ”¯æŒçš„åŠŸèƒ½åˆ—è¡¨å’Œç‰¹æ€§ä¿¡æ¯ã€‚ # CPUID æŒ‡ä»¤éœ€è¦å°†æŸ¥è¯¢ä¿¡æ¯çš„ç¼–å·å­˜å‚¨åœ¨ EAX å¯„å­˜å™¨ä¸­ï¼Œç„¶åæ‰§è¡Œ CPUID æŒ‡ä»¤ã€‚ # å¤„ç†å™¨å°†è¿”å›ç»“æœå­˜å‚¨åœ¨ EAXã€EBXã€ECX å’Œ EDX å››ä¸ªå¯„å­˜å™¨ä¸­ï¼Œå…·ä½“çš„è¿”å›å€¼æ ¼å¼å’Œå«ä¹‰å–å†³äºæŸ¥è¯¢ä¿¡æ¯çš„ç¼–å·ã€‚ # EAX æ˜¯ 0 æ—¶ï¼šè¿”å›æœ€å¤§æ”¯æŒçš„åŠŸèƒ½ç¼–å·ï¼ˆåŒ…æ‹¬è¯¥ç¼–å·ï¼‰å’Œå‚å•† IDï¼ˆ12 ä¸ªå­—ç¬¦ï¼‰ã€‚ # 1. EAXï¼šè¿”å›æœ€å¤§æ”¯æŒçš„åŠŸèƒ½ç¼–å· # 2. EBXï¼šå¦‚æœæ˜¯ Inter è¿”å› \"Genu\"ã€‚å¦‚æœæ˜¯ AMD è¿”å› \"Auth\" ã€‚ # 3. ECXï¼šå¦‚æœæ˜¯ Inter è¿”å› \"ntel\"ã€‚å¦‚æœæ˜¯ AMD è¿”å› \"enti\" ã€‚ # 4. EDXï¼šå¦‚æœæ˜¯ Inter è¿”å› \"ntel\"ã€‚å¦‚æœæ˜¯ AMD è¿”å› \"cAMD\" ã€‚ # Genuntelntelæ˜¯è‹±ç‰¹å‚å•†åç§°ã€‚AuthenticAMDè¡¨ç¤ºæ˜¯AMDå‚å•†åç§°ã€‚ # EAX æ˜¯ 1 æ—¶ï¼šè¿”å›å¤„ç†å™¨çš„åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¤„ç†å™¨å‹å·ã€ç³»åˆ—ã€æ‰©å±•å‹å·ã€æ‰©å±•ç³»åˆ—ç­‰ã€‚ # 1. EAX çš„ä½0-3å°†åŒ…å«å¤„ç†å™¨ç±»å‹ç¼–ç ï¼Œä½4-7å°†åŒ…å«å¤„ç†å™¨å®¶æ—ç¼–ç ï¼Œä½8-11å°†åŒ…å«å¤„ç†å™¨å‹å·ç¼–ç ï¼Œ # ä½12-13å°†åŒ…å«å¤„ç†å™¨æ‰©å±•å‹å·ç¼–ç ï¼Œä½14-15å°†åŒ…å«å¤„ç†å™¨æ‰©å±•å®¶æ—ç¼–ç ã€‚ # 2. EBXã€ECXã€EDX ä¸‰ä¸ªå¯„å­˜å™¨å°†åŒ…å«å…¶ä»–å¤„ç†å™¨ç‰¹æ€§çš„ä¿¡æ¯ã€‚æ­¤å¤„æˆ‘ä»¬ä¸å…³å¿ƒè¿™äº›æ•°æ®ã€‚ # æŸ¥è¯¢ CPU æ”¯æŒçš„åŠŸèƒ½åˆ—è¡¨ï¼ˆç¼–å· 0ï¼‰ï¼š0ã€1ã€2ã€4ã€0x80000000ã€0x80000001 # 1. EAX çš„å€¼ä¸º 0x0ï¼šè¿”å›æœ€å¤§æ”¯æŒçš„åŠŸèƒ½ç¼–å·ï¼ˆåŒ…æ‹¬è¯¥ç¼–å·ï¼‰å’Œå‚å•† IDï¼ˆ12 ä¸ªå­—ç¬¦ï¼‰ã€‚ # 2. EAX çš„å€¼ä¸º 0x1ï¼šè¿”å›å¤„ç†å™¨çš„åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¤„ç†å™¨å‹å·ã€ç³»åˆ—ã€æ‰©å±•å‹å·ã€æ‰©å±•ç³»åˆ—ç­‰ã€‚ # 3. EAX çš„å€¼ä¸º 0x80000000hï¼šè¿”å›æœ€å¤§æ”¯æŒçš„æ‰©å±•åŠŸèƒ½ç¼–å·å’Œå‚å•† IDï¼ˆ12 ä¸ªå­—ç¬¦ï¼‰ã€‚ # 4. EAX çš„å€¼ä¸º 0x80000001hï¼šè¿”å›å¤„ç†å™¨çš„æ‰©å±•ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ‰©å±•ç‰¹æ€§ã€è™šæ‹ŸåŒ–æ”¯æŒç­‰ã€‚ CPUID CMPL AX, $0 JE nocpuinfo # AX == 0ï¼Œæ²¡æœ‰CPUä¿¡æ¯ # ä»¥ä¸‹åˆ¤æ–­å½“å‰å¤„ç†å™¨æ˜¯å¦æ˜¯ GenuineIntel # BX != \"Genu\"; JNE å°±ä¼šè·³è½¬ CMPL BX, $0x756E6547 # \"Genu\" JNE\tnotintel # ä¸æ˜¯è‹±ç‰¹å¤„ç†å™¨æ—¶ # BX != \"ineI\"; JNE å°±ä¼šè·³è½¬ CMPL DX, $0x49656E69 # \"ineI\" JNE\tnotintel # ä¸æ˜¯è‹±ç‰¹å¤„ç†å™¨æ—¶ # BX != \"ntel\"; JNE å°±ä¼šè·³è½¬ CMPL CX, $0x6C65746E # \"ntel\" JNE\tnotintel # ä¸æ˜¯è‹±ç‰¹å¤„ç†å™¨æ—¶ # å°†runtimeçš„å…¨å±€å˜é‡ isIntel è®¾ç½®ä¸º 1 # è¯¥å˜é‡åœ¨ runtime/runtime2.go å…¨å±€å˜é‡ä¸­ # è¡¨ç¤ºå½“å‰å¤„ç†å™¨æ˜¯ GenuineIntel MOVB $1, runtimeÂ·isIntel(SB) notintel: # ä¸æ˜¯intel # Load EAX=1 cpuid flags MOVL $1, AX CPUID # å°†runtimeçš„å…¨å±€å˜é‡ processorVersionInfo è®¾ç½®ä¸º AX # AXå¯„å­˜å™¨å­˜å‚¨çš„æ˜¯å¤„ç†å™¨çš„æ ‡è¯†ï¼Œå¯ä»¥è¯†åˆ«ç‰¹å®šçš„å¤„ç†å™¨ã€‚ # ç”±äºåˆ¤æ–­CPUæ˜¯å¦æ”¯æŒç›¸å…³çš„æŒ‡ä»¤é›†ï¼Œæ¯”å¦‚AVXæŒ‡ä»¤é›†ã€‚ MOVL AX, runtimeÂ·processorVersionInfo(SB) nocpuinfo: # æ²¡æœ‰cpuä¿¡æ¯ # if there is an _cgo_init, call it. # # å¦‚æœå­˜åœ¨_cgo_initï¼Œåˆ™è°ƒç”¨å®ƒã€‚ä»£ç ä¸­å­˜åœ¨è°ƒç”¨Cç›¸å…³å‡½æ•°æ—¶è¿™é‡ŒAXä¼šæœ‰å€¼å¹¶åˆ¤æ–­æˆåŠŸ # cgo_initå‡½æ•°æ˜¯ä¸€ä¸ªå†…éƒ¨å‡½æ•°ï¼Œç”¨äºåˆå§‹åŒ–Cè¯­è¨€ä»£ç å’ŒGoä»£ç ä¹‹é—´çš„æ¥å£ã€‚ # cgo_initå‡½æ•°æ˜¯Goè¿è¡Œæ—¶ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒåœ¨ç¨‹åºå¯åŠ¨æ—¶è¢«è‡ªåŠ¨è°ƒç”¨ã€‚ # å®ƒä¼šåˆå§‹åŒ–cgoç›¸å…³çš„å…¨å±€å˜é‡ï¼Œè®¾ç½®cgoçš„ä¿¡å·å¤„ç†å™¨ï¼Œå¹¶å°†Cè¯­è¨€ä»£ç ä¸­çš„å‡½æ•°æŒ‡é’ˆè½¬æ¢ä¸ºGoè¯­è¨€ä¸­çš„å‡½æ•°ç±»å‹ï¼Œ # ä»¥ä¾¿èƒ½å¤Ÿåœ¨Goè¯­è¨€ä¸­è°ƒç”¨å®ƒä»¬ã€‚ # ä½¿ç”¨ CGO çš„æƒ…å†µä¸‹ï¼š # 1. Goä¼šåˆ›å»ºä¸€ä¸ªCè¯­è¨€çš„çº¿ç¨‹ï¼Œå¹¶ä½¿ç”¨çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆThread-Local Storageï¼ŒTLSï¼‰æ¥å­˜å‚¨Cè¯­è¨€å‡½æ•°æ‰€éœ€è¦çš„æ•°æ®ã€‚ # 2. å½“ä½¿ç”¨cgoè°ƒç”¨Cè¯­è¨€å‡½æ•°æ—¶ï¼Œcgoä¼šè‡ªåŠ¨åˆå§‹åŒ–è¿™ä¸ªçº¿ç¨‹çš„TLSã€‚è¿™ä¸ªåˆå§‹åŒ–æ˜¯åœ¨_cgo_initå‡½æ•°ä¸­å®Œæˆçš„ï¼Œ # è¿™ä¸ªå‡½æ•°æ˜¯ç”±Goç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ã€‚ MOVQ _cgo_init(SB), AX # å°†å¯„å­˜å™¨ AX ä¸­çš„å€¼ä¸è‡ªå·±è¿›è¡ŒæŒ‰ä½é€»è¾‘ä¸è¿ç®—ï¼Œå¹¶æ›´æ–°æ ‡å¿—å¯„å­˜å™¨çš„å€¼ã€‚ # å¦‚æœå…¨éƒ¨ä¸º 1ï¼Œé‚£ä¹ˆç»“æœå°±æ˜¯éé›¶å€¼ï¼Œå¦åˆ™å°±æ˜¯é›¶ã€‚ # è¿™æ¡æŒ‡ä»¤çš„ä½œç”¨å°±æ˜¯åˆ¤æ–­ AX çš„å€¼æ˜¯å¦ä¸ºé›¶ã€‚ TESTQ AX, AX # è¿™æ¡æŒ‡ä»¤æ˜¯ä¸€ä¸ªæ¡ä»¶è·³è½¬æŒ‡ä»¤ï¼Œå®ƒä¼šæ ¹æ®ä¸Šä¸€æ¡æŒ‡ä»¤æ›´æ–°çš„æ ‡å¿—å¯„å­˜å™¨çš„å€¼æ¥åˆ¤æ–­æ˜¯å¦è·³è½¬åˆ°ç›®æ ‡æ ‡ç­¾ needtlsã€‚ # JZ æ˜¯â€œJump if Zeroâ€çš„ç¼©å†™ï¼Œæ„æ€æ˜¯å¦‚æœä¸Šä¸€æ¡æŒ‡ä»¤çš„ã€ç»“æœä¸ºé›¶ã€‘ï¼Œåˆ™è·³è½¬åˆ°ç›®æ ‡æ ‡ç­¾ã€‚ # è·³è½¬è¿™é‡Œè¡¨ç¤ºä¿®æ”¹å» TLS è®¾ç½® JZ\tneedtls # æ²¡æœ‰ _cgo_init å‡½æ•°æ—¶è·³è½¬åˆ° needtls # arg 1: g0, already in DI # å‚æ•°1ï¼šg0, å·²ç»åœ¨ DI ä¸­ï¼Œå‰é¢åˆå§‹åŒ–g0æ—¶æ”¾å…¥DIä¸­çš„ # å‚æ•°2ï¼šsetg_gcc æ”¾å…¥ SI MOVQ $setg_gcc\u003c\u003e(SB), SI # arg 2: setg_gcc #ifdef GOOS_android\tMOVQ $runtimeÂ·tls_g(SB), DX # arg 3: \u0026tls_g # arg 4: TLS base, stored in slot 0 (Android's TLS_SLOT_SELF). # Compensate for tls_g (+16). MOVQ -16(TLS), CX #else # å‚æ•°3,4ï¼šéƒ½ä¸º0ï¼Œä½¿ç”¨å¹³å°çš„TLSæ—¶ä¸ä½¿ç”¨ MOVQ $0, DX\t# arg 3, 4: not used when using platform's TLS MOVQ $0, CX #endif #ifdef GOOS_windows # Adjust for the Win64 calling convention. MOVQ CX, R9 # arg 4 MOVQ DX, R8 # arg 3 MOVQ SI, DX # arg 2 MOVQ DI, CX # arg 1 #endif # DIã€SIã€DXã€CXå‚æ•°å·²å‡†å¤‡å¥½ # DI = \u0026g0 # SI = setg_gcc # DX = 0 # CX = 0 # AX=_cgo_init; è°ƒç”¨ _cgo_init å‡½æ•° CALL AX # update stackguard after _cgo_init # åœ¨ _cgo_init åæ›´æ–° stackguardï¼Œå› ä¸ºæ›´æ–°äº†stack.loçš„å€¼äº†ã€‚ MOVQ $runtimeÂ·g0(SB), CX # CX = \u0026g0 MOVQ (g_stack+stack_lo)(CX), AX # AX = g0.stack.lo; lo = SP + 8MB - 4KB # _StackGuard æ˜¯ 928byte ADDQ $const__StackGuard, AX # AX = AX + _StackGuard # g0.stackguard0 = g0.stack.lo + _StackGuard # g0.stack.lo = SP + 8MB - 4KB # stackguard0 ç”¨äº runtime æ ˆæº¢å‡ºåˆ¤æ–­ã€‚ MOVQ AX, g_stackguard0(CX) # g0.stackguard1 = g0.stack.lo + _StackGuard # stackguard1 è¢« g0 å’Œ gsignal ä¸­çš„Cä»£ç ä½¿ç”¨ã€‚ç”¨äºæ ˆæº¢å‡ºåˆ¤æ–­ MOVQ AX, g_stackguard1(CX) ## è¿™é‡Œæ˜¯ ifndefï¼Œä¸æ˜¯windowsåˆ™JMP okä¸éœ€è¦å»TLS ## è¿™ç§æƒ…å†µå‘ç”Ÿåœ¨ _cgo_init å‡½æ•°è¢«è°ƒç”¨æ—¶å€™ # #ifndef GOOS_windows JMP ok #endif needtls: ## éœ€è¦TLSçš„æƒ…å†µåˆ¤æ–­ #ifdef GOOS_plan9 # skip TLS setup on Plan 9 JMP ok ## è·³è¿‡TLSè®¾ç½®ï¼Œä¸è¦æ‰‹åŠ¨è®¾ç½® #endif #ifdef GOOS_solaris # skip TLS setup on Solaris JMP ok ## è·³è¿‡TLSè®¾ç½®ï¼Œä¸è¦æ‰‹åŠ¨è®¾ç½® #endif #ifdef GOOS_illumos # skip TLS setup on illumos JMP ok ## è·³è¿‡TLSè®¾ç½®ï¼Œä¸è¦æ‰‹åŠ¨è®¾ç½® #endif #ifdef GOOS_darwin # skip TLS setup on Darwin JMP ok ## è·³è¿‡TLSè®¾ç½®ï¼Œä¸è¦æ‰‹åŠ¨è®¾ç½® #endif #ifdef GOOS_openbsd # skip TLS setup on OpenBSD JMP ok ## è·³è¿‡TLSè®¾ç½®ï¼Œä¸è¦æ‰‹åŠ¨è®¾ç½® #endif cgoåˆå§‹åŒ– åˆå§‹åŒ– C è¯­è¨€ä»£ç å’Œ Go ä»£ç ä¹‹é—´çš„æ¥å£ã€‚ å‚æ•°ï¼š G *gï¼š\u0026runtime.g0ã€‚ void (*setg)(void*)ï¼šsetg_gccå‡½æ•°ã€‚ void **tlsgï¼šNULLã€‚ void **tlsbaseï¼šNULLã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/cgo/gcc_linux_amd64.cã€‚ è¯¥å‡½æ•°åªæ˜¯è®¾ç½®äº†g0æ ˆçš„stack.lo = SP - 8MB + 4KBï¼Œå¹¶æ²¡æœ‰åˆ›å»ºæ–°çš„çº¿ç¨‹ã€‚ è¿™æ®µä»£ç æ‰§è¡Œäº†ä»¥ä¸‹é‡è¦ä»»åŠ¡ï¼š çº¿ç¨‹æ ˆçš„åˆå§‹åŒ–å’Œè®¾ç½®ï¼š Goè¿è¡Œæ—¶ä½¿ç”¨goroutinesæ¥å¹¶å‘æ‰§è¡Œä»£ç ï¼Œæ¯ä¸ªgoroutineæœ‰è‡ªå·±çš„æ ˆã€‚ å½“ä½¿ç”¨cgoæ—¶ï¼ŒGoè¿è¡Œæ—¶éœ€è¦ä¸Cä»£ç çš„çº¿ç¨‹æ ˆè¿›è¡Œäº¤äº’ã€‚ è¿™æ®µä»£ç ç¡®ä¿äº†Cçº¿ç¨‹çš„æ ˆä¸Goè¿è¡Œæ—¶çš„æ ˆè®¾ç½®æ˜¯ä¸€è‡´çš„ã€‚ æ ˆè¾¹ç•Œè®¾ç½®ï¼š è®¾ç½®stackloå­—æ®µæ˜¯ä¸ºäº†ç¡®å®šgoroutineæ ˆçš„åº•éƒ¨ä½ç½®ã€‚ åœ¨Goä¸­ï¼Œæ¯ä¸ªgoroutineçš„æ ˆéƒ½æœ‰ä¸€ä¸ªåº•éƒ¨å’Œé¡¶éƒ¨ï¼Œstackloå’Œstackhiåˆ†åˆ«ä»£è¡¨æ ˆçš„åº•éƒ¨å’Œé¡¶éƒ¨åœ°å€ã€‚ ä»¥ä¸‹æ˜¯ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾ç½®çš„åŸå› ï¼š å®‰å…¨è¾¹ç•Œï¼šé€šè¿‡å°†stackloè®¾ç½®ä¸ºè·ç¦»æ ˆé¡¶8MBå‡å»4KBçš„ä½ç½®ï¼Œä»£ç ä¸ºæ ˆæº¢å‡ºæ£€æµ‹ç•™å‡ºäº†ç©ºé—´ã€‚å¦‚æœgoroutineçš„æ ˆå¢é•¿è¶…è¿‡äº†è¿™ä¸ªè®¾ç½®çš„èŒƒå›´ï¼Œé‚£ä¹ˆå®ƒå°†è§¦å‘æ ˆæº¢å‡ºé”™è¯¯ï¼Œè€Œä¸æ˜¯è¦†ç›–å…¶ä»–å†…å­˜ï¼Œè¿™æœ‰åŠ©äºé˜²æ­¢å†…å­˜æŸåã€‚ æ ˆç©ºé—´é¢„ç•™ï¼šåœ¨Cå’ŒGoä»£ç ä¹‹é—´è¿›è¡Œåˆ‡æ¢æ—¶ï¼Œå¯èƒ½éœ€è¦é¢å¤–çš„æ ˆç©ºé—´æ¥å¤„ç†å‡½æ•°è°ƒç”¨ã€å‚æ•°ä¼ é€’ç­‰ã€‚é¢„ç•™ç©ºé—´å¯ä»¥ç¡®ä¿åœ¨è¿™äº›æ“ä½œä¸­æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œé¿å…æ ˆæº¢å‡ºã€‚ ä¸Goè¿è¡Œæ—¶æ ˆç®¡ç†å…¼å®¹ï¼šGoè¿è¡Œæ—¶è´Ÿè´£ç®¡ç†goroutinesçš„æ ˆï¼ŒåŒ…æ‹¬æ ˆçš„å¢é•¿å’Œæ”¶ç¼©ã€‚è¿™æ®µä»£ç ç¡®ä¿äº†Cçº¿ç¨‹çš„æ ˆä¸Goè¿è¡Œæ—¶çš„æ ˆç®¡ç†ç­–ç•¥å…¼å®¹ã€‚ åˆå§‹åŒ–setg_gccï¼šsetg_gccæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œç”¨äºåœ¨Cä»£ç ä¸­è®¾ç½®å½“å‰çš„goroutineã€‚åœ¨Cä»£ç ä¸­è°ƒç”¨Goå‡½æ•°æ—¶ï¼Œéœ€è¦æ­£ç¡®è®¾ç½®å½“å‰çš„goroutineï¼Œè¿™æ ·Goè¿è¡Œæ—¶æ‰èƒ½æ­£ç¡®ç®¡ç†goroutineçš„çŠ¶æ€ã€‚ æ€»çš„æ¥è¯´ï¼Œè¿™æ®µä»£ç æ˜¯cgoåˆå§‹åŒ–çš„ä¸€éƒ¨åˆ†ï¼Œç›®çš„æ˜¯ä¸ºäº†ç¡®ä¿Cçº¿ç¨‹çš„æ ˆä¸Goè¿è¡Œæ—¶çš„goroutineæ ˆèƒ½å¤Ÿæ­£ç¡®åœ°ååŒå·¥ä½œï¼ŒåŒæ—¶ä¿æŒæ ˆçš„å®‰å…¨æ€§å’Œæ€§èƒ½ã€‚ 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 static void (*setg_gcc)(void*); // This will be set in gcc_android.c for android-specific customization. void (*x_cgo_inittls)(void **tlsg, void **tlsbase) __attribute__((common)); void x_cgo_init(G *g, void (*setg)(void*), void **tlsg, void **tlsbase) { // ç”³æ˜ä¸€ä¸ª pthread_attr_t ç±»å‹å˜é‡ *attrï¼ŒæŒ‡é’ˆç±»å‹. // pthread_attr_t æ˜¯çº¿ç¨‹çš„å±æ€§ç»“æ„ pthread_attr_t *attr; // ç”³æ˜ä¸€ä¸ª size_t ç±»å‹å˜é‡ sizeã€‚ size_t size; // ç”¨äºä¿å­˜æ–°åˆ›å»ºçš„è¿™ä¸ªçº¿ç¨‹çš„æ ˆå¤§å° /* The memory sanitizer distributed with versions of clang before 3.8 has a bug: if you call mmap before malloc, mmap may return an address that is later overwritten by the msan library. Avoid this problem by forcing a call to malloc here, before we ever call malloc. This is only required for the memory sanitizer, so it's unfortunate that we always run it. It should be possible to remove this when we no longer care about versions of clang before 3.8. The test for this is misc/cgo/testsanitizers. GCC works hard to eliminate a seemingly unnecessary call to malloc, so we actually use the memory we allocate. */ setg_gcc = setg; // å‘setg_gccå…¨å±€é™æ€å˜é‡èµ‹å€¼setg_gcc()å‡½æ•°çš„åœ°å€ // å‘æ“ä½œç³»ç»Ÿç”³è¯· *attr ç±»å‹éœ€è¦çš„å†…å­˜ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆå¤§å°ã€‚ attr = (pthread_attr_t*)malloc(sizeof *attr); if (attr == NULL) { // ç”³è¯·å¤±è´¥ fatalf(\"malloc failed: %s\", strerror(errno)); } // åˆå§‹åŒ–çº¿ç¨‹å±æ€§å¯¹è±¡ï¼›åˆ›å»ºçš„é»˜è®¤æ ˆå¤§å°ä¸º8M pthread_attr_init(attr); // pthread_attr_getstacksize è·å–çº¿ç¨‹çš„æ ˆå¤§å° pthread_attr_getstacksize(attr, \u0026size); // __builtin_frame_address(0) æŸ¥çœ‹å½“å‰å‡½æ•°çš„æ ˆå¸§åœ°å€ï¼Œå› æ­¤å’ŒSPå¯„å­˜å™¨å€¼ç›¸å·®ä¸å¤§ // æ³¨æ„è¿™é‡Œä¿®æ”¹çš„æ˜¯ stack.lo = SP - 8MB + 4KBï¼ŒåŠ ä¸Š4KBæ˜¯ä¸ºäº†åˆ¤æ–­å½“å‰åˆ†é…çš„æ ˆæ˜¯å¦è¶…è¿‡4KB // å› ä¸ºgå‚æ•°ä¼ é€’çš„æ˜¯æŒ‡é’ˆï¼Œè¿™é‡Œç›´æ¥ä¿®æ”¹äº†g0çš„stack.loå­—æ®µçš„å€¼ï¼Œè¿™é‡Œç›¸å½“äºæ‰©å¤§äº†g0æ ˆå¤§å°ã€‚ g-\u003estacklo = (uintptr)__builtin_frame_address(0) - size + 4096; // lo \u003e= hiï¼Œé”™è¯¯çš„æ ˆè¾¹ç•Œã€‚hi-\u003eloï¼ˆé«˜-\u003eä½ï¼‰ï¼Œåˆ¤æ–­æ˜¯å¦æº¢å‡º if (g-\u003estacklo \u003e= g-\u003estackhi) fatalf(\"bad stack bounds: lo=%p hi=%p\\n\", g-\u003estacklo, g-\u003estackhi); // é”€æ¯ attr è¿™ä¸ªçº¿ç¨‹å±æ€§å¯¹è±¡ pthread_attr_destroy(attr); free(attr); // é‡Šæ”¾ attr å ç”¨çš„å†…å­˜ if (x_cgo_inittls) { x_cgo_inittls(tlsg, tlsbase); } } æ ¹æ®æ±‡ç¼–ä»£ç å¯çŸ¥ï¼Œsetg_gcc()å‡½æ•°åº”è¯¥æ˜¯æŠŠgæ”¾å…¥TLSå’ŒR14å¯„å­˜å™¨ä¸­ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ 1049 1050 1051 1052 1053 1054 # void setg_gcc(G*); set g called from gcc. TEXT setg_gcc\u003c\u003e(SB),NOSPLIT,$0 get_tls(AX) MOVQ DI, g(AX) MOVQ DI, R14 # set the g register RET ä¼ å…¥ç»™x_cgo_initçš„G *gå‚æ•°å…¶å®æ˜¯g0ï¼Œè€Œg0ç»“æ„ä½“ç¬¬ä¸€ä¸ªå­—æ®µå°±æ˜¯stackï¼ŒåŒ…å«stackloå’Œstackhiï¼Œå› æ­¤èƒ½ç›´æ¥è½¬æ¢ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/cgo/libcgo.hã€‚ 17 18 19 20 21 22 23 24 25 26 27 /* * The beginning of the per-goroutine structure, * as defined in ../pkg/runtime/runtime.h. * Just enough to edit these two fields. */ typedef struct G G; struct G { uintptr stacklo; uintptr stackhi; }; æ€»ç»“ï¼šè¿™éƒ¨åˆ†ä»£ç ï¼Œå°è¯•è·å–CPUç›¸å…³ä¿¡æ¯å¹¶ä¿å­˜åœ¨å…¨å±€å˜é‡ä¸­ã€‚åˆ¤æ–­æ˜¯å¦å­˜åœ¨CGOç›¸å…³åˆå§‹åŒ–ï¼Œå¦‚æœéœ€è¦åˆ™ä»æ–°è®¾ç½®g0çš„æ ˆå¤§å°ã€‚ è¿è¡Œå®Œä¸Šé¢è¿™cgoåˆå§‹åŒ–ä¸æ ˆä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ä¸»çº¿ç¨‹ä¸m0ç»‘å®š è®¾ç½®tls è®¾ç½®å¥½g0æ ˆä¹‹åï¼Œè·å–åˆ°CPUå‹å·ä»¥åŠcgoåˆå§‹åŒ–åï¼Œè®¾ç½®å·¥ä½œçº¿ç¨‹TLSã€‚ è°ƒç”¨settlså‡½æ•°åˆå§‹åŒ–ä¸»çº¿ç¨‹çš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨(TLS)ï¼Œç›®çš„æ˜¯æŠŠm0ä¸ä¸»çº¿ç¨‹å…³è”åœ¨ä¸€èµ·ã€‚ è®¾ç½®äº†çº¿ç¨‹æœ¬åœ°å­˜å‚¨ä¹‹åæ¥ä¸‹æ¥çš„å‡ æ¡æŒ‡ä»¤åœ¨äºéªŒè¯TLSåŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼Œå¦‚æœä¸æ­£å¸¸åˆ™ç›´æ¥aborté€€å‡ºç¨‹åºã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 # 1) è®¾ç½® TLS # ä¸‹é¢å¼€å§‹åˆå§‹åŒ–tlsï¼ˆthread local storageï¼Œçº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼‰ # LEAå°†å†…å­˜åœ°å€èµ‹å€¼ç»™DIï¼Œå–m0çš„tlsæˆå‘˜çš„åœ°å€åˆ°DIå¯„å­˜å™¨ LEAQ runtimeÂ·m0+m_tls(SB), DI # DI=\u0026m0.tls # è°ƒç”¨settlsè®¾ç½®çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œsettlså‡½æ•°çš„å‚æ•°åœ¨DIå¯„å­˜å™¨ä¸­ CALL runtimeÂ·settls(SB) # 2) éªŒè¯ TLS æ˜¯å¦å¯ç”¨ # store through it, to make sure it works # # é€šè¿‡å®ƒè¿›è¡Œå­˜å‚¨ï¼Œä»¥ç¡®ä¿å®ƒæœ‰æ•ˆ # éªŒè¯settlsæ˜¯å¦å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œå¦‚æœæœ‰é—®é¢˜åˆ™aborté€€å‡ºç¨‹åº get_tls(BX)\t# è·å–fsæ®µåŸºåœ°å€å¹¶æ”¾å…¥BXå¯„å­˜å™¨ï¼Œå…¶å®å°±æ˜¯m0.tls[1]çš„åœ°å€ï¼Œget_tlsçš„ä»£ç ç”±ç¼–è¯‘å™¨ç”Ÿæˆ # é€šè¿‡ FS å¯„å­˜å™¨å­˜å‚¨çš„å€¼è¿›è¡Œè®¾ç½® MOVQ $0x123, g(BX) # æŠŠæ•´å‹å¸¸é‡0x123æ‹·è´åˆ°fsæ®µåŸºåœ°å€åç§»-8çš„å†…å­˜ä½ç½®ï¼Œä¹Ÿå°±æ˜¯m0.tls[0]=0x123 # é€šè¿‡ runtime.mtls[0] è¿›è¡Œå–å€¼ MOVQ runtimeÂ·m0+m_tls(SB), AX # AX=m0.tls[0]ï¼ŒMOVå°†å€¼èµ‹å€¼ç»™AX # æ¯”è¾ƒ AX ä¸ $0x123 æ˜¯å¦ç›¸ç­‰ CMPQ AX, $0x123 # æ£€æŸ¥m0.tls[0]çš„å€¼æ˜¯å¦é€šè¿‡çº¿ç¨‹æœ¬åœ°å­˜å‚¨å­˜å…¥çš„0x123æ¥éªŒè¯tlsåŠŸèƒ½æ˜¯å¦æ­£å¸¸ # å¦‚æœå‰é¢çš„æ¯”è¾ƒç»“æœæ˜¯ç›¸ç­‰ï¼Œè·³è½¬åˆ°å½“å‰æŒ‡ä»¤åœ°å€åŠ 2ä¸ªå­—èŠ‚çš„ä½ç½®ï¼ˆå³ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼‰ # å¦‚æœæ¯”è¾ƒç»“æœä¸æ˜¯ç›¸ç­‰ï¼Œåˆ™ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚ JEQ 2(PC) # è·³è¿‡ä¸‹é¢è¿™ä¸€æ¡æŒ‡ä»¤ CALL runtimeÂ·abort(SB) # å¦‚æœçº¿ç¨‹æœ¬åœ°å­˜å‚¨ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œé€€å‡ºç¨‹åº runtimeÂ·settls(SB) å°†tls-baseè®¾ç½®ä¸ºDIå¯„å­˜å™¨çš„å€¼ï¼ŒDIå¯„å­˜å™¨å­˜å‚¨çš„æ˜¯m0.tlsçš„åœ°å€ã€‚ é€šè¿‡arch_prctlç³»ç»Ÿè°ƒç”¨æŠŠm0.tls[1]çš„åœ°å€è®¾ç½®æˆäº†fsæ®µçš„æ®µåŸºå€ã€‚ CPUä¸­æœ‰ä¸ªå«fsçš„æ®µå¯„å­˜å™¨ä¸ä¹‹å¯¹åº”ï¼š è€Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸€ç»„CPUå¯„å­˜å™¨å€¼ï¼Œæ“ä½œç³»ç»Ÿåœ¨æŠŠçº¿ç¨‹è°ƒç¦»CPUè¿è¡Œæ—¶ä¼šå¸®æˆ‘ä»¬æŠŠæ‰€æœ‰å¯„å­˜å™¨ä¸­çš„å€¼ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚ è°ƒåº¦çº¿ç¨‹èµ·æ¥è¿è¡Œæ—¶åˆä¼šä»å†…å­˜ä¸­æŠŠè¿™äº›å¯„å­˜å™¨çš„å€¼æ¢å¤åˆ°CPUã€‚åœ¨æ­¤ä¹‹åå·¥ä½œçº¿ç¨‹ä»£ç å°±å¯ä»¥é€šè¿‡fså¯„å­˜å™¨æ¥æ‰¾åˆ°m.tlsã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/sys_linux_amd64.sã€‚ 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 # set tls base to DI TEXT runtimeÂ·settls(SB),NOSPLIT,$32 #ifdef GOOS_android # Android stores the TLS offset in runtimeÂ·tls_g. SUBQ runtimeÂ·tls_g(SB), DI #else # DIå¯„å­˜å™¨ä¸­å­˜æ”¾çš„æ˜¯m.tls[0]çš„åœ°å€ï¼Œmçš„tlsæˆå‘˜æ˜¯ä¸€ä¸ªæ•°ç»„ # ä¸‹é¢è¿™ä¸€å¥ä»£ç æŠŠDIå¯„å­˜å™¨ä¸­çš„åœ°å€åŠ 8ï¼Œä¸ºä»€ä¹ˆè¦+8å‘¢ï¼Œä¸»è¦è·ŸELFå¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ä¸­çš„TLSå®ç°çš„æœºåˆ¶æœ‰å…³ # æ‰§è¡Œä¸‹é¢è¿™å¥æŒ‡ä»¤ä¹‹åDIå¯„å­˜å™¨ä¸­å­˜æ”¾çš„å°±æ˜¯m.tls[1]çš„åœ°å€äº† ADDQ $8, DI # ELF wants to use -8(FS) #endif # AMD64 Linuxå¹³å°çº¦å®šåœ¨è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ä½¿ç”¨ï¼š # 1. raxå¯„å­˜å™¨å­˜æ”¾ç³»ç»Ÿè°ƒç”¨ç¼–å· # 2. åŒæ—¶çº¦å®šä½¿ç”¨rdi, rsi, rdx, r10, r8å’Œr9æ¥ä¼ é€’å‰6ä¸ªç³»ç»Ÿè°ƒç”¨å‚æ•° # ä¸‹é¢é€šè¿‡arch_prctlç³»ç»Ÿè°ƒç”¨è®¾ç½®FSæ®µåŸºåœ°å€ # arch_prctlç³»ç»Ÿè°ƒç”¨çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œè®¾ç½®è¯¥å€¼ä¸ºFSæ®µåŸºåœ°å€ MOVQ DI, SI # SI = DI # arch_prctlçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼šARCH_SET_FS å‚æ•°å€¼è¡¨ç¤ºè®¾ç½®çº¿ç¨‹çš„TLSåœ°å€çš„ã€‚ # åœ¨ x86 æ¶æ„ä¸­ï¼ŒFS å¯„å­˜å™¨ç”¨äºå­˜å‚¨ TLS ï¼ˆThread Local Storageï¼‰çš„åœ°å€ MOVQ $0x1002, DI\t# ARCH_SET_FS # AX ç³»ç»Ÿè°ƒç”¨ç¼–å· MOVQ $SYS_arch_prctl, AX # AX = $SYS_arch_prctl # DI = ARCH_SET_FS # SI = \u0026m.tls[1] SYSCALL # ç³»ç»Ÿè°ƒç”¨ï¼Œè¿›å…¥å†…æ ¸ # åˆ¤æ–­ç³»ç»Ÿè°ƒç”¨æ˜¯å¦æˆåŠŸ # å°† AX å¯„å­˜å™¨ä¸­çš„å€¼ä¸ 0xfffffffffffff001 è¿›è¡Œæ¯”è¾ƒ # å¦‚æœ AX ä¸­çš„å€¼å°äºç­‰äº 0xfffffffffffff001ï¼Œåˆ™è·³è½¬åˆ°å½“å‰æŒ‡ä»¤åœ°å€åŠ ä¸Š2çš„åœ°å€ï¼ˆå³è·³è½¬åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼‰ã€‚ CMPQ AX, $0xfffffffffffff001 JLS\t2(PC) # è·³è¿‡ä»¥ä¸‹ä¸¤æ¡æŒ‡ä»¤ MOVL $0xf1, 0xf1 # crash ç³»ç»Ÿè°ƒç”¨å¤±è´¥ç›´æ¥crashï¼Œå¤±è´¥åŸå› æ˜¯æŠŠ$0xf1æ”¾å…¥ä¸å­˜åœ¨åœ°å€é‡Œé¢ RET # ç›´æ¥è¿”å› ç›¸å…³å®å®šä¹‰ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/go_tls.hã€‚ 9 10 11 12 #ifdef GOARCH_amd64 #define get_tls(r) MOVQ TLS, r // get_tlså‡½æ•°å®šä¹‰ï¼ŒTLSå…¶å®å°±æ˜¯FSå¯„å­˜å™¨çš„å€¼ #define g(r) 0(r)(TLS*1) // (r + TLS*1 + 0) #endif m0ç»‘å®š é¦–å…ˆæŠŠg0çš„åœ°å€æ”¾å…¥ä¸»çº¿ç¨‹çš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆTLSï¼‰ä¸­ï¼Œç„¶åé€šè¿‡ã€m0.g0=\u0026g0ã€‘ã€g0.m=\u0026m0ã€‘æŠŠm0å’Œg0ç»‘å®šåœ¨ä¸€èµ·ã€‚ ä¹‹ååœ¨ä¸»çº¿ç¨‹ä¸­é€šè¿‡get_tlså¯ä»¥è·å–åˆ°g0ï¼Œé€šè¿‡g0çš„mæˆå‘˜åˆå¯ä»¥æ‰¾åˆ°m0ã€‚ ä¿å­˜åœ¨ä¸»çº¿ç¨‹æœ¬åœ°å­˜å‚¨ä¸­çš„å€¼æ˜¯g0çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´å·¥ä½œçº¿ç¨‹çš„ç§æœ‰å…¨å±€å˜é‡å…¶å®æ˜¯ä¸€ä¸ªæŒ‡å‘gçš„æŒ‡é’ˆè€Œä¸æ˜¯æŒ‡å‘mçš„æŒ‡é’ˆã€‚ ç›®å‰è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘g0ï¼Œè¡¨ç¤ºä»£ç æ­£è¿è¡Œåœ¨g0æ ˆã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 ok: # 1) g0 ä¸ TLS ç»‘å®š # set the per-goroutine and per-mach \"registers\" get_tls(BX)\t# è·å–fsæ®µåŸºåœ°å€åˆ°BXå¯„å­˜å™¨ LEAQ runtimeÂ·g0(SB), CX # CX = \u0026g0; var g0 g; # æŠŠg0çš„åœ°å€ä¿å­˜åœ¨çº¿ç¨‹æœ¬åœ°å­˜å‚¨é‡Œé¢ MOVQ CX, g(BX) # m0.tls[0]=\u0026g0 LEAQ runtimeÂ·m0(SB), AX # AX = \u0026m0; var m0 m; # 2) m0 å’Œ g0 ç›¸äº’ç»‘å®š # m0.g0 = \u0026g0 # g0.m = \u0026m0 # save m-\u003eg0 = g0 MOVQ CX, m_g0(AX) # m0.g0=g0 # save m0 to g0-\u003em # mçš„ç¬¬ä¸€ä¸ªå­—æ®µå°±æ˜¯m0.g0æ‰€ä»¥è¿™é‡ŒAXä»£è¡¨çš„å°±æ˜¯m0.g0çš„åœ°å€å¤„ MOVQ AX, g_m(CX) # g0.m=m0\t# CLD æŒ‡ä»¤æ˜¯ Clear Direction Flag çš„ç¼©å†™ã€‚ç”¨äºå°†æ–¹å‘æ ‡å¿—ä½ DFï¼ˆDirection Flagï¼‰æ¸…é›¶ã€‚ # åœ¨x86æ¶æ„çš„è®¡ç®—æœºä¸­ï¼Œæ–¹å‘æ ‡å¿—ä½DFæ˜¯ä¸€ä¸ªæ ‡å¿—å¯„å­˜å™¨ä¸­çš„ä¸€ä½ï¼Œç”¨äºæŒ‡ç¤ºå­—ç¬¦ä¸²æ“ä½œæŒ‡ä»¤ï¼ˆå¦‚ MOVSBã€LODSBã€STOSB ç­‰ï¼‰ # åœ¨æ‰§è¡Œæ—¶æ˜¯æŒ‰ç…§é€’å¢æ–¹å‘è¿˜æ˜¯é€’å‡æ–¹å‘è¿›è¡Œæ“ä½œã€‚ # å½“ DF ä¸º 0 æ—¶ï¼Œå­—ç¬¦ä¸²æŒ‡é’ˆå°†æŒ‰ç…§é€’å¢æ–¹å‘ç§»åŠ¨ï¼›å½“ DF ä¸º 1 æ—¶ï¼Œå­—ç¬¦ä¸²æŒ‡é’ˆå°†æŒ‰ç…§é€’å‡æ–¹å‘ç§»åŠ¨ã€‚ # CLD æŒ‡ä»¤å°†æ–¹å‘æ ‡å¿—ä½ DF æ¸…é›¶ï¼Œè¡¨ç¤ºå­—ç¬¦ä¸²æ“ä½œæŒ‡ä»¤å°†æŒ‰ç…§é€’å¢æ–¹å‘è¿›è¡Œæ“ä½œã€‚ # å¦‚æœæˆ‘ä»¬ä½¿ç”¨MOVSBæŒ‡ä»¤å°†ä¸€ä¸ªé•¿åº¦ä¸º10å­—èŠ‚çš„å­—ç¬¦ä¸²ä»å­˜å‚¨å™¨ä¸­å¤åˆ¶åˆ°å¯„å­˜å™¨ä¸­ï¼Œå®ƒä¼šæŒ‰ç…§é€’å¢æ–¹å‘ä»å­˜å‚¨å™¨ä¸­çš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¼€å§‹è¯»å–æ•°æ®ï¼Œ # å¹¶å°†å®ƒä»¬å¤åˆ¶åˆ°å¯„å­˜å™¨ä¸­ã€‚ç„¶åï¼Œå®ƒä¼šé€’å¢å­˜å‚¨å™¨åœ°å€å’Œå¯„å­˜å™¨åœ°å€ï¼Œä»¥ä¾¿è¯»å–å’Œå¤åˆ¶ä¸‹ä¸€ä¸ªå­—èŠ‚ï¼Œç›´åˆ°æ•´ä¸ªå­—ç¬¦ä¸²è¢«å¤åˆ¶åˆ°å¯„å­˜å™¨ä¸­ä¸ºæ­¢ã€‚ # æ„æ€æ˜¯ï¼Œåœ¨ä½¿ç”¨å­—ç¬¦ä¸²æ“ä½œæŒ‡ä»¤æ—¶ï¼Œè¿™äº›æŒ‡ä»¤ä¼šæŒ‰ç…§é€’å¢æ–¹å‘æ“ä½œï¼Œå³æŒ‰ç…§å­˜å‚¨å™¨åœ°å€é€’å¢çš„é¡ºåºå¤åˆ¶æ•°æ®ã€‚ CLD # convention is D is always left cleared æ­¤æ—¶ï¼Œä¸»çº¿ç¨‹ï¼Œm0ï¼Œg0ä»¥åŠg0çš„æ ˆä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ€»ç»“ï¼šè¿™æ®µå‡½æ•°é€šè¿‡runtimeÂ·settls()å‡½æ•°æŠŠå½“å‰å·¥ä½œçº¿ç¨‹çš„FSå¯„å­˜å™¨åœ°å€è®¾ç½®ä¸º\u0026m0.tls[1]åœ°å€çš„å€¼ï¼Œç„¶åå†éªŒè¯æ˜¯å¦è®¾ç½®æˆåŠŸã€‚ç„¶åæŠŠg0åœ°å€æ”¾å…¥FSæ®µå¯„å­˜å™¨ä¸­ï¼Œä¹Ÿå°±æ˜¯\u0026m0.tls[0]å¤„ï¼Œè¡¨ç¤ºå½“å‰å·¥ä½œçº¿ç¨‹æ­£åœ¨æ‰§è¡Œg0ã€‚æ¥ç€è®¾ç½®m0.g0=g0å’Œg0.m=m0ï¼ŒæŠŠg0å’Œm0ç›¸å…³è”èµ·ã€‚ æ£€æŸ¥ ç¼–è¯‘å™¨ä¼šåœ¨å¾ˆå¤šå‡½æ•°éœ€è¦å‰å°è£…ä¸€å±‚æŠŠgå†™å…¥R14å¯„å­˜å™¨ä¸­ã€‚è¿™é‡Œç¼–è¯‘å™¨ä¼šæŠŠg0å†™å…¥R14å¯„å­˜å…¶ä¸­ã€‚ ä¸»è¦æ˜¯runtimeÂ·check()å‡½æ•°ï¼Œæ£€æŸ¥å†…ç½®ç±»å‹çš„ç›¸å…³ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 # Check GOAMD64 reqirements # We need to do this after setting up TLS, so that # we can report an error if there is a failure. See issue 49586. # # æ£€æŸ¥GOAMD64è¦æ±‚æˆ‘ä»¬éœ€è¦åœ¨è®¾ç½®TLSåæ‰§è¡Œæ­¤æ“ä½œï¼Œä»¥ä¾¿åœ¨å‡ºç°å¤±è´¥æ—¶æŠ¥å‘Šé”™è¯¯ã€‚ #ifdef NEED_FEATURES_CX\tMOVL $0, AX CPUID CMPL AX, $0 JE\tbad_cpu MOVL $1, AX CPUID ANDL $NEED_FEATURES_CX, CX CMPL CX, $NEED_FEATURES_CX JNE\tbad_cpu #endif #ifdef NEED_MAX_CPUID MOVL $0x80000000, AX CPUID CMPL AX, $NEED_MAX_CPUID JL bad_cpu #endif #ifdef NEED_EXT_FEATURES_BX MOVL $7, AX MOVL $0, CX CPUID ANDL $NEED_EXT_FEATURES_BX, BX CMPL BX, $NEED_EXT_FEATURES_BX JNE bad_cpu #endif #ifdef NEED_EXT_FEATURES_CX MOVL $0x80000001, AX CPUID ANDL $NEED_EXT_FEATURES_CX, CX CMPL CX, $NEED_EXT_FEATURES_CX JNE bad_cpu #endif #ifdef NEED_OS_SUPPORT_AX XORL CX, CX XGETBV ANDL $NEED_OS_SUPPORT_AX, AX CMPL AX, $NEED_OS_SUPPORT_AX JNE bad_cpu #endif #ifdef NEED_DARWIN_SUPPORT MOVQ $commpage64_version, BX CMPW (BX), $13 # cpu_capabilities64 undefined in versions \u003c 13 JL bad_cpu MOVQ $commpage64_cpu_capabilities64, BX MOVQ (BX), BX MOVQ $NEED_DARWIN_SUPPORT, CX ANDQ CX, BX CMPQ BX, CX JNE bad_cpu #endif # \"TEXT runtime.check(SB)\" æ˜¯ç”±ç¼–è¯‘å™¨å®ç°ï¼Œå› ä¸ºä»¥ä¸‹checkæ–¹æ³•ç”±runtimeçš„Goå®ç°éœ€è¦è·å–gã€‚ # ç¼–è¯‘å™¨å®ç° \"TEXT runtime.check(SB)\" æ˜¯éœ€è¦æŠŠg0å†™å…¥R14ä¸­ï¼Œç„¶åJMPè·³è½¬åˆ°check # è¯¥å‡½æ•°åœ¨ go1.19.3/src/runtime/runtime1.go:check() # ä¸»è¦æ˜¯æ£€æŸ¥goæ”¯æŒçš„å˜é‡å†…å­˜æƒ…å†µï¼ŒåŸå­CASå‡½æ•°ç­‰ CALL runtimeÂ·check(SB) runtimeÂ·check(SB) æ±‡ç¼–å¼€å¤´å‡ è¡Œã€‚ TEXT runtime.check(SB) \u003cautogenerated\u003e xorps xmm15, xmm15\t# æ¸…é™¤xmm15å¯„å­˜å™¨ï¼Œå¯èƒ½åé¢å‡½æ•°éœ€è¦ä½¿ç”¨ mov r14, qword ptr fs:[0xfffffff8] # R14 = g0 jmp $runtime.check # è·³è½¬ check() å‡½æ•° runtime.check()çš„æºç å®šä¹‰åœ¨/src/runtime/runtime1.goæ–‡ä»¶ä¸­ã€‚ 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 func check() { var ( a int8 b uint8 c int16 d uint16 e int32 f uint32 g int64 h uint64 i, i1 float32 j, j1 float64 k unsafe.Pointer l *uint16 m [4]byte ) type x1t struct { x uint8 } type y1t struct { x1 x1t y uint8 } var x1 x1t var y1 y1t // æ£€æŸ¥ int8 ç±»å‹å ç”¨å­—èŠ‚é•¿åº¦ if unsafe.Sizeof(a) != 1 { throw(\"bad a\") } // æ£€æŸ¥ uint8 ç±»å‹å ç”¨å­—èŠ‚é•¿åº¦ if unsafe.Sizeof(b) != 1 { throw(\"bad b\") } if unsafe.Sizeof(c) != 2 { throw(\"bad c\") } if unsafe.Sizeof(d) != 2 { throw(\"bad d\") } if unsafe.Sizeof(e) != 4 { throw(\"bad e\") } if unsafe.Sizeof(f) != 4 { throw(\"bad f\") } if unsafe.Sizeof(g) != 8 { throw(\"bad g\") } if unsafe.Sizeof(h) != 8 { throw(\"bad h\") } if unsafe.Sizeof(i) != 4 { throw(\"bad i\") } if unsafe.Sizeof(j) != 8 { throw(\"bad j\") } if unsafe.Sizeof(k) != goarch.PtrSize { throw(\"bad k\") } if unsafe.Sizeof(l) != goarch.PtrSize { throw(\"bad l\") } if unsafe.Sizeof(x1) != 1 { throw(\"bad unsafe.Sizeof x1\") } if unsafe.Offsetof(y1.y) != 1 { throw(\"bad offsetof y1.y\") } if unsafe.Sizeof(y1) != 2 { throw(\"bad unsafe.Sizeof y1\") } if timediv(12345*1000000000+54321, 1000000000, \u0026e) != 12345 || e != 54321 { throw(\"bad timediv\") } var z uint32 z = 1 // æ£€æŸ¥åŸå­æ“ä½œç›¸å…³ if !atomic.Cas(\u0026z, 1, 2) { throw(\"cas1\") } if z != 2 { throw(\"cas2\") } z = 4 if atomic.Cas(\u0026z, 5, 6) { throw(\"cas3\") } if z != 4 { throw(\"cas4\") } z = 0xffffffff if !atomic.Cas(\u0026z, 0xffffffff, 0xfffffffe) { throw(\"cas5\") } if z != 0xfffffffe { throw(\"cas6\") } m = [4]byte{1, 1, 1, 1} atomic.Or8(\u0026m[1], 0xf0) if m[0] != 1 || m[1] != 0xf1 || m[2] != 1 || m[3] != 1 { throw(\"atomicor8\") } m = [4]byte{0xff, 0xff, 0xff, 0xff} atomic.And8(\u0026m[1], 0x1) if m[0] != 0xff || m[1] != 0x1 || m[2] != 0xff || m[3] != 0xff { throw(\"atomicand8\") } *(*uint64)(unsafe.Pointer(\u0026j)) = ^uint64(0) if j == j { throw(\"float64nan\") } if !(j != j) { throw(\"float64nan1\") } *(*uint64)(unsafe.Pointer(\u0026j1)) = ^uint64(1) if j == j1 { throw(\"float64nan2\") } if !(j != j1) { throw(\"float64nan3\") } *(*uint32)(unsafe.Pointer(\u0026i)) = ^uint32(0) if i == i { throw(\"float32nan\") } if i == i { throw(\"float32nan1\") } *(*uint32)(unsafe.Pointer(\u0026i1)) = ^uint32(1) if i == i1 { throw(\"float32nan2\") } if i == i1 { throw(\"float32nan3\") } testAtomic64() if _FixedStack != round2(_FixedStack) { throw(\"FixedStack is not power-of-2\") } if !checkASM() { throw(\"assembly checks failed\") } } æ€»ç»“ï¼šè¿™æ®µä»£ç ä¸»è¦æ˜¯è°ƒç”¨äº†runtimeÂ·check()å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸»è¦æ˜¯æ£€æŸ¥ç¼–è¯‘å™¨æ˜¯å¦æŒ‰ç…§é¢„æœŸï¼Œæ£€æŸ¥äº†ç›¸å…³å†…å­˜å ç”¨å€¼å’ŒåŸå­æ“ä½œç­‰ã€‚ åˆå§‹åŒ–m0 å¤„ç†å‘½ä»¤è¡Œå‚æ•°ï¼Œè°ƒç”¨osinitå‡½æ•°è·å–CPUæ ¸çš„æ•°é‡å¹¶ä¿å­˜åœ¨å…¨å±€å˜é‡ncpuä¹‹ä¸­ï¼Œ è°ƒåº¦å™¨åˆå§‹åŒ–æ—¶éœ€è¦çŸ¥é“å½“å‰ç³»ç»Ÿæœ‰å¤šå°‘ä¸ªCPUæ ¸ã€‚ è°ƒç”¨runtime.args()å‡½æ•°æ¥æš‚å­˜å‘½ä»¤è¡Œå‚æ•°ä»¥å¾…åç»­è§£æã€‚éƒ¨åˆ†ç³»ç»Ÿä¼šåœ¨è¿™é‡Œè·å–ä¸ç¡¬ä»¶ç›¸å…³çš„ä¸€äº›å‚æ•°ï¼Œä¾‹å¦‚ç‰©ç†é¡µé¢å¤§å°ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ 338 339 340 341 342 343 344 345 346 347 348 349 350 # 1) å‡†å¤‡è°ƒç”¨argså‡½æ•°ï¼Œå‰é¢å››æ¡æŒ‡ä»¤æŠŠå‚æ•°æ”¾åœ¨æ ˆä¸Š MOVL\t24(SP), AX\t# copy argc AX=argc MOVL\tAX, 0(SP)\t# argcæ”¾åœ¨æ ˆé¡¶ï¼Œä¸ºè°ƒç”¨runtimeÂ·argsçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œvar argc int32 MOVQ\t32(SP), AX\t# copy argv AX=*argv MOVQ\tAX, 8(SP)\t# argvæ”¾åœ¨SP+8çš„ä½ç½®ï¼Œä¸ºè°ƒç”¨runtimeÂ·argsçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œvar argv **byte # ä¿å­˜ argcå’Œargv éå† auxv è®¾ç½® physPageSize å’Œ startupRandomData ä»¥åŠå¤„ç† VDSO # å¤„ç†æ“ä½œç³»ç»Ÿä¼ é€’è¿‡æ¥çš„å‚æ•°å’Œenvï¼Œå¤åˆ¶å…¨å±€å˜é‡argcå’Œargvå€¼ï¼Œå¹¶å¤„ç†ç³»ç»Ÿå‚æ•°èµ‹å€¼ç»™cpuç›¸å…³ CALL\truntimeÂ·args(SB) # è·å–CPUæ ¸æ•°ä¿å­˜åœ¨ncpuä¸­ï¼Œè·å–physHugePageSizeå‚æ•°ã€‚ # physHugePageSize æ˜¯åˆ†é…å¤§é¡µé¢æ—¶å€™è¢«ç”¨åˆ°ã€‚ CALL\truntimeÂ·osinit(SB)\t# æ‰§è¡Œçš„ç»“æœæ˜¯å…¨å±€å˜é‡ncpu = CPUæ ¸æ•° CALL\truntimeÂ·schedinit(SB)\t# è°ƒåº¦ç³»ç»Ÿåˆå§‹åŒ– args(SB) å…³äº argv çš„åˆ†å¸ƒå›¾ã€‚ argvï¼šæ˜¯ä¸€ä¸ªæŒ‡å‘å­—ç¬¦æŒ‡é’ˆçš„æŒ‡é’ˆæ•°ç»„ï¼Œå…¶ä¸­æ¯ä¸ªå­—ç¬¦æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªä»¥ null ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦ä¸²ä»£è¡¨äº†ç¨‹åºå¯åŠ¨æ—¶åœ¨å‘½ä»¤è¡Œä¸Šè¾“å…¥çš„å‚æ•°ã€‚æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´  argv[0] é€šå¸¸åŒ…å«äº†ç¨‹åºçš„åç§°æˆ–è·¯å¾„ï¼Œè€Œéšåçš„å…ƒç´  argv[1] åˆ° argv[argc-1] åŒ…å«äº†ç¨‹åºçš„å®é™…å‚æ•°ã€‚ envpï¼šæ˜¯ä¸€ä¸ªæŒ‡å‘ç¯å¢ƒå˜é‡çš„æŒ‡é’ˆæ•°ç»„ï¼Œè¿™äº›ç¯å¢ƒå˜é‡åœ¨ç¨‹åºå¯åŠ¨æ—¶ç”±æ“ä½œç³»ç»Ÿä¼ é€’ç»™ç¨‹åºã€‚æ¯ä¸ªæ•°ç»„å…ƒç´ éƒ½æ˜¯ä¸€ä¸ªä»¥ null ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºä¸€ä¸ªé”®å€¼å¯¹ï¼Œå…¶ä¸­é”®å’Œå€¼ä¹‹é—´é€šè¿‡ç­‰å·(=)è¿æ¥ã€‚ç¯å¢ƒå˜é‡æ˜¯æ“ä½œç³»ç»Ÿç”¨æ¥å­˜å‚¨æœ‰å…³å½“å‰ä¼šè¯æˆ–æ‰§è¡Œç¯å¢ƒçš„ä¿¡æ¯çš„ä¸€ç§æ–¹å¼ã€‚å®ƒä»¬é€šå¸¸ç”¨äºé…ç½®ç¨‹åºçš„è¡Œä¸ºï¼Œæä¾›è·¯å¾„ä¿¡æ¯ï¼Œæˆ–è€…å­˜å‚¨ç”¨æˆ·ç‰¹å®šçš„è®¾ç½®ã€‚ ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ç¯å¢ƒå˜é‡åŠå…¶ç”¨é€”ï¼š HOMEï¼šç”¨æˆ·çš„ä¸»ç›®å½•è·¯å¾„ã€‚ PATHï¼šæ‰§è¡Œå‘½ä»¤æ—¶è¦æœç´¢çš„ç›®å½•åˆ—è¡¨ã€‚ PWDï¼šå½“å‰å·¥ä½œç›®å½•çš„è·¯å¾„ã€‚ USERï¼šå½“å‰ç™»å½•çš„ç”¨æˆ·åã€‚ SHELLï¼šç”¨æˆ·ç™»å½•çš„ shell çš„è·¯å¾„ã€‚ LANGï¼šç³»ç»Ÿè¯­è¨€å’Œåœ°åŒºè®¾ç½®ã€‚ DISPLAYï¼šX Window System çš„æ˜¾ç¤ºå˜é‡ï¼Œç”¨äºå›¾å½¢ç•Œé¢ç¨‹åºã€‚ EDITORï¼šç”¨æˆ·çš„é¦–é€‰æ–‡æœ¬ç¼–è¾‘å™¨ã€‚ TERMï¼šç»ˆç«¯ç±»å‹ã€‚ auxvï¼šä¸ºç¨‹åºæä¾›äº†å…³äºå…¶æ‰§è¡Œç¯å¢ƒçš„é¢å¤–ä¿¡æ¯ã€‚ ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ auxv æ¡ç›®ç±»å‹åŠå…¶å«ä¹‰ï¼š AT_NULLï¼šæ ‡å¿—ç€ auxv æ•°ç»„çš„ç»“æŸã€‚ AT_EXECFDï¼šæ‰§è¡Œæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚ AT_PHDRï¼šç¨‹åºå¤´è¡¨çš„åœ°å€ã€‚ AT_PHENTï¼šç¨‹åºå¤´è¡¨ä¸­æ¯ä¸ªæ¡ç›®çš„å¤§å°ã€‚ AT_PHNUMï¼šç¨‹åºå¤´è¡¨ä¸­çš„æ¡ç›®æ•°é‡ã€‚ AT_PAGESZï¼šç³»ç»Ÿçš„é¡µé¢å¤§å°ã€‚ AT_BASEï¼šåŠ¨æ€é“¾æ¥å™¨çš„åŸºåœ°å€ã€‚ AT_ENTRYï¼šç¨‹åºçš„å…¥å£ç‚¹åœ°å€ã€‚ AT_UIDï¼šæ‰§è¡Œç¨‹åºçš„ç”¨æˆ·çš„çœŸå®ç”¨æˆ· IDã€‚ AT_EUIDï¼šæ‰§è¡Œç¨‹åºçš„æœ‰æ•ˆç”¨æˆ· IDã€‚ AT_GIDï¼šæ‰§è¡Œç¨‹åºçš„ç»„ IDã€‚ AT_EGIDï¼šæ‰§è¡Œç¨‹åºçš„æœ‰æ•ˆç»„ IDã€‚ AT_SECUREï¼šæŒ‡ç¤ºç¨‹åºæ˜¯å¦åœ¨ â€œsecure modeâ€ ä¸‹æ‰§è¡Œã€‚ AT_RANDOMï¼šæä¾›éšæœºå€¼çš„æŒ‡é’ˆï¼Œç”¨äºå®‰å…¨ç›®çš„ã€‚ æš‚å­˜å‘½ä»¤è¡Œå‚æ•°ä»¥å¾…åç»­è§£æã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/runtime1.goã€‚ 66 67 68 69 70 71 72 73 74 75 76 77 func args(c int32, v **byte) { // ä¿å­˜ argc å’Œ argv argc = c // runtimeçš„å…¨å±€å˜é‡ä¸­ argv = v // runtimeçš„å…¨å±€å˜é‡ä¸­ // åŠ è½½ auxv sysargs(c, v) } var ( argc int32 argv **byte ) sysargs() æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/os_linux.goã€‚ 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 func sysargs(argc int32, argv **byte) { // è·³è¿‡ argv + NULL n := argc + 1 // skip over argv, envp to get to auxv // è·³è¿‡ argv å’Œ envp ç›´æ¥åˆ° auxv for argv_index(argv, n) != nil { n++ } // skip NULL separator n++ // è·³è¿‡ NULL // now argv+n is auxv // argv+n åç°åœ¨æ˜¯ auxvã€‚ auxv := (*[1 \u003c\u003c 28]uintptr)(add(unsafe.Pointer(argv), uintptr(n)*goarch.PtrSize)) if sysauxv(auxv[:]) != 0 { return } // In some situations we don't get a loader-provided // auxv, such as when loaded as a library on Android. // Fall back to /proc/self/auxv. // // åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ä¼šå¾—åˆ°åŠ è½½å™¨æä¾›çš„auxvï¼Œæ¯”å¦‚åœ¨Androidä¸Šä½œä¸ºåº“åŠ è½½æ—¶ã€‚ // å›åˆ° /proc/self/auxvï¼Œå»åŠ è½½ä¿¡æ¯ã€‚ // var procAuxv []byte = []byte(\"/proc/self/auxv\\x00\") fd := open(\u0026procAuxv[0], 0 /* O_RDONLY */, 0) // æ‰“å¼€æŒ‡å®šæ–‡ä»¶å¥æŸ„ if fd \u003c 0 { // On Android, /proc/self/auxv might be unreadable (issue 9229), so we fallback to // try using mincore to detect the physical page size. // mincore should return EINVAL when address is not a multiple of system page size. const size = 256 \u003c\u003c 10 // size of memory region to allocate p, err := mmap(nil, size, _PROT_READ|_PROT_WRITE, _MAP_ANON|_MAP_PRIVATE, -1, 0) if err != 0 { return } var n uintptr for n = 4 \u003c\u003c 10; n \u003c size; n \u003c\u003c= 1 { err := mincore(unsafe.Pointer(uintptr(p)+n), 1, \u0026addrspace_vec[0]) if err == 0 { physPageSize = n break } } if physPageSize == 0 { physPageSize = size } munmap(p, size) return } var buf [128]uintptr // ä»å½“å‰æ–‡ä»¶ä¸­è¯»å–ä¿¡æ¯ n = read(fd, noescape(unsafe.Pointer(\u0026buf[0])), int32(unsafe.Sizeof(buf))) closefd(fd) // å…³é—­æ–‡ä»¶å¥æŸ„ if n \u003c 0 { return } // Make sure buf is terminated, even if we didn't read // the whole file. // ç¡®ä¿bufè¢«ç»ˆæ­¢ï¼Œå³ä½¿æˆ‘ä»¬æ²¡æœ‰è¯»å–æ•´ä¸ªæ–‡ä»¶ã€‚ buf[len(buf)-2] = _AT_NULL sysauxv(buf[:]) } argv_index() æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/runtime1.goã€‚ 59 60 61 62 63 64 // nosplit for use in linux startup sysargs // //go:nosplit func argv_index(argv **byte, i int32) *byte { return *(**byte)(add(unsafe.Pointer(argv), uintptr(i)*goarch.PtrSize)) } sysauxv() è®¾ç½® startupRandomData ç”¨äºHashï¼ŒphysPageSize ç‰©ç†å†…å­˜é¡µå¤§å°ï¼Œå¦‚æœè¿™äº›å­˜åœ¨çš„æƒ…å†µä¸‹ã€‚ è®¾ç½®å…¨å±€å˜é‡ç‰©ç†é¡µé¢å¤§å°ç­‰ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/os_linux.goã€‚ 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 func sysauxv(auxv []uintptr) int { var i int // éå†auxvç›´åˆ°ç»“æŸ _AT_NULLï¼Œä¸€æ¬¡æ€§å–ä¸¤ä¸ªåˆ†åˆ«æ˜¯ tag å’Œ val for ; auxv[i] != _AT_NULL; i += 2 { tag, val := auxv[i], auxv[i+1] switch tag { case _AT_RANDOM: // The kernel provides a pointer to 16-bytes // worth of random data. // // å†…æ ¸æä¾›äº†ä¸€ä¸ªæŒ‡å‘16å­—èŠ‚éšæœºæ•°æ®çš„æŒ‡é’ˆã€‚ // startupRandomDataä¿å­˜åœ¨å¯åŠ¨æ—¶åˆå§‹åŒ–çš„éšæœºå­—èŠ‚ã€‚è¿™äº›æ¥è‡ªELF AT_RANDOMè¾…åŠ©å‘é‡ã€‚ startupRandomData = (*[16]byte)(unsafe.Pointer(val))[:] case _AT_PAGESZ: physPageSize = val // å¦‚æœæ˜¯ç‰©ç†é¡µå¤§å°è®¾ç½®è¯¥å€¼ } archauxv(tag, val) // è¯¥å‡½æ•°åœ¨linuxä¸‹æ˜¯ç©º vdsoauxv(tag, val) // å¤„ç† vdso } return i / 2 } osinit(SB) runtime.osinit()å‡½æ•°ä¸­ï¼Œæ‰€æœ‰çš„ç³»ç»Ÿéƒ½ä¼šåœ¨è¿™é‡Œè·å–CPUæ ¸å¿ƒæ•°ï¼Œå¦‚æœä¸Šä¸€æ­¥runtime.args()æ²¡æœ‰æˆåŠŸè·å–ç‰©ç†é¡µé¢å¤§å°ï¼Œåˆ™éƒ¨åˆ†ç³»ç»Ÿä¼šå†æ¬¡è·å–ã€‚Linuxç³»ç»Ÿä¼šåœ¨è¿™é‡Œè·å–Hugeç‰©ç†é¡µé¢çš„å¤§å°ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/os_linux.goã€‚ 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 func osinit() { // è·å– CPU æ ¸æ•° ncpu = getproccount() // è·å–Linuxä¸­ç‰©ç†å†…å­˜å¤§é¡µé¢å¤§å°ã€‚ // å¤§é¡µé¢æ˜¯æŒ‡æ¯”æ™®é€šé¡µé¢ï¼ˆé€šå¸¸ä¸º 4KBï¼‰æ›´å¤§çš„é¡µé¢å¤§å°ï¼Œé€šå¸¸ä¸º 2MB æˆ– 1GBã€‚ // ä½¿ç”¨å¤§é¡µé¢å¯ä»¥æé«˜å†…å­˜è®¿é—®æ•ˆç‡å’Œç³»ç»Ÿæ€§èƒ½ï¼Œå› ä¸ºåœ¨ä½¿ç”¨å¤§é¡µé¢æ—¶ï¼Œå†…æ ¸éœ€è¦ç®¡ç†æ›´å°‘çš„é¡µè¡¨å’Œ TLB æ¡ç›®ã€‚ // è¯¥æ–¹æ³•é€šè¿‡openå»\"/sys/kernel/mm/transparent_hugepage/hpage_pmd_size\"è·¯å¾„è¯»å–çš„ physHugePageSize = getHugePageSize() if iscgo { // #42494 glibc and musl reserve some signals for // internal use and require they not be blocked by // the rest of a normal C runtime. When the go runtime // blocks...unblocks signals, temporarily, the blocked // interval of time is generally very short. As such, // these expectations of *libc code are mostly met by // the combined go+cgo system of threads. However, // when go causes a thread to exit, via a return from // mstart(), the combined runtime can deadlock if // these signals are blocked. Thus, don't block these // signals when exiting threads. // - glibc: SIGCANCEL (32), SIGSETXID (33) // - musl: SIGTIMER (32), SIGCANCEL (33), SIGSYNCCALL (34) sigdelset(\u0026sigsetAllExiting, 32) sigdelset(\u0026sigsetAllExiting, 33) sigdelset(\u0026sigsetAllExiting, 34) } osArchInit() // linuxä¸Šè¯¥å‡½æ•°ä¸ºç©º } è·å–cpuæ ¸æ•° è¿™æ®µä»£ç é€šè¿‡è°ƒç”¨æ“ä½œç³»ç»Ÿçš„sched_getaffinityç³»ç»Ÿè°ƒç”¨æ¥è·å–å½“å‰è¿›ç¨‹çš„CPUäº²å’ŒåŠ›æ©ç ï¼Œè¿™ä¸ªæ©ç æ˜¯ä¸€ä¸ªä½å›¾ï¼Œå…¶ä¸­æ¯ä¸ªæ¯”ç‰¹ä½å¯¹åº”ä¸€ä¸ªCPUæ ¸å¿ƒã€‚å¦‚æœæŸä¸ªæ¯”ç‰¹ä½ä¸º1ï¼Œåˆ™è¡¨ç¤ºå¯¹åº”çš„CPUæ ¸å¿ƒæ˜¯å¯ç”¨çš„ã€‚ä»£ç é€šè¿‡éå†è¿™ä¸ªä½å›¾å¹¶è®¡ç®—ä¸º1çš„æ¯”ç‰¹ä½çš„æ•°é‡æ¥å¾—åˆ°å¯ç”¨çš„CPUæ ¸å¿ƒæ•°ã€‚è¿™æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„æ–¹å¼æ¥è·å–ç³»ç»Ÿèµ„æºä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦æ ¹æ®æ ¸å¿ƒæ•°æ¥è°ƒæ•´ç¨‹åºå¹¶è¡Œåº¦çš„åœºæ™¯ä¸­ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/os_linux.goã€‚ 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 func getproccount() int32 { // This buffer is huge (8 kB) but we are on the system stack // and there should be plenty of space (64 kB). // Also this is a leaf, so we're not holding up the memory for long. // See golang.org/issue/11823. // The suggested behavior here is to keep trying with ever-larger // buffers, but we don't have a dynamic memory allocator at the // moment, so that's a bit tricky and seems like overkill. // // è¿™ä¸ªç¼“å†²åŒºå¾ˆå¤§(8 kB)ï¼Œä½†æˆ‘ä»¬åœ¨ç³»ç»Ÿå †æ ˆä¸Šï¼Œåº”è¯¥æœ‰è¶³å¤Ÿçš„ç©ºé—´(64 kB)ã€‚ // è€Œä¸”è¿™æ˜¯ä¸€ä¸ªå¶å­ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ä¼šå ç”¨å†…å­˜å¾ˆé•¿æ—¶é—´ã€‚ // è¿™é‡Œå»ºè®®çš„è¡Œä¸ºæ˜¯ç»§ç»­å°è¯•ä½¿ç”¨æ›´å¤§çš„ç¼“å†²åŒºï¼Œä½†æˆ‘ä»¬ç›®å‰æ²¡æœ‰åŠ¨æ€å†…å­˜åˆ†é…å™¨ï¼Œæ‰€ä»¥è¿™æœ‰ç‚¹æ£˜æ‰‹ï¼Œä¼¼ä¹æœ‰ç‚¹è¿‡åº¦ã€‚ // å®šä¹‰äº†ä¸€ä¸ªå¸¸é‡maxCPUsï¼Œå€¼ä¸º65536ã€‚ // è¿™ä¸ªå€¼å¹¶ä¸æ˜¯çœŸæ­£çš„CPUæ ¸å¿ƒæ•°ï¼Œè€Œæ˜¯ä¸€ä¸ªé¢„å®šä¹‰çš„æœ€å¤§å€¼ï¼Œç”¨äºç¡®å®šç¼“å†²åŒºå¤§å°ã€‚ const maxCPUs = 64 * 1024 // 65536 // å®šä¹‰äº†ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡bufï¼Œå¤§å°ä¸º8192å­—èŠ‚ï¼ˆå³8KBï¼‰ã€‚ // è¿™æ˜¯å› ä¸ºæ¯ä¸ªCPUæ ¸å¿ƒå¯ä»¥ç”¨ä¸€ä¸ªæ¯”ç‰¹ä½è¡¨ç¤ºï¼Œæ‰€ä»¥8192å­—èŠ‚å¯ä»¥è¡¨ç¤º65536ä¸ªæ¯”ç‰¹ä½ï¼Œå¯¹åº”maxCPUsä¸ªCPUæ ¸å¿ƒ var buf [maxCPUs / 8]byte // 8KB // è¿™è¡Œä»£ç æ˜¯æ ¸å¿ƒï¼Œå®ƒè°ƒç”¨äº†æ“ä½œç³»ç»Ÿæä¾›çš„sched_getaffinityç³»ç»Ÿè°ƒç”¨ã€‚ // è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ç”¨äºè·å–ç»™å®šè¿›ç¨‹IDï¼ˆè¿™é‡Œæ˜¯0ï¼Œè¡¨ç¤ºå½“å‰è¿›ç¨‹ï¼‰çš„CPUäº²å’ŒåŠ›æ©ç ã€‚ // 1. ç¬¬ä¸€ä¸ªå‚æ•°0è¡¨ç¤ºå½“å‰è¿›ç¨‹çš„è¿›ç¨‹IDã€‚ // 2. ç¬¬äºŒä¸ªå‚æ•°æ˜¯ç¼“å†²åŒºbufçš„å¤§å°ã€‚ // 3. ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ç¼“å†²åŒºçš„æŒ‡é’ˆã€‚ // ræ˜¯ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ï¼Œå®ƒè¡¨ç¤ºå®é™…å†™å…¥ç¼“å†²åŒºçš„å­—èŠ‚æ•°ã€‚ r := sched_getaffinity(0, unsafe.Sizeof(buf), \u0026buf[0]) // int32 // å¦‚æœç³»ç»Ÿè°ƒç”¨è¿”å›è´Ÿå€¼ï¼Œè¡¨ç¤ºå‘ç”Ÿäº†é”™è¯¯ã€‚ // åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‡½æ•°è¿”å›1ï¼Œè¿™å¯èƒ½æ„å‘³ç€è‡³å°‘æœ‰ä¸€ä¸ªCPUæ ¸å¿ƒæ˜¯å¯ç”¨çš„ã€‚ if r \u003c 0 { return 1 } n := int32(0) // éå†ç¼“å†²åŒºç›´åˆ°å®é™…å†™å…¥çš„å­—èŠ‚æ•°ã€‚ // è¿™æ®µä»£ç å®é™…ä¸Šæ˜¯åœ¨è®¡ç®—ç¼“å†²åŒºä¸­è®¾ç½®ä¸º1çš„æ¯”ç‰¹ä½çš„æ•°é‡ï¼Œæ¯ä¸ªä¸º1çš„æ¯”ç‰¹ä½ä»£è¡¨ä¸€ä¸ªå¯ç”¨çš„CPUæ ¸å¿ƒã€‚ for _, v := range buf[:r] { // å¯¹äºç¼“å†²åŒºçš„æ¯ä¸ªå­—èŠ‚ï¼Œå¦‚æœå®ƒä¸ä¸º0ï¼Œåˆ™è¿›è¡Œå¤„ç†ã€‚ for v != 0 { // é€šè¿‡æ£€æŸ¥æ¯ä¸ªæ¯”ç‰¹ä½æ˜¯å¦ä¸º1æ¥è®¡ç®—æ ¸å¿ƒæ•°ã€‚ // è¿™é‡Œä½¿ç”¨äº†ä½è¿ç®—\u0026æ¥æ£€æŸ¥æœ€ä½ä½æ˜¯å¦ä¸º1ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å¢åŠ æ ¸å¿ƒæ•°ã€‚ n += int32(v \u0026 1) // å°†å­—èŠ‚å³ç§»ä¸€ä½ï¼Œç»§ç»­æ£€æŸ¥ä¸‹ä¸€ä¸ªæ¯”ç‰¹ä½ã€‚ v \u003e\u003e= 1 } // n = 4 } // å¦‚æœè®¡ç®—å¾—å‡ºçš„æ ¸å¿ƒæ•°ä¸º0ï¼ˆè¿™å¯èƒ½æ˜¯ä¸€ä¸ªé”™è¯¯çš„æƒ…å†µï¼‰ï¼Œåˆ™é»˜è®¤è®¾ç½®ä¸º1ã€‚ if n == 0 { n = 1 } // å‡½æ•°è¿”å›è®¡ç®—å‡ºçš„CPUæ ¸å¿ƒæ•°ã€‚ return n } sched_getaffinity å‡½æ•°åŸå‹ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/os_linux.goã€‚ 448 449 //go:noescape func sched_getaffinity(pid, len uintptr, buf *byte) int32 æ±‡ç¼–æ–‡ä»¶åœ°å€ï¼šgo1.19.3/src/runtime/sys_linux_amd64.sã€‚ 660 661 662 663 664 665 666 667 668 669 670 TEXT runtimeÂ·sched_getaffinity(SB),NOSPLIT,$0 # ç¬¬ä¸€ä¸ªå‚æ•° pid ä¸º 0 MOVQ pid+0(FP), DI\t# ç¬¬äºŒä¸ªå‚æ•° len å ç”¨å†…å­˜å¤§å°å­—èŠ‚ MOVQ len+8(FP), SI # ç¬¬ä¸‰ä¸ªå‚æ•° buf *byte æŒ‡é’ˆ MOVQ buf+16(FP), DX MOVL $SYS_sched_getaffinity, AX # $SYS_sched_getaffinity = 204 SYSCALL MOVL AX, ret+24(FP) # ä¿å­˜è¿”å›å€¼ RET è·å–ç‰©ç†å†…å­˜é¡µå¤§å° è¿™æ®µä»£ç é€šè¿‡è¯»å–æ“ä½œç³»ç»Ÿæ–‡ä»¶/sys/kernel/mm/transparent_hugepage/hpage_pmd_sizeæ¥è·å–é€æ˜å¤§é¡µçš„å¤§å°ã€‚ è¿™ä¸ªæ–‡ä»¶é€šå¸¸åŒ…å«ä¸€ä¸ªæ•´æ•°ï¼Œè¡¨ç¤ºé€æ˜å¤§é¡µçš„å¤§å°ï¼ˆé€šå¸¸æ˜¯2çš„å¹‚ï¼‰ã€‚ä»£ç é€šè¿‡æ ‡å‡†çš„æ–‡ä»¶æ‰“å¼€ã€è¯»å–å’Œå…³é—­æ“ä½œæ¥è·å–è¿™ä¸ªå€¼ï¼Œå¹¶è¿›è¡Œäº†ä¸€äº›åŸºæœ¬çš„é”™è¯¯å¤„ç†å’ŒéªŒè¯ï¼Œä»¥ç¡®ä¿è¿”å›çš„æ˜¯ä¸€ä¸ªåˆç†çš„é¡µå¤§å°ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ã€æ— æ³•è¯»å–æˆ–å†…å®¹ä¸ç¬¦åˆé¢„æœŸï¼Œå‡½æ•°å°†è¿”å›0ã€‚è¿”å›å€¼uintptræ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•´æ•°ç±»å‹ï¼Œè¶³ä»¥å­˜å‚¨å†…å­˜é¡µå¤§å°ã€‚ 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 // å®šä¹‰äº†ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡sysTHPSizePathï¼Œå…¶ä¸­åŒ…å«äº†é€æ˜å¤§é¡µå¤§å°çš„é…ç½®æ–‡ä»¶è·¯å¾„ã€‚ // æœ«å°¾çš„\\x00æ˜¯ç©ºå­—ç¬¦ï¼Œç”¨äºå­—ç¬¦ä¸²çš„ç»ˆæ­¢ã€‚ var sysTHPSizePath = []byte(\"/sys/kernel/mm/transparent_hugepage/hpage_pmd_size\\x00\") func getHugePageSize() uintptr { var numbuf [20]byte // è°ƒç”¨openå‡½æ•°ä»¥åªè¯»æ¨¡å¼æ‰“å¼€ä¸Šè¿°è·¯å¾„æŒ‡å®šçš„æ–‡ä»¶ã€‚ // 0ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºåªè¯»æ¨¡å¼ï¼ˆO_RDONLYï¼‰ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æ¨¡å¼ï¼Œè¿™é‡Œä¼ 0è¡¨ç¤ºä¸éœ€è¦ç‰¹æ®Šçš„æ–‡ä»¶æƒé™ã€‚ fd := open(\u0026sysTHPSizePath[0], 0 /* O_RDONLY */, 0) // å¦‚æœopenå‡½æ•°è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦å°äº0ï¼Œè¡¨ç¤ºæ‰“å¼€æ–‡ä»¶å¤±è´¥ï¼Œå‡½æ•°è¿”å›0ã€‚ if fd \u003c 0 { return 0 } // ä½¿ç”¨noescapeå‡½æ•°æ¥é˜²æ­¢ptré€ƒé€¸åˆ°å †ä¸Šï¼Œunsafe.Pointerå°†numbufæ•°ç»„çš„åœ°å€è½¬æ¢ä¸ºæŒ‡é’ˆã€‚ ptr := noescape(unsafe.Pointer(\u0026numbuf[0])) // è°ƒç”¨readå‡½æ•°ä»æ–‡ä»¶æè¿°ç¬¦fdè¯»å–å†…å®¹åˆ°numbufæ•°ç»„ä¸­ï¼Œæœ€å¤šè¯»å–numbufçš„é•¿åº¦ä¸ªå­—èŠ‚ã€‚ n := read(fd, ptr, int32(len(numbuf))) // è¯»å–å®Œæˆåå…³é—­æ–‡ä»¶æè¿°ç¬¦ã€‚ closefd(fd) // å¦‚æœè¯»å–çš„å­—èŠ‚æ•°å°äºæˆ–ç­‰äº0ï¼Œè¡¨ç¤ºè¯»å–å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©ºï¼Œå‡½æ•°è¿”å›0ã€‚ if n \u003c= 0 { return 0 } // å‡å»1ï¼Œä»¥ç§»é™¤è¯»å–åˆ°çš„å­—ç¬¦ä¸²æœ«å°¾çš„æ¢è¡Œç¬¦ã€‚ n-- // remove trailing newline // å°†è¯»å–åˆ°çš„å­—èŠ‚è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œç„¶åä½¿ç”¨atoiå‡½æ•°å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•´æ•°ã€‚okè¡¨ç¤ºè½¬æ¢æ˜¯å¦æˆåŠŸã€‚ v, ok := atoi(slicebytetostringtmp((*byte)(ptr), int(n))) // å¦‚æœè½¬æ¢å¤±è´¥æˆ–å¾—åˆ°çš„å€¼å°äº0ï¼Œåˆ™å°†vè®¾ç½®ä¸º0ã€‚ if !ok || v \u003c 0 { v = 0 } // æ£€æŸ¥væ˜¯å¦ä¸º2çš„å¹‚ã€‚ // ä¸€ä¸ªæ•°æ˜¯2çš„å¹‚å½“ä¸”ä»…å½“å®ƒä¸å…¶è‡ªèº«å‡1çš„ä½ä¸ç»“æœä¸º0ã€‚å¦‚æœä¸æ˜¯2çš„å¹‚ï¼Œåˆ™è¿”å›0ã€‚ if v\u0026(v-1) != 0 { // v is not a power of 2 return 0 } // å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œå°†è¯»å–åˆ°çš„å€¼è½¬æ¢ä¸ºuintptrç±»å‹å¹¶è¿”å›ã€‚ return uintptr(v) } schedinit(SB) åˆå§‹åŒ–è°ƒåº¦ç³»ç»Ÿï¼ŒåŠ è½½è¿‡ç¨‹ï¼š call osinitï¼šè°ƒç”¨osinit()å‡½æ•°ï¼Œè®¾ç½®runtime.ncpuå’Œruntime.physHugePageSizeå‚æ•°çš„å€¼ã€‚ call schedinitï¼šè°ƒç”¨schedinit()å‡½æ•°ï¼Œåˆå§‹åŒ–è°ƒåº¦å™¨ã€‚ make \u0026 queue new Gï¼šåˆ›å»ºç¬¬ä¸€ä¸ªmain goroutineï¼Œå¹¶åŠ å…¥é˜Ÿåˆ—ã€‚ call runtimeÂ·mstartï¼šè°ƒç”¨runtimeÂ·mstart()å‡½æ•°å¼€å¯è°ƒåº¦å¾ªç¯ã€‚ è¿™ä¸ªæ–°çš„goroutineè¿è¡Œruntime.main()å‡½æ•°ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 791 792 793 794 795 796 797 // The bootstrap sequence is: // //\tcall osinit //\tcall schedinit //\tmake \u0026 queue new G //\tcall runtimeÂ·mstart // // The new G calls runtimeÂ·main. func schedinit() { // åˆå§‹åŒ–é”ï¼Œå¦‚æœæœ‰é”æ’åæƒ…å†µä¸‹ lockInit(\u0026sched.lock, lockRankSched) lockInit(\u0026sched.sysmonlock, lockRankSysmon) lockInit(\u0026sched.deferlock, lockRankDefer) lockInit(\u0026sched.sudoglock, lockRankSudog) lockInit(\u0026deadlock, lockRankDeadlock) lockInit(\u0026paniclk, lockRankPanic) lockInit(\u0026allglock, lockRankAllg) lockInit(\u0026allpLock, lockRankAllp) lockInit(\u0026reflectOffs.lock, lockRankReflectOffs) lockInit(\u0026finlock, lockRankFin) lockInit(\u0026trace.bufLock, lockRankTraceBuf) lockInit(\u0026trace.stringsLock, lockRankTraceStrings) lockInit(\u0026trace.lock, lockRankTrace) lockInit(\u0026cpuprof.lock, lockRankCpuprof) lockInit(\u0026trace.stackTab.lock, lockRankTraceStackTab) // Enforce that this lock is always a leaf lock. // All of this lock's critical sections should be // extremely short. // å¼ºåˆ¶è¿™ä¸ªé”å§‹ç»ˆæ˜¯ä¸€ä¸ªå¶é”ã€‚æ‰€æœ‰é”çš„å…³é”®éƒ¨åˆ†éƒ½åº”è¯¥éå¸¸çŸ­ã€‚ lockInit(\u0026memstats.heapStats.noPLock, lockRankLeafRank) // raceinit must be the first call to race detector. // In particular, it must be done before mallocinit below calls racemapshadow. // // getg()å‡½æ•°åœ¨æºä»£ç ä¸­æ²¡æœ‰å¯¹åº”çš„å®šä¹‰ï¼Œç”±ç¼–è¯‘å™¨æ’å…¥ç±»ä¼¼ä¸‹é¢ä¸¤è¡Œä»£ç  // 1. get_tls(CX) =\u003e MOVQ TLS, CX // 2. MOVQ g(CX), BX; // èµ·å§‹å°±æ˜¯ä»TLSä¸­å–å‡ºgoroutineï¼Œæ­¤æ—¶åº”è¯¥æ˜¯*g0ã€‚ä¹Ÿå°±æ˜¯\u0026m0.tls[0]é‡Œé¢å­˜å‚¨çš„å€¼*g0ã€‚ // å‰é¢ä»£ç å¯çŸ¥ï¼Œg0çš„åœ°å€è¢«æ”¾å…¥äº†TLSä¸­ï¼Œå› æ­¤è¿™é‡Œä»TLSè·å–g0çš„åœ°å€ _g_ := getg() // _g_ = \u0026g0 if raceenabled { _g_.racectx, raceprocctx0 = raceinit() } // è®¾ç½®æœ€å¤šå¯åŠ¨10000ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯æœ€å¤š10000ä¸ªM sched.maxmcount = 10000 // The world starts stopped. // // åœ¨æ²¡æœ‰é”æ’åä¸‹ï¼Œè¯¥å‡½æ•°ä¸ºç©ºã€‚å› ä¸ºæ­¤æ—¶å°±åªæœ‰m0ä¸€ä¸ªçº¿ç¨‹ã€‚ // åœ¨æœ‰é”æ’åä¸‹ï¼Œè¯¥å‡½æ•°æŠŠworldIsStoppedå…¨å±€å˜é‡è®¾ç½®ä¸º1ï¼Œå°±è¿”å›äº†ã€‚ worldStopped() // STW // æ ¡éªŒç¨‹åºçš„å„ä¸ªæ¨¡å—ï¼Œå› ä¸ºgolangæ”¯æŒsharedã€pluginç­‰buildæ¨¡å¼ï¼Œå¯èƒ½ä¼šæœ‰å¾ˆå¤šä¸ªäºŒè¿›åˆ¶æ¨¡å— // è¿™é‡Œä¼šæ ¡éªŒå„ä¸ªæ¨¡å—çš„ç¬¦å·ã€ABIç­‰ï¼Œç¡®ä¿æ¨¡å—é—´ä¸€è‡´ã€‚ moduledataverify() // æ ˆå†…å­˜åˆå§‹åŒ–ï¼Œstackpool å’Œ stackLarge åˆå§‹åŒ– // goroutineçš„æ ˆæ˜¯åŠ¨æ€åˆ†é…ã€åŠ¨æ€å¢é•¿çš„ï¼Œè¿™ä¸€æ­¥ä¼šåˆå§‹åŒ–ç”¨äºæ ˆåˆ†é…çš„å…¨å±€ç¼“å­˜æ± ï¼Œä»¥åŠç›¸å…³çš„é”ã€‚ stackinit() // æ ˆå†…å­˜åˆå§‹åŒ– // å †å†…å­˜åˆå§‹åŒ–ï¼ŒåŒ…æ‹¬åˆå§‹åŒ–mheapã€mcache0ä»¥åŠè®¾ç½®å †çš„arenaHint mallocinit()\t// è¿›è¡Œä¸CPUç›¸å…³çš„åˆå§‹åŒ–å·¥ä½œï¼Œæ£€æµ‹CPUæ˜¯å¦æ”¯æŒæŸäº›æŒ‡ä»¤é›†ï¼Œä»¥åŠæ ¹æ®GODEBUGç¯å¢ƒå˜é‡æ¥å¯ç”¨æˆ–ç¦ç”¨æŸäº›ç¡¬ä»¶ç‰¹æ€§ cpuinit() // must run before alginit // æ ¹æ®CPUå¯¹AESç›¸å…³æŒ‡ä»¤çš„æ”¯æŒæƒ…å†µï¼Œé€‰æ‹©ä¸åŒå¾—Hashç®—æ³•ï¼Œæ‰€ä»¥å¿…é¡»åœ¨ cpuinit() åé¢è°ƒç”¨ // mapã€hashå¿…é¡»åœ¨ alginit() å‡½æ•°è°ƒç”¨åæ‰å¯ä»¥ä½¿ç”¨ alginit() // maps, hash, fastrand must not be used before this call // åˆå§‹åŒ– fastrandseedï¼Œåœ¨æ¥ä¸‹æ¥çš„mcommoninit()å‡½æ•°ä¸­è¢«ç”¨åˆ° fastrandinit() // must run before mcommoninit // åˆå§‹åŒ–m0ï¼Œå› ä¸ºä»å‰çš„ä»£ç æˆ‘ä»¬çŸ¥é“ g0-\u003em=\u0026m0 // ä¸ºå½“å‰å·¥ä½œçº¿ç¨‹Måˆ†é…IDã€åˆå§‹åŒ–gsignalï¼Œå¹¶æŠŠMæ·»åŠ åˆ°allmå…¨å±€é“¾è¡¨ä¸­ // è¯¥å‡½æ•°åœ¨æ–°åˆ›å»ºå·¥ä½œçº¿ç¨‹æ—¶ä¹Ÿä¼šè°ƒç”¨ã€‚ mcommoninit(_g_.m, -1) // m0 // åŸºäºæ‰€æœ‰çš„å·²åŠ è½½æ¨¡å—ï¼Œæ„é€ ä¸€ä¸ªæ´»è·ƒæ¨¡å—åˆ‡ç‰‡ modulesSliceï¼Œå¹¶åˆå§‹åŒ–GCéœ€è¦çš„Maskæ•°æ® modulesinit() // provides activeModules // Typelinksinitæ‰«ææ¥è‡ªé¢å¤–æ¨¡å—çš„ç±»å‹ï¼Œå¹¶æ„å»ºmoduledataç±»å‹æ˜ å°„ï¼Œç”¨äºæ¶ˆé™¤é‡å¤ç±»å‹æŒ‡é’ˆã€‚ // åŸºäºæ´»è·ƒæ¨¡å—åˆ—è¡¨æ„å»ºæ¨¡å—çº§çš„typemapï¼Œå®ç°å…¨å±€èŒƒå›´å†…å¯¹ç±»å‹å…ƒæ•°æ®å»é‡ã€‚ typelinksinit() // uses maps, activeModules // éå†æ´»è·ƒæ¨¡å—åˆ—è¡¨ï¼Œå°†ç¼–è¯‘å™¨é˜¶æ®µç”Ÿæˆçš„æ‰€æœ‰itabæ·»åŠ åˆ°itabTableä¸­ // è¯¥å‡½æ•°ä¼šè°ƒç”¨itabAdd()å‡½æ•°ï¼Œæ¥å£çš„æ—¶å€™çŸ¥é“è¯¥å‡½æ•°ä¼šç”Ÿæˆ*itab itabsinit() // uses activeModules stkobjinit() // must run before GC starts sigsave(\u0026_g_.m.sigmask) initSigmask = _g_.m.sigmask // è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œç¨‹åºä¸­é€šè¿‡os.Argså¾—åˆ°çš„å‚æ•°æ˜¯åœ¨è¿™é‡Œåˆå§‹åŒ–çš„ï¼ˆWindowsé™¤å¤–ï¼‰ // å­˜å…¥ argslice []string å˜é‡ä¸­ goargs() // è§£æç¯å¢ƒå˜é‡ï¼Œç¨‹åºä¸­é€šè¿‡os.Getenvè·å–çš„ç¯å¢ƒå˜é‡æ˜¯åœ¨è¿™é‡Œåˆå§‹åŒ–çš„ï¼ˆWindowsé™¤å¤–ï¼‰ // å­˜å…¥ envs []string å˜é‡ä¸­ goenvs() // è§£æç¯å¢ƒå˜é‡GODEBUGï¼Œä¸ºruntimeå„ä¸ªè°ƒè¯•å‚æ•°èµ‹å€¼ parsedebugvars() // åˆå§‹åŒ–ä¸GCç›¸å…³çš„å‚æ•°ï¼Œæ ¹æ®ç¯å¢ƒå˜é‡GOGCè®¾ç½®gcpercent gcinit() lock(\u0026sched.lock) // è·å– mutex è§£é” // ä¸Šæ¬¡ç½‘ç»œè½®è¯¢çš„æ—¶é—´ç‚¹ï¼Œè®¾ç½®ä¸ºå½“å‰æ—¶é—´ç‚¹ sched.lastpoll = uint64(nanotime()) // ç³»ç»Ÿä¸­æœ‰å¤šå°‘æ ¸ï¼Œå°±åˆ›å»ºå’Œåˆå§‹åŒ–å¤šå°‘ä¸ªPç»“æ„ä½“å¯¹è±¡ procs := ncpu\t// ncpuè¯¥å€¼åœ¨runtime.osinitå‡½æ•°ä¸­è¢«è®¾ç½® // å¦‚æœç¯å¢ƒå˜é‡æŒ‡å®šäº†GOMAXPROCSï¼Œåˆ™åˆ›å»ºæŒ‡å®šæ•°é‡çš„p if n, ok := atoi32(gogetenv(\"GOMAXPROCS\")); ok \u0026\u0026 n \u003e 0 { procs = n\t} // procresize åˆ›å»ºå’Œåˆå§‹åŒ–å…¨å±€å˜é‡allp // æ ¹æ® CPU çš„æ ¸æ•°æˆ–ç¯å¢ƒå˜é‡GOMAXPROCç¡®å®šPçš„æ•°é‡ï¼Œè°ƒç”¨procresizeè¿›è¡Œè°ƒæ•´ // procresize è¿”å›nilè¡¨ç¤ºæ‰€æœ‰çš„Pä¸­æœ¬åœ°é˜Ÿåˆ—éƒ½æ²¡æœ‰å¯è¿è¡Œçš„goroutineã€‚ if procresize(procs) != nil { throw(\"unknown runnable goroutine during bootstrap\") } unlock(\u0026sched.lock) // mutex è§£é” // World is effectively started now, as P's can run. worldStarted() // Start World // For cgocheck \u003e 1, we turn on the write barrier at all times // and check all pointer writes. We can't do this until after // procresize because the write barrier needs a P. // // å¯¹äºcgocheck \u003e 1ï¼Œæˆ‘ä»¬åœ¨ä»»ä½•æ—¶å€™éƒ½æ‰“å¼€å†™å±éšœå¹¶æ£€æŸ¥æ‰€æœ‰çš„æŒ‡é’ˆå†™ã€‚ // æˆ‘ä»¬ä¸èƒ½è¿™æ ·åšï¼Œç›´åˆ°procresizeä¹‹åï¼Œå› ä¸ºå†™å±éšœéœ€è¦ä¸€ä¸ªPã€‚ if debug.cgocheck \u003e 1 { // debug.cgocheckåœ¨parsedebugvars()å‡½æ•°ä¸­è¢«è®¾ç½®ä¸º1 // å¼€å¯å†™å±éšœ writeBarrier.cgo = true writeBarrier.enabled = true // åˆå§‹åŒ–æ‰€æœ‰Pä¸Šçš„å†™å±éšœç¼“å­˜åŒº for _, p := range allp { p.wbBuf.reset() } } // æœªçŸ¥ç¼–è¯‘ç‰ˆæœ¬æ—¶ if buildVersion == \"\" { // Condition should never trigger. This code just serves // to ensure runtimeÂ·buildVersion is kept in the resulting binary. // // æ¡ä»¶åº”è¯¥æ°¸è¿œä¸ä¼šè§¦å‘ã€‚è¿™æ®µä»£ç åªæ˜¯ç”¨äºç¡®ä¿runtimeÂ·buildVersionä¿å­˜åœ¨ç»“æœäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚ buildVersion = \"unknown\" } if len(modinfo) == 1 { // Condition should never trigger. This code just serves // to ensure runtimeÂ·modinfo is kept in the resulting binary. // // æ¡ä»¶åº”è¯¥æ°¸è¿œä¸ä¼šè§¦å‘ã€‚è¿™æ®µä»£ç åªæ˜¯ç”¨äºç¡®ä¿runtimeÂ·modinfoä¿å­˜åœ¨ç»“æœäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚ modinfo = \"\" } } mcommoninit() getg()è·å–å‡ºæ¥çš„æ˜¯g0ï¼Œç„¶åè°ƒç”¨mcommoninitå‡½æ•°å¯¹m0(g0.m)è¿›è¡Œå¿…è¦çš„åˆå§‹åŒ–ã€‚ é¢„åˆ†é…çš„IDå¯ä»¥ä½œä¸º'id'ä¼ é€’ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¼ é€’ -1 æ¥çœç•¥ï¼Œç³»ç»Ÿé»˜è®¤åˆ†é…ã€‚ è¯¥å‡½æ•°åœ¨æ–°åˆ›å»ºå·¥ä½œçº¿ç¨‹æ—¶ä¹Ÿä¼šè¢«è°ƒç”¨ï¼Œå› æ­¤å¯èƒ½ä¼šå‡ºç°ç«äº‰ã€‚ æ€»ç»“ï¼šè¯¥æ–¹æ³•ä¸»è¦ä¸ºå·¥ä½œçº¿ç¨‹åˆ†é…ï¼ˆæŒ‡å®šä¸€ä¸ªå”¯ä¸€idï¼‰ï¼Œå¹¶åˆå§‹åŒ–mçš„ç›¸å…³å‚æ•°ï¼ŒæŠŠmåŠ å…¥åˆ°å…¨å±€allmä¸­ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 785 786 787 788 789 790 791 792 793 794 795 796 797 798 799 800 801 802 803 804 805 806 807 808 809 810 811 812 813 814 815 816 817 818 819 820 821 822 823 824 825 826 827 828 829 830 831 832 833 834 835 836 837 838 839 840 841 842 843 844 845 846 847 848 849 // Pre-allocated ID may be passed as 'id', or omitted by passing -1. func mcommoninit(mp *m, id int64) { _g_ := getg() // \u0026g0 // g0 stack won't make sense for user (and is not necessary unwindable). // // g0å †æ ˆå¯¹ç”¨æˆ·æ¥è¯´æ²¡æœ‰æ„ä¹‰(å¹¶ä¸”ä¸ä¸€å®šæ˜¯å¯æ’¤é”€çš„)ã€‚ if _g_ != _g_.m.g0 { callers(1, mp.createstack[:]) } // è·å– mutex é” lock(\u0026sched.lock) if id \u003e= 0 { mp.id = id // ä½¿ç”¨ä¼ é€’æ¥çš„id } else { mp.id = mReserveID() // ç³»ç»Ÿåˆ†é… } // æ ¹æ®mp.idå’Œfastrandseedç”Ÿæˆéšæœºhash lo := uint32(int64Hash(uint64(mp.id), fastrandseed)) // æ ¹æ®cputicks()å’Œ^fastrandseedç”Ÿæˆéšæœºhashã€‚cputicks()æ˜¯å½“å‰CPUæ—¶é—´ hi := uint32(int64Hash(uint64(cputicks()), ^fastrandseed)) // å¦‚æœ lo å’Œ hi åˆšå¥½äº’è¡¥æ—¶ if lo|hi == 0 { hi = 1 } // Same behavior as for 1.17. // TODO: Simplify ths. // // ä¸‹é¢é€šè¿‡ uint32 çš„ lo å’Œ hi ç»„æˆä¸€ä¸ª(hi\u003c\u003c32 + lo)çš„uint64éšæœºå€¼ // å› ä¸ºå†…å­˜å­˜å‚¨çš„åŸå› æ‰€ä»¥æœ‰ä»¥ä¸‹åˆ¤æ–­ï¼Œä»¥åŠæ•°æ®çš„æ“ä½œä¸ä¸€æ · if goarch.BigEndian { // æ•°æ®å­˜å‚¨æ˜¯å¤§ç«¯å­˜å‚¨æ—¶ mp.fastrand = uint64(lo)\u003c\u003c32 | uint64(hi) } else { // æ•°æ®å­˜å‚¨æ˜¯å°ç«¯å­˜å‚¨æ—¶ // linux x86èµ°è¿™é‡Œã€‚fastrandè¡¨ç¤ºMçš„éšæœºå€¼ã€‚ mp.fastrand = uint64(hi)\u003c\u003c32 | uint64(lo) } // åˆ›å»ºä¿¡å·å¤„ç†çš„gsignalã€‚ // åˆ†é…ä¸€ä¸ª32KBå¤§å°çš„æ ˆï¼Œç„¶å mp.gsignal.m = mp mpreinit(mp) if mp.gsignal != nil { // è®¾ç½® mp.gsignal.stackguard1 = 0 + _StackGuard mp.gsignal.stackguard1 = mp.gsignal.stack.lo + _StackGuard } // Add to allm so garbage collector doesn't free g-\u003em // when it is just in a register or thread-local storage. mp.alllink = allm // mp.alllink ä¸ allm ç»‘å®š // NumCgoCall() iterates over allm w/o schedlock, // so we need to publish it safely. atomicstorep(unsafe.Pointer(\u0026allm), unsafe.Pointer(mp)) // atomically allm = mp unlock(\u0026sched.lock) // mutex è§£é” // Allocate memory to hold a cgo traceback if the cgo call crashes. // å¦‚æœcgoè°ƒç”¨å´©æºƒï¼Œåˆ†é…å†…å­˜ä¿å­˜cgoå›æº¯ã€‚ if iscgo || GOOS == \"solaris\" || GOOS == \"illumos\" || GOOS == \"windows\" { mp.cgoCallers = new(cgoCallers) } } mReserveID() å‘ç³»ç»Ÿç”³è¯·IDã€‚å°±æ˜¯é€’å¢çš„å€¼ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 // mReserveID returns the next ID to use for a new m. This new m is immediately // considered 'running' by checkdead. // // sched.lock must be held. func mReserveID() int64 { // è°ƒç”¨è¯¥æ–¹æ³•æ—¶ sched.lock é”å¿…é¡»å·²è¢«æŒæœ‰ assertLockHeld(\u0026sched.lock) // mnext å€¼å·²ç»æº¢å‡º if sched.mnext+1 \u003c sched.mnext { throw(\"runtime: thread ID overflow\") } id := sched.mnext // åˆ†é…è¯¥å€¼ sched.mnext++ // æ£€æŸ¥æ˜¯å¦è¶…å‡ºè®¾ç½®çš„æœ€å¤§å€¼ checkmcount() return id } 759 760 761 762 763 764 765 766 767 768 // sched.lock must be held. func checkmcount() { assertLockHeld(\u0026sched.lock) // sched.maxmcount æœ€å¤§å€¼é»˜è®¤è¢«è®¾ç½®ä¸º 10000 if mcount() \u003e sched.maxmcount { print(\"runtime: program exceeds \", sched.maxmcount, \"-thread limit\\n\") throw(\"thread exhaustion\") } } 4490 4491 4492 4493 func mcount() int32 { // sched.nmfreed å·²é‡Šæ”¾çš„å·¥ä½œçº¿ç¨‹æ•°é‡ return int32(sched.mnext - sched.nmfreed) } mpreinit() mpreinit ä¸ºgsignalåˆ†é…32KBæ ˆï¼Œå¹¶ç»‘å®šå½“å‰Mã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/os_linux.goã€‚ 381 382 383 384 385 386 // Called to initialize a new m (including the bootstrap m). // Called on the parent thread (main thread in case of bootstrap), can allocate memory. func mpreinit(mp *m) { mp.gsignal = malg(32 * 1024) // Linux wants \u003e= 2K mp.gsignal.m = mp } atomicstorep() atomicstorep åŸå­åœ°æ‰§è¡Œ *ptr = newï¼Œå¹¶è°ƒç”¨ä¸€ä¸ªå†™å±éšœã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/atomic_pointer.goã€‚ 28 29 30 31 32 33 34 35 36 37 // atomicstorep performs *ptr = new atomically and invokes a write barrier. // //go:nosplit func atomicstorep(ptr unsafe.Pointer, new unsafe.Pointer) { // å¦‚æœå¼€å¯äº†å†™å±éšœ if writeBarrier.enabled { atomicwb((*unsafe.Pointer)(ptr), new) } atomic.StorepNoWB(noescape(ptr), new) // *ptr = new } æ­¤æ—¶ï¼Œä¸»çº¿ç¨‹ï¼Œm0ï¼Œg0ä»¥åŠg0çš„æ ˆä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š goargs() ä¿å­˜argvå‚æ•°åˆ°argsliceä¸­ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/runtime1.goã€‚ 72 73 74 75 76 77 78 79 80 81 82 83 84 85 func goargs() { if GOOS == \"windows\" { return } // ç”³è¯·å‚æ•°éœ€è¦çš„å†…å­˜å¤§å° argslice = make([]string, argc) for i := int32(0); i \u003c argc; i++ { // argv_index åœ¨7.1.2ä¸­åˆ—å‡ºï¼Œå°±æ˜¯åç§»iä¸ªå­—èŠ‚ argslice[i] = gostringnocopy(argv_index(argv, i)) } } var envs []string var argslice []string gostringnocopyç»„è£…æˆä¸€ä¸ªå­—ç¬¦ä¸²ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/string.goã€‚ 564 565 566 567 568 569 570 //go:nosplit func gostringnocopy(str *byte) string { // findnullå¯»æ‰¾åˆ°nullç»“æŸè¯†åˆ«å­—ç¬¦ä¸²é•¿åº¦ ss := stringStruct{str: unsafe.Pointer(str), len: findnull(str)} s := *(*string)(unsafe.Pointer(\u0026ss)) return s } goenvs() è§£æç¯å¢ƒå˜é‡ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/os_linux.goã€‚ 367 368 369 func goenvs() { goenvs_unix() } æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/runtime1.goã€‚ 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 func goenvs_unix() { // TODO(austin): ppc64 in dynamic linking mode doesn't // guarantee env[] will immediately follow argv. Might cause // problems. n := int32(0) // è·³è¿‡argv + NULLï¼Œåˆ°envpï¼Œè®¡ç®—envpçš„é•¿åº¦ã€‚ // argv_index å‚è€ƒ7.1.2 for argv_index(argv, argc+1+n) != nil { n++ } envs = make([]string, n) // ç”³è¯·né•¿åº¦çš„å†…å­˜ for i := int32(0); i \u003c n; i++ { envs[i] = gostring(argv_index(argv, argc+1+i)) } } æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/string.goã€‚ 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 // This is exported via linkname to assembly in syscall (for Plan9). // //go:linkname gostring func gostring(p *byte) string { l := findnull(p) // æ‰¾å‡ºå­—ç¬¦ä¸²é•¿åº¦ if l == 0 { return \"\" } // rawstring å‡½æ•°åœ¨å­—ç¬¦ä¸²åŒ…ä¸­å·²ç»ä»‹ç»è¿‡ // åˆ†ä¼šçš„så’Œbåˆ†åˆ«å…±ç”¨ä¸€ä¸ªåº•å±‚ï¼Œè¿™æ ·æ“ä½œbåˆ‡ç‰‡sä¹Ÿä¼šè·Ÿç€æ”¹å˜ s, b := rawstring(l) // s string, b []byte // æ‹·è´æ•°æ®åˆ°bä¸­ä»pæ‹·è´é•¿åº¦lå­—èŠ‚ã€‚ memmove(unsafe.Pointer(\u0026b[0]), unsafe.Pointer(p), uintptr(l)) return s } åˆå§‹åŒ–allp ä¸‹é¢åˆ†æprocresize()å‡½æ•°ã€‚ è€ƒè™‘åˆ°åˆå§‹åŒ–å®Œæˆä¹‹åç”¨æˆ·ä»£ç è¿˜å¯ä»¥é€šè¿‡GOMAXPROCS()å‡½æ•°è°ƒç”¨å®ƒé‡æ–°åˆ›å»ºå’Œåˆå§‹åŒ–pç»“æ„ä½“å¯¹è±¡ã€‚ è€Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å†åŠ¨æ€çš„è°ƒæ•´pç‰µæ¶‰åˆ°çš„é—®é¢˜æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°çš„å¤„ç†æ¯”è¾ƒå¤æ‚ã€‚ procresize() æ›´æ”¹å¤„ç†å™¨æ•°é‡ã€‚sched.lockå¿…é¡»è¢«æŒæœ‰å¹¶ä¸”å¿…é¡»æ˜¯åœ¨STWæœŸé—´ã€‚ gcworkbufsä¸èƒ½è¢«GCæˆ–å†™å±éšœä»£ç ä¿®æ”¹ï¼Œå› æ­¤å¦‚æœPæ•°å®é™…å‘ç”Ÿå˜åŒ–ï¼ŒGCå¿…é¡»ä¸è¿è¡Œã€‚ è¿”å›å…·æœ‰æœ¬åœ°å·¥ä½œçš„påˆ—è¡¨ï¼Œå®ƒä»¬éœ€è¦ç”±è°ƒç”¨è€…è°ƒåº¦ã€‚ è¯¥å‡½æ•°ä¼šåœ¨ã€ç¨‹åºåˆå§‹åŒ–ã€‘æˆ–ã€startTheWorldWithSemaã€‘å‡½æ•°ä¸­è¢«è°ƒç”¨ã€‚ å‡½æ•°æµç¨‹ï¼š ä½¿ç”¨make([]*p, nprocs)åˆå§‹åŒ–å…¨å±€å˜é‡allpï¼Œå³allp = make([]*p, nprocs)ã€‚ å¾ªç¯åˆ›å»ºå¹¶åˆå§‹åŒ–nprocsä¸ªpç»“æ„ä½“å¯¹è±¡å¹¶ä¾æ¬¡ä¿å­˜åœ¨allpåˆ‡ç‰‡ä¹‹ä¸­ã€‚ æŠŠm0å’Œallp[0]ç»‘å®šåœ¨ä¸€èµ·ï¼Œå³ã€m0.p = allp[0], allp[0].m = m0ã€‘ã€‚ æŠŠé™¤äº†allp[0]ä¹‹å¤–çš„æ‰€æœ‰pæ”¾å…¥åˆ°å…¨å±€å˜é‡schedçš„pidleç©ºé—²é˜Ÿåˆ—ä¹‹ä¸­ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 4793 4794 4795 4796 4797 4798 4799 4800 4801 4802 4803 4804 4805 4806 4807 4808 4809 4810 4811 4812 4813 4814 4815 4816 4817 4818 4819 4820 4821 4822 4823 4824 4825 4826 4827 4828 4829 4830 4831 4832 4833 4834 4835 4836 4837 4838 4839 4840 4841 4842 4843 4844 4845 4846 4847 4848 4849 4850 4851 4852 4853 4854 4855 4856 4857 4858 4859 4860 4861 4862 4863 4864 4865 4866 4867 4868 4869 4870 4871 4872 4873 4874 4875 4876 4877 4878 4879 4880 4881 4882 4883 4884 4885 4886 4887 4888 4889 4890 4891 4892 4893 4894 4895 4896 4897 4898 4899 4900 4901 4902 4903 4904 4905 4906 4907 4908 4909 4910 4911 4912 4913 4914 4915 4916 4917 4918 4919 4920 4921 4922 4923 4924 4925 4926 4927 4928 4929 4930 4931 4932 4933 4934 4935 4936 4937 4938 4939 4940 4941 4942 4943 4944 4945 4946 4947 4948 4949 4950 4951 4952 4953 4954 4955 4956 4957 4958 4959 4960 4961 4962 4963 4964 4965 4966 4967 4968 4969 4970 4971 4972 4973 4974 4975 4976 4977 4978 4979 4980 4981 4982 4983 4984 // Change number of processors. // // sched.lock must be held, and the world must be stopped. // // gcworkbufs must not be being modified by either the GC or the write barrier // code, so the GC must not be running if the number of Ps actually changes. // // Returns list of Ps with local work, they need to be scheduled by the caller. func procresize(nprocs int32) *p { // sched.lock é”å·²ç»è¢«æŒæœ‰ assertLockHeld(\u0026sched.lock) // å¿…é¡»æ˜¯ STW æœŸé—´ assertWorldStopped() // ç³»ç»Ÿåˆå§‹åŒ–æ—¶ï¼Œgomaxprocs = 0 old := gomaxprocs // æ—§çš„æ•°é‡ï¼Œä¹Ÿå°±æ˜¯ä¸Šæ¬¡çš„æ•°é‡ // nprocs æœåŠ¡å™¨cpuæ ¸æ•°ï¼Œæˆ–ç”¨æˆ·é€šè¿‡GOMAXPROCSç¯å¢ƒå˜é‡æŒ‡å®šçš„æ•°é‡ if old \u003c 0 || nprocs \u003c= 0 { throw(\"procresize: invalid arg\") } if trace.enabled { traceGomaxprocs(nprocs) } // update statistics now := nanotime() // å½“å‰æ—¶é—´ // sched.procresizetime æœ€åä¸€æ¬¡æ”¹å˜gomaxprocsçš„æ—¶é—´ if sched.procresizetime != 0 { // ä»å¤‡æ³¨ä¸­çœ‹å‡ºè¯¥å€¼æ˜¯procresizetimeå˜åŒ–çš„ç§¯åˆ†ï¼Œå› è¯¥ç”¨äºç»Ÿè®¡ç›¸å…³ // âˆ«gomaxprocs dt up to procresizetime sched.totaltime += int64(old) * (now - sched.procresizetime) } sched.procresizetime = now // ä»¥32ä¸ºä¸€ç»„ï¼Œåˆ†åˆ«å¤„ç†Pçš„æ ‡å¿—ä½ // idlepMaskï¼šè¡¨ç¤ºåœ¨_Pidleåˆ—è¡¨ä¸­çš„ä½æ©ç ï¼Œæ¯ä¸€ä¸ªPè¡¨ç¤ºä¸€ä½ï¼Œè®°å½•é‚£äº›På¤„ç†_Pidleï¼ˆç©ºé—²ï¼‰çŠ¶æ€ // timerpMaskï¼šè¡¨ç¤ºPåœ¨timerä¸Šçš„ä½æ©ç ï¼Œæ¯ä¸€ä¸ªPè¡¨ç¤ºä¸€ä½ï¼Œè®°å½•Pä¸timerç›¸å…³ï¼ˆ1è¡¨ç¤ºæœ‰timerï¼Œ0è¡¨ç¤ºæ²¡æœ‰timerï¼‰ // idlepMaskå’ŒtimerpMaskç”¨äºå¿«é€Ÿåˆ¤æ–­Pçš„çŠ¶æ€å’ŒPä¸Šæ˜¯å¦æœ‰timerã€‚ maskWords := (nprocs + 31) / 32 // int32 // Grow allp if necessary. // // å¦‚æœæœ‰å¿…è¦æ‰©å±•allpã€‚ if nprocs \u003e int32(len(allp)) { // åˆå§‹åŒ–æ—¶ æˆ– Pçš„æ•°é‡æ‰©å¤§æ—¶ // Synchronize with retake, which could be running // concurrently since it doesn't run on a P. lock(\u0026allpLock)\t// è·å– mutex é” // å½“å‰ allp çš„å®¹é‡è¶³å¤Ÿæœ¬æ¬¡æ‰©å±•ã€‚å¤„ç†P if nprocs \u003c= int32(cap(allp)) { allp = allp[:nprocs] } else { // ä»æ–°ç”³è¯·å†…å­˜å¹¶æ‹·è´ nallp := make([]*p, nprocs) // Copy everything up to allp's cap so we // never lose old allocated Ps. copy(nallp, allp[:cap(allp)]) allp = nallp } // idlepMaskå’ŒtimerpMaskå¤„ç†ï¼Œå®¹é‡å¤Ÿï¼Œç›´æ¥ä½¿ç”¨ if maskWords \u003c= int32(cap(idlepMask)) { idlepMask = idlepMask[:maskWords] timerpMask = timerpMask[:maskWords] } else { // å®¹é‡ä¸å¤Ÿï¼Œç”³è¯·å†…å­˜å¹¶æ¬è¿ // åˆ›å»ºä¸€ä¸ª []uint32ï¼Œæ¯ä¸€ä½åˆ†åˆ«ä»£è¡¨ä¸€ä¸ªP nidlepMask := make([]uint32, maskWords) // No need to copy beyond len, old Ps are irrelevant. copy(nidlepMask, idlepMask) idlepMask = nidlepMask ntimerpMask := make([]uint32, maskWords) copy(ntimerpMask, timerpMask) timerpMask = ntimerpMask } unlock(\u0026allpLock) // mutex è§£é” } // initialize new P's // // åˆå§‹åŒ–æ‰€æœ‰æ–°åˆ›å»ºçš„Pï¼Œä»oldå¤„å¼€å§‹å› æ­¤ä¹‹å‰çš„å·²ç»åˆå§‹åŒ–äº† for i := old; i \u003c nprocs; i++ { pp := allp[i] if pp == nil { // å¯è§Pæ˜¯å †åˆ†é…çš„ pp = new(p) } pp.init(i) // åˆå§‹åŒ–å½“å‰P // åŸå­è®¾ç½® ã€allp[i] = ppã€‘ atomicstorep(unsafe.Pointer(\u0026allp[i]), unsafe.Pointer(pp)) // ä¿å­˜allpä¸­å» } _g_ := getg() // g0 // å½“å‰mç»‘å®šäº†Pæ—¶ï¼Œåˆå§‹åŒ–æ—¶må¹¶æ²¡æœ‰ç»‘å®šPï¼Œ_g_.m.p == 0ã€‚ // _g_.m.p != 0 \u0026\u0026 _g_.m.p.ptr().id \u003c nprocs è¿™ç§æƒ…å†µæˆç«‹å‘ç”Ÿåœ¨ï¼š // å‘ç”Ÿæ‰©å®¹ æˆ– å‘ç”Ÿç¼©å®¹(å½“å‰På¹¶ä¸åœ¨è£å‰ªä¹‹å¤–) if _g_.m.p != 0 \u0026\u0026 _g_.m.p.ptr().id \u003c nprocs { // continue to use the current P // // ç»§ç»­ä½¿ç”¨å½“å‰Pï¼Œ_Prunning è¿è¡Œä¸­çŠ¶æ€ _g_.m.p.ptr().status = _Prunning _g_.m.p.ptr().mcache.prepareForSweep() // æ¸…ç† } else { // release the current P and acquire allp[0]. // // We must do this before destroying our current P // because p.destroy itself has write barriers, so we // need to do that from a valid P. if _g_.m.p != 0 { // è¿™ç§æƒ…å†µå‘ç”Ÿåœ¨Påœ¨ç¼©å®¹(å½“å‰På¹¶ä¸åœ¨è£å‰ªä¹‹å¤–) if trace.enabled { // Pretend that we were descheduled // and then scheduled again to keep // the trace sane. traceGoSched() traceProcStop(_g_.m.p.ptr()) } // å½“å‰Mç»‘å®šçš„pä¸å½“å‰Mè§£ç»‘ // å› ä¸º M ä¸ P ç›¸äº’ç»‘å®šçš„ï¼Œè¿™é‡Œè¦è§£ç»‘ _g_.m.p.ptr().m = 0 // p.m = 0 } // åˆå§‹åŒ–æ—¶ï¼Œä¼šèµ°è¿™é‡Œ // è§£ç»‘Mä¸På…³ç³» _g_.m.p = 0 // m.p = 0 // é€‰å–allp[0]ç»‘å®šå½“å‰å·¥ä½œçº¿ç¨‹ p := allp[0] p.m = 0 // _Pidle ç©ºé—²çŠ¶æ€ p.status = _Pidle // æ ‡è®°å½“å‰Pä¸ºç©ºé—²çŠ¶æ€ // è¯¥æ–¹æ³•è¦æ±‚På’ŒMéƒ½æ˜¯æ²¡æœ‰ç»‘å®šçš„ï¼Œå¹¶ä¸”Pä¸€å®šæ˜¯_PidleçŠ¶æ€ã€‚ // p.m = m; m.p = p; acquirep(p) // mä¸pç›¸äº’ç»‘å®šï¼Œå¹¶ä¿®æ”¹pçš„çŠ¶æ€ä¸ºè¿è¡Œä¸­ã€‚ if trace.enabled { traceGoStart() } } // g.m.p is now set, so we no longer need mcache0 for bootstrapping. // // g.m.p ç°åœ¨å·²ç»è®¾ç½®ï¼Œå› æ­¤æˆ‘ä»¬ä¸å†éœ€è¦ mcache0 æ¥è¿›è¡Œå¼•å¯¼ã€‚ // mcache0 åœ¨ p.init() å‡½æ•°ä¸­è¢«ä½¿ç”¨ mcache0 = nil // è¯¥å€¼åœ¨å‰é¢schedinit()å‡½æ•°ä¸­ï¼Œæ ˆç›¸å…³åˆå§‹åŒ–æ—¶è¢«è®¾ç½® // release resources from unused P's // // ä»æœªä½¿ç”¨çš„ P é‡Šæ”¾èµ„æºï¼Œè¿™ç§æƒ…å†µå‘ç”Ÿåœ¨ç¼©å®¹Pæ—¶ for i := nprocs; i \u003c old; i++ { p := allp[i] p.destroy() // å›æ”¶P // can't free P itself because it can be referenced by an M in syscall // // ä¸èƒ½é‡Šæ”¾Pæœ¬èº«ï¼Œå› ä¸ºå®ƒå¯ä»¥è¢«ç³»ç»Ÿè°ƒç”¨ä¸­çš„Må¼•ç”¨ } // Trim allp. // è£å‰ª allpã€‚ if int32(len(allp)) != nprocs { lock(\u0026allpLock) allp = allp[:nprocs] idlepMask = idlepMask[:maskWords] timerpMask = timerpMask[:maskWords] unlock(\u0026allpLock) } var runnablePs *p // éå†æ‰€æœ‰Pï¼Œå¤„ç†Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­æœ‰goroutineçš„éœ€è¦ç»‘å®šMè¿è¡Œè¿™äº›goroutineã€‚ for i := nprocs - 1; i \u003e= 0; i-- { p := allp[i] // è·³è¿‡å½“å‰Pï¼Œå½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„Pæ­£åœ¨æ‰§è¡Œè¿™é‡Œçš„ä»£ç éœ€è¦è·³è¿‡ if _g_.m.p.ptr() == p { continue } p.status = _Pidle // çŠ¶æ€ä¿®æ”¹ä¸º _Pidle ç©ºé—² if runqempty(p) { // Pçš„runqæ˜¯ç©ºçš„æ—¶ pidleput(p, now) // æŠŠå½“å‰PæŒ‚åœ¨å…¨å±€schedç©ºé—²é“¾è¡¨ä¸­ } else { p.m.set(mget()) // pç»‘å®šm p.link.set(runnablePs) runnablePs = p } } // é‡ç½® stealOrderï¼Œè¯¥å€¼ç”¨äºéšæœºä»allpä¸­å·å–goroutineåˆå§‹æ¡ä»¶ stealOrder.reset(uint32(nprocs)) // åˆå§‹åŒ–Påé¢è¦ç”¨åˆ°å·å–çš„æ•°æ® // åŸå­ç»‘å®š gomaxprocs = nprocs var int32p *int32 = \u0026gomaxprocs // make compiler check that gomaxprocs is an int32 atomic.Store((*uint32)(unsafe.Pointer(int32p)), uint32(nprocs)) // gomaxprocs = nprocs if old != nprocs { // Notify the limiter that the amount of procs has changed. gcCPULimiter.resetCapacity(now, nprocs) } // runnablePs != nil è¯´æ˜é™¤äº†å½“å‰På¤–çš„å…¶ä»–Pä¸­å­˜åœ¨goroutine return runnablePs } p.init() åˆå§‹åŒ–Pã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 4669 4670 4671 4672 4673 4674 4675 4676 4677 4678 4679 4680 4681 4682 4683 4684 4685 4686 4687 4688 4689 4690 4691 4692 4693 4694 4695 4696 4697 4698 4699 4700 4701 4702 4703 4704 4705 4706 4707 4708 4709 4710 4711 4712 // init initializes pp, which may be a freshly allocated p or a // previously destroyed p, and transitions it to status _Pgcstop. func (pp *p) init(id int32) { pp.id = id\t// åˆ†é…Pçš„idï¼Œè¯¥idæ˜¯å”¯ä¸€çš„ pp.status = _Pgcstop // è®¾ç½®PçŠ¶æ€ _Pgcstop GCåœæ­¢çŠ¶æ€ pp.sudogcache = pp.sudogbuf[:0] // Pä¸Šsudogç¼“å­˜ pp.deferpool = pp.deferpoolbuf[:0] // Pä¸Šdeferæ±  pp.wbBuf.reset() // Pçš„wbBufé‡ç½®ï¼Œè¯¥å­—æ®µä¸å†™å±éšœç›¸å…³ // pp.mcache æ²¡æœ‰åˆå§‹åŒ– if pp.mcache == nil { if id == 0 { // ç¨‹åºåˆšåˆå§‹åŒ–æ—¶ï¼Œmcache0åœ¨schedinit()ä¸­çš„mallocinit()å‡½æ•°ä¸­è¢«åˆ›å»º if mcache0 == nil { throw(\"missing mcache?\") } // Use the bootstrap mcache0. Only one P will get // mcache0: the one with ID 0. pp.mcache = mcache0 } else { // ä½¿ç”¨ allocmcache() åˆ†é…ç¼“å­˜ pp.mcache = allocmcache() } } if raceenabled \u0026\u0026 pp.raceprocctx == 0 { if id == 0 { pp.raceprocctx = raceprocctx0 raceprocctx0 = 0 // bootstrap } else { pp.raceprocctx = raceproccreate() } } lockInit(\u0026pp.timersLock, lockRankTimers) // åˆå§‹åŒ– P.timersLock é” // This P may get timers when it starts running. Set the mask here // since the P may not go through pidleget (notably P 0 on startup). // // è¿™ä¸ªPå¼€å§‹è¿è¡Œæ—¶å¯èƒ½ä¼šæœ‰timesã€‚åœ¨è¿™é‡Œè®¾ç½®å¯èƒ½ä¸ä¼šç»è¿‡pidleget(ç‰¹åˆ«æ˜¯åœ¨å¯åŠ¨æ—¶P 0)ã€‚ timerpMask.set(id) // Similarly, we may not go through pidleget before this P starts // running if it is P 0 on startup. // // ç±»ä¼¼çš„ï¼Œå¦‚æœè¿™ä¸ªPæ˜¯åœ¨å¯åŠ¨çš„æ˜¯P 0ï¼Œæˆ‘ä»¬å¯èƒ½ä¸ä¼šåœ¨è¿™ä¸ªPå¼€å§‹è¿è¡Œä¹‹å‰ç»å†pidlegetã€‚ idlepMask.clear(id) } acquirep() Må’ŒPç›¸äº’ç»‘å®šã€‚m.p = pã€p.m = mã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 4938 4939 4940 4941 4942 4943 4944 4945 4946 4947 4948 4949 4950 4951 4952 4953 4954 4955 4956 4957 4958 4959 4960 4961 // Associate p and the current m. // // This function is allowed to have write barriers even if the caller // isn't because it immediately acquires _p_. // //go:yeswritebarrierrec func acquirep(_p_ *p) { // Do the part that isn't allowed to have write barriers. // // ä¸å…è®¸æœ‰å†™å…¥éšœç¢çš„éƒ¨åˆ†ã€‚ wirep(_p_) // mä¸pç›¸äº’ç»‘å®šï¼Œå¹¶ä¿®æ”¹pçš„çŠ¶æ€ä¸ºè¿è¡Œä¸­ã€‚ // Have p; write barriers now allowed. // Perform deferred mcache flush before this P can allocate // from a potentially stale mcache. // // åœ¨è¿™ä¸ªPå¯ä»¥ä»å¯èƒ½è¿‡æœŸçš„mcacheè¿›è¡Œåˆ†é…ä¹‹å‰æ‰§è¡Œå»¶è¿Ÿçš„mcacheåˆ·å†™ã€‚ _p_.mcache.prepareForSweep() // GCç›¸å…³ if trace.enabled { traceProcStart() } } wirep() wirepæ˜¯acquirep çš„ç¬¬ä¸€æ­¥ï¼Œå®ƒå®é™…ä¸Šå°†å½“å‰Må…³è”åˆ° _p_ã€‚ è¿™é‡Œä¸å…è®¸æ ˆæ£€æŸ¥ï¼Œä»¥åŠå†™å±éšœç›¸å…³ä»£ç ï¼Œå› ä¸ºMè¿˜æ²¡æœ‰ç»‘å®šPã€‚ mä¸pç›¸äº’ç»‘å®šï¼Œå¹¶ä¿®æ”¹pçš„çŠ¶æ€ä¸ºè¿è¡Œä¸­ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 4959 4960 4961 4962 4963 4964 4965 4966 4967 4968 4969 4970 4971 4972 4973 4974 4975 4976 4977 4978 4979 4980 4981 4982 4983 4984 4985 4986 4987 // wirep is the first step of acquirep, which actually associates the // current M to _p_. This is broken out so we can disallow write // barriers for this part, since we don't yet have a P. // //go:nowritebarrierrec //go:nosplit func wirep(_p_ *p) { // åœ¨å½“å‰è¿™é‡Œåªèƒ½æ˜¯g0ï¼Œä½†æ˜¯å…¶ä»–åœ°æ–¹å¯èƒ½æ˜¯g _g_ := getg() // g0 // æ­¤æ—¶Mä¸€å®šæ˜¯æ²¡æœ‰ç»‘å®šPçš„ã€‚ if _g_.m.p != 0 { throw(\"wirep: already in go\") } // æ­¤æ—¶pä¸€å®šæ²¡æœ‰ç»‘å®šMï¼Œå¹¶ä¸”Pä¸€å®šæ˜¯_PidleçŠ¶æ€ï¼ˆç©ºé—²ï¼‰ if _p_.m != 0 || _p_.status != _Pidle { id := int64(0) if _p_.m != 0 { id = _p_.m.ptr().id } print(\"wirep: p-\u003em=\", _p_.m, \"(\", id, \") p-\u003estatus=\", _p_.status, \"\\n\") throw(\"wirep: invalid p state\") } // Mä¸Pç›¸äº’ç»‘å®šï¼Œå¹¶è®¾ç½®Pçš„çŠ¶æ€ä¸ºè¿è¡Œä¸­ _g_.m.p.set(_p_) // m.p = _p_ _p_.m.set(_g_.m) // _p_.m = m // _Prunning è¿è¡Œä¸­çŠ¶æ€ _p_.status = _Prunning // ä¿®æ”¹å½“å‰Pä¸ºè¿è¡ŒçŠ¶æ€ } p.destroy() destroyé‡Šæ”¾ä¸ppç›¸å…³çš„æ‰€æœ‰èµ„æºï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºçŠ¶æ€_Pdeadã€‚ sched.lockå¿…é¡»è¢«æŒæœ‰å¹¶ä¸”STWã€‚ è¯¥å‡½æ•°å¤„ç†Pä¸­çš„goroutineï¼Œä»¥åŠè¿ç§»ppä¸Šæ‰€æœ‰çš„timerï¼Œä»¥åŠå†™å±éšœç›¸å…³å†…å­˜é‡Šæ”¾ç­‰ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 4707 4708 4709 4710 4711 4712 4713 4714 4715 4716 4717 4718 4719 4720 4721 4722 4723 4724 4725 4726 4727 4728 4729 4730 4731 4732 4733 4734 4735 4736 4737 4738 4739 4740 4741 4742 4743 4744 4745 4746 4747 4748 4749 4750 4751 4752 4753 4754 4755 4756 4757 4758 4759 4760 4761 4762 4763 4764 4765 4766 4767 4768 4769 4770 4771 4772 4773 4774 4775 4776 4777 4778 4779 4780 4781 4782 4783 4784 4785 4786 4787 4788 4789 4790 4791 4792 4793 4794 4795 4796 4797 4798 4799 4800 4801 4802 4803 4804 4805 4806 4807 4808 // destroy releases all of the resources associated with pp and // transitions it to status _Pdead. // // sched.lock must be held and the world must be stopped. func (pp *p) destroy() { assertLockHeld(\u0026sched.lock) assertWorldStopped() // Move all runnable goroutines to the global queue // // å°†å½“å‰Pçš„æ‰€æœ‰å¯è¿è¡Œçš„goroutinesç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ— for pp.runqhead != pp.runqtail { // Pop from tail of local queue pp.runqtail-- gp := pp.runq[pp.runqtail%uint32(len(pp.runq))].ptr() // Push onto head of global queue globrunqputhead(gp) // åŠ å…¥åˆ°å…¨å±€é˜Ÿåˆ—æ± ä¸­ } // pp.runnext ä¸Šå­˜åœ¨ goroutineï¼ŒåŠ å…¥åˆ°å…¨å±€æ±  if pp.runnext != 0 { globrunqputhead(pp.runnext.ptr()) pp.runnext = 0 } // P ä¸­è¿˜æœ‰timerã€‚ if len(pp.timers) \u003e 0 { // å½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„P plocal := getg().m.p.ptr() // The world is stopped, but we acquire timersLock to // protect against sysmon calling timeSleepUntil. // This is the only case where we hold the timersLock of // more than one P, so there are no deadlock concerns. // // STWäº†ï¼Œä½†æ˜¯æˆ‘ä»¬è·å¾—äº†timersLockæ¥é˜²æ­¢sysmonè°ƒç”¨timeSleepUntil // è¿™æ˜¯æˆ‘ä»¬æŒæœ‰ä¸æ­¢ä¸€ä¸ªPçš„å®šæ—¶å™¨é”çš„å”¯ä¸€æƒ…å†µï¼Œå› æ­¤ä¸å­˜åœ¨æ­»é”é—®é¢˜ã€‚ lock(\u0026plocal.timersLock) // plocal lock(\u0026pp.timersLock) // pp // æŠŠpp.timersä¸­æ‰€æœ‰æœ‰æ•ˆçš„timeré‡æ–°æ·»åŠ åˆ°plocal.timersä¸­ // è¿™é‡ŒæŠŠéœ€è¦åˆ é™¤çš„ppä¸Šçš„æ‰€æœ‰timerè½¬ç§»åˆ°å½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„Pä¸Šé¢ moveTimers(plocal, pp.timers) pp.timers = nil // æƒ…å†µ pp.timersï¼Œå› ä¸ºtimerså·²ç»è¿ç§»åˆ°äº†å½“å‰å·¥ä½œçº¿ç¨‹çš„Päº†ã€‚ // numTimersï¼šè®°å½•çš„æ˜¯å †ä¸­ timer çš„æ€»æ•°ï¼Œåº”è¯¥ä¸ timers åˆ‡ç‰‡çš„é•¿åº¦ä¸€è‡´ã€‚ pp.numTimers = 0 // deletedTimersï¼šè®°å½•çš„æ˜¯å †ä¸­å·²åˆ é™¤ä½†è¿˜æœªè¢«ç§»é™¤çš„ timer çš„æ€»æ•°ã€‚ pp.deletedTimers = 0 // timer0Whenï¼šè¡¨ç¤ºä½äºæœ€å°å †å †é¡¶çš„ timer çš„è§¦å‘æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯èµ‹å€¼å…¶ when å­—æ®µã€‚ atomic.Store64(\u0026pp.timer0When, 0) // pp.timer0When = 0 unlock(\u0026pp.timersLock) unlock(\u0026plocal.timersLock) } // Flush p's write barrier buffer. // // åˆ·æ–°pçš„å†™å±éšœç¼“å†²åŒºã€‚å†™å±éšœç›¸å…³ if gcphase != _GCoff { wbBufFlush1(pp) pp.gcw.dispose() } for i := range pp.sudogbuf { pp.sudogbuf[i] = nil } pp.sudogcache = pp.sudogbuf[:0] for j := range pp.deferpoolbuf { pp.deferpoolbuf[j] = nil } pp.deferpool = pp.deferpoolbuf[:0] // åˆ‡æ¢åˆ°g0æ ˆå¤„ç†mspancache systemstack(func() { // ç›¸å…³å†…å­˜é‡Šæ”¾ for i := 0; i \u003c pp.mspancache.len; i++ { // Safe to call since the world is stopped. mheap_.spanalloc.free(unsafe.Pointer(pp.mspancache.buf[i])) } pp.mspancache.len = 0 lock(\u0026mheap_.lock) pp.pcache.flush(\u0026mheap_.pages) unlock(\u0026mheap_.lock) }) freemcache(pp.mcache) // é‡Šæ”¾å†…å­˜ pp.mcache = nil gfpurge(pp) // å›æ”¶P traceProcFree(pp) if raceenabled { if pp.timerRaceCtx != 0 { // The race detector code uses a callback to fetch // the proc context, so arrange for that callback // to see the right thing. // This hack only works because we are the only // thread running. mp := getg().m phold := mp.p.ptr() mp.p.set(pp) racectxend(pp.timerRaceCtx) pp.timerRaceCtx = 0 mp.p.set(phold) } raceprocdestroy(pp.raceprocctx) pp.raceprocctx = 0 } pp.gcAssistTime = 0 pp.status = _Pdead // ä¿®æ”¹PçŠ¶æ€ä¸ºç©ºé—² } pidleput() å‚æ•°ï¼š _p_ *pï¼šå½“å‰æ“ä½œçš„pï¼Œè¯¥pçš„æœ¬åœ°é˜Ÿåˆ—åº”è¯¥æ˜¯ç©ºçš„ã€‚ now int64ï¼šå½“å‰æ—¶é—´ã€‚ æŠŠå½“_p_æŒ‚åœ¨å…¨å±€schedç©ºé—²é“¾è¡¨ä¸­ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5696 5697 5698 5699 5700 5701 5702 5703 5704 5705 5706 5707 5708 5709 5710 5711 5712 5713 5714 5715 5716 5717 5718 5719 5720 5721 5722 5723 5724 5725 5726 5727 5728 5729 5730 // pidleput puts p on the _Pidle list. now must be a relatively recent call // to nanotime or zero. Returns now or the current time if now was zero. // // This releases ownership of p. Once sched.lock is released it is no longer // safe to use p. // // sched.lock must be held. // // May run during STW, so write barriers are not allowed. // //go:nowritebarrierrec func pidleput(_p_ *p, now int64) int64 { // è°ƒç”¨è¯¥å‡½æ•°æ—¶ sched.lock å¿…é¡»è¢«æŒæœ‰ assertLockHeld(\u0026sched.lock) // å½“å‰På‡†å¤‡æ”¾å…¥ç©ºé—²é“¾è¡¨ï¼Œå› æ­¤runqä¸­ä¸èƒ½æœ‰goroutine if !runqempty(_p_) { throw(\"pidleput: P has non-empty run queue\") } if now == 0 { now = nanotime() } // æ›´æ–°TimerPMask updateTimerPMask(_p_) // clear if there are no timers. idlepMask.set(_p_.id) // æ ‡è®°_p_æ˜¯ç©ºé—²çš„ // æ”¾å…¥å…¨å±€é“¾è¡¨ä¸­ _p_.link = sched.pidle sched.pidle.set(_p_) // sched.pidle = _p_ // ç©ºé—²Pæ•°é‡åŠ ä¸€ atomic.Xadd(\u0026sched.npidle, 1) // sched.npidle if !_p_.limiterEvent.start(limiterEventIdle, now) { throw(\"must be able to track idle limiter event\") } return now } main goroutine schedinitå®Œæˆè°ƒåº¦ç³»ç»Ÿåˆå§‹åŒ–åã€‚ è¿”å›åˆ°rt0_goå‡½æ•°ä¸­å¼€å§‹è°ƒç”¨newproc()åˆ›å»ºä¸€ä¸ªæ–°çš„goroutineç”¨äºæ‰§è¡ŒmainPCæ‰€å¯¹åº”çš„runtimeÂ·mainå‡½æ•°ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ ä»¥ä¸‹runtimeÂ·newprocã€runtimeÂ·mstartå°†åœ¨åç»­æ–‡ç« ä¸­ä»‹ç»ã€‚ 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 # create a new goroutine to start program # # åˆ›å»ºä¸€ä¸ªæ–°çš„goroutineæ¥å¯åŠ¨ç¨‹åºã€‚ # AX = runtimeÂ·main # runtimeÂ·main æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œ\u0026funcval{fn:runtime.main} MOVQ $runtimeÂ·mainPC(SB), AX # entry # å°†AXçš„å€¼å‹å…¥æ ˆä¸­ PUSHQ AX # AXçš„å€¼ä½œä¸ºruntimeÂ·newproc()å‡½æ•°çš„å‚æ•° CALL runtimeÂ·newproc(SB) # åˆ›å»ºmain goroutine POPQ AX # start this M CALL runtimeÂ·mstart(SB) # ä¸»çº¿ç¨‹è¿›å…¥å¾ªç¯è°ƒåº¦ï¼Œè¿è¡Œåˆšåˆšåˆ›å»ºçš„goroutine # ä¸Šé¢çš„mstartæ°¸è¿œä¸åº”è¯¥è¿”å›çš„ï¼Œå¦‚æœè¿”å›äº†ï¼Œä¸€å®šæ˜¯ä»£ç é€»è¾‘æœ‰é—®é¢˜ï¼Œç›´æ¥abort CALL runtimeÂ·abort(SB)\t# mstart should never return RET # å‰é¢æ²¡æœ‰è·å–åˆ°CPUç›¸å…³ä¿¡æ¯æ—¶ä¼šèµ°è¿™é‡Œçš„å¼‚å¸¸ bad_cpu: # show that the program requires a certain microarchitecture level. MOVQ $2, 0(SP) MOVQ $bad_cpu_msg\u003c\u003e(SB), AX MOVQ AX, 8(SP) MOVQ $84, 16(SP) CALL runtimeÂ·write(SB) MOVQ $1, 0(SP) CALL runtimeÂ·exit(SB) CALL runtimeÂ·abort(SB) RET # Prevent dead-code elimination of debugCallV2, which is # intended to be called by debuggers. MOVQ $runtimeÂ·debugCallV2\u003cABIInternal\u003e(SB), AX RET å…¶ä»–å†…å®¹ argcå’Œargv åœ¨è®¡ç®—æœºç¼–ç¨‹ä¸­ï¼Œé€šå¸¸ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°æ¥å‘ç¨‹åºä¼ é€’é¢å¤–çš„ä¿¡æ¯ã€‚ Cè¯­è¨€ä¸­çš„mainå‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯argcå’Œargvã€‚ å…¶ä¸­argcè¡¨ç¤ºå‘½ä»¤è¡Œå‚æ•°çš„æ•°é‡ï¼Œè€Œargvæ˜¯ä¸€ä¸ªæŒ‡å‘å‚æ•°å­—ç¬¦ä¸²æ•°ç»„çš„æŒ‡é’ˆï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ éƒ½åŒ…å«ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°ã€‚ å¦‚æœä½ åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š$ my_program arg1 arg2 arg3 åˆ™argcçš„å€¼å°†æ˜¯4ï¼Œå…¶ä¸­åŒ…æ‹¬ç¨‹åºåmy_programå’Œ3ä¸ªå‚æ•°arg1ã€arg2å’Œarg3ã€‚è€ŒargvæŒ‡å‘ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œå…¶å†…å®¹å¦‚ä¸‹ï¼š argv[0] = \"my_program\" argv[1] = \"arg1\" argv[2] = \"arg2\" argv[3] = \"arg3\" æ¯”å¦‚åœ¨Goè¯­è¨€ä¸­ï¼Œargcå’Œargvä½¿ç”¨ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 package main import ( \"fmt\" \"os\" ) func main() { args := os.Args // []string fmt.Printf(\"Pathï¼š%s\\n\", args[0]) fmt.Printf(\"Argsï¼š%#v\\n\", args[1:]) } å½“æˆ‘ä»¬æ‰§è¡Œgo runå‘½ä»¤è¿è¡Œä¸Šé¢çš„ç¨‹åºå¹¶ä¼ é€’ä¸€äº›å‚æ•°æ—¶ï¼Œå°†ä¼šå¾—åˆ°ç±»ä¼¼ä»¥ä¸‹çš„è¾“å‡ºï¼š [root@localhost hello1]# go run tt12.go foo bar baz js Pathï¼š/tmp/go-build1239766326/b001/exe/tt12 Argsï¼š[]string{\"foo\", \"bar\", \"baz\", \"js\"} ",
  "wordCount" : "7931",
  "inLanguage": "zh",
  "image": "https://helium.github.io/favicon-32x32.png","datePublished": "2024-07-27T00:00:00Z",
  "dateModified": "2024-07-27T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://helium.github.io/posts/golang/goroutine/flow/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://helium.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://helium.github.io/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://helium.github.io/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://helium.github.io/" title="ä¸»é¡µ">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/posts" title="æ–‡ç« ">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/archives" title="æ—¶é—´è½´">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/tags/" title="æ ‡ç­¾">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/search/" title="æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/support" title="æ‰“èµ">
                    <span>ğŸ«¶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://helium.github.io/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://helium.github.io/posts/">Article</a>&nbsp;Â»&nbsp;<a href="https://helium.github.io/posts/golang/">Golang</a>&nbsp;Â»&nbsp;<a href="https://helium.github.io/posts/golang/goroutine/">ç¬¬12ç«  Goroutine</a></div>
    <h1 class="post-title entry-hint-parent">
      Go æ‰§è¡Œæµç¨‹
    </h1>
    <div class="post-description">
      ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬
    </div>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2024-07-27</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2024-07-27</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>7931å­—</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>38åˆ†é’Ÿ</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &nbsp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://helium.github.io/tags/golang/" target="_blank" rel="noopener">Golang</a>
            <a href="https://helium.github.io/tags/goroutine/" target="_blank" rel="noopener">Goroutine</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &nbsp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e7%a8%8b%e5%ba%8f%e5%8a%a0%e8%bd%bd%e9%98%b6%e6%ae%b5" aria-label="ç¨‹åºåŠ è½½é˜¶æ®µ">ç¨‹åºåŠ è½½é˜¶æ®µ</a></li>
                    <li>
                        <a href="#%e7%a8%8b%e5%ba%8f%e5%85%a5%e5%8f%a3" aria-label="ç¨‹åºå…¥å£">ç¨‹åºå…¥å£</a></li>
                    <li>
                        <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96g0" aria-label="åˆå§‹åŒ–g0">åˆå§‹åŒ–<code>g0</code></a></li>
                    <li>
                        <a href="#cpu-%e7%9b%b8%e5%85%b3" aria-label="CPU ç›¸å…³">CPU ç›¸å…³</a></li>
                    <li>
                        <a href="#%e4%b8%bb%e7%ba%bf%e7%a8%8b%e4%b8%8em0%e7%bb%91%e5%ae%9a" aria-label="ä¸»çº¿ç¨‹ä¸m0ç»‘å®š">ä¸»çº¿ç¨‹ä¸<code>m0</code>ç»‘å®š</a><ul>
                            
                    <li>
                        <a href="#%e8%ae%be%e7%bd%aetls" aria-label="è®¾ç½®tls">è®¾ç½®tls</a></li>
                    <li>
                        <a href="#m0%e7%bb%91%e5%ae%9a" aria-label="m0ç»‘å®š"><code>m0</code>ç»‘å®š</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%a3%80%e6%9f%a5" aria-label="æ£€æŸ¥">æ£€æŸ¥</a></li>
                    <li>
                        <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96m0" aria-label="åˆå§‹åŒ–m0">åˆå§‹åŒ–<code>m0</code></a><ul>
                            
                    <li>
                        <a href="#argssb-" aria-label="args(SB) "><code>args(SB) </code></a><ul>
                            
                    <li>
                        <a href="#sysargs" aria-label="sysargs()">sysargs()</a></li>
                    <li>
                        <a href="#argv_index" aria-label="argv_index()">argv_index()</a></li>
                    <li>
                        <a href="#sysauxv" aria-label="sysauxv()">sysauxv()</a></li></ul>
                    </li>
                    <li>
                        <a href="#osinitsb" aria-label="osinit(SB)">osinit(SB)</a><ul>
                            
                    <li>
                        <a href="#%e8%8e%b7%e5%8f%96cpu%e6%a0%b8%e6%95%b0" aria-label="è·å–cpuæ ¸æ•°">è·å–cpuæ ¸æ•°</a></li>
                    <li>
                        <a href="#%e8%8e%b7%e5%8f%96%e7%89%a9%e7%90%86%e5%86%85%e5%ad%98%e9%a1%b5%e5%a4%a7%e5%b0%8f" aria-label="è·å–ç‰©ç†å†…å­˜é¡µå¤§å°">è·å–ç‰©ç†å†…å­˜é¡µå¤§å°</a></li></ul>
                    </li>
                    <li>
                        <a href="#schedinitsb" aria-label="schedinit(SB)">schedinit(SB)</a><ul>
                            
                    <li>
                        <a href="#mcommoninit" aria-label="mcommoninit()">mcommoninit()</a></li>
                    <li>
                        <a href="#goargs" aria-label="goargs()">goargs()</a></li>
                    <li>
                        <a href="#goenvs" aria-label="goenvs()">goenvs()</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96allp" aria-label="åˆå§‹åŒ–allp">åˆå§‹åŒ–allp</a><ul>
                            
                    <li>
                        <a href="#procresize" aria-label="procresize()">procresize()</a></li>
                    <li>
                        <a href="#pinit" aria-label="p.init()">p.init()</a></li>
                    <li>
                        <a href="#acquirep" aria-label="acquirep()">acquirep()</a></li>
                    <li>
                        <a href="#wirep" aria-label="wirep()">wirep()</a></li>
                    <li>
                        <a href="#pdestroy" aria-label="p.destroy()">p.destroy()</a></li>
                    <li>
                        <a href="#pidleput" aria-label="pidleput()">pidleput()</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#main-goroutine" aria-label="main goroutine"><code>main goroutine</code></a></li>
                    <li>
                        <a href="#%e5%85%b6%e4%bb%96%e5%86%85%e5%ae%b9" aria-label="å…¶ä»–å†…å®¹">å…¶ä»–å†…å®¹</a><ul>
                            
                    <li>
                        <a href="#argc%e5%92%8cargv" aria-label="argcå’Œargv">argcå’Œargv</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><ol>
<li>ç¤ºä¾‹ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Hello World!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ç¨‹åºåŠ è½½é˜¶æ®µ">ç¨‹åºåŠ è½½é˜¶æ®µ<a hidden class="anchor" aria-hidden="true" href="#ç¨‹åºåŠ è½½é˜¶æ®µ">#</a></h2>
<ol>
<li>ç¨‹åºåœ¨è¢«æ“ä½œç³»ç»ŸåŠ è½½èµ·æ¥è¿è¡Œæ—¶éƒ½ä¼šä¾æ¬¡ç»è¿‡å¦‚ä¸‹é˜¶æ®µï¼š
<ol>
<li>ä»ç£ç›˜ä¸ŠæŠŠå¯æ‰§è¡Œç¨‹åºè¯»å…¥å†…å­˜ã€‚</li>
<li>åˆ›å»ºè¿›ç¨‹å’Œä¸»çº¿ç¨‹ã€‚</li>
<li>ä¸ºä¸»çº¿ç¨‹åˆ†é…æ ˆç©ºé—´ã€‚</li>
<li>æŠŠç”±ç”¨æˆ·åœ¨å‘½ä»¤è¡Œè¾“å…¥çš„å‚æ•°æ‹·è´åˆ°ä¸»çº¿ç¨‹çš„æ ˆã€‚</li>
<li>æŠŠä¸»çº¿ç¨‹æ”¾å…¥æ“ä½œç³»ç»Ÿçš„è¿è¡Œé˜Ÿåˆ—ç­‰å¾…è¢«è°ƒåº¦æ‰§è¡Œèµ·æ¥è¿è¡Œã€‚</li>
</ol>
</li>
<li>åœ¨ä¸»çº¿ç¨‹ç¬¬ä¸€æ¬¡è¢«è°ƒåº¦èµ·æ¥æ‰§è¡Œç¬¬ä¸€æ¡æŒ‡ä»¤ä¹‹å‰ï¼Œä¸»çº¿ç¨‹çš„å‡½æ•°æ ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<code>sp</code>æŒ‡å‘æ ˆé¡¶ã€‚</li>
</ol>
<p><img loading="lazy" src="../images/goroutine-001.png" alt=""  />
</p>
<ol start="3">
<li>ç›¸å…³æ¦‚å¿µï¼š
<ol>
<li><strong><code>rsp</code></strong>ï¼šæŒ‡å‘å½“å‰æ ˆçš„æ ˆé¡¶ï¼Œè¡¨ç¤ºå½“å‰æ ˆå·²ç»ç”¨åˆ°ä»€ä¹ˆä½ç½®ã€‚</li>
<li><strong><code>rbp</code></strong>ï¼šæŒ‡å‘å½“å‰æ ˆçš„æ ˆåº•ï¼Œè¡¨ç¤ºå½“å‰æ ˆçš„èµ·ç‚¹ä½ç½®ã€‚</li>
<li><strong><code>rip</code></strong>ï¼š<code>CPU</code>å³å°†æ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œæ§åˆ¶ç€ç¨‹åºçš„æµç¨‹ã€‚</li>
<li><strong><code>SB</code></strong>ï¼š<code>GO</code>æ±‡ç¼–ç›¸å…³çš„è™šæ‹Ÿå¯„å­˜å™¨ï¼Œä¿å­˜ç¨‹åºåœ°å€ç©ºé—´çš„èµ·å§‹åœ°å€ã€‚
<ul>
<li><code>SB</code>å¯„å­˜å™¨ä¿å­˜çš„æ˜¯å½“å‰å‡½æ•°åœ¨ä»£ç åŒºçš„èµ·å§‹ä½ç½®ã€‚</li>
<li>å‡ºç°åœ¨<code>GO</code>æ±‡ç¼–çš„å‡½æ•°å®šä¹‰ã€å‡½æ•°è°ƒç”¨ã€å…¨å±€å˜é‡å®šä¹‰ä»¥åŠå¯¹å…¶å¼•ç”¨ä¼šç”¨åˆ°è¿™ä¸ª<code>SB</code>è™šæ‹Ÿå¯„å­˜å™¨ã€‚</li>
</ul>
</li>
<li><strong><code>FP</code></strong>ï¼š<code>GO</code>æ±‡ç¼–ç›¸å…³çš„è™šæ‹Ÿå¯„å­˜å™¨ï¼Œä¸»è¦ç”¨æ¥å¼•ç”¨å‡½æ•°å‚æ•°ã€‚
<ul>
<li><code>Go</code>è¯­è¨€è§„å®šå‡½æ•°è°ƒç”¨æ—¶å‚æ•°éƒ½å¿…é¡»æ”¾åœ¨æ ˆä¸Šï¼Œæ¯”å¦‚è¢«è°ƒç”¨å‡½æ•°ä½¿ç”¨<code>first_arg+0(FP)</code>æ¥å¼•ç”¨è°ƒç”¨è€…ä¼ é€’è¿›æ¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ã€‚</li>
<li>ç”¨<code>second_arg+8(FP)</code>æ¥å¼•ç”¨ç¬¬äºŒä¸ªå‚æ•°ç­‰ã€‚è¿™é‡Œçš„<code>first_arg</code>å’Œ<code>second_arg</code>ä»…ä»…æ˜¯ä¸€ä¸ªå¸®åŠ©æˆ‘ä»¬é˜…è¯»æºä»£ç çš„ç¬¦å·ã€‚</li>
<li>å¯¹ç¼–è¯‘å™¨æ¥è¯´æ— å®é™…æ„ä¹‰ï¼Œ+0å’Œ+8è¡¨ç¤ºç›¸å¯¹äº<code>FP</code>å¯„å­˜å™¨çš„åç§»é‡ã€‚</li>
</ul>
</li>
<li><strong><code>$16-8</code></strong>ï¼šæ•°å­—16è¯´æ˜æ­¤å‡½æ•°çš„æ ˆå¸§å¤§å°ä¸º16å­—èŠ‚ï¼Œ8è¯´æ˜æ­¤å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ä¸€å…±éœ€è¦å ç”¨8å­—èŠ‚å†…å­˜ã€‚</li>
</ol>
</li>
</ol>
<h2 id="ç¨‹åºå…¥å£">ç¨‹åºå…¥å£<a hidden class="anchor" aria-hidden="true" href="#ç¨‹åºå…¥å£">#</a></h2>
<ol>
<li>ç¬¬ä¸€è¡Œä»£ç ï¼šå®šä¹‰äº†<code>_rt0_amd64_linux</code>è¿™ä¸ªç¬¦å·ï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„<code>CPU</code>æŒ‡ä»¤ã€‚
<ul>
<li><code>NOSPLIT</code>å‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦åœ¨è¿™ä¸ªå‡½æ•°ä¸­æ’å…¥æ£€æŸ¥æ ˆæ˜¯å¦æº¢å‡ºçš„ä»£ç ã€‚</li>
</ul>
</li>
<li>ç¬¬äºŒè¡Œçš„<code>JMP</code>æŒ‡ä»¤ï¼šæ‰æ˜¯ä¸»çº¿ç¨‹çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ã€‚
<ul>
<li>è¿™æ¡æŒ‡ä»¤ç®€å•çš„è·³è½¬åˆ°ï¼ˆç›¸å½“äº<code>go</code>è¯­è¨€æˆ–<code>c</code>ä¸­çš„<code>goto</code>å…³é”®å­—ï¼‰<code>_rt0_amd64</code> è¿™ä¸ªç¬¦å·å¤„ç»§ç»­æ‰§è¡Œã€‚</li>
</ul>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/rt0_linux_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">_rt0_amd64_linux</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="p">,</span><span class="no">$-8</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JMP</span> <span class="no">_rt0_amd64</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<ol>
<li>å‰ä¸¤è¡ŒæŒ‡ä»¤ï¼šæŠŠæ“ä½œç³»ç»Ÿå†…æ ¸ä¼ é€’è¿‡æ¥çš„å‚æ•°<code>argc</code>å’Œ<code>argv</code>æ•°ç»„çš„åœ°å€åˆ†åˆ«æ”¾åœ¨<code>DI</code>å’Œ<code>SI</code>å¯„å­˜å™¨ä¸­ã€‚
<ul>
<li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šã€<code>MOVQ 0(SP), DI</code>ã€‘æ‹·è´çš„æ˜¯<code>argc</code>çš„å€¼æ˜¯ä¸ª8å­—èŠ‚çš„å­˜å‚¨çš„æ˜¯å‚æ•°çš„ä¸ªæ•°ï¼Œæ˜¯ä¸ªæ•°å­—ã€‚</li>
<li>ã€<code>LEAQ 8(SP), SI</code>ã€‘åˆ™æ˜¯å–çš„<code>argv</code>çš„åœ°å€ï¼Œæ˜¯ä¸ªæŒ‡é’ˆ<code>*argv</code>ï¼Œä¹Ÿæ˜¯8å­—èŠ‚ã€‚</li>
</ul>
</li>
<li>ç¬¬ä¸‰è¡ŒæŒ‡ä»¤ï¼šè·³è½¬åˆ° <code>rt0_go</code> å»æ‰§è¡Œã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/asm_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1"># _rt0_amd64 is common startup code for most amd64 systems when using
</span></span></span><span class="line"><span class="cl"><span class="c1"># internal linking. This is the entry point for the program from the
</span></span></span><span class="line"><span class="cl"><span class="c1"># kernel for an ordinary -buildmode=exe program. The stack holds the
</span></span></span><span class="line"><span class="cl"><span class="c1"># number of arguments and the C-style argv.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">_rt0_amd64</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="p">,</span><span class="no">$-8</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DI</span>   <span class="c1"># DI = argc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å‡è®¾SPå­˜å‚¨å€¼ä¸º0x00ff00ï¼Œåˆ™SI=0x00ff08ï¼ŒæŒ‡å‘çš„æ˜¯ *argv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">LEAQ</span>    <span class="mi">8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">SI</span>   <span class="c1"># SI = 8(SP); *argv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JMP</span>	<span class="no">runtime</span><span class="err">Â·</span><span class="no">rt0_go</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<ol>
<li><code>rt0_go</code>å‡½æ•°å®Œæˆäº†<code>go</code>ç¨‹åºå¯åŠ¨æ—¶çš„æ‰€æœ‰åˆå§‹åŒ–å·¥ä½œã€‚</li>
<li>ç¬¬<code>4</code>æ¡æŒ‡ä»¤ï¼ˆ<code>ANDQ $~15, SP</code>ï¼‰ï¼š
<ul>
<li>ç”¨äºè°ƒæ•´æ ˆé¡¶å¯„å­˜å™¨çš„å€¼ä½¿å…¶æŒ‰16å­—èŠ‚å¯¹é½ï¼Œä¹Ÿå°±æ˜¯è®©æ ˆé¡¶å¯„å­˜å™¨<code>SP</code>æŒ‡å‘çš„å†…å­˜çš„åœ°å€ä¸º16çš„å€æ•°ã€‚</li>
<li><strong>ä¹‹æ‰€ä»¥è¦æŒ‰16å­—èŠ‚å¯¹é½ï¼Œæ˜¯å› ä¸ºCPUæœ‰ä¸€ç»„SSEæŒ‡ä»¤ï¼Œè¿™äº›æŒ‡ä»¤ä¸­å‡ºç°çš„å†…å­˜åœ°å€å¿…é¡»æ˜¯16çš„å€æ•°</strong>ã€‚</li>
</ul>
</li>
<li>æœ€åä¸¤æ¡æŒ‡ä»¤ï¼šæŠŠ<code>argc</code>å’Œ<code>argv</code>æ¬åˆ°æ–°çš„ä½ç½®ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/asm_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">rt0_go</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="err">|</span><span class="no">TOPFRAME</span><span class="p">,</span><span class="no">$0</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># copy arguments forward on an even stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># åœ¨å¶æ•°æ ˆä¸Šå‘å‰å¤åˆ¶å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># argcæ˜¯ä¸ª8å­—èŠ‚çš„æ•°å€¼ï¼Œå› æ­¤AXå­˜å‚¨çš„æ˜¯æ‹·è´çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># argvæ ¹æ®å‰é¢å¯çŸ¥ï¼Œè¿™é‡ŒBXå­˜å‚¨çš„æ˜¯argvçš„åœ°å€ï¼Œå› æ­¤åŸæ•°æ®è¿˜åœ¨8(SP)çš„ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">DI</span><span class="p">,</span> <span class="no">AX</span>      <span class="c1"># AX=argc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">SI</span><span class="p">,</span> <span class="no">BX</span>      <span class="c1"># BX=*argv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">SUBQ</span>    <span class="no">$</span><span class="p">(</span><span class="mi">5</span><span class="p">*</span><span class="mi">8</span><span class="p">),</span> <span class="no">SP</span>  <span class="c1"># 3args 2auto
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># $~15ï¼š0000_1111 -&gt; 1111_0000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ç»è¿‡ ANDQ è°ƒæ•´åï¼Œä¸€å®šæ˜¯å¤§äºç­‰äº40byte
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ANDQ</span>    <span class="no">$</span><span class="err">~</span><span class="mi">15</span><span class="p">,</span> <span class="no">SP</span>    <span class="c1"># è°ƒæ•´æ ˆé¡¶å¯„å­˜å™¨ä½¿å…¶æŒ‰16å­—èŠ‚å¯¹é½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="mi">24</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>  <span class="c1"># argcæ”¾åœ¨SP+24å­—èŠ‚å¤„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">BX</span><span class="p">,</span> <span class="mi">32</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>  <span class="c1"># argvæ”¾åœ¨SP+32å­—èŠ‚å¤„ï¼Œæ­¤æ—¶æ˜¯argvçš„åœ°å€ï¼Œ*argv
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/goroutine-002.png" alt=""  />
</p>
<ol start="5">
<li>æ€»ç»“ï¼šè¿™éƒ¨åˆ†ä»£ç å®Œæˆäº†<code>argc</code>å’Œ<code>argv</code>çš„æ‹·è´ï¼ˆ<code>argv</code>æ˜¯æ‹·è´äº†åœ°å€ï¼Œ<code>argv</code>åˆ™æ˜¯æ‹·è´äº†å‰¯æœ¬å€¼ï¼‰ï¼Œæ ˆæŒ‰ç…§16å­—èŠ‚å¯¹é½äº†ã€‚</li>
</ol>
<h2 id="åˆå§‹åŒ–g0">åˆå§‹åŒ–<code>g0</code><a hidden class="anchor" aria-hidden="true" href="#åˆå§‹åŒ–g0">#</a></h2>
<ol>
<li><code>g0</code>çš„ä¸»è¦ä½œç”¨æ˜¯æä¾›ä¸€ä¸ªæ ˆä¾›<code>runtime</code>ä»£ç æ‰§è¡Œï¼Œå› æ­¤è¿™é‡Œä¸»è¦å¯¹<code>g0</code>çš„å‡ ä¸ªä¸æ ˆæœ‰å…³çš„æˆå‘˜è¿›è¡Œäº†åˆå§‹åŒ–ã€‚</li>
<li>ä»è¿™é‡Œå¯ä»¥çœ‹å‡º<code>g0</code>çš„æ ˆå¤§çº¦æœ‰<code>64KB</code>ï¼Œåœ°å€èŒƒå›´ä¸º<code>SP - 64*1024 + 104 ï½ SP</code>ã€‚</li>
<li>æ³¨æ„ï¼šè™½ç„¶è¿™é‡Œç»™<code>g0</code>æŒ‡å®šäº†å¤§æ¦‚<code>64KB</code>å¤§å°çš„æ ˆç©ºé—´å¤§å°ï¼Œä½†æ˜¯<code>SP</code>å¯„å­˜å™¨çš„å€¼å´æ²¡æœ‰å‡å»<code>64KB</code>å¤§å°ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/asm_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">    <span class="c1"># create istack out of the given (operating system) stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># _cgo_init may update stackguard.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä»ç»™å®šçš„æ“ä½œç³»ç»Ÿæ ˆä¸­åˆ›å»º istack (è‡ªå·±çš„æ ˆ)ã€‚_cgo_init å¯èƒ½ä¼šæ›´æ–° stackguardã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä¸‹é¢è¿™æ®µä»£ç ä»ç³»ç»Ÿçº¿ç¨‹çš„æ ˆç©ºåˆ†å‡ºä¸€éƒ¨åˆ†å½“åšg0çš„æ ˆï¼Œç„¶ååˆå§‹åŒ–g0çš„æ ˆä¿¡æ¯å’Œstackgard
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$runtime</span><span class="err">Â·</span><span class="no">g0</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">DI</span>         <span class="c1"># DI = &amp;g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">LEAQ</span>    <span class="p">(-</span><span class="mi">64</span><span class="p">*</span><span class="mi">1024</span><span class="err">+</span><span class="mi">104</span><span class="p">)(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BX</span>      <span class="c1"># BX = SP - 64*1024 + 104
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># g0.stackguard0å’Œg0.stackguard1ç”¨äºæ ˆæº¢å‡ºæ£€æŸ¥ï¼Œå®ç°æ ˆçš„è‡ªåŠ¨ä¼¸ç¼©ï¼ŒæŠ¢å è°ƒåº¦ä¹Ÿä¼šç”¨åˆ°stackguard0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">BX</span><span class="p">,</span> <span class="no">g_stackguard0</span><span class="p">(</span><span class="no">DI</span><span class="p">)</span>       <span class="c1"># g0.stackguard0 = SP - 64*1024 + 104
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">BX</span><span class="p">,</span> <span class="no">g_stackguard1</span><span class="p">(</span><span class="no">DI</span><span class="p">)</span>       <span class="c1"># g0.stackguard1 = SP - 64*1024 + 104
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># g0.stack ä¸»è¦ç”¨æ¥è®°å½•goroutineæ‰€ä½¿ç”¨çš„æ ˆï¼Œ[lo, hi)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># g0.stack.lo æ ˆé¡¶ï¼ŒæŒ‡å‘å†…å­˜ä½åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># g0.stack.hi æ ˆåº•ï¼ŒæŒ‡å‘å†…å­˜é«˜åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">BX</span><span class="p">,</span> <span class="p">(</span><span class="no">g_stack</span><span class="err">+</span><span class="no">stack_lo</span><span class="p">)(</span><span class="no">DI</span><span class="p">)</span>  <span class="c1"># g0.stack.lo = SP - 64*1024 + 104  lo
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">SP</span><span class="p">,</span> <span class="p">(</span><span class="no">g_stack</span><span class="err">+</span><span class="no">stack_hi</span><span class="p">)(</span><span class="no">DI</span><span class="p">)</span>  <span class="c1"># g0.stack.hi = SP                  hi
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>è¿è¡Œå®Œä¸Šé¢è¿™å‡ è¡ŒæŒ‡ä»¤å<code>g0</code>ä¸æ ˆä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li>
</ol>
<p><img loading="lazy" src="../images/goroutine-003.png" alt=""  />
</p>
<ol start="6">
<li>æ€»ç»“ï¼šè¿™éƒ¨åˆ†ä»£ç ç»™<code>g0</code>é¢„ç•™äº†å¤§çº¦<code>64KB</code>çš„å°çš„æ ˆç©ºé—´ï¼ˆæ³¨æ„è¿™é‡Œçš„<code>SP</code>å¯„å­˜å™¨å€¼å¹¶æ²¡æœ‰è¢«ä¿®æ”¹ï¼‰ï¼Œè®¾ç½®äº†<code>stack</code>ã€<code>stackguard0</code>ã€<code>stackguard1</code>å­—æ®µï¼Œè¿™äº›å­—æ®µéƒ½æ˜¯ä¸<code>g0</code>æ ˆç›¸å…³çš„ã€‚</li>
</ol>
<h2 id="cpu-ç›¸å…³">CPU ç›¸å…³<a hidden class="anchor" aria-hidden="true" href="#cpu-ç›¸å…³">#</a></h2>
<ol>
<li>è°ƒç”¨<code>CPU</code>ç›¸å…³æŒ‡ä»¤ï¼Œå°è¯•è·å–<code>CPU</code>ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚<code>CPU</code>çš„å‚å•†ã€å¤„ç†å™¨å‹å·ç­‰ï¼Œå¦‚æœè·å–æˆåŠŸåˆ™è®°å½•åœ¨å…¨å±€å˜é‡ä¸­ã€‚</li>
<li>åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨åˆå§‹åŒ–<code>CGO</code>ç›¸å…³å‡½æ•°ï¼ˆç¨‹åºä¸­æœ‰ç›¸å…³<code>C</code>ä»£ç åˆ™ä¼šè°ƒç”¨ï¼Œæ²¡æœ‰åˆ™ä¸ä¼šè°ƒç”¨ï¼‰ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/asm_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">    <span class="c1"># find out information about the processor we&#39;re on
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æ‰¾å‡ºæˆ‘ä»¬æ­£åœ¨ä½¿ç”¨çš„å¤„ç†å™¨ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># EAXå¯„å­˜å™¨è®¾ç½®ä¸ºç¼–å·0ï¼Œå› ä¸ºCPUIDæŒ‡ä»¤ä¼šä½¿ç”¨åˆ°è¯¥å¯„å­˜å™¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVL</span>    <span class="no">$0</span><span class="p">,</span> <span class="no">AX</span>  <span class="c1"># EAX = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># CPUID æ˜¯ä¸€ç§ç”¨äºæŸ¥è¯¢å¤„ç†å™¨ä¿¡æ¯çš„æŒ‡ä»¤ï¼Œå®ƒå¯ä»¥è¿”å›å¤„ç†å™¨æ”¯æŒçš„åŠŸèƒ½åˆ—è¡¨å’Œç‰¹æ€§ä¿¡æ¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># CPUID æŒ‡ä»¤éœ€è¦å°†æŸ¥è¯¢ä¿¡æ¯çš„ç¼–å·å­˜å‚¨åœ¨ EAX å¯„å­˜å™¨ä¸­ï¼Œç„¶åæ‰§è¡Œ CPUID æŒ‡ä»¤ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å¤„ç†å™¨å°†è¿”å›ç»“æœå­˜å‚¨åœ¨ EAXã€EBXã€ECX å’Œ EDX å››ä¸ªå¯„å­˜å™¨ä¸­ï¼Œå…·ä½“çš„è¿”å›å€¼æ ¼å¼å’Œå«ä¹‰å–å†³äºæŸ¥è¯¢ä¿¡æ¯çš„ç¼–å·ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># EAX æ˜¯ 0 æ—¶ï¼šè¿”å›æœ€å¤§æ”¯æŒçš„åŠŸèƒ½ç¼–å·ï¼ˆåŒ…æ‹¬è¯¥ç¼–å·ï¼‰å’Œå‚å•† IDï¼ˆ12 ä¸ªå­—ç¬¦ï¼‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   1. EAXï¼šè¿”å›æœ€å¤§æ”¯æŒçš„åŠŸèƒ½ç¼–å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   2. EBXï¼šå¦‚æœæ˜¯ Inter è¿”å› &#34;Genu&#34;ã€‚å¦‚æœæ˜¯ AMD è¿”å› &#34;Auth&#34; ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   3. ECXï¼šå¦‚æœæ˜¯ Inter è¿”å› &#34;ntel&#34;ã€‚å¦‚æœæ˜¯ AMD è¿”å› &#34;enti&#34; ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   4. EDXï¼šå¦‚æœæ˜¯ Inter è¿”å› &#34;ntel&#34;ã€‚å¦‚æœæ˜¯ AMD è¿”å› &#34;cAMD&#34; ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   Genuntelntelæ˜¯è‹±ç‰¹å‚å•†åç§°ã€‚AuthenticAMDè¡¨ç¤ºæ˜¯AMDå‚å•†åç§°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#  EAX æ˜¯ 1 æ—¶ï¼šè¿”å›å¤„ç†å™¨çš„åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¤„ç†å™¨å‹å·ã€ç³»åˆ—ã€æ‰©å±•å‹å·ã€æ‰©å±•ç³»åˆ—ç­‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   1. EAX çš„ä½0-3å°†åŒ…å«å¤„ç†å™¨ç±»å‹ç¼–ç ï¼Œä½4-7å°†åŒ…å«å¤„ç†å™¨å®¶æ—ç¼–ç ï¼Œä½8-11å°†åŒ…å«å¤„ç†å™¨å‹å·ç¼–ç ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#      ä½12-13å°†åŒ…å«å¤„ç†å™¨æ‰©å±•å‹å·ç¼–ç ï¼Œä½14-15å°†åŒ…å«å¤„ç†å™¨æ‰©å±•å®¶æ—ç¼–ç ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   2. EBXã€ECXã€EDX ä¸‰ä¸ªå¯„å­˜å™¨å°†åŒ…å«å…¶ä»–å¤„ç†å™¨ç‰¹æ€§çš„ä¿¡æ¯ã€‚æ­¤å¤„æˆ‘ä»¬ä¸å…³å¿ƒè¿™äº›æ•°æ®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æŸ¥è¯¢ CPU æ”¯æŒçš„åŠŸèƒ½åˆ—è¡¨ï¼ˆç¼–å· 0ï¼‰ï¼š0ã€1ã€2ã€4ã€0x80000000ã€0x80000001
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#  1. EAX çš„å€¼ä¸º 0x0ï¼šè¿”å›æœ€å¤§æ”¯æŒçš„åŠŸèƒ½ç¼–å·ï¼ˆåŒ…æ‹¬è¯¥ç¼–å·ï¼‰å’Œå‚å•† IDï¼ˆ12 ä¸ªå­—ç¬¦ï¼‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#  2. EAX çš„å€¼ä¸º 0x1ï¼šè¿”å›å¤„ç†å™¨çš„åŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¤„ç†å™¨å‹å·ã€ç³»åˆ—ã€æ‰©å±•å‹å·ã€æ‰©å±•ç³»åˆ—ç­‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#  3. EAX çš„å€¼ä¸º 0x80000000hï¼šè¿”å›æœ€å¤§æ”¯æŒçš„æ‰©å±•åŠŸèƒ½ç¼–å·å’Œå‚å•† IDï¼ˆ12 ä¸ªå­—ç¬¦ï¼‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#  4. EAX çš„å€¼ä¸º 0x80000001hï¼šè¿”å›å¤„ç†å™¨çš„æ‰©å±•ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ‰©å±•ç‰¹æ€§ã€è™šæ‹ŸåŒ–æ”¯æŒç­‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CPUID</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CMPL</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">$0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JE</span>  <span class="no">nocpuinfo</span> <span class="c1"># AX == 0ï¼Œæ²¡æœ‰CPUä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ä»¥ä¸‹åˆ¤æ–­å½“å‰å¤„ç†å™¨æ˜¯å¦æ˜¯ GenuineIntel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># BX != &#34;Genu&#34;; JNE å°±ä¼šè·³è½¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPL</span>    <span class="no">BX</span><span class="p">,</span> <span class="no">$0x756E6547</span>  <span class="c1"># &#34;Genu&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JNE</span>	<span class="no">notintel</span> <span class="c1"># ä¸æ˜¯è‹±ç‰¹å¤„ç†å™¨æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># BX != &#34;ineI&#34;; JNE å°±ä¼šè·³è½¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPL</span>    <span class="no">DX</span><span class="p">,</span> <span class="no">$0x49656E69</span>  <span class="c1"># &#34;ineI&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JNE</span>	<span class="no">notintel</span> <span class="c1"># ä¸æ˜¯è‹±ç‰¹å¤„ç†å™¨æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># BX != &#34;ntel&#34;; JNE å°±ä¼šè·³è½¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPL</span>    <span class="no">CX</span><span class="p">,</span> <span class="no">$0x6C65746E</span>  <span class="c1"># &#34;ntel&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JNE</span>	<span class="no">notintel</span> <span class="c1"># ä¸æ˜¯è‹±ç‰¹å¤„ç†å™¨æ—¶ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å°†runtimeçš„å…¨å±€å˜é‡ isIntel è®¾ç½®ä¸º 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è¯¥å˜é‡åœ¨ runtime/runtime2.go å…¨å±€å˜é‡ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è¡¨ç¤ºå½“å‰å¤„ç†å™¨æ˜¯ GenuineIntel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVB</span>    <span class="no">$1</span><span class="p">,</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">isIntel</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">notintel:</span> <span class="c1"># ä¸æ˜¯intel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># Load EAX=1 cpuid flags
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVL</span>    <span class="no">$1</span><span class="p">,</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CPUID</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å°†runtimeçš„å…¨å±€å˜é‡ processorVersionInfo è®¾ç½®ä¸º AX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># AXå¯„å­˜å™¨å­˜å‚¨çš„æ˜¯å¤„ç†å™¨çš„æ ‡è¯†ï¼Œå¯ä»¥è¯†åˆ«ç‰¹å®šçš„å¤„ç†å™¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ç”±äºåˆ¤æ–­CPUæ˜¯å¦æ”¯æŒç›¸å…³çš„æŒ‡ä»¤é›†ï¼Œæ¯”å¦‚AVXæŒ‡ä»¤é›†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVL</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">processorVersionInfo</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">nocpuinfo:</span> <span class="c1"># æ²¡æœ‰cpuä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># if there is an _cgo_init, call it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å¦‚æœå­˜åœ¨_cgo_initï¼Œåˆ™è°ƒç”¨å®ƒã€‚ä»£ç ä¸­å­˜åœ¨è°ƒç”¨Cç›¸å…³å‡½æ•°æ—¶è¿™é‡ŒAXä¼šæœ‰å€¼å¹¶åˆ¤æ–­æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># cgo_initå‡½æ•°æ˜¯ä¸€ä¸ªå†…éƒ¨å‡½æ•°ï¼Œç”¨äºåˆå§‹åŒ–Cè¯­è¨€ä»£ç å’ŒGoä»£ç ä¹‹é—´çš„æ¥å£ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># cgo_initå‡½æ•°æ˜¯Goè¿è¡Œæ—¶ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒåœ¨ç¨‹åºå¯åŠ¨æ—¶è¢«è‡ªåŠ¨è°ƒç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å®ƒä¼šåˆå§‹åŒ–cgoç›¸å…³çš„å…¨å±€å˜é‡ï¼Œè®¾ç½®cgoçš„ä¿¡å·å¤„ç†å™¨ï¼Œå¹¶å°†Cè¯­è¨€ä»£ç ä¸­çš„å‡½æ•°æŒ‡é’ˆè½¬æ¢ä¸ºGoè¯­è¨€ä¸­çš„å‡½æ•°ç±»å‹ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä»¥ä¾¿èƒ½å¤Ÿåœ¨Goè¯­è¨€ä¸­è°ƒç”¨å®ƒä»¬ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä½¿ç”¨ CGO çš„æƒ…å†µä¸‹ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   1. Goä¼šåˆ›å»ºä¸€ä¸ªCè¯­è¨€çš„çº¿ç¨‹ï¼Œå¹¶ä½¿ç”¨çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆThread-Local Storageï¼ŒTLSï¼‰æ¥å­˜å‚¨Cè¯­è¨€å‡½æ•°æ‰€éœ€è¦çš„æ•°æ®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   2. å½“ä½¿ç”¨cgoè°ƒç”¨Cè¯­è¨€å‡½æ•°æ—¶ï¼Œcgoä¼šè‡ªåŠ¨åˆå§‹åŒ–è¿™ä¸ªçº¿ç¨‹çš„TLSã€‚è¿™ä¸ªåˆå§‹åŒ–æ˜¯åœ¨_cgo_initå‡½æ•°ä¸­å®Œæˆçš„ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   è¿™ä¸ªå‡½æ•°æ˜¯ç”±Goç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">_cgo_init</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å°†å¯„å­˜å™¨ AX ä¸­çš„å€¼ä¸è‡ªå·±è¿›è¡ŒæŒ‰ä½é€»è¾‘ä¸è¿ç®—ï¼Œå¹¶æ›´æ–°æ ‡å¿—å¯„å­˜å™¨çš„å€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å¦‚æœå…¨éƒ¨ä¸º 1ï¼Œé‚£ä¹ˆç»“æœå°±æ˜¯éé›¶å€¼ï¼Œå¦åˆ™å°±æ˜¯é›¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è¿™æ¡æŒ‡ä»¤çš„ä½œç”¨å°±æ˜¯åˆ¤æ–­ AX çš„å€¼æ˜¯å¦ä¸ºé›¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">TESTQ</span>   <span class="no">AX</span><span class="p">,</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è¿™æ¡æŒ‡ä»¤æ˜¯ä¸€ä¸ªæ¡ä»¶è·³è½¬æŒ‡ä»¤ï¼Œå®ƒä¼šæ ¹æ®ä¸Šä¸€æ¡æŒ‡ä»¤æ›´æ–°çš„æ ‡å¿—å¯„å­˜å™¨çš„å€¼æ¥åˆ¤æ–­æ˜¯å¦è·³è½¬åˆ°ç›®æ ‡æ ‡ç­¾ needtlsã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># JZ æ˜¯â€œJump if Zeroâ€çš„ç¼©å†™ï¼Œæ„æ€æ˜¯å¦‚æœä¸Šä¸€æ¡æŒ‡ä»¤çš„ã€ç»“æœä¸ºé›¶ã€‘ï¼Œåˆ™è·³è½¬åˆ°ç›®æ ‡æ ‡ç­¾ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è·³è½¬è¿™é‡Œè¡¨ç¤ºä¿®æ”¹å» TLS è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JZ</span>	<span class="no">needtls</span> <span class="c1"># æ²¡æœ‰ _cgo_init å‡½æ•°æ—¶è·³è½¬åˆ° needtls
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># arg 1: g0, already in DI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å‚æ•°1ï¼šg0, å·²ç»åœ¨ DI ä¸­ï¼Œå‰é¢åˆå§‹åŒ–g0æ—¶æ”¾å…¥DIä¸­çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å‚æ•°2ï¼šsetg_gcc æ”¾å…¥ SI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$setg_gcc</span><span class="err">&lt;&gt;</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">SI</span> <span class="c1"># arg 2: setg_gcc
</span></span></span><span class="line"><span class="cl"><span class="c1">#ifdef GOOS_android	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$runtime</span><span class="err">Â·</span><span class="no">tls_g</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">DX</span>  <span class="c1"># arg 3: &amp;tls_g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># arg 4: TLS base, stored in slot 0 (Android&#39;s TLS_SLOT_SELF).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># Compensate for tls_g (+16).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="p">-</span><span class="mi">16</span><span class="p">(</span><span class="no">TLS</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"><span class="c1">#else
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å‚æ•°3,4ï¼šéƒ½ä¸º0ï¼Œä½¿ç”¨å¹³å°çš„TLSæ—¶ä¸ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$0</span><span class="p">,</span> <span class="no">DX</span>	<span class="c1"># arg 3, 4: not used when using platform&#39;s TLS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$0</span><span class="p">,</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif
</span></span></span><span class="line"><span class="cl"><span class="c1">#ifdef GOOS_windows 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># Adjust for the Win64 calling convention.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">CX</span><span class="p">,</span> <span class="no">R9</span> <span class="c1"># arg 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">DX</span><span class="p">,</span> <span class="no">R8</span> <span class="c1"># arg 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">SI</span><span class="p">,</span> <span class="no">DX</span> <span class="c1"># arg 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">DI</span><span class="p">,</span> <span class="no">CX</span> <span class="c1"># arg 1
</span></span></span><span class="line"><span class="cl"><span class="c1">#endif
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># DIã€SIã€DXã€CXå‚æ•°å·²å‡†å¤‡å¥½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># DI = &amp;g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># SI = setg_gcc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># DX = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># CX = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># AX=_cgo_init; è°ƒç”¨ _cgo_init å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">AX</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># update stackguard after _cgo_init
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># åœ¨ _cgo_init åæ›´æ–° stackguardï¼Œå› ä¸ºæ›´æ–°äº†stack.loçš„å€¼äº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$runtime</span><span class="err">Â·</span><span class="no">g0</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">CX</span>     <span class="c1"># CX = &amp;g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="p">(</span><span class="no">g_stack</span><span class="err">+</span><span class="no">stack_lo</span><span class="p">)(</span><span class="no">CX</span><span class="p">),</span> <span class="no">AX</span> <span class="c1"># AX = g0.stack.lo; lo = SP + 8MB - 4KB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># _StackGuard æ˜¯ 928byte
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ADDQ</span>    <span class="no">$const__StackGuard</span><span class="p">,</span> <span class="no">AX</span> <span class="c1"># AX = AX + _StackGuard
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># g0.stackguard0 = g0.stack.lo + _StackGuard
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># g0.stack.lo = SP + 8MB - 4KB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># stackguard0 ç”¨äº runtime æ ˆæº¢å‡ºåˆ¤æ–­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">g_stackguard0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># g0.stackguard1 = g0.stack.lo + _StackGuard
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># stackguard1 è¢« g0 å’Œ gsignal ä¸­çš„Cä»£ç ä½¿ç”¨ã€‚ç”¨äºæ ˆæº¢å‡ºåˆ¤æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">g_stackguard1</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## è¿™é‡Œæ˜¯ ifndefï¼Œä¸æ˜¯windowsåˆ™JMP okä¸éœ€è¦å»TLS
</span></span></span><span class="line"><span class="cl"><span class="c1">## è¿™ç§æƒ…å†µå‘ç”Ÿåœ¨ _cgo_init å‡½æ•°è¢«è°ƒç”¨æ—¶å€™
</span></span></span><span class="line"><span class="cl"><span class="c1">#
</span></span></span><span class="line"><span class="cl"><span class="c1">#ifndef GOOS_windows
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JMP</span> <span class="no">ok</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">needtls:</span> <span class="c1">## éœ€è¦TLSçš„æƒ…å†µåˆ¤æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1">#ifdef GOOS_plan9
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># skip TLS setup on Plan 9
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JMP</span> <span class="no">ok</span> <span class="c1">## è·³è¿‡TLSè®¾ç½®ï¼Œä¸è¦æ‰‹åŠ¨è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1">#endif
</span></span></span><span class="line"><span class="cl"><span class="c1">#ifdef GOOS_solaris 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># skip TLS setup on Solaris
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JMP</span> <span class="no">ok</span> <span class="c1">## è·³è¿‡TLSè®¾ç½®ï¼Œä¸è¦æ‰‹åŠ¨è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1">#endif
</span></span></span><span class="line"><span class="cl"><span class="c1">#ifdef GOOS_illumos 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># skip TLS setup on illumos
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JMP</span> <span class="no">ok</span> <span class="c1">## è·³è¿‡TLSè®¾ç½®ï¼Œä¸è¦æ‰‹åŠ¨è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1">#endif
</span></span></span><span class="line"><span class="cl"><span class="c1">#ifdef GOOS_darwin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># skip TLS setup on Darwin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JMP</span> <span class="no">ok</span> <span class="c1">## è·³è¿‡TLSè®¾ç½®ï¼Œä¸è¦æ‰‹åŠ¨è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1">#endif
</span></span></span><span class="line"><span class="cl"><span class="c1">#ifdef GOOS_openbsd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># skip TLS setup on OpenBSD
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JMP</span> <span class="no">ok</span> <span class="c1">## è·³è¿‡TLSè®¾ç½®ï¼Œä¸è¦æ‰‹åŠ¨è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1">#endif
</span></span></span></code></pre></td></tr></table>
</div>
</div>

<p><details >
  <summary markdown="span">cgoåˆå§‹åŒ–</summary>
  <blockquote>
<ol>
<li>åˆå§‹åŒ– <code>C</code> è¯­è¨€ä»£ç å’Œ <code>Go</code> ä»£ç ä¹‹é—´çš„æ¥å£ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>G *g</code>ï¼š&amp;runtime.g0ã€‚</li>
<li><code>void (*setg)(void*)</code>ï¼šsetg_gccå‡½æ•°ã€‚</li>
<li><code>void **tlsg</code>ï¼šNULLã€‚</li>
<li><code>void **tlsbase</code>ï¼šNULLã€‚</li>
</ul>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/cgo/gcc_linux_amd64.c</code>ã€‚</li>
<li>è¯¥å‡½æ•°åªæ˜¯è®¾ç½®äº†g0æ ˆçš„<code>stack.lo = SP - 8MB + 4KB</code>ï¼Œå¹¶æ²¡æœ‰åˆ›å»ºæ–°çš„çº¿ç¨‹ã€‚</li>
<li>è¿™æ®µä»£ç æ‰§è¡Œäº†ä»¥ä¸‹é‡è¦ä»»åŠ¡ï¼š
<ol>
<li>çº¿ç¨‹æ ˆçš„åˆå§‹åŒ–å’Œè®¾ç½®ï¼š
<ul>
<li>Goè¿è¡Œæ—¶ä½¿ç”¨goroutinesæ¥å¹¶å‘æ‰§è¡Œä»£ç ï¼Œæ¯ä¸ªgoroutineæœ‰è‡ªå·±çš„æ ˆã€‚</li>
<li>å½“ä½¿ç”¨cgoæ—¶ï¼ŒGoè¿è¡Œæ—¶éœ€è¦ä¸Cä»£ç çš„çº¿ç¨‹æ ˆè¿›è¡Œäº¤äº’ã€‚</li>
<li>è¿™æ®µä»£ç ç¡®ä¿äº†Cçº¿ç¨‹çš„æ ˆä¸Goè¿è¡Œæ—¶çš„æ ˆè®¾ç½®æ˜¯ä¸€è‡´çš„ã€‚</li>
</ul>
</li>
<li>æ ˆè¾¹ç•Œè®¾ç½®ï¼š
<ul>
<li>è®¾ç½®stackloå­—æ®µæ˜¯ä¸ºäº†ç¡®å®šgoroutineæ ˆçš„åº•éƒ¨ä½ç½®ã€‚</li>
<li>åœ¨Goä¸­ï¼Œæ¯ä¸ªgoroutineçš„æ ˆéƒ½æœ‰ä¸€ä¸ªåº•éƒ¨å’Œé¡¶éƒ¨ï¼Œstackloå’Œstackhiåˆ†åˆ«ä»£è¡¨æ ˆçš„åº•éƒ¨å’Œé¡¶éƒ¨åœ°å€ã€‚</li>
</ul>
</li>
</ol>
</li>
<li>ä»¥ä¸‹æ˜¯ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾ç½®çš„åŸå› ï¼š
<ol>
<li>å®‰å…¨è¾¹ç•Œï¼šé€šè¿‡å°†stackloè®¾ç½®ä¸ºè·ç¦»æ ˆé¡¶8MBå‡å»4KBçš„ä½ç½®ï¼Œä»£ç ä¸ºæ ˆæº¢å‡ºæ£€æµ‹ç•™å‡ºäº†ç©ºé—´ã€‚å¦‚æœgoroutineçš„æ ˆå¢é•¿è¶…è¿‡äº†è¿™ä¸ªè®¾ç½®çš„èŒƒå›´ï¼Œé‚£ä¹ˆå®ƒå°†è§¦å‘æ ˆæº¢å‡ºé”™è¯¯ï¼Œè€Œä¸æ˜¯è¦†ç›–å…¶ä»–å†…å­˜ï¼Œè¿™æœ‰åŠ©äºé˜²æ­¢å†…å­˜æŸåã€‚</li>
<li>æ ˆç©ºé—´é¢„ç•™ï¼šåœ¨Cå’ŒGoä»£ç ä¹‹é—´è¿›è¡Œåˆ‡æ¢æ—¶ï¼Œå¯èƒ½éœ€è¦é¢å¤–çš„æ ˆç©ºé—´æ¥å¤„ç†å‡½æ•°è°ƒç”¨ã€å‚æ•°ä¼ é€’ç­‰ã€‚é¢„ç•™ç©ºé—´å¯ä»¥ç¡®ä¿åœ¨è¿™äº›æ“ä½œä¸­æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œé¿å…æ ˆæº¢å‡ºã€‚</li>
<li>ä¸Goè¿è¡Œæ—¶æ ˆç®¡ç†å…¼å®¹ï¼šGoè¿è¡Œæ—¶è´Ÿè´£ç®¡ç†goroutinesçš„æ ˆï¼ŒåŒ…æ‹¬æ ˆçš„å¢é•¿å’Œæ”¶ç¼©ã€‚è¿™æ®µä»£ç ç¡®ä¿äº†Cçº¿ç¨‹çš„æ ˆä¸Goè¿è¡Œæ—¶çš„æ ˆç®¡ç†ç­–ç•¥å…¼å®¹ã€‚</li>
<li>åˆå§‹åŒ–setg_gccï¼šsetg_gccæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œç”¨äºåœ¨Cä»£ç ä¸­è®¾ç½®å½“å‰çš„goroutineã€‚åœ¨Cä»£ç ä¸­è°ƒç”¨Goå‡½æ•°æ—¶ï¼Œéœ€è¦æ­£ç¡®è®¾ç½®å½“å‰çš„goroutineï¼Œè¿™æ ·Goè¿è¡Œæ—¶æ‰èƒ½æ­£ç¡®ç®¡ç†goroutineçš„çŠ¶æ€ã€‚</li>
</ol>
</li>
<li>æ€»çš„æ¥è¯´ï¼Œè¿™æ®µä»£ç æ˜¯cgoåˆå§‹åŒ–çš„ä¸€éƒ¨åˆ†ï¼Œç›®çš„æ˜¯ä¸ºäº†ç¡®ä¿Cçº¿ç¨‹çš„æ ˆä¸Goè¿è¡Œæ—¶çš„goroutineæ ˆèƒ½å¤Ÿæ­£ç¡®åœ°ååŒå·¥ä½œï¼ŒåŒæ—¶ä¿æŒæ ˆçš„å®‰å…¨æ€§å’Œæ€§èƒ½ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">setg_gcc</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// This will be set in gcc_android.c for android-specific customization.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">x_cgo_inittls</span><span class="p">)(</span><span class="kt">void</span> <span class="o">**</span><span class="n">tlsg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">tlsbase</span><span class="p">)</span> <span class="nf">__attribute__</span><span class="p">((</span><span class="n">common</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span>
</span></span><span class="line"><span class="cl"><span class="nf">x_cgo_init</span><span class="p">(</span><span class="n">G</span> <span class="o">*</span><span class="n">g</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">setg</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">**</span><span class="n">tlsg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">tlsbase</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç”³æ˜ä¸€ä¸ª pthread_attr_t ç±»å‹å˜é‡ *attrï¼ŒæŒ‡é’ˆç±»å‹.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// pthread_attr_t æ˜¯çº¿ç¨‹çš„å±æ€§ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">pthread_attr_t</span> <span class="o">*</span><span class="n">attr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç”³æ˜ä¸€ä¸ª size_t ç±»å‹å˜é‡ sizeã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span> <span class="c1">// ç”¨äºä¿å­˜æ–°åˆ›å»ºçš„è¿™ä¸ªçº¿ç¨‹çš„æ ˆå¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* The memory sanitizer distributed with versions of clang
</span></span></span><span class="line"><span class="cl"><span class="cm">       before 3.8 has a bug: if you call mmap before malloc, mmap
</span></span></span><span class="line"><span class="cl"><span class="cm">       may return an address that is later overwritten by the msan
</span></span></span><span class="line"><span class="cl"><span class="cm">       library.  Avoid this problem by forcing a call to malloc
</span></span></span><span class="line"><span class="cl"><span class="cm">       here, before we ever call malloc.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">       This is only required for the memory sanitizer, so it&#39;s
</span></span></span><span class="line"><span class="cl"><span class="cm">       unfortunate that we always run it.  It should be possible
</span></span></span><span class="line"><span class="cl"><span class="cm">       to remove this when we no longer care about versions of
</span></span></span><span class="line"><span class="cl"><span class="cm">       clang before 3.8.  The test for this is
</span></span></span><span class="line"><span class="cl"><span class="cm">       misc/cgo/testsanitizers.
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">       GCC works hard to eliminate a seemingly unnecessary call to
</span></span></span><span class="line"><span class="cl"><span class="cm">       malloc, so we actually use the memory we allocate.  */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">setg_gcc</span> <span class="o">=</span> <span class="n">setg</span><span class="p">;</span> <span class="c1">// å‘setg_gccå…¨å±€é™æ€å˜é‡èµ‹å€¼setg_gcc()å‡½æ•°çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å‘æ“ä½œç³»ç»Ÿç”³è¯· *attr ç±»å‹éœ€è¦çš„å†…å­˜ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆå¤§å°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">attr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">pthread_attr_t</span><span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">attr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// ç”³è¯·å¤±è´¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">fatalf</span><span class="p">(</span><span class="s">&#34;malloc failed: %s&#34;</span><span class="p">,</span> <span class="nf">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆå§‹åŒ–çº¿ç¨‹å±æ€§å¯¹è±¡ï¼›åˆ›å»ºçš„é»˜è®¤æ ˆå¤§å°ä¸º8M
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">pthread_attr_init</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// pthread_attr_getstacksize è·å–çº¿ç¨‹çš„æ ˆå¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">pthread_attr_getstacksize</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// __builtin_frame_address(0) æŸ¥çœ‹å½“å‰å‡½æ•°çš„æ ˆå¸§åœ°å€ï¼Œå› æ­¤å’ŒSPå¯„å­˜å™¨å€¼ç›¸å·®ä¸å¤§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ³¨æ„è¿™é‡Œä¿®æ”¹çš„æ˜¯ stack.lo = SP - 8MB + 4KBï¼ŒåŠ ä¸Š4KBæ˜¯ä¸ºäº†åˆ¤æ–­å½“å‰åˆ†é…çš„æ ˆæ˜¯å¦è¶…è¿‡4KB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› ä¸ºgå‚æ•°ä¼ é€’çš„æ˜¯æŒ‡é’ˆï¼Œè¿™é‡Œç›´æ¥ä¿®æ”¹äº†g0çš„stack.loå­—æ®µçš„å€¼ï¼Œè¿™é‡Œç›¸å½“äºæ‰©å¤§äº†g0æ ˆå¤§å°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">g</span><span class="o">-&gt;</span><span class="n">stacklo</span> <span class="o">=</span> <span class="p">(</span><span class="n">uintptr</span><span class="p">)</span><span class="nf">__builtin_frame_address</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">4096</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// lo &gt;= hiï¼Œé”™è¯¯çš„æ ˆè¾¹ç•Œã€‚hi-&gt;loï¼ˆé«˜-&gt;ä½ï¼‰ï¼Œåˆ¤æ–­æ˜¯å¦æº¢å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">stacklo</span> <span class="o">&gt;=</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">stackhi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fatalf</span><span class="p">(</span><span class="s">&#34;bad stack bounds: lo=%p hi=%p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">stacklo</span><span class="p">,</span> <span class="n">g</span><span class="o">-&gt;</span><span class="n">stackhi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// é”€æ¯ attr è¿™ä¸ªçº¿ç¨‹å±æ€§å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">pthread_attr_destroy</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">free</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>   <span class="c1">// é‡Šæ”¾ attr å ç”¨çš„å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">x_cgo_inittls</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">x_cgo_inittls</span><span class="p">(</span><span class="n">tlsg</span><span class="p">,</span> <span class="n">tlsbase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="8">
<li>æ ¹æ®æ±‡ç¼–ä»£ç å¯çŸ¥ï¼Œ<code>setg_gcc()</code>å‡½æ•°åº”è¯¥æ˜¯æŠŠ<code>g</code>æ”¾å…¥<code>TLS</code>å’Œ<code>R14</code>å¯„å­˜å™¨ä¸­ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/asm_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1049
</span><span class="lnt">1050
</span><span class="lnt">1051
</span><span class="lnt">1052
</span><span class="lnt">1053
</span><span class="lnt">1054
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1"># void setg_gcc(G*); set g called from gcc.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">setg_gcc</span><span class="err">&lt;&gt;</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="p">,</span><span class="no">$0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">get_tls</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">DI</span><span class="p">,</span> <span class="no">g</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">DI</span><span class="p">,</span> <span class="no">R14</span> <span class="c1"># set the g register
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="10">
<li>ä¼ å…¥ç»™<code>x_cgo_init</code>çš„<code>G *g</code>å‚æ•°å…¶å®æ˜¯<code>g0</code>ï¼Œè€Œ<code>g0</code>ç»“æ„ä½“ç¬¬ä¸€ä¸ªå­—æ®µå°±æ˜¯<code>stack</code>ï¼ŒåŒ…å«<code>stacklo</code>å’Œ<code>stackhi</code>ï¼Œå› æ­¤èƒ½ç›´æ¥è½¬æ¢ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/cgo/libcgo.h</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">* The beginning of the per-goroutine structure,
</span></span></span><span class="line"><span class="cl"><span class="cm">* as defined in ../pkg/runtime/runtime.h.
</span></span></span><span class="line"><span class="cl"><span class="cm">* Just enough to edit these two fields.
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">G</span> <span class="n">G</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">G</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">uintptr</span> <span class="n">stacklo</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">uintptr</span> <span class="n">stackhi</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="12">
<li>æ€»ç»“ï¼šè¿™éƒ¨åˆ†ä»£ç ï¼Œå°è¯•è·å–<code>CPU</code>ç›¸å…³ä¿¡æ¯å¹¶ä¿å­˜åœ¨å…¨å±€å˜é‡ä¸­ã€‚åˆ¤æ–­æ˜¯å¦å­˜åœ¨<code>CGO</code>ç›¸å…³åˆå§‹åŒ–ï¼Œå¦‚æœéœ€è¦åˆ™ä»æ–°è®¾ç½®<code>g0</code>çš„æ ˆå¤§å°ã€‚</li>
<li>è¿è¡Œå®Œä¸Šé¢è¿™cgoåˆå§‹åŒ–ä¸æ ˆä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li>
</ol>
<p><img loading="lazy" src="../images/goroutine-004.png" alt=""  />
</p>
</blockquote>
</details></p>

<h2 id="ä¸»çº¿ç¨‹ä¸m0ç»‘å®š">ä¸»çº¿ç¨‹ä¸<code>m0</code>ç»‘å®š<a hidden class="anchor" aria-hidden="true" href="#ä¸»çº¿ç¨‹ä¸m0ç»‘å®š">#</a></h2>
<h3 id="è®¾ç½®tls">è®¾ç½®tls<a hidden class="anchor" aria-hidden="true" href="#è®¾ç½®tls">#</a></h3>
<ol>
<li>è®¾ç½®å¥½<code>g0</code>æ ˆä¹‹åï¼Œè·å–åˆ°<code>CPU</code>å‹å·ä»¥åŠ<code>cgo</code>åˆå§‹åŒ–åï¼Œè®¾ç½®å·¥ä½œçº¿ç¨‹<code>TLS</code>ã€‚</li>
<li>è°ƒç”¨<code>settls</code>å‡½æ•°åˆå§‹åŒ–ä¸»çº¿ç¨‹çš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨(<code>TLS</code>)ï¼Œç›®çš„æ˜¯æŠŠ<code>m0</code>ä¸ä¸»çº¿ç¨‹å…³è”åœ¨ä¸€èµ·ã€‚</li>
<li>è®¾ç½®äº†çº¿ç¨‹æœ¬åœ°å­˜å‚¨ä¹‹åæ¥ä¸‹æ¥çš„å‡ æ¡æŒ‡ä»¤åœ¨äºéªŒè¯<code>TLS</code>åŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼Œå¦‚æœä¸æ­£å¸¸åˆ™ç›´æ¥<code>abort</code>é€€å‡ºç¨‹åºã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/asm_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">    <span class="c1"># 1) è®¾ç½® TLS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ä¸‹é¢å¼€å§‹åˆå§‹åŒ–tlsï¼ˆthread local storageï¼Œçº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># LEAå°†å†…å­˜åœ°å€èµ‹å€¼ç»™DIï¼Œå–m0çš„tlsæˆå‘˜çš„åœ°å€åˆ°DIå¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">LEAQ</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">m0</span><span class="err">+</span><span class="no">m_tls</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">DI</span>  <span class="c1"># DI=&amp;m0.tls
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è°ƒç”¨settlsè®¾ç½®çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œsettlså‡½æ•°çš„å‚æ•°åœ¨DIå¯„å­˜å™¨ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">settls</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 2) éªŒè¯ TLS æ˜¯å¦å¯ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># store through it, to make sure it works
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># é€šè¿‡å®ƒè¿›è¡Œå­˜å‚¨ï¼Œä»¥ç¡®ä¿å®ƒæœ‰æ•ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># éªŒè¯settlsæ˜¯å¦å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œå¦‚æœæœ‰é—®é¢˜åˆ™aborté€€å‡ºç¨‹åº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">get_tls</span><span class="p">(</span><span class="no">BX</span><span class="p">)</span>	<span class="c1"># è·å–fsæ®µåŸºåœ°å€å¹¶æ”¾å…¥BXå¯„å­˜å™¨ï¼Œå…¶å®å°±æ˜¯m0.tls[1]çš„åœ°å€ï¼Œget_tlsçš„ä»£ç ç”±ç¼–è¯‘å™¨ç”Ÿæˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># é€šè¿‡ FS å¯„å­˜å™¨å­˜å‚¨çš„å€¼è¿›è¡Œè®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$0x123</span><span class="p">,</span> <span class="no">g</span><span class="p">(</span><span class="no">BX</span><span class="p">)</span> <span class="c1"># æŠŠæ•´å‹å¸¸é‡0x123æ‹·è´åˆ°fsæ®µåŸºåœ°å€åç§»-8çš„å†…å­˜ä½ç½®ï¼Œä¹Ÿå°±æ˜¯m0.tls[0]=0x123
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># é€šè¿‡ runtime.mtls[0] è¿›è¡Œå–å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">m0</span><span class="err">+</span><span class="no">m_tls</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">AX</span> <span class="c1"># AX=m0.tls[0]ï¼ŒMOVå°†å€¼èµ‹å€¼ç»™AX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æ¯”è¾ƒ AX ä¸ $0x123 æ˜¯å¦ç›¸ç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">$0x123</span>  <span class="c1"># æ£€æŸ¥m0.tls[0]çš„å€¼æ˜¯å¦é€šè¿‡çº¿ç¨‹æœ¬åœ°å­˜å‚¨å­˜å…¥çš„0x123æ¥éªŒè¯tlsåŠŸèƒ½æ˜¯å¦æ­£å¸¸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å¦‚æœå‰é¢çš„æ¯”è¾ƒç»“æœæ˜¯ç›¸ç­‰ï¼Œè·³è½¬åˆ°å½“å‰æŒ‡ä»¤åœ°å€åŠ 2ä¸ªå­—èŠ‚çš„ä½ç½®ï¼ˆå³ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å¦‚æœæ¯”è¾ƒç»“æœä¸æ˜¯ç›¸ç­‰ï¼Œåˆ™ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JEQ</span> <span class="mi">2</span><span class="p">(</span><span class="no">PC</span><span class="p">)</span>   <span class="c1"># è·³è¿‡ä¸‹é¢è¿™ä¸€æ¡æŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">abort</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="c1"># å¦‚æœçº¿ç¨‹æœ¬åœ°å­˜å‚¨ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œé€€å‡ºç¨‹åº
</span></span></span></code></pre></td></tr></table>
</div>
</div>

<p><details >
  <summary markdown="span">runtimeÂ·settls(SB)</summary>
  <blockquote>
<ol>
<li>å°†<code>tls-base</code>è®¾ç½®ä¸º<code>DI</code>å¯„å­˜å™¨çš„å€¼ï¼Œ<code>DI</code>å¯„å­˜å™¨å­˜å‚¨çš„æ˜¯<code>m0.tls</code>çš„åœ°å€ã€‚</li>
<li>é€šè¿‡<code>arch_prctl</code>ç³»ç»Ÿè°ƒç”¨æŠŠ<code>m0.tls[1]</code>çš„åœ°å€è®¾ç½®æˆäº†<code>fs</code>æ®µçš„æ®µåŸºå€ã€‚</li>
<li><code>CPU</code>ä¸­æœ‰ä¸ªå«<code>fs</code>çš„æ®µå¯„å­˜å™¨ä¸ä¹‹å¯¹åº”ï¼š
<ul>
<li>è€Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ä¸€ç»„<code>CPU</code>å¯„å­˜å™¨å€¼ï¼Œæ“ä½œç³»ç»Ÿåœ¨æŠŠçº¿ç¨‹è°ƒç¦»<code>CPU</code>è¿è¡Œæ—¶ä¼šå¸®æˆ‘ä»¬æŠŠæ‰€æœ‰å¯„å­˜å™¨ä¸­çš„å€¼ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚</li>
<li>è°ƒåº¦çº¿ç¨‹èµ·æ¥è¿è¡Œæ—¶åˆä¼šä»å†…å­˜ä¸­æŠŠè¿™äº›å¯„å­˜å™¨çš„å€¼æ¢å¤åˆ°<code>CPU</code>ã€‚åœ¨æ­¤ä¹‹åå·¥ä½œçº¿ç¨‹ä»£ç å°±å¯ä»¥é€šè¿‡<code>fs</code>å¯„å­˜å™¨æ¥æ‰¾åˆ°<code>m.tls</code>ã€‚</li>
</ul>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/sys_linux_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1"># set tls base to DI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">settls</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="p">,</span><span class="no">$32</span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef GOOS_android
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># Android stores the TLS offset in runtimeÂ·tls_g.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">SUBQ</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">tls_g</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">DI</span>
</span></span><span class="line"><span class="cl"><span class="c1">#else
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># DIå¯„å­˜å™¨ä¸­å­˜æ”¾çš„æ˜¯m.tls[0]çš„åœ°å€ï¼Œmçš„tlsæˆå‘˜æ˜¯ä¸€ä¸ªæ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä¸‹é¢è¿™ä¸€å¥ä»£ç æŠŠDIå¯„å­˜å™¨ä¸­çš„åœ°å€åŠ 8ï¼Œä¸ºä»€ä¹ˆè¦+8å‘¢ï¼Œä¸»è¦è·ŸELFå¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼ä¸­çš„TLSå®ç°çš„æœºåˆ¶æœ‰å…³
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æ‰§è¡Œä¸‹é¢è¿™å¥æŒ‡ä»¤ä¹‹åDIå¯„å­˜å™¨ä¸­å­˜æ”¾çš„å°±æ˜¯m.tls[1]çš„åœ°å€äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ADDQ</span>    <span class="no">$8</span><span class="p">,</span> <span class="no">DI</span>  <span class="c1"># ELF wants to use -8(FS)
</span></span></span><span class="line"><span class="cl"><span class="c1">#endif
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># AMD64 Linuxå¹³å°çº¦å®šåœ¨è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ä½¿ç”¨ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   1. raxå¯„å­˜å™¨å­˜æ”¾ç³»ç»Ÿè°ƒç”¨ç¼–å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   2. åŒæ—¶çº¦å®šä½¿ç”¨rdi, rsi, rdx, r10, r8å’Œr9æ¥ä¼ é€’å‰6ä¸ªç³»ç»Ÿè°ƒç”¨å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä¸‹é¢é€šè¿‡arch_prctlç³»ç»Ÿè°ƒç”¨è®¾ç½®FSæ®µåŸºåœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># arch_prctlç³»ç»Ÿè°ƒç”¨çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œè®¾ç½®è¯¥å€¼ä¸ºFSæ®µåŸºåœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">DI</span><span class="p">,</span> <span class="no">SI</span>  <span class="c1"># SI = DI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># arch_prctlçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼šARCH_SET_FS å‚æ•°å€¼è¡¨ç¤ºè®¾ç½®çº¿ç¨‹çš„TLSåœ°å€çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># åœ¨ x86 æ¶æ„ä¸­ï¼ŒFS å¯„å­˜å™¨ç”¨äºå­˜å‚¨ TLS ï¼ˆThread Local Storageï¼‰çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$0x1002</span><span class="p">,</span> <span class="no">DI</span>	<span class="c1"># ARCH_SET_FS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># AX ç³»ç»Ÿè°ƒç”¨ç¼–å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$SYS_arch_prctl</span><span class="p">,</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># AX = $SYS_arch_prctl
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># DI = ARCH_SET_FS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># SI = &amp;m.tls[1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">SYSCALL</span>   <span class="c1"># ç³»ç»Ÿè°ƒç”¨ï¼Œè¿›å…¥å†…æ ¸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># åˆ¤æ–­ç³»ç»Ÿè°ƒç”¨æ˜¯å¦æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å°† AX å¯„å­˜å™¨ä¸­çš„å€¼ä¸ 0xfffffffffffff001 è¿›è¡Œæ¯”è¾ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å¦‚æœ AX ä¸­çš„å€¼å°äºç­‰äº 0xfffffffffffff001ï¼Œåˆ™è·³è½¬åˆ°å½“å‰æŒ‡ä»¤åœ°å€åŠ ä¸Š2çš„åœ°å€ï¼ˆå³è·³è½¬åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">$0xfffffffffffff001</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JLS</span>	<span class="mi">2</span><span class="p">(</span><span class="no">PC</span><span class="p">)</span>   <span class="c1"># è·³è¿‡ä»¥ä¸‹ä¸¤æ¡æŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVL</span>    <span class="no">$0xf1</span><span class="p">,</span> <span class="mi">0xf1</span> <span class="c1"># crash ç³»ç»Ÿè°ƒç”¨å¤±è´¥ç›´æ¥crashï¼Œå¤±è´¥åŸå› æ˜¯æŠŠ$0xf1æ”¾å…¥ä¸å­˜åœ¨åœ°å€é‡Œé¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">RET</span> <span class="c1"># ç›´æ¥è¿”å›
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>ç›¸å…³å®å®šä¹‰ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/go_tls.h</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#ifdef GOARCH_amd64
</span></span></span><span class="line"><span class="cl"><span class="cp">#define   get_tls(r)  MOVQ TLS, r </span><span class="c1">// get_tlså‡½æ•°å®šä¹‰ï¼ŒTLSå…¶å®å°±æ˜¯FSå¯„å­˜å™¨çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#define   g(r)    0(r)(TLS*1)     </span><span class="c1">// (r + TLS*1 + 0)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cp">#endif
</span></span></span></code></pre></td></tr></table>
</div>
</div></blockquote>

</details></p>

<h3 id="m0ç»‘å®š"><code>m0</code>ç»‘å®š<a hidden class="anchor" aria-hidden="true" href="#m0ç»‘å®š">#</a></h3>
<ol>
<li>é¦–å…ˆæŠŠ<code>g0</code>çš„åœ°å€æ”¾å…¥ä¸»çº¿ç¨‹çš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆ<code>TLS</code>ï¼‰ä¸­ï¼Œç„¶åé€šè¿‡ã€<code>m0.g0=&amp;g0</code>ã€‘ã€<code>g0.m=&amp;m0</code>ã€‘æŠŠ<code>m0</code>å’Œ<code>g0</code>ç»‘å®šåœ¨ä¸€èµ·ã€‚</li>
<li>ä¹‹ååœ¨ä¸»çº¿ç¨‹ä¸­é€šè¿‡<code>get_tls</code>å¯ä»¥è·å–åˆ°<code>g0</code>ï¼Œé€šè¿‡<code>g0</code>çš„<code>m</code>æˆå‘˜åˆå¯ä»¥æ‰¾åˆ°<code>m0</code>ã€‚</li>
<li>ä¿å­˜åœ¨ä¸»çº¿ç¨‹æœ¬åœ°å­˜å‚¨ä¸­çš„å€¼æ˜¯<code>g0</code>çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´å·¥ä½œçº¿ç¨‹çš„ç§æœ‰å…¨å±€å˜é‡å…¶å®æ˜¯ä¸€ä¸ªæŒ‡å‘<code>g</code>çš„æŒ‡é’ˆè€Œä¸æ˜¯æŒ‡å‘<code>m</code>çš„æŒ‡é’ˆã€‚</li>
<li>ç›®å‰è¿™ä¸ªæŒ‡é’ˆæŒ‡å‘<code>g0</code>ï¼Œè¡¨ç¤ºä»£ç æ­£è¿è¡Œåœ¨<code>g0</code>æ ˆã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/asm_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">    <span class="nl">ok:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 1) g0 ä¸ TLS ç»‘å®š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># set the per-goroutine and per-mach &#34;registers&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">get_tls</span><span class="p">(</span><span class="no">BX</span><span class="p">)</span>	<span class="c1"># è·å–fsæ®µåŸºåœ°å€åˆ°BXå¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">LEAQ</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">g0</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">CX</span> <span class="c1"># CX = &amp;g0; var g0 g;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æŠŠg0çš„åœ°å€ä¿å­˜åœ¨çº¿ç¨‹æœ¬åœ°å­˜å‚¨é‡Œé¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">CX</span><span class="p">,</span> <span class="no">g</span><span class="p">(</span><span class="no">BX</span><span class="p">)</span>           <span class="c1"># m0.tls[0]=&amp;g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">LEAQ</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">m0</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">AX</span>  <span class="c1"># AX = &amp;m0; var m0 m;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 2) m0 å’Œ g0 ç›¸äº’ç»‘å®š 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   m0.g0 = &amp;g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   g0.m = &amp;m0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># save m-&gt;g0 = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">CX</span><span class="p">,</span> <span class="no">m_g0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>    <span class="c1"># m0.g0=g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># save m0 to g0-&gt;m
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># mçš„ç¬¬ä¸€ä¸ªå­—æ®µå°±æ˜¯m0.g0æ‰€ä»¥è¿™é‡ŒAXä»£è¡¨çš„å°±æ˜¯m0.g0çš„åœ°å€å¤„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">g_m</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span> <span class="c1"># g0.m=m0	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># CLD æŒ‡ä»¤æ˜¯ Clear Direction Flag çš„ç¼©å†™ã€‚ç”¨äºå°†æ–¹å‘æ ‡å¿—ä½ DFï¼ˆDirection Flagï¼‰æ¸…é›¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># åœ¨x86æ¶æ„çš„è®¡ç®—æœºä¸­ï¼Œæ–¹å‘æ ‡å¿—ä½DFæ˜¯ä¸€ä¸ªæ ‡å¿—å¯„å­˜å™¨ä¸­çš„ä¸€ä½ï¼Œç”¨äºæŒ‡ç¤ºå­—ç¬¦ä¸²æ“ä½œæŒ‡ä»¤ï¼ˆå¦‚ MOVSBã€LODSBã€STOSB ç­‰ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># åœ¨æ‰§è¡Œæ—¶æ˜¯æŒ‰ç…§é€’å¢æ–¹å‘è¿˜æ˜¯é€’å‡æ–¹å‘è¿›è¡Œæ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å½“ DF ä¸º 0 æ—¶ï¼Œå­—ç¬¦ä¸²æŒ‡é’ˆå°†æŒ‰ç…§é€’å¢æ–¹å‘ç§»åŠ¨ï¼›å½“ DF ä¸º 1 æ—¶ï¼Œå­—ç¬¦ä¸²æŒ‡é’ˆå°†æŒ‰ç…§é€’å‡æ–¹å‘ç§»åŠ¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># CLD æŒ‡ä»¤å°†æ–¹å‘æ ‡å¿—ä½ DF æ¸…é›¶ï¼Œè¡¨ç¤ºå­—ç¬¦ä¸²æ“ä½œæŒ‡ä»¤å°†æŒ‰ç…§é€’å¢æ–¹å‘è¿›è¡Œæ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å¦‚æœæˆ‘ä»¬ä½¿ç”¨MOVSBæŒ‡ä»¤å°†ä¸€ä¸ªé•¿åº¦ä¸º10å­—èŠ‚çš„å­—ç¬¦ä¸²ä»å­˜å‚¨å™¨ä¸­å¤åˆ¶åˆ°å¯„å­˜å™¨ä¸­ï¼Œå®ƒä¼šæŒ‰ç…§é€’å¢æ–¹å‘ä»å­˜å‚¨å™¨ä¸­çš„ç¬¬ä¸€ä¸ªå­—èŠ‚å¼€å§‹è¯»å–æ•°æ®ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å¹¶å°†å®ƒä»¬å¤åˆ¶åˆ°å¯„å­˜å™¨ä¸­ã€‚ç„¶åï¼Œå®ƒä¼šé€’å¢å­˜å‚¨å™¨åœ°å€å’Œå¯„å­˜å™¨åœ°å€ï¼Œä»¥ä¾¿è¯»å–å’Œå¤åˆ¶ä¸‹ä¸€ä¸ªå­—èŠ‚ï¼Œç›´åˆ°æ•´ä¸ªå­—ç¬¦ä¸²è¢«å¤åˆ¶åˆ°å¯„å­˜å™¨ä¸­ä¸ºæ­¢ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æ„æ€æ˜¯ï¼Œåœ¨ä½¿ç”¨å­—ç¬¦ä¸²æ“ä½œæŒ‡ä»¤æ—¶ï¼Œè¿™äº›æŒ‡ä»¤ä¼šæŒ‰ç…§é€’å¢æ–¹å‘æ“ä½œï¼Œå³æŒ‰ç…§å­˜å‚¨å™¨åœ°å€é€’å¢çš„é¡ºåºå¤åˆ¶æ•°æ®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CLD</span>     <span class="c1"># convention is D is always left cleared
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>æ­¤æ—¶ï¼Œä¸»çº¿ç¨‹ï¼Œ<code>m0</code>ï¼Œ<code>g0</code>ä»¥åŠ<code>g0</code>çš„æ ˆä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li>
</ol>
<p><img loading="lazy" src="../images/goroutine-005.png" alt=""  />
</p>
<ol start="7">
<li>æ€»ç»“ï¼šè¿™æ®µå‡½æ•°é€šè¿‡<code>runtimeÂ·settls()</code>å‡½æ•°æŠŠå½“å‰å·¥ä½œçº¿ç¨‹çš„<code>FS</code>å¯„å­˜å™¨åœ°å€è®¾ç½®ä¸º<code>&amp;m0.tls[1]</code>åœ°å€çš„å€¼ï¼Œç„¶åå†éªŒè¯æ˜¯å¦è®¾ç½®æˆåŠŸã€‚ç„¶åæŠŠ<code>g0</code>åœ°å€æ”¾å…¥<code>FS</code>æ®µå¯„å­˜å™¨ä¸­ï¼Œä¹Ÿå°±æ˜¯<code>&amp;m0.tls[0]</code>å¤„ï¼Œè¡¨ç¤ºå½“å‰å·¥ä½œçº¿ç¨‹æ­£åœ¨æ‰§è¡Œ<code>g0</code>ã€‚æ¥ç€è®¾ç½®<code>m0.g0=g0</code>å’Œ<code>g0.m=m0</code>ï¼ŒæŠŠ<code>g0</code>å’Œ<code>m0</code>ç›¸å…³è”èµ·ã€‚</li>
</ol>
<h2 id="æ£€æŸ¥">æ£€æŸ¥<a hidden class="anchor" aria-hidden="true" href="#æ£€æŸ¥">#</a></h2>
<ol>
<li>ç¼–è¯‘å™¨ä¼šåœ¨å¾ˆå¤šå‡½æ•°éœ€è¦å‰å°è£…ä¸€å±‚æŠŠ<code>g</code>å†™å…¥<code>R14</code>å¯„å­˜å™¨ä¸­ã€‚è¿™é‡Œç¼–è¯‘å™¨ä¼šæŠŠ<code>g0</code>å†™å…¥<code>R14</code>å¯„å­˜å…¶ä¸­ã€‚</li>
<li>ä¸»è¦æ˜¯<code>runtimeÂ·check()</code>å‡½æ•°ï¼Œæ£€æŸ¥å†…ç½®ç±»å‹çš„ç›¸å…³ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/asm_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">    <span class="c1"># Check GOAMD64 reqirements
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># We need to do this after setting up TLS, so that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># we can report an error if there is a failure. See issue 49586.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æ£€æŸ¥GOAMD64è¦æ±‚æˆ‘ä»¬éœ€è¦åœ¨è®¾ç½®TLSåæ‰§è¡Œæ­¤æ“ä½œï¼Œä»¥ä¾¿åœ¨å‡ºç°å¤±è´¥æ—¶æŠ¥å‘Šé”™è¯¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">#ifdef NEED_FEATURES_CX	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVL</span>    <span class="no">$0</span><span class="p">,</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CPUID</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CMPL</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">$0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JE</span>	<span class="no">bad_cpu</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">$1</span><span class="p">,</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CPUID</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ANDL</span>    <span class="no">$NEED_FEATURES_CX</span><span class="p">,</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CMPL</span>    <span class="no">CX</span><span class="p">,</span> <span class="no">$NEED_FEATURES_CX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JNE</span>	<span class="no">bad_cpu</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef NEED_MAX_CPUID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVL</span>    <span class="no">$0x80000000</span><span class="p">,</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CPUID</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CMPL</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">$NEED_MAX_CPUID</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JL</span>  <span class="no">bad_cpu</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef NEED_EXT_FEATURES_BX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVL</span>    <span class="no">$7</span><span class="p">,</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">$0</span><span class="p">,</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CPUID</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ANDL</span>    <span class="no">$NEED_EXT_FEATURES_BX</span><span class="p">,</span> <span class="no">BX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CMPL</span>    <span class="no">BX</span><span class="p">,</span> <span class="no">$NEED_EXT_FEATURES_BX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JNE</span> <span class="no">bad_cpu</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef NEED_EXT_FEATURES_CX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVL</span>    <span class="no">$0x80000001</span><span class="p">,</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CPUID</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ANDL</span>    <span class="no">$NEED_EXT_FEATURES_CX</span><span class="p">,</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CMPL</span>    <span class="no">CX</span><span class="p">,</span> <span class="no">$NEED_EXT_FEATURES_CX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JNE</span> <span class="no">bad_cpu</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef NEED_OS_SUPPORT_AX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">XORL</span>    <span class="no">CX</span><span class="p">,</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">XGETBV</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ANDL</span>    <span class="no">$NEED_OS_SUPPORT_AX</span><span class="p">,</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CMPL</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">$NEED_OS_SUPPORT_AX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JNE</span> <span class="no">bad_cpu</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">#ifdef NEED_DARWIN_SUPPORT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$commpage64_version</span><span class="p">,</span> <span class="no">BX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CMPW</span>    <span class="p">(</span><span class="no">BX</span><span class="p">),</span> <span class="no">$13</span>  <span class="c1"># cpu_capabilities64 undefined in versions &lt; 13
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JL</span>  <span class="no">bad_cpu</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">$commpage64_cpu_capabilities64</span><span class="p">,</span> <span class="no">BX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="p">(</span><span class="no">BX</span><span class="p">),</span> <span class="no">BX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">$NEED_DARWIN_SUPPORT</span><span class="p">,</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ANDQ</span>    <span class="no">CX</span><span class="p">,</span> <span class="no">BX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CMPQ</span>    <span class="no">BX</span><span class="p">,</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JNE</span> <span class="no">bad_cpu</span>
</span></span><span class="line"><span class="cl"><span class="c1">#endif
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># &#34;TEXT runtime.check(SB)&#34; æ˜¯ç”±ç¼–è¯‘å™¨å®ç°ï¼Œå› ä¸ºä»¥ä¸‹checkæ–¹æ³•ç”±runtimeçš„Goå®ç°éœ€è¦è·å–gã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ç¼–è¯‘å™¨å®ç° &#34;TEXT runtime.check(SB)&#34; æ˜¯éœ€è¦æŠŠg0å†™å…¥R14ä¸­ï¼Œç„¶åJMPè·³è½¬åˆ°check
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è¯¥å‡½æ•°åœ¨ go1.19.3/src/runtime/runtime1.go:check() 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä¸»è¦æ˜¯æ£€æŸ¥goæ”¯æŒçš„å˜é‡å†…å­˜æƒ…å†µï¼ŒåŸå­CASå‡½æ•°ç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">check</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li><code>runtimeÂ·check(SB)</code> æ±‡ç¼–å¼€å¤´å‡ è¡Œã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">runtime.check</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">&lt;</span><span class="no">autogenerated</span><span class="err">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nf">xorps</span> <span class="no">xmm15</span><span class="p">,</span> <span class="no">xmm15</span>	<span class="c1"># æ¸…é™¤xmm15å¯„å­˜å™¨ï¼Œå¯èƒ½åé¢å‡½æ•°éœ€è¦ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">mov</span> <span class="no">r14</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="no">fs</span><span class="p">:[</span><span class="mi">0xfffffff8</span><span class="p">]</span> <span class="c1"># R14 = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">jmp</span> <span class="no">$runtime.check</span> <span class="c1"># è·³è½¬ check() å‡½æ•°
</span></span></span></code></pre></div><ol start="5">
<li><code>runtime.check()</code>çš„æºç å®šä¹‰åœ¨<code>/src/runtime/runtime1.go</code>æ–‡ä»¶ä¸­ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">check</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">a</span>     <span class="kt">int8</span>
</span></span><span class="line"><span class="cl">        <span class="nx">b</span>     <span class="kt">uint8</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span>     <span class="kt">int16</span>
</span></span><span class="line"><span class="cl">        <span class="nx">d</span>     <span class="kt">uint16</span>
</span></span><span class="line"><span class="cl">        <span class="nx">e</span>     <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">        <span class="nx">f</span>     <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">        <span class="nx">g</span>     <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">        <span class="nx">h</span>     <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">        <span class="nx">i</span><span class="p">,</span> <span class="nx">i1</span> <span class="kt">float32</span>
</span></span><span class="line"><span class="cl">        <span class="nx">j</span><span class="p">,</span> <span class="nx">j1</span> <span class="kt">float64</span>
</span></span><span class="line"><span class="cl">        <span class="nx">k</span>     <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl">        <span class="nx">l</span>     <span class="o">*</span><span class="kt">uint16</span>
</span></span><span class="line"><span class="cl">        <span class="nx">m</span>     <span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">type</span> <span class="nx">x1t</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">x</span> <span class="kt">uint8</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">type</span> <span class="nx">y1t</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">x1</span> <span class="nx">x1t</span>
</span></span><span class="line"><span class="cl">        <span class="nx">y</span>  <span class="kt">uint8</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">x1</span> <span class="nx">x1t</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">y1</span> <span class="nx">y1t</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ£€æŸ¥ int8 ç±»å‹å ç”¨å­—èŠ‚é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad a&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ£€æŸ¥ uint8 ç±»å‹å ç”¨å­—èŠ‚é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad b&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad c&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad d&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad e&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad f&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad g&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad h&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad i&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">j</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">8</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad j&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">goarch</span><span class="p">.</span><span class="nx">PtrSize</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad k&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">goarch</span><span class="p">.</span><span class="nx">PtrSize</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad l&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">x1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad unsafe.Sizeof x1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Offsetof</span><span class="p">(</span><span class="nx">y1</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad offsetof y1.y&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">y1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad unsafe.Sizeof y1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nf">timediv</span><span class="p">(</span><span class="mi">12345</span><span class="o">*</span><span class="mi">1000000000</span><span class="o">+</span><span class="mi">54321</span><span class="p">,</span> <span class="mi">1000000000</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">e</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">12345</span> <span class="o">||</span> <span class="nx">e</span> <span class="o">!=</span> <span class="mi">54321</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad timediv&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">z</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">z</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ£€æŸ¥åŸå­æ“ä½œç›¸å…³
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Cas</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">z</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;cas1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">z</span> <span class="o">!=</span> <span class="mi">2</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;cas2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">z</span> <span class="p">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Cas</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">z</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;cas3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">z</span> <span class="o">!=</span> <span class="mi">4</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;cas4&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">z</span> <span class="p">=</span> <span class="mh">0xffffffff</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Cas</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">z</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xfffffffe</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;cas5&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">z</span> <span class="o">!=</span> <span class="mh">0xfffffffe</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;cas6&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">m</span> <span class="p">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="kt">byte</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">atomic</span><span class="p">.</span><span class="nf">Or8</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mh">0xf0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xf1</span> <span class="o">||</span> <span class="nx">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">m</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;atomicor8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">m</span> <span class="p">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="kt">byte</span><span class="p">{</span><span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">atomic</span><span class="p">.</span><span class="nf">And8</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mh">0x1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">||</span> <span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x1</span> <span class="o">||</span> <span class="nx">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">||</span> <span class="nx">m</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;atomicand8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">uint64</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">j</span><span class="p">))</span> <span class="p">=</span> <span class="p">^</span><span class="nb">uint64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">j</span> <span class="o">==</span> <span class="nx">j</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;float64nan&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!(</span><span class="nx">j</span> <span class="o">!=</span> <span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;float64nan1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">uint64</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">j1</span><span class="p">))</span> <span class="p">=</span> <span class="p">^</span><span class="nb">uint64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">j</span> <span class="o">==</span> <span class="nx">j1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;float64nan2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!(</span><span class="nx">j</span> <span class="o">!=</span> <span class="nx">j1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;float64nan3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">uint32</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">i</span><span class="p">))</span> <span class="p">=</span> <span class="p">^</span><span class="nb">uint32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="nx">i</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;float32nan&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="nx">i</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;float32nan1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">uint32</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">i1</span><span class="p">))</span> <span class="p">=</span> <span class="p">^</span><span class="nb">uint32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="nx">i1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;float32nan2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="nx">i1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;float32nan3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">testAtomic64</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_FixedStack</span> <span class="o">!=</span> <span class="nf">round2</span><span class="p">(</span><span class="nx">_FixedStack</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;FixedStack is not power-of-2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nf">checkASM</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;assembly checks failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>æ€»ç»“ï¼šè¿™æ®µä»£ç ä¸»è¦æ˜¯è°ƒç”¨äº†<code>runtimeÂ·check()</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸»è¦æ˜¯æ£€æŸ¥ç¼–è¯‘å™¨æ˜¯å¦æŒ‰ç…§é¢„æœŸï¼Œæ£€æŸ¥äº†ç›¸å…³å†…å­˜å ç”¨å€¼å’ŒåŸå­æ“ä½œç­‰ã€‚</li>
</ol>
<h2 id="åˆå§‹åŒ–m0">åˆå§‹åŒ–<code>m0</code><a hidden class="anchor" aria-hidden="true" href="#åˆå§‹åŒ–m0">#</a></h2>
<ol>
<li>å¤„ç†å‘½ä»¤è¡Œå‚æ•°ï¼Œè°ƒç”¨<code>osinit</code>å‡½æ•°è·å–<code>CPU</code>æ ¸çš„æ•°é‡å¹¶ä¿å­˜åœ¨å…¨å±€å˜é‡<code>ncpu</code>ä¹‹ä¸­ï¼Œ</li>
<li>è°ƒåº¦å™¨åˆå§‹åŒ–æ—¶éœ€è¦çŸ¥é“å½“å‰ç³»ç»Ÿæœ‰å¤šå°‘ä¸ª<code>CPU</code>æ ¸ã€‚</li>
<li>è°ƒç”¨<code>runtime.args()</code>å‡½æ•°æ¥æš‚å­˜å‘½ä»¤è¡Œå‚æ•°ä»¥å¾…åç»­è§£æã€‚éƒ¨åˆ†ç³»ç»Ÿä¼šåœ¨è¿™é‡Œè·å–ä¸ç¡¬ä»¶ç›¸å…³çš„ä¸€äº›å‚æ•°ï¼Œä¾‹å¦‚ç‰©ç†é¡µé¢å¤§å°ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/asm_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">    <span class="c1"># 1) å‡†å¤‡è°ƒç”¨argså‡½æ•°ï¼Œå‰é¢å››æ¡æŒ‡ä»¤æŠŠå‚æ•°æ”¾åœ¨æ ˆä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVL</span>	<span class="mi">24</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>		<span class="c1"># copy argc   AX=argc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVL</span>	<span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>		<span class="c1"># argcæ”¾åœ¨æ ˆé¡¶ï¼Œä¸ºè°ƒç”¨runtimeÂ·argsçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œvar argc int32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>	<span class="mi">32</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>		<span class="c1"># copy argv   AX=*argv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>	<span class="no">AX</span><span class="p">,</span> <span class="mi">8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>		<span class="c1"># argvæ”¾åœ¨SP+8çš„ä½ç½®ï¼Œä¸ºè°ƒç”¨runtimeÂ·argsçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œvar argv **byte
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä¿å­˜ argcå’Œargv éå† auxv è®¾ç½® physPageSize å’Œ startupRandomData ä»¥åŠå¤„ç† VDSO
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å¤„ç†æ“ä½œç³»ç»Ÿä¼ é€’è¿‡æ¥çš„å‚æ•°å’Œenvï¼Œå¤åˆ¶å…¨å±€å˜é‡argcå’Œargvå€¼ï¼Œå¹¶å¤„ç†ç³»ç»Ÿå‚æ•°èµ‹å€¼ç»™cpuç›¸å…³
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>	<span class="no">runtime</span><span class="err">Â·</span><span class="no">args</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># è·å–CPUæ ¸æ•°ä¿å­˜åœ¨ncpuä¸­ï¼Œè·å–physHugePageSizeå‚æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># physHugePageSize æ˜¯åˆ†é…å¤§é¡µé¢æ—¶å€™è¢«ç”¨åˆ°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>	<span class="no">runtime</span><span class="err">Â·</span><span class="no">osinit</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>		<span class="c1"># æ‰§è¡Œçš„ç»“æœæ˜¯å…¨å±€å˜é‡ncpu = CPUæ ¸æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>	<span class="no">runtime</span><span class="err">Â·</span><span class="no">schedinit</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>	<span class="c1"># è°ƒåº¦ç³»ç»Ÿåˆå§‹åŒ–
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="argssb-"><code>args(SB) </code><a hidden class="anchor" aria-hidden="true" href="#argssb-">#</a></h3>
<ol>
<li>å…³äº argv çš„åˆ†å¸ƒå›¾ã€‚
<ul>
<li><code>argv</code>ï¼šæ˜¯ä¸€ä¸ªæŒ‡å‘å­—ç¬¦æŒ‡é’ˆçš„æŒ‡é’ˆæ•°ç»„ï¼Œå…¶ä¸­æ¯ä¸ªå­—ç¬¦æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªä»¥ null ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œè¿™äº›å­—ç¬¦ä¸²ä»£è¡¨äº†ç¨‹åºå¯åŠ¨æ—¶åœ¨å‘½ä»¤è¡Œä¸Šè¾“å…¥çš„å‚æ•°ã€‚æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´  argv[0] é€šå¸¸åŒ…å«äº†ç¨‹åºçš„åç§°æˆ–è·¯å¾„ï¼Œè€Œéšåçš„å…ƒç´  argv[1] åˆ° argv[argc-1] åŒ…å«äº†ç¨‹åºçš„å®é™…å‚æ•°ã€‚</li>
<li><code>envp</code>ï¼šæ˜¯ä¸€ä¸ªæŒ‡å‘ç¯å¢ƒå˜é‡çš„æŒ‡é’ˆæ•°ç»„ï¼Œè¿™äº›ç¯å¢ƒå˜é‡åœ¨ç¨‹åºå¯åŠ¨æ—¶ç”±æ“ä½œç³»ç»Ÿä¼ é€’ç»™ç¨‹åºã€‚æ¯ä¸ªæ•°ç»„å…ƒç´ éƒ½æ˜¯ä¸€ä¸ªä»¥ null ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºä¸€ä¸ªé”®å€¼å¯¹ï¼Œå…¶ä¸­é”®å’Œå€¼ä¹‹é—´é€šè¿‡ç­‰å·(=)è¿æ¥ã€‚ç¯å¢ƒå˜é‡æ˜¯æ“ä½œç³»ç»Ÿç”¨æ¥å­˜å‚¨æœ‰å…³å½“å‰ä¼šè¯æˆ–æ‰§è¡Œç¯å¢ƒçš„ä¿¡æ¯çš„ä¸€ç§æ–¹å¼ã€‚å®ƒä»¬é€šå¸¸ç”¨äºé…ç½®ç¨‹åºçš„è¡Œä¸ºï¼Œæä¾›è·¯å¾„ä¿¡æ¯ï¼Œæˆ–è€…å­˜å‚¨ç”¨æˆ·ç‰¹å®šçš„è®¾ç½®ã€‚
<ul>
<li>ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ç¯å¢ƒå˜é‡åŠå…¶ç”¨é€”ï¼š
<ul>
<li>HOMEï¼šç”¨æˆ·çš„ä¸»ç›®å½•è·¯å¾„ã€‚</li>
<li>PATHï¼šæ‰§è¡Œå‘½ä»¤æ—¶è¦æœç´¢çš„ç›®å½•åˆ—è¡¨ã€‚</li>
<li>PWDï¼šå½“å‰å·¥ä½œç›®å½•çš„è·¯å¾„ã€‚</li>
<li>USERï¼šå½“å‰ç™»å½•çš„ç”¨æˆ·åã€‚</li>
<li>SHELLï¼šç”¨æˆ·ç™»å½•çš„ shell çš„è·¯å¾„ã€‚</li>
<li>LANGï¼šç³»ç»Ÿè¯­è¨€å’Œåœ°åŒºè®¾ç½®ã€‚</li>
<li>DISPLAYï¼šX Window System çš„æ˜¾ç¤ºå˜é‡ï¼Œç”¨äºå›¾å½¢ç•Œé¢ç¨‹åºã€‚</li>
<li>EDITORï¼šç”¨æˆ·çš„é¦–é€‰æ–‡æœ¬ç¼–è¾‘å™¨ã€‚</li>
<li>TERMï¼šç»ˆç«¯ç±»å‹ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><code>auxv</code>ï¼šä¸ºç¨‹åºæä¾›äº†å…³äºå…¶æ‰§è¡Œç¯å¢ƒçš„é¢å¤–ä¿¡æ¯ã€‚
<ul>
<li>ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ auxv æ¡ç›®ç±»å‹åŠå…¶å«ä¹‰ï¼š
<ul>
<li>AT_NULLï¼šæ ‡å¿—ç€ auxv æ•°ç»„çš„ç»“æŸã€‚</li>
<li>AT_EXECFDï¼šæ‰§è¡Œæ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</li>
<li>AT_PHDRï¼šç¨‹åºå¤´è¡¨çš„åœ°å€ã€‚</li>
<li>AT_PHENTï¼šç¨‹åºå¤´è¡¨ä¸­æ¯ä¸ªæ¡ç›®çš„å¤§å°ã€‚</li>
<li>AT_PHNUMï¼šç¨‹åºå¤´è¡¨ä¸­çš„æ¡ç›®æ•°é‡ã€‚</li>
<li>AT_PAGESZï¼šç³»ç»Ÿçš„é¡µé¢å¤§å°ã€‚</li>
<li>AT_BASEï¼šåŠ¨æ€é“¾æ¥å™¨çš„åŸºåœ°å€ã€‚</li>
<li>AT_ENTRYï¼šç¨‹åºçš„å…¥å£ç‚¹åœ°å€ã€‚</li>
<li>AT_UIDï¼šæ‰§è¡Œç¨‹åºçš„ç”¨æˆ·çš„çœŸå®ç”¨æˆ· IDã€‚</li>
<li>AT_EUIDï¼šæ‰§è¡Œç¨‹åºçš„æœ‰æ•ˆç”¨æˆ· IDã€‚</li>
<li>AT_GIDï¼šæ‰§è¡Œç¨‹åºçš„ç»„ IDã€‚</li>
<li>AT_EGIDï¼šæ‰§è¡Œç¨‹åºçš„æœ‰æ•ˆç»„ IDã€‚</li>
<li>AT_SECUREï¼šæŒ‡ç¤ºç¨‹åºæ˜¯å¦åœ¨ â€œsecure modeâ€ ä¸‹æ‰§è¡Œã€‚</li>
<li>AT_RANDOMï¼šæä¾›éšæœºå€¼çš„æŒ‡é’ˆï¼Œç”¨äºå®‰å…¨ç›®çš„ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><img loading="lazy" src="../images/goroutine-006.png" alt=""  />
</p>
<ol start="2">
<li>æš‚å­˜å‘½ä»¤è¡Œå‚æ•°ä»¥å¾…åç»­è§£æã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/runtime1.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">args</span><span class="p">(</span><span class="nx">c</span> <span class="kt">int32</span><span class="p">,</span> <span class="nx">v</span> <span class="o">**</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¿å­˜ argc å’Œ argv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">argc</span> <span class="p">=</span> <span class="nx">c</span> <span class="c1">// runtimeçš„å…¨å±€å˜é‡ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">argv</span> <span class="p">=</span> <span class="nx">v</span> <span class="c1">// runtimeçš„å…¨å±€å˜é‡ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åŠ è½½ auxv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">sysargs</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">argc</span> <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">argv</span> <span class="o">**</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="sysargs">sysargs()<a hidden class="anchor" aria-hidden="true" href="#sysargs">#</a></h4>
<ol>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/os_linux.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">sysargs</span><span class="p">(</span><span class="nx">argc</span> <span class="kt">int32</span><span class="p">,</span> <span class="nx">argv</span> <span class="o">**</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è·³è¿‡ argv + NULL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">n</span> <span class="o">:=</span> <span class="nx">argc</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// skip over argv, envp to get to auxv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è·³è¿‡ argv å’Œ envp ç›´æ¥åˆ° auxv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nf">argv_index</span><span class="p">(</span><span class="nx">argv</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">n</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// skip NULL separator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">n</span><span class="o">++</span> <span class="c1">// è·³è¿‡ NULL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// now argv+n is auxv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// argv+n åç°åœ¨æ˜¯ auxvã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">auxv</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">]</span><span class="kt">uintptr</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">argv</span><span class="p">),</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span><span class="o">*</span><span class="nx">goarch</span><span class="p">.</span><span class="nx">PtrSize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nf">sysauxv</span><span class="p">(</span><span class="nx">auxv</span><span class="p">[:])</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// In some situations we don&#39;t get a loader-provided
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// auxv, such as when loaded as a library on Android.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Fall back to /proc/self/auxv.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ä¼šå¾—åˆ°åŠ è½½å™¨æä¾›çš„auxvï¼Œæ¯”å¦‚åœ¨Androidä¸Šä½œä¸ºåº“åŠ è½½æ—¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å›åˆ° /proc/self/auxvï¼Œå»åŠ è½½ä¿¡æ¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// var procAuxv []byte = []byte(&#34;/proc/self/auxv\x00&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fd</span> <span class="o">:=</span> <span class="nf">open</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">procAuxv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span> <span class="cm">/* O_RDONLY */</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// æ‰“å¼€æŒ‡å®šæ–‡ä»¶å¥æŸ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">fd</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// On Android, /proc/self/auxv might be unreadable (issue 9229), so we fallback to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// try using mincore to detect the physical page size.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// mincore should return EINVAL when address is not a multiple of system page size.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">const</span> <span class="nx">size</span> <span class="p">=</span> <span class="mi">256</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span> <span class="c1">// size of memory region to allocate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">mmap</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">_PROT_READ</span><span class="p">|</span><span class="nx">_PROT_WRITE</span><span class="p">,</span> <span class="nx">_MAP_ANON</span><span class="p">|</span><span class="nx">_MAP_PRIVATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">n</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">n</span> <span class="p">=</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="nx">size</span><span class="p">;</span> <span class="nx">n</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">err</span> <span class="o">:=</span> <span class="nf">mincore</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span><span class="o">+</span><span class="nx">n</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">addrspace_vec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">physPageSize</span> <span class="p">=</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">physPageSize</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">physPageSize</span> <span class="p">=</span> <span class="nx">size</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">munmap</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">buf</span> <span class="p">[</span><span class="mi">128</span><span class="p">]</span><span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»å½“å‰æ–‡ä»¶ä¸­è¯»å–ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">n</span> <span class="p">=</span> <span class="nf">read</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span> <span class="nf">noescape</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">buf</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="nf">closefd</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span> <span class="c1">// å…³é—­æ–‡ä»¶å¥æŸ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Make sure buf is terminated, even if we didn&#39;t read
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the whole file.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç¡®ä¿bufè¢«ç»ˆæ­¢ï¼Œå³ä½¿æˆ‘ä»¬æ²¡æœ‰è¯»å–æ•´ä¸ªæ–‡ä»¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">buf</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="p">=</span> <span class="nx">_AT_NULL</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sysauxv</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:])</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="argv_index">argv_index()<a hidden class="anchor" aria-hidden="true" href="#argv_index">#</a></h4>
<ol>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/runtime1.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// nosplit for use in linux startup sysargs
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">argv_index</span><span class="p">(</span><span class="nx">argv</span> <span class="o">**</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">i</span> <span class="kt">int32</span><span class="p">)</span> <span class="o">*</span><span class="kt">byte</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="o">**</span><span class="kt">byte</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">argv</span><span class="p">),</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span><span class="o">*</span><span class="nx">goarch</span><span class="p">.</span><span class="nx">PtrSize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="sysauxv">sysauxv()<a hidden class="anchor" aria-hidden="true" href="#sysauxv">#</a></h4>
<ol>
<li>è®¾ç½® <code>startupRandomData</code> ç”¨äº<code>Hash</code>ï¼Œ<code>physPageSize</code> ç‰©ç†å†…å­˜é¡µå¤§å°ï¼Œå¦‚æœè¿™äº›å­˜åœ¨çš„æƒ…å†µä¸‹ã€‚</li>
<li>è®¾ç½®å…¨å±€å˜é‡ç‰©ç†é¡µé¢å¤§å°ç­‰ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/os_linux.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">sysauxv</span><span class="p">(</span><span class="nx">auxv</span> <span class="p">[]</span><span class="kt">uintptr</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">i</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// éå†auxvç›´åˆ°ç»“æŸ _AT_NULLï¼Œä¸€æ¬¡æ€§å–ä¸¤ä¸ªåˆ†åˆ«æ˜¯ tag å’Œ val
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">;</span> <span class="nx">auxv</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">_AT_NULL</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">2</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">tag</span><span class="p">,</span> <span class="nx">val</span> <span class="o">:=</span> <span class="nx">auxv</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">auxv</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="nx">tag</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">_AT_RANDOM</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// The kernel provides a pointer to 16-bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// worth of random data.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å†…æ ¸æä¾›äº†ä¸€ä¸ªæŒ‡å‘16å­—èŠ‚éšæœºæ•°æ®çš„æŒ‡é’ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// startupRandomDataä¿å­˜åœ¨å¯åŠ¨æ—¶åˆå§‹åŒ–çš„éšæœºå­—èŠ‚ã€‚è¿™äº›æ¥è‡ªELF AT_RANDOMè¾…åŠ©å‘é‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">startupRandomData</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="kt">byte</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">val</span><span class="p">))[:]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">_AT_PAGESZ</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">physPageSize</span> <span class="p">=</span> <span class="nx">val</span> <span class="c1">// å¦‚æœæ˜¯ç‰©ç†é¡µå¤§å°è®¾ç½®è¯¥å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">archauxv</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="c1">// è¯¥å‡½æ•°åœ¨linuxä¸‹æ˜¯ç©º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">vdsoauxv</span><span class="p">(</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="c1">// å¤„ç† vdso
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">i</span> <span class="o">/</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="osinitsb">osinit(SB)<a hidden class="anchor" aria-hidden="true" href="#osinitsb">#</a></h3>
<ol>
<li><code>runtime.osinit()</code>å‡½æ•°ä¸­ï¼Œæ‰€æœ‰çš„ç³»ç»Ÿéƒ½ä¼šåœ¨è¿™é‡Œè·å–<code>CPU</code>æ ¸å¿ƒæ•°ï¼Œå¦‚æœä¸Šä¸€æ­¥<code>runtime.args()</code>æ²¡æœ‰æˆåŠŸè·å–ç‰©ç†é¡µé¢å¤§å°ï¼Œåˆ™éƒ¨åˆ†ç³»ç»Ÿä¼šå†æ¬¡è·å–ã€‚<code>Linux</code>ç³»ç»Ÿä¼šåœ¨è¿™é‡Œè·å–<code>Huge</code>ç‰©ç†é¡µé¢çš„å¤§å°ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/os_linux.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">osinit</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å– CPU æ ¸æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ncpu</span> <span class="p">=</span> <span class="nf">getproccount</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å–Linuxä¸­ç‰©ç†å†…å­˜å¤§é¡µé¢å¤§å°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¤§é¡µé¢æ˜¯æŒ‡æ¯”æ™®é€šé¡µé¢ï¼ˆé€šå¸¸ä¸º 4KBï¼‰æ›´å¤§çš„é¡µé¢å¤§å°ï¼Œé€šå¸¸ä¸º 2MB æˆ– 1GBã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä½¿ç”¨å¤§é¡µé¢å¯ä»¥æé«˜å†…å­˜è®¿é—®æ•ˆç‡å’Œç³»ç»Ÿæ€§èƒ½ï¼Œå› ä¸ºåœ¨ä½¿ç”¨å¤§é¡µé¢æ—¶ï¼Œå†…æ ¸éœ€è¦ç®¡ç†æ›´å°‘çš„é¡µè¡¨å’Œ TLB æ¡ç›®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¯¥æ–¹æ³•é€šè¿‡openå»&#34;/sys/kernel/mm/transparent_hugepage/hpage_pmd_size&#34;è·¯å¾„è¯»å–çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">physHugePageSize</span> <span class="p">=</span> <span class="nf">getHugePageSize</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">iscgo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// #42494 glibc and musl reserve some signals for
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// internal use and require they not be blocked by
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// the rest of a normal C runtime. When the go runtime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// blocks...unblocks signals, temporarily, the blocked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// interval of time is generally very short. As such,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// these expectations of *libc code are mostly met by
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// the combined go+cgo system of threads. However,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// when go causes a thread to exit, via a return from
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// mstart(), the combined runtime can deadlock if
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// these signals are blocked. Thus, don&#39;t block these
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// signals when exiting threads.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// - glibc: SIGCANCEL (32), SIGSETXID (33)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// - musl: SIGTIMER (32), SIGCANCEL (33), SIGSYNCCALL (34)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">sigdelset</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sigsetAllExiting</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sigdelset</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sigsetAllExiting</span><span class="p">,</span> <span class="mi">33</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sigdelset</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sigsetAllExiting</span><span class="p">,</span> <span class="mi">34</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">osArchInit</span><span class="p">()</span> <span class="c1">// linuxä¸Šè¯¥å‡½æ•°ä¸ºç©º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="è·å–cpuæ ¸æ•°">è·å–cpuæ ¸æ•°<a hidden class="anchor" aria-hidden="true" href="#è·å–cpuæ ¸æ•°">#</a></h4>
<ol>
<li>è¿™æ®µä»£ç é€šè¿‡è°ƒç”¨æ“ä½œç³»ç»Ÿçš„sched_getaffinityç³»ç»Ÿè°ƒç”¨æ¥è·å–å½“å‰è¿›ç¨‹çš„CPUäº²å’ŒåŠ›æ©ç ï¼Œè¿™ä¸ªæ©ç æ˜¯ä¸€ä¸ªä½å›¾ï¼Œå…¶ä¸­æ¯ä¸ªæ¯”ç‰¹ä½å¯¹åº”ä¸€ä¸ªCPUæ ¸å¿ƒã€‚å¦‚æœæŸä¸ªæ¯”ç‰¹ä½ä¸º1ï¼Œåˆ™è¡¨ç¤ºå¯¹åº”çš„CPUæ ¸å¿ƒæ˜¯å¯ç”¨çš„ã€‚ä»£ç é€šè¿‡éå†è¿™ä¸ªä½å›¾å¹¶è®¡ç®—ä¸º1çš„æ¯”ç‰¹ä½çš„æ•°é‡æ¥å¾—åˆ°å¯ç”¨çš„CPUæ ¸å¿ƒæ•°ã€‚è¿™æ˜¯ä¸€ä¸ªé«˜æ•ˆçš„æ–¹å¼æ¥è·å–ç³»ç»Ÿèµ„æºä¿¡æ¯ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦æ ¹æ®æ ¸å¿ƒæ•°æ¥è°ƒæ•´ç¨‹åºå¹¶è¡Œåº¦çš„åœºæ™¯ä¸­ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/os_linux.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">getproccount</span><span class="p">()</span> <span class="kt">int32</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// This buffer is huge (8 kB) but we are on the system stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// and there should be plenty of space (64 kB).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Also this is a leaf, so we&#39;re not holding up the memory for long.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// See golang.org/issue/11823.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// The suggested behavior here is to keep trying with ever-larger
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// buffers, but we don&#39;t have a dynamic memory allocator at the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// moment, so that&#39;s a bit tricky and seems like overkill.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™ä¸ªç¼“å†²åŒºå¾ˆå¤§(8 kB)ï¼Œä½†æˆ‘ä»¬åœ¨ç³»ç»Ÿå †æ ˆä¸Šï¼Œåº”è¯¥æœ‰è¶³å¤Ÿçš„ç©ºé—´(64 kB)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è€Œä¸”è¿™æ˜¯ä¸€ä¸ªå¶å­ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ä¼šå ç”¨å†…å­˜å¾ˆé•¿æ—¶é—´ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œå»ºè®®çš„è¡Œä¸ºæ˜¯ç»§ç»­å°è¯•ä½¿ç”¨æ›´å¤§çš„ç¼“å†²åŒºï¼Œä½†æˆ‘ä»¬ç›®å‰æ²¡æœ‰åŠ¨æ€å†…å­˜åˆ†é…å™¨ï¼Œæ‰€ä»¥è¿™æœ‰ç‚¹æ£˜æ‰‹ï¼Œä¼¼ä¹æœ‰ç‚¹è¿‡åº¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å®šä¹‰äº†ä¸€ä¸ªå¸¸é‡maxCPUsï¼Œå€¼ä¸º65536ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™ä¸ªå€¼å¹¶ä¸æ˜¯çœŸæ­£çš„CPUæ ¸å¿ƒæ•°ï¼Œè€Œæ˜¯ä¸€ä¸ªé¢„å®šä¹‰çš„æœ€å¤§å€¼ï¼Œç”¨äºç¡®å®šç¼“å†²åŒºå¤§å°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">const</span> <span class="nx">maxCPUs</span> <span class="p">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span> <span class="c1">// 65536
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å®šä¹‰äº†ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡bufï¼Œå¤§å°ä¸º8192å­—èŠ‚ï¼ˆå³8KBï¼‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™æ˜¯å› ä¸ºæ¯ä¸ªCPUæ ¸å¿ƒå¯ä»¥ç”¨ä¸€ä¸ªæ¯”ç‰¹ä½è¡¨ç¤ºï¼Œæ‰€ä»¥8192å­—èŠ‚å¯ä»¥è¡¨ç¤º65536ä¸ªæ¯”ç‰¹ä½ï¼Œå¯¹åº”maxCPUsä¸ªCPUæ ¸å¿ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">buf</span> <span class="p">[</span><span class="nx">maxCPUs</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span><span class="kt">byte</span> <span class="c1">// 8KB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™è¡Œä»£ç æ˜¯æ ¸å¿ƒï¼Œå®ƒè°ƒç”¨äº†æ“ä½œç³»ç»Ÿæä¾›çš„sched_getaffinityç³»ç»Ÿè°ƒç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ç”¨äºè·å–ç»™å®šè¿›ç¨‹IDï¼ˆè¿™é‡Œæ˜¯0ï¼Œè¡¨ç¤ºå½“å‰è¿›ç¨‹ï¼‰çš„CPUäº²å’ŒåŠ›æ©ç ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. ç¬¬ä¸€ä¸ªå‚æ•°0è¡¨ç¤ºå½“å‰è¿›ç¨‹çš„è¿›ç¨‹IDã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. ç¬¬äºŒä¸ªå‚æ•°æ˜¯ç¼“å†²åŒºbufçš„å¤§å°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  3. ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ç¼“å†²åŒºçš„æŒ‡é’ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ræ˜¯ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ï¼Œå®ƒè¡¨ç¤ºå®é™…å†™å…¥ç¼“å†²åŒºçš„å­—èŠ‚æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">r</span> <span class="o">:=</span> <span class="nf">sched_getaffinity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">buf</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">// int32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœç³»ç»Ÿè°ƒç”¨è¿”å›è´Ÿå€¼ï¼Œè¡¨ç¤ºå‘ç”Ÿäº†é”™è¯¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‡½æ•°è¿”å›1ï¼Œè¿™å¯èƒ½æ„å‘³ç€è‡³å°‘æœ‰ä¸€ä¸ªCPUæ ¸å¿ƒæ˜¯å¯ç”¨çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">r</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">n</span> <span class="o">:=</span> <span class="nb">int32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// éå†ç¼“å†²åŒºç›´åˆ°å®é™…å†™å…¥çš„å­—èŠ‚æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™æ®µä»£ç å®é™…ä¸Šæ˜¯åœ¨è®¡ç®—ç¼“å†²åŒºä¸­è®¾ç½®ä¸º1çš„æ¯”ç‰¹ä½çš„æ•°é‡ï¼Œæ¯ä¸ªä¸º1çš„æ¯”ç‰¹ä½ä»£è¡¨ä¸€ä¸ªå¯ç”¨çš„CPUæ ¸å¿ƒã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">buf</span><span class="p">[:</span><span class="nx">r</span><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¯¹äºç¼“å†²åŒºçš„æ¯ä¸ªå­—èŠ‚ï¼Œå¦‚æœå®ƒä¸ä¸º0ï¼Œåˆ™è¿›è¡Œå¤„ç†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="nx">v</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// é€šè¿‡æ£€æŸ¥æ¯ä¸ªæ¯”ç‰¹ä½æ˜¯å¦ä¸º1æ¥è®¡ç®—æ ¸å¿ƒæ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿™é‡Œä½¿ç”¨äº†ä½è¿ç®—&amp;æ¥æ£€æŸ¥æœ€ä½ä½æ˜¯å¦ä¸º1ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å¢åŠ æ ¸å¿ƒæ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">n</span> <span class="o">+=</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">v</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å°†å­—èŠ‚å³ç§»ä¸€ä½ï¼Œç»§ç»­æ£€æŸ¥ä¸‹ä¸€ä¸ªæ¯”ç‰¹ä½ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">v</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// n = 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœè®¡ç®—å¾—å‡ºçš„æ ¸å¿ƒæ•°ä¸º0ï¼ˆè¿™å¯èƒ½æ˜¯ä¸€ä¸ªé”™è¯¯çš„æƒ…å†µï¼‰ï¼Œåˆ™é»˜è®¤è®¾ç½®ä¸º1ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">n</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å‡½æ•°è¿”å›è®¡ç®—å‡ºçš„CPUæ ¸å¿ƒæ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>sched_getaffinity å‡½æ•°åŸå‹ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/os_linux.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">448
</span><span class="lnt">449
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:noescape
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">sched_getaffinity</span><span class="p">(</span><span class="nx">pid</span><span class="p">,</span> <span class="nx">len</span> <span class="kt">uintptr</span><span class="p">,</span> <span class="nx">buf</span> <span class="o">*</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">int32</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>æ±‡ç¼–æ–‡ä»¶åœ°å€ï¼š<code>go1.19.3/src/runtime/sys_linux_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">sched_getaffinity</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="p">,</span><span class="no">$0</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ç¬¬ä¸€ä¸ªå‚æ•° pid ä¸º 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">pid</span><span class="err">+</span><span class="mi">0</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">DI</span>	
</span></span><span class="line"><span class="cl">    <span class="c1"># ç¬¬äºŒä¸ªå‚æ•° len å ç”¨å†…å­˜å¤§å°å­—èŠ‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">len</span><span class="err">+</span><span class="mi">8</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">SI</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ç¬¬ä¸‰ä¸ªå‚æ•° buf *byte æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">buf</span><span class="err">+</span><span class="mi">16</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">DX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">$SYS_sched_getaffinity</span><span class="p">,</span> <span class="no">AX</span> <span class="c1"># $SYS_sched_getaffinity = 204
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">SYSCALL</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">ret</span><span class="err">+</span><span class="mi">24</span><span class="p">(</span><span class="no">FP</span><span class="p">)</span> <span class="c1"># ä¿å­˜è¿”å›å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="è·å–ç‰©ç†å†…å­˜é¡µå¤§å°">è·å–ç‰©ç†å†…å­˜é¡µå¤§å°<a hidden class="anchor" aria-hidden="true" href="#è·å–ç‰©ç†å†…å­˜é¡µå¤§å°">#</a></h4>
<ol>
<li>è¿™æ®µä»£ç é€šè¿‡è¯»å–æ“ä½œç³»ç»Ÿæ–‡ä»¶/sys/kernel/mm/transparent_hugepage/hpage_pmd_sizeæ¥è·å–é€æ˜å¤§é¡µçš„å¤§å°ã€‚</li>
<li>è¿™ä¸ªæ–‡ä»¶é€šå¸¸åŒ…å«ä¸€ä¸ªæ•´æ•°ï¼Œè¡¨ç¤ºé€æ˜å¤§é¡µçš„å¤§å°ï¼ˆé€šå¸¸æ˜¯2çš„å¹‚ï¼‰ã€‚ä»£ç é€šè¿‡æ ‡å‡†çš„æ–‡ä»¶æ‰“å¼€ã€è¯»å–å’Œå…³é—­æ“ä½œæ¥è·å–è¿™ä¸ªå€¼ï¼Œå¹¶è¿›è¡Œäº†ä¸€äº›åŸºæœ¬çš„é”™è¯¯å¤„ç†å’ŒéªŒè¯ï¼Œä»¥ç¡®ä¿è¿”å›çš„æ˜¯ä¸€ä¸ªåˆç†çš„é¡µå¤§å°ã€‚å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ã€æ— æ³•è¯»å–æˆ–å†…å®¹ä¸ç¬¦åˆé¢„æœŸï¼Œå‡½æ•°å°†è¿”å›0ã€‚è¿”å›å€¼uintptræ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•´æ•°ç±»å‹ï¼Œè¶³ä»¥å­˜å‚¨å†…å­˜é¡µå¤§å°ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// å®šä¹‰äº†ä¸€ä¸ªå­—èŠ‚åˆ‡ç‰‡sysTHPSizePathï¼Œå…¶ä¸­åŒ…å«äº†é€æ˜å¤§é¡µå¤§å°çš„é…ç½®æ–‡ä»¶è·¯å¾„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">// æœ«å°¾çš„\x00æ˜¯ç©ºå­—ç¬¦ï¼Œç”¨äºå­—ç¬¦ä¸²çš„ç»ˆæ­¢ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">sysTHPSizePath</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;/sys/kernel/mm/transparent_hugepage/hpage_pmd_size\x00&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">getHugePageSize</span><span class="p">()</span> <span class="kt">uintptr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">numbuf</span> <span class="p">[</span><span class="mi">20</span><span class="p">]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒç”¨openå‡½æ•°ä»¥åªè¯»æ¨¡å¼æ‰“å¼€ä¸Šè¿°è·¯å¾„æŒ‡å®šçš„æ–‡ä»¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºåªè¯»æ¨¡å¼ï¼ˆO_RDONLYï¼‰ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯æ¨¡å¼ï¼Œè¿™é‡Œä¼ 0è¡¨ç¤ºä¸éœ€è¦ç‰¹æ®Šçš„æ–‡ä»¶æƒé™ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fd</span> <span class="o">:=</span> <span class="nf">open</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sysTHPSizePath</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span> <span class="cm">/* O_RDONLY */</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœopenå‡½æ•°è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦å°äº0ï¼Œè¡¨ç¤ºæ‰“å¼€æ–‡ä»¶å¤±è´¥ï¼Œå‡½æ•°è¿”å›0ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">fd</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä½¿ç”¨noescapeå‡½æ•°æ¥é˜²æ­¢ptré€ƒé€¸åˆ°å †ä¸Šï¼Œunsafe.Pointerå°†numbufæ•°ç»„çš„åœ°å€è½¬æ¢ä¸ºæŒ‡é’ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ptr</span> <span class="o">:=</span> <span class="nf">noescape</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">numbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒç”¨readå‡½æ•°ä»æ–‡ä»¶æè¿°ç¬¦fdè¯»å–å†…å®¹åˆ°numbufæ•°ç»„ä¸­ï¼Œæœ€å¤šè¯»å–numbufçš„é•¿åº¦ä¸ªå­—èŠ‚ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">n</span> <span class="o">:=</span> <span class="nf">read</span><span class="p">(</span><span class="nx">fd</span><span class="p">,</span> <span class="nx">ptr</span><span class="p">,</span> <span class="nb">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">numbuf</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¯»å–å®Œæˆåå…³é—­æ–‡ä»¶æè¿°ç¬¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">closefd</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœè¯»å–çš„å­—èŠ‚æ•°å°äºæˆ–ç­‰äº0ï¼Œè¡¨ç¤ºè¯»å–å¤±è´¥æˆ–æ–‡ä»¶ä¸ºç©ºï¼Œå‡½æ•°è¿”å›0ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">n</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å‡å»1ï¼Œä»¥ç§»é™¤è¯»å–åˆ°çš„å­—ç¬¦ä¸²æœ«å°¾çš„æ¢è¡Œç¬¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">n</span><span class="o">--</span> <span class="c1">// remove trailing newline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å°†è¯»å–åˆ°çš„å­—èŠ‚è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œç„¶åä½¿ç”¨atoiå‡½æ•°å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•´æ•°ã€‚okè¡¨ç¤ºè½¬æ¢æ˜¯å¦æˆåŠŸã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">v</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nf">atoi</span><span class="p">(</span><span class="nf">slicebytetostringtmp</span><span class="p">((</span><span class="o">*</span><span class="kt">byte</span><span class="p">)(</span><span class="nx">ptr</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="nx">n</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœè½¬æ¢å¤±è´¥æˆ–å¾—åˆ°çš„å€¼å°äº0ï¼Œåˆ™å°†vè®¾ç½®ä¸º0ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="o">||</span> <span class="nx">v</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">v</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ£€æŸ¥væ˜¯å¦ä¸º2çš„å¹‚ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸€ä¸ªæ•°æ˜¯2çš„å¹‚å½“ä¸”ä»…å½“å®ƒä¸å…¶è‡ªèº«å‡1çš„ä½ä¸ç»“æœä¸º0ã€‚å¦‚æœä¸æ˜¯2çš„å¹‚ï¼Œåˆ™è¿”å›0ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">v</span><span class="o">&amp;</span><span class="p">(</span><span class="nx">v</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// v is not a power of 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œå°†è¯»å–åˆ°çš„å€¼è½¬æ¢ä¸ºuintptrç±»å‹å¹¶è¿”å›ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="schedinitsb">schedinit(SB)<a hidden class="anchor" aria-hidden="true" href="#schedinitsb">#</a></h3>
<ol>
<li>åˆå§‹åŒ–è°ƒåº¦ç³»ç»Ÿï¼ŒåŠ è½½è¿‡ç¨‹ï¼š
<ol>
<li><strong><code>call osinit</code></strong>ï¼šè°ƒç”¨<code>osinit()</code>å‡½æ•°ï¼Œè®¾ç½®<code>runtime.ncpu</code>å’Œ<code>runtime.physHugePageSize</code>å‚æ•°çš„å€¼ã€‚</li>
<li><strong><code>call schedinit</code></strong>ï¼šè°ƒç”¨<code>schedinit()</code>å‡½æ•°ï¼Œåˆå§‹åŒ–è°ƒåº¦å™¨ã€‚</li>
<li><strong><code>make &amp; queue new G</code></strong>ï¼šåˆ›å»ºç¬¬ä¸€ä¸ª<code>main goroutine</code>ï¼Œå¹¶åŠ å…¥é˜Ÿåˆ—ã€‚</li>
<li><strong><code>call runtimeÂ·mstart</code></strong>ï¼šè°ƒç”¨<code>runtimeÂ·mstart()</code>å‡½æ•°å¼€å¯è°ƒåº¦å¾ªç¯ã€‚</li>
</ol>
</li>
<li>è¿™ä¸ªæ–°çš„<code>goroutine</code>è¿è¡Œ<code>runtime.main()</code>å‡½æ•°ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span><span class="lnt">671
</span><span class="lnt">672
</span><span class="lnt">673
</span><span class="lnt">674
</span><span class="lnt">675
</span><span class="lnt">676
</span><span class="lnt">677
</span><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span><span class="lnt">694
</span><span class="lnt">695
</span><span class="lnt">696
</span><span class="lnt">697
</span><span class="lnt">698
</span><span class="lnt">699
</span><span class="lnt">700
</span><span class="lnt">701
</span><span class="lnt">702
</span><span class="lnt">703
</span><span class="lnt">704
</span><span class="lnt">705
</span><span class="lnt">706
</span><span class="lnt">707
</span><span class="lnt">708
</span><span class="lnt">709
</span><span class="lnt">710
</span><span class="lnt">711
</span><span class="lnt">712
</span><span class="lnt">713
</span><span class="lnt">714
</span><span class="lnt">715
</span><span class="lnt">716
</span><span class="lnt">717
</span><span class="lnt">718
</span><span class="lnt">719
</span><span class="lnt">720
</span><span class="lnt">721
</span><span class="lnt">722
</span><span class="lnt">723
</span><span class="lnt">724
</span><span class="lnt">725
</span><span class="lnt">726
</span><span class="lnt">727
</span><span class="lnt">728
</span><span class="lnt">729
</span><span class="lnt">730
</span><span class="lnt">731
</span><span class="lnt">732
</span><span class="lnt">733
</span><span class="lnt">734
</span><span class="lnt">735
</span><span class="lnt">736
</span><span class="lnt">737
</span><span class="lnt">738
</span><span class="lnt">739
</span><span class="lnt">740
</span><span class="lnt">741
</span><span class="lnt">742
</span><span class="lnt">743
</span><span class="lnt">744
</span><span class="lnt">745
</span><span class="lnt">746
</span><span class="lnt">747
</span><span class="lnt">748
</span><span class="lnt">749
</span><span class="lnt">750
</span><span class="lnt">751
</span><span class="lnt">752
</span><span class="lnt">753
</span><span class="lnt">754
</span><span class="lnt">755
</span><span class="lnt">756
</span><span class="lnt">757
</span><span class="lnt">758
</span><span class="lnt">759
</span><span class="lnt">760
</span><span class="lnt">761
</span><span class="lnt">762
</span><span class="lnt">763
</span><span class="lnt">764
</span><span class="lnt">765
</span><span class="lnt">766
</span><span class="lnt">767
</span><span class="lnt">768
</span><span class="lnt">769
</span><span class="lnt">770
</span><span class="lnt">771
</span><span class="lnt">772
</span><span class="lnt">773
</span><span class="lnt">774
</span><span class="lnt">775
</span><span class="lnt">776
</span><span class="lnt">777
</span><span class="lnt">778
</span><span class="lnt">779
</span><span class="lnt">780
</span><span class="lnt">781
</span><span class="lnt">782
</span><span class="lnt">783
</span><span class="lnt">784
</span><span class="lnt">785
</span><span class="lnt">786
</span><span class="lnt">787
</span><span class="lnt">788
</span><span class="lnt">789
</span><span class="lnt">790
</span><span class="lnt">791
</span><span class="lnt">792
</span><span class="lnt">793
</span><span class="lnt">794
</span><span class="lnt">795
</span><span class="lnt">796
</span><span class="lnt">797
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// The bootstrap sequence is:
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//	call osinit
</span></span></span><span class="line"><span class="cl"><span class="c1">//	call schedinit
</span></span></span><span class="line"><span class="cl"><span class="c1">//	make &amp; queue new G
</span></span></span><span class="line"><span class="cl"><span class="c1">//	call runtimeÂ·mstart
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// The new G calls runtimeÂ·main.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">schedinit</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆå§‹åŒ–é”ï¼Œå¦‚æœæœ‰é”æ’åæƒ…å†µä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">,</span> <span class="nx">lockRankSched</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sysmonlock</span><span class="p">,</span> <span class="nx">lockRankSysmon</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">deferlock</span><span class="p">,</span> <span class="nx">lockRankDefer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sudoglock</span><span class="p">,</span> <span class="nx">lockRankSudog</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">deadlock</span><span class="p">,</span> <span class="nx">lockRankDeadlock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">paniclk</span><span class="p">,</span> <span class="nx">lockRankPanic</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">allglock</span><span class="p">,</span> <span class="nx">lockRankAllg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">allpLock</span><span class="p">,</span> <span class="nx">lockRankAllp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">reflectOffs</span><span class="p">.</span><span class="nx">lock</span><span class="p">,</span> <span class="nx">lockRankReflectOffs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">finlock</span><span class="p">,</span> <span class="nx">lockRankFin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">trace</span><span class="p">.</span><span class="nx">bufLock</span><span class="p">,</span> <span class="nx">lockRankTraceBuf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">trace</span><span class="p">.</span><span class="nx">stringsLock</span><span class="p">,</span> <span class="nx">lockRankTraceStrings</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">trace</span><span class="p">.</span><span class="nx">lock</span><span class="p">,</span> <span class="nx">lockRankTrace</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cpuprof</span><span class="p">.</span><span class="nx">lock</span><span class="p">,</span> <span class="nx">lockRankCpuprof</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">trace</span><span class="p">.</span><span class="nx">stackTab</span><span class="p">.</span><span class="nx">lock</span><span class="p">,</span> <span class="nx">lockRankTraceStackTab</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Enforce that this lock is always a leaf lock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// All of this lock&#39;s critical sections should be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// extremely short.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¼ºåˆ¶è¿™ä¸ªé”å§‹ç»ˆæ˜¯ä¸€ä¸ªå¶é”ã€‚æ‰€æœ‰é”çš„å…³é”®éƒ¨åˆ†éƒ½åº”è¯¥éå¸¸çŸ­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">memstats</span><span class="p">.</span><span class="nx">heapStats</span><span class="p">.</span><span class="nx">noPLock</span><span class="p">,</span> <span class="nx">lockRankLeafRank</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// raceinit must be the first call to race detector.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// In particular, it must be done before mallocinit below calls racemapshadow.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// getg()å‡½æ•°åœ¨æºä»£ç ä¸­æ²¡æœ‰å¯¹åº”çš„å®šä¹‰ï¼Œç”±ç¼–è¯‘å™¨æ’å…¥ç±»ä¼¼ä¸‹é¢ä¸¤è¡Œä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. get_tls(CX) =&gt; MOVQ TLS, CX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. MOVQ g(CX), BX;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// èµ·å§‹å°±æ˜¯ä»TLSä¸­å–å‡ºgoroutineï¼Œæ­¤æ—¶åº”è¯¥æ˜¯*g0ã€‚ä¹Ÿå°±æ˜¯&amp;m0.tls[0]é‡Œé¢å­˜å‚¨çš„å€¼*g0ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å‰é¢ä»£ç å¯çŸ¥ï¼Œg0çš„åœ°å€è¢«æ”¾å…¥äº†TLSä¸­ï¼Œå› æ­¤è¿™é‡Œä»TLSè·å–g0çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>   <span class="c1">// _g_ = &amp;g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_g_</span><span class="p">.</span><span class="nx">racectx</span><span class="p">,</span> <span class="nx">raceprocctx0</span> <span class="p">=</span> <span class="nf">raceinit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è®¾ç½®æœ€å¤šå¯åŠ¨10000ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯æœ€å¤š10000ä¸ªM
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sched</span><span class="p">.</span><span class="nx">maxmcount</span> <span class="p">=</span> <span class="mi">10000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// The world starts stopped.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨æ²¡æœ‰é”æ’åä¸‹ï¼Œè¯¥å‡½æ•°ä¸ºç©ºã€‚å› ä¸ºæ­¤æ—¶å°±åªæœ‰m0ä¸€ä¸ªçº¿ç¨‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨æœ‰é”æ’åä¸‹ï¼Œè¯¥å‡½æ•°æŠŠworldIsStoppedå…¨å±€å˜é‡è®¾ç½®ä¸º1ï¼Œå°±è¿”å›äº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">worldStopped</span><span class="p">()</span>  <span class="c1">// STW
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ ¡éªŒç¨‹åºçš„å„ä¸ªæ¨¡å—ï¼Œå› ä¸ºgolangæ”¯æŒsharedã€pluginç­‰buildæ¨¡å¼ï¼Œå¯èƒ½ä¼šæœ‰å¾ˆå¤šä¸ªäºŒè¿›åˆ¶æ¨¡å—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œä¼šæ ¡éªŒå„ä¸ªæ¨¡å—çš„ç¬¦å·ã€ABIç­‰ï¼Œç¡®ä¿æ¨¡å—é—´ä¸€è‡´ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">moduledataverify</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ ˆå†…å­˜åˆå§‹åŒ–ï¼Œstackpool å’Œ stackLarge åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// goroutineçš„æ ˆæ˜¯åŠ¨æ€åˆ†é…ã€åŠ¨æ€å¢é•¿çš„ï¼Œè¿™ä¸€æ­¥ä¼šåˆå§‹åŒ–ç”¨äºæ ˆåˆ†é…çš„å…¨å±€ç¼“å­˜æ± ï¼Œä»¥åŠç›¸å…³çš„é”ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">stackinit</span><span class="p">()</span> <span class="c1">// æ ˆå†…å­˜åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å †å†…å­˜åˆå§‹åŒ–ï¼ŒåŒ…æ‹¬åˆå§‹åŒ–mheapã€mcache0ä»¥åŠè®¾ç½®å †çš„arenaHint
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">mallocinit</span><span class="p">()</span>	
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿›è¡Œä¸CPUç›¸å…³çš„åˆå§‹åŒ–å·¥ä½œï¼Œæ£€æµ‹CPUæ˜¯å¦æ”¯æŒæŸäº›æŒ‡ä»¤é›†ï¼Œä»¥åŠæ ¹æ®GODEBUGç¯å¢ƒå˜é‡æ¥å¯ç”¨æˆ–ç¦ç”¨æŸäº›ç¡¬ä»¶ç‰¹æ€§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">cpuinit</span><span class="p">()</span>   <span class="c1">// must run before alginit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ ¹æ®CPUå¯¹AESç›¸å…³æŒ‡ä»¤çš„æ”¯æŒæƒ…å†µï¼Œé€‰æ‹©ä¸åŒå¾—Hashç®—æ³•ï¼Œæ‰€ä»¥å¿…é¡»åœ¨ cpuinit() åé¢è°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// mapã€hashå¿…é¡»åœ¨ alginit() å‡½æ•°è°ƒç”¨åæ‰å¯ä»¥ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">alginit</span><span class="p">()</span>   <span class="c1">// maps, hash, fastrand must not be used before this call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åˆå§‹åŒ– fastrandseedï¼Œåœ¨æ¥ä¸‹æ¥çš„mcommoninit()å‡½æ•°ä¸­è¢«ç”¨åˆ°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">fastrandinit</span><span class="p">()</span> <span class="c1">// must run before mcommoninit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åˆå§‹åŒ–m0ï¼Œå› ä¸ºä»å‰çš„ä»£ç æˆ‘ä»¬çŸ¥é“ g0-&gt;m=&amp;m0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸ºå½“å‰å·¥ä½œçº¿ç¨‹Måˆ†é…IDã€åˆå§‹åŒ–gsignalï¼Œå¹¶æŠŠMæ·»åŠ åˆ°allmå…¨å±€é“¾è¡¨ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¯¥å‡½æ•°åœ¨æ–°åˆ›å»ºå·¥ä½œçº¿ç¨‹æ—¶ä¹Ÿä¼šè°ƒç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">mcommoninit</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1">// m0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åŸºäºæ‰€æœ‰çš„å·²åŠ è½½æ¨¡å—ï¼Œæ„é€ ä¸€ä¸ªæ´»è·ƒæ¨¡å—åˆ‡ç‰‡ modulesSliceï¼Œå¹¶åˆå§‹åŒ–GCéœ€è¦çš„Maskæ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">modulesinit</span><span class="p">()</span>   <span class="c1">// provides activeModules
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Typelinksinitæ‰«ææ¥è‡ªé¢å¤–æ¨¡å—çš„ç±»å‹ï¼Œå¹¶æ„å»ºmoduledataç±»å‹æ˜ å°„ï¼Œç”¨äºæ¶ˆé™¤é‡å¤ç±»å‹æŒ‡é’ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åŸºäºæ´»è·ƒæ¨¡å—åˆ—è¡¨æ„å»ºæ¨¡å—çº§çš„typemapï¼Œå®ç°å…¨å±€èŒƒå›´å†…å¯¹ç±»å‹å…ƒæ•°æ®å»é‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">typelinksinit</span><span class="p">()</span> <span class="c1">// uses maps, activeModules
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// éå†æ´»è·ƒæ¨¡å—åˆ—è¡¨ï¼Œå°†ç¼–è¯‘å™¨é˜¶æ®µç”Ÿæˆçš„æ‰€æœ‰itabæ·»åŠ åˆ°itabTableä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¯¥å‡½æ•°ä¼šè°ƒç”¨itabAdd()å‡½æ•°ï¼Œæ¥å£çš„æ—¶å€™çŸ¥é“è¯¥å‡½æ•°ä¼šç”Ÿæˆ*itab
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">itabsinit</span><span class="p">()</span>     <span class="c1">// uses activeModules
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">stkobjinit</span><span class="p">()</span>    <span class="c1">// must run before GC starts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">sigsave</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">sigmask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">initSigmask</span> <span class="p">=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">sigmask</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œç¨‹åºä¸­é€šè¿‡os.Argså¾—åˆ°çš„å‚æ•°æ˜¯åœ¨è¿™é‡Œåˆå§‹åŒ–çš„ï¼ˆWindowsé™¤å¤–ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å­˜å…¥ argslice []string å˜é‡ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">goargs</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// è§£æç¯å¢ƒå˜é‡ï¼Œç¨‹åºä¸­é€šè¿‡os.Getenvè·å–çš„ç¯å¢ƒå˜é‡æ˜¯åœ¨è¿™é‡Œåˆå§‹åŒ–çš„ï¼ˆWindowsé™¤å¤–ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å­˜å…¥ envs []string å˜é‡ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">goenvs</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è§£æç¯å¢ƒå˜é‡GODEBUGï¼Œä¸ºruntimeå„ä¸ªè°ƒè¯•å‚æ•°èµ‹å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">parsedebugvars</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆå§‹åŒ–ä¸GCç›¸å…³çš„å‚æ•°ï¼Œæ ¹æ®ç¯å¢ƒå˜é‡GOGCè®¾ç½®gcpercent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">gcinit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span> <span class="c1">// è·å– mutex è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸Šæ¬¡ç½‘ç»œè½®è¯¢çš„æ—¶é—´ç‚¹ï¼Œè®¾ç½®ä¸ºå½“å‰æ—¶é—´ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sched</span><span class="p">.</span><span class="nx">lastpoll</span> <span class="p">=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nf">nanotime</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç³»ç»Ÿä¸­æœ‰å¤šå°‘æ ¸ï¼Œå°±åˆ›å»ºå’Œåˆå§‹åŒ–å¤šå°‘ä¸ªPç»“æ„ä½“å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">procs</span> <span class="o">:=</span> <span class="nx">ncpu</span>	<span class="c1">// ncpuè¯¥å€¼åœ¨runtime.osinitå‡½æ•°ä¸­è¢«è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœç¯å¢ƒå˜é‡æŒ‡å®šäº†GOMAXPROCSï¼Œåˆ™åˆ›å»ºæŒ‡å®šæ•°é‡çš„p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nf">atoi32</span><span class="p">(</span><span class="nf">gogetenv</span><span class="p">(</span><span class="s">&#34;GOMAXPROCS&#34;</span><span class="p">));</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">procs</span> <span class="p">=</span> <span class="nx">n</span>	
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// procresize åˆ›å»ºå’Œåˆå§‹åŒ–å…¨å±€å˜é‡allp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ ¹æ® CPU çš„æ ¸æ•°æˆ–ç¯å¢ƒå˜é‡GOMAXPROCç¡®å®šPçš„æ•°é‡ï¼Œè°ƒç”¨procresizeè¿›è¡Œè°ƒæ•´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// procresize è¿”å›nilè¡¨ç¤ºæ‰€æœ‰çš„Pä¸­æœ¬åœ°é˜Ÿåˆ—éƒ½æ²¡æœ‰å¯è¿è¡Œçš„goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">procresize</span><span class="p">(</span><span class="nx">procs</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;unknown runnable goroutine during bootstrap&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span> <span class="c1">// mutex è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// World is effectively started now, as P&#39;s can run.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">worldStarted</span><span class="p">()</span> <span class="c1">// Start World
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// For cgocheck &gt; 1, we turn on the write barrier at all times
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// and check all pointer writes. We can&#39;t do this until after
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// procresize because the write barrier needs a P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯¹äºcgocheck &gt; 1ï¼Œæˆ‘ä»¬åœ¨ä»»ä½•æ—¶å€™éƒ½æ‰“å¼€å†™å±éšœå¹¶æ£€æŸ¥æ‰€æœ‰çš„æŒ‡é’ˆå†™ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æˆ‘ä»¬ä¸èƒ½è¿™æ ·åšï¼Œç›´åˆ°procresizeä¹‹åï¼Œå› ä¸ºå†™å±éšœéœ€è¦ä¸€ä¸ªPã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">debug</span><span class="p">.</span><span class="nx">cgocheck</span> <span class="p">&gt;</span> <span class="mi">1</span> <span class="p">{</span> <span class="c1">// debug.cgocheckåœ¨parsedebugvars()å‡½æ•°ä¸­è¢«è®¾ç½®ä¸º1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å¼€å¯å†™å±éšœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">writeBarrier</span><span class="p">.</span><span class="nx">cgo</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="nx">writeBarrier</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆå§‹åŒ–æ‰€æœ‰Pä¸Šçš„å†™å±éšœç¼“å­˜åŒº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">p</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">allp</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">p</span><span class="p">.</span><span class="nx">wbBuf</span><span class="p">.</span><span class="nf">reset</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æœªçŸ¥ç¼–è¯‘ç‰ˆæœ¬æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">buildVersion</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Condition should never trigger. This code just serves
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// to ensure runtimeÂ·buildVersion is kept in the resulting binary.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ¡ä»¶åº”è¯¥æ°¸è¿œä¸ä¼šè§¦å‘ã€‚è¿™æ®µä»£ç åªæ˜¯ç”¨äºç¡®ä¿runtimeÂ·buildVersionä¿å­˜åœ¨ç»“æœäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">buildVersion</span> <span class="p">=</span> <span class="s">&#34;unknown&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">modinfo</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Condition should never trigger. This code just serves
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// to ensure runtimeÂ·modinfo is kept in the resulting binary.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ¡ä»¶åº”è¯¥æ°¸è¿œä¸ä¼šè§¦å‘ã€‚è¿™æ®µä»£ç åªæ˜¯ç”¨äºç¡®ä¿runtimeÂ·modinfoä¿å­˜åœ¨ç»“æœäºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">modinfo</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="mcommoninit">mcommoninit()<a hidden class="anchor" aria-hidden="true" href="#mcommoninit">#</a></h4>
<ol>
<li><code>getg()</code>è·å–å‡ºæ¥çš„æ˜¯<code>g0</code>ï¼Œç„¶åè°ƒç”¨<code>mcommoninit</code>å‡½æ•°å¯¹<code>m0(g0.m)</code>è¿›è¡Œå¿…è¦çš„åˆå§‹åŒ–ã€‚</li>
<li>é¢„åˆ†é…çš„<code>ID</code>å¯ä»¥ä½œä¸º<code>'id'</code>ä¼ é€’ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¼ é€’ -1 æ¥çœç•¥ï¼Œç³»ç»Ÿé»˜è®¤åˆ†é…ã€‚</li>
<li>è¯¥å‡½æ•°åœ¨<strong>æ–°åˆ›å»ºå·¥ä½œçº¿ç¨‹</strong>æ—¶ä¹Ÿä¼šè¢«è°ƒç”¨ï¼Œå› æ­¤å¯èƒ½ä¼šå‡ºç°ç«äº‰ã€‚</li>
<li>æ€»ç»“ï¼šè¯¥æ–¹æ³•ä¸»è¦ä¸ºå·¥ä½œçº¿ç¨‹åˆ†é…ï¼ˆæŒ‡å®šä¸€ä¸ªå”¯ä¸€<code>id</code>ï¼‰ï¼Œå¹¶åˆå§‹åŒ–<code>m</code>çš„ç›¸å…³å‚æ•°ï¼ŒæŠŠ<code>m</code>åŠ å…¥åˆ°å…¨å±€<code>allm</code>ä¸­ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">785
</span><span class="lnt">786
</span><span class="lnt">787
</span><span class="lnt">788
</span><span class="lnt">789
</span><span class="lnt">790
</span><span class="lnt">791
</span><span class="lnt">792
</span><span class="lnt">793
</span><span class="lnt">794
</span><span class="lnt">795
</span><span class="lnt">796
</span><span class="lnt">797
</span><span class="lnt">798
</span><span class="lnt">799
</span><span class="lnt">800
</span><span class="lnt">801
</span><span class="lnt">802
</span><span class="lnt">803
</span><span class="lnt">804
</span><span class="lnt">805
</span><span class="lnt">806
</span><span class="lnt">807
</span><span class="lnt">808
</span><span class="lnt">809
</span><span class="lnt">810
</span><span class="lnt">811
</span><span class="lnt">812
</span><span class="lnt">813
</span><span class="lnt">814
</span><span class="lnt">815
</span><span class="lnt">816
</span><span class="lnt">817
</span><span class="lnt">818
</span><span class="lnt">819
</span><span class="lnt">820
</span><span class="lnt">821
</span><span class="lnt">822
</span><span class="lnt">823
</span><span class="lnt">824
</span><span class="lnt">825
</span><span class="lnt">826
</span><span class="lnt">827
</span><span class="lnt">828
</span><span class="lnt">829
</span><span class="lnt">830
</span><span class="lnt">831
</span><span class="lnt">832
</span><span class="lnt">833
</span><span class="lnt">834
</span><span class="lnt">835
</span><span class="lnt">836
</span><span class="lnt">837
</span><span class="lnt">838
</span><span class="lnt">839
</span><span class="lnt">840
</span><span class="lnt">841
</span><span class="lnt">842
</span><span class="lnt">843
</span><span class="lnt">844
</span><span class="lnt">845
</span><span class="lnt">846
</span><span class="lnt">847
</span><span class="lnt">848
</span><span class="lnt">849
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Pre-allocated ID may be passed as &#39;id&#39;, or omitted by passing -1.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mcommoninit</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// &amp;g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// g0 stack won&#39;t make sense for user (and is not necessary unwindable).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// g0å †æ ˆå¯¹ç”¨æˆ·æ¥è¯´æ²¡æœ‰æ„ä¹‰(å¹¶ä¸”ä¸ä¸€å®šæ˜¯å¯æ’¤é”€çš„)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span> <span class="o">!=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">g0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">callers</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">createstack</span><span class="p">[:])</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å– mutex é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">id</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mp</span><span class="p">.</span><span class="nx">id</span> <span class="p">=</span> <span class="nx">id</span> <span class="c1">// ä½¿ç”¨ä¼ é€’æ¥çš„id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mp</span><span class="p">.</span><span class="nx">id</span> <span class="p">=</span> <span class="nf">mReserveID</span><span class="p">()</span> <span class="c1">// ç³»ç»Ÿåˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ ¹æ®mp.idå’Œfastrandseedç”Ÿæˆéšæœºhash
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">lo</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="nf">int64Hash</span><span class="p">(</span><span class="nb">uint64</span><span class="p">(</span><span class="nx">mp</span><span class="p">.</span><span class="nx">id</span><span class="p">),</span> <span class="nx">fastrandseed</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ ¹æ®cputicks()å’Œ^fastrandseedç”Ÿæˆéšæœºhashã€‚cputicks()æ˜¯å½“å‰CPUæ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">hi</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="nf">int64Hash</span><span class="p">(</span><span class="nb">uint64</span><span class="p">(</span><span class="nf">cputicks</span><span class="p">()),</span> <span class="p">^</span><span class="nx">fastrandseed</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœ lo å’Œ hi åˆšå¥½äº’è¡¥æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">lo</span><span class="p">|</span><span class="nx">hi</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">hi</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Same behavior as for 1.17.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// TODO: Simplify ths.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸‹é¢é€šè¿‡ uint32 çš„ lo å’Œ hi ç»„æˆä¸€ä¸ª(hi&lt;&lt;32 + lo)çš„uint64éšæœºå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› ä¸ºå†…å­˜å­˜å‚¨çš„åŸå› æ‰€ä»¥æœ‰ä»¥ä¸‹åˆ¤æ–­ï¼Œä»¥åŠæ•°æ®çš„æ“ä½œä¸ä¸€æ ·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">goarch</span><span class="p">.</span><span class="nx">BigEndian</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">        <span class="c1">// æ•°æ®å­˜å‚¨æ˜¯å¤§ç«¯å­˜å‚¨æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">mp</span><span class="p">.</span><span class="nx">fastrand</span> <span class="p">=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">lo</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">32</span> <span class="p">|</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">hi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ•°æ®å­˜å‚¨æ˜¯å°ç«¯å­˜å‚¨æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// linux x86èµ°è¿™é‡Œã€‚fastrandè¡¨ç¤ºMçš„éšæœºå€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">mp</span><span class="p">.</span><span class="nx">fastrand</span> <span class="p">=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">hi</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">32</span> <span class="p">|</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">lo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»ºä¿¡å·å¤„ç†çš„gsignalã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åˆ†é…ä¸€ä¸ª32KBå¤§å°çš„æ ˆï¼Œç„¶å mp.gsignal.m = mp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">mpreinit</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">gsignal</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è®¾ç½® mp.gsignal.stackguard1 = 0 + _StackGuard
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">mp</span><span class="p">.</span><span class="nx">gsignal</span><span class="p">.</span><span class="nx">stackguard1</span> <span class="p">=</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">gsignal</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">+</span> <span class="nx">_StackGuard</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Add to allm so garbage collector doesn&#39;t free g-&gt;m
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// when it is just in a register or thread-local storage.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mp</span><span class="p">.</span><span class="nx">alllink</span> <span class="p">=</span> <span class="nx">allm</span> <span class="c1">// mp.alllink ä¸ allm ç»‘å®š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// NumCgoCall() iterates over allm w/o schedlock,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// so we need to publish it safely.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">atomicstorep</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">allm</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">mp</span><span class="p">))</span> <span class="c1">// atomically allm = mp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span> <span class="c1">// mutex è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Allocate memory to hold a cgo traceback if the cgo call crashes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœcgoè°ƒç”¨å´©æºƒï¼Œåˆ†é…å†…å­˜ä¿å­˜cgoå›æº¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">iscgo</span> <span class="o">||</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;solaris&#34;</span> <span class="o">||</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;illumos&#34;</span> <span class="o">||</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;windows&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mp</span><span class="p">.</span><span class="nx">cgoCallers</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">cgoCallers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

<p><details >
  <summary markdown="span">mReserveID()</summary>
  <blockquote>
<ol>
<li>å‘ç³»ç»Ÿç”³è¯·<code>ID</code>ã€‚å°±æ˜¯é€’å¢çš„å€¼ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">769
</span><span class="lnt">770
</span><span class="lnt">771
</span><span class="lnt">772
</span><span class="lnt">773
</span><span class="lnt">774
</span><span class="lnt">775
</span><span class="lnt">776
</span><span class="lnt">777
</span><span class="lnt">778
</span><span class="lnt">779
</span><span class="lnt">780
</span><span class="lnt">781
</span><span class="lnt">782
</span><span class="lnt">783
</span><span class="lnt">784
</span><span class="lnt">785
</span><span class="lnt">786
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// mReserveID returns the next ID to use for a new m. This new m is immediately
</span></span></span><span class="line"><span class="cl"><span class="c1">// considered &#39;running&#39; by checkdead.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mReserveID</span><span class="p">()</span> <span class="kt">int64</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒç”¨è¯¥æ–¹æ³•æ—¶ sched.lock é”å¿…é¡»å·²è¢«æŒæœ‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// mnext å€¼å·²ç»æº¢å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">mnext</span><span class="o">+</span><span class="mi">1</span> <span class="p">&lt;</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">mnext</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runtime: thread ID overflow&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">id</span> <span class="o">:=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">mnext</span> <span class="c1">// åˆ†é…è¯¥å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sched</span><span class="p">.</span><span class="nx">mnext</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ£€æŸ¥æ˜¯å¦è¶…å‡ºè®¾ç½®çš„æœ€å¤§å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">checkmcount</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">id</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">759
</span><span class="lnt">760
</span><span class="lnt">761
</span><span class="lnt">762
</span><span class="lnt">763
</span><span class="lnt">764
</span><span class="lnt">765
</span><span class="lnt">766
</span><span class="lnt">767
</span><span class="lnt">768
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// sched.lock must be held.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">checkmcount</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// sched.maxmcount æœ€å¤§å€¼é»˜è®¤è¢«è®¾ç½®ä¸º 10000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">mcount</span><span class="p">()</span> <span class="p">&gt;</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">maxmcount</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;runtime: program exceeds &#34;</span><span class="p">,</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">maxmcount</span><span class="p">,</span> <span class="s">&#34;-thread limit\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;thread exhaustion&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">4490
</span><span class="lnt">4491
</span><span class="lnt">4492
</span><span class="lnt">4493
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mcount</span><span class="p">()</span> <span class="kt">int32</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// sched.nmfreed å·²é‡Šæ”¾çš„å·¥ä½œçº¿ç¨‹æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">sched</span><span class="p">.</span><span class="nx">mnext</span> <span class="o">-</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">nmfreed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>

</details></p>



<p><details >
  <summary markdown="span">mpreinit()</summary>
  <blockquote>
<ol>
<li>mpreinit ä¸ºgsignalåˆ†é…32KBæ ˆï¼Œå¹¶ç»‘å®šå½“å‰Mã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/os_linux.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Called to initialize a new m (including the bootstrap m).
</span></span></span><span class="line"><span class="cl"><span class="c1">// Called on the parent thread (main thread in case of bootstrap), can allocate memory.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mpreinit</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">gsignal</span> <span class="p">=</span> <span class="nf">malg</span><span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="c1">// Linux wants &gt;= 2K
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mp</span><span class="p">.</span><span class="nx">gsignal</span><span class="p">.</span><span class="nx">m</span> <span class="p">=</span> <span class="nx">mp</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>

</details></p>



<p><details >
  <summary markdown="span">atomicstorep()</summary>
  <blockquote>
<ol>
<li>atomicstorep åŸå­åœ°æ‰§è¡Œ <code>*ptr = new</code>ï¼Œå¹¶è°ƒç”¨ä¸€ä¸ªå†™å±éšœã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/atomic_pointer.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// atomicstorep performs *ptr = new atomically and invokes a write barrier.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">atomicstorep</span><span class="p">(</span><span class="nx">ptr</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">new</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœå¼€å¯äº†å†™å±éšœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">writeBarrier</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">atomicwb</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">ptr</span><span class="p">),</span> <span class="nx">new</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">atomic</span><span class="p">.</span><span class="nf">StorepNoWB</span><span class="p">(</span><span class="nf">noescape</span><span class="p">(</span><span class="nx">ptr</span><span class="p">),</span> <span class="nx">new</span><span class="p">)</span> <span class="c1">// *ptr = new
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>

</details></p>

<ol start="6">
<li>æ­¤æ—¶ï¼Œä¸»çº¿ç¨‹ï¼Œm0ï¼Œg0ä»¥åŠg0çš„æ ˆä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li>
</ol>
<p><img loading="lazy" src="../images/goroutine-007.png" alt=""  />
</p>
<h4 id="goargs">goargs()<a hidden class="anchor" aria-hidden="true" href="#goargs">#</a></h4>
<ol>
<li>ä¿å­˜<code>argv</code>å‚æ•°åˆ°<code>argslice</code>ä¸­ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/runtime1.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">goargs</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;windows&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç”³è¯·å‚æ•°éœ€è¦çš„å†…å­˜å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">argslice</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">argc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">int32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">argc</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// argv_index åœ¨7.1.2ä¸­åˆ—å‡ºï¼Œå°±æ˜¯åç§»iä¸ªå­—èŠ‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">argslice</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nf">gostringnocopy</span><span class="p">(</span><span class="nf">argv_index</span><span class="p">(</span><span class="nx">argv</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">envs</span> <span class="p">[]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">argslice</span> <span class="p">[]</span><span class="kt">string</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li><code>gostringnocopy</code>ç»„è£…æˆä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/string.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">gostringnocopy</span><span class="p">(</span><span class="nx">str</span> <span class="o">*</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// findnullå¯»æ‰¾åˆ°nullç»“æŸè¯†åˆ«å­—ç¬¦ä¸²é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ss</span> <span class="o">:=</span> <span class="nx">stringStruct</span><span class="p">{</span><span class="nx">str</span><span class="p">:</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">str</span><span class="p">),</span> <span class="nx">len</span><span class="p">:</span> <span class="nf">findnull</span><span class="p">(</span><span class="nx">str</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span> <span class="o">:=</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">string</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ss</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">s</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="goenvs">goenvs()<a hidden class="anchor" aria-hidden="true" href="#goenvs">#</a></h4>
<ol>
<li>è§£æç¯å¢ƒå˜é‡ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/os_linux.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">goenvs</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">goenvs_unix</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/runtime1.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">goenvs_unix</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO(austin): ppc64 in dynamic linking mode doesn&#39;t
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// guarantee env[] will immediately follow argv. Might cause
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// problems.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">n</span> <span class="o">:=</span> <span class="nb">int32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è·³è¿‡argv + NULLï¼Œåˆ°envpï¼Œè®¡ç®—envpçš„é•¿åº¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// argv_index å‚è€ƒ7.1.2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nf">argv_index</span><span class="p">(</span><span class="nx">argv</span><span class="p">,</span> <span class="nx">argc</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="nx">n</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">n</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">envs</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="c1">// ç”³è¯·né•¿åº¦çš„å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">int32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">envs</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nf">gostring</span><span class="p">(</span><span class="nf">argv_index</span><span class="p">(</span><span class="nx">argv</span><span class="p">,</span> <span class="nx">argc</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="nx">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/string.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// This is exported via linkname to assembly in syscall (for Plan9).
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:linkname gostring
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">gostring</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">l</span> <span class="o">:=</span> <span class="nf">findnull</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="c1">// æ‰¾å‡ºå­—ç¬¦ä¸²é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">l</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// rawstring å‡½æ•°åœ¨å­—ç¬¦ä¸²åŒ…ä¸­å·²ç»ä»‹ç»è¿‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åˆ†ä¼šçš„så’Œbåˆ†åˆ«å…±ç”¨ä¸€ä¸ªåº•å±‚ï¼Œè¿™æ ·æ“ä½œbåˆ‡ç‰‡sä¹Ÿä¼šè·Ÿç€æ”¹å˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">s</span><span class="p">,</span> <span class="nx">b</span> <span class="o">:=</span> <span class="nf">rawstring</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span> <span class="c1">// s string, b []byte
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ‹·è´æ•°æ®åˆ°bä¸­ä»pæ‹·è´é•¿åº¦lå­—èŠ‚ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memmove</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">p</span><span class="p">),</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">l</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">s</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="åˆå§‹åŒ–allp">åˆå§‹åŒ–allp<a hidden class="anchor" aria-hidden="true" href="#åˆå§‹åŒ–allp">#</a></h3>
<ol>
<li>ä¸‹é¢åˆ†æ<code>procresize()</code>å‡½æ•°ã€‚
<ul>
<li>è€ƒè™‘åˆ°åˆå§‹åŒ–å®Œæˆä¹‹åç”¨æˆ·ä»£ç è¿˜å¯ä»¥é€šè¿‡<code>GOMAXPROCS()</code>å‡½æ•°è°ƒç”¨å®ƒé‡æ–°åˆ›å»ºå’Œåˆå§‹åŒ–<code>p</code>ç»“æ„ä½“å¯¹è±¡ã€‚</li>
<li>è€Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­å†åŠ¨æ€çš„è°ƒæ•´pç‰µæ¶‰åˆ°çš„é—®é¢˜æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°çš„å¤„ç†æ¯”è¾ƒå¤æ‚ã€‚</li>
</ul>
</li>
</ol>
<h4 id="procresize">procresize()<a hidden class="anchor" aria-hidden="true" href="#procresize">#</a></h4>
<ol>
<li>æ›´æ”¹å¤„ç†å™¨æ•°é‡ã€‚<code>sched.lock</code>å¿…é¡»è¢«æŒæœ‰å¹¶ä¸”å¿…é¡»æ˜¯åœ¨<code>STW</code>æœŸé—´ã€‚</li>
<li><code>gcworkbufs</code>ä¸èƒ½è¢«<code>GC</code>æˆ–å†™å±éšœä»£ç ä¿®æ”¹ï¼Œå› æ­¤å¦‚æœ<code>P</code>æ•°å®é™…å‘ç”Ÿå˜åŒ–ï¼Œ<code>GC</code>å¿…é¡»ä¸è¿è¡Œã€‚</li>
<li>è¿”å›å…·æœ‰æœ¬åœ°å·¥ä½œçš„<code>p</code>åˆ—è¡¨ï¼Œå®ƒä»¬éœ€è¦ç”±è°ƒç”¨è€…è°ƒåº¦ã€‚</li>
<li>è¯¥å‡½æ•°ä¼šåœ¨ã€ç¨‹åºåˆå§‹åŒ–ã€‘æˆ–ã€<code>startTheWorldWithSema</code>ã€‘å‡½æ•°ä¸­è¢«è°ƒç”¨ã€‚</li>
<li>å‡½æ•°æµç¨‹ï¼š
<ol>
<li>ä½¿ç”¨<code>make([]*p, nprocs)</code>åˆå§‹åŒ–å…¨å±€å˜é‡<code>allp</code>ï¼Œå³<code>allp = make([]*p, nprocs)</code>ã€‚</li>
<li>å¾ªç¯åˆ›å»ºå¹¶åˆå§‹åŒ–<code>nprocs</code>ä¸ª<code>p</code>ç»“æ„ä½“å¯¹è±¡å¹¶ä¾æ¬¡ä¿å­˜åœ¨<code>allp</code>åˆ‡ç‰‡ä¹‹ä¸­ã€‚</li>
<li>æŠŠ<code>m0</code>å’Œ<code>allp[0]</code>ç»‘å®šåœ¨ä¸€èµ·ï¼Œå³ã€<code>m0.p = allp[0]</code>, <code>allp[0].m = m0</code>ã€‘ã€‚</li>
<li>æŠŠé™¤äº†<code>allp[0]</code>ä¹‹å¤–çš„æ‰€æœ‰<code>p</code>æ”¾å…¥åˆ°å…¨å±€å˜é‡<code>sched</code>çš„<code>pidle</code>ç©ºé—²é˜Ÿåˆ—ä¹‹ä¸­ã€‚</li>
</ol>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">4793
</span><span class="lnt">4794
</span><span class="lnt">4795
</span><span class="lnt">4796
</span><span class="lnt">4797
</span><span class="lnt">4798
</span><span class="lnt">4799
</span><span class="lnt">4800
</span><span class="lnt">4801
</span><span class="lnt">4802
</span><span class="lnt">4803
</span><span class="lnt">4804
</span><span class="lnt">4805
</span><span class="lnt">4806
</span><span class="lnt">4807
</span><span class="lnt">4808
</span><span class="lnt">4809
</span><span class="lnt">4810
</span><span class="lnt">4811
</span><span class="lnt">4812
</span><span class="lnt">4813
</span><span class="lnt">4814
</span><span class="lnt">4815
</span><span class="lnt">4816
</span><span class="lnt">4817
</span><span class="lnt">4818
</span><span class="lnt">4819
</span><span class="lnt">4820
</span><span class="lnt">4821
</span><span class="lnt">4822
</span><span class="lnt">4823
</span><span class="lnt">4824
</span><span class="lnt">4825
</span><span class="lnt">4826
</span><span class="lnt">4827
</span><span class="lnt">4828
</span><span class="lnt">4829
</span><span class="lnt">4830
</span><span class="lnt">4831
</span><span class="lnt">4832
</span><span class="lnt">4833
</span><span class="lnt">4834
</span><span class="lnt">4835
</span><span class="lnt">4836
</span><span class="lnt">4837
</span><span class="lnt">4838
</span><span class="lnt">4839
</span><span class="lnt">4840
</span><span class="lnt">4841
</span><span class="lnt">4842
</span><span class="lnt">4843
</span><span class="lnt">4844
</span><span class="lnt">4845
</span><span class="lnt">4846
</span><span class="lnt">4847
</span><span class="lnt">4848
</span><span class="lnt">4849
</span><span class="lnt">4850
</span><span class="lnt">4851
</span><span class="lnt">4852
</span><span class="lnt">4853
</span><span class="lnt">4854
</span><span class="lnt">4855
</span><span class="lnt">4856
</span><span class="lnt">4857
</span><span class="lnt">4858
</span><span class="lnt">4859
</span><span class="lnt">4860
</span><span class="lnt">4861
</span><span class="lnt">4862
</span><span class="lnt">4863
</span><span class="lnt">4864
</span><span class="lnt">4865
</span><span class="lnt">4866
</span><span class="lnt">4867
</span><span class="lnt">4868
</span><span class="lnt">4869
</span><span class="lnt">4870
</span><span class="lnt">4871
</span><span class="lnt">4872
</span><span class="lnt">4873
</span><span class="lnt">4874
</span><span class="lnt">4875
</span><span class="lnt">4876
</span><span class="lnt">4877
</span><span class="lnt">4878
</span><span class="lnt">4879
</span><span class="lnt">4880
</span><span class="lnt">4881
</span><span class="lnt">4882
</span><span class="lnt">4883
</span><span class="lnt">4884
</span><span class="lnt">4885
</span><span class="lnt">4886
</span><span class="lnt">4887
</span><span class="lnt">4888
</span><span class="lnt">4889
</span><span class="lnt">4890
</span><span class="lnt">4891
</span><span class="lnt">4892
</span><span class="lnt">4893
</span><span class="lnt">4894
</span><span class="lnt">4895
</span><span class="lnt">4896
</span><span class="lnt">4897
</span><span class="lnt">4898
</span><span class="lnt">4899
</span><span class="lnt">4900
</span><span class="lnt">4901
</span><span class="lnt">4902
</span><span class="lnt">4903
</span><span class="lnt">4904
</span><span class="lnt">4905
</span><span class="lnt">4906
</span><span class="lnt">4907
</span><span class="lnt">4908
</span><span class="lnt">4909
</span><span class="lnt">4910
</span><span class="lnt">4911
</span><span class="lnt">4912
</span><span class="lnt">4913
</span><span class="lnt">4914
</span><span class="lnt">4915
</span><span class="lnt">4916
</span><span class="lnt">4917
</span><span class="lnt">4918
</span><span class="lnt">4919
</span><span class="lnt">4920
</span><span class="lnt">4921
</span><span class="lnt">4922
</span><span class="lnt">4923
</span><span class="lnt">4924
</span><span class="lnt">4925
</span><span class="lnt">4926
</span><span class="lnt">4927
</span><span class="lnt">4928
</span><span class="lnt">4929
</span><span class="lnt">4930
</span><span class="lnt">4931
</span><span class="lnt">4932
</span><span class="lnt">4933
</span><span class="lnt">4934
</span><span class="lnt">4935
</span><span class="lnt">4936
</span><span class="lnt">4937
</span><span class="lnt">4938
</span><span class="lnt">4939
</span><span class="lnt">4940
</span><span class="lnt">4941
</span><span class="lnt">4942
</span><span class="lnt">4943
</span><span class="lnt">4944
</span><span class="lnt">4945
</span><span class="lnt">4946
</span><span class="lnt">4947
</span><span class="lnt">4948
</span><span class="lnt">4949
</span><span class="lnt">4950
</span><span class="lnt">4951
</span><span class="lnt">4952
</span><span class="lnt">4953
</span><span class="lnt">4954
</span><span class="lnt">4955
</span><span class="lnt">4956
</span><span class="lnt">4957
</span><span class="lnt">4958
</span><span class="lnt">4959
</span><span class="lnt">4960
</span><span class="lnt">4961
</span><span class="lnt">4962
</span><span class="lnt">4963
</span><span class="lnt">4964
</span><span class="lnt">4965
</span><span class="lnt">4966
</span><span class="lnt">4967
</span><span class="lnt">4968
</span><span class="lnt">4969
</span><span class="lnt">4970
</span><span class="lnt">4971
</span><span class="lnt">4972
</span><span class="lnt">4973
</span><span class="lnt">4974
</span><span class="lnt">4975
</span><span class="lnt">4976
</span><span class="lnt">4977
</span><span class="lnt">4978
</span><span class="lnt">4979
</span><span class="lnt">4980
</span><span class="lnt">4981
</span><span class="lnt">4982
</span><span class="lnt">4983
</span><span class="lnt">4984
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Change number of processors.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held, and the world must be stopped.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// gcworkbufs must not be being modified by either the GC or the write barrier
</span></span></span><span class="line"><span class="cl"><span class="c1">// code, so the GC must not be running if the number of Ps actually changes.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Returns list of Ps with local work, they need to be scheduled by the caller.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">procresize</span><span class="p">(</span><span class="nx">nprocs</span> <span class="kt">int32</span><span class="p">)</span> <span class="o">*</span><span class="nx">p</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// sched.lock é”å·²ç»è¢«æŒæœ‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¿…é¡»æ˜¯ STW æœŸé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">assertWorldStopped</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ç³»ç»Ÿåˆå§‹åŒ–æ—¶ï¼Œgomaxprocs = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">old</span> <span class="o">:=</span> <span class="nx">gomaxprocs</span> <span class="c1">// æ—§çš„æ•°é‡ï¼Œä¹Ÿå°±æ˜¯ä¸Šæ¬¡çš„æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// nprocs æœåŠ¡å™¨cpuæ ¸æ•°ï¼Œæˆ–ç”¨æˆ·é€šè¿‡GOMAXPROCSç¯å¢ƒå˜é‡æŒ‡å®šçš„æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">old</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">nprocs</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;procresize: invalid arg&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceGomaxprocs</span><span class="p">(</span><span class="nx">nprocs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// update statistics
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">now</span> <span class="o">:=</span> <span class="nf">nanotime</span><span class="p">()</span> <span class="c1">// å½“å‰æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sched.procresizetime æœ€åä¸€æ¬¡æ”¹å˜gomaxprocsçš„æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">procresizetime</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä»å¤‡æ³¨ä¸­çœ‹å‡ºè¯¥å€¼æ˜¯procresizetimeå˜åŒ–çš„ç§¯åˆ†ï¼Œå› è¯¥ç”¨äºç»Ÿè®¡ç›¸å…³
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// âˆ«gomaxprocs dt up to procresizetime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sched</span><span class="p">.</span><span class="nx">totaltime</span> <span class="o">+=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">old</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">procresizetime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sched</span><span class="p">.</span><span class="nx">procresizetime</span> <span class="p">=</span> <span class="nx">now</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»¥32ä¸ºä¸€ç»„ï¼Œåˆ†åˆ«å¤„ç†Pçš„æ ‡å¿—ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// idlepMaskï¼šè¡¨ç¤ºåœ¨_Pidleåˆ—è¡¨ä¸­çš„ä½æ©ç ï¼Œæ¯ä¸€ä¸ªPè¡¨ç¤ºä¸€ä½ï¼Œè®°å½•é‚£äº›På¤„ç†_Pidleï¼ˆç©ºé—²ï¼‰çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// timerpMaskï¼šè¡¨ç¤ºPåœ¨timerä¸Šçš„ä½æ©ç ï¼Œæ¯ä¸€ä¸ªPè¡¨ç¤ºä¸€ä½ï¼Œè®°å½•Pä¸timerç›¸å…³ï¼ˆ1è¡¨ç¤ºæœ‰timerï¼Œ0è¡¨ç¤ºæ²¡æœ‰timerï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// idlepMaskå’ŒtimerpMaskç”¨äºå¿«é€Ÿåˆ¤æ–­Pçš„çŠ¶æ€å’ŒPä¸Šæ˜¯å¦æœ‰timerã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">maskWords</span> <span class="o">:=</span> <span class="p">(</span><span class="nx">nprocs</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span> <span class="c1">// int32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Grow allp if necessary.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœæœ‰å¿…è¦æ‰©å±•allpã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">nprocs</span> <span class="p">&gt;</span> <span class="nb">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">allp</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// åˆå§‹åŒ–æ—¶ æˆ– Pçš„æ•°é‡æ‰©å¤§æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Synchronize with retake, which could be running
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// concurrently since it doesn&#39;t run on a P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">allpLock</span><span class="p">)</span>	<span class="c1">// è·å– mutex é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å½“å‰ allp çš„å®¹é‡è¶³å¤Ÿæœ¬æ¬¡æ‰©å±•ã€‚å¤„ç†P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">nprocs</span> <span class="o">&lt;=</span> <span class="nb">int32</span><span class="p">(</span><span class="nb">cap</span><span class="p">(</span><span class="nx">allp</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">allp</span> <span class="p">=</span> <span class="nx">allp</span><span class="p">[:</span><span class="nx">nprocs</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ä»æ–°ç”³è¯·å†…å­˜å¹¶æ‹·è´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">nallp</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">nprocs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Copy everything up to allp&#39;s cap so we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// never lose old allocated Ps.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nb">copy</span><span class="p">(</span><span class="nx">nallp</span><span class="p">,</span> <span class="nx">allp</span><span class="p">[:</span><span class="nb">cap</span><span class="p">(</span><span class="nx">allp</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">            <span class="nx">allp</span> <span class="p">=</span> <span class="nx">nallp</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// idlepMaskå’ŒtimerpMaskå¤„ç†ï¼Œå®¹é‡å¤Ÿï¼Œç›´æ¥ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">maskWords</span> <span class="o">&lt;=</span> <span class="nb">int32</span><span class="p">(</span><span class="nb">cap</span><span class="p">(</span><span class="nx">idlepMask</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">idlepMask</span> <span class="p">=</span> <span class="nx">idlepMask</span><span class="p">[:</span><span class="nx">maskWords</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="nx">timerpMask</span> <span class="p">=</span> <span class="nx">timerpMask</span><span class="p">[:</span><span class="nx">maskWords</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// å®¹é‡ä¸å¤Ÿï¼Œç”³è¯·å†…å­˜å¹¶æ¬è¿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// åˆ›å»ºä¸€ä¸ª []uint32ï¼Œæ¯ä¸€ä½åˆ†åˆ«ä»£è¡¨ä¸€ä¸ªP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">nidlepMask</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">uint32</span><span class="p">,</span> <span class="nx">maskWords</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// No need to copy beyond len, old Ps are irrelevant.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nb">copy</span><span class="p">(</span><span class="nx">nidlepMask</span><span class="p">,</span> <span class="nx">idlepMask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">idlepMask</span> <span class="p">=</span> <span class="nx">nidlepMask</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">ntimerpMask</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">uint32</span><span class="p">,</span> <span class="nx">maskWords</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">copy</span><span class="p">(</span><span class="nx">ntimerpMask</span><span class="p">,</span> <span class="nx">timerpMask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">timerpMask</span> <span class="p">=</span> <span class="nx">ntimerpMask</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">allpLock</span><span class="p">)</span> <span class="c1">// mutex è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// initialize new P&#39;s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åˆå§‹åŒ–æ‰€æœ‰æ–°åˆ›å»ºçš„Pï¼Œä»oldå¤„å¼€å§‹å› æ­¤ä¹‹å‰çš„å·²ç»åˆå§‹åŒ–äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">old</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">nprocs</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pp</span> <span class="o">:=</span> <span class="nx">allp</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">pp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å¯è§Pæ˜¯å †åˆ†é…çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">pp</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pp</span><span class="p">.</span><span class="nf">init</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="c1">// åˆå§‹åŒ–å½“å‰P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åŸå­è®¾ç½® ã€allp[i] = ppã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">atomicstorep</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">allp</span><span class="p">[</span><span class="nx">i</span><span class="p">]),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">pp</span><span class="p">))</span> <span class="c1">// ä¿å­˜allpä¸­å»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰mç»‘å®šäº†Pæ—¶ï¼Œåˆå§‹åŒ–æ—¶må¹¶æ²¡æœ‰ç»‘å®šPï¼Œ_g_.m.p == 0ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _g_.m.p != 0 &amp;&amp; _g_.m.p.ptr().id &lt; nprocs è¿™ç§æƒ…å†µæˆç«‹å‘ç”Ÿåœ¨ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å‘ç”Ÿæ‰©å®¹ æˆ– å‘ç”Ÿç¼©å®¹(å½“å‰På¹¶ä¸åœ¨è£å‰ªä¹‹å¤–)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">id</span> <span class="p">&lt;</span> <span class="nx">nprocs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// continue to use the current P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ç»§ç»­ä½¿ç”¨å½“å‰Pï¼Œ_Prunning è¿è¡Œä¸­çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">status</span> <span class="p">=</span> <span class="nx">_Prunning</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">mcache</span><span class="p">.</span><span class="nf">prepareForSweep</span><span class="p">()</span> <span class="c1">// æ¸…ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// release the current P and acquire allp[0].
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// We must do this before destroying our current P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// because p.destroy itself has write barriers, so we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// need to do that from a valid P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// è¿™ç§æƒ…å†µå‘ç”Ÿåœ¨Påœ¨ç¼©å®¹(å½“å‰På¹¶ä¸åœ¨è£å‰ªä¹‹å¤–)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Pretend that we were descheduled
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// and then scheduled again to keep
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// the trace sane.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">traceGoSched</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="nf">traceProcStop</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å½“å‰Mç»‘å®šçš„pä¸å½“å‰Mè§£ç»‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å› ä¸º M ä¸ P ç›¸äº’ç»‘å®šçš„ï¼Œè¿™é‡Œè¦è§£ç»‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">m</span> <span class="p">=</span> <span class="mi">0</span> <span class="c1">// p.m = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆå§‹åŒ–æ—¶ï¼Œä¼šèµ°è¿™é‡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è§£ç»‘Mä¸På…³ç³»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="p">=</span> <span class="mi">0</span> <span class="c1">// m.p = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// é€‰å–allp[0]ç»‘å®šå½“å‰å·¥ä½œçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">p</span> <span class="o">:=</span> <span class="nx">allp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl">        <span class="nx">p</span><span class="p">.</span><span class="nx">m</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// _Pidle ç©ºé—²çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">p</span><span class="p">.</span><span class="nx">status</span> <span class="p">=</span> <span class="nx">_Pidle</span> <span class="c1">// æ ‡è®°å½“å‰Pä¸ºç©ºé—²çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¯¥æ–¹æ³•è¦æ±‚På’ŒMéƒ½æ˜¯æ²¡æœ‰ç»‘å®šçš„ï¼Œå¹¶ä¸”Pä¸€å®šæ˜¯_PidleçŠ¶æ€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// p.m = m; m.p = p;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">acquirep</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="c1">// mä¸pç›¸äº’ç»‘å®šï¼Œå¹¶ä¿®æ”¹pçš„çŠ¶æ€ä¸ºè¿è¡Œä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">traceGoStart</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// g.m.p is now set, so we no longer need mcache0 for bootstrapping.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// g.m.p ç°åœ¨å·²ç»è®¾ç½®ï¼Œå› æ­¤æˆ‘ä»¬ä¸å†éœ€è¦ mcache0 æ¥è¿›è¡Œå¼•å¯¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// mcache0 åœ¨ p.init() å‡½æ•°ä¸­è¢«ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mcache0</span> <span class="p">=</span> <span class="kc">nil</span> <span class="c1">// è¯¥å€¼åœ¨å‰é¢schedinit()å‡½æ•°ä¸­ï¼Œæ ˆç›¸å…³åˆå§‹åŒ–æ—¶è¢«è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// release resources from unused P&#39;s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä»æœªä½¿ç”¨çš„ P é‡Šæ”¾èµ„æºï¼Œè¿™ç§æƒ…å†µå‘ç”Ÿåœ¨ç¼©å®¹Pæ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">nprocs</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">old</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">p</span> <span class="o">:=</span> <span class="nx">allp</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nx">p</span><span class="p">.</span><span class="nf">destroy</span><span class="p">()</span> <span class="c1">// å›æ”¶P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// can&#39;t free P itself because it can be referenced by an M in syscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä¸èƒ½é‡Šæ”¾Pæœ¬èº«ï¼Œå› ä¸ºå®ƒå¯ä»¥è¢«ç³»ç»Ÿè°ƒç”¨ä¸­çš„Må¼•ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Trim allp.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è£å‰ª allpã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nb">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">allp</span><span class="p">))</span> <span class="o">!=</span> <span class="nx">nprocs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">allpLock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">allp</span> <span class="p">=</span> <span class="nx">allp</span><span class="p">[:</span><span class="nx">nprocs</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nx">idlepMask</span> <span class="p">=</span> <span class="nx">idlepMask</span><span class="p">[:</span><span class="nx">maskWords</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nx">timerpMask</span> <span class="p">=</span> <span class="nx">timerpMask</span><span class="p">[:</span><span class="nx">maskWords</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">allpLock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">runnablePs</span> <span class="o">*</span><span class="nx">p</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// éå†æ‰€æœ‰Pï¼Œå¤„ç†Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­æœ‰goroutineçš„éœ€è¦ç»‘å®šMè¿è¡Œè¿™äº›goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">nprocs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">p</span> <span class="o">:=</span> <span class="nx">allp</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è·³è¿‡å½“å‰Pï¼Œå½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„Pæ­£åœ¨æ‰§è¡Œè¿™é‡Œçš„ä»£ç éœ€è¦è·³è¿‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span> <span class="o">==</span> <span class="nx">p</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">p</span><span class="p">.</span><span class="nx">status</span> <span class="p">=</span> <span class="nx">_Pidle</span> <span class="c1">// çŠ¶æ€ä¿®æ”¹ä¸º _Pidle ç©ºé—²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nf">runqempty</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Pçš„runqæ˜¯ç©ºçš„æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">pidleput</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">now</span><span class="p">)</span> <span class="c1">// æŠŠå½“å‰PæŒ‚åœ¨å…¨å±€schedç©ºé—²é“¾è¡¨ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">            <span class="nx">p</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nf">mget</span><span class="p">())</span> <span class="c1">// pç»‘å®šm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">p</span><span class="p">.</span><span class="nx">link</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">runnablePs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">runnablePs</span> <span class="p">=</span> <span class="nx">p</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// é‡ç½® stealOrderï¼Œè¯¥å€¼ç”¨äºéšæœºä»allpä¸­å·å–goroutineåˆå§‹æ¡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">stealOrder</span><span class="p">.</span><span class="nf">reset</span><span class="p">(</span><span class="nb">uint32</span><span class="p">(</span><span class="nx">nprocs</span><span class="p">))</span> <span class="c1">// åˆå§‹åŒ–Påé¢è¦ç”¨åˆ°å·å–çš„æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åŸå­ç»‘å®š gomaxprocs = nprocs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">int32p</span> <span class="o">*</span><span class="kt">int32</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">gomaxprocs</span> <span class="c1">// make compiler check that gomaxprocs is an int32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store</span><span class="p">((</span><span class="o">*</span><span class="kt">uint32</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">int32p</span><span class="p">)),</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">nprocs</span><span class="p">))</span> <span class="c1">// gomaxprocs = nprocs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">old</span> <span class="o">!=</span> <span class="nx">nprocs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Notify the limiter that the amount of procs has changed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">gcCPULimiter</span><span class="p">.</span><span class="nf">resetCapacity</span><span class="p">(</span><span class="nx">now</span><span class="p">,</span> <span class="nx">nprocs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// runnablePs != nil è¯´æ˜é™¤äº†å½“å‰På¤–çš„å…¶ä»–Pä¸­å­˜åœ¨goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">runnablePs</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/goroutine-008.png" alt=""  />
</p>
<h4 id="pinit">p.init()<a hidden class="anchor" aria-hidden="true" href="#pinit">#</a></h4>
<ol>
<li>åˆå§‹åŒ–Pã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">4669
</span><span class="lnt">4670
</span><span class="lnt">4671
</span><span class="lnt">4672
</span><span class="lnt">4673
</span><span class="lnt">4674
</span><span class="lnt">4675
</span><span class="lnt">4676
</span><span class="lnt">4677
</span><span class="lnt">4678
</span><span class="lnt">4679
</span><span class="lnt">4680
</span><span class="lnt">4681
</span><span class="lnt">4682
</span><span class="lnt">4683
</span><span class="lnt">4684
</span><span class="lnt">4685
</span><span class="lnt">4686
</span><span class="lnt">4687
</span><span class="lnt">4688
</span><span class="lnt">4689
</span><span class="lnt">4690
</span><span class="lnt">4691
</span><span class="lnt">4692
</span><span class="lnt">4693
</span><span class="lnt">4694
</span><span class="lnt">4695
</span><span class="lnt">4696
</span><span class="lnt">4697
</span><span class="lnt">4698
</span><span class="lnt">4699
</span><span class="lnt">4700
</span><span class="lnt">4701
</span><span class="lnt">4702
</span><span class="lnt">4703
</span><span class="lnt">4704
</span><span class="lnt">4705
</span><span class="lnt">4706
</span><span class="lnt">4707
</span><span class="lnt">4708
</span><span class="lnt">4709
</span><span class="lnt">4710
</span><span class="lnt">4711
</span><span class="lnt">4712
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// init initializes pp, which may be a freshly allocated p or a
</span></span></span><span class="line"><span class="cl"><span class="c1">// previously destroyed p, and transitions it to status _Pgcstop.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">pp</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="nf">init</span><span class="p">(</span><span class="nx">id</span> <span class="kt">int32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pp</span><span class="p">.</span><span class="nx">id</span> <span class="p">=</span> <span class="nx">id</span>	<span class="c1">// åˆ†é…Pçš„idï¼Œè¯¥idæ˜¯å”¯ä¸€çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">pp</span><span class="p">.</span><span class="nx">status</span> <span class="p">=</span> <span class="nx">_Pgcstop</span> <span class="c1">// è®¾ç½®PçŠ¶æ€ _Pgcstop GCåœæ­¢çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">pp</span><span class="p">.</span><span class="nx">sudogcache</span> <span class="p">=</span> <span class="nx">pp</span><span class="p">.</span><span class="nx">sudogbuf</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="c1">// Pä¸Šsudogç¼“å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">pp</span><span class="p">.</span><span class="nx">deferpool</span> <span class="p">=</span> <span class="nx">pp</span><span class="p">.</span><span class="nx">deferpoolbuf</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span> <span class="c1">// Pä¸Šdeferæ±  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">pp</span><span class="p">.</span><span class="nx">wbBuf</span><span class="p">.</span><span class="nf">reset</span><span class="p">()</span> <span class="c1">// Pçš„wbBufé‡ç½®ï¼Œè¯¥å­—æ®µä¸å†™å±éšœç›¸å…³
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// pp.mcache æ²¡æœ‰åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">pp</span><span class="p">.</span><span class="nx">mcache</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">id</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">            <span class="c1">// ç¨‹åºåˆšåˆå§‹åŒ–æ—¶ï¼Œmcache0åœ¨schedinit()ä¸­çš„mallocinit()å‡½æ•°ä¸­è¢«åˆ›å»º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">mcache0</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;missing mcache?&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Use the bootstrap mcache0. Only one P will get
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// mcache0: the one with ID 0.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">pp</span><span class="p">.</span><span class="nx">mcache</span> <span class="p">=</span> <span class="nx">mcache0</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ä½¿ç”¨ allocmcache() åˆ†é…ç¼“å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">pp</span><span class="p">.</span><span class="nx">mcache</span> <span class="p">=</span> <span class="nf">allocmcache</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="o">&amp;&amp;</span> <span class="nx">pp</span><span class="p">.</span><span class="nx">raceprocctx</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">id</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">pp</span><span class="p">.</span><span class="nx">raceprocctx</span> <span class="p">=</span> <span class="nx">raceprocctx0</span>
</span></span><span class="line"><span class="cl">            <span class="nx">raceprocctx0</span> <span class="p">=</span> <span class="mi">0</span> <span class="c1">// bootstrap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">pp</span><span class="p">.</span><span class="nx">raceprocctx</span> <span class="p">=</span> <span class="nf">raceproccreate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pp</span><span class="p">.</span><span class="nx">timersLock</span><span class="p">,</span> <span class="nx">lockRankTimers</span><span class="p">)</span> <span class="c1">// åˆå§‹åŒ– P.timersLock é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// This P may get timers when it starts running. Set the mask here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// since the P may not go through pidleget (notably P 0 on startup).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™ä¸ªPå¼€å§‹è¿è¡Œæ—¶å¯èƒ½ä¼šæœ‰timesã€‚åœ¨è¿™é‡Œè®¾ç½®å¯èƒ½ä¸ä¼šç»è¿‡pidleget(ç‰¹åˆ«æ˜¯åœ¨å¯åŠ¨æ—¶P 0)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">timerpMask</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Similarly, we may not go through pidleget before this P starts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// running if it is P 0 on startup.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç±»ä¼¼çš„ï¼Œå¦‚æœè¿™ä¸ªPæ˜¯åœ¨å¯åŠ¨çš„æ˜¯P 0ï¼Œæˆ‘ä»¬å¯èƒ½ä¸ä¼šåœ¨è¿™ä¸ªPå¼€å§‹è¿è¡Œä¹‹å‰ç»å†pidlegetã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">idlepMask</span><span class="p">.</span><span class="nb">clear</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="acquirep">acquirep()<a hidden class="anchor" aria-hidden="true" href="#acquirep">#</a></h4>
<ol>
<li><code>M</code>å’Œ<code>P</code>ç›¸äº’ç»‘å®šã€‚<code>m.p = p</code>ã€<code>p.m = m</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">4938
</span><span class="lnt">4939
</span><span class="lnt">4940
</span><span class="lnt">4941
</span><span class="lnt">4942
</span><span class="lnt">4943
</span><span class="lnt">4944
</span><span class="lnt">4945
</span><span class="lnt">4946
</span><span class="lnt">4947
</span><span class="lnt">4948
</span><span class="lnt">4949
</span><span class="lnt">4950
</span><span class="lnt">4951
</span><span class="lnt">4952
</span><span class="lnt">4953
</span><span class="lnt">4954
</span><span class="lnt">4955
</span><span class="lnt">4956
</span><span class="lnt">4957
</span><span class="lnt">4958
</span><span class="lnt">4959
</span><span class="lnt">4960
</span><span class="lnt">4961
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Associate p and the current m.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// This function is allowed to have write barriers even if the caller
</span></span></span><span class="line"><span class="cl"><span class="c1">// isn&#39;t because it immediately acquires _p_.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:yeswritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Do the part that isn&#39;t allowed to have write barriers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸å…è®¸æœ‰å†™å…¥éšœç¢çš„éƒ¨åˆ†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">wirep</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="c1">// mä¸pç›¸äº’ç»‘å®šï¼Œå¹¶ä¿®æ”¹pçš„çŠ¶æ€ä¸ºè¿è¡Œä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Have p; write barriers now allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Perform deferred mcache flush before this P can allocate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// from a potentially stale mcache.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨è¿™ä¸ªPå¯ä»¥ä»å¯èƒ½è¿‡æœŸçš„mcacheè¿›è¡Œåˆ†é…ä¹‹å‰æ‰§è¡Œå»¶è¿Ÿçš„mcacheåˆ·å†™ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">mcache</span><span class="p">.</span><span class="nf">prepareForSweep</span><span class="p">()</span> <span class="c1">// GCç›¸å…³
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceProcStart</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="wirep">wirep()<a hidden class="anchor" aria-hidden="true" href="#wirep">#</a></h4>
<ol>
<li><code>wirep</code>æ˜¯<code>acquirep</code> çš„ç¬¬ä¸€æ­¥ï¼Œå®ƒå®é™…ä¸Šå°†å½“å‰<code>M</code>å…³è”åˆ° <code>_p_</code>ã€‚</li>
<li>è¿™é‡Œä¸å…è®¸æ ˆæ£€æŸ¥ï¼Œä»¥åŠå†™å±éšœç›¸å…³ä»£ç ï¼Œå› ä¸º<code>M</code>è¿˜æ²¡æœ‰ç»‘å®š<code>P</code>ã€‚</li>
<li><code>m</code>ä¸<code>p</code>ç›¸äº’ç»‘å®šï¼Œå¹¶ä¿®æ”¹<code>p</code>çš„çŠ¶æ€ä¸ºè¿è¡Œä¸­ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">4959
</span><span class="lnt">4960
</span><span class="lnt">4961
</span><span class="lnt">4962
</span><span class="lnt">4963
</span><span class="lnt">4964
</span><span class="lnt">4965
</span><span class="lnt">4966
</span><span class="lnt">4967
</span><span class="lnt">4968
</span><span class="lnt">4969
</span><span class="lnt">4970
</span><span class="lnt">4971
</span><span class="lnt">4972
</span><span class="lnt">4973
</span><span class="lnt">4974
</span><span class="lnt">4975
</span><span class="lnt">4976
</span><span class="lnt">4977
</span><span class="lnt">4978
</span><span class="lnt">4979
</span><span class="lnt">4980
</span><span class="lnt">4981
</span><span class="lnt">4982
</span><span class="lnt">4983
</span><span class="lnt">4984
</span><span class="lnt">4985
</span><span class="lnt">4986
</span><span class="lnt">4987
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// wirep is the first step of acquirep, which actually associates the
</span></span></span><span class="line"><span class="cl"><span class="c1">// current M to _p_. This is broken out so we can disallow write
</span></span></span><span class="line"><span class="cl"><span class="c1">// barriers for this part, since we don&#39;t yet have a P.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">wirep</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åœ¨å½“å‰è¿™é‡Œåªèƒ½æ˜¯g0ï¼Œä½†æ˜¯å…¶ä»–åœ°æ–¹å¯èƒ½æ˜¯g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ­¤æ—¶Mä¸€å®šæ˜¯æ²¡æœ‰ç»‘å®šPçš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;wirep: already in go&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ­¤æ—¶pä¸€å®šæ²¡æœ‰ç»‘å®šMï¼Œå¹¶ä¸”Pä¸€å®šæ˜¯_PidleçŠ¶æ€ï¼ˆç©ºé—²ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="nx">_Pidle</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">id</span> <span class="p">=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">id</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;wirep: p-&gt;m=&#34;</span><span class="p">,</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span> <span class="s">&#34;(&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&#34;) p-&gt;status=&#34;</span><span class="p">,</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;wirep: invalid p state&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Mä¸Pç›¸äº’ç»‘å®šï¼Œå¹¶è®¾ç½®Pçš„çŠ¶æ€ä¸ºè¿è¡Œä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="c1">// m.p = _p_
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span> <span class="c1">// _p_.m = m
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _Prunning è¿è¡Œä¸­çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span> <span class="p">=</span> <span class="nx">_Prunning</span> <span class="c1">// ä¿®æ”¹å½“å‰Pä¸ºè¿è¡ŒçŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/goroutine-009.png" alt=""  />
</p>
<h4 id="pdestroy">p.destroy()<a hidden class="anchor" aria-hidden="true" href="#pdestroy">#</a></h4>
<ol>
<li><code>destroy</code>é‡Šæ”¾ä¸<code>pp</code>ç›¸å…³çš„æ‰€æœ‰èµ„æºï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºçŠ¶æ€<code>_Pdead</code>ã€‚</li>
<li><code>sched.lock</code>å¿…é¡»è¢«æŒæœ‰å¹¶ä¸”<code>STW</code>ã€‚</li>
<li>è¯¥å‡½æ•°å¤„ç†<code>P</code>ä¸­çš„<code>goroutine</code>ï¼Œä»¥åŠè¿ç§»<code>pp</code>ä¸Šæ‰€æœ‰çš„<code>timer</code>ï¼Œä»¥åŠå†™å±éšœç›¸å…³å†…å­˜é‡Šæ”¾ç­‰ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">4707
</span><span class="lnt">4708
</span><span class="lnt">4709
</span><span class="lnt">4710
</span><span class="lnt">4711
</span><span class="lnt">4712
</span><span class="lnt">4713
</span><span class="lnt">4714
</span><span class="lnt">4715
</span><span class="lnt">4716
</span><span class="lnt">4717
</span><span class="lnt">4718
</span><span class="lnt">4719
</span><span class="lnt">4720
</span><span class="lnt">4721
</span><span class="lnt">4722
</span><span class="lnt">4723
</span><span class="lnt">4724
</span><span class="lnt">4725
</span><span class="lnt">4726
</span><span class="lnt">4727
</span><span class="lnt">4728
</span><span class="lnt">4729
</span><span class="lnt">4730
</span><span class="lnt">4731
</span><span class="lnt">4732
</span><span class="lnt">4733
</span><span class="lnt">4734
</span><span class="lnt">4735
</span><span class="lnt">4736
</span><span class="lnt">4737
</span><span class="lnt">4738
</span><span class="lnt">4739
</span><span class="lnt">4740
</span><span class="lnt">4741
</span><span class="lnt">4742
</span><span class="lnt">4743
</span><span class="lnt">4744
</span><span class="lnt">4745
</span><span class="lnt">4746
</span><span class="lnt">4747
</span><span class="lnt">4748
</span><span class="lnt">4749
</span><span class="lnt">4750
</span><span class="lnt">4751
</span><span class="lnt">4752
</span><span class="lnt">4753
</span><span class="lnt">4754
</span><span class="lnt">4755
</span><span class="lnt">4756
</span><span class="lnt">4757
</span><span class="lnt">4758
</span><span class="lnt">4759
</span><span class="lnt">4760
</span><span class="lnt">4761
</span><span class="lnt">4762
</span><span class="lnt">4763
</span><span class="lnt">4764
</span><span class="lnt">4765
</span><span class="lnt">4766
</span><span class="lnt">4767
</span><span class="lnt">4768
</span><span class="lnt">4769
</span><span class="lnt">4770
</span><span class="lnt">4771
</span><span class="lnt">4772
</span><span class="lnt">4773
</span><span class="lnt">4774
</span><span class="lnt">4775
</span><span class="lnt">4776
</span><span class="lnt">4777
</span><span class="lnt">4778
</span><span class="lnt">4779
</span><span class="lnt">4780
</span><span class="lnt">4781
</span><span class="lnt">4782
</span><span class="lnt">4783
</span><span class="lnt">4784
</span><span class="lnt">4785
</span><span class="lnt">4786
</span><span class="lnt">4787
</span><span class="lnt">4788
</span><span class="lnt">4789
</span><span class="lnt">4790
</span><span class="lnt">4791
</span><span class="lnt">4792
</span><span class="lnt">4793
</span><span class="lnt">4794
</span><span class="lnt">4795
</span><span class="lnt">4796
</span><span class="lnt">4797
</span><span class="lnt">4798
</span><span class="lnt">4799
</span><span class="lnt">4800
</span><span class="lnt">4801
</span><span class="lnt">4802
</span><span class="lnt">4803
</span><span class="lnt">4804
</span><span class="lnt">4805
</span><span class="lnt">4806
</span><span class="lnt">4807
</span><span class="lnt">4808
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// destroy releases all of the resources associated with pp and
</span></span></span><span class="line"><span class="cl"><span class="c1">// transitions it to status _Pdead.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held and the world must be stopped.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">pp</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="nf">destroy</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">assertWorldStopped</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Move all runnable goroutines to the global queue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å°†å½“å‰Pçš„æ‰€æœ‰å¯è¿è¡Œçš„goroutinesç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">pp</span><span class="p">.</span><span class="nx">runqhead</span> <span class="o">!=</span> <span class="nx">pp</span><span class="p">.</span><span class="nx">runqtail</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Pop from tail of local queue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">pp</span><span class="p">.</span><span class="nx">runqtail</span><span class="o">--</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">pp</span><span class="p">.</span><span class="nx">runq</span><span class="p">[</span><span class="nx">pp</span><span class="p">.</span><span class="nx">runqtail</span><span class="o">%</span><span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">pp</span><span class="p">.</span><span class="nx">runq</span><span class="p">))].</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Push onto head of global queue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">globrunqputhead</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span> <span class="c1">// åŠ å…¥åˆ°å…¨å±€é˜Ÿåˆ—æ± ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// pp.runnext ä¸Šå­˜åœ¨ goroutineï¼ŒåŠ å…¥åˆ°å…¨å±€æ± 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">pp</span><span class="p">.</span><span class="nx">runnext</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">globrunqputhead</span><span class="p">(</span><span class="nx">pp</span><span class="p">.</span><span class="nx">runnext</span><span class="p">.</span><span class="nf">ptr</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pp</span><span class="p">.</span><span class="nx">runnext</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// P ä¸­è¿˜æœ‰timerã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">pp</span><span class="p">.</span><span class="nx">timers</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">plocal</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">().</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// The world is stopped, but we acquire timersLock to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// protect against sysmon calling timeSleepUntil.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// This is the only case where we hold the timersLock of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// more than one P, so there are no deadlock concerns.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// STWäº†ï¼Œä½†æ˜¯æˆ‘ä»¬è·å¾—äº†timersLockæ¥é˜²æ­¢sysmonè°ƒç”¨timeSleepUntil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿™æ˜¯æˆ‘ä»¬æŒæœ‰ä¸æ­¢ä¸€ä¸ªPçš„å®šæ—¶å™¨é”çš„å”¯ä¸€æƒ…å†µï¼Œå› æ­¤ä¸å­˜åœ¨æ­»é”é—®é¢˜ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">plocal</span><span class="p">.</span><span class="nx">timersLock</span><span class="p">)</span> <span class="c1">// plocal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pp</span><span class="p">.</span><span class="nx">timersLock</span><span class="p">)</span> <span class="c1">// pp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æŠŠpp.timersä¸­æ‰€æœ‰æœ‰æ•ˆçš„timeré‡æ–°æ·»åŠ åˆ°plocal.timersä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿™é‡ŒæŠŠéœ€è¦åˆ é™¤çš„ppä¸Šçš„æ‰€æœ‰timerè½¬ç§»åˆ°å½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„Pä¸Šé¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">moveTimers</span><span class="p">(</span><span class="nx">plocal</span><span class="p">,</span> <span class="nx">pp</span><span class="p">.</span><span class="nx">timers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pp</span><span class="p">.</span><span class="nx">timers</span> <span class="p">=</span> <span class="kc">nil</span> <span class="c1">// æƒ…å†µ pp.timersï¼Œå› ä¸ºtimerså·²ç»è¿ç§»åˆ°äº†å½“å‰å·¥ä½œçº¿ç¨‹çš„Päº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// numTimersï¼šè®°å½•çš„æ˜¯å †ä¸­ timer çš„æ€»æ•°ï¼Œåº”è¯¥ä¸ timers åˆ‡ç‰‡çš„é•¿åº¦ä¸€è‡´ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">pp</span><span class="p">.</span><span class="nx">numTimers</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// deletedTimersï¼šè®°å½•çš„æ˜¯å †ä¸­å·²åˆ é™¤ä½†è¿˜æœªè¢«ç§»é™¤çš„ timer çš„æ€»æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">pp</span><span class="p">.</span><span class="nx">deletedTimers</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// timer0Whenï¼šè¡¨ç¤ºä½äºæœ€å°å †å †é¡¶çš„ timer çš„è§¦å‘æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯èµ‹å€¼å…¶ when å­—æ®µã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pp</span><span class="p">.</span><span class="nx">timer0When</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// pp.timer0When = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pp</span><span class="p">.</span><span class="nx">timersLock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">plocal</span><span class="p">.</span><span class="nx">timersLock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Flush p&#39;s write barrier buffer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åˆ·æ–°pçš„å†™å±éšœç¼“å†²åŒºã€‚å†™å±éšœç›¸å…³
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gcphase</span> <span class="o">!=</span> <span class="nx">_GCoff</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">wbBufFlush1</span><span class="p">(</span><span class="nx">pp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pp</span><span class="p">.</span><span class="nx">gcw</span><span class="p">.</span><span class="nf">dispose</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pp</span><span class="p">.</span><span class="nx">sudogbuf</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pp</span><span class="p">.</span><span class="nx">sudogbuf</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pp</span><span class="p">.</span><span class="nx">sudogcache</span> <span class="p">=</span> <span class="nx">pp</span><span class="p">.</span><span class="nx">sudogbuf</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pp</span><span class="p">.</span><span class="nx">deferpoolbuf</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pp</span><span class="p">.</span><span class="nx">deferpoolbuf</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pp</span><span class="p">.</span><span class="nx">deferpool</span> <span class="p">=</span> <span class="nx">pp</span><span class="p">.</span><span class="nx">deferpoolbuf</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ‡æ¢åˆ°g0æ ˆå¤„ç†mspancache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ç›¸å…³å†…å­˜é‡Šæ”¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">pp</span><span class="p">.</span><span class="nx">mspancache</span><span class="p">.</span><span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Safe to call since the world is stopped.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">mheap_</span><span class="p">.</span><span class="nx">spanalloc</span><span class="p">.</span><span class="nf">free</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">pp</span><span class="p">.</span><span class="nx">mspancache</span><span class="p">.</span><span class="nx">buf</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pp</span><span class="p">.</span><span class="nx">mspancache</span><span class="p">.</span><span class="nx">len</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mheap_</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pp</span><span class="p">.</span><span class="nx">pcache</span><span class="p">.</span><span class="nf">flush</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mheap_</span><span class="p">.</span><span class="nx">pages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mheap_</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nf">freemcache</span><span class="p">(</span><span class="nx">pp</span><span class="p">.</span><span class="nx">mcache</span><span class="p">)</span> <span class="c1">// é‡Šæ”¾å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">pp</span><span class="p">.</span><span class="nx">mcache</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gfpurge</span><span class="p">(</span><span class="nx">pp</span><span class="p">)</span> <span class="c1">// å›æ”¶P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">traceProcFree</span><span class="p">(</span><span class="nx">pp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">pp</span><span class="p">.</span><span class="nx">timerRaceCtx</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// The race detector code uses a callback to fetch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// the proc context, so arrange for that callback
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// to see the right thing.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// This hack only works because we are the only
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// thread running.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">().</span><span class="nx">m</span>
</span></span><span class="line"><span class="cl">            <span class="nx">phold</span> <span class="o">:=</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nx">mp</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">pp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nf">racectxend</span><span class="p">(</span><span class="nx">pp</span><span class="p">.</span><span class="nx">timerRaceCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">pp</span><span class="p">.</span><span class="nx">timerRaceCtx</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">mp</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">phold</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">raceprocdestroy</span><span class="p">(</span><span class="nx">pp</span><span class="p">.</span><span class="nx">raceprocctx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pp</span><span class="p">.</span><span class="nx">raceprocctx</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pp</span><span class="p">.</span><span class="nx">gcAssistTime</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pp</span><span class="p">.</span><span class="nx">status</span> <span class="p">=</span> <span class="nx">_Pdead</span> <span class="c1">// ä¿®æ”¹PçŠ¶æ€ä¸ºç©ºé—²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="pidleput">pidleput()<a hidden class="anchor" aria-hidden="true" href="#pidleput">#</a></h4>
<ol>
<li>å‚æ•°ï¼š
<ul>
<li><code>_p_ *p</code>ï¼šå½“å‰æ“ä½œçš„<code>p</code>ï¼Œè¯¥<code>p</code>çš„æœ¬åœ°é˜Ÿåˆ—åº”è¯¥æ˜¯ç©ºçš„ã€‚</li>
<li><code>now int64</code>ï¼šå½“å‰æ—¶é—´ã€‚</li>
</ul>
</li>
<li>æŠŠå½“<code>_p_</code>æŒ‚åœ¨å…¨å±€<code>sched</code>ç©ºé—²é“¾è¡¨ä¸­ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5696
</span><span class="lnt">5697
</span><span class="lnt">5698
</span><span class="lnt">5699
</span><span class="lnt">5700
</span><span class="lnt">5701
</span><span class="lnt">5702
</span><span class="lnt">5703
</span><span class="lnt">5704
</span><span class="lnt">5705
</span><span class="lnt">5706
</span><span class="lnt">5707
</span><span class="lnt">5708
</span><span class="lnt">5709
</span><span class="lnt">5710
</span><span class="lnt">5711
</span><span class="lnt">5712
</span><span class="lnt">5713
</span><span class="lnt">5714
</span><span class="lnt">5715
</span><span class="lnt">5716
</span><span class="lnt">5717
</span><span class="lnt">5718
</span><span class="lnt">5719
</span><span class="lnt">5720
</span><span class="lnt">5721
</span><span class="lnt">5722
</span><span class="lnt">5723
</span><span class="lnt">5724
</span><span class="lnt">5725
</span><span class="lnt">5726
</span><span class="lnt">5727
</span><span class="lnt">5728
</span><span class="lnt">5729
</span><span class="lnt">5730
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pidleput puts p on the _Pidle list. now must be a relatively recent call
</span></span></span><span class="line"><span class="cl"><span class="c1">// to nanotime or zero. Returns now or the current time if now was zero.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// This releases ownership of p. Once sched.lock is released it is no longer
</span></span></span><span class="line"><span class="cl"><span class="c1">// safe to use p.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// May run during STW, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">pidleput</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">now</span> <span class="kt">int64</span><span class="p">)</span> <span class="kt">int64</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒç”¨è¯¥å‡½æ•°æ—¶ sched.lock å¿…é¡»è¢«æŒæœ‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰På‡†å¤‡æ”¾å…¥ç©ºé—²é“¾è¡¨ï¼Œå› æ­¤runqä¸­ä¸èƒ½æœ‰goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nf">runqempty</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;pidleput: P has non-empty run queue&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">now</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">now</span> <span class="p">=</span> <span class="nf">nanotime</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ›´æ–°TimerPMask
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">updateTimerPMask</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="c1">// clear if there are no timers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">idlepMask</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="c1">// æ ‡è®°_p_æ˜¯ç©ºé—²çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ”¾å…¥å…¨å±€é“¾è¡¨ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">link</span> <span class="p">=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">pidle</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sched</span><span class="p">.</span><span class="nx">pidle</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="c1">// sched.pidle = _p_
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç©ºé—²Pæ•°é‡åŠ ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">npidle</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// sched.npidle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">limiterEvent</span><span class="p">.</span><span class="nf">start</span><span class="p">(</span><span class="nx">limiterEventIdle</span><span class="p">,</span> <span class="nx">now</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;must be able to track idle limiter event&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">now</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="main-goroutine"><code>main goroutine</code><a hidden class="anchor" aria-hidden="true" href="#main-goroutine">#</a></h2>
<ol>
<li><code>schedinit</code>å®Œæˆè°ƒåº¦ç³»ç»Ÿåˆå§‹åŒ–åã€‚</li>
<li>è¿”å›åˆ°<code>rt0_go</code>å‡½æ•°ä¸­å¼€å§‹è°ƒç”¨<code>newproc()</code>åˆ›å»ºä¸€ä¸ªæ–°çš„<code>goroutine</code>ç”¨äºæ‰§è¡Œ<code>mainPC</code>æ‰€å¯¹åº”çš„<code>runtimeÂ·main</code>å‡½æ•°ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/asm_amd64.s</code>ã€‚</li>
<li>ä»¥ä¸‹<code>runtimeÂ·newproc</code>ã€<code>runtimeÂ·mstart</code>å°†åœ¨åç»­æ–‡ç« ä¸­ä»‹ç»ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">    <span class="c1"># create a new goroutine to start program
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># åˆ›å»ºä¸€ä¸ªæ–°çš„goroutineæ¥å¯åŠ¨ç¨‹åºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># AX = runtimeÂ·main 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># runtimeÂ·main æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œ&amp;funcval{fn:runtime.main}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$runtime</span><span class="err">Â·</span><span class="no">mainPC</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">AX</span> <span class="c1"># entry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å°†AXçš„å€¼å‹å…¥æ ˆä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">PUSHQ</span>   <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># AXçš„å€¼ä½œä¸ºruntimeÂ·newproc()å‡½æ•°çš„å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">newproc</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="c1"># åˆ›å»ºmain goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">POPQ</span>    <span class="no">AX</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># start this M
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">mstart</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="c1"># ä¸»çº¿ç¨‹è¿›å…¥å¾ªç¯è°ƒåº¦ï¼Œè¿è¡Œåˆšåˆšåˆ›å»ºçš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ä¸Šé¢çš„mstartæ°¸è¿œä¸åº”è¯¥è¿”å›çš„ï¼Œå¦‚æœè¿”å›äº†ï¼Œä¸€å®šæ˜¯ä»£ç é€»è¾‘æœ‰é—®é¢˜ï¼Œç›´æ¥abort
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">abort</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>	<span class="c1"># mstart should never return
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">RET</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># å‰é¢æ²¡æœ‰è·å–åˆ°CPUç›¸å…³ä¿¡æ¯æ—¶ä¼šèµ°è¿™é‡Œçš„å¼‚å¸¸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">bad_cpu:</span> <span class="c1"># show that the program requires a certain microarchitecture level.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$2</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">$bad_cpu_msg</span><span class="err">&lt;&gt;</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="mi">8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">$84</span><span class="p">,</span> <span class="mi">16</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">write</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">$1</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">exit</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">abort</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">RET</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Prevent dead-code elimination of debugCallV2, which is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># intended to be called by debuggers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$runtime</span><span class="err">Â·</span><span class="no">debugCallV2</span><span class="err">&lt;</span><span class="no">ABIInternal</span><span class="err">&gt;</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/goroutine-010.png" alt=""  />
</p>
<h2 id="å…¶ä»–å†…å®¹">å…¶ä»–å†…å®¹<a hidden class="anchor" aria-hidden="true" href="#å…¶ä»–å†…å®¹">#</a></h2>
<h3 id="argcå’Œargv">argcå’Œargv<a hidden class="anchor" aria-hidden="true" href="#argcå’Œargv">#</a></h3>
<ol>
<li>åœ¨è®¡ç®—æœºç¼–ç¨‹ä¸­ï¼Œé€šå¸¸ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°æ¥å‘ç¨‹åºä¼ é€’é¢å¤–çš„ä¿¡æ¯ã€‚</li>
<li><code>C</code>è¯­è¨€ä¸­çš„<code>main</code>å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯<code>argc</code>å’Œ<code>argv</code>ã€‚</li>
<li>å…¶ä¸­<code>argc</code>è¡¨ç¤ºå‘½ä»¤è¡Œå‚æ•°çš„æ•°é‡ï¼Œè€Œ<code>argv</code>æ˜¯ä¸€ä¸ªæŒ‡å‘å‚æ•°å­—ç¬¦ä¸²æ•°ç»„çš„æŒ‡é’ˆï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ éƒ½åŒ…å«ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°ã€‚</li>
<li>å¦‚æœä½ åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š<code>$ my_program arg1 arg2 arg3</code></li>
<li>åˆ™<code>argc</code>çš„å€¼å°†æ˜¯4ï¼Œå…¶ä¸­åŒ…æ‹¬ç¨‹åºå<code>my_program</code>å’Œ3ä¸ªå‚æ•°<code>arg1</code>ã€<code>arg2</code>å’Œ<code>arg3</code>ã€‚è€Œ<code>argv</code>æŒ‡å‘ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œå…¶å†…å®¹å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;my_program&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;arg1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;arg2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;arg3&#34;</span>
</span></span></code></pre></div><ol start="6">
<li>æ¯”å¦‚åœ¨<code>Go</code>è¯­è¨€ä¸­ï¼Œ<code>argc</code>å’Œ<code>argv</code>ä½¿ç”¨ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;os&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">args</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span> <span class="c1">// []string
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Pathï¼š%s\n&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Argsï¼š%#v\n&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="7">
<li>å½“æˆ‘ä»¬æ‰§è¡Œ<code>go run</code>å‘½ä»¤è¿è¡Œä¸Šé¢çš„ç¨‹åºå¹¶ä¼ é€’ä¸€äº›å‚æ•°æ—¶ï¼Œå°†ä¼šå¾—åˆ°ç±»ä¼¼ä»¥ä¸‹çš„è¾“å‡ºï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="o">[</span>root@localhost hello1<span class="o">]</span><span class="c1"># go run tt12.go foo bar baz js</span>
</span></span><span class="line"><span class="cl">Pathï¼š/tmp/go-build1239766326/b001/exe/tt12
</span></span><span class="line"><span class="cl">Argsï¼š<span class="o">[]</span>string<span class="o">{</span><span class="s2">&#34;foo&#34;</span>, <span class="s2">&#34;bar&#34;</span>, <span class="s2">&#34;baz&#34;</span>, <span class="s2">&#34;js&#34;</span><span class="o">}</span>
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://helium.github.io/tags/golang/">Golang</a></li>
      <li><a href="https://helium.github.io/tags/goroutine/">Goroutine</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://helium.github.io/posts/golang/interface/use/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>æ¥å£(ä½¿ç”¨)</span>
  </a>
  <a class="next" href="https://helium.github.io/posts/golang/goroutine/newproc/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>go å…³é”®å­—</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
    </span>
    <span id="busuanzi_container_site_uv">
        æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
    </span>
    </div>
        <span>Copyright Â© 2024 èœ€ICPå¤‡2024091074å· <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
