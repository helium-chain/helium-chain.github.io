<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>å·¥ä½œçº¿ç¨‹çš„å”¤é†’å’Œåˆ›å»º | Helium</title>
<meta name="keywords" content="golang, Goroutine">
<meta name="description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬">
<meta name="author" content="helium">
<link rel="canonical" href="https://heliu.site/posts/golang/goroutine/newm/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://heliu.site/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://heliu.site/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://heliu.site/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://heliu.site/apple-touch-icon.png">
<link rel="mask-icon" href="https://heliu.site/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://heliu.site/posts/golang/goroutine/newm/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="å·¥ä½œçº¿ç¨‹çš„å”¤é†’å’Œåˆ›å»º" />
<meta property="og:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://heliu.site/posts/golang/goroutine/newm/" />
<meta property="og:image" content="https://heliu.site/favicon-32x32.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-07-30T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-07-30T00:00:00+00:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://heliu.site/favicon-32x32.png" />
<meta name="twitter:title" content="å·¥ä½œçº¿ç¨‹çš„å”¤é†’å’Œåˆ›å»º"/>
<meta name="twitter:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://heliu.site/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Golang åˆé›†",
      "item": "https://heliu.site/posts/golang/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ç¬¬12ç«  Goroutine",
      "item": "https://heliu.site/posts/golang/goroutine/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "å·¥ä½œçº¿ç¨‹çš„å”¤é†’å’Œåˆ›å»º",
      "item": "https://heliu.site/posts/golang/goroutine/newm/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "å·¥ä½œçº¿ç¨‹çš„å”¤é†’å’Œåˆ›å»º",
  "name": "å·¥ä½œçº¿ç¨‹çš„å”¤é†’å’Œåˆ›å»º",
  "description": "ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18+ç‰ˆæœ¬",
  "keywords": [
    "golang", "Goroutine"
  ],
  "articleBody": "å”¤é†’å·¥ä½œçº¿ç¨‹ å»å°è¯•å”¤é†’å·¥ä½œçº¿ç¨‹æ¡ä»¶ï¼šatomic.Load(\u0026sched.npidle) != 0 \u0026\u0026 atomic.Load(\u0026sched.nmspinning) == 0ã€‚ atomic.Load(\u0026sched.npidle) != 0ï¼šæœ‰ç©ºé—²çš„Pã€‚ atomic.Load(\u0026sched.nmspinning) == 0ï¼šæ²¡æœ‰å·¥ä½œçº¿ç¨‹æ­£åœ¨å°è¯•ä»å…¶ä»–å·¥ä½œçº¿ç¨‹çš„æœ¬åœ°é˜Ÿåˆ—å·å–goroutineã€‚(å°±æ˜¯æ²¡æœ‰spinningè‡ªæ—‹çš„goroutineæ—¶) å”¤é†’ç©ºé—²çš„På’ŒMç”±wakep()å‡½æ•°å®Œæˆã€‚ wakep() å°è¯•æ·»åŠ ä¸€ä¸ªPæ¥æ‰§è¡ŒGã€‚å½“Gæ˜¯å¯è¿è¡Œæ—¶è°ƒç”¨(newproc, ready)ã€‚ wakep()å‡½æ•°è¢«è°ƒç”¨çš„åœ°æ–¹ï¼šã€åˆ›å»ºgæ—¶å€™ï¼Œåœ¨newproc()å‡½æ•°ä¸­ï¼Œå°±æ˜¯goå…³é”®å­—ã€‘ï¼Œã€gæ”¾å›Pçš„æ—¶å€™ï¼Œåœ¨ready()å‡½æ•°ä¸­ã€‘ã€‚ newproc()å‡½æ•°ä¸­ï¼Œä¹Ÿå°±æ˜¯goå…³é”®å­—æ—¶ï¼Œruntime.mainå·²å¯åŠ¨æ—¶ã€‚ï¼ˆè¿™ç§æƒ…å†µå‘ç”Ÿåœ¨goå…³é”®å­—æ—¶ï¼‰ ready()å‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°é€šè¿‡æŠŠéœ€è¦å”¤é†’çš„goroutineæ”¾å…¥è¿è¡Œé˜Ÿåˆ—æ¥å”¤é†’å®ƒã€‚ï¼ˆè¿™ç§æƒ…å†µåœ¨gè¢«æŒ‚åœ¨äº†å…¶ä»–åœ°æ–¹æ—¶éœ€è¦æ¢å¤åˆ°Pä¸­æ—¶ï¼‰ ä¹Ÿå°±æ˜¯åªè¦gè¢«æ”¾å…¥æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼Œå‡†å¤‡è¿è¡Œæ—¶éƒ½éœ€è¦è°ƒç”¨wakep()å‡½æ•°å°è¯•åˆ©ç”¨ç©ºé—²çš„Må’ŒPæ¥è¿è¡Œå®ƒã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 2420 2421 2422 2423 2424 2425 2426 2427 2428 2429 2430 2431 2432 2433 2434 2435 2436 2437 2438 2439 2440 2441 2442 2443 2444 2445 2446 2447 // Tries to add one more P to execute G's. // Called when a G is made runnable (newproc, ready). func wakep() { // æ²¡æœ‰ç©ºé—²çš„Pï¼Œç›´æ¥è¿”å›ã€‚å½“å‰æ‰€æœ‰çš„Péƒ½åœ¨å·¥ä½œã€‚å› ä¸ºPçš„æ•°é‡æ˜¯å›ºå®šçš„ã€‚ if atomic.Load(\u0026sched.npidle) == 0 { return } // be conservative about spinning threads // // å¯¹è‡ªæ—‹çš„çº¿ç¨‹æŒä¿å®ˆæ€åº¦ï¼š // 1. sched.nmspinning != 0ï¼šæœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨è‡ªæ—‹ï¼ˆå°±æ˜¯åœ¨å…¶ä»–çº¿ç¨‹ä¸­å»å·å–gï¼‰ // 2. !atomic.Cas(\u0026sched.nmspinning, 0, 1)ï¼šé€šè¿‡casæ“ä½œå†æ¬¡ç¡®è®¤æ˜¯å¦æœ‰å…¶ä»–å·¥ä½œçº¿ç¨‹å¤„äºspinningçŠ¶æ€ // ä»è¿›å…¥wakep()åˆ¤æ–­åˆ°çœŸæ­£å¯åŠ¨å·¥ä½œçº¿ç¨‹ä¹‹å‰çš„è¿™ä¸€æ®µæ—¶é—´ä¹‹å†…ï¼Œå¦‚æœå·²ç»æœ‰å·¥ä½œçº¿ç¨‹è¿›å…¥äº†spinningçŠ¶æ€è€Œåœ¨å››å¤„å¯»æ‰¾éœ€è¦è¿è¡Œçš„goroutine // è¿™æ ·çš„è¯æˆ‘ä»¬å°±æ²¡æœ‰å¿…è¦å†å¯åŠ¨ä¸€ä¸ªå¤šä½™çš„å·¥ä½œçº¿ç¨‹å‡ºæ¥äº† // å¦‚æœcasæ“ä½œæˆåŠŸï¼Œåˆ™ç»§ç»­è°ƒç”¨startmåˆ›å»ºä¸€ä¸ªæ–°çš„æˆ–å”¤é†’ä¸€ä¸ªå¤„äºç¡çœ çŠ¶æ€çš„å·¥ä½œçº¿ç¨‹å‡ºæ¥å·¥ä½œ // // 1. atomic.Load(\u0026sched.nmspinning) != 0 æˆç«‹ï¼šæœ‰å…¶ä»–å·¥ä½œçº¿ç¨‹æ­£åœ¨è‡ªæ—‹ï¼Œç›´æ¥returné€€å‡º // 2. atomic.Load(\u0026sched.nmspinning) == 0 æˆç«‹ï¼šå½“å‰æ²¡æœ‰å¿™ç¢Œçš„å·¥ä½œçº¿ç¨‹ // atomic.Cas(\u0026sched.nmspinning, 0, 1) == trueï¼šå½“å‰æ²¡æœ‰å¿™ç¢Œçš„å·¥ä½œçº¿ç¨‹ï¼Œå½“å‰å¯ä»¥åˆ›å»ºå·¥ä½œçº¿ç¨‹ï¼Œå¹¶æ ‡è®°sched.nmspinning=1é˜»æ­¢åæ¥è€… // atomic.Cas(\u0026sched.nmspinning, 0, 1) == falseï¼šå½“å‰æœ‰å…¶ä»–å¿™ç¢Œçš„å·¥ä½œçº¿ç¨‹ï¼Œç›´æ¥returné€€å‡º if atomic.Load(\u0026sched.nmspinning) != 0 || !atomic.Cas(\u0026sched.nmspinning, 0, 1) { return } // ç¨‹åºæ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜ï¼šsched.nmspinningä¸€å®šè¢«æ ‡è®°ä¸º1äº†ã€‚ startm(nil, true) } startm() è°ƒåº¦ä¸€äº›Mæ¥è¿è¡Œp(å¦‚æœéœ€è¦ï¼Œåˆ›å»ºä¸€ä¸ªM)ã€‚ å¦‚æœp==nilï¼Œå°è¯•å¾—åˆ°ä¸€ä¸ªç©ºé—²çš„pï¼Œå¦‚æœæ²¡æœ‰ç©ºé—²çš„pä»€ä¹ˆéƒ½ä¸åšã€‚ å¯ä»¥ä½¿ç”¨m.p==nilè¿è¡Œï¼Œå› æ­¤ä¸å…è®¸å†™å…¥éšœç¢ã€‚ å¦‚æœè®¾ç½®äº†spinningï¼Œåˆ™è°ƒç”¨è€…å¢åŠ äº†nmspinningï¼Œè€Œstartmå°†å‡å°‘nmspinningæˆ–åœ¨æ–°å¯åŠ¨çš„Mä¸­è®¾ç½®m.spinningã€‚ ä¼ é€’nilçš„Pçš„è°ƒç”¨æ–¹å¿…é¡»ä»ä¸å¯æŠ¢å çš„ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ã€‚è§ä¸‹é¢å¯¹acquiremã€‚ å¿…é¡»æ²¡æœ‰å†™éšœç¢ï¼Œå› ä¸ºè¿™ä¸ªå¯èƒ½æ²¡æœ‰Pã€‚ go:nowritebarrierrecï¼šä¸å…è®¸ç¼–è¯‘å™¨æ’å…¥å†™å±éšœç›¸å…³ä»£ç ã€‚ åœ¨æŠ¢å ç³»ç»Ÿè°ƒç”¨çš„Pçš„æ—¶å€™è¯¥å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå¹¶ä¼ å…¥ç©ºé—²çš„På’Œfalseå‚æ•°ã€‚ å‚æ•°ï¼š _p_ *pï¼šnilè¡¨ç¤ºæ²¡æœ‰æŒ‡å®šPï¼Œå¦åˆ™æŒ‡å®šPã€‚ spinning boolï¼štrue.sched.nmspinningçš„å€¼åœ¨å‰é¢è¢«åŠ ä¸€äº†ã€‚false.æ²¡æœ‰åŠ ä¸€ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 2257 2258 2259 2260 2261 2262 2263 2264 2265 2266 2267 2268 2269 2270 2271 2272 2273 2274 2275 2276 2277 2278 2279 2280 2281 2282 2283 2284 2285 2286 2287 2288 2289 2290 2291 2292 2293 2294 2295 2296 2297 2298 2299 2300 2301 2302 2303 2304 2305 2306 2307 2308 2309 2310 2311 2312 2313 2314 2315 2316 2317 2318 2319 2320 2321 2322 2323 2324 2325 2326 2327 2328 2329 2330 2331 2332 2333 2334 2335 2336 2337 2338 2339 2340 2341 2342 2343 2344 2345 2346 2347 2348 2349 2350 2351 2352 2353 2354 2355 2356 2357 2358 2359 2360 2361 2362 2363 2364 2365 2366 2367 2368 2369 2370 2371 2372 2373 2374 2375 2376 2377 2378 2379 2380 // Schedules some M to run the p (creates an M if necessary). // If p==nil, tries to get an idle P, if no idle P's does nothing. // May run with m.p==nil, so write barriers are not allowed. // If spinning is set, the caller has incremented nmspinning and startm will // either decrement nmspinning or set m.spinning in the newly started M. // // Callers passing a non-nil P must call from a non-preemptible context. See // comment on acquirem below. // // Must not have write barriers because this may be called without a P. // //go:nowritebarrierrec func startm(_p_ *p, spinning bool) { // Disable preemption. // // Every owned P must have an owner that will eventually stop it in the // event of a GC stop request. startm takes transient ownership of a P // (either from argument or pidleget below) and transfers ownership to // a started M, which will be responsible for performing the stop. // // Preemption must be disabled during this transient ownership, // otherwise the P this is running on may enter GC stop while still // holding the transient P, leaving that P in limbo and deadlocking the // STW. // // Callers passing a non-nil P must already be in non-preemptible // context, otherwise such preemption could occur on function entry to // startm. Callers passing a nil P may be preemptible, so we must // disable preemption before acquiring a P from pidleget below. mp := acquirem() // ç¦æ­¢å½“å‰Mè¢«æŠ¢å  lock(\u0026sched.lock) // é”ä½å…¨å±€sched // æœ‰ç©ºé—²çš„pæ‰ä¼šå»å”¤é†’çº¿ç¨‹ if _p_ == nil { // å¦‚æœæ²¡æœ‰æŒ‡å®šPï¼Œåˆ™éœ€è¦ä»Pçš„ç©ºé—²åˆ—è¡¨ä¸­è·å–ä¸€ä¸ªP _p_ = pidleget(0) // ä»Pçš„ç©ºé—²é˜Ÿåˆ—ä¸­è·å–ç©ºé—²çš„P // æ²¡æœ‰ç©ºé—²çš„Pï¼Œæ„å‘³ç€æ‰€æœ‰çš„Péƒ½å¾ˆå¿™ä¸éœ€è¦å”¤é†’ if _p_ == nil {\tunlock(\u0026sched.lock) // ä¹‹å‰çš„CasæŠŠnmspinningåŠ ä¸€ï¼Œè¿™é‡Œéœ€è¦å‡å›æ¥ if spinning {\t// The caller incremented nmspinning, but there are no idle Ps, // so it's okay to just undo the increment and give up. // // æ­£å¸¸é€»è¾‘è¿™é‡Œä¸åº”è¯¥å‡æˆè´Ÿæ•°ï¼Œå¦åˆ™æ˜¯ç³»ç»Ÿé€»è¾‘å­˜åœ¨é”™è¯¯ if int32(atomic.Xadd(\u0026sched.nmspinning, -1)) \u003c 0 { throw(\"startm: negative nmspinning\") } } // ä¸acquiremå‡½æ•°å‘¼åº”ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦æœ‰æŠ¢å è¯·æ±‚å‘ç”Ÿ releasem(mp)\treturn // æ²¡æœ‰ç©ºé—²çš„Pç›´æ¥è¿”å› } } // å°è¯•ä»mç©ºé—²é˜Ÿåˆ—ä¸­è·å–æ­£å¤„äºç¡çœ ä¹‹ä¸­çš„å·¥ä½œçº¿ç¨‹ // æ‰€æœ‰å¤„äºç¡çœ çŠ¶æ€çš„méƒ½åœ¨æ­¤é˜Ÿåˆ—ä¸­ nmp := mget() // æ²¡æœ‰å¤„äºç¡çœ çŠ¶æ€çš„å·¥ä½œçº¿ç¨‹ï¼Œè¿™ç§æƒ…å†µéœ€è¦å»åˆ›å»ºçº¿ç¨‹ if nmp == nil {\t// No M is available, we must drop sched.lock and call newm. // However, we already own a P to assign to the M. // // Once sched.lock is released, another G (e.g., in a syscall), // could find no idle P while checkdead finds a runnable G but // no running M's because this new M hasn't started yet, thus // throwing in an apparent deadlock. // // Avoid this situation by pre-allocating the ID for the new M, // thus marking it as 'running' before we drop sched.lock. This // new M will eventually run the scheduler to execute any // queued G's. // // è¿™é‡Œæ˜¯ä¸ºéœ€è¦æ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹å‡†å¤‡å·¥ä½œ id := mReserveID() // ç»™éœ€è¦åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹åˆ†é…ID unlock(\u0026sched.lock) // åˆå§‹åŒ–fnå‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨å·¥ä½œçº¿ç¨‹åˆšå¯åŠ¨æ—¶ä¼šè¢«è°ƒç”¨ var fn func() // nil if spinning { // å¦‚æœéœ€è¦æ ‡è®°å½“å‰å·¥ä½œçº¿ç¨‹æ˜¯è‡ªæ—‹çŠ¶æ€ // The caller incremented nmspinning, so set m.spinning in the new M. // // mspinningå‡½æ•°å°±ä¸€è¡Œä»£ç  'getg().m.spinning = true' æ ‡è®°å½“å‰å·¥ä½œçº¿ç¨‹æ˜¯è‡ªæ—‹çŠ¶æ€ // å› ä¸ºå…¨å±€çš„sched.nmspinningå·²ç»åŠ ä¸€äº†ï¼Œå› æ­¤éœ€è¦æ ‡è®°mçš„spinning fn = mspinning\t} newm(fn, _p_, id) // åˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹ // Ownership transfer of _p_ committed by start in newm. // Preemption is now safe. releasem(mp) return } // åˆ°è¿™é‡Œè¯´æ˜æœ‰æ­£åœ¨å¤„äºç¡çœ çš„å·¥ä½œçº¿ç¨‹ unlock(\u0026sched.lock) // ä»ç©ºé—²çš„çº¿ç¨‹é˜Ÿåˆ—ä¸­æ‹¿å‡ºæ¥çš„ spinning æ ‡å¿—ä½å­˜åœ¨ï¼Œè¯´æ˜sleepæ—¶æœ‰é—®é¢˜ if nmp.spinning { // ç³»ç»Ÿé€»è¾‘å­˜åœ¨é—®é¢˜ throw(\"startm: m is spinning\") } // å·¥ä½œçº¿ç¨‹è¿˜ä¸å…¶ä»–Pæœ‰å…³ï¼Œè¯´æ˜æœ‰é—®é¢˜ if nmp.nextp != 0 { // ç³»ç»Ÿé€»è¾‘å­˜åœ¨é—®é¢˜ throw(\"startm: m has p\") } // ç©ºé—²çš„Pä¸­ä¸åº”è¯¥å­˜åœ¨gï¼Œç³»ç»Ÿé€»è¾‘å­˜åœ¨é—®é¢˜ if spinning \u0026\u0026 !runqempty(_p_) {\tthrow(\"startm: p has runnable gs\") } // The caller incremented nmspinning, so set m.spinning in the new M. // // è°ƒç”¨è€…å¢åŠ nmspinningï¼Œå› æ­¤å°†m.spinningè®¾ç½®ä¸ºæ–°çš„Mã€‚å› æ­¤å½“å‰è¿™ä¸ªMå°±æ˜¯è¿™ä¸ªè‡ªæ—‹çš„M nmp.spinning = spinning // æ ‡è®°å½“å‰éœ€è¦å”¤é†’çš„å·¥ä½œçº¿ç¨‹ è‡ªæ—‹çš„çŠ¶æ€ // å½“å‰Mçš„Pæš‚æ—¶æ”¾åœ¨nextpä¸Š // è¿™é‡Œä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹ç›´æ¥åœ¨nextpå»å–Pï¼ŒåŸå› åœ¨è¿™é‡Œå…³è”çš„ // å› ä¸º_p_åªåœ¨è¿™é‡Œå­˜åœ¨ï¼Œå› æ­¤ä¸ä¼šå­˜åœ¨å…¶ä»–å·¥ä½œçº¿ç¨‹ä½¿ç”¨è¯¥Pã€‚ nmp.nextp.set(_p_)\t// å”¤é†’å·¥ä½œçº¿ç¨‹ï¼Œå·¥ä½œçº¿ç¨‹ç¡çœ åœ¨ nmp.park ä¸Šé¢ notewakeup(\u0026nmp.park)\t// Ownership transfer of _p_ committed by wakeup. Preemption is now // safe. // // å”¤é†’æäº¤çš„_p_çš„æ‰€æœ‰æƒè½¬ç§»ã€‚ æŠ¢å ç°åœ¨æ˜¯å®‰å…¨çš„ // ä¸acquiremå‡½æ•°å‘¼åº”ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦æœ‰æŠ¢å è¯·æ±‚å‘ç”Ÿ releasem(mp) } acquirem() måŠ é”ç¦æ­¢æŠ¢å å½“å‰mã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/runtime1.goã€‚ 473 474 475 476 477 478 //go:nosplit func acquirem() *m { _g_ := getg() _g_.m.locks++ return _g_.m } releasem() æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/runtime1.goã€‚ 482 483 484 485 486 487 488 489 490 func releasem(mp *m) { _g_ := getg() mp.locks-- // å½“å‰Mæ²¡æœ‰é”ï¼Œå¹¶ä¸”Géœ€è¦è¢«æŠ¢å  if mp.locks == 0 \u0026\u0026 _g_.preempt { // restore the preemption request in case we've cleared it in newstack _g_.stackguard0 = stackPreempt // è®¾ç½®æŠ¢å æ ‡å¿— } } pidleget() ä»sched.pidleä¸­å°è¯•è·å–ä¸€ä¸ªç©ºé—²çš„Pã€‚ å‚æ•°now int64ï¼š0åˆ™å–å½“å‰æ—¶é—´ç‚¹ã€‚ è¿”å›å€¼ï¼š *pï¼šè¿”å›ä¸€ä¸ªç©ºé—²çš„Pï¼Œå¦åˆ™ä¸ºnilæ²¡æœ‰ç©ºé—²çš„Pã€‚ int64ï¼šä¼ å…¥nowçš„æ—¶é—´å€¼ï¼Œ0åˆ™æ˜¯å½“å‰æ—¶é—´å€¼ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5727 5728 5729 5730 5731 5732 5733 5734 5735 5736 5737 5738 5739 5740 5741 5742 5743 5744 5745 5746 5747 5748 5749 5750 5751 5752 5753 5754 5755 5756 // pidleget tries to get a p from the _Pidle list, acquiring ownership. // // sched.lock must be held. // // May run during STW, so write barriers are not allowed. // //go:nowritebarrierrec func pidleget(now int64) (*p, int64) { // sched.lock å¿…é¡»è¢«æŒæœ‰ assertLockHeld(\u0026sched.lock) // ä»sched.pidleä¸Šè·å–ç©ºé—²çš„P _p_ := sched.pidle.ptr() if _p_ != nil { // Timer may get added at any time now. if now == 0 { now = nanotime() } // è®¾ç½®timerpMaskå’ŒidlepMask timerpMask.set(_p_.id) idlepMask.clear(_p_.id) // ä»å…¨å±€ç©ºé—²çš„Pä¸­ç§»é™¤_p_ sched.pidle = _p_.link // å…¨å±€çš„ç©ºé—²Pçš„æ¬¡æ•°å‡ä¸€ atomic.Xadd(\u0026sched.npidle, -1) // limiterEventè·Ÿè¸ªGC CPUé™åˆ¶å™¨çš„äº‹ä»¶ã€‚ _p_.limiterEvent.stop(limiterEventIdle, now) } return _p_, now } mget() å°è¯•ä»sched.midleè·å–ä¸€ä¸ªç©ºé—²çš„å·¥ä½œçº¿ç¨‹mï¼Œèµ·æ¥ç»‘å®šPè¿è¡Œã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5547 5548 5549 5550 5551 5552 5553 5554 5555 5556 5557 5558 5559 5560 5561 5562 5563 5564 // Try to get an m from midle list. // sched.lock must be held. // May run during STW, so write barriers are not allowed. // //go:nowritebarrierrec func mget() *m { assertLockHeld(\u0026sched.lock) // ç©ºé—²çš„måœ¨sched.midleä¸Š mp := sched.midle.ptr() if mp != nil { // ä»sched.midleä¸Šç§»é™¤mp sched.midle = mp.schedlink // ç©ºé—²çš„mæ•°é‡å‡ä¸€ sched.nmidle-- } return mp } mReserveID() ç»™æ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹åˆ†é…å”¯ä¸€çš„IDã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 // mReserveID returns the next ID to use for a new m. This new m is immediately // considered 'running' by checkdead. // // sched.lock must be held. func mReserveID() int64 { // sched.locké”å¿…é¡»è¢«æŒæœ‰ assertLockHeld(\u0026sched.lock) // åˆ†é…çš„IDæº¢å‡ºäº† if sched.mnext+1 \u003c sched.mnext { throw(\"runtime: thread ID overflow\") } id := sched.mnext // åˆ†é…çš„ID sched.mnext++ // ä¸‹ä¸€ä¸ªID // æ£€æŸ¥sched.mnext - sched.nmfreed \u003e sched.maxmcount // sched.maxmcount åœ¨ runtime.main ä¸­è¢«è®¾ç½®ä¸º 10000 // sched.mnext ä¸‹ä¸€ä¸ªåˆ†é…çš„IDï¼Œè¯¥å€¼æ˜¯ç´¯åŠ çš„ // sched.nmfreed å·²ç»é‡Šæ”¾çš„å·¥ä½œçº¿ç¨‹æ•°é‡ // å› æ­¤è¿™é‡Œæ˜¯æ£€æŸ¥å½“å‰å·²ç»åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹æ•°é‡ä¸èƒ½å¤§äºæœ€å¤§å€¼ checkmcount() return id } notewakeup() é¦–å…ˆä½¿ç”¨atomic.Xchgè®¾ç½®note.keyå€¼ä¸º1ã€‚ è¿™æ˜¯ä¸ºäº†ä½¿è¢«å”¤é†’çš„çº¿ç¨‹å¯ä»¥é€šè¿‡æŸ¥çœ‹è¯¥å€¼æ˜¯å¦ç­‰äº1æ¥ç¡®å®šæ˜¯è¢«å…¶å®ƒçº¿ç¨‹å”¤é†’è¿˜æ˜¯æ„å¤–ä»ç¡çœ ä¸­è‹é†’äº†è¿‡æ¥ï¼Œ å¦‚æœè¯¥å€¼ä¸º1åˆ™è¡¨ç¤ºæ˜¯è¢«å”¤é†’çš„ï¼Œå¯ä»¥ç»§ç»­å·¥ä½œäº†ã€‚ ä½†å¦‚æœè¯¥å€¼ä¸º0åˆ™è¡¨ç¤ºæ˜¯æ„å¤–è‹é†’ï¼Œéœ€è¦å†æ¬¡è¿›å…¥ç¡çœ ï¼Œ å·¥ä½œçº¿ç¨‹è‹é†’ä¹‹åçš„å¤„ç†é€»è¾‘æˆ‘ä»¬å·²ç»åœ¨notesleep()å‡½æ•°ä¸­è§è¿‡ï¼Œæ‰€ä»¥è¿™é‡Œç•¥è¿‡ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/lock_futex.goã€‚ 139 140 141 142 143 144 145 146 147 func notewakeup(n *note) { // è®¾ç½®n.key = 1, è¢«å”¤é†’çš„çº¿ç¨‹é€šè¿‡æŸ¥çœ‹è¯¥å€¼æ˜¯å¦ç­‰äº1æ¥ç¡®å®šæ˜¯è¢«å…¶å®ƒçº¿ç¨‹å”¤é†’è¿˜æ˜¯æ„å¤–ä»ç¡çœ ä¸­è‹é†’ old := atomic.Xchg(key32(\u0026n.key), 1) if old != 0 { // å¦‚æœæ—§å€¼ä¸æ˜¯0è¯´æ˜ç³»ç»Ÿé€»è¾‘æœ‰é—®é¢˜ print(\"notewakeup - double wakeup (\", old, \")\\n\") throw(\"notewakeup - double wakeup\") } futexwakeup(key32(\u0026n.key), 1) // è°ƒç”¨futexwakeupå”¤é†’ } futexwakeup() å¯¹äºLinuxå¹³å°æ¥è¯´ï¼Œå·¥ä½œçº¿ç¨‹é€šè¿‡noteç¡çœ å…¶å®æ˜¯é€šè¿‡futexç³»ç»Ÿè°ƒç”¨ç¡çœ åœ¨å†…æ ¸ä¹‹ä¸­ï¼Œ æ‰€ä»¥å”¤é†’å¤„äºç¡çœ çŠ¶æ€çš„çº¿ç¨‹ä¹Ÿéœ€è¦é€šè¿‡futexç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸æ¥å”¤é†’ã€‚ æ‰€ä»¥è¿™é‡Œçš„futexwakeup()åˆç»§ç»­è°ƒç”¨åŒ…è£…äº†futexç³»ç»Ÿè°ƒç”¨çš„futex()å‡½æ•°æ¥å®ç°å”¤é†’ç¡çœ åœ¨å†…æ ¸ä¸­çš„å·¥ä½œçº¿ç¨‹ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/os_linux.goã€‚ 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 // If any procs are sleeping on addr, wake up at most cnt. //go:nosplit func futexwakeup(addr *uint32, cnt uint32) { // è°ƒç”¨futexå‡½æ•°å”¤é†’å·¥ä½œçº¿ç¨‹ ret := futex(unsafe.Pointer(addr), _FUTEX_WAKE_PRIVATE, cnt, nil, nil, 0) if ret \u003e= 0 {\t// è°ƒç”¨æˆåŠŸæ˜¯è¿™é‡Œç›´æ¥è¿”å› return } // I don't know that futex wakeup can return // EAGAIN or EINTR, but if it does, it would be // safe to loop and call futex again. systemstack(func() { print(\"futexwakeup addr=\", addr, \" returned \", ret, \"\\n\") }) // ç¨‹åºä¸ä¼šåˆ°è¿™é‡Œæ¥ï¼Œå³ä½¿åˆ°è¿™é‡Œæ¥äº†ï¼Œå‘ä¸€ä¸ªæœªçŸ¥åœ°å€å†™å…¥æ•°æ®ç›´æ¥å®•æœº *(*int32)(unsafe.Pointer(uintptr(0x1006))) = 0x1006 } futex() futex()å‡½æ•°ç”±æ±‡ç¼–ä»£ç å†™æˆï¼Œå‰é¢çš„å‡ æ¡æŒ‡ä»¤éƒ½åœ¨ä¸ºfutexç³»ç»Ÿè°ƒç”¨å‡†å¤‡å‚æ•°ï¼Œ å‚æ•°å‡†å¤‡å®Œæˆä¹‹ååˆ™é€šè¿‡SYSCALLæŒ‡ä»¤è¿›å…¥æ“ä½œç³»ç»Ÿå†…æ ¸å®Œæˆçº¿ç¨‹çš„å”¤é†’åŠŸèƒ½ã€‚ å†…æ ¸åœ¨å®Œæˆå”¤é†’å·¥ä½œä¹‹åå½“å‰å·¥ä½œçº¿ç¨‹åˆ™ä»å†…æ ¸è¿”å›åˆ°futex()å‡½æ•°ç»§ç»­æ‰§è¡ŒSYSCALLæŒ‡ä»¤ä¹‹åçš„ä»£ç å¹¶æŒ‰å‡½æ•°è°ƒç”¨é“¾åŸè·¯è¿”å›ã€‚ ç»§ç»­æ‰§è¡Œå…¶å®ƒä»£ç ï¼Œè€Œè¢«å”¤é†’çš„å·¥ä½œçº¿ç¨‹åˆ™ç”±å†…æ ¸è´Ÿè´£åœ¨é€‚å½“çš„æ—¶å€™è°ƒåº¦åˆ°CPUä¸Šè¿è¡Œã€‚ é™·å…¥ç³»ç»Ÿè°ƒç”¨å¤ªé•¿æ—¶é—´çš„å·¥ä½œçº¿ç¨‹ä¼šåœ¨ç›‘æ§çº¿ç¨‹ä¸­å‰¥ç¦»På’ŒGï¼Œå…·ä½“çš„å‚çœ‹ç›‘æ§çº¿ç¨‹ç›¸å…³ä»£ç ã€‚è¿™é‡Œæ²¡æœ‰æ ‡è®°å·¥ä½œçº¿ç¨‹é™·å…¥ç³»ç»Ÿè°ƒç”¨çš„æ ‡å¿—ã€‚ åº”è¯¥æ˜¯å½“å‰å‡½æ•°è°ƒç”¨ä¸ä¼šå½¢æˆé˜»å¡ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/sys_linux_amd64.sã€‚ 549 550 551 552 553 554 555 556 557 558 559 560 561 562 # int64 futex(int32 *uaddr, int32 op, int32 val, # struct timespec *timeout, int32 *uaddr2, int32 val2); TEXT runtimeÂ·futex(SB),NOSPLIT,$0 #è¿™6æ¡æŒ‡ä»¤åœ¨ä¸ºfutexç³»ç»Ÿè°ƒç”¨å‡†å¤‡å‚æ•° MOVQ addr+0(FP), DI MOVL op+8(FP), SI MOVL val+12(FP), DX MOVQ ts+16(FP), R10 MOVQ addr2+24(FP), R8 MOVL val3+32(FP), R9 MOVL $SYS_futex, AX # futexç³»ç»Ÿè°ƒç”¨ç¼–å·æ”¾å…¥AXå¯„å­˜å™¨ SYSCALL # ç³»ç»Ÿè°ƒç”¨ï¼Œè¿›å…¥å†…æ ¸ MOVL AX, ret+40(FP) # ç³»ç»Ÿè°ƒç”¨é€šè¿‡AXå¯„å­˜å™¨è¿”å›è¿”å›å€¼ï¼Œè¿™é‡ŒæŠŠè¿”å›å€¼ä¿å­˜åˆ°å†…å­˜ä¹‹ä¸­ RET åˆ›å»ºå·¥ä½œçº¿ç¨‹ å¦‚æœæ²¡æœ‰æ­£å¤„äºä¼‘çœ çŠ¶æ€çš„å·¥ä½œçº¿ç¨‹ï¼Œåˆ™éœ€è¦è°ƒç”¨newm()å‡½æ•°æ–°å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ã€‚ newm() åˆ›å»ºè°ƒåº¦çº¿ç¨‹å’Œç›‘æ§çº¿ç¨‹éƒ½æ˜¯é€šè¿‡è¯¥å‡½æ•°ï¼Œæ‰§è¡Œè¯¥å‡½æ•°æ—¶éƒ½ä¼šæŠŠæ ˆåˆ‡æ¢åˆ°g0æ ˆï¼Œå› ä¸ºg0æ ˆæ¯”è¾ƒå¤§ã€‚ è¯¥å‡½æ•°åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹ä½¿ç”¨ï¼š newm(sysmon, nil, -1)ï¼šåˆ›å»ºã€ç›‘æ§çº¿ç¨‹ã€‘ã€‚ sysmonå·¥ä½œçº¿ç¨‹å¼€å§‹æ‰§è¡Œæ—¶é¦–å…ˆè°ƒç”¨çš„å‡½æ•°ã€‚ï¼ˆä¸æ˜¯å…¥å£å‡½æ•°ï¼Œnewm()åˆ›å»ºçš„å…¥å£å‡½æ•°éƒ½æ˜¯å›ºå®šçš„mstart()å‡½æ•°ï¼‰ nilè¡¨ç¤ºä¸éœ€è¦ç»‘å®šPã€‚ -1ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªé€’å¢çš„æ•°å­—ã€‚ï¼ˆå…¨å±€å”¯ä¸€çš„IDï¼‰ newm(fn, _p_, id)ï¼šåˆ›å»ºã€è°ƒåº¦çº¿ç¨‹ã€‘ã€‚ fnå·¥ä½œçº¿ç¨‹å¼€å§‹æ‰§è¡Œæ—¶é¦–å…ˆè°ƒç”¨çš„å‡½æ•°ã€‚ï¼ˆä¸æ˜¯å…¥å£å‡½æ•°ï¼Œnewm()åˆ›å»ºçš„å…¥å£å‡½æ•°éƒ½æ˜¯å›ºå®šçš„mstart()å‡½æ•°ï¼‰ _p_çº¿ç¨‹å¯åŠ¨æ—¶éœ€è¦ç»‘å®šçš„Pã€‚ åˆ›å»ºå·¥ä½œçº¿ç¨‹çš„å”¯ä¸€IDã€‚ åˆ›å»ºä¸€ä¸ªæ–°çš„mã€‚å®ƒå°†ä»å¯¹fnæˆ–è°ƒåº¦å™¨çš„è°ƒç”¨å¼€å§‹ã€‚fnéœ€è¦æ˜¯é™æ€çš„ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå †åˆ†é…é—­åŒ…ã€‚å¯ä»¥ä½¿ç”¨ m.p==nilè¿è¡Œï¼Œå› æ­¤ä¸å…è®¸å†™å…¥éšœç¢ã€‚ idæ˜¯å¯é€‰çš„ï¼Œé¢„åˆ†é…çš„Mçš„idã€‚é€šè¿‡ä¼ é€’-1æ¥çœç•¥ã€‚ go:nowritebarrierrecï¼šå‘Šè¯‰ç¼–è¯‘å™¨è¯¥å‡½æ•°åŠé‡Œé¢æ‰€è°ƒç”¨çš„å‡½æ•°éƒ½ä¸æ’å…¥å†™å±éšœä»£ç ã€‚ å‚æ•°ï¼š fn func()ï¼šæ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹å¯åŠ¨åéœ€è¦æ‰§è¡Œçš„å‡½æ•°ï¼Œä¸èƒ½æ˜¯ä¸€ä¸ªå †åˆ†é…çš„é—­åŒ…ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªé™æ€çš„å‡½æ•°ã€‚ ä¹Ÿå°±æ˜¯æ‰€æœ‰åˆ›å»ºçš„çº¿ç¨‹å…¥å£å‡½æ•°éƒ½æ˜¯mstart()å‡½æ•°æ˜¯çº¿ç¨‹çš„å…¥å£å‡½æ•°æ•°ï¼Œå‚çœ‹newosproc()å‡½æ•°ã€‚ _p_ *pï¼šæ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹éœ€è¦ç»‘å®šçš„Pï¼Œè¯¥å€¼å¯ä»¥ä¸º nilï¼Œè¡¨ç¤ºä¸ç»‘å®šPã€‚ id int64ï¼šæ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹çš„IDå€¼ï¼Œè¯¥å€¼å¯ä»¥æ˜¯-1ï¼Œè¡¨ç¤ºç³»ç»Ÿè‡ªåŠ¨åˆ†é…ä¸€ä¸ªé€’å¢çš„IDæ•°å€¼ã€‚ æ–‡ä»¶ä½ç½®ï¼š // Create a new m. It will start off with a call to fn, or else the scheduler. // fn needs to be static and not a heap allocated closure. // May run with m.p==nil, so write barriers are not allowed. // // id is optional pre-allocated m ID. Omit by passing -1. // //go:nowritebarrierrec func newm(fn func(), _p_ *p, id int64) { // allocm adds a new M to allm, but they do not start until created by // the OS in newm1 or the template thread. // // doAllThreadsSyscall requires that every M in allm will eventually // start and be signal-able, even with a STW. // // Disable preemption here until we start the thread to ensure that // newm is not preempted between allocm and starting the new thread, // ensuring that anything added to allm is guaranteed to eventually // start. // // allocmå°†ä¸€ä¸ªæ–°çš„Mæ·»åŠ åˆ°allmä¸­ï¼Œä½†æ˜¯ç›´åˆ°æ“ä½œç³»ç»Ÿåœ¨newm1æˆ–æ¨¡æ¿çº¿ç¨‹ä¸­åˆ›å»ºå®ƒä»¬æ‰å¼€å§‹ã€‚ // doAllThreadsSyscall è¦æ±‚allmä¸­çš„æ¯ä¸ªMæœ€ç»ˆéƒ½å°†å¯åŠ¨å¹¶å¯å‘é€ä¿¡å·ï¼Œå³ä½¿æ˜¯STWã€‚ // åœ¨è¿™é‡Œç¦ç”¨æŠ¢å ï¼Œç›´åˆ°æˆ‘ä»¬å¯åŠ¨çº¿ç¨‹ï¼Œä»¥ç¡®ä¿newmåœ¨allocmå’Œå¯åŠ¨æ–°çº¿ç¨‹ä¹‹é—´ä¸è¢«æŠ¢å ï¼Œç¡®ä¿æ·»åŠ åˆ°allmçš„ä»»ä½•å†…å®¹æœ€ç»ˆéƒ½èƒ½å¯åŠ¨ã€‚ acquirem()\t// ç¦æ­¢å½“å‰å·¥ä½œçº¿ç¨‹è¢«æŠ¢å  // allocmä»å †ä¸Šåˆ†é…ä¸€ä¸ªmç»“æ„ä½“ï¼Œå¹¶ç»‘å®šMä¸å…¶ä»–ç›¸å…³ä¾‹å¦‚allpç­‰ mp := allocm(_p_, fn, id) mp.nextp.set(_p_)\t// è®¾ç½®å½“å‰Méœ€è¦ç”¨åˆ°çš„P mp.sigmask = initSigmask if gp := getg(); gp != nil \u0026\u0026 gp.m != nil \u0026\u0026 (gp.m.lockedExt != 0 || gp.m.incgo) \u0026\u0026 GOOS != \"plan9\" { // We're on a locked M or a thread that may have been // started by C. The kernel state of this thread may // be strange (the user may have locked it for that // purpose). We don't want to clone that into another // thread. Instead, ask a known-good thread to create // the thread for us. // // This is disabled on Plan 9. See golang.org/issue/22227. // // TODO: This may be unnecessary on Windows, which // doesn't model thread creation off fork. lock(\u0026newmHandoff.lock) if newmHandoff.haveTemplateThread == 0 { throw(\"on a locked thread with no template thread\") } mp.schedlink = newmHandoff.newm newmHandoff.newm.set(mp) if newmHandoff.waiting { newmHandoff.waiting = false notewakeup(\u0026newmHandoff.wake) } unlock(\u0026newmHandoff.lock) // The M has not started yet, but the template thread does not // participate in STW, so it will always process queued Ms and // it is safe to releasem. releasem(getg().m) return } newm1(mp) releasem(getg().m) } ",
  "wordCount" : "1888",
  "inLanguage": "zh",
  "image": "https://heliu.site/favicon-32x32.png","datePublished": "2024-07-30T00:00:00Z",
  "dateModified": "2024-07-30T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://heliu.site/posts/golang/goroutine/newm/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://heliu.site/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://heliu.site/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://heliu.site/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://heliu.site/" title="ä¸»é¡µ">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/posts" title="æ–‡ç« ">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/archives" title="æ—¶é—´è½´">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/tags/" title="æ ‡ç­¾">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/search/" title="æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/support" title="æ‰“èµ">
                    <span>ğŸ«¶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://heliu.site/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/">Article</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/golang/">Golang åˆé›†</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/golang/goroutine/">ç¬¬12ç«  Goroutine</a></div>
    <h1 class="post-title entry-hint-parent">
      å·¥ä½œçº¿ç¨‹çš„å”¤é†’å’Œåˆ›å»º
    </h1>
    <div class="post-description">
      ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬
    </div>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2024-07-30</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2024-07-30</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>1888å­—</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>9åˆ†é’Ÿ</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &nbsp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://heliu.site/tags/golang/" target="_blank" rel="noopener">Golang</a>
            <a href="https://heliu.site/tags/goroutine/" target="_blank" rel="noopener">Goroutine</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &nbsp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%94%a4%e9%86%92%e5%b7%a5%e4%bd%9c%e7%ba%bf%e7%a8%8b" aria-label="å”¤é†’å·¥ä½œçº¿ç¨‹">å”¤é†’å·¥ä½œçº¿ç¨‹</a><ul>
                            
                    <li>
                        <a href="#wakep" aria-label="wakep()">wakep()</a></li>
                    <li>
                        <a href="#startm" aria-label="startm()">startm()</a><ul>
                            
                    <li>
                        <a href="#acquirem" aria-label="acquirem()">acquirem()</a></li>
                    <li>
                        <a href="#releasem" aria-label="releasem()">releasem()</a></li>
                    <li>
                        <a href="#pidleget" aria-label="pidleget()">pidleget()</a></li>
                    <li>
                        <a href="#mget" aria-label="mget()">mget()</a></li>
                    <li>
                        <a href="#mreserveid" aria-label="mReserveID()">mReserveID()</a></li></ul>
                    </li>
                    <li>
                        <a href="#notewakeup" aria-label="notewakeup()">notewakeup()</a></li>
                    <li>
                        <a href="#futexwakeup" aria-label="futexwakeup()">futexwakeup()</a></li>
                    <li>
                        <a href="#futex" aria-label="futex()">futex()</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%88%9b%e5%bb%ba%e5%b7%a5%e4%bd%9c%e7%ba%bf%e7%a8%8b" aria-label="åˆ›å»ºå·¥ä½œçº¿ç¨‹">åˆ›å»ºå·¥ä½œçº¿ç¨‹</a><ul>
                            
                    <li>
                        <a href="#newm" aria-label="newm()">newm()</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><h2 id="å”¤é†’å·¥ä½œçº¿ç¨‹">å”¤é†’å·¥ä½œçº¿ç¨‹<a hidden class="anchor" aria-hidden="true" href="#å”¤é†’å·¥ä½œçº¿ç¨‹">#</a></h2>
<ol>
<li>å»å°è¯•å”¤é†’å·¥ä½œçº¿ç¨‹æ¡ä»¶ï¼š<strong><code>atomic.Load(&amp;sched.npidle) != 0 &amp;&amp; atomic.Load(&amp;sched.nmspinning) == 0</code></strong>ã€‚
<ul>
<li><strong><code>atomic.Load(&amp;sched.npidle) != 0</code></strong>ï¼šæœ‰ç©ºé—²çš„<code>P</code>ã€‚</li>
<li><strong><code>atomic.Load(&amp;sched.nmspinning) == 0</code></strong>ï¼šæ²¡æœ‰å·¥ä½œçº¿ç¨‹æ­£åœ¨å°è¯•ä»å…¶ä»–å·¥ä½œçº¿ç¨‹çš„æœ¬åœ°é˜Ÿåˆ—å·å–<code>goroutine</code>ã€‚(å°±æ˜¯æ²¡æœ‰<code>spinning</code>è‡ªæ—‹çš„<code>goroutine</code>æ—¶)</li>
</ul>
</li>
<li>å”¤é†’ç©ºé—²çš„<code>P</code>å’Œ<code>M</code>ç”±<code>wakep()</code>å‡½æ•°å®Œæˆã€‚</li>
</ol>
<h3 id="wakep">wakep()<a hidden class="anchor" aria-hidden="true" href="#wakep">#</a></h3>
<ol>
<li>å°è¯•æ·»åŠ ä¸€ä¸ª<code>P</code>æ¥æ‰§è¡Œ<code>G</code>ã€‚å½“<code>G</code>æ˜¯å¯è¿è¡Œæ—¶è°ƒç”¨(<code>newproc, ready</code>)ã€‚</li>
<li><code>wakep()</code>å‡½æ•°è¢«è°ƒç”¨çš„åœ°æ–¹ï¼šã€åˆ›å»º<code>g</code>æ—¶å€™ï¼Œåœ¨<code>newproc()</code>å‡½æ•°ä¸­ï¼Œå°±æ˜¯<code>go</code>å…³é”®å­—ã€‘ï¼Œã€<code>g</code>æ”¾å›<code>P</code>çš„æ—¶å€™ï¼Œåœ¨<code>ready()</code>å‡½æ•°ä¸­ã€‘ã€‚
<ul>
<li><code>newproc()</code>å‡½æ•°ä¸­ï¼Œä¹Ÿå°±æ˜¯<code>go</code>å…³é”®å­—æ—¶ï¼Œ<code>runtime.main</code>å·²å¯åŠ¨æ—¶ã€‚ï¼ˆè¿™ç§æƒ…å†µå‘ç”Ÿåœ¨<code>go</code>å…³é”®å­—æ—¶ï¼‰</li>
<li><code>ready()</code>å‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°é€šè¿‡æŠŠéœ€è¦å”¤é†’çš„<code>goroutine</code>æ”¾å…¥è¿è¡Œé˜Ÿåˆ—æ¥å”¤é†’å®ƒã€‚ï¼ˆè¿™ç§æƒ…å†µåœ¨<code>g</code>è¢«æŒ‚åœ¨äº†å…¶ä»–åœ°æ–¹æ—¶éœ€è¦æ¢å¤åˆ°<code>P</code>ä¸­æ—¶ï¼‰</li>
</ul>
</li>
<li>ä¹Ÿå°±æ˜¯åªè¦<code>g</code>è¢«æ”¾å…¥æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼Œå‡†å¤‡è¿è¡Œæ—¶éƒ½éœ€è¦è°ƒç”¨<code>wakep()</code>å‡½æ•°å°è¯•åˆ©ç”¨ç©ºé—²çš„<code>M</code>å’Œ<code>P</code>æ¥è¿è¡Œå®ƒã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2420
</span><span class="lnt">2421
</span><span class="lnt">2422
</span><span class="lnt">2423
</span><span class="lnt">2424
</span><span class="lnt">2425
</span><span class="lnt">2426
</span><span class="lnt">2427
</span><span class="lnt">2428
</span><span class="lnt">2429
</span><span class="lnt">2430
</span><span class="lnt">2431
</span><span class="lnt">2432
</span><span class="lnt">2433
</span><span class="lnt">2434
</span><span class="lnt">2435
</span><span class="lnt">2436
</span><span class="lnt">2437
</span><span class="lnt">2438
</span><span class="lnt">2439
</span><span class="lnt">2440
</span><span class="lnt">2441
</span><span class="lnt">2442
</span><span class="lnt">2443
</span><span class="lnt">2444
</span><span class="lnt">2445
</span><span class="lnt">2446
</span><span class="lnt">2447
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Tries to add one more P to execute G&#39;s.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Called when a G is made runnable (newproc, ready).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">wakep</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ²¡æœ‰ç©ºé—²çš„Pï¼Œç›´æ¥è¿”å›ã€‚å½“å‰æ‰€æœ‰çš„Péƒ½åœ¨å·¥ä½œã€‚å› ä¸ºPçš„æ•°é‡æ˜¯å›ºå®šçš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">npidle</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// be conservative about spinning threads
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯¹è‡ªæ—‹çš„çº¿ç¨‹æŒä¿å®ˆæ€åº¦ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 	1. sched.nmspinning != 0ï¼šæœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨è‡ªæ—‹ï¼ˆå°±æ˜¯åœ¨å…¶ä»–çº¿ç¨‹ä¸­å»å·å–gï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. !atomic.Cas(&amp;sched.nmspinning, 0, 1)ï¼šé€šè¿‡casæ“ä½œå†æ¬¡ç¡®è®¤æ˜¯å¦æœ‰å…¶ä»–å·¥ä½œçº¿ç¨‹å¤„äºspinningçŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä»è¿›å…¥wakep()åˆ¤æ–­åˆ°çœŸæ­£å¯åŠ¨å·¥ä½œçº¿ç¨‹ä¹‹å‰çš„è¿™ä¸€æ®µæ—¶é—´ä¹‹å†…ï¼Œå¦‚æœå·²ç»æœ‰å·¥ä½œçº¿ç¨‹è¿›å…¥äº†spinningçŠ¶æ€è€Œåœ¨å››å¤„å¯»æ‰¾éœ€è¦è¿è¡Œçš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™æ ·çš„è¯æˆ‘ä»¬å°±æ²¡æœ‰å¿…è¦å†å¯åŠ¨ä¸€ä¸ªå¤šä½™çš„å·¥ä½œçº¿ç¨‹å‡ºæ¥äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœcasæ“ä½œæˆåŠŸï¼Œåˆ™ç»§ç»­è°ƒç”¨startmåˆ›å»ºä¸€ä¸ªæ–°çš„æˆ–å”¤é†’ä¸€ä¸ªå¤„äºç¡çœ çŠ¶æ€çš„å·¥ä½œçº¿ç¨‹å‡ºæ¥å·¥ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 1. atomic.Load(&amp;sched.nmspinning) != 0 æˆç«‹ï¼šæœ‰å…¶ä»–å·¥ä½œçº¿ç¨‹æ­£åœ¨è‡ªæ—‹ï¼Œç›´æ¥returné€€å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2. atomic.Load(&amp;sched.nmspinning) == 0 æˆç«‹ï¼šå½“å‰æ²¡æœ‰å¿™ç¢Œçš„å·¥ä½œçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    atomic.Cas(&amp;sched.nmspinning, 0, 1) == trueï¼šå½“å‰æ²¡æœ‰å¿™ç¢Œçš„å·¥ä½œçº¿ç¨‹ï¼Œå½“å‰å¯ä»¥åˆ›å»ºå·¥ä½œçº¿ç¨‹ï¼Œå¹¶æ ‡è®°sched.nmspinning=1é˜»æ­¢åæ¥è€…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    atomic.Cas(&amp;sched.nmspinning, 0, 1) == falseï¼šå½“å‰æœ‰å…¶ä»–å¿™ç¢Œçš„å·¥ä½œçº¿ç¨‹ï¼Œç›´æ¥returné€€å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">!</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Cas</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// ç¨‹åºæ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜ï¼šsched.nmspinningä¸€å®šè¢«æ ‡è®°ä¸º1äº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">startm</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="startm">startm()<a hidden class="anchor" aria-hidden="true" href="#startm">#</a></h3>
<ol>
<li>è°ƒåº¦ä¸€äº›<code>M</code>æ¥è¿è¡Œ<code>p</code>(å¦‚æœéœ€è¦ï¼Œåˆ›å»ºä¸€ä¸ª<code>M</code>)ã€‚</li>
<li>å¦‚æœ<code>p==nil</code>ï¼Œå°è¯•å¾—åˆ°ä¸€ä¸ªç©ºé—²çš„<code>p</code>ï¼Œå¦‚æœæ²¡æœ‰ç©ºé—²çš„<code>p</code>ä»€ä¹ˆéƒ½ä¸åšã€‚</li>
<li>å¯ä»¥ä½¿ç”¨<code>m.p==nil</code>è¿è¡Œï¼Œå› æ­¤ä¸å…è®¸å†™å…¥éšœç¢ã€‚</li>
<li>å¦‚æœè®¾ç½®äº†<code>spinning</code>ï¼Œåˆ™è°ƒç”¨è€…å¢åŠ äº†<code>nmspinning</code>ï¼Œè€Œ<code>startm</code>å°†å‡å°‘<code>nmspinning</code>æˆ–åœ¨æ–°å¯åŠ¨çš„<code>M</code>ä¸­è®¾ç½®<code>m.spinning</code>ã€‚</li>
<li>ä¼ é€’<code>nil</code>çš„Pçš„è°ƒç”¨æ–¹å¿…é¡»ä»ä¸å¯æŠ¢å çš„ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ã€‚è§ä¸‹é¢å¯¹<code>acquirem</code>ã€‚</li>
<li>å¿…é¡»æ²¡æœ‰å†™éšœç¢ï¼Œå› ä¸ºè¿™ä¸ªå¯èƒ½æ²¡æœ‰<code>P</code>ã€‚</li>
<li><code>go:nowritebarrierrec</code>ï¼šä¸å…è®¸ç¼–è¯‘å™¨æ’å…¥å†™å±éšœç›¸å…³ä»£ç ã€‚</li>
<li>åœ¨æŠ¢å ç³»ç»Ÿè°ƒç”¨çš„<code>P</code>çš„æ—¶å€™è¯¥å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå¹¶ä¼ å…¥ç©ºé—²çš„<code>P</code>å’Œ<code>false</code>å‚æ•°ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>_p_ *p</code>ï¼š<code>nil</code>è¡¨ç¤ºæ²¡æœ‰æŒ‡å®š<code>P</code>ï¼Œå¦åˆ™æŒ‡å®š<code>P</code>ã€‚</li>
<li><code>spinning bool</code>ï¼š<code>true</code>.<code>sched.nmspinning</code>çš„å€¼åœ¨å‰é¢è¢«åŠ ä¸€äº†ã€‚<code>false</code>.æ²¡æœ‰åŠ ä¸€ã€‚</li>
</ul>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2257
</span><span class="lnt">2258
</span><span class="lnt">2259
</span><span class="lnt">2260
</span><span class="lnt">2261
</span><span class="lnt">2262
</span><span class="lnt">2263
</span><span class="lnt">2264
</span><span class="lnt">2265
</span><span class="lnt">2266
</span><span class="lnt">2267
</span><span class="lnt">2268
</span><span class="lnt">2269
</span><span class="lnt">2270
</span><span class="lnt">2271
</span><span class="lnt">2272
</span><span class="lnt">2273
</span><span class="lnt">2274
</span><span class="lnt">2275
</span><span class="lnt">2276
</span><span class="lnt">2277
</span><span class="lnt">2278
</span><span class="lnt">2279
</span><span class="lnt">2280
</span><span class="lnt">2281
</span><span class="lnt">2282
</span><span class="lnt">2283
</span><span class="lnt">2284
</span><span class="lnt">2285
</span><span class="lnt">2286
</span><span class="lnt">2287
</span><span class="lnt">2288
</span><span class="lnt">2289
</span><span class="lnt">2290
</span><span class="lnt">2291
</span><span class="lnt">2292
</span><span class="lnt">2293
</span><span class="lnt">2294
</span><span class="lnt">2295
</span><span class="lnt">2296
</span><span class="lnt">2297
</span><span class="lnt">2298
</span><span class="lnt">2299
</span><span class="lnt">2300
</span><span class="lnt">2301
</span><span class="lnt">2302
</span><span class="lnt">2303
</span><span class="lnt">2304
</span><span class="lnt">2305
</span><span class="lnt">2306
</span><span class="lnt">2307
</span><span class="lnt">2308
</span><span class="lnt">2309
</span><span class="lnt">2310
</span><span class="lnt">2311
</span><span class="lnt">2312
</span><span class="lnt">2313
</span><span class="lnt">2314
</span><span class="lnt">2315
</span><span class="lnt">2316
</span><span class="lnt">2317
</span><span class="lnt">2318
</span><span class="lnt">2319
</span><span class="lnt">2320
</span><span class="lnt">2321
</span><span class="lnt">2322
</span><span class="lnt">2323
</span><span class="lnt">2324
</span><span class="lnt">2325
</span><span class="lnt">2326
</span><span class="lnt">2327
</span><span class="lnt">2328
</span><span class="lnt">2329
</span><span class="lnt">2330
</span><span class="lnt">2331
</span><span class="lnt">2332
</span><span class="lnt">2333
</span><span class="lnt">2334
</span><span class="lnt">2335
</span><span class="lnt">2336
</span><span class="lnt">2337
</span><span class="lnt">2338
</span><span class="lnt">2339
</span><span class="lnt">2340
</span><span class="lnt">2341
</span><span class="lnt">2342
</span><span class="lnt">2343
</span><span class="lnt">2344
</span><span class="lnt">2345
</span><span class="lnt">2346
</span><span class="lnt">2347
</span><span class="lnt">2348
</span><span class="lnt">2349
</span><span class="lnt">2350
</span><span class="lnt">2351
</span><span class="lnt">2352
</span><span class="lnt">2353
</span><span class="lnt">2354
</span><span class="lnt">2355
</span><span class="lnt">2356
</span><span class="lnt">2357
</span><span class="lnt">2358
</span><span class="lnt">2359
</span><span class="lnt">2360
</span><span class="lnt">2361
</span><span class="lnt">2362
</span><span class="lnt">2363
</span><span class="lnt">2364
</span><span class="lnt">2365
</span><span class="lnt">2366
</span><span class="lnt">2367
</span><span class="lnt">2368
</span><span class="lnt">2369
</span><span class="lnt">2370
</span><span class="lnt">2371
</span><span class="lnt">2372
</span><span class="lnt">2373
</span><span class="lnt">2374
</span><span class="lnt">2375
</span><span class="lnt">2376
</span><span class="lnt">2377
</span><span class="lnt">2378
</span><span class="lnt">2379
</span><span class="lnt">2380
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Schedules some M to run the p (creates an M if necessary).
</span></span></span><span class="line"><span class="cl"><span class="c1">// If p==nil, tries to get an idle P, if no idle P&#39;s does nothing.
</span></span></span><span class="line"><span class="cl"><span class="c1">// May run with m.p==nil, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If spinning is set, the caller has incremented nmspinning and startm will
</span></span></span><span class="line"><span class="cl"><span class="c1">// either decrement nmspinning or set m.spinning in the newly started M.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Callers passing a non-nil P must call from a non-preemptible context. See
</span></span></span><span class="line"><span class="cl"><span class="c1">// comment on acquirem below.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Must not have write barriers because this may be called without a P.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">startm</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">spinning</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Disable preemption.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Every owned P must have an owner that will eventually stop it in the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// event of a GC stop request. startm takes transient ownership of a P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// (either from argument or pidleget below) and transfers ownership to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// a started M, which will be responsible for performing the stop.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Preemption must be disabled during this transient ownership,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// otherwise the P this is running on may enter GC stop while still
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// holding the transient P, leaving that P in limbo and deadlocking the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// STW.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Callers passing a non-nil P must already be in non-preemptible
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// context, otherwise such preemption could occur on function entry to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// startm. Callers passing a nil P may be preemptible, so we must
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// disable preemption before acquiring a P from pidleget below.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">acquirem</span><span class="p">()</span>    <span class="c1">// ç¦æ­¢å½“å‰Mè¢«æŠ¢å 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>   <span class="c1">// é”ä½å…¨å±€sched
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æœ‰ç©ºé—²çš„pæ‰ä¼šå»å”¤é†’çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_p_</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>     <span class="c1">// å¦‚æœæ²¡æœ‰æŒ‡å®šPï¼Œåˆ™éœ€è¦ä»Pçš„ç©ºé—²åˆ—è¡¨ä¸­è·å–ä¸€ä¸ªP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_p_</span> <span class="p">=</span> <span class="nf">pidleget</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>   <span class="c1">// ä»Pçš„ç©ºé—²é˜Ÿåˆ—ä¸­è·å–ç©ºé—²çš„P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ²¡æœ‰ç©ºé—²çš„Pï¼Œæ„å‘³ç€æ‰€æœ‰çš„Péƒ½å¾ˆå¿™ä¸éœ€è¦å”¤é†’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">_p_</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">            <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ä¹‹å‰çš„CasæŠŠnmspinningåŠ ä¸€ï¼Œè¿™é‡Œéœ€è¦å‡å›æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">spinning</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">                <span class="c1">// The caller incremented nmspinning, but there are no idle Ps,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// so it&#39;s okay to just undo the increment and give up.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// æ­£å¸¸é€»è¾‘è¿™é‡Œä¸åº”è¯¥å‡æˆè´Ÿæ•°ï¼Œå¦åˆ™æ˜¯ç³»ç»Ÿé€»è¾‘å­˜åœ¨é”™è¯¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;startm: negative nmspinning&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ä¸acquiremå‡½æ•°å‘¼åº”ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦æœ‰æŠ¢å è¯·æ±‚å‘ç”Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">releasem</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">            <span class="k">return</span>  <span class="c1">// æ²¡æœ‰ç©ºé—²çš„Pç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// å°è¯•ä»mç©ºé—²é˜Ÿåˆ—ä¸­è·å–æ­£å¤„äºç¡çœ ä¹‹ä¸­çš„å·¥ä½œçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ‰€æœ‰å¤„äºç¡çœ çŠ¶æ€çš„méƒ½åœ¨æ­¤é˜Ÿåˆ—ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nmp</span> <span class="o">:=</span> <span class="nf">mget</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// æ²¡æœ‰å¤„äºç¡çœ çŠ¶æ€çš„å·¥ä½œçº¿ç¨‹ï¼Œè¿™ç§æƒ…å†µéœ€è¦å»åˆ›å»ºçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">nmp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">        <span class="c1">// No M is available, we must drop sched.lock and call newm.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// However, we already own a P to assign to the M.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Once sched.lock is released, another G (e.g., in a syscall),
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// could find no idle P while checkdead finds a runnable G but
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// no running M&#39;s because this new M hasn&#39;t started yet, thus
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// throwing in an apparent deadlock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Avoid this situation by pre-allocating the ID for the new M,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// thus marking it as &#39;running&#39; before we drop sched.lock. This
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// new M will eventually run the scheduler to execute any
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// queued G&#39;s.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿™é‡Œæ˜¯ä¸ºéœ€è¦æ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹å‡†å¤‡å·¥ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">id</span> <span class="o">:=</span> <span class="nf">mReserveID</span><span class="p">()</span>      <span class="c1">// ç»™éœ€è¦åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹åˆ†é…ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆå§‹åŒ–fnå‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨å·¥ä½œçº¿ç¨‹åˆšå¯åŠ¨æ—¶ä¼šè¢«è°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">var</span> <span class="nx">fn</span> <span class="kd">func</span><span class="p">()</span>   <span class="c1">// nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">spinning</span> <span class="p">{</span>   <span class="c1">// å¦‚æœéœ€è¦æ ‡è®°å½“å‰å·¥ä½œçº¿ç¨‹æ˜¯è‡ªæ—‹çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// The caller incremented nmspinning, so set m.spinning in the new M.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// mspinningå‡½æ•°å°±ä¸€è¡Œä»£ç  &#39;getg().m.spinning = true&#39; æ ‡è®°å½“å‰å·¥ä½œçº¿ç¨‹æ˜¯è‡ªæ—‹çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å› ä¸ºå…¨å±€çš„sched.nmspinningå·²ç»åŠ ä¸€äº†ï¼Œå› æ­¤éœ€è¦æ ‡è®°mçš„spinning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">fn</span> <span class="p">=</span> <span class="nx">mspinning</span>	
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">newm</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">_p_</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>   <span class="c1">// åˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Ownership transfer of _p_ committed by start in newm.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Preemption is now safe.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">releasem</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ°è¿™é‡Œè¯´æ˜æœ‰æ­£åœ¨å¤„äºç¡çœ çš„å·¥ä½œçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»ç©ºé—²çš„çº¿ç¨‹é˜Ÿåˆ—ä¸­æ‹¿å‡ºæ¥çš„ spinning æ ‡å¿—ä½å­˜åœ¨ï¼Œè¯´æ˜sleepæ—¶æœ‰é—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">nmp</span><span class="p">.</span><span class="nx">spinning</span> <span class="p">{</span> <span class="c1">// ç³»ç»Ÿé€»è¾‘å­˜åœ¨é—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;startm: m is spinning&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å·¥ä½œçº¿ç¨‹è¿˜ä¸å…¶ä»–Pæœ‰å…³ï¼Œè¯´æ˜æœ‰é—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">nmp</span><span class="p">.</span><span class="nx">nextp</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// ç³»ç»Ÿé€»è¾‘å­˜åœ¨é—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;startm: m has p&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç©ºé—²çš„Pä¸­ä¸åº”è¯¥å­˜åœ¨gï¼Œç³»ç»Ÿé€»è¾‘å­˜åœ¨é—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">spinning</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nf">runqempty</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;startm: p has runnable gs&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// The caller incremented nmspinning, so set m.spinning in the new M.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è°ƒç”¨è€…å¢åŠ nmspinningï¼Œå› æ­¤å°†m.spinningè®¾ç½®ä¸ºæ–°çš„Mã€‚å› æ­¤å½“å‰è¿™ä¸ªMå°±æ˜¯è¿™ä¸ªè‡ªæ—‹çš„M
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nmp</span><span class="p">.</span><span class="nx">spinning</span> <span class="p">=</span> <span class="nx">spinning</span> <span class="c1">// æ ‡è®°å½“å‰éœ€è¦å”¤é†’çš„å·¥ä½œçº¿ç¨‹ è‡ªæ—‹çš„çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰Mçš„Pæš‚æ—¶æ”¾åœ¨nextpä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹ç›´æ¥åœ¨nextpå»å–Pï¼ŒåŸå› åœ¨è¿™é‡Œå…³è”çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› ä¸º_p_åªåœ¨è¿™é‡Œå­˜åœ¨ï¼Œå› æ­¤ä¸ä¼šå­˜åœ¨å…¶ä»–å·¥ä½œçº¿ç¨‹ä½¿ç”¨è¯¥Pã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nmp</span><span class="p">.</span><span class="nx">nextp</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">    <span class="c1">// å”¤é†’å·¥ä½œçº¿ç¨‹ï¼Œå·¥ä½œçº¿ç¨‹ç¡çœ åœ¨ nmp.park ä¸Šé¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">notewakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">nmp</span><span class="p">.</span><span class="nx">park</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">    <span class="c1">// Ownership transfer of _p_ committed by wakeup. Preemption is now
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// safe.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å”¤é†’æäº¤çš„_p_çš„æ‰€æœ‰æƒè½¬ç§»ã€‚ æŠ¢å ç°åœ¨æ˜¯å®‰å…¨çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸acquiremå‡½æ•°å‘¼åº”ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦æœ‰æŠ¢å è¯·æ±‚å‘ç”Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">releasem</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="acquirem">acquirem()<a hidden class="anchor" aria-hidden="true" href="#acquirem">#</a></h4>
<ol>
<li><code>m</code>åŠ é”ç¦æ­¢æŠ¢å å½“å‰<code>m</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/runtime1.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">acquirem</span><span class="p">()</span> <span class="o">*</span><span class="nx">m</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">locks</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="releasem">releasem()<a hidden class="anchor" aria-hidden="true" href="#releasem">#</a></h4>
<ol>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/runtime1.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">releasem</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">locks</span><span class="o">--</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰Mæ²¡æœ‰é”ï¼Œå¹¶ä¸”Géœ€è¦è¢«æŠ¢å 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">locks</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">preempt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// restore the preemption request in case we&#39;ve cleared it in newstack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_g_</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">stackPreempt</span> <span class="c1">// è®¾ç½®æŠ¢å æ ‡å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="pidleget">pidleget()<a hidden class="anchor" aria-hidden="true" href="#pidleget">#</a></h4>
<ol>
<li>ä»<code>sched.pidle</code>ä¸­å°è¯•è·å–ä¸€ä¸ªç©ºé—²çš„<code>P</code>ã€‚</li>
<li>å‚æ•°<code>now int64</code>ï¼š0åˆ™å–å½“å‰æ—¶é—´ç‚¹ã€‚</li>
<li>è¿”å›å€¼ï¼š
<ul>
<li><code>*p</code>ï¼šè¿”å›ä¸€ä¸ªç©ºé—²çš„<code>P</code>ï¼Œå¦åˆ™ä¸º<code>nil</code>æ²¡æœ‰ç©ºé—²çš„<code>P</code>ã€‚</li>
<li><code>int64</code>ï¼šä¼ å…¥<code>now</code>çš„æ—¶é—´å€¼ï¼Œ0åˆ™æ˜¯å½“å‰æ—¶é—´å€¼ã€‚</li>
</ul>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5727
</span><span class="lnt">5728
</span><span class="lnt">5729
</span><span class="lnt">5730
</span><span class="lnt">5731
</span><span class="lnt">5732
</span><span class="lnt">5733
</span><span class="lnt">5734
</span><span class="lnt">5735
</span><span class="lnt">5736
</span><span class="lnt">5737
</span><span class="lnt">5738
</span><span class="lnt">5739
</span><span class="lnt">5740
</span><span class="lnt">5741
</span><span class="lnt">5742
</span><span class="lnt">5743
</span><span class="lnt">5744
</span><span class="lnt">5745
</span><span class="lnt">5746
</span><span class="lnt">5747
</span><span class="lnt">5748
</span><span class="lnt">5749
</span><span class="lnt">5750
</span><span class="lnt">5751
</span><span class="lnt">5752
</span><span class="lnt">5753
</span><span class="lnt">5754
</span><span class="lnt">5755
</span><span class="lnt">5756
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pidleget tries to get a p from the _Pidle list, acquiring ownership.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// May run during STW, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">pidleget</span><span class="p">(</span><span class="nx">now</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// sched.lock å¿…é¡»è¢«æŒæœ‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»sched.pidleä¸Šè·å–ç©ºé—²çš„P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span> <span class="o">:=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">pidle</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_p_</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Timer may get added at any time now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">now</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">now</span> <span class="p">=</span> <span class="nf">nanotime</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è®¾ç½®timerpMaskå’ŒidlepMask
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">timerpMask</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">idlepMask</span><span class="p">.</span><span class="nb">clear</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä»å…¨å±€ç©ºé—²çš„Pä¸­ç§»é™¤_p_
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sched</span><span class="p">.</span><span class="nx">pidle</span> <span class="p">=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">link</span> 
</span></span><span class="line"><span class="cl">        <span class="c1">// å…¨å±€çš„ç©ºé—²Pçš„æ¬¡æ•°å‡ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">npidle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// limiterEventè·Ÿè¸ªGC CPUé™åˆ¶å™¨çš„äº‹ä»¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_p_</span><span class="p">.</span><span class="nx">limiterEvent</span><span class="p">.</span><span class="nf">stop</span><span class="p">(</span><span class="nx">limiterEventIdle</span><span class="p">,</span> <span class="nx">now</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">_p_</span><span class="p">,</span> <span class="nx">now</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="mget">mget()<a hidden class="anchor" aria-hidden="true" href="#mget">#</a></h4>
<ol>
<li>å°è¯•ä»<code>sched.midle</code>è·å–ä¸€ä¸ªç©ºé—²çš„å·¥ä½œçº¿ç¨‹<code>m</code>ï¼Œèµ·æ¥ç»‘å®š<code>P</code>è¿è¡Œã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5547
</span><span class="lnt">5548
</span><span class="lnt">5549
</span><span class="lnt">5550
</span><span class="lnt">5551
</span><span class="lnt">5552
</span><span class="lnt">5553
</span><span class="lnt">5554
</span><span class="lnt">5555
</span><span class="lnt">5556
</span><span class="lnt">5557
</span><span class="lnt">5558
</span><span class="lnt">5559
</span><span class="lnt">5560
</span><span class="lnt">5561
</span><span class="lnt">5562
</span><span class="lnt">5563
</span><span class="lnt">5564
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Try to get an m from midle list.
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held.
</span></span></span><span class="line"><span class="cl"><span class="c1">// May run during STW, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mget</span><span class="p">()</span> <span class="o">*</span><span class="nx">m</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ç©ºé—²çš„måœ¨sched.midleä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mp</span> <span class="o">:=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">midle</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">mp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä»sched.midleä¸Šç§»é™¤mp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sched</span><span class="p">.</span><span class="nx">midle</span> <span class="p">=</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">schedlink</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ç©ºé—²çš„mæ•°é‡å‡ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sched</span><span class="p">.</span><span class="nx">nmidle</span><span class="o">--</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">mp</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="mreserveid">mReserveID()<a hidden class="anchor" aria-hidden="true" href="#mreserveid">#</a></h4>
<ol>
<li>ç»™æ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹åˆ†é…å”¯ä¸€çš„<code>ID</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">769
</span><span class="lnt">770
</span><span class="lnt">771
</span><span class="lnt">772
</span><span class="lnt">773
</span><span class="lnt">774
</span><span class="lnt">775
</span><span class="lnt">776
</span><span class="lnt">777
</span><span class="lnt">778
</span><span class="lnt">779
</span><span class="lnt">780
</span><span class="lnt">781
</span><span class="lnt">782
</span><span class="lnt">783
</span><span class="lnt">784
</span><span class="lnt">785
</span><span class="lnt">786
</span><span class="lnt">787
</span><span class="lnt">788
</span><span class="lnt">789
</span><span class="lnt">790
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// mReserveID returns the next ID to use for a new m. This new m is immediately
</span></span></span><span class="line"><span class="cl"><span class="c1">// considered &#39;running&#39; by checkdead.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mReserveID</span><span class="p">()</span> <span class="kt">int64</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// sched.locké”å¿…é¡»è¢«æŒæœ‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ†é…çš„IDæº¢å‡ºäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">mnext</span><span class="o">+</span><span class="mi">1</span> <span class="p">&lt;</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">mnext</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runtime: thread ID overflow&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">id</span> <span class="o">:=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">mnext</span> <span class="c1">// åˆ†é…çš„ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sched</span><span class="p">.</span><span class="nx">mnext</span><span class="o">++</span> <span class="c1">// ä¸‹ä¸€ä¸ªID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ£€æŸ¥sched.mnext - sched.nmfreed &gt; sched.maxmcount
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sched.maxmcount åœ¨ runtime.main ä¸­è¢«è®¾ç½®ä¸º 10000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sched.mnext ä¸‹ä¸€ä¸ªåˆ†é…çš„IDï¼Œè¯¥å€¼æ˜¯ç´¯åŠ çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sched.nmfreed å·²ç»é‡Šæ”¾çš„å·¥ä½œçº¿ç¨‹æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› æ­¤è¿™é‡Œæ˜¯æ£€æŸ¥å½“å‰å·²ç»åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹æ•°é‡ä¸èƒ½å¤§äºæœ€å¤§å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">checkmcount</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">id</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="notewakeup">notewakeup()<a hidden class="anchor" aria-hidden="true" href="#notewakeup">#</a></h3>
<ol>
<li>é¦–å…ˆä½¿ç”¨<code>atomic.Xchg</code>è®¾ç½®<code>note.key</code>å€¼ä¸º1ã€‚</li>
<li>è¿™æ˜¯ä¸ºäº†ä½¿è¢«å”¤é†’çš„çº¿ç¨‹å¯ä»¥é€šè¿‡æŸ¥çœ‹è¯¥å€¼æ˜¯å¦ç­‰äº1æ¥ç¡®å®šæ˜¯è¢«å…¶å®ƒçº¿ç¨‹å”¤é†’è¿˜æ˜¯æ„å¤–ä»ç¡çœ ä¸­è‹é†’äº†è¿‡æ¥ï¼Œ</li>
<li>å¦‚æœè¯¥å€¼ä¸º1åˆ™è¡¨ç¤ºæ˜¯è¢«å”¤é†’çš„ï¼Œå¯ä»¥ç»§ç»­å·¥ä½œäº†ã€‚</li>
<li>ä½†å¦‚æœè¯¥å€¼ä¸º0åˆ™è¡¨ç¤ºæ˜¯æ„å¤–è‹é†’ï¼Œéœ€è¦å†æ¬¡è¿›å…¥ç¡çœ ï¼Œ</li>
<li>å·¥ä½œçº¿ç¨‹è‹é†’ä¹‹åçš„å¤„ç†é€»è¾‘æˆ‘ä»¬å·²ç»åœ¨<code>notesleep</code>()å‡½æ•°ä¸­è§è¿‡ï¼Œæ‰€ä»¥è¿™é‡Œç•¥è¿‡ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/lock_futex.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">notewakeup</span><span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">note</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è®¾ç½®n.key = 1, è¢«å”¤é†’çš„çº¿ç¨‹é€šè¿‡æŸ¥çœ‹è¯¥å€¼æ˜¯å¦ç­‰äº1æ¥ç¡®å®šæ˜¯è¢«å…¶å®ƒçº¿ç¨‹å”¤é†’è¿˜æ˜¯æ„å¤–ä»ç¡çœ ä¸­è‹é†’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">old</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xchg</span><span class="p">(</span><span class="nf">key32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">n</span><span class="p">.</span><span class="nx">key</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">old</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>   <span class="c1">// å¦‚æœæ—§å€¼ä¸æ˜¯0è¯´æ˜ç³»ç»Ÿé€»è¾‘æœ‰é—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;notewakeup - double wakeup (&#34;</span><span class="p">,</span> <span class="nx">old</span><span class="p">,</span> <span class="s">&#34;)\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;notewakeup - double wakeup&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">futexwakeup</span><span class="p">(</span><span class="nf">key32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">n</span><span class="p">.</span><span class="nx">key</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// è°ƒç”¨futexwakeupå”¤é†’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="futexwakeup">futexwakeup()<a hidden class="anchor" aria-hidden="true" href="#futexwakeup">#</a></h3>
<ol>
<li>å¯¹äº<code>Linux</code>å¹³å°æ¥è¯´ï¼Œå·¥ä½œçº¿ç¨‹é€šè¿‡<code>note</code>ç¡çœ å…¶å®æ˜¯é€šè¿‡<code>futex</code>ç³»ç»Ÿè°ƒç”¨ç¡çœ åœ¨å†…æ ¸ä¹‹ä¸­ï¼Œ</li>
<li>æ‰€ä»¥å”¤é†’å¤„äºç¡çœ çŠ¶æ€çš„çº¿ç¨‹ä¹Ÿéœ€è¦é€šè¿‡<code>futex</code>ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸æ¥å”¤é†’ã€‚</li>
<li>æ‰€ä»¥è¿™é‡Œçš„<code>futexwakeup()</code>åˆç»§ç»­è°ƒç”¨åŒ…è£…äº†<code>futex</code>ç³»ç»Ÿè°ƒç”¨çš„<code>futex()</code>å‡½æ•°æ¥å®ç°å”¤é†’ç¡çœ åœ¨å†…æ ¸ä¸­çš„å·¥ä½œçº¿ç¨‹ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/os_linux.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// If any procs are sleeping on addr, wake up at most cnt.
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">futexwakeup</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">uint32</span><span class="p">,</span> <span class="nx">cnt</span> <span class="kt">uint32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒç”¨futexå‡½æ•°å”¤é†’å·¥ä½œçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ret</span> <span class="o">:=</span> <span class="nf">futex</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">addr</span><span class="p">),</span> <span class="nx">_FUTEX_WAKE_PRIVATE</span><span class="p">,</span> <span class="nx">cnt</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">{</span>	<span class="c1">// è°ƒç”¨æˆåŠŸæ˜¯è¿™é‡Œç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// I don&#39;t know that futex wakeup can return
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// EAGAIN or EINTR, but if it does, it would be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// safe to loop and call futex again.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;futexwakeup addr=&#34;</span><span class="p">,</span> <span class="nx">addr</span><span class="p">,</span> <span class="s">&#34; returned &#34;</span><span class="p">,</span> <span class="nx">ret</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ç¨‹åºä¸ä¼šåˆ°è¿™é‡Œæ¥ï¼Œå³ä½¿åˆ°è¿™é‡Œæ¥äº†ï¼Œå‘ä¸€ä¸ªæœªçŸ¥åœ°å€å†™å…¥æ•°æ®ç›´æ¥å®•æœº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">int32</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nb">uintptr</span><span class="p">(</span><span class="mh">0x1006</span><span class="p">)))</span> <span class="p">=</span> <span class="mh">0x1006</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="futex">futex()<a hidden class="anchor" aria-hidden="true" href="#futex">#</a></h3>
<ol>
<li><code>futex()</code>å‡½æ•°ç”±æ±‡ç¼–ä»£ç å†™æˆï¼Œå‰é¢çš„å‡ æ¡æŒ‡ä»¤éƒ½åœ¨ä¸º<code>futex</code>ç³»ç»Ÿè°ƒç”¨å‡†å¤‡å‚æ•°ï¼Œ</li>
<li>å‚æ•°å‡†å¤‡å®Œæˆä¹‹ååˆ™é€šè¿‡<code>SYSCALL</code>æŒ‡ä»¤è¿›å…¥æ“ä½œç³»ç»Ÿå†…æ ¸å®Œæˆçº¿ç¨‹çš„å”¤é†’åŠŸèƒ½ã€‚</li>
<li>å†…æ ¸åœ¨å®Œæˆå”¤é†’å·¥ä½œä¹‹åå½“å‰å·¥ä½œçº¿ç¨‹åˆ™ä»å†…æ ¸è¿”å›åˆ°<code>futex()</code>å‡½æ•°ç»§ç»­æ‰§è¡Œ<code>SYSCALL</code>æŒ‡ä»¤ä¹‹åçš„ä»£ç å¹¶æŒ‰å‡½æ•°è°ƒç”¨é“¾åŸè·¯è¿”å›ã€‚</li>
<li>ç»§ç»­æ‰§è¡Œå…¶å®ƒä»£ç ï¼Œè€Œè¢«å”¤é†’çš„å·¥ä½œçº¿ç¨‹åˆ™ç”±å†…æ ¸è´Ÿè´£åœ¨é€‚å½“çš„æ—¶å€™è°ƒåº¦åˆ°<code>CPU</code>ä¸Šè¿è¡Œã€‚</li>
<li>é™·å…¥ç³»ç»Ÿè°ƒç”¨å¤ªé•¿æ—¶é—´çš„å·¥ä½œçº¿ç¨‹ä¼šåœ¨ç›‘æ§çº¿ç¨‹ä¸­å‰¥ç¦»<code>P</code>å’Œ<code>G</code>ï¼Œå…·ä½“çš„å‚çœ‹ç›‘æ§çº¿ç¨‹ç›¸å…³ä»£ç ã€‚è¿™é‡Œæ²¡æœ‰æ ‡è®°å·¥ä½œçº¿ç¨‹é™·å…¥ç³»ç»Ÿè°ƒç”¨çš„æ ‡å¿—ã€‚</li>
<li>åº”è¯¥æ˜¯å½“å‰å‡½æ•°è°ƒç”¨ä¸ä¼šå½¢æˆé˜»å¡ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/sys_linux_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1"># int64 futex(int32 *uaddr, int32 op, int32 val,
</span></span></span><span class="line"><span class="cl"><span class="c1">#   struct timespec *timeout, int32 *uaddr2, int32 val2);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">futex</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="p">,</span><span class="no">$0</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#è¿™6æ¡æŒ‡ä»¤åœ¨ä¸ºfutexç³»ç»Ÿè°ƒç”¨å‡†å¤‡å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">addr</span><span class="err">+</span><span class="mi">0</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">DI</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">op</span><span class="err">+</span><span class="mi">8</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">SI</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">val</span><span class="err">+</span><span class="mi">12</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">DX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">ts</span><span class="err">+</span><span class="mi">16</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">R10</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">addr2</span><span class="err">+</span><span class="mi">24</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">R8</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">val3</span><span class="err">+</span><span class="mi">32</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">R9</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">$SYS_futex</span><span class="p">,</span> <span class="no">AX</span>  <span class="c1"># futexç³»ç»Ÿè°ƒç”¨ç¼–å·æ”¾å…¥AXå¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">SYSCALL</span>                 <span class="c1"># ç³»ç»Ÿè°ƒç”¨ï¼Œè¿›å…¥å†…æ ¸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVL</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">ret</span><span class="err">+</span><span class="mi">40</span><span class="p">(</span><span class="no">FP</span><span class="p">)</span>  <span class="c1"># ç³»ç»Ÿè°ƒç”¨é€šè¿‡AXå¯„å­˜å™¨è¿”å›è¿”å›å€¼ï¼Œè¿™é‡ŒæŠŠè¿”å›å€¼ä¿å­˜åˆ°å†…å­˜ä¹‹ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="åˆ›å»ºå·¥ä½œçº¿ç¨‹">åˆ›å»ºå·¥ä½œçº¿ç¨‹<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºå·¥ä½œçº¿ç¨‹">#</a></h2>
<ol>
<li>å¦‚æœæ²¡æœ‰æ­£å¤„äºä¼‘çœ çŠ¶æ€çš„å·¥ä½œçº¿ç¨‹ï¼Œåˆ™éœ€è¦è°ƒç”¨<code>newm()</code>å‡½æ•°æ–°å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ã€‚</li>
</ol>
<h3 id="newm">newm()<a hidden class="anchor" aria-hidden="true" href="#newm">#</a></h3>
<ol>
<li>åˆ›å»ºè°ƒåº¦çº¿ç¨‹å’Œç›‘æ§çº¿ç¨‹éƒ½æ˜¯é€šè¿‡è¯¥å‡½æ•°ï¼Œæ‰§è¡Œè¯¥å‡½æ•°æ—¶éƒ½ä¼šæŠŠæ ˆåˆ‡æ¢åˆ°<code>g0</code>æ ˆï¼Œå› ä¸º<code>g0</code>æ ˆæ¯”è¾ƒå¤§ã€‚</li>
<li>è¯¥å‡½æ•°åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹ä½¿ç”¨ï¼š
<ol>
<li><strong>newm(sysmon, nil, -1)</strong>ï¼šåˆ›å»ºã€<strong>ç›‘æ§çº¿ç¨‹</strong>ã€‘ã€‚
<ul>
<li><code>sysmon</code>å·¥ä½œçº¿ç¨‹å¼€å§‹æ‰§è¡Œæ—¶é¦–å…ˆè°ƒç”¨çš„å‡½æ•°ã€‚ï¼ˆä¸æ˜¯å…¥å£å‡½æ•°ï¼Œ<code>newm()</code>åˆ›å»ºçš„å…¥å£å‡½æ•°éƒ½æ˜¯å›ºå®šçš„<code>mstart()</code>å‡½æ•°ï¼‰</li>
<li><code>nil</code>è¡¨ç¤ºä¸éœ€è¦ç»‘å®š<code>P</code>ã€‚</li>
<li><code>-1</code>ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªé€’å¢çš„æ•°å­—ã€‚ï¼ˆå…¨å±€å”¯ä¸€çš„<code>ID</code>ï¼‰</li>
</ul>
</li>
<li><strong>newm(fn, <code>_p_</code>, id)</strong>ï¼šåˆ›å»ºã€<strong>è°ƒåº¦çº¿ç¨‹</strong>ã€‘ã€‚
<ul>
<li><code>fn</code>å·¥ä½œçº¿ç¨‹å¼€å§‹æ‰§è¡Œæ—¶é¦–å…ˆè°ƒç”¨çš„å‡½æ•°ã€‚ï¼ˆä¸æ˜¯å…¥å£å‡½æ•°ï¼Œ<code>newm()</code>åˆ›å»ºçš„å…¥å£å‡½æ•°éƒ½æ˜¯å›ºå®šçš„<code>mstart()</code>å‡½æ•°ï¼‰</li>
<li><code>_p_</code>çº¿ç¨‹å¯åŠ¨æ—¶éœ€è¦ç»‘å®šçš„<code>P</code>ã€‚</li>
<li>åˆ›å»ºå·¥ä½œçº¿ç¨‹çš„å”¯ä¸€<code>ID</code>ã€‚</li>
</ul>
</li>
</ol>
</li>
<li>åˆ›å»ºä¸€ä¸ªæ–°çš„<code>m</code>ã€‚å®ƒå°†ä»å¯¹<strong>fn</strong>æˆ–<strong>è°ƒåº¦å™¨çš„è°ƒç”¨</strong>å¼€å§‹ã€‚fnéœ€è¦æ˜¯é™æ€çš„ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå †åˆ†é…é—­åŒ…ã€‚å¯ä»¥ä½¿ç”¨ <code>m.p==nil</code>è¿è¡Œï¼Œå› æ­¤ä¸å…è®¸å†™å…¥éšœç¢ã€‚</li>
<li><code>id</code>æ˜¯å¯é€‰çš„ï¼Œé¢„åˆ†é…çš„<code>M</code>çš„<code>id</code>ã€‚é€šè¿‡ä¼ é€’<code>-1</code>æ¥çœç•¥ã€‚</li>
<li><code>go:nowritebarrierrec</code>ï¼šå‘Šè¯‰ç¼–è¯‘å™¨è¯¥å‡½æ•°åŠé‡Œé¢æ‰€è°ƒç”¨çš„å‡½æ•°éƒ½ä¸æ’å…¥å†™å±éšœä»£ç ã€‚</li>
<li>å‚æ•°ï¼š
<ol>
<li><strong><code>fn func()</code></strong>ï¼šæ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹å¯åŠ¨åéœ€è¦æ‰§è¡Œçš„å‡½æ•°ï¼Œä¸èƒ½æ˜¯ä¸€ä¸ªå †åˆ†é…çš„é—­åŒ…ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªé™æ€çš„å‡½æ•°ã€‚
<ul>
<li>ä¹Ÿå°±æ˜¯æ‰€æœ‰åˆ›å»ºçš„çº¿ç¨‹å…¥å£å‡½æ•°éƒ½æ˜¯mstart()å‡½æ•°æ˜¯çº¿ç¨‹çš„å…¥å£å‡½æ•°æ•°ï¼Œå‚çœ‹<code>newosproc()</code>å‡½æ•°ã€‚</li>
</ul>
</li>
<li><strong><code>_p_ *p</code></strong>ï¼šæ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹éœ€è¦ç»‘å®šçš„<code>P</code>ï¼Œè¯¥å€¼å¯ä»¥ä¸º <code>nil</code>ï¼Œè¡¨ç¤ºä¸ç»‘å®š<code>P</code>ã€‚</li>
<li><strong><code>id int64</code></strong>ï¼šæ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹çš„<code>ID</code>å€¼ï¼Œè¯¥å€¼å¯ä»¥æ˜¯<code>-1</code>ï¼Œè¡¨ç¤ºç³»ç»Ÿè‡ªåŠ¨åˆ†é…ä¸€ä¸ªé€’å¢çš„<code>ID</code>æ•°å€¼ã€‚</li>
</ol>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Create a new m. It will start off with a call to fn, or else the scheduler.
</span></span></span><span class="line"><span class="cl"><span class="c1">// fn needs to be static and not a heap allocated closure.
</span></span></span><span class="line"><span class="cl"><span class="c1">// May run with m.p==nil, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// id is optional pre-allocated m ID. Omit by passing -1.
</span></span></span><span class="line"><span class="cl"><span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newm</span><span class="p">(</span><span class="nx">fn</span> <span class="kd">func</span><span class="p">(),</span> <span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// allocm adds a new M to allm, but they do not start until created by
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the OS in newm1 or the template thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// doAllThreadsSyscall requires that every M in allm will eventually
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// start and be signal-able, even with a STW.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Disable preemption here until we start the thread to ensure that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// newm is not preempted between allocm and starting the new thread,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ensuring that anything added to allm is guaranteed to eventually
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// start.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// allocmå°†ä¸€ä¸ªæ–°çš„Mæ·»åŠ åˆ°allmä¸­ï¼Œä½†æ˜¯ç›´åˆ°æ“ä½œç³»ç»Ÿåœ¨newm1æˆ–æ¨¡æ¿çº¿ç¨‹ä¸­åˆ›å»ºå®ƒä»¬æ‰å¼€å§‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// doAllThreadsSyscall è¦æ±‚allmä¸­çš„æ¯ä¸ªMæœ€ç»ˆéƒ½å°†å¯åŠ¨å¹¶å¯å‘é€ä¿¡å·ï¼Œå³ä½¿æ˜¯STWã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨è¿™é‡Œç¦ç”¨æŠ¢å ï¼Œç›´åˆ°æˆ‘ä»¬å¯åŠ¨çº¿ç¨‹ï¼Œä»¥ç¡®ä¿newmåœ¨allocmå’Œå¯åŠ¨æ–°çº¿ç¨‹ä¹‹é—´ä¸è¢«æŠ¢å ï¼Œç¡®ä¿æ·»åŠ åˆ°allmçš„ä»»ä½•å†…å®¹æœ€ç»ˆéƒ½èƒ½å¯åŠ¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">acquirem</span><span class="p">()</span>	<span class="c1">// ç¦æ­¢å½“å‰å·¥ä½œçº¿ç¨‹è¢«æŠ¢å 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// allocmä»å †ä¸Šåˆ†é…ä¸€ä¸ªmç»“æ„ä½“ï¼Œå¹¶ç»‘å®šMä¸å…¶ä»–ç›¸å…³ä¾‹å¦‚allpç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">allocm</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">nextp</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>	<span class="c1">// è®¾ç½®å½“å‰Méœ€è¦ç”¨åˆ°çš„P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mp</span><span class="p">.</span><span class="nx">sigmask</span> <span class="p">=</span> <span class="nx">initSigmask</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">();</span> <span class="nx">gp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">lockedExt</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">incgo</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">GOOS</span> <span class="o">!=</span> <span class="s">&#34;plan9&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// We&#39;re on a locked M or a thread that may have been
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// started by C. The kernel state of this thread may
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// be strange (the user may have locked it for that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// purpose). We don&#39;t want to clone that into another
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// thread. Instead, ask a known-good thread to create
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// the thread for us.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// This is disabled on Plan 9. See golang.org/issue/22227.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// TODO: This may be unnecessary on Windows, which
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// doesn&#39;t model thread creation off fork.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">newmHandoff</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">newmHandoff</span><span class="p">.</span><span class="nx">haveTemplateThread</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;on a locked thread with no template thread&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mp</span><span class="p">.</span><span class="nx">schedlink</span> <span class="p">=</span> <span class="nx">newmHandoff</span><span class="p">.</span><span class="nx">newm</span>
</span></span><span class="line"><span class="cl">        <span class="nx">newmHandoff</span><span class="p">.</span><span class="nx">newm</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">newmHandoff</span><span class="p">.</span><span class="nx">waiting</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">newmHandoff</span><span class="p">.</span><span class="nx">waiting</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">            <span class="nf">notewakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">newmHandoff</span><span class="p">.</span><span class="nx">wake</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">newmHandoff</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// The M has not started yet, but the template thread does not
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// participate in STW, so it will always process queued Ms and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// it is safe to releasem.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">releasem</span><span class="p">(</span><span class="nf">getg</span><span class="p">().</span><span class="nx">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">newm1</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">releasem</span><span class="p">(</span><span class="nf">getg</span><span class="p">().</span><span class="nx">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://heliu.site/tags/golang/">Golang</a></li>
      <li><a href="https://heliu.site/tags/goroutine/">Goroutine</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://heliu.site/posts/golang/goroutine/sysmon/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>sysmon ç›‘æ§çº¿ç¨‹</span>
  </a>
  <a class="next" href="https://heliu.site/posts/golang/netpoll/linux/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>Linux epoll</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
    </span>
    <span id="busuanzi_container_site_uv">
        æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
    </span>
    </div>
        <span>Copyright Â© 2024 èœ€ICPå¤‡2024091074å· <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
