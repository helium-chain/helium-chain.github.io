<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>å·¥ä½œçº¿ç¨‹çš„å”¤é†’å’Œåˆ›å»º | Helium</title>
<meta name="keywords" content="golang, Goroutine">
<meta name="description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬">
<meta name="author" content="helium">
<link rel="canonical" href="https://helium-chain.github.io/posts/golang/goroutine/newm/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://helium-chain.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://helium-chain.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://helium-chain.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://helium-chain.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://helium-chain.github.io/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://helium-chain.github.io/posts/golang/goroutine/newm/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="å·¥ä½œçº¿ç¨‹çš„å”¤é†’å’Œåˆ›å»º" />
<meta property="og:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://helium-chain.github.io/posts/golang/goroutine/newm/" />
<meta property="og:image" content="https://helium-chain.github.io/favicon-32x32.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-07-30T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-07-30T00:00:00+00:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://helium-chain.github.io/favicon-32x32.png" />
<meta name="twitter:title" content="å·¥ä½œçº¿ç¨‹çš„å”¤é†’å’Œåˆ›å»º"/>
<meta name="twitter:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://helium-chain.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Golang",
      "item": "https://helium-chain.github.io/posts/golang/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ç¬¬12ç«  Goroutine",
      "item": "https://helium-chain.github.io/posts/golang/goroutine/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "å·¥ä½œçº¿ç¨‹çš„å”¤é†’å’Œåˆ›å»º",
      "item": "https://helium-chain.github.io/posts/golang/goroutine/newm/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "å·¥ä½œçº¿ç¨‹çš„å”¤é†’å’Œåˆ›å»º",
  "name": "å·¥ä½œçº¿ç¨‹çš„å”¤é†’å’Œåˆ›å»º",
  "description": "ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18+ç‰ˆæœ¬",
  "keywords": [
    "golang", "Goroutine"
  ],
  "articleBody": "å”¤é†’å·¥ä½œçº¿ç¨‹ å»å°è¯•å”¤é†’å·¥ä½œçº¿ç¨‹æ¡ä»¶ï¼šatomic.Load(\u0026sched.npidle) != 0 \u0026\u0026 atomic.Load(\u0026sched.nmspinning) == 0ã€‚ atomic.Load(\u0026sched.npidle) != 0ï¼šæœ‰ç©ºé—²çš„Pã€‚ atomic.Load(\u0026sched.nmspinning) == 0ï¼šæ²¡æœ‰å·¥ä½œçº¿ç¨‹æ­£åœ¨å°è¯•ä»å…¶ä»–å·¥ä½œçº¿ç¨‹çš„æœ¬åœ°é˜Ÿåˆ—å·å–goroutineã€‚(å°±æ˜¯æ²¡æœ‰spinningè‡ªæ—‹çš„goroutineæ—¶) å”¤é†’ç©ºé—²çš„På’ŒMç”±wakep()å‡½æ•°å®Œæˆã€‚ wakep() å°è¯•æ·»åŠ ä¸€ä¸ªPæ¥æ‰§è¡ŒGã€‚å½“Gæ˜¯å¯è¿è¡Œæ—¶è°ƒç”¨(newproc, ready)ã€‚ wakep()å‡½æ•°è¢«è°ƒç”¨çš„åœ°æ–¹ï¼šã€åˆ›å»ºgæ—¶å€™ï¼Œåœ¨newproc()å‡½æ•°ä¸­ï¼Œå°±æ˜¯goå…³é”®å­—ã€‘ï¼Œã€gæ”¾å›Pçš„æ—¶å€™ï¼Œåœ¨ready()å‡½æ•°ä¸­ã€‘ã€‚ newproc()å‡½æ•°ä¸­ï¼Œä¹Ÿå°±æ˜¯goå…³é”®å­—æ—¶ï¼Œruntime.mainå·²å¯åŠ¨æ—¶ã€‚ï¼ˆè¿™ç§æƒ…å†µå‘ç”Ÿåœ¨goå…³é”®å­—æ—¶ï¼‰ ready()å‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°é€šè¿‡æŠŠéœ€è¦å”¤é†’çš„goroutineæ”¾å…¥è¿è¡Œé˜Ÿåˆ—æ¥å”¤é†’å®ƒã€‚ï¼ˆè¿™ç§æƒ…å†µåœ¨gè¢«æŒ‚åœ¨äº†å…¶ä»–åœ°æ–¹æ—¶éœ€è¦æ¢å¤åˆ°Pä¸­æ—¶ï¼‰ ä¹Ÿå°±æ˜¯åªè¦gè¢«æ”¾å…¥æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼Œå‡†å¤‡è¿è¡Œæ—¶éƒ½éœ€è¦è°ƒç”¨wakep()å‡½æ•°å°è¯•åˆ©ç”¨ç©ºé—²çš„Må’ŒPæ¥è¿è¡Œå®ƒã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 2420 2421 2422 2423 2424 2425 2426 2427 2428 2429 2430 2431 2432 2433 2434 2435 2436 2437 2438 2439 2440 2441 2442 2443 2444 2445 2446 2447 // Tries to add one more P to execute G's. // Called when a G is made runnable (newproc, ready). func wakep() { // æ²¡æœ‰ç©ºé—²çš„Pï¼Œç›´æ¥è¿”å›ã€‚å½“å‰æ‰€æœ‰çš„Péƒ½åœ¨å·¥ä½œã€‚å› ä¸ºPçš„æ•°é‡æ˜¯å›ºå®šçš„ã€‚ if atomic.Load(\u0026sched.npidle) == 0 { return } // be conservative about spinning threads // // å¯¹è‡ªæ—‹çš„çº¿ç¨‹æŒä¿å®ˆæ€åº¦ï¼š // 1. sched.nmspinning != 0ï¼šæœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨è‡ªæ—‹ï¼ˆå°±æ˜¯åœ¨å…¶ä»–çº¿ç¨‹ä¸­å»å·å–gï¼‰ // 2. !atomic.Cas(\u0026sched.nmspinning, 0, 1)ï¼šé€šè¿‡casæ“ä½œå†æ¬¡ç¡®è®¤æ˜¯å¦æœ‰å…¶ä»–å·¥ä½œçº¿ç¨‹å¤„äºspinningçŠ¶æ€ // ä»è¿›å…¥wakep()åˆ¤æ–­åˆ°çœŸæ­£å¯åŠ¨å·¥ä½œçº¿ç¨‹ä¹‹å‰çš„è¿™ä¸€æ®µæ—¶é—´ä¹‹å†…ï¼Œå¦‚æœå·²ç»æœ‰å·¥ä½œçº¿ç¨‹è¿›å…¥äº†spinningçŠ¶æ€è€Œåœ¨å››å¤„å¯»æ‰¾éœ€è¦è¿è¡Œçš„goroutine // è¿™æ ·çš„è¯æˆ‘ä»¬å°±æ²¡æœ‰å¿…è¦å†å¯åŠ¨ä¸€ä¸ªå¤šä½™çš„å·¥ä½œçº¿ç¨‹å‡ºæ¥äº† // å¦‚æœcasæ“ä½œæˆåŠŸï¼Œåˆ™ç»§ç»­è°ƒç”¨startmåˆ›å»ºä¸€ä¸ªæ–°çš„æˆ–å”¤é†’ä¸€ä¸ªå¤„äºç¡çœ çŠ¶æ€çš„å·¥ä½œçº¿ç¨‹å‡ºæ¥å·¥ä½œ // // 1. atomic.Load(\u0026sched.nmspinning) != 0 æˆç«‹ï¼šæœ‰å…¶ä»–å·¥ä½œçº¿ç¨‹æ­£åœ¨è‡ªæ—‹ï¼Œç›´æ¥returné€€å‡º // 2. atomic.Load(\u0026sched.nmspinning) == 0 æˆç«‹ï¼šå½“å‰æ²¡æœ‰å¿™ç¢Œçš„å·¥ä½œçº¿ç¨‹ // atomic.Cas(\u0026sched.nmspinning, 0, 1) == trueï¼šå½“å‰æ²¡æœ‰å¿™ç¢Œçš„å·¥ä½œçº¿ç¨‹ï¼Œå½“å‰å¯ä»¥åˆ›å»ºå·¥ä½œçº¿ç¨‹ï¼Œå¹¶æ ‡è®°sched.nmspinning=1é˜»æ­¢åæ¥è€… // atomic.Cas(\u0026sched.nmspinning, 0, 1) == falseï¼šå½“å‰æœ‰å…¶ä»–å¿™ç¢Œçš„å·¥ä½œçº¿ç¨‹ï¼Œç›´æ¥returné€€å‡º if atomic.Load(\u0026sched.nmspinning) != 0 || !atomic.Cas(\u0026sched.nmspinning, 0, 1) { return } // ç¨‹åºæ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜ï¼šsched.nmspinningä¸€å®šè¢«æ ‡è®°ä¸º1äº†ã€‚ startm(nil, true) } startm() è°ƒåº¦ä¸€äº›Mæ¥è¿è¡Œp(å¦‚æœéœ€è¦ï¼Œåˆ›å»ºä¸€ä¸ªM)ã€‚ å¦‚æœp==nilï¼Œå°è¯•å¾—åˆ°ä¸€ä¸ªç©ºé—²çš„pï¼Œå¦‚æœæ²¡æœ‰ç©ºé—²çš„pä»€ä¹ˆéƒ½ä¸åšã€‚ å¯ä»¥ä½¿ç”¨m.p==nilè¿è¡Œï¼Œå› æ­¤ä¸å…è®¸å†™å…¥éšœç¢ã€‚ å¦‚æœè®¾ç½®äº†spinningï¼Œåˆ™è°ƒç”¨è€…å¢åŠ äº†nmspinningï¼Œè€Œstartmå°†å‡å°‘nmspinningæˆ–åœ¨æ–°å¯åŠ¨çš„Mä¸­è®¾ç½®m.spinningã€‚ ä¼ é€’nilçš„Pçš„è°ƒç”¨æ–¹å¿…é¡»ä»ä¸å¯æŠ¢å çš„ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ã€‚è§ä¸‹é¢å¯¹acquiremã€‚ å¿…é¡»æ²¡æœ‰å†™éšœç¢ï¼Œå› ä¸ºè¿™ä¸ªå¯èƒ½æ²¡æœ‰Pã€‚ go:nowritebarrierrecï¼šä¸å…è®¸ç¼–è¯‘å™¨æ’å…¥å†™å±éšœç›¸å…³ä»£ç ã€‚ åœ¨æŠ¢å ç³»ç»Ÿè°ƒç”¨çš„Pçš„æ—¶å€™è¯¥å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå¹¶ä¼ å…¥ç©ºé—²çš„På’Œfalseå‚æ•°ã€‚ å‚æ•°ï¼š _p_ *pï¼šnilè¡¨ç¤ºæ²¡æœ‰æŒ‡å®šPï¼Œå¦åˆ™æŒ‡å®šPã€‚ spinning boolï¼štrue.sched.nmspinningçš„å€¼åœ¨å‰é¢è¢«åŠ ä¸€äº†ã€‚false.æ²¡æœ‰åŠ ä¸€ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 2257 2258 2259 2260 2261 2262 2263 2264 2265 2266 2267 2268 2269 2270 2271 2272 2273 2274 2275 2276 2277 2278 2279 2280 2281 2282 2283 2284 2285 2286 2287 2288 2289 2290 2291 2292 2293 2294 2295 2296 2297 2298 2299 2300 2301 2302 2303 2304 2305 2306 2307 2308 2309 2310 2311 2312 2313 2314 2315 2316 2317 2318 2319 2320 2321 2322 2323 2324 2325 2326 2327 2328 2329 2330 2331 2332 2333 2334 2335 2336 2337 2338 2339 2340 2341 2342 2343 2344 2345 2346 2347 2348 2349 2350 2351 2352 2353 2354 2355 2356 2357 2358 2359 2360 2361 2362 2363 2364 2365 2366 2367 2368 2369 2370 2371 2372 2373 2374 2375 2376 2377 2378 2379 2380 // Schedules some M to run the p (creates an M if necessary). // If p==nil, tries to get an idle P, if no idle P's does nothing. // May run with m.p==nil, so write barriers are not allowed. // If spinning is set, the caller has incremented nmspinning and startm will // either decrement nmspinning or set m.spinning in the newly started M. // // Callers passing a non-nil P must call from a non-preemptible context. See // comment on acquirem below. // // Must not have write barriers because this may be called without a P. // //go:nowritebarrierrec func startm(_p_ *p, spinning bool) { // Disable preemption. // // Every owned P must have an owner that will eventually stop it in the // event of a GC stop request. startm takes transient ownership of a P // (either from argument or pidleget below) and transfers ownership to // a started M, which will be responsible for performing the stop. // // Preemption must be disabled during this transient ownership, // otherwise the P this is running on may enter GC stop while still // holding the transient P, leaving that P in limbo and deadlocking the // STW. // // Callers passing a non-nil P must already be in non-preemptible // context, otherwise such preemption could occur on function entry to // startm. Callers passing a nil P may be preemptible, so we must // disable preemption before acquiring a P from pidleget below. mp := acquirem() // ç¦æ­¢å½“å‰Mè¢«æŠ¢å  lock(\u0026sched.lock) // é”ä½å…¨å±€sched // æœ‰ç©ºé—²çš„pæ‰ä¼šå»å”¤é†’çº¿ç¨‹ if _p_ == nil { // å¦‚æœæ²¡æœ‰æŒ‡å®šPï¼Œåˆ™éœ€è¦ä»Pçš„ç©ºé—²åˆ—è¡¨ä¸­è·å–ä¸€ä¸ªP _p_ = pidleget(0) // ä»Pçš„ç©ºé—²é˜Ÿåˆ—ä¸­è·å–ç©ºé—²çš„P // æ²¡æœ‰ç©ºé—²çš„Pï¼Œæ„å‘³ç€æ‰€æœ‰çš„Péƒ½å¾ˆå¿™ä¸éœ€è¦å”¤é†’ if _p_ == nil {\tunlock(\u0026sched.lock) // ä¹‹å‰çš„CasæŠŠnmspinningåŠ ä¸€ï¼Œè¿™é‡Œéœ€è¦å‡å›æ¥ if spinning {\t// The caller incremented nmspinning, but there are no idle Ps, // so it's okay to just undo the increment and give up. // // æ­£å¸¸é€»è¾‘è¿™é‡Œä¸åº”è¯¥å‡æˆè´Ÿæ•°ï¼Œå¦åˆ™æ˜¯ç³»ç»Ÿé€»è¾‘å­˜åœ¨é”™è¯¯ if int32(atomic.Xadd(\u0026sched.nmspinning, -1)) \u003c 0 { throw(\"startm: negative nmspinning\") } } // ä¸acquiremå‡½æ•°å‘¼åº”ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦æœ‰æŠ¢å è¯·æ±‚å‘ç”Ÿ releasem(mp)\treturn // æ²¡æœ‰ç©ºé—²çš„Pç›´æ¥è¿”å› } } // å°è¯•ä»mç©ºé—²é˜Ÿåˆ—ä¸­è·å–æ­£å¤„äºç¡çœ ä¹‹ä¸­çš„å·¥ä½œçº¿ç¨‹ // æ‰€æœ‰å¤„äºç¡çœ çŠ¶æ€çš„méƒ½åœ¨æ­¤é˜Ÿåˆ—ä¸­ nmp := mget() // æ²¡æœ‰å¤„äºç¡çœ çŠ¶æ€çš„å·¥ä½œçº¿ç¨‹ï¼Œè¿™ç§æƒ…å†µéœ€è¦å»åˆ›å»ºçº¿ç¨‹ if nmp == nil {\t// No M is available, we must drop sched.lock and call newm. // However, we already own a P to assign to the M. // // Once sched.lock is released, another G (e.g., in a syscall), // could find no idle P while checkdead finds a runnable G but // no running M's because this new M hasn't started yet, thus // throwing in an apparent deadlock. // // Avoid this situation by pre-allocating the ID for the new M, // thus marking it as 'running' before we drop sched.lock. This // new M will eventually run the scheduler to execute any // queued G's. // // è¿™é‡Œæ˜¯ä¸ºéœ€è¦æ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹å‡†å¤‡å·¥ä½œ id := mReserveID() // ç»™éœ€è¦åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹åˆ†é…ID unlock(\u0026sched.lock) // åˆå§‹åŒ–fnå‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨å·¥ä½œçº¿ç¨‹åˆšå¯åŠ¨æ—¶ä¼šè¢«è°ƒç”¨ var fn func() // nil if spinning { // å¦‚æœéœ€è¦æ ‡è®°å½“å‰å·¥ä½œçº¿ç¨‹æ˜¯è‡ªæ—‹çŠ¶æ€ // The caller incremented nmspinning, so set m.spinning in the new M. // // mspinningå‡½æ•°å°±ä¸€è¡Œä»£ç  'getg().m.spinning = true' æ ‡è®°å½“å‰å·¥ä½œçº¿ç¨‹æ˜¯è‡ªæ—‹çŠ¶æ€ // å› ä¸ºå…¨å±€çš„sched.nmspinningå·²ç»åŠ ä¸€äº†ï¼Œå› æ­¤éœ€è¦æ ‡è®°mçš„spinning fn = mspinning\t} newm(fn, _p_, id) // åˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹ // Ownership transfer of _p_ committed by start in newm. // Preemption is now safe. releasem(mp) return } // åˆ°è¿™é‡Œè¯´æ˜æœ‰æ­£åœ¨å¤„äºç¡çœ çš„å·¥ä½œçº¿ç¨‹ unlock(\u0026sched.lock) // ä»ç©ºé—²çš„çº¿ç¨‹é˜Ÿåˆ—ä¸­æ‹¿å‡ºæ¥çš„ spinning æ ‡å¿—ä½å­˜åœ¨ï¼Œè¯´æ˜sleepæ—¶æœ‰é—®é¢˜ if nmp.spinning { // ç³»ç»Ÿé€»è¾‘å­˜åœ¨é—®é¢˜ throw(\"startm: m is spinning\") } // å·¥ä½œçº¿ç¨‹è¿˜ä¸å…¶ä»–Pæœ‰å…³ï¼Œè¯´æ˜æœ‰é—®é¢˜ if nmp.nextp != 0 { // ç³»ç»Ÿé€»è¾‘å­˜åœ¨é—®é¢˜ throw(\"startm: m has p\") } // ç©ºé—²çš„Pä¸­ä¸åº”è¯¥å­˜åœ¨gï¼Œç³»ç»Ÿé€»è¾‘å­˜åœ¨é—®é¢˜ if spinning \u0026\u0026 !runqempty(_p_) {\tthrow(\"startm: p has runnable gs\") } // The caller incremented nmspinning, so set m.spinning in the new M. // // è°ƒç”¨è€…å¢åŠ nmspinningï¼Œå› æ­¤å°†m.spinningè®¾ç½®ä¸ºæ–°çš„Mã€‚å› æ­¤å½“å‰è¿™ä¸ªMå°±æ˜¯è¿™ä¸ªè‡ªæ—‹çš„M nmp.spinning = spinning // æ ‡è®°å½“å‰éœ€è¦å”¤é†’çš„å·¥ä½œçº¿ç¨‹ è‡ªæ—‹çš„çŠ¶æ€ // å½“å‰Mçš„Pæš‚æ—¶æ”¾åœ¨nextpä¸Š // è¿™é‡Œä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹ç›´æ¥åœ¨nextpå»å–Pï¼ŒåŸå› åœ¨è¿™é‡Œå…³è”çš„ // å› ä¸º_p_åªåœ¨è¿™é‡Œå­˜åœ¨ï¼Œå› æ­¤ä¸ä¼šå­˜åœ¨å…¶ä»–å·¥ä½œçº¿ç¨‹ä½¿ç”¨è¯¥Pã€‚ nmp.nextp.set(_p_)\t// å”¤é†’å·¥ä½œçº¿ç¨‹ï¼Œå·¥ä½œçº¿ç¨‹ç¡çœ åœ¨ nmp.park ä¸Šé¢ notewakeup(\u0026nmp.park)\t// Ownership transfer of _p_ committed by wakeup. Preemption is now // safe. // // å”¤é†’æäº¤çš„_p_çš„æ‰€æœ‰æƒè½¬ç§»ã€‚ æŠ¢å ç°åœ¨æ˜¯å®‰å…¨çš„ // ä¸acquiremå‡½æ•°å‘¼åº”ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦æœ‰æŠ¢å è¯·æ±‚å‘ç”Ÿ releasem(mp) } acquirem() måŠ é”ç¦æ­¢æŠ¢å å½“å‰mã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/runtime1.goã€‚ 473 474 475 476 477 478 //go:nosplit func acquirem() *m { _g_ := getg() _g_.m.locks++ return _g_.m } releasem() æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/runtime1.goã€‚ 482 483 484 485 486 487 488 489 490 func releasem(mp *m) { _g_ := getg() mp.locks-- // å½“å‰Mæ²¡æœ‰é”ï¼Œå¹¶ä¸”Géœ€è¦è¢«æŠ¢å  if mp.locks == 0 \u0026\u0026 _g_.preempt { // restore the preemption request in case we've cleared it in newstack _g_.stackguard0 = stackPreempt // è®¾ç½®æŠ¢å æ ‡å¿— } } pidleget() ä»sched.pidleä¸­å°è¯•è·å–ä¸€ä¸ªç©ºé—²çš„Pã€‚ å‚æ•°now int64ï¼š0åˆ™å–å½“å‰æ—¶é—´ç‚¹ã€‚ è¿”å›å€¼ï¼š *pï¼šè¿”å›ä¸€ä¸ªç©ºé—²çš„Pï¼Œå¦åˆ™ä¸ºnilæ²¡æœ‰ç©ºé—²çš„Pã€‚ int64ï¼šä¼ å…¥nowçš„æ—¶é—´å€¼ï¼Œ0åˆ™æ˜¯å½“å‰æ—¶é—´å€¼ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5727 5728 5729 5730 5731 5732 5733 5734 5735 5736 5737 5738 5739 5740 5741 5742 5743 5744 5745 5746 5747 5748 5749 5750 5751 5752 5753 5754 5755 5756 // pidleget tries to get a p from the _Pidle list, acquiring ownership. // // sched.lock must be held. // // May run during STW, so write barriers are not allowed. // //go:nowritebarrierrec func pidleget(now int64) (*p, int64) { // sched.lock å¿…é¡»è¢«æŒæœ‰ assertLockHeld(\u0026sched.lock) // ä»sched.pidleä¸Šè·å–ç©ºé—²çš„P _p_ := sched.pidle.ptr() if _p_ != nil { // Timer may get added at any time now. if now == 0 { now = nanotime() } // è®¾ç½®timerpMaskå’ŒidlepMask timerpMask.set(_p_.id) idlepMask.clear(_p_.id) // ä»å…¨å±€ç©ºé—²çš„Pä¸­ç§»é™¤_p_ sched.pidle = _p_.link // å…¨å±€çš„ç©ºé—²Pçš„æ¬¡æ•°å‡ä¸€ atomic.Xadd(\u0026sched.npidle, -1) // limiterEventè·Ÿè¸ªGC CPUé™åˆ¶å™¨çš„äº‹ä»¶ã€‚ _p_.limiterEvent.stop(limiterEventIdle, now) } return _p_, now } mget() å°è¯•ä»sched.midleè·å–ä¸€ä¸ªç©ºé—²çš„å·¥ä½œçº¿ç¨‹mï¼Œèµ·æ¥ç»‘å®šPè¿è¡Œã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5547 5548 5549 5550 5551 5552 5553 5554 5555 5556 5557 5558 5559 5560 5561 5562 5563 5564 // Try to get an m from midle list. // sched.lock must be held. // May run during STW, so write barriers are not allowed. // //go:nowritebarrierrec func mget() *m { assertLockHeld(\u0026sched.lock) // ç©ºé—²çš„måœ¨sched.midleä¸Š mp := sched.midle.ptr() if mp != nil { // ä»sched.midleä¸Šç§»é™¤mp sched.midle = mp.schedlink // ç©ºé—²çš„mæ•°é‡å‡ä¸€ sched.nmidle-- } return mp } mReserveID() ç»™æ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹åˆ†é…å”¯ä¸€çš„IDã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 // mReserveID returns the next ID to use for a new m. This new m is immediately // considered 'running' by checkdead. // // sched.lock must be held. func mReserveID() int64 { // sched.locké”å¿…é¡»è¢«æŒæœ‰ assertLockHeld(\u0026sched.lock) // åˆ†é…çš„IDæº¢å‡ºäº† if sched.mnext+1 \u003c sched.mnext { throw(\"runtime: thread ID overflow\") } id := sched.mnext // åˆ†é…çš„ID sched.mnext++ // ä¸‹ä¸€ä¸ªID // æ£€æŸ¥sched.mnext - sched.nmfreed \u003e sched.maxmcount // sched.maxmcount åœ¨ runtime.main ä¸­è¢«è®¾ç½®ä¸º 10000 // sched.mnext ä¸‹ä¸€ä¸ªåˆ†é…çš„IDï¼Œè¯¥å€¼æ˜¯ç´¯åŠ çš„ // sched.nmfreed å·²ç»é‡Šæ”¾çš„å·¥ä½œçº¿ç¨‹æ•°é‡ // å› æ­¤è¿™é‡Œæ˜¯æ£€æŸ¥å½“å‰å·²ç»åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹æ•°é‡ä¸èƒ½å¤§äºæœ€å¤§å€¼ checkmcount() return id } notewakeup() é¦–å…ˆä½¿ç”¨atomic.Xchgè®¾ç½®note.keyå€¼ä¸º1ã€‚ è¿™æ˜¯ä¸ºäº†ä½¿è¢«å”¤é†’çš„çº¿ç¨‹å¯ä»¥é€šè¿‡æŸ¥çœ‹è¯¥å€¼æ˜¯å¦ç­‰äº1æ¥ç¡®å®šæ˜¯è¢«å…¶å®ƒçº¿ç¨‹å”¤é†’è¿˜æ˜¯æ„å¤–ä»ç¡çœ ä¸­è‹é†’äº†è¿‡æ¥ï¼Œ å¦‚æœè¯¥å€¼ä¸º1åˆ™è¡¨ç¤ºæ˜¯è¢«å”¤é†’çš„ï¼Œå¯ä»¥ç»§ç»­å·¥ä½œäº†ã€‚ ä½†å¦‚æœè¯¥å€¼ä¸º0åˆ™è¡¨ç¤ºæ˜¯æ„å¤–è‹é†’ï¼Œéœ€è¦å†æ¬¡è¿›å…¥ç¡çœ ï¼Œ å·¥ä½œçº¿ç¨‹è‹é†’ä¹‹åçš„å¤„ç†é€»è¾‘æˆ‘ä»¬å·²ç»åœ¨notesleep()å‡½æ•°ä¸­è§è¿‡ï¼Œæ‰€ä»¥è¿™é‡Œç•¥è¿‡ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/lock_futex.goã€‚ 139 140 141 142 143 144 145 146 147 func notewakeup(n *note) { // è®¾ç½®n.key = 1, è¢«å”¤é†’çš„çº¿ç¨‹é€šè¿‡æŸ¥çœ‹è¯¥å€¼æ˜¯å¦ç­‰äº1æ¥ç¡®å®šæ˜¯è¢«å…¶å®ƒçº¿ç¨‹å”¤é†’è¿˜æ˜¯æ„å¤–ä»ç¡çœ ä¸­è‹é†’ old := atomic.Xchg(key32(\u0026n.key), 1) if old != 0 { // å¦‚æœæ—§å€¼ä¸æ˜¯0è¯´æ˜ç³»ç»Ÿé€»è¾‘æœ‰é—®é¢˜ print(\"notewakeup - double wakeup (\", old, \")\\n\") throw(\"notewakeup - double wakeup\") } futexwakeup(key32(\u0026n.key), 1) // è°ƒç”¨futexwakeupå”¤é†’ } futexwakeup() å¯¹äºLinuxå¹³å°æ¥è¯´ï¼Œå·¥ä½œçº¿ç¨‹é€šè¿‡noteç¡çœ å…¶å®æ˜¯é€šè¿‡futexç³»ç»Ÿè°ƒç”¨ç¡çœ åœ¨å†…æ ¸ä¹‹ä¸­ï¼Œ æ‰€ä»¥å”¤é†’å¤„äºç¡çœ çŠ¶æ€çš„çº¿ç¨‹ä¹Ÿéœ€è¦é€šè¿‡futexç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸æ¥å”¤é†’ã€‚ æ‰€ä»¥è¿™é‡Œçš„futexwakeup()åˆç»§ç»­è°ƒç”¨åŒ…è£…äº†futexç³»ç»Ÿè°ƒç”¨çš„futex()å‡½æ•°æ¥å®ç°å”¤é†’ç¡çœ åœ¨å†…æ ¸ä¸­çš„å·¥ä½œçº¿ç¨‹ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/os_linux.goã€‚ 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 // If any procs are sleeping on addr, wake up at most cnt. //go:nosplit func futexwakeup(addr *uint32, cnt uint32) { // è°ƒç”¨futexå‡½æ•°å”¤é†’å·¥ä½œçº¿ç¨‹ ret := futex(unsafe.Pointer(addr), _FUTEX_WAKE_PRIVATE, cnt, nil, nil, 0) if ret \u003e= 0 {\t// è°ƒç”¨æˆåŠŸæ˜¯è¿™é‡Œç›´æ¥è¿”å› return } // I don't know that futex wakeup can return // EAGAIN or EINTR, but if it does, it would be // safe to loop and call futex again. systemstack(func() { print(\"futexwakeup addr=\", addr, \" returned \", ret, \"\\n\") }) // ç¨‹åºä¸ä¼šåˆ°è¿™é‡Œæ¥ï¼Œå³ä½¿åˆ°è¿™é‡Œæ¥äº†ï¼Œå‘ä¸€ä¸ªæœªçŸ¥åœ°å€å†™å…¥æ•°æ®ç›´æ¥å®•æœº *(*int32)(unsafe.Pointer(uintptr(0x1006))) = 0x1006 } futex() futex()å‡½æ•°ç”±æ±‡ç¼–ä»£ç å†™æˆï¼Œå‰é¢çš„å‡ æ¡æŒ‡ä»¤éƒ½åœ¨ä¸ºfutexç³»ç»Ÿè°ƒç”¨å‡†å¤‡å‚æ•°ï¼Œ å‚æ•°å‡†å¤‡å®Œæˆä¹‹ååˆ™é€šè¿‡SYSCALLæŒ‡ä»¤è¿›å…¥æ“ä½œç³»ç»Ÿå†…æ ¸å®Œæˆçº¿ç¨‹çš„å”¤é†’åŠŸèƒ½ã€‚ å†…æ ¸åœ¨å®Œæˆå”¤é†’å·¥ä½œä¹‹åå½“å‰å·¥ä½œçº¿ç¨‹åˆ™ä»å†…æ ¸è¿”å›åˆ°futex()å‡½æ•°ç»§ç»­æ‰§è¡ŒSYSCALLæŒ‡ä»¤ä¹‹åçš„ä»£ç å¹¶æŒ‰å‡½æ•°è°ƒç”¨é“¾åŸè·¯è¿”å›ã€‚ ç»§ç»­æ‰§è¡Œå…¶å®ƒä»£ç ï¼Œè€Œè¢«å”¤é†’çš„å·¥ä½œçº¿ç¨‹åˆ™ç”±å†…æ ¸è´Ÿè´£åœ¨é€‚å½“çš„æ—¶å€™è°ƒåº¦åˆ°CPUä¸Šè¿è¡Œã€‚ é™·å…¥ç³»ç»Ÿè°ƒç”¨å¤ªé•¿æ—¶é—´çš„å·¥ä½œçº¿ç¨‹ä¼šåœ¨ç›‘æ§çº¿ç¨‹ä¸­å‰¥ç¦»På’ŒGï¼Œå…·ä½“çš„å‚çœ‹ç›‘æ§çº¿ç¨‹ç›¸å…³ä»£ç ã€‚è¿™é‡Œæ²¡æœ‰æ ‡è®°å·¥ä½œçº¿ç¨‹é™·å…¥ç³»ç»Ÿè°ƒç”¨çš„æ ‡å¿—ã€‚ åº”è¯¥æ˜¯å½“å‰å‡½æ•°è°ƒç”¨ä¸ä¼šå½¢æˆé˜»å¡ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/sys_linux_amd64.sã€‚ 549 550 551 552 553 554 555 556 557 558 559 560 561 562 # int64 futex(int32 *uaddr, int32 op, int32 val, # struct timespec *timeout, int32 *uaddr2, int32 val2); TEXT runtimeÂ·futex(SB),NOSPLIT,$0 #è¿™6æ¡æŒ‡ä»¤åœ¨ä¸ºfutexç³»ç»Ÿè°ƒç”¨å‡†å¤‡å‚æ•° MOVQ addr+0(FP), DI MOVL op+8(FP), SI MOVL val+12(FP), DX MOVQ ts+16(FP), R10 MOVQ addr2+24(FP), R8 MOVL val3+32(FP), R9 MOVL $SYS_futex, AX # futexç³»ç»Ÿè°ƒç”¨ç¼–å·æ”¾å…¥AXå¯„å­˜å™¨ SYSCALL # ç³»ç»Ÿè°ƒç”¨ï¼Œè¿›å…¥å†…æ ¸ MOVL AX, ret+40(FP) # ç³»ç»Ÿè°ƒç”¨é€šè¿‡AXå¯„å­˜å™¨è¿”å›è¿”å›å€¼ï¼Œè¿™é‡ŒæŠŠè¿”å›å€¼ä¿å­˜åˆ°å†…å­˜ä¹‹ä¸­ RET åˆ›å»ºå·¥ä½œçº¿ç¨‹ å¦‚æœæ²¡æœ‰æ­£å¤„äºä¼‘çœ çŠ¶æ€çš„å·¥ä½œçº¿ç¨‹ï¼Œåˆ™éœ€è¦è°ƒç”¨newm()å‡½æ•°æ–°å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ã€‚ newm() åˆ›å»ºè°ƒåº¦çº¿ç¨‹å’Œç›‘æ§çº¿ç¨‹éƒ½æ˜¯é€šè¿‡è¯¥å‡½æ•°ï¼Œæ‰§è¡Œè¯¥å‡½æ•°æ—¶éƒ½ä¼šæŠŠæ ˆåˆ‡æ¢åˆ°g0æ ˆï¼Œå› ä¸ºg0æ ˆæ¯”è¾ƒå¤§ã€‚ è¯¥å‡½æ•°åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹ä½¿ç”¨ï¼š newm(sysmon, nil, -1)ï¼šåˆ›å»ºã€ç›‘æ§çº¿ç¨‹ã€‘ã€‚ sysmonå·¥ä½œçº¿ç¨‹å¼€å§‹æ‰§è¡Œæ—¶é¦–å…ˆè°ƒç”¨çš„å‡½æ•°ã€‚ï¼ˆä¸æ˜¯å…¥å£å‡½æ•°ï¼Œnewm()åˆ›å»ºçš„å…¥å£å‡½æ•°éƒ½æ˜¯å›ºå®šçš„mstart()å‡½æ•°ï¼‰ nilè¡¨ç¤ºä¸éœ€è¦ç»‘å®šPã€‚ -1ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªé€’å¢çš„æ•°å­—ã€‚ï¼ˆå…¨å±€å”¯ä¸€çš„IDï¼‰ newm(fn, _p_, id)ï¼šåˆ›å»ºã€è°ƒåº¦çº¿ç¨‹ã€‘ã€‚ fnå·¥ä½œçº¿ç¨‹å¼€å§‹æ‰§è¡Œæ—¶é¦–å…ˆè°ƒç”¨çš„å‡½æ•°ã€‚ï¼ˆä¸æ˜¯å…¥å£å‡½æ•°ï¼Œnewm()åˆ›å»ºçš„å…¥å£å‡½æ•°éƒ½æ˜¯å›ºå®šçš„mstart()å‡½æ•°ï¼‰ _p_çº¿ç¨‹å¯åŠ¨æ—¶éœ€è¦ç»‘å®šçš„Pã€‚ åˆ›å»ºå·¥ä½œçº¿ç¨‹çš„å”¯ä¸€IDã€‚ åˆ›å»ºä¸€ä¸ªæ–°çš„mã€‚å®ƒå°†ä»å¯¹fnæˆ–è°ƒåº¦å™¨çš„è°ƒç”¨å¼€å§‹ã€‚fnéœ€è¦æ˜¯é™æ€çš„ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå †åˆ†é…é—­åŒ…ã€‚å¯ä»¥ä½¿ç”¨ m.p==nilè¿è¡Œï¼Œå› æ­¤ä¸å…è®¸å†™å…¥éšœç¢ã€‚ idæ˜¯å¯é€‰çš„ï¼Œé¢„åˆ†é…çš„Mçš„idã€‚é€šè¿‡ä¼ é€’-1æ¥çœç•¥ã€‚ go:nowritebarrierrecï¼šå‘Šè¯‰ç¼–è¯‘å™¨è¯¥å‡½æ•°åŠé‡Œé¢æ‰€è°ƒç”¨çš„å‡½æ•°éƒ½ä¸æ’å…¥å†™å±éšœä»£ç ã€‚ å‚æ•°ï¼š fn func()ï¼šæ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹å¯åŠ¨åéœ€è¦æ‰§è¡Œçš„å‡½æ•°ï¼Œä¸èƒ½æ˜¯ä¸€ä¸ªå †åˆ†é…çš„é—­åŒ…ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªé™æ€çš„å‡½æ•°ã€‚ ä¹Ÿå°±æ˜¯æ‰€æœ‰åˆ›å»ºçš„çº¿ç¨‹å…¥å£å‡½æ•°éƒ½æ˜¯mstart()å‡½æ•°æ˜¯çº¿ç¨‹çš„å…¥å£å‡½æ•°æ•°ï¼Œå‚çœ‹newosproc()å‡½æ•°ã€‚ _p_ *pï¼šæ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹éœ€è¦ç»‘å®šçš„Pï¼Œè¯¥å€¼å¯ä»¥ä¸º nilï¼Œè¡¨ç¤ºä¸ç»‘å®šPã€‚ id int64ï¼šæ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹çš„IDå€¼ï¼Œè¯¥å€¼å¯ä»¥æ˜¯-1ï¼Œè¡¨ç¤ºç³»ç»Ÿè‡ªåŠ¨åˆ†é…ä¸€ä¸ªé€’å¢çš„IDæ•°å€¼ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 2089 2090 2091 2092 2093 2094 2095 2096 2097 2098 2099 2100 2101 2102 2103 2104 2105 2106 2107 2108 2109 2110 2111 2112 2113 2114 2115 2116 2117 2118 2119 2120 2121 2122 2123 2124 2125 2126 2127 2128 2129 2130 2131 2132 2133 2134 2135 2136 2137 2138 2139 2140 2141 2142 2143 2144 2145 2146 2147 2148 // Create a new m. It will start off with a call to fn, or else the scheduler. // fn needs to be static and not a heap allocated closure. // May run with m.p==nil, so write barriers are not allowed. // // id is optional pre-allocated m ID. Omit by passing -1. // //go:nowritebarrierrec func newm(fn func(), _p_ *p, id int64) { // allocm adds a new M to allm, but they do not start until created by // the OS in newm1 or the template thread. // // doAllThreadsSyscall requires that every M in allm will eventually // start and be signal-able, even with a STW. // // Disable preemption here until we start the thread to ensure that // newm is not preempted between allocm and starting the new thread, // ensuring that anything added to allm is guaranteed to eventually // start. // // allocmå°†ä¸€ä¸ªæ–°çš„Mæ·»åŠ åˆ°allmä¸­ï¼Œä½†æ˜¯ç›´åˆ°æ“ä½œç³»ç»Ÿåœ¨newm1æˆ–æ¨¡æ¿çº¿ç¨‹ä¸­åˆ›å»ºå®ƒä»¬æ‰å¼€å§‹ã€‚ // doAllThreadsSyscall è¦æ±‚allmä¸­çš„æ¯ä¸ªMæœ€ç»ˆéƒ½å°†å¯åŠ¨å¹¶å¯å‘é€ä¿¡å·ï¼Œå³ä½¿æ˜¯STWã€‚ // åœ¨è¿™é‡Œç¦ç”¨æŠ¢å ï¼Œç›´åˆ°æˆ‘ä»¬å¯åŠ¨çº¿ç¨‹ï¼Œä»¥ç¡®ä¿newmåœ¨allocmå’Œå¯åŠ¨æ–°çº¿ç¨‹ä¹‹é—´ä¸è¢«æŠ¢å ï¼Œç¡®ä¿æ·»åŠ åˆ°allmçš„ä»»ä½•å†…å®¹æœ€ç»ˆéƒ½èƒ½å¯åŠ¨ã€‚ acquirem()\t// ç¦æ­¢å½“å‰å·¥ä½œçº¿ç¨‹è¢«æŠ¢å  // allocmä»å †ä¸Šåˆ†é…ä¸€ä¸ªmç»“æ„ä½“ï¼Œå¹¶ç»‘å®šMä¸å…¶ä»–ç›¸å…³ä¾‹å¦‚allpç­‰ mp := allocm(_p_, fn, id) mp.nextp.set(_p_)\t// è®¾ç½®å½“å‰Méœ€è¦ç”¨åˆ°çš„P mp.sigmask = initSigmask if gp := getg(); gp != nil \u0026\u0026 gp.m != nil \u0026\u0026 (gp.m.lockedExt != 0 || gp.m.incgo) \u0026\u0026 GOOS != \"plan9\" { // We're on a locked M or a thread that may have been // started by C. The kernel state of this thread may // be strange (the user may have locked it for that // purpose). We don't want to clone that into another // thread. Instead, ask a known-good thread to create // the thread for us. // // This is disabled on Plan 9. See golang.org/issue/22227. // // TODO: This may be unnecessary on Windows, which // doesn't model thread creation off fork. lock(\u0026newmHandoff.lock) if newmHandoff.haveTemplateThread == 0 { throw(\"on a locked thread with no template thread\") } mp.schedlink = newmHandoff.newm newmHandoff.newm.set(mp) if newmHandoff.waiting { newmHandoff.waiting = false notewakeup(\u0026newmHandoff.wake) } unlock(\u0026newmHandoff.lock) // The M has not started yet, but the template thread does not // participate in STW, so it will always process queued Ms and // it is safe to releasem. releasem(getg().m) return } newm1(mp) releasem(getg().m) } acquirem() æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/runtime1.goã€‚ 473 474 475 476 477 478 //go:nosplit func acquirem() *m { _g_ := getg() _g_.m.locks++ return _g_.m } allocm() åˆ†é…ä¸€ä¸ªä¸ä¸ä»»ä½•çº¿ç¨‹å…³è”çš„æ–°mã€‚å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä½¿ç”¨pä½œä¸ºåˆ†é…ä¸Šä¸‹æ–‡ã€‚ fnè¢«è®°å½•ä¸ºæ–°mçš„m.mstartfnã€‚idæ˜¯å¯é€‰çš„ï¼Œé¢„åˆ†é…çš„mçš„idã€‚é€šè¿‡ä¼ é€’-1æ¥çœç•¥ã€‚ è¿™ä¸ªå‡½æ•°å…è®¸æœ‰å†™éšœç¢ï¼Œå³ä½¿è°ƒç”¨è€…æ²¡æœ‰ï¼Œå› ä¸ºå®ƒå€Ÿç”¨äº†_p_ã€‚ go:yeswritebarrierrecï¼šå…è®¸ç¼–è¯‘å™¨æ’å…¥å†™å±éšœç›¸å…³ä»£ç ï¼Œå› ä¸ºè°ƒç”¨è€…ä½¿ç”¨çš„æ˜¯go:nowritebarrierrecã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 1706 1707 1708 1709 1710 1711 1712 1713 1714 1715 1716 1717 1718 1719 1720 1721 1722 1723 1724 1725 1726 1727 1728 1729 1730 1731 1732 1733 1734 1735 1736 1737 1738 1739 1740 1741 1742 1743 1744 1745 1746 1747 1748 1749 1750 1751 1752 1753 1754 1755 1756 1757 1758 1759 1760 1761 1762 1763 1764 1765 1766 1767 1768 1769 1770 1771 1772 1773 1774 1775 1776 1777 1778 1779 1780 1781 1782 1783 1784 1785 1786 1787 1788 1789 1790 // Allocate a new m unassociated with any thread. // Can use p for allocation context if needed. // fn is recorded as the new m's m.mstartfn. // id is optional pre-allocated m ID. Omit by passing -1. // // This function is allowed to have write barriers even if the caller // isn't because it borrows _p_. // //go:yeswritebarrierrec func allocm(_p_ *p, fn func(), id int64) *m { allocmLock.rlock() // è¯»åŠ é” // The caller owns _p_, but we may borrow (i.e., acquirep) it. We must // disable preemption to ensure it is not stolen, which would make the // caller lose ownership. acquirem() // ç¦æ­¢å½“å‰Mè¢«æŠ¢å  _g_ := getg() // å½“å‰g // æ³¨æ„è¿™é‡Œæ˜¯æ­£åœ¨æ‰§è¡Œçš„å·¥ä½œçº¿ç¨‹,åœ¨æ­¤å‡½æ•°ä¸­ä¸º malloc ä¸´æ—¶å€Ÿç”¨ p if _g_.m.p == 0 { // å¦‚æœå½“å‰Mæ²¡æœ‰ç»‘å®šPï¼Œåˆ™å»ç»‘å®šä¸€ä¸ªP // åœ¨è¿™ä¸ªå‡½æ•°ä¸­æš‚æ—¶å€Ÿç”¨pæ¥ä»£æ›¿mallocs // å½“å‰è¿™ä¸ªå·¥ä½œçº¿ç¨‹æ²¡æœ‰ç»‘å®špéœ€è¦ä¸´æ—¶å€Ÿç”¨è¿™ä¸ª_p_ï¼Œè¿™ç§æƒ…å†µå¯èƒ½æ˜¯sysmonçº¿ç¨‹ä¸­æ¥çš„ã€‚ acquirep(_p_) // temporarily borrow p for mallocs in this function } // Release the free M list. We need to do this somewhere and // this may free up a stack we can use. // // sched.freem å­˜å‚¨çš„æ˜¯ç­‰å¾…é‡Šæ”¾çš„mçš„é“¾è¡¨ if sched.freem != nil { // é‡Šæ”¾éœ€è¦é‡Šæ”¾çš„Måˆ—è¡¨ lock(\u0026sched.lock) var newList *m // freem æ˜¯ä¸€ç»„å·²ç»è¿è¡Œç»“æŸçš„Mæ„æˆçš„é“¾è¡¨ï¼ˆä¸æ˜¯ç©ºé—²çš„ï¼‰ã€‚ for freem := sched.freem; freem != nil; { // freeWait é‡Šæ”¾g0å’Œåˆ é™¤mæ˜¯å¦å®‰å…¨(freeMRef, freeMStack, freeMWaitä¸­çš„ä¸€ä¸ª) if freem.freeWait != 0 { next := freem.freelink freem.freelink = newList newList = freem freem = next continue } // stackfree must be on the system stack, but allocm is // reachable off the system stack transitively from // startm. // // stackfree å¿…é¡»åœ¨ç³»ç»Ÿæ ˆä¸Šï¼Œä½†allocmä»startmå¼€å§‹åœ¨ç³»ç»Ÿæ ˆä¹‹å¤–æ˜¯å¯è®¿é—®çš„ã€‚ systemstack(func() { stackfree(freem.g0.stack) // é‡Šæ”¾æ ˆ }) freem = freem.freelink } sched.freem = newList unlock(\u0026sched.lock) } // å †åˆ†é…ä¸€ä¸ªm mp := new(m)\t// Må¼€å§‹å‰éœ€è¦æ‰§è¡Œçš„å‡½æ•°ï¼Œä¸æ˜¯Mçš„å…¥å£å‡½æ•°ï¼Œæ˜¯æ‰§è¡Œmstartåä¼šè°ƒç”¨çš„å‡½æ•°ã€‚ // 1. å¦‚æœæ˜¯è°ƒåº¦çº¿ä¸‹è¿™é‡Œå­˜å‚¨çš„æ˜¯mspinning()å‡½æ•° // 2. å¦‚æœæ˜¯ç›‘æ§çº¿ç¨‹å­˜å‚¨çš„æ˜¯sysmon()å‡½æ•° mp.mstartfn = fn\t// åˆå§‹åŒ–Mï¼Œä¸»è¦æ˜¯æŠŠmåŠ å…¥åˆ°allmä¸­ï¼Œmè®°å½•allmåœ°å€ç­‰ // è¯¥å‡½æ•°åœ¨ç¨‹åºåˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¹Ÿè¢«è°ƒç”¨è¿‡ mcommoninit(mp, id)\t// In case of cgo or Solaris or illumos or Darwin, pthread_create will make us a stack. // Windows and Plan 9 will layout sched stack on OS stack. if iscgo || mStackIsSystemAllocated() { mp.g0 = malg(-1) } else { // runtime çš„g0æ ˆåˆ†é…çš„æ˜¯64kbå·¦å³å¤§å°ï¼Œå…¶ä»–çš„g0æ ˆåˆ†é…çš„æ˜¯8kbå·¦å³å¤§å° // å…³äºmalgå‡½æ•°ï¼Œæ˜¯æ¥è‡ªæ ˆç›¸å…³ mp.g0 = malg(8192 * sys.StackGuardMultiplier) // åˆ†é…ä¸€ä¸ªå¤§æ¦‚8Kbå·¦å³çš„g0ä½œä¸ºç³»ç»Ÿæ ˆ } mp.g0.m = mp\t// g0ä¸må…³è” if _p_ == _g_.m.p.ptr() { // å¦‚æœå‰é¢ä¸´æ—¶å€Ÿç”¨äº†Pï¼Œè¿™é‡Œéœ€è¦è¿˜å‡ºæ¥ releasep() // è§£ç»‘å½“å‰å·¥ä½œçº¿ç¨‹Må’ŒPçš„å…³è” } releasem(_g_.m) // åˆ¤æ–­å½“å‰gæ˜¯å¦éœ€è¦è¢«æŠ¢å ï¼Œè®¾ç½®æŠ¢å æ ‡å¿— allocmLock.runlock() return mp } acquirep() æŠŠpå’Œå½“å‰mè”ç³»èµ·æ¥ã€‚ è¿™ä¸ªå‡½æ•°å…è®¸æœ‰å†™éšœç¢ï¼Œå³ä½¿è°ƒç”¨è€…æ²¡æœ‰ï¼Œå› ä¸ºå®ƒç«‹å³è·å¾—_p_ã€‚ go:yeswritebarrierrecï¼šå…è®¸ç¼–è¯‘å™¨æ’å…¥å†™å±éšœç›¸å…³ä»£ç ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 4938 4939 4940 4941 4942 4943 4944 4945 4946 4947 4948 4949 4950 4951 4952 4953 4954 4955 4956 4957 4958 4959 // Associate p and the current m. // // This function is allowed to have write barriers even if the caller // isn't because it immediately acquires _p_. // //go:yeswritebarrierrec func acquirep(_p_ *p) { // Do the part that isn't allowed to have write barriers. wirep(_p_)\t// æŠŠ P ä¸ M ç»‘å®šèµ·æ¥ // Have p; write barriers now allowed. // ç°åœ¨æœ‰päº†ï¼›ç°åœ¨å…è®¸å†™å±éšœã€‚ // Perform deferred mcache flush before this P can allocate // from a potentially stale mcache. // åœ¨æ­¤På¯ä»¥ä»å¯èƒ½ä¸æ–°é²œçš„mcacheåˆ†é…ä¹‹å‰ï¼Œæ‰§è¡Œå»¶è¿Ÿçš„mcacheåˆ·æ–°ã€‚ _p_.mcache.prepareForSweep() if trace.enabled { traceProcStart() } } wirepæ˜¯acquirepçš„ç¬¬ä¸€æ­¥ï¼Œå®ƒå®é™…ä¸Šå°†å½“å‰Må…³è”åˆ°_p_ã€‚ å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰Pï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨è¿™éƒ¨åˆ†ä¸å…è®¸å†™éšœç¢ã€‚ go:nowritebarrierrecï¼šä¸å…è®¸ç¼–è¯‘å™¨æ’å…¥å†™å±éšœç›¸å…³ä»£ç ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 4959 4960 4961 4962 4963 4964 4965 4966 4967 4968 4969 4970 4971 4972 4973 4974 4975 4976 4977 4978 4979 4980 4981 4982 4983 4984 4985 // wirep is the first step of acquirep, which actually associates the // current M to _p_. This is broken out so we can disallow write // barriers for this part, since we don't yet have a P. // //go:nowritebarrierrec //go:nosplit func wirep(_p_ *p) { _g_ := getg() // g // è¿™é‡Œæ¥çš„mä¸€å®šéœ€è¦æ˜¯æ²¡ç»‘å®špçš„ã€‚ if _g_.m.p != 0 { throw(\"wirep: already in go\") } // å½“å‰pä¹Ÿæ˜¯ä¸èƒ½ç»‘å®šmçš„ï¼Œå¹¶ä¸”å½“å‰pçš„çŠ¶æ€ä¸èƒ½æ˜¯ _Pidle if _p_.m != 0 || _p_.status != _Pidle { id := int64(0) if _p_.m != 0 { id = _p_.m.ptr().id } print(\"wirep: p-\u003em=\", _p_.m, \"(\", id, \") p-\u003estatus=\", _p_.status, \"\\n\") throw(\"wirep: invalid p state\") } // p ä¸ m ç›¸äº’ç»‘å®š _g_.m.p.set(_p_) // m.p = _p_ _p_.m.set(_g_.m) // _p_.m = m _p_.status = _Prunning // è®¾ç½®pçš„çŠ¶æ€ä¸ºè¿è¡Œä¸­ } mcommoninit() é¢„åˆ†é…çš„IDå¯ä»¥ä½œä¸º'ID'ä¼ é€’ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¼ é€’-1æ¥çœç•¥ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 785 786 787 788 789 790 791 792 793 794 795 796 797 798 799 800 801 802 803 804 805 806 807 808 809 810 811 812 813 814 815 816 817 818 819 820 821 822 823 824 825 826 827 828 829 830 831 832 833 // Pre-allocated ID may be passed as 'id', or omitted by passing -1. func mcommoninit(mp *m, id int64) { _g_ := getg() // g // g0 stack won't make sense for user (and is not necessary unwindable). if _g_ != _g_.m.g0 { // ä¸èƒ½æ˜¯g0æ ˆ callers(1, mp.createstack[:]) } lock(\u0026sched.lock) if id \u003e= 0 { mp.id = id } else { mp.id = mReserveID() } lo := uint32(int64Hash(uint64(mp.id), fastrandseed)) hi := uint32(int64Hash(uint64(cputicks()), ^fastrandseed)) if lo|hi == 0 { hi = 1 } // Same behavior as for 1.17. // TODO: Simplify ths. if goarch.BigEndian { mp.fastrand = uint64(lo)\u003c\u003c32 | uint64(hi) } else { mp.fastrand = uint64(hi)\u003c\u003c32 | uint64(lo) } mpreinit(mp) // ä¿¡å·ç›¸å…³ if mp.gsignal != nil { mp.gsignal.stackguard1 = mp.gsignal.stack.lo + _StackGuard } // Add to allm so garbage collector doesn't free g-\u003em // when it is just in a register or thread-local storage. mp.alllink = allm // è®°å½•å½“å‰m.alllinkçš„å…¨å±€allmåœ°å€ // NumCgoCall() iterates over allm w/o schedlock, // so we need to publish it safely. atomicstorep(unsafe.Pointer(\u0026allm), unsafe.Pointer(mp))\t// æŠŠmæ·»åŠ åˆ°å…¨å±€allmä¸­ unlock(\u0026sched.lock) // Allocate memory to hold a cgo traceback if the cgo call crashes. if iscgo || GOOS == \"solaris\" || GOOS == \"illumos\" || GOOS == \"windows\" { mp.cgoCallers = new(cgoCallers) } } newm1() æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 2145 2146 2147 2148 2149 2150 2151 2152 2153 2154 2155 2156 2157 2158 2159 2160 2161 2162 2163 2164 2165 2166 2167 2168 2169 2170 func newm1(mp *m) { if iscgo { // cgoç›¸å…³ä»£ç  var ts cgothreadstart if _cgo_thread_start == nil { throw(\"_cgo_thread_start missing\") } ts.g.set(mp.g0) ts.tls = (*uint64)(unsafe.Pointer(\u0026mp.tls[0])) ts.fn = unsafe.Pointer(abi.FuncPCABI0(mstart)) if msanenabled { msanwrite(unsafe.Pointer(\u0026ts), unsafe.Sizeof(ts)) } if asanenabled { asanwrite(unsafe.Pointer(\u0026ts), unsafe.Sizeof(ts)) } execLock.rlock() // Prevent process clone. asmcgocall(_cgo_thread_start, unsafe.Pointer(\u0026ts)) execLock.runlock() return } execLock.rlock() // Prevent process clone. // newosprocå‡½æ•° è°ƒç”¨cloneå‡½æ•°åˆ›å»ºä¸€ä¸ªç³»ç»Ÿçº¿ç¨‹ // æ–°å»ºçš„è¿™ä¸ªç³»ç»Ÿçº¿ç¨‹å°†ä»mstart()å‡½æ•°å¼€å§‹è¿è¡Œã€‚ newosproc(mp) execLock.runlock() } newosproc() å¯ä»¥m.p==nil è¿è¡Œï¼Œå› æ­¤ä¸å…è®¸å†™å±éšœã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/os_linux.goã€‚ 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 // May run with m.p==nil, so write barriers are not allowed. // //go:nowritebarrier func newosproc(mp *m) { stk := unsafe.Pointer(mp.g0.stack.hi) // è·å–å½“å‰æ–°åˆ›å»ºçš„Mçš„g0æ ˆæ ˆé¡¶ä½ç½® /* * note: strace gets confused if we use CLONE_PTRACE here. */ if false { print(\"newosproc stk=\", stk, \" m=\", mp, \" g=\", mp.g0, \" clone=\", abi.FuncPCABI0(clone), \" id=\", mp.id, \" ostk=\", \u0026mp, \"\\n\") } // Disable signals during clone, so that the new thread starts // with signals disabled. It will enable them in minit. // // åœ¨å…‹éš†æœŸé—´ç¦ç”¨ä¿¡å·ï¼Œä»¥ä¾¿æ–°çº¿ç¨‹ä»¥ç¦ç”¨ä¿¡å·å¼€å§‹ã€‚ å®ƒå°†åœ¨minitä¸­å¯ç”¨å®ƒä»¬ã€‚ var oset sigset sigprocmask(_SIG_SETMASK, \u0026sigset_all, \u0026oset) // cloneFlags = _CLONE_VM | /* share memory */ // æŒ‡å®šçˆ¶å­çº¿ç¨‹å…±äº«è¿›ç¨‹åœ°å€ç©ºé—´ // _CLONE_FS | /* share cwd, etc */ // _CLONE_FILES | /* share fd table */ // _CLONE_SIGHAND | /* share sig handler table */ // _CLONE_SYSVSEM | /* share SysV semaphore undo lists (see issue #20763) */ // _CLONE_THREAD /* revisit - okay for now */ // åˆ›å»ºå­çº¿ç¨‹è€Œä¸æ˜¯å­è¿›ç¨‹ // ç¨‹åºçš„å…¥å£éƒ½æ˜¯ã€mstart()ã€‘å‡½æ•°å¼€å§‹ ret := clone(cloneFlags, stk, unsafe.Pointer(mp), unsafe.Pointer(mp.g0), unsafe.Pointer(abi.FuncPCABI0(mstart))) sigprocmask(_SIG_SETMASK, \u0026oset, nil) // æ€ä¹ˆä¹Ÿåº”è¯¥å‡ºç° ret å°äº0çš„æƒ…å†µ if ret \u003c 0 { print(\"runtime: failed to create new OS thread (have \", mcount(), \" already; errno=\", -ret, \")\\n\") if ret == -_EAGAIN { println(\"runtime: may need to increase max user processes (ulimit -u)\") } throw(\"newosproc\") } } clone() Cå‡½æ•°åŸå‹ï¼šint32 clone(int32 flags, void *stk, M *mp, G *gp, void (*fn)(void))\nint32 flagsï¼šæŒ‡å®šå†…æ ¸åˆ›å»ºçº¿ç¨‹æ—¶éœ€è¦çš„é€‰é¡¹ã€‚ void *stkï¼šæ–°çº¿ç¨‹åº”è¯¥ä½¿ç”¨çš„æ ˆï¼š å› ä¸ºå³å°†è¢«åˆ›å»ºçš„çº¿ç¨‹ä¸å½“å‰çº¿ç¨‹å…±äº«åŒä¸€ä¸ªè¿›ç¨‹åœ°å€ç©ºé—´ï¼Œæ‰€ä»¥è¿™é‡Œå¿…é¡»ä¸ºå­çº¿ç¨‹æŒ‡å®šå…¶ä½¿ç”¨çš„æ ˆï¼Œå¦åˆ™çˆ¶å­çº¿ç¨‹ä¼šå…±äº«åŒä¸€ä¸ªæ ˆä»è€Œé€ æˆæ··ä¹±ã€‚ ä»ä¸Šé¢çš„newosproc()å‡½æ•°å¯ä»¥çœ‹å‡ºï¼Œæ–°çº¿ç¨‹ä½¿ç”¨çš„æ ˆä¸ºm.g0.stack.loï½m.g0.stack.hiè¿™æ®µå†…å­˜ï¼Œè€Œè¿™æ®µå†…å­˜æ˜¯newm()å‡½æ•°åœ¨åˆ›å»ºmç»“æ„ä½“å¯¹è±¡æ—¶ä»è¿›ç¨‹çš„å †ä¸Šåˆ†é…è€Œæ¥çš„ã€‚ M *mpï¼šå·¥ä½œçº¿ç¨‹ M çš„ä¿¡æ¯è®°å½•ã€‚ G *gpï¼šg0æ ˆä¿¡æ¯è®°å½•ã€‚ void (*fn)(void)ï¼šå­çº¿ç¨‹ç¨‹åºå…¥å£å‡½æ•°ã€‚ ä¸Šé¢ä¸‰ä¸ªå‚æ•°ï¼ˆM *mpã€G *gpã€void (*fn)(void)ï¼‰ä¿å­˜åˆ°å¯„å­˜å™¨ï¼ˆR13ã€R9ã€R12ï¼‰ä¸­ï¼š ä¹‹æ‰€ä»¥éœ€è¦åœ¨ç³»ç»Ÿè°ƒç”¨ä¹‹å‰ä¿å­˜è¿™å‡ ä¸ªå‚æ•°ï¼ŒåŸå› åœ¨äºè¿™å‡ ä¸ªå‚æ•°ç›®å‰è¿˜ä½äºçˆ¶çº¿ç¨‹çš„æ ˆä¹‹ä¸­ã€‚ ä¸€æ—¦é€šè¿‡ç³»ç»Ÿè°ƒç”¨æŠŠå­çº¿ç¨‹åˆ›å»ºå‡ºæ¥ä¹‹åï¼Œå­çº¿ç¨‹å°†ä¼šä½¿ç”¨æˆ‘ä»¬åœ¨cloneç³»ç»Ÿè°ƒç”¨æ—¶ç»™å®ƒæŒ‡å®šçš„æ ˆã€‚ æ‰€ä»¥è¿™é‡Œéœ€è¦æŠŠè¿™å‡ ä¸ªå‚æ•°å…ˆä¿å­˜åˆ°å¯„å­˜å™¨ï¼Œç­‰å­çº¿ç¨‹ä»ç³»ç»Ÿè°ƒç”¨è¿”å›åç›´æ¥åœ¨å¯„å­˜å™¨ä¸­è·å–è¿™å‡ ä¸ªå‚æ•°ã€‚ è¿™é‡Œè¦æ³¨æ„çš„æ˜¯è™½ç„¶è¿™ä¸ªå‡ ä¸ªå‚æ•°å€¼ä¿å­˜åœ¨äº†çˆ¶çº¿ç¨‹çš„å¯„å­˜å™¨ä¹‹ä¸­ï¼Œä½†åˆ›å»ºå­çº¿ç¨‹æ—¶ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¼šæŠŠçˆ¶çº¿ç¨‹çš„æ‰€æœ‰å¯„å­˜å™¨å¸®æˆ‘ä»¬å¤åˆ¶ä¸€ä»½ç»™å­çº¿ç¨‹ï¼Œæ‰€ä»¥å½“å­çº¿ç¨‹å¼€å§‹è¿è¡Œæ—¶å°±èƒ½æ‹¿åˆ°çˆ¶çº¿ç¨‹ä¿å­˜åœ¨å¯„å­˜å™¨ä¸­çš„å€¼ï¼Œä»è€Œæ‹¿åˆ°è¿™å‡ ä¸ªå‚æ•°ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/sys_linux_amd64.sã€‚ 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 # int32 clone(int32 flags, void *stk, M *mp, G *gp, void (*fn)(void)); TEXT runtimeÂ·clone(SB),NOSPLIT,$0 # 1) æ¥å—å‚æ•°åˆ†è˜–æ”¾å…¥ DIã€SIã€R13ã€R9ã€R12å¯„å­˜å™¨ä¸­ # æ¸…é™¤ DXã€R10ã€D8å¯„å­˜å™¨çš„å€¼ # ç¬¬ä¸€ä¸ªå‚æ•° flagsï¼Œcloneéœ€è¦çš„å‚æ•° MOVL flags+0(FP), DI # DI = flags # ç¬¬äºŒä¸ªå‚æ•° stkï¼Œg0æ ˆç©ºé—´ MOVQ stk+8(FP), SI # SI = stk MOVQ $0, DX # æ¸…é™¤DXå¯„å­˜å™¨ MOVQ $0, R10 # æ¸…é™¤R10å¯„å­˜å™¨ MOVQ $0, R8 # æ¸…é™¤R8å¯„å­˜å™¨ # Copy mp, gp, fn off parent stack for use by child. # Careful: Linux system call clobbers CX and R11. # # ä»çˆ¶å †æ ˆä¸­å¤åˆ¶ mpã€gpã€fn ä»¥ä¾›å­çº§ä½¿ç”¨ # å°å¿ƒï¼šLinuxç³»ç»Ÿè°ƒç”¨clobbers CXå’ŒR11 # ç¬¬ä¸‰ä¸ªå‚æ•° mp # åœ¨cloneåå­çº¿ç¨‹å¼€å§‹è¿è¡Œæ—¶ï¼ŒR13ã€R9ã€R12çš„å€¼ä¼šè¢«æ‹·è´ç»™å­çº¿ç¨‹ MOVQ mp+16(FP), R13 # R13 = mp # ç¬¬å››ä¸ªå‚æ•° gpï¼Œè¿™é‡Œæ˜¯ g0 MOVQ gp+24(FP), R9 # R9 = gp # ç¬¬äº”ä¸ªå‚æ•° fnï¼Œmstart()å‡½æ•° MOVQ fn+32(FP), R12 # R12 = fn # 2) åˆ¤æ–­ mp å’Œ gp çš„å€¼æ˜¯ä¸º nil # åˆ¤æ–­mp==nilå’Œg0=nil # m å¦‚æœR13ä¸º0åˆ™è·³è½¬ CMPQ R13, $0 JEQ\tnog1 # g\tå¦‚æœR9ä¸º0åˆ™è·³è½¬ CMPQ R9, $0 JEQ\tnog1 # 3) æ‰¾åˆ°éœ€è¦è®¾ç½®TLSçš„åœ°å€å€¼ï¼Œä¹Ÿå°±æ˜¯\u0026m.tls[1] # è°ƒç”¨ç³»ç»ŸSYS_cloneå‡½æ•°å…‹éš†çº¿ç¨‹ # æŠŠm.tlsåœ°å€å­˜å…¥R8å¯„å­˜å™¨ LEAQ m_tls(R13), R8 # R8 = TLS #ifdef GOOS_android # Android stores the TLS offset in runtimeÂ·tls_g. SUBQ runtimeÂ·tls_g(SB), R8 #else # R8 = -8(FS); R8=\u0026m.tls[1]å¤„åœ°å€ ADDQ $8, R8\t# ELF wants to use -8(FS) #endif # æ·»åŠ CLONE_SETTLSæ ‡å¿— ORQ $0x00080000, DI #add flag CLONE_SETTLS(0x00080000) to call clone nog1: MOVL $SYS_clone, AX # å†™å…¥cloneå‡½æ•°æ ‡å¿—ï¼Œç„¶åè°ƒç”¨ç³»ç»Ÿå‡½æ•° # ç³»ç»Ÿè°ƒç”¨çº¦å®šå¯„å­˜å™¨ DI SI DX R10 R8 R9 å‚æ•°ä¼ å‚ # DI = flags # SI = stk # DX = 0 # R10 = 0 # R8 = R8=\u0026m.tls[1] # R9 = gp SYSCALL # 4) ç³»ç»Ÿè°ƒç”¨åï¼Œæ–°åˆ›å»ºçš„å­çº¿ç¨‹å’Œå½“å‰çº¿ç¨‹éƒ½ä¼šä»ç³»ç»Ÿè°ƒç”¨ä¸­è¿”å›ç„¶åæ‰§è¡Œåé¢çš„ä»£ç  # # é‚£ä¹ˆä»ç³»ç»Ÿè°ƒç”¨è¿”å›ä¹‹åæˆ‘ä»¬æ€ä¹ˆçŸ¥é“å“ªä¸ªæ˜¯çˆ¶çº¿ç¨‹å“ªä¸ªæ˜¯å­çº¿ç¨‹ï¼Œä»è€Œæ¥å†³å®šå®ƒä»¬çš„æ‰§è¡Œæµç¨‹ï¼Ÿ # ä½¿ç”¨è¿‡forkç³»ç»Ÿè°ƒç”¨çš„è¯»è€…åº”è¯¥çŸ¥é“ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡è¿”å›å€¼æ¥åˆ¤æ–­çˆ¶å­çº¿ç¨‹ï¼š # 1. ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼å¦‚æœæ˜¯0åˆ™è¡¨ç¤ºè¿™æ˜¯å­çº¿ç¨‹ # 2. ä¸ä¸º0åˆ™è¡¨ç¤ºè¿™ä¸ªæ˜¯çˆ¶çº¿ç¨‹ # 4.1) çˆ¶çº¿ç¨‹çš„å¤„ç†é€»è¾‘ # In parent, return. # # åœ¨çˆ¶çº¿ç¨‹ä¸­ï¼Œç›´æ¥è¿”å›ã€‚ # åˆ¤æ–­ç³»ç»Ÿè°ƒç”¨SYS_cloneçš„è¿”å›å€¼AXä¸0æ¯”è¾ƒ CMPQ AX, $0 # JEQ è¡¨ç¤ºAXæ˜¯0åˆ™æ‰§è¡Œ 3(PC)è·³è¿‡3æ¡æŒ‡ä»¤ JEQ\t3(PC) #è·³è½¬åˆ°å­çº¿ç¨‹éƒ¨åˆ† # è¿™é‡Œæ˜¯çˆ¶çº¿ç¨‹ç›´æ¥æŠŠè¿”å›å€¼å†™å…¥æ ˆï¼Œç„¶åé€€å‡ºå‡½æ•° MOVL AX, ret+40(FP)\tRET\t# 4.2) å­çº¿ç¨‹çš„å¤„ç†é€»è¾‘ï¼Œè®¾ç½®SPï¼Œåˆ¤æ–­mpå’Œgpï¼Œè®¾ç½®mp.procid # In child, on new stack. # # åœ¨å­çº¿ç¨‹ä¸­ï¼Œåœ¨newæ ˆä¸Šã€‚ # æ–°åˆ›å»ºçš„å­çº¿ç¨‹ä»è¿™é‡Œå¼€å§‹ï¼Œæ³¨æ„ä¸€ä¸‹ä»£ç æ˜¯åœ¨å­çº¿ç¨‹ä¸­ï¼Œå¯„å­˜å™¨ä¹Ÿæ˜¯å­çº¿ç¨‹çš„ # è®¾ç½®CPUæ ˆé¡¶å¯„å­˜å™¨æŒ‡å‘å­çº¿ç¨‹çš„æ ˆé¡¶ï¼Œè¿™æ¡æŒ‡ä»¤çœ‹èµ·æ¥æ˜¯å¤šä½™çš„ï¼Ÿå†…æ ¸åº”è¯¥å·²ç»æŠŠSPè®¾ç½®å¥½äº† MOVQ SI, SP # If g or m are nil, skip Go-related setup. # # å¦‚æœ g æˆ– m ä¸º nilï¼Œè·³è¿‡ Go-related è®¾ç½®ã€‚ # m\tæ–°åˆ›å»ºçš„mç»“æ„ä½“å¯¹è±¡çš„åœ°å€ï¼Œç”±çˆ¶çº¿ç¨‹ä¿å­˜åœ¨R13å¯„å­˜å™¨ä¸­çš„å€¼è¢«å¤åˆ¶åˆ°äº†å­çº¿ç¨‹ CMPQ R13, $0 # R13 = mp JEQ\tnog2 # R13 ä¸º 0 æ—¶è·³è½¬ # g\tm.g0çš„åœ°å€ï¼Œç”±çˆ¶çº¿ç¨‹ä¿å­˜åœ¨R9å¯„å­˜å™¨ä¸­çš„å€¼è¢«å¤åˆ¶åˆ°äº†å­çº¿ç¨‹ CMPQ R9, $0 # R9 = gp JEQ\tnog2 # R9 ä¸º 0 æ—¶è·³è½¬ # Initialize m-\u003eprocid to Linux tid # # å°†m-\u003eprocidåˆå§‹åŒ–ä¸ºLinux tidã€‚ MOVL $SYS_gettid, AX\t# é€šè¿‡gettid()ç³»ç»Ÿè°ƒç”¨è·å–çº¿ç¨‹IDï¼ˆtidï¼‰ SYSCALL MOVQ AX, m_procid(R13) # m.procid = tid # Set FS to point at m-\u003etls. # # æ–°çº¿ç¨‹åˆšåˆšåˆ›å»ºå‡ºæ¥ï¼Œè¿˜æœªè®¾ç½®çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œå³mç»“æ„ä½“å¯¹è±¡è¿˜æœªä¸å·¥ä½œçº¿ç¨‹å…³è”èµ·æ¥ï¼Œ # ä¸‹é¢çš„æŒ‡ä»¤è´Ÿè´£è®¾ç½®æ–°çº¿ç¨‹çš„TLSï¼ŒæŠŠmå¯¹è±¡å’Œå·¥ä½œçº¿ç¨‹å…³è”èµ·æ¥ # è¿™ä¸¤è¡Œä»£ç åœ¨go1.18ä¸­æ¶ˆå¤±äº†ï¼ŒåŸå› åœ¨äºCLONE_SETTLSé…åˆå‚æ•°å’ŒR8å¯„å­˜å™¨åœ¨cloneä¸­è¢«è®¾ç½®äº† # LEAQ m_tls(R13), DI # å–m.tlså­—æ®µçš„åœ°å€\t# CALL runtimeÂ·settls(SB) # In child, set up new stack get_tls(CX)\t# CX=\u0026m.tls[1]; CX=TLS MOVQ R13, g_m(R9) # g0.m = m MOVQ R9, g(CX) # m.tls[0]=\u0026g0 # R14=\u0026g0 R14å¯„å­˜å™¨ä¸»è¦å­˜å‚¨å½“å‰æ­£åœ¨è¿è¡Œçš„goroutine MOVQ R9, R14 # set g register CALL runtimeÂ·stackcheck(SB) # æ£€æŸ¥ SP æ˜¯å¦åœ¨ [g-\u003estack.lo, g-\u003estack.hi) èŒƒå›´å†… nog2: # Call fn. This is the PC of an ABI0 function. # # è°ƒç”¨mstart()å‡½æ•°å¼€å§‹è°ƒåº¦å¾ªç¯ CALL R12\t# æ°¸ä¸è¿”å› # It shouldn't return. If it does, exit that thread. MOVL $111, DI MOVL $SYS_exit, AX SYSCALL JMP\t-3(PC) // keep exiting stackcheck() æ£€æŸ¥SPæ˜¯å¦åœ¨[g-\u003estack.lo, g-\u003estack.hi)èŒƒå›´å†…ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/sys_linux_amd64.sã€‚ 1061 1062 1063 1064 1065 1066 1067 1068 1069 1070 1071 1072 1073 # check that SP is in range [g-\u003estack.lo, g-\u003estack.hi) TEXT runtimeÂ·stackcheck(SB), NOSPLIT, $0-0 get_tls(CX) # CX=TLS MOVQ g(CX), AX # AX=g0 # g0.stack.hi ä¸ SP æ¯”è¾ƒ CMPQ (g_stack+stack_hi)(AX), SP JHI\t2(PC) CALL runtimeÂ·abort(SB) # g0.stack.lo ä¸ SP æ¯”è¾ƒ CMPQ SP, (g_stack+stack_lo)(AX) JHI\t2(PC) CALL runtimeÂ·abort(SB) RET ",
  "wordCount" : "3970",
  "inLanguage": "zh",
  "image": "https://helium-chain.github.io/favicon-32x32.png","datePublished": "2024-07-30T00:00:00Z",
  "dateModified": "2024-07-30T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://helium-chain.github.io/posts/golang/goroutine/newm/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://helium-chain.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://helium-chain.github.io/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://helium-chain.github.io/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://helium-chain.github.io/" title="ä¸»é¡µ">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://helium-chain.github.io/posts" title="æ–‡ç« ">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://helium-chain.github.io/archives" title="æ—¶é—´è½´">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://helium-chain.github.io/tags/" title="æ ‡ç­¾">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://helium-chain.github.io/search/" title="æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://helium-chain.github.io/support" title="æ‰“èµ">
                    <span>ğŸ«¶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://helium-chain.github.io/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://helium-chain.github.io/posts/">Article</a>&nbsp;Â»&nbsp;<a href="https://helium-chain.github.io/posts/golang/">Golang</a>&nbsp;Â»&nbsp;<a href="https://helium-chain.github.io/posts/golang/goroutine/">ç¬¬12ç«  Goroutine</a></div>
    <h1 class="post-title entry-hint-parent">
      å·¥ä½œçº¿ç¨‹çš„å”¤é†’å’Œåˆ›å»º
    </h1>
    <div class="post-description">
      ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬
    </div>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2024-07-30</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2024-07-30</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>3970å­—</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>19åˆ†é’Ÿ</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &nbsp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://helium-chain.github.io/tags/golang/" target="_blank" rel="noopener">Golang</a>
            <a href="https://helium-chain.github.io/tags/goroutine/" target="_blank" rel="noopener">Goroutine</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &nbsp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%94%a4%e9%86%92%e5%b7%a5%e4%bd%9c%e7%ba%bf%e7%a8%8b" aria-label="å”¤é†’å·¥ä½œçº¿ç¨‹">å”¤é†’å·¥ä½œçº¿ç¨‹</a><ul>
                            
                    <li>
                        <a href="#wakep" aria-label="wakep()">wakep()</a></li>
                    <li>
                        <a href="#startm" aria-label="startm()">startm()</a><ul>
                            
                    <li>
                        <a href="#acquirem" aria-label="acquirem()">acquirem()</a></li>
                    <li>
                        <a href="#releasem" aria-label="releasem()">releasem()</a></li>
                    <li>
                        <a href="#pidleget" aria-label="pidleget()">pidleget()</a></li>
                    <li>
                        <a href="#mget" aria-label="mget()">mget()</a></li>
                    <li>
                        <a href="#mreserveid" aria-label="mReserveID()">mReserveID()</a></li></ul>
                    </li>
                    <li>
                        <a href="#notewakeup" aria-label="notewakeup()">notewakeup()</a></li>
                    <li>
                        <a href="#futexwakeup" aria-label="futexwakeup()">futexwakeup()</a></li>
                    <li>
                        <a href="#futex" aria-label="futex()">futex()</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%88%9b%e5%bb%ba%e5%b7%a5%e4%bd%9c%e7%ba%bf%e7%a8%8b" aria-label="åˆ›å»ºå·¥ä½œçº¿ç¨‹">åˆ›å»ºå·¥ä½œçº¿ç¨‹</a><ul>
                            
                    <li>
                        <a href="#newm" aria-label="newm()">newm()</a><ul>
                            
                    <li>
                        <a href="#acquirem-1" aria-label="acquirem()">acquirem()</a></li></ul>
                    </li>
                    <li>
                        <a href="#allocm" aria-label="allocm()">allocm()</a><ul>
                            
                    <li>
                        <a href="#acquirep" aria-label="acquirep()">acquirep()</a></li>
                    <li>
                        <a href="#mcommoninit" aria-label="mcommoninit()">mcommoninit()</a></li></ul>
                    </li>
                    <li>
                        <a href="#newm1" aria-label="newm1()">newm1()</a></li>
                    <li>
                        <a href="#newosproc" aria-label="newosproc()">newosproc()</a></li>
                    <li>
                        <a href="#clone" aria-label="clone()">clone()</a></li>
                    <li>
                        <a href="#stackcheck" aria-label="stackcheck()">stackcheck()</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><h2 id="å”¤é†’å·¥ä½œçº¿ç¨‹">å”¤é†’å·¥ä½œçº¿ç¨‹<a hidden class="anchor" aria-hidden="true" href="#å”¤é†’å·¥ä½œçº¿ç¨‹">#</a></h2>
<ol>
<li>å»å°è¯•å”¤é†’å·¥ä½œçº¿ç¨‹æ¡ä»¶ï¼š<strong><code>atomic.Load(&amp;sched.npidle) != 0 &amp;&amp; atomic.Load(&amp;sched.nmspinning) == 0</code></strong>ã€‚
<ul>
<li><strong><code>atomic.Load(&amp;sched.npidle) != 0</code></strong>ï¼šæœ‰ç©ºé—²çš„<code>P</code>ã€‚</li>
<li><strong><code>atomic.Load(&amp;sched.nmspinning) == 0</code></strong>ï¼šæ²¡æœ‰å·¥ä½œçº¿ç¨‹æ­£åœ¨å°è¯•ä»å…¶ä»–å·¥ä½œçº¿ç¨‹çš„æœ¬åœ°é˜Ÿåˆ—å·å–<code>goroutine</code>ã€‚(å°±æ˜¯æ²¡æœ‰<code>spinning</code>è‡ªæ—‹çš„<code>goroutine</code>æ—¶)</li>
</ul>
</li>
<li>å”¤é†’ç©ºé—²çš„<code>P</code>å’Œ<code>M</code>ç”±<code>wakep()</code>å‡½æ•°å®Œæˆã€‚</li>
</ol>
<h3 id="wakep">wakep()<a hidden class="anchor" aria-hidden="true" href="#wakep">#</a></h3>
<ol>
<li>å°è¯•æ·»åŠ ä¸€ä¸ª<code>P</code>æ¥æ‰§è¡Œ<code>G</code>ã€‚å½“<code>G</code>æ˜¯å¯è¿è¡Œæ—¶è°ƒç”¨(<code>newproc, ready</code>)ã€‚</li>
<li><code>wakep()</code>å‡½æ•°è¢«è°ƒç”¨çš„åœ°æ–¹ï¼šã€åˆ›å»º<code>g</code>æ—¶å€™ï¼Œåœ¨<code>newproc()</code>å‡½æ•°ä¸­ï¼Œå°±æ˜¯<code>go</code>å…³é”®å­—ã€‘ï¼Œã€<code>g</code>æ”¾å›<code>P</code>çš„æ—¶å€™ï¼Œåœ¨<code>ready()</code>å‡½æ•°ä¸­ã€‘ã€‚
<ul>
<li><code>newproc()</code>å‡½æ•°ä¸­ï¼Œä¹Ÿå°±æ˜¯<code>go</code>å…³é”®å­—æ—¶ï¼Œ<code>runtime.main</code>å·²å¯åŠ¨æ—¶ã€‚ï¼ˆè¿™ç§æƒ…å†µå‘ç”Ÿåœ¨<code>go</code>å…³é”®å­—æ—¶ï¼‰</li>
<li><code>ready()</code>å‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°é€šè¿‡æŠŠéœ€è¦å”¤é†’çš„<code>goroutine</code>æ”¾å…¥è¿è¡Œé˜Ÿåˆ—æ¥å”¤é†’å®ƒã€‚ï¼ˆè¿™ç§æƒ…å†µåœ¨<code>g</code>è¢«æŒ‚åœ¨äº†å…¶ä»–åœ°æ–¹æ—¶éœ€è¦æ¢å¤åˆ°<code>P</code>ä¸­æ—¶ï¼‰</li>
</ul>
</li>
<li>ä¹Ÿå°±æ˜¯åªè¦<code>g</code>è¢«æ”¾å…¥æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼Œå‡†å¤‡è¿è¡Œæ—¶éƒ½éœ€è¦è°ƒç”¨<code>wakep()</code>å‡½æ•°å°è¯•åˆ©ç”¨ç©ºé—²çš„<code>M</code>å’Œ<code>P</code>æ¥è¿è¡Œå®ƒã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2420
</span><span class="lnt">2421
</span><span class="lnt">2422
</span><span class="lnt">2423
</span><span class="lnt">2424
</span><span class="lnt">2425
</span><span class="lnt">2426
</span><span class="lnt">2427
</span><span class="lnt">2428
</span><span class="lnt">2429
</span><span class="lnt">2430
</span><span class="lnt">2431
</span><span class="lnt">2432
</span><span class="lnt">2433
</span><span class="lnt">2434
</span><span class="lnt">2435
</span><span class="lnt">2436
</span><span class="lnt">2437
</span><span class="lnt">2438
</span><span class="lnt">2439
</span><span class="lnt">2440
</span><span class="lnt">2441
</span><span class="lnt">2442
</span><span class="lnt">2443
</span><span class="lnt">2444
</span><span class="lnt">2445
</span><span class="lnt">2446
</span><span class="lnt">2447
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Tries to add one more P to execute G&#39;s.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Called when a G is made runnable (newproc, ready).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">wakep</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ²¡æœ‰ç©ºé—²çš„Pï¼Œç›´æ¥è¿”å›ã€‚å½“å‰æ‰€æœ‰çš„Péƒ½åœ¨å·¥ä½œã€‚å› ä¸ºPçš„æ•°é‡æ˜¯å›ºå®šçš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">npidle</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// be conservative about spinning threads
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯¹è‡ªæ—‹çš„çº¿ç¨‹æŒä¿å®ˆæ€åº¦ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 	1. sched.nmspinning != 0ï¼šæœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨è‡ªæ—‹ï¼ˆå°±æ˜¯åœ¨å…¶ä»–çº¿ç¨‹ä¸­å»å·å–gï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. !atomic.Cas(&amp;sched.nmspinning, 0, 1)ï¼šé€šè¿‡casæ“ä½œå†æ¬¡ç¡®è®¤æ˜¯å¦æœ‰å…¶ä»–å·¥ä½œçº¿ç¨‹å¤„äºspinningçŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä»è¿›å…¥wakep()åˆ¤æ–­åˆ°çœŸæ­£å¯åŠ¨å·¥ä½œçº¿ç¨‹ä¹‹å‰çš„è¿™ä¸€æ®µæ—¶é—´ä¹‹å†…ï¼Œå¦‚æœå·²ç»æœ‰å·¥ä½œçº¿ç¨‹è¿›å…¥äº†spinningçŠ¶æ€è€Œåœ¨å››å¤„å¯»æ‰¾éœ€è¦è¿è¡Œçš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™æ ·çš„è¯æˆ‘ä»¬å°±æ²¡æœ‰å¿…è¦å†å¯åŠ¨ä¸€ä¸ªå¤šä½™çš„å·¥ä½œçº¿ç¨‹å‡ºæ¥äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœcasæ“ä½œæˆåŠŸï¼Œåˆ™ç»§ç»­è°ƒç”¨startmåˆ›å»ºä¸€ä¸ªæ–°çš„æˆ–å”¤é†’ä¸€ä¸ªå¤„äºç¡çœ çŠ¶æ€çš„å·¥ä½œçº¿ç¨‹å‡ºæ¥å·¥ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 1. atomic.Load(&amp;sched.nmspinning) != 0 æˆç«‹ï¼šæœ‰å…¶ä»–å·¥ä½œçº¿ç¨‹æ­£åœ¨è‡ªæ—‹ï¼Œç›´æ¥returné€€å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2. atomic.Load(&amp;sched.nmspinning) == 0 æˆç«‹ï¼šå½“å‰æ²¡æœ‰å¿™ç¢Œçš„å·¥ä½œçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    atomic.Cas(&amp;sched.nmspinning, 0, 1) == trueï¼šå½“å‰æ²¡æœ‰å¿™ç¢Œçš„å·¥ä½œçº¿ç¨‹ï¼Œå½“å‰å¯ä»¥åˆ›å»ºå·¥ä½œçº¿ç¨‹ï¼Œå¹¶æ ‡è®°sched.nmspinning=1é˜»æ­¢åæ¥è€…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    atomic.Cas(&amp;sched.nmspinning, 0, 1) == falseï¼šå½“å‰æœ‰å…¶ä»–å¿™ç¢Œçš„å·¥ä½œçº¿ç¨‹ï¼Œç›´æ¥returné€€å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">!</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Cas</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// ç¨‹åºæ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜ï¼šsched.nmspinningä¸€å®šè¢«æ ‡è®°ä¸º1äº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">startm</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="startm">startm()<a hidden class="anchor" aria-hidden="true" href="#startm">#</a></h3>
<ol>
<li>è°ƒåº¦ä¸€äº›<code>M</code>æ¥è¿è¡Œ<code>p</code>(å¦‚æœéœ€è¦ï¼Œåˆ›å»ºä¸€ä¸ª<code>M</code>)ã€‚</li>
<li>å¦‚æœ<code>p==nil</code>ï¼Œå°è¯•å¾—åˆ°ä¸€ä¸ªç©ºé—²çš„<code>p</code>ï¼Œå¦‚æœæ²¡æœ‰ç©ºé—²çš„<code>p</code>ä»€ä¹ˆéƒ½ä¸åšã€‚</li>
<li>å¯ä»¥ä½¿ç”¨<code>m.p==nil</code>è¿è¡Œï¼Œå› æ­¤ä¸å…è®¸å†™å…¥éšœç¢ã€‚</li>
<li>å¦‚æœè®¾ç½®äº†<code>spinning</code>ï¼Œåˆ™è°ƒç”¨è€…å¢åŠ äº†<code>nmspinning</code>ï¼Œè€Œ<code>startm</code>å°†å‡å°‘<code>nmspinning</code>æˆ–åœ¨æ–°å¯åŠ¨çš„<code>M</code>ä¸­è®¾ç½®<code>m.spinning</code>ã€‚</li>
<li>ä¼ é€’<code>nil</code>çš„Pçš„è°ƒç”¨æ–¹å¿…é¡»ä»ä¸å¯æŠ¢å çš„ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ã€‚è§ä¸‹é¢å¯¹<code>acquirem</code>ã€‚</li>
<li>å¿…é¡»æ²¡æœ‰å†™éšœç¢ï¼Œå› ä¸ºè¿™ä¸ªå¯èƒ½æ²¡æœ‰<code>P</code>ã€‚</li>
<li><code>go:nowritebarrierrec</code>ï¼šä¸å…è®¸ç¼–è¯‘å™¨æ’å…¥å†™å±éšœç›¸å…³ä»£ç ã€‚</li>
<li>åœ¨æŠ¢å ç³»ç»Ÿè°ƒç”¨çš„<code>P</code>çš„æ—¶å€™è¯¥å‡½æ•°ä¼šè¢«è°ƒç”¨ï¼Œå¹¶ä¼ å…¥ç©ºé—²çš„<code>P</code>å’Œ<code>false</code>å‚æ•°ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>_p_ *p</code>ï¼š<code>nil</code>è¡¨ç¤ºæ²¡æœ‰æŒ‡å®š<code>P</code>ï¼Œå¦åˆ™æŒ‡å®š<code>P</code>ã€‚</li>
<li><code>spinning bool</code>ï¼š<code>true</code>.<code>sched.nmspinning</code>çš„å€¼åœ¨å‰é¢è¢«åŠ ä¸€äº†ã€‚<code>false</code>.æ²¡æœ‰åŠ ä¸€ã€‚</li>
</ul>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2257
</span><span class="lnt">2258
</span><span class="lnt">2259
</span><span class="lnt">2260
</span><span class="lnt">2261
</span><span class="lnt">2262
</span><span class="lnt">2263
</span><span class="lnt">2264
</span><span class="lnt">2265
</span><span class="lnt">2266
</span><span class="lnt">2267
</span><span class="lnt">2268
</span><span class="lnt">2269
</span><span class="lnt">2270
</span><span class="lnt">2271
</span><span class="lnt">2272
</span><span class="lnt">2273
</span><span class="lnt">2274
</span><span class="lnt">2275
</span><span class="lnt">2276
</span><span class="lnt">2277
</span><span class="lnt">2278
</span><span class="lnt">2279
</span><span class="lnt">2280
</span><span class="lnt">2281
</span><span class="lnt">2282
</span><span class="lnt">2283
</span><span class="lnt">2284
</span><span class="lnt">2285
</span><span class="lnt">2286
</span><span class="lnt">2287
</span><span class="lnt">2288
</span><span class="lnt">2289
</span><span class="lnt">2290
</span><span class="lnt">2291
</span><span class="lnt">2292
</span><span class="lnt">2293
</span><span class="lnt">2294
</span><span class="lnt">2295
</span><span class="lnt">2296
</span><span class="lnt">2297
</span><span class="lnt">2298
</span><span class="lnt">2299
</span><span class="lnt">2300
</span><span class="lnt">2301
</span><span class="lnt">2302
</span><span class="lnt">2303
</span><span class="lnt">2304
</span><span class="lnt">2305
</span><span class="lnt">2306
</span><span class="lnt">2307
</span><span class="lnt">2308
</span><span class="lnt">2309
</span><span class="lnt">2310
</span><span class="lnt">2311
</span><span class="lnt">2312
</span><span class="lnt">2313
</span><span class="lnt">2314
</span><span class="lnt">2315
</span><span class="lnt">2316
</span><span class="lnt">2317
</span><span class="lnt">2318
</span><span class="lnt">2319
</span><span class="lnt">2320
</span><span class="lnt">2321
</span><span class="lnt">2322
</span><span class="lnt">2323
</span><span class="lnt">2324
</span><span class="lnt">2325
</span><span class="lnt">2326
</span><span class="lnt">2327
</span><span class="lnt">2328
</span><span class="lnt">2329
</span><span class="lnt">2330
</span><span class="lnt">2331
</span><span class="lnt">2332
</span><span class="lnt">2333
</span><span class="lnt">2334
</span><span class="lnt">2335
</span><span class="lnt">2336
</span><span class="lnt">2337
</span><span class="lnt">2338
</span><span class="lnt">2339
</span><span class="lnt">2340
</span><span class="lnt">2341
</span><span class="lnt">2342
</span><span class="lnt">2343
</span><span class="lnt">2344
</span><span class="lnt">2345
</span><span class="lnt">2346
</span><span class="lnt">2347
</span><span class="lnt">2348
</span><span class="lnt">2349
</span><span class="lnt">2350
</span><span class="lnt">2351
</span><span class="lnt">2352
</span><span class="lnt">2353
</span><span class="lnt">2354
</span><span class="lnt">2355
</span><span class="lnt">2356
</span><span class="lnt">2357
</span><span class="lnt">2358
</span><span class="lnt">2359
</span><span class="lnt">2360
</span><span class="lnt">2361
</span><span class="lnt">2362
</span><span class="lnt">2363
</span><span class="lnt">2364
</span><span class="lnt">2365
</span><span class="lnt">2366
</span><span class="lnt">2367
</span><span class="lnt">2368
</span><span class="lnt">2369
</span><span class="lnt">2370
</span><span class="lnt">2371
</span><span class="lnt">2372
</span><span class="lnt">2373
</span><span class="lnt">2374
</span><span class="lnt">2375
</span><span class="lnt">2376
</span><span class="lnt">2377
</span><span class="lnt">2378
</span><span class="lnt">2379
</span><span class="lnt">2380
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Schedules some M to run the p (creates an M if necessary).
</span></span></span><span class="line"><span class="cl"><span class="c1">// If p==nil, tries to get an idle P, if no idle P&#39;s does nothing.
</span></span></span><span class="line"><span class="cl"><span class="c1">// May run with m.p==nil, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If spinning is set, the caller has incremented nmspinning and startm will
</span></span></span><span class="line"><span class="cl"><span class="c1">// either decrement nmspinning or set m.spinning in the newly started M.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Callers passing a non-nil P must call from a non-preemptible context. See
</span></span></span><span class="line"><span class="cl"><span class="c1">// comment on acquirem below.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Must not have write barriers because this may be called without a P.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">startm</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">spinning</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Disable preemption.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Every owned P must have an owner that will eventually stop it in the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// event of a GC stop request. startm takes transient ownership of a P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// (either from argument or pidleget below) and transfers ownership to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// a started M, which will be responsible for performing the stop.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Preemption must be disabled during this transient ownership,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// otherwise the P this is running on may enter GC stop while still
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// holding the transient P, leaving that P in limbo and deadlocking the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// STW.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Callers passing a non-nil P must already be in non-preemptible
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// context, otherwise such preemption could occur on function entry to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// startm. Callers passing a nil P may be preemptible, so we must
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// disable preemption before acquiring a P from pidleget below.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">acquirem</span><span class="p">()</span>    <span class="c1">// ç¦æ­¢å½“å‰Mè¢«æŠ¢å 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>   <span class="c1">// é”ä½å…¨å±€sched
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æœ‰ç©ºé—²çš„pæ‰ä¼šå»å”¤é†’çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_p_</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>     <span class="c1">// å¦‚æœæ²¡æœ‰æŒ‡å®šPï¼Œåˆ™éœ€è¦ä»Pçš„ç©ºé—²åˆ—è¡¨ä¸­è·å–ä¸€ä¸ªP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_p_</span> <span class="p">=</span> <span class="nf">pidleget</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>   <span class="c1">// ä»Pçš„ç©ºé—²é˜Ÿåˆ—ä¸­è·å–ç©ºé—²çš„P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ²¡æœ‰ç©ºé—²çš„Pï¼Œæ„å‘³ç€æ‰€æœ‰çš„Péƒ½å¾ˆå¿™ä¸éœ€è¦å”¤é†’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">_p_</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">            <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ä¹‹å‰çš„CasæŠŠnmspinningåŠ ä¸€ï¼Œè¿™é‡Œéœ€è¦å‡å›æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">spinning</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">                <span class="c1">// The caller incremented nmspinning, but there are no idle Ps,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// so it&#39;s okay to just undo the increment and give up.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// æ­£å¸¸é€»è¾‘è¿™é‡Œä¸åº”è¯¥å‡æˆè´Ÿæ•°ï¼Œå¦åˆ™æ˜¯ç³»ç»Ÿé€»è¾‘å­˜åœ¨é”™è¯¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;startm: negative nmspinning&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ä¸acquiremå‡½æ•°å‘¼åº”ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦æœ‰æŠ¢å è¯·æ±‚å‘ç”Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">releasem</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">            <span class="k">return</span>  <span class="c1">// æ²¡æœ‰ç©ºé—²çš„Pç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// å°è¯•ä»mç©ºé—²é˜Ÿåˆ—ä¸­è·å–æ­£å¤„äºç¡çœ ä¹‹ä¸­çš„å·¥ä½œçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ‰€æœ‰å¤„äºç¡çœ çŠ¶æ€çš„méƒ½åœ¨æ­¤é˜Ÿåˆ—ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nmp</span> <span class="o">:=</span> <span class="nf">mget</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// æ²¡æœ‰å¤„äºç¡çœ çŠ¶æ€çš„å·¥ä½œçº¿ç¨‹ï¼Œè¿™ç§æƒ…å†µéœ€è¦å»åˆ›å»ºçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">nmp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">        <span class="c1">// No M is available, we must drop sched.lock and call newm.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// However, we already own a P to assign to the M.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Once sched.lock is released, another G (e.g., in a syscall),
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// could find no idle P while checkdead finds a runnable G but
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// no running M&#39;s because this new M hasn&#39;t started yet, thus
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// throwing in an apparent deadlock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Avoid this situation by pre-allocating the ID for the new M,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// thus marking it as &#39;running&#39; before we drop sched.lock. This
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// new M will eventually run the scheduler to execute any
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// queued G&#39;s.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿™é‡Œæ˜¯ä¸ºéœ€è¦æ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹å‡†å¤‡å·¥ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">id</span> <span class="o">:=</span> <span class="nf">mReserveID</span><span class="p">()</span>      <span class="c1">// ç»™éœ€è¦åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹åˆ†é…ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆå§‹åŒ–fnå‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨å·¥ä½œçº¿ç¨‹åˆšå¯åŠ¨æ—¶ä¼šè¢«è°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">var</span> <span class="nx">fn</span> <span class="kd">func</span><span class="p">()</span>   <span class="c1">// nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">spinning</span> <span class="p">{</span>   <span class="c1">// å¦‚æœéœ€è¦æ ‡è®°å½“å‰å·¥ä½œçº¿ç¨‹æ˜¯è‡ªæ—‹çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// The caller incremented nmspinning, so set m.spinning in the new M.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// mspinningå‡½æ•°å°±ä¸€è¡Œä»£ç  &#39;getg().m.spinning = true&#39; æ ‡è®°å½“å‰å·¥ä½œçº¿ç¨‹æ˜¯è‡ªæ—‹çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å› ä¸ºå…¨å±€çš„sched.nmspinningå·²ç»åŠ ä¸€äº†ï¼Œå› æ­¤éœ€è¦æ ‡è®°mçš„spinning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">fn</span> <span class="p">=</span> <span class="nx">mspinning</span>	
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">newm</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">_p_</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>   <span class="c1">// åˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Ownership transfer of _p_ committed by start in newm.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Preemption is now safe.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">releasem</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ°è¿™é‡Œè¯´æ˜æœ‰æ­£åœ¨å¤„äºç¡çœ çš„å·¥ä½œçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»ç©ºé—²çš„çº¿ç¨‹é˜Ÿåˆ—ä¸­æ‹¿å‡ºæ¥çš„ spinning æ ‡å¿—ä½å­˜åœ¨ï¼Œè¯´æ˜sleepæ—¶æœ‰é—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">nmp</span><span class="p">.</span><span class="nx">spinning</span> <span class="p">{</span> <span class="c1">// ç³»ç»Ÿé€»è¾‘å­˜åœ¨é—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;startm: m is spinning&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å·¥ä½œçº¿ç¨‹è¿˜ä¸å…¶ä»–Pæœ‰å…³ï¼Œè¯´æ˜æœ‰é—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">nmp</span><span class="p">.</span><span class="nx">nextp</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// ç³»ç»Ÿé€»è¾‘å­˜åœ¨é—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;startm: m has p&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç©ºé—²çš„Pä¸­ä¸åº”è¯¥å­˜åœ¨gï¼Œç³»ç»Ÿé€»è¾‘å­˜åœ¨é—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">spinning</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nf">runqempty</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;startm: p has runnable gs&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// The caller incremented nmspinning, so set m.spinning in the new M.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è°ƒç”¨è€…å¢åŠ nmspinningï¼Œå› æ­¤å°†m.spinningè®¾ç½®ä¸ºæ–°çš„Mã€‚å› æ­¤å½“å‰è¿™ä¸ªMå°±æ˜¯è¿™ä¸ªè‡ªæ—‹çš„M
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nmp</span><span class="p">.</span><span class="nx">spinning</span> <span class="p">=</span> <span class="nx">spinning</span> <span class="c1">// æ ‡è®°å½“å‰éœ€è¦å”¤é†’çš„å·¥ä½œçº¿ç¨‹ è‡ªæ—‹çš„çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰Mçš„Pæš‚æ—¶æ”¾åœ¨nextpä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹ç›´æ¥åœ¨nextpå»å–Pï¼ŒåŸå› åœ¨è¿™é‡Œå…³è”çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› ä¸º_p_åªåœ¨è¿™é‡Œå­˜åœ¨ï¼Œå› æ­¤ä¸ä¼šå­˜åœ¨å…¶ä»–å·¥ä½œçº¿ç¨‹ä½¿ç”¨è¯¥Pã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nmp</span><span class="p">.</span><span class="nx">nextp</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">    <span class="c1">// å”¤é†’å·¥ä½œçº¿ç¨‹ï¼Œå·¥ä½œçº¿ç¨‹ç¡çœ åœ¨ nmp.park ä¸Šé¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">notewakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">nmp</span><span class="p">.</span><span class="nx">park</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">    <span class="c1">// Ownership transfer of _p_ committed by wakeup. Preemption is now
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// safe.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å”¤é†’æäº¤çš„_p_çš„æ‰€æœ‰æƒè½¬ç§»ã€‚ æŠ¢å ç°åœ¨æ˜¯å®‰å…¨çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸acquiremå‡½æ•°å‘¼åº”ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦æœ‰æŠ¢å è¯·æ±‚å‘ç”Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">releasem</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="acquirem">acquirem()<a hidden class="anchor" aria-hidden="true" href="#acquirem">#</a></h4>
<ol>
<li><code>m</code>åŠ é”ç¦æ­¢æŠ¢å å½“å‰<code>m</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/runtime1.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">acquirem</span><span class="p">()</span> <span class="o">*</span><span class="nx">m</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">locks</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="releasem">releasem()<a hidden class="anchor" aria-hidden="true" href="#releasem">#</a></h4>
<ol>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/runtime1.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">releasem</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">locks</span><span class="o">--</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰Mæ²¡æœ‰é”ï¼Œå¹¶ä¸”Géœ€è¦è¢«æŠ¢å 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">locks</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">preempt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// restore the preemption request in case we&#39;ve cleared it in newstack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_g_</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">stackPreempt</span> <span class="c1">// è®¾ç½®æŠ¢å æ ‡å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="pidleget">pidleget()<a hidden class="anchor" aria-hidden="true" href="#pidleget">#</a></h4>
<ol>
<li>ä»<code>sched.pidle</code>ä¸­å°è¯•è·å–ä¸€ä¸ªç©ºé—²çš„<code>P</code>ã€‚</li>
<li>å‚æ•°<code>now int64</code>ï¼š0åˆ™å–å½“å‰æ—¶é—´ç‚¹ã€‚</li>
<li>è¿”å›å€¼ï¼š
<ul>
<li><code>*p</code>ï¼šè¿”å›ä¸€ä¸ªç©ºé—²çš„<code>P</code>ï¼Œå¦åˆ™ä¸º<code>nil</code>æ²¡æœ‰ç©ºé—²çš„<code>P</code>ã€‚</li>
<li><code>int64</code>ï¼šä¼ å…¥<code>now</code>çš„æ—¶é—´å€¼ï¼Œ0åˆ™æ˜¯å½“å‰æ—¶é—´å€¼ã€‚</li>
</ul>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5727
</span><span class="lnt">5728
</span><span class="lnt">5729
</span><span class="lnt">5730
</span><span class="lnt">5731
</span><span class="lnt">5732
</span><span class="lnt">5733
</span><span class="lnt">5734
</span><span class="lnt">5735
</span><span class="lnt">5736
</span><span class="lnt">5737
</span><span class="lnt">5738
</span><span class="lnt">5739
</span><span class="lnt">5740
</span><span class="lnt">5741
</span><span class="lnt">5742
</span><span class="lnt">5743
</span><span class="lnt">5744
</span><span class="lnt">5745
</span><span class="lnt">5746
</span><span class="lnt">5747
</span><span class="lnt">5748
</span><span class="lnt">5749
</span><span class="lnt">5750
</span><span class="lnt">5751
</span><span class="lnt">5752
</span><span class="lnt">5753
</span><span class="lnt">5754
</span><span class="lnt">5755
</span><span class="lnt">5756
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// pidleget tries to get a p from the _Pidle list, acquiring ownership.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// May run during STW, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">pidleget</span><span class="p">(</span><span class="nx">now</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// sched.lock å¿…é¡»è¢«æŒæœ‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»sched.pidleä¸Šè·å–ç©ºé—²çš„P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span> <span class="o">:=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">pidle</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_p_</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Timer may get added at any time now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">now</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">now</span> <span class="p">=</span> <span class="nf">nanotime</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è®¾ç½®timerpMaskå’ŒidlepMask
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">timerpMask</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">idlepMask</span><span class="p">.</span><span class="nb">clear</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä»å…¨å±€ç©ºé—²çš„Pä¸­ç§»é™¤_p_
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sched</span><span class="p">.</span><span class="nx">pidle</span> <span class="p">=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">link</span> 
</span></span><span class="line"><span class="cl">        <span class="c1">// å…¨å±€çš„ç©ºé—²Pçš„æ¬¡æ•°å‡ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">npidle</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// limiterEventè·Ÿè¸ªGC CPUé™åˆ¶å™¨çš„äº‹ä»¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_p_</span><span class="p">.</span><span class="nx">limiterEvent</span><span class="p">.</span><span class="nf">stop</span><span class="p">(</span><span class="nx">limiterEventIdle</span><span class="p">,</span> <span class="nx">now</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">_p_</span><span class="p">,</span> <span class="nx">now</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="mget">mget()<a hidden class="anchor" aria-hidden="true" href="#mget">#</a></h4>
<ol>
<li>å°è¯•ä»<code>sched.midle</code>è·å–ä¸€ä¸ªç©ºé—²çš„å·¥ä½œçº¿ç¨‹<code>m</code>ï¼Œèµ·æ¥ç»‘å®š<code>P</code>è¿è¡Œã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5547
</span><span class="lnt">5548
</span><span class="lnt">5549
</span><span class="lnt">5550
</span><span class="lnt">5551
</span><span class="lnt">5552
</span><span class="lnt">5553
</span><span class="lnt">5554
</span><span class="lnt">5555
</span><span class="lnt">5556
</span><span class="lnt">5557
</span><span class="lnt">5558
</span><span class="lnt">5559
</span><span class="lnt">5560
</span><span class="lnt">5561
</span><span class="lnt">5562
</span><span class="lnt">5563
</span><span class="lnt">5564
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Try to get an m from midle list.
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held.
</span></span></span><span class="line"><span class="cl"><span class="c1">// May run during STW, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mget</span><span class="p">()</span> <span class="o">*</span><span class="nx">m</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ç©ºé—²çš„måœ¨sched.midleä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mp</span> <span class="o">:=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">midle</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">mp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä»sched.midleä¸Šç§»é™¤mp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sched</span><span class="p">.</span><span class="nx">midle</span> <span class="p">=</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">schedlink</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ç©ºé—²çš„mæ•°é‡å‡ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sched</span><span class="p">.</span><span class="nx">nmidle</span><span class="o">--</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">mp</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="mreserveid">mReserveID()<a hidden class="anchor" aria-hidden="true" href="#mreserveid">#</a></h4>
<ol>
<li>ç»™æ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹åˆ†é…å”¯ä¸€çš„<code>ID</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">769
</span><span class="lnt">770
</span><span class="lnt">771
</span><span class="lnt">772
</span><span class="lnt">773
</span><span class="lnt">774
</span><span class="lnt">775
</span><span class="lnt">776
</span><span class="lnt">777
</span><span class="lnt">778
</span><span class="lnt">779
</span><span class="lnt">780
</span><span class="lnt">781
</span><span class="lnt">782
</span><span class="lnt">783
</span><span class="lnt">784
</span><span class="lnt">785
</span><span class="lnt">786
</span><span class="lnt">787
</span><span class="lnt">788
</span><span class="lnt">789
</span><span class="lnt">790
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// mReserveID returns the next ID to use for a new m. This new m is immediately
</span></span></span><span class="line"><span class="cl"><span class="c1">// considered &#39;running&#39; by checkdead.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mReserveID</span><span class="p">()</span> <span class="kt">int64</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// sched.locké”å¿…é¡»è¢«æŒæœ‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ†é…çš„IDæº¢å‡ºäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">mnext</span><span class="o">+</span><span class="mi">1</span> <span class="p">&lt;</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">mnext</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runtime: thread ID overflow&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">id</span> <span class="o">:=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">mnext</span> <span class="c1">// åˆ†é…çš„ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sched</span><span class="p">.</span><span class="nx">mnext</span><span class="o">++</span> <span class="c1">// ä¸‹ä¸€ä¸ªID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ£€æŸ¥sched.mnext - sched.nmfreed &gt; sched.maxmcount
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sched.maxmcount åœ¨ runtime.main ä¸­è¢«è®¾ç½®ä¸º 10000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sched.mnext ä¸‹ä¸€ä¸ªåˆ†é…çš„IDï¼Œè¯¥å€¼æ˜¯ç´¯åŠ çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sched.nmfreed å·²ç»é‡Šæ”¾çš„å·¥ä½œçº¿ç¨‹æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› æ­¤è¿™é‡Œæ˜¯æ£€æŸ¥å½“å‰å·²ç»åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹æ•°é‡ä¸èƒ½å¤§äºæœ€å¤§å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">checkmcount</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">id</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="notewakeup">notewakeup()<a hidden class="anchor" aria-hidden="true" href="#notewakeup">#</a></h3>
<ol>
<li>é¦–å…ˆä½¿ç”¨<code>atomic.Xchg</code>è®¾ç½®<code>note.key</code>å€¼ä¸º1ã€‚</li>
<li>è¿™æ˜¯ä¸ºäº†ä½¿è¢«å”¤é†’çš„çº¿ç¨‹å¯ä»¥é€šè¿‡æŸ¥çœ‹è¯¥å€¼æ˜¯å¦ç­‰äº1æ¥ç¡®å®šæ˜¯è¢«å…¶å®ƒçº¿ç¨‹å”¤é†’è¿˜æ˜¯æ„å¤–ä»ç¡çœ ä¸­è‹é†’äº†è¿‡æ¥ï¼Œ</li>
<li>å¦‚æœè¯¥å€¼ä¸º1åˆ™è¡¨ç¤ºæ˜¯è¢«å”¤é†’çš„ï¼Œå¯ä»¥ç»§ç»­å·¥ä½œäº†ã€‚</li>
<li>ä½†å¦‚æœè¯¥å€¼ä¸º0åˆ™è¡¨ç¤ºæ˜¯æ„å¤–è‹é†’ï¼Œéœ€è¦å†æ¬¡è¿›å…¥ç¡çœ ï¼Œ</li>
<li>å·¥ä½œçº¿ç¨‹è‹é†’ä¹‹åçš„å¤„ç†é€»è¾‘æˆ‘ä»¬å·²ç»åœ¨<code>notesleep</code>()å‡½æ•°ä¸­è§è¿‡ï¼Œæ‰€ä»¥è¿™é‡Œç•¥è¿‡ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/lock_futex.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">notewakeup</span><span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">note</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è®¾ç½®n.key = 1, è¢«å”¤é†’çš„çº¿ç¨‹é€šè¿‡æŸ¥çœ‹è¯¥å€¼æ˜¯å¦ç­‰äº1æ¥ç¡®å®šæ˜¯è¢«å…¶å®ƒçº¿ç¨‹å”¤é†’è¿˜æ˜¯æ„å¤–ä»ç¡çœ ä¸­è‹é†’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">old</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xchg</span><span class="p">(</span><span class="nf">key32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">n</span><span class="p">.</span><span class="nx">key</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">old</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>   <span class="c1">// å¦‚æœæ—§å€¼ä¸æ˜¯0è¯´æ˜ç³»ç»Ÿé€»è¾‘æœ‰é—®é¢˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;notewakeup - double wakeup (&#34;</span><span class="p">,</span> <span class="nx">old</span><span class="p">,</span> <span class="s">&#34;)\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;notewakeup - double wakeup&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">futexwakeup</span><span class="p">(</span><span class="nf">key32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">n</span><span class="p">.</span><span class="nx">key</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// è°ƒç”¨futexwakeupå”¤é†’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="futexwakeup">futexwakeup()<a hidden class="anchor" aria-hidden="true" href="#futexwakeup">#</a></h3>
<ol>
<li>å¯¹äº<code>Linux</code>å¹³å°æ¥è¯´ï¼Œå·¥ä½œçº¿ç¨‹é€šè¿‡<code>note</code>ç¡çœ å…¶å®æ˜¯é€šè¿‡<code>futex</code>ç³»ç»Ÿè°ƒç”¨ç¡çœ åœ¨å†…æ ¸ä¹‹ä¸­ï¼Œ</li>
<li>æ‰€ä»¥å”¤é†’å¤„äºç¡çœ çŠ¶æ€çš„çº¿ç¨‹ä¹Ÿéœ€è¦é€šè¿‡<code>futex</code>ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸æ¥å”¤é†’ã€‚</li>
<li>æ‰€ä»¥è¿™é‡Œçš„<code>futexwakeup()</code>åˆç»§ç»­è°ƒç”¨åŒ…è£…äº†<code>futex</code>ç³»ç»Ÿè°ƒç”¨çš„<code>futex()</code>å‡½æ•°æ¥å®ç°å”¤é†’ç¡çœ åœ¨å†…æ ¸ä¸­çš„å·¥ä½œçº¿ç¨‹ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/os_linux.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// If any procs are sleeping on addr, wake up at most cnt.
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">futexwakeup</span><span class="p">(</span><span class="nx">addr</span> <span class="o">*</span><span class="kt">uint32</span><span class="p">,</span> <span class="nx">cnt</span> <span class="kt">uint32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒç”¨futexå‡½æ•°å”¤é†’å·¥ä½œçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ret</span> <span class="o">:=</span> <span class="nf">futex</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">addr</span><span class="p">),</span> <span class="nx">_FUTEX_WAKE_PRIVATE</span><span class="p">,</span> <span class="nx">cnt</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">{</span>	<span class="c1">// è°ƒç”¨æˆåŠŸæ˜¯è¿™é‡Œç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// I don&#39;t know that futex wakeup can return
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// EAGAIN or EINTR, but if it does, it would be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// safe to loop and call futex again.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;futexwakeup addr=&#34;</span><span class="p">,</span> <span class="nx">addr</span><span class="p">,</span> <span class="s">&#34; returned &#34;</span><span class="p">,</span> <span class="nx">ret</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ç¨‹åºä¸ä¼šåˆ°è¿™é‡Œæ¥ï¼Œå³ä½¿åˆ°è¿™é‡Œæ¥äº†ï¼Œå‘ä¸€ä¸ªæœªçŸ¥åœ°å€å†™å…¥æ•°æ®ç›´æ¥å®•æœº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">int32</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nb">uintptr</span><span class="p">(</span><span class="mh">0x1006</span><span class="p">)))</span> <span class="p">=</span> <span class="mh">0x1006</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="futex">futex()<a hidden class="anchor" aria-hidden="true" href="#futex">#</a></h3>
<ol>
<li><code>futex()</code>å‡½æ•°ç”±æ±‡ç¼–ä»£ç å†™æˆï¼Œå‰é¢çš„å‡ æ¡æŒ‡ä»¤éƒ½åœ¨ä¸º<code>futex</code>ç³»ç»Ÿè°ƒç”¨å‡†å¤‡å‚æ•°ï¼Œ</li>
<li>å‚æ•°å‡†å¤‡å®Œæˆä¹‹ååˆ™é€šè¿‡<code>SYSCALL</code>æŒ‡ä»¤è¿›å…¥æ“ä½œç³»ç»Ÿå†…æ ¸å®Œæˆçº¿ç¨‹çš„å”¤é†’åŠŸèƒ½ã€‚</li>
<li>å†…æ ¸åœ¨å®Œæˆå”¤é†’å·¥ä½œä¹‹åå½“å‰å·¥ä½œçº¿ç¨‹åˆ™ä»å†…æ ¸è¿”å›åˆ°<code>futex()</code>å‡½æ•°ç»§ç»­æ‰§è¡Œ<code>SYSCALL</code>æŒ‡ä»¤ä¹‹åçš„ä»£ç å¹¶æŒ‰å‡½æ•°è°ƒç”¨é“¾åŸè·¯è¿”å›ã€‚</li>
<li>ç»§ç»­æ‰§è¡Œå…¶å®ƒä»£ç ï¼Œè€Œè¢«å”¤é†’çš„å·¥ä½œçº¿ç¨‹åˆ™ç”±å†…æ ¸è´Ÿè´£åœ¨é€‚å½“çš„æ—¶å€™è°ƒåº¦åˆ°<code>CPU</code>ä¸Šè¿è¡Œã€‚</li>
<li>é™·å…¥ç³»ç»Ÿè°ƒç”¨å¤ªé•¿æ—¶é—´çš„å·¥ä½œçº¿ç¨‹ä¼šåœ¨ç›‘æ§çº¿ç¨‹ä¸­å‰¥ç¦»<code>P</code>å’Œ<code>G</code>ï¼Œå…·ä½“çš„å‚çœ‹ç›‘æ§çº¿ç¨‹ç›¸å…³ä»£ç ã€‚è¿™é‡Œæ²¡æœ‰æ ‡è®°å·¥ä½œçº¿ç¨‹é™·å…¥ç³»ç»Ÿè°ƒç”¨çš„æ ‡å¿—ã€‚</li>
<li>åº”è¯¥æ˜¯å½“å‰å‡½æ•°è°ƒç”¨ä¸ä¼šå½¢æˆé˜»å¡ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/sys_linux_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1"># int64 futex(int32 *uaddr, int32 op, int32 val,
</span></span></span><span class="line"><span class="cl"><span class="c1">#   struct timespec *timeout, int32 *uaddr2, int32 val2);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">futex</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="p">,</span><span class="no">$0</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#è¿™6æ¡æŒ‡ä»¤åœ¨ä¸ºfutexç³»ç»Ÿè°ƒç”¨å‡†å¤‡å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">addr</span><span class="err">+</span><span class="mi">0</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">DI</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">op</span><span class="err">+</span><span class="mi">8</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">SI</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">val</span><span class="err">+</span><span class="mi">12</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">DX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">ts</span><span class="err">+</span><span class="mi">16</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">R10</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">addr2</span><span class="err">+</span><span class="mi">24</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">R8</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">val3</span><span class="err">+</span><span class="mi">32</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">R9</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">$SYS_futex</span><span class="p">,</span> <span class="no">AX</span>  <span class="c1"># futexç³»ç»Ÿè°ƒç”¨ç¼–å·æ”¾å…¥AXå¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">SYSCALL</span>                 <span class="c1"># ç³»ç»Ÿè°ƒç”¨ï¼Œè¿›å…¥å†…æ ¸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVL</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">ret</span><span class="err">+</span><span class="mi">40</span><span class="p">(</span><span class="no">FP</span><span class="p">)</span>  <span class="c1"># ç³»ç»Ÿè°ƒç”¨é€šè¿‡AXå¯„å­˜å™¨è¿”å›è¿”å›å€¼ï¼Œè¿™é‡ŒæŠŠè¿”å›å€¼ä¿å­˜åˆ°å†…å­˜ä¹‹ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="åˆ›å»ºå·¥ä½œçº¿ç¨‹">åˆ›å»ºå·¥ä½œçº¿ç¨‹<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºå·¥ä½œçº¿ç¨‹">#</a></h2>
<ol>
<li>å¦‚æœæ²¡æœ‰æ­£å¤„äºä¼‘çœ çŠ¶æ€çš„å·¥ä½œçº¿ç¨‹ï¼Œåˆ™éœ€è¦è°ƒç”¨<code>newm()</code>å‡½æ•°æ–°å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ã€‚</li>
</ol>
<h3 id="newm">newm()<a hidden class="anchor" aria-hidden="true" href="#newm">#</a></h3>
<ol>
<li>åˆ›å»ºè°ƒåº¦çº¿ç¨‹å’Œç›‘æ§çº¿ç¨‹éƒ½æ˜¯é€šè¿‡è¯¥å‡½æ•°ï¼Œæ‰§è¡Œè¯¥å‡½æ•°æ—¶éƒ½ä¼šæŠŠæ ˆåˆ‡æ¢åˆ°<code>g0</code>æ ˆï¼Œå› ä¸º<code>g0</code>æ ˆæ¯”è¾ƒå¤§ã€‚</li>
<li>è¯¥å‡½æ•°åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹ä½¿ç”¨ï¼š
<ol>
<li><strong>newm(sysmon, nil, -1)</strong>ï¼šåˆ›å»ºã€<strong>ç›‘æ§çº¿ç¨‹</strong>ã€‘ã€‚
<ul>
<li><code>sysmon</code>å·¥ä½œçº¿ç¨‹å¼€å§‹æ‰§è¡Œæ—¶é¦–å…ˆè°ƒç”¨çš„å‡½æ•°ã€‚ï¼ˆä¸æ˜¯å…¥å£å‡½æ•°ï¼Œ<code>newm()</code>åˆ›å»ºçš„å…¥å£å‡½æ•°éƒ½æ˜¯å›ºå®šçš„<code>mstart()</code>å‡½æ•°ï¼‰</li>
<li><code>nil</code>è¡¨ç¤ºä¸éœ€è¦ç»‘å®š<code>P</code>ã€‚</li>
<li><code>-1</code>ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªé€’å¢çš„æ•°å­—ã€‚ï¼ˆå…¨å±€å”¯ä¸€çš„<code>ID</code>ï¼‰</li>
</ul>
</li>
<li><strong>newm(fn, <code>_p_</code>, id)</strong>ï¼šåˆ›å»ºã€<strong>è°ƒåº¦çº¿ç¨‹</strong>ã€‘ã€‚
<ul>
<li><code>fn</code>å·¥ä½œçº¿ç¨‹å¼€å§‹æ‰§è¡Œæ—¶é¦–å…ˆè°ƒç”¨çš„å‡½æ•°ã€‚ï¼ˆä¸æ˜¯å…¥å£å‡½æ•°ï¼Œ<code>newm()</code>åˆ›å»ºçš„å…¥å£å‡½æ•°éƒ½æ˜¯å›ºå®šçš„<code>mstart()</code>å‡½æ•°ï¼‰</li>
<li><code>_p_</code>çº¿ç¨‹å¯åŠ¨æ—¶éœ€è¦ç»‘å®šçš„<code>P</code>ã€‚</li>
<li>åˆ›å»ºå·¥ä½œçº¿ç¨‹çš„å”¯ä¸€<code>ID</code>ã€‚</li>
</ul>
</li>
</ol>
</li>
<li>åˆ›å»ºä¸€ä¸ªæ–°çš„<code>m</code>ã€‚å®ƒå°†ä»å¯¹<strong>fn</strong>æˆ–<strong>è°ƒåº¦å™¨çš„è°ƒç”¨</strong>å¼€å§‹ã€‚fnéœ€è¦æ˜¯é™æ€çš„ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå †åˆ†é…é—­åŒ…ã€‚å¯ä»¥ä½¿ç”¨ <code>m.p==nil</code>è¿è¡Œï¼Œå› æ­¤ä¸å…è®¸å†™å…¥éšœç¢ã€‚</li>
<li><code>id</code>æ˜¯å¯é€‰çš„ï¼Œé¢„åˆ†é…çš„<code>M</code>çš„<code>id</code>ã€‚é€šè¿‡ä¼ é€’<code>-1</code>æ¥çœç•¥ã€‚</li>
<li><code>go:nowritebarrierrec</code>ï¼šå‘Šè¯‰ç¼–è¯‘å™¨è¯¥å‡½æ•°åŠé‡Œé¢æ‰€è°ƒç”¨çš„å‡½æ•°éƒ½ä¸æ’å…¥å†™å±éšœä»£ç ã€‚</li>
<li>å‚æ•°ï¼š
<ol>
<li><strong><code>fn func()</code></strong>ï¼šæ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹å¯åŠ¨åéœ€è¦æ‰§è¡Œçš„å‡½æ•°ï¼Œä¸èƒ½æ˜¯ä¸€ä¸ªå †åˆ†é…çš„é—­åŒ…ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªé™æ€çš„å‡½æ•°ã€‚
<ul>
<li>ä¹Ÿå°±æ˜¯æ‰€æœ‰åˆ›å»ºçš„çº¿ç¨‹å…¥å£å‡½æ•°éƒ½æ˜¯mstart()å‡½æ•°æ˜¯çº¿ç¨‹çš„å…¥å£å‡½æ•°æ•°ï¼Œå‚çœ‹<code>newosproc()</code>å‡½æ•°ã€‚</li>
</ul>
</li>
<li><strong><code>_p_ *p</code></strong>ï¼šæ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹éœ€è¦ç»‘å®šçš„<code>P</code>ï¼Œè¯¥å€¼å¯ä»¥ä¸º <code>nil</code>ï¼Œè¡¨ç¤ºä¸ç»‘å®š<code>P</code>ã€‚</li>
<li><strong><code>id int64</code></strong>ï¼šæ–°åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹çš„<code>ID</code>å€¼ï¼Œè¯¥å€¼å¯ä»¥æ˜¯<code>-1</code>ï¼Œè¡¨ç¤ºç³»ç»Ÿè‡ªåŠ¨åˆ†é…ä¸€ä¸ªé€’å¢çš„<code>ID</code>æ•°å€¼ã€‚</li>
</ol>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2089
</span><span class="lnt">2090
</span><span class="lnt">2091
</span><span class="lnt">2092
</span><span class="lnt">2093
</span><span class="lnt">2094
</span><span class="lnt">2095
</span><span class="lnt">2096
</span><span class="lnt">2097
</span><span class="lnt">2098
</span><span class="lnt">2099
</span><span class="lnt">2100
</span><span class="lnt">2101
</span><span class="lnt">2102
</span><span class="lnt">2103
</span><span class="lnt">2104
</span><span class="lnt">2105
</span><span class="lnt">2106
</span><span class="lnt">2107
</span><span class="lnt">2108
</span><span class="lnt">2109
</span><span class="lnt">2110
</span><span class="lnt">2111
</span><span class="lnt">2112
</span><span class="lnt">2113
</span><span class="lnt">2114
</span><span class="lnt">2115
</span><span class="lnt">2116
</span><span class="lnt">2117
</span><span class="lnt">2118
</span><span class="lnt">2119
</span><span class="lnt">2120
</span><span class="lnt">2121
</span><span class="lnt">2122
</span><span class="lnt">2123
</span><span class="lnt">2124
</span><span class="lnt">2125
</span><span class="lnt">2126
</span><span class="lnt">2127
</span><span class="lnt">2128
</span><span class="lnt">2129
</span><span class="lnt">2130
</span><span class="lnt">2131
</span><span class="lnt">2132
</span><span class="lnt">2133
</span><span class="lnt">2134
</span><span class="lnt">2135
</span><span class="lnt">2136
</span><span class="lnt">2137
</span><span class="lnt">2138
</span><span class="lnt">2139
</span><span class="lnt">2140
</span><span class="lnt">2141
</span><span class="lnt">2142
</span><span class="lnt">2143
</span><span class="lnt">2144
</span><span class="lnt">2145
</span><span class="lnt">2146
</span><span class="lnt">2147
</span><span class="lnt">2148
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Create a new m. It will start off with a call to fn, or else the scheduler.
</span></span></span><span class="line"><span class="cl"><span class="c1">// fn needs to be static and not a heap allocated closure.
</span></span></span><span class="line"><span class="cl"><span class="c1">// May run with m.p==nil, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// id is optional pre-allocated m ID. Omit by passing -1.
</span></span></span><span class="line"><span class="cl"><span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newm</span><span class="p">(</span><span class="nx">fn</span> <span class="kd">func</span><span class="p">(),</span> <span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// allocm adds a new M to allm, but they do not start until created by
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the OS in newm1 or the template thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// doAllThreadsSyscall requires that every M in allm will eventually
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// start and be signal-able, even with a STW.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Disable preemption here until we start the thread to ensure that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// newm is not preempted between allocm and starting the new thread,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ensuring that anything added to allm is guaranteed to eventually
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// start.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// allocmå°†ä¸€ä¸ªæ–°çš„Mæ·»åŠ åˆ°allmä¸­ï¼Œä½†æ˜¯ç›´åˆ°æ“ä½œç³»ç»Ÿåœ¨newm1æˆ–æ¨¡æ¿çº¿ç¨‹ä¸­åˆ›å»ºå®ƒä»¬æ‰å¼€å§‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// doAllThreadsSyscall è¦æ±‚allmä¸­çš„æ¯ä¸ªMæœ€ç»ˆéƒ½å°†å¯åŠ¨å¹¶å¯å‘é€ä¿¡å·ï¼Œå³ä½¿æ˜¯STWã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨è¿™é‡Œç¦ç”¨æŠ¢å ï¼Œç›´åˆ°æˆ‘ä»¬å¯åŠ¨çº¿ç¨‹ï¼Œä»¥ç¡®ä¿newmåœ¨allocmå’Œå¯åŠ¨æ–°çº¿ç¨‹ä¹‹é—´ä¸è¢«æŠ¢å ï¼Œç¡®ä¿æ·»åŠ åˆ°allmçš„ä»»ä½•å†…å®¹æœ€ç»ˆéƒ½èƒ½å¯åŠ¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">acquirem</span><span class="p">()</span>	<span class="c1">// ç¦æ­¢å½“å‰å·¥ä½œçº¿ç¨‹è¢«æŠ¢å 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// allocmä»å †ä¸Šåˆ†é…ä¸€ä¸ªmç»“æ„ä½“ï¼Œå¹¶ç»‘å®šMä¸å…¶ä»–ç›¸å…³ä¾‹å¦‚allpç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">allocm</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">nextp</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>	<span class="c1">// è®¾ç½®å½“å‰Méœ€è¦ç”¨åˆ°çš„P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mp</span><span class="p">.</span><span class="nx">sigmask</span> <span class="p">=</span> <span class="nx">initSigmask</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">();</span> <span class="nx">gp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">lockedExt</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">incgo</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">GOOS</span> <span class="o">!=</span> <span class="s">&#34;plan9&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// We&#39;re on a locked M or a thread that may have been
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// started by C. The kernel state of this thread may
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// be strange (the user may have locked it for that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// purpose). We don&#39;t want to clone that into another
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// thread. Instead, ask a known-good thread to create
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// the thread for us.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// This is disabled on Plan 9. See golang.org/issue/22227.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// TODO: This may be unnecessary on Windows, which
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// doesn&#39;t model thread creation off fork.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">newmHandoff</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">newmHandoff</span><span class="p">.</span><span class="nx">haveTemplateThread</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;on a locked thread with no template thread&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mp</span><span class="p">.</span><span class="nx">schedlink</span> <span class="p">=</span> <span class="nx">newmHandoff</span><span class="p">.</span><span class="nx">newm</span>
</span></span><span class="line"><span class="cl">        <span class="nx">newmHandoff</span><span class="p">.</span><span class="nx">newm</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">newmHandoff</span><span class="p">.</span><span class="nx">waiting</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">newmHandoff</span><span class="p">.</span><span class="nx">waiting</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">            <span class="nf">notewakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">newmHandoff</span><span class="p">.</span><span class="nx">wake</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">newmHandoff</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// The M has not started yet, but the template thread does not
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// participate in STW, so it will always process queued Ms and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// it is safe to releasem.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">releasem</span><span class="p">(</span><span class="nf">getg</span><span class="p">().</span><span class="nx">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">newm1</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">releasem</span><span class="p">(</span><span class="nf">getg</span><span class="p">().</span><span class="nx">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="acquirem-1">acquirem()<a hidden class="anchor" aria-hidden="true" href="#acquirem-1">#</a></h4>
<ol>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/runtime1.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">acquirem</span><span class="p">()</span> <span class="o">*</span><span class="nx">m</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">locks</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="allocm">allocm()<a hidden class="anchor" aria-hidden="true" href="#allocm">#</a></h3>
<ol>
<li>åˆ†é…ä¸€ä¸ªä¸ä¸ä»»ä½•çº¿ç¨‹å…³è”çš„æ–°<code>m</code>ã€‚å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä½¿ç”¨<code>p</code>ä½œä¸ºåˆ†é…ä¸Šä¸‹æ–‡ã€‚</li>
<li><code>fn</code>è¢«è®°å½•ä¸ºæ–°<code>m</code>çš„<code>m.mstartfn</code>ã€‚<code>id</code>æ˜¯å¯é€‰çš„ï¼Œé¢„åˆ†é…çš„<code>m</code>çš„<code>id</code>ã€‚é€šè¿‡ä¼ é€’-1æ¥çœç•¥ã€‚</li>
<li>è¿™ä¸ªå‡½æ•°å…è®¸æœ‰å†™éšœç¢ï¼Œå³ä½¿è°ƒç”¨è€…æ²¡æœ‰ï¼Œå› ä¸ºå®ƒå€Ÿç”¨äº†<code>_p_</code>ã€‚</li>
<li><code>go:yeswritebarrierrec</code>ï¼šå…è®¸ç¼–è¯‘å™¨æ’å…¥å†™å±éšœç›¸å…³ä»£ç ï¼Œå› ä¸ºè°ƒç”¨è€…ä½¿ç”¨çš„æ˜¯<code>go:nowritebarrierrec</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1706
</span><span class="lnt">1707
</span><span class="lnt">1708
</span><span class="lnt">1709
</span><span class="lnt">1710
</span><span class="lnt">1711
</span><span class="lnt">1712
</span><span class="lnt">1713
</span><span class="lnt">1714
</span><span class="lnt">1715
</span><span class="lnt">1716
</span><span class="lnt">1717
</span><span class="lnt">1718
</span><span class="lnt">1719
</span><span class="lnt">1720
</span><span class="lnt">1721
</span><span class="lnt">1722
</span><span class="lnt">1723
</span><span class="lnt">1724
</span><span class="lnt">1725
</span><span class="lnt">1726
</span><span class="lnt">1727
</span><span class="lnt">1728
</span><span class="lnt">1729
</span><span class="lnt">1730
</span><span class="lnt">1731
</span><span class="lnt">1732
</span><span class="lnt">1733
</span><span class="lnt">1734
</span><span class="lnt">1735
</span><span class="lnt">1736
</span><span class="lnt">1737
</span><span class="lnt">1738
</span><span class="lnt">1739
</span><span class="lnt">1740
</span><span class="lnt">1741
</span><span class="lnt">1742
</span><span class="lnt">1743
</span><span class="lnt">1744
</span><span class="lnt">1745
</span><span class="lnt">1746
</span><span class="lnt">1747
</span><span class="lnt">1748
</span><span class="lnt">1749
</span><span class="lnt">1750
</span><span class="lnt">1751
</span><span class="lnt">1752
</span><span class="lnt">1753
</span><span class="lnt">1754
</span><span class="lnt">1755
</span><span class="lnt">1756
</span><span class="lnt">1757
</span><span class="lnt">1758
</span><span class="lnt">1759
</span><span class="lnt">1760
</span><span class="lnt">1761
</span><span class="lnt">1762
</span><span class="lnt">1763
</span><span class="lnt">1764
</span><span class="lnt">1765
</span><span class="lnt">1766
</span><span class="lnt">1767
</span><span class="lnt">1768
</span><span class="lnt">1769
</span><span class="lnt">1770
</span><span class="lnt">1771
</span><span class="lnt">1772
</span><span class="lnt">1773
</span><span class="lnt">1774
</span><span class="lnt">1775
</span><span class="lnt">1776
</span><span class="lnt">1777
</span><span class="lnt">1778
</span><span class="lnt">1779
</span><span class="lnt">1780
</span><span class="lnt">1781
</span><span class="lnt">1782
</span><span class="lnt">1783
</span><span class="lnt">1784
</span><span class="lnt">1785
</span><span class="lnt">1786
</span><span class="lnt">1787
</span><span class="lnt">1788
</span><span class="lnt">1789
</span><span class="lnt">1790
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Allocate a new m unassociated with any thread.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Can use p for allocation context if needed.
</span></span></span><span class="line"><span class="cl"><span class="c1">// fn is recorded as the new m&#39;s m.mstartfn.
</span></span></span><span class="line"><span class="cl"><span class="c1">// id is optional pre-allocated m ID. Omit by passing -1.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// This function is allowed to have write barriers even if the caller
</span></span></span><span class="line"><span class="cl"><span class="c1">// isn&#39;t because it borrows _p_.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:yeswritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">allocm</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">fn</span> <span class="kd">func</span><span class="p">(),</span> <span class="nx">id</span> <span class="kt">int64</span><span class="p">)</span> <span class="o">*</span><span class="nx">m</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">allocmLock</span><span class="p">.</span><span class="nf">rlock</span><span class="p">()</span>  <span class="c1">// è¯»åŠ é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The caller owns _p_, but we may borrow (i.e., acquirep) it. We must
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// disable preemption to ensure it is not stolen, which would make the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// caller lose ownership.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">acquirem</span><span class="p">()</span>          <span class="c1">// ç¦æ­¢å½“å‰Mè¢«æŠ¢å 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>       <span class="c1">// å½“å‰g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ³¨æ„è¿™é‡Œæ˜¯æ­£åœ¨æ‰§è¡Œçš„å·¥ä½œçº¿ç¨‹,åœ¨æ­¤å‡½æ•°ä¸­ä¸º malloc ä¸´æ—¶å€Ÿç”¨ p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>   <span class="c1">// å¦‚æœå½“å‰Mæ²¡æœ‰ç»‘å®šPï¼Œåˆ™å»ç»‘å®šä¸€ä¸ªP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åœ¨è¿™ä¸ªå‡½æ•°ä¸­æš‚æ—¶å€Ÿç”¨pæ¥ä»£æ›¿mallocs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å½“å‰è¿™ä¸ªå·¥ä½œçº¿ç¨‹æ²¡æœ‰ç»‘å®špéœ€è¦ä¸´æ—¶å€Ÿç”¨è¿™ä¸ª_p_ï¼Œè¿™ç§æƒ…å†µå¯èƒ½æ˜¯sysmonçº¿ç¨‹ä¸­æ¥çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>   <span class="c1">// temporarily borrow p for mallocs in this function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Release the free M list. We need to do this somewhere and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// this may free up a stack we can use.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sched.freem å­˜å‚¨çš„æ˜¯ç­‰å¾…é‡Šæ”¾çš„mçš„é“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">freem</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> <span class="c1">// é‡Šæ”¾éœ€è¦é‡Šæ”¾çš„Måˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">newList</span> <span class="o">*</span><span class="nx">m</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// freem æ˜¯ä¸€ç»„å·²ç»è¿è¡Œç»“æŸçš„Mæ„æˆçš„é“¾è¡¨ï¼ˆä¸æ˜¯ç©ºé—²çš„ï¼‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="nx">freem</span> <span class="o">:=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">freem</span><span class="p">;</span> <span class="nx">freem</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// freeWait é‡Šæ”¾g0å’Œåˆ é™¤mæ˜¯å¦å®‰å…¨(freeMRef, freeMStack, freeMWaitä¸­çš„ä¸€ä¸ª)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">freem</span><span class="p">.</span><span class="nx">freeWait</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">next</span> <span class="o">:=</span> <span class="nx">freem</span><span class="p">.</span><span class="nx">freelink</span>
</span></span><span class="line"><span class="cl">                <span class="nx">freem</span><span class="p">.</span><span class="nx">freelink</span> <span class="p">=</span> <span class="nx">newList</span>
</span></span><span class="line"><span class="cl">                <span class="nx">newList</span> <span class="p">=</span> <span class="nx">freem</span>
</span></span><span class="line"><span class="cl">                <span class="nx">freem</span> <span class="p">=</span> <span class="nx">next</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// stackfree must be on the system stack, but allocm is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// reachable off the system stack transitively from
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// startm.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// stackfree å¿…é¡»åœ¨ç³»ç»Ÿæ ˆä¸Šï¼Œä½†allocmä»startmå¼€å§‹åœ¨ç³»ç»Ÿæ ˆä¹‹å¤–æ˜¯å¯è®¿é—®çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">stackfree</span><span class="p">(</span><span class="nx">freem</span><span class="p">.</span><span class="nx">g0</span><span class="p">.</span><span class="nx">stack</span><span class="p">)</span> <span class="c1">// é‡Šæ”¾æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">})</span>
</span></span><span class="line"><span class="cl">            <span class="nx">freem</span> <span class="p">=</span> <span class="nx">freem</span><span class="p">.</span><span class="nx">freelink</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sched</span><span class="p">.</span><span class="nx">freem</span> <span class="p">=</span> <span class="nx">newList</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å †åˆ†é…ä¸€ä¸ªm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mp</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span>		
</span></span><span class="line"><span class="cl">    <span class="c1">// Må¼€å§‹å‰éœ€è¦æ‰§è¡Œçš„å‡½æ•°ï¼Œä¸æ˜¯Mçš„å…¥å£å‡½æ•°ï¼Œæ˜¯æ‰§è¡Œmstartåä¼šè°ƒç”¨çš„å‡½æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. å¦‚æœæ˜¯è°ƒåº¦çº¿ä¸‹è¿™é‡Œå­˜å‚¨çš„æ˜¯mspinning()å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. å¦‚æœæ˜¯ç›‘æ§çº¿ç¨‹å­˜å‚¨çš„æ˜¯sysmon()å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mp</span><span class="p">.</span><span class="nx">mstartfn</span> <span class="p">=</span> <span class="nx">fn</span>	
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆå§‹åŒ–Mï¼Œä¸»è¦æ˜¯æŠŠmåŠ å…¥åˆ°allmä¸­ï¼Œmè®°å½•allmåœ°å€ç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¯¥å‡½æ•°åœ¨ç¨‹åºåˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¹Ÿè¢«è°ƒç”¨è¿‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">mcommoninit</span><span class="p">(</span><span class="nx">mp</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>	 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// In case of cgo or Solaris or illumos or Darwin, pthread_create will make us a stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Windows and Plan 9 will layout sched stack on OS stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">iscgo</span> <span class="o">||</span> <span class="nf">mStackIsSystemAllocated</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mp</span><span class="p">.</span><span class="nx">g0</span> <span class="p">=</span> <span class="nf">malg</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// runtime çš„g0æ ˆåˆ†é…çš„æ˜¯64kbå·¦å³å¤§å°ï¼Œå…¶ä»–çš„g0æ ˆåˆ†é…çš„æ˜¯8kbå·¦å³å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å…³äºmalgå‡½æ•°ï¼Œæ˜¯æ¥è‡ªæ ˆç›¸å…³
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">mp</span><span class="p">.</span><span class="nx">g0</span> <span class="p">=</span> <span class="nf">malg</span><span class="p">(</span><span class="mi">8192</span> <span class="o">*</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">StackGuardMultiplier</span><span class="p">)</span>   <span class="c1">// åˆ†é…ä¸€ä¸ªå¤§æ¦‚8Kbå·¦å³çš„g0ä½œä¸ºç³»ç»Ÿæ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">g0</span><span class="p">.</span><span class="nx">m</span> <span class="p">=</span> <span class="nx">mp</span>	<span class="c1">// g0ä¸må…³è”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_p_</span> <span class="o">==</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span> <span class="p">{</span>   <span class="c1">// å¦‚æœå‰é¢ä¸´æ—¶å€Ÿç”¨äº†Pï¼Œè¿™é‡Œéœ€è¦è¿˜å‡ºæ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">releasep</span><span class="p">()</span>              <span class="c1">// è§£ç»‘å½“å‰å·¥ä½œçº¿ç¨‹Må’ŒPçš„å…³è”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">releasem</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span>             <span class="c1">// åˆ¤æ–­å½“å‰gæ˜¯å¦éœ€è¦è¢«æŠ¢å ï¼Œè®¾ç½®æŠ¢å æ ‡å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">allocmLock</span><span class="p">.</span><span class="nf">runlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">mp</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="acquirep">acquirep()<a hidden class="anchor" aria-hidden="true" href="#acquirep">#</a></h4>
<ol>
<li>æŠŠ<code>p</code>å’Œå½“å‰<code>m</code>è”ç³»èµ·æ¥ã€‚</li>
<li>è¿™ä¸ªå‡½æ•°å…è®¸æœ‰å†™éšœç¢ï¼Œå³ä½¿è°ƒç”¨è€…æ²¡æœ‰ï¼Œå› ä¸ºå®ƒç«‹å³è·å¾—<code>_p_</code>ã€‚</li>
<li><code>go:yeswritebarrierrec</code>ï¼šå…è®¸ç¼–è¯‘å™¨æ’å…¥å†™å±éšœç›¸å…³ä»£ç ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">4938
</span><span class="lnt">4939
</span><span class="lnt">4940
</span><span class="lnt">4941
</span><span class="lnt">4942
</span><span class="lnt">4943
</span><span class="lnt">4944
</span><span class="lnt">4945
</span><span class="lnt">4946
</span><span class="lnt">4947
</span><span class="lnt">4948
</span><span class="lnt">4949
</span><span class="lnt">4950
</span><span class="lnt">4951
</span><span class="lnt">4952
</span><span class="lnt">4953
</span><span class="lnt">4954
</span><span class="lnt">4955
</span><span class="lnt">4956
</span><span class="lnt">4957
</span><span class="lnt">4958
</span><span class="lnt">4959
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Associate p and the current m.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// This function is allowed to have write barriers even if the caller
</span></span></span><span class="line"><span class="cl"><span class="c1">// isn&#39;t because it immediately acquires _p_.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:yeswritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Do the part that isn&#39;t allowed to have write barriers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">wirep</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>	<span class="c1">// æŠŠ P ä¸ M ç»‘å®šèµ·æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Have p; write barriers now allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç°åœ¨æœ‰päº†ï¼›ç°åœ¨å…è®¸å†™å±éšœã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Perform deferred mcache flush before this P can allocate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// from a potentially stale mcache.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨æ­¤På¯ä»¥ä»å¯èƒ½ä¸æ–°é²œçš„mcacheåˆ†é…ä¹‹å‰ï¼Œæ‰§è¡Œå»¶è¿Ÿçš„mcacheåˆ·æ–°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">mcache</span><span class="p">.</span><span class="nf">prepareForSweep</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceProcStart</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>wirepæ˜¯acquirepçš„ç¬¬ä¸€æ­¥ï¼Œå®ƒå®é™…ä¸Šå°†å½“å‰Må…³è”åˆ°<code>_p_</code>ã€‚</li>
<li>å› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰Pï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨è¿™éƒ¨åˆ†ä¸å…è®¸å†™éšœç¢ã€‚</li>
<li><code>go:nowritebarrierrec</code>ï¼šä¸å…è®¸ç¼–è¯‘å™¨æ’å…¥å†™å±éšœç›¸å…³ä»£ç ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">4959
</span><span class="lnt">4960
</span><span class="lnt">4961
</span><span class="lnt">4962
</span><span class="lnt">4963
</span><span class="lnt">4964
</span><span class="lnt">4965
</span><span class="lnt">4966
</span><span class="lnt">4967
</span><span class="lnt">4968
</span><span class="lnt">4969
</span><span class="lnt">4970
</span><span class="lnt">4971
</span><span class="lnt">4972
</span><span class="lnt">4973
</span><span class="lnt">4974
</span><span class="lnt">4975
</span><span class="lnt">4976
</span><span class="lnt">4977
</span><span class="lnt">4978
</span><span class="lnt">4979
</span><span class="lnt">4980
</span><span class="lnt">4981
</span><span class="lnt">4982
</span><span class="lnt">4983
</span><span class="lnt">4984
</span><span class="lnt">4985
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// wirep is the first step of acquirep, which actually associates the
</span></span></span><span class="line"><span class="cl"><span class="c1">// current M to _p_. This is broken out so we can disallow write
</span></span></span><span class="line"><span class="cl"><span class="c1">// barriers for this part, since we don&#39;t yet have a P.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">wirep</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>   <span class="c1">// g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿™é‡Œæ¥çš„mä¸€å®šéœ€è¦æ˜¯æ²¡ç»‘å®špçš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;wirep: already in go&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰pä¹Ÿæ˜¯ä¸èƒ½ç»‘å®šmçš„ï¼Œå¹¶ä¸”å½“å‰pçš„çŠ¶æ€ä¸èƒ½æ˜¯ _Pidle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="nx">_Pidle</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">id</span> <span class="p">=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">id</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;wirep: p-&gt;m=&#34;</span><span class="p">,</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span> <span class="s">&#34;(&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&#34;) p-&gt;status=&#34;</span><span class="p">,</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;wirep: invalid p state&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// p ä¸ m ç›¸äº’ç»‘å®š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>        <span class="c1">// m.p = _p_
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span>        <span class="c1">// _p_.m = m
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span> <span class="p">=</span> <span class="nx">_Prunning</span>  <span class="c1">// è®¾ç½®pçš„çŠ¶æ€ä¸ºè¿è¡Œä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="mcommoninit">mcommoninit()<a hidden class="anchor" aria-hidden="true" href="#mcommoninit">#</a></h4>
<ol>
<li>é¢„åˆ†é…çš„<code>ID</code>å¯ä»¥ä½œä¸º<code>'ID'</code>ä¼ é€’ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¼ é€’<code>-1</code>æ¥çœç•¥ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">785
</span><span class="lnt">786
</span><span class="lnt">787
</span><span class="lnt">788
</span><span class="lnt">789
</span><span class="lnt">790
</span><span class="lnt">791
</span><span class="lnt">792
</span><span class="lnt">793
</span><span class="lnt">794
</span><span class="lnt">795
</span><span class="lnt">796
</span><span class="lnt">797
</span><span class="lnt">798
</span><span class="lnt">799
</span><span class="lnt">800
</span><span class="lnt">801
</span><span class="lnt">802
</span><span class="lnt">803
</span><span class="lnt">804
</span><span class="lnt">805
</span><span class="lnt">806
</span><span class="lnt">807
</span><span class="lnt">808
</span><span class="lnt">809
</span><span class="lnt">810
</span><span class="lnt">811
</span><span class="lnt">812
</span><span class="lnt">813
</span><span class="lnt">814
</span><span class="lnt">815
</span><span class="lnt">816
</span><span class="lnt">817
</span><span class="lnt">818
</span><span class="lnt">819
</span><span class="lnt">820
</span><span class="lnt">821
</span><span class="lnt">822
</span><span class="lnt">823
</span><span class="lnt">824
</span><span class="lnt">825
</span><span class="lnt">826
</span><span class="lnt">827
</span><span class="lnt">828
</span><span class="lnt">829
</span><span class="lnt">830
</span><span class="lnt">831
</span><span class="lnt">832
</span><span class="lnt">833
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Pre-allocated ID may be passed as &#39;id&#39;, or omitted by passing -1.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mcommoninit</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>           <span class="c1">// g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// g0 stack won&#39;t make sense for user (and is not necessary unwindable).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span> <span class="o">!=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">g0</span> <span class="p">{</span>    <span class="c1">// ä¸èƒ½æ˜¯g0æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">callers</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">createstack</span><span class="p">[:])</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">id</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mp</span><span class="p">.</span><span class="nx">id</span> <span class="p">=</span> <span class="nx">id</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mp</span><span class="p">.</span><span class="nx">id</span> <span class="p">=</span> <span class="nf">mReserveID</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">lo</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="nf">int64Hash</span><span class="p">(</span><span class="nb">uint64</span><span class="p">(</span><span class="nx">mp</span><span class="p">.</span><span class="nx">id</span><span class="p">),</span> <span class="nx">fastrandseed</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">hi</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="nf">int64Hash</span><span class="p">(</span><span class="nb">uint64</span><span class="p">(</span><span class="nf">cputicks</span><span class="p">()),</span> <span class="p">^</span><span class="nx">fastrandseed</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">lo</span><span class="p">|</span><span class="nx">hi</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">hi</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Same behavior as for 1.17.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// TODO: Simplify ths.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">goarch</span><span class="p">.</span><span class="nx">BigEndian</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mp</span><span class="p">.</span><span class="nx">fastrand</span> <span class="p">=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">lo</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">32</span> <span class="p">|</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">hi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mp</span><span class="p">.</span><span class="nx">fastrand</span> <span class="p">=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">hi</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">32</span> <span class="p">|</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">lo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">mpreinit</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>            <span class="c1">// ä¿¡å·ç›¸å…³
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">gsignal</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mp</span><span class="p">.</span><span class="nx">gsignal</span><span class="p">.</span><span class="nx">stackguard1</span> <span class="p">=</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">gsignal</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">+</span> <span class="nx">_StackGuard</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Add to allm so garbage collector doesn&#39;t free g-&gt;m
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// when it is just in a register or thread-local storage.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mp</span><span class="p">.</span><span class="nx">alllink</span> <span class="p">=</span> <span class="nx">allm</span>       <span class="c1">// è®°å½•å½“å‰m.alllinkçš„å…¨å±€allmåœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// NumCgoCall() iterates over allm w/o schedlock,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// so we need to publish it safely.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">atomicstorep</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">allm</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">mp</span><span class="p">))</span>	<span class="c1">// æŠŠmæ·»åŠ åˆ°å…¨å±€allmä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Allocate memory to hold a cgo traceback if the cgo call crashes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">iscgo</span> <span class="o">||</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;solaris&#34;</span> <span class="o">||</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;illumos&#34;</span> <span class="o">||</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;windows&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mp</span><span class="p">.</span><span class="nx">cgoCallers</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">cgoCallers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="newm1">newm1()<a hidden class="anchor" aria-hidden="true" href="#newm1">#</a></h3>
<ol>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2145
</span><span class="lnt">2146
</span><span class="lnt">2147
</span><span class="lnt">2148
</span><span class="lnt">2149
</span><span class="lnt">2150
</span><span class="lnt">2151
</span><span class="lnt">2152
</span><span class="lnt">2153
</span><span class="lnt">2154
</span><span class="lnt">2155
</span><span class="lnt">2156
</span><span class="lnt">2157
</span><span class="lnt">2158
</span><span class="lnt">2159
</span><span class="lnt">2160
</span><span class="lnt">2161
</span><span class="lnt">2162
</span><span class="lnt">2163
</span><span class="lnt">2164
</span><span class="lnt">2165
</span><span class="lnt">2166
</span><span class="lnt">2167
</span><span class="lnt">2168
</span><span class="lnt">2169
</span><span class="lnt">2170
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newm1</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">iscgo</span> <span class="p">{</span>  <span class="c1">// cgoç›¸å…³ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">var</span> <span class="nx">ts</span> <span class="nx">cgothreadstart</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">_cgo_thread_start</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;_cgo_thread_start missing&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ts</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">mp</span><span class="p">.</span><span class="nx">g0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ts</span><span class="p">.</span><span class="nx">tls</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="kt">uint64</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mp</span><span class="p">.</span><span class="nx">tls</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ts</span><span class="p">.</span><span class="nx">fn</span> <span class="p">=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABI0</span><span class="p">(</span><span class="nx">mstart</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">msanenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">msanwrite</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ts</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">ts</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">asanenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">asanwrite</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ts</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">ts</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">execLock</span><span class="p">.</span><span class="nf">rlock</span><span class="p">()</span> <span class="c1">// Prevent process clone.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">asmcgocall</span><span class="p">(</span><span class="nx">_cgo_thread_start</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ts</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">execLock</span><span class="p">.</span><span class="nf">runlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">execLock</span><span class="p">.</span><span class="nf">rlock</span><span class="p">()</span> <span class="c1">// Prevent process clone.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// newosprocå‡½æ•° è°ƒç”¨cloneå‡½æ•°åˆ›å»ºä¸€ä¸ªç³»ç»Ÿçº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ–°å»ºçš„è¿™ä¸ªç³»ç»Ÿçº¿ç¨‹å°†ä»mstart()å‡½æ•°å¼€å§‹è¿è¡Œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">newosproc</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">execLock</span><span class="p">.</span><span class="nf">runlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="newosproc">newosproc()<a hidden class="anchor" aria-hidden="true" href="#newosproc">#</a></h3>
<ol>
<li>å¯ä»¥<code>m.p==nil</code> è¿è¡Œï¼Œå› æ­¤ä¸å…è®¸å†™å±éšœã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/os_linux.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// May run with m.p==nil, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrier
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newosproc</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">stk</span> <span class="o">:=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">mp</span><span class="p">.</span><span class="nx">g0</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span><span class="p">)</span>   <span class="c1">// è·å–å½“å‰æ–°åˆ›å»ºçš„Mçš„g0æ ˆæ ˆé¡¶ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * note: strace gets confused if we use CLONE_PTRACE here.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="kc">false</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;newosproc stk=&#34;</span><span class="p">,</span> <span class="nx">stk</span><span class="p">,</span> <span class="s">&#34; m=&#34;</span><span class="p">,</span> <span class="nx">mp</span><span class="p">,</span> <span class="s">&#34; g=&#34;</span><span class="p">,</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">g0</span><span class="p">,</span> <span class="s">&#34; clone=&#34;</span><span class="p">,</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABI0</span><span class="p">(</span><span class="nx">clone</span><span class="p">),</span> <span class="s">&#34; id=&#34;</span><span class="p">,</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s">&#34; ostk=&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">mp</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Disable signals during clone, so that the new thread starts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// with signals disabled. It will enable them in minit.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨å…‹éš†æœŸé—´ç¦ç”¨ä¿¡å·ï¼Œä»¥ä¾¿æ–°çº¿ç¨‹ä»¥ç¦ç”¨ä¿¡å·å¼€å§‹ã€‚ å®ƒå°†åœ¨minitä¸­å¯ç”¨å®ƒä»¬ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">oset</span> <span class="nx">sigset</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sigprocmask</span><span class="p">(</span><span class="nx">_SIG_SETMASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">sigset_all</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">oset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//  cloneFlags = _CLONE_VM | /* share memory */ // æŒ‡å®šçˆ¶å­çº¿ç¨‹å…±äº«è¿›ç¨‹åœ°å€ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      _CLONE_FS | /* share cwd, etc */
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      _CLONE_FILES | /* share fd table */
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      _CLONE_SIGHAND | /* share sig handler table */
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      _CLONE_SYSVSEM | /* share SysV semaphore undo lists (see issue #20763) */
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      _CLONE_THREAD /* revisit - okay for now */  // åˆ›å»ºå­çº¿ç¨‹è€Œä¸æ˜¯å­è¿›ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç¨‹åºçš„å…¥å£éƒ½æ˜¯ã€mstart()ã€‘å‡½æ•°å¼€å§‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ret</span> <span class="o">:=</span> <span class="nf">clone</span><span class="p">(</span><span class="nx">cloneFlags</span><span class="p">,</span> <span class="nx">stk</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">mp</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">mp</span><span class="p">.</span><span class="nx">g0</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABI0</span><span class="p">(</span><span class="nx">mstart</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sigprocmask</span><span class="p">(</span><span class="nx">_SIG_SETMASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">oset</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ€ä¹ˆä¹Ÿåº”è¯¥å‡ºç° ret å°äº0çš„æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">ret</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;runtime: failed to create new OS thread (have &#34;</span><span class="p">,</span> <span class="nf">mcount</span><span class="p">(),</span> <span class="s">&#34; already; errno=&#34;</span><span class="p">,</span> <span class="o">-</span><span class="nx">ret</span><span class="p">,</span> <span class="s">&#34;)\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">ret</span> <span class="o">==</span> <span class="o">-</span><span class="nx">_EAGAIN</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">println</span><span class="p">(</span><span class="s">&#34;runtime: may need to increase max user processes (ulimit -u)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;newosproc&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="clone">clone()<a hidden class="anchor" aria-hidden="true" href="#clone">#</a></h3>
<p><code>C</code>å‡½æ•°åŸå‹ï¼š<code>int32 clone(int32 flags, void *stk, M *mp, G *gp, void (*fn)(void))</code></p>
<ol>
<li><code>int32 flags</code>ï¼šæŒ‡å®šå†…æ ¸åˆ›å»ºçº¿ç¨‹æ—¶éœ€è¦çš„é€‰é¡¹ã€‚</li>
<li><code>void *stk</code>ï¼šæ–°çº¿ç¨‹åº”è¯¥ä½¿ç”¨çš„æ ˆï¼š
<ol>
<li>å› ä¸ºå³å°†è¢«åˆ›å»ºçš„çº¿ç¨‹ä¸å½“å‰çº¿ç¨‹å…±äº«åŒä¸€ä¸ªè¿›ç¨‹åœ°å€ç©ºé—´ï¼Œæ‰€ä»¥è¿™é‡Œå¿…é¡»ä¸ºå­çº¿ç¨‹æŒ‡å®šå…¶ä½¿ç”¨çš„æ ˆï¼Œå¦åˆ™çˆ¶å­çº¿ç¨‹ä¼šå…±äº«åŒä¸€ä¸ªæ ˆä»è€Œé€ æˆæ··ä¹±ã€‚</li>
<li>ä»ä¸Šé¢çš„<code>newosproc()</code>å‡½æ•°å¯ä»¥çœ‹å‡ºï¼Œæ–°çº¿ç¨‹ä½¿ç”¨çš„æ ˆä¸º<code>m.g0.stack.loï½m.g0.stack.hi</code>è¿™æ®µå†…å­˜ï¼Œè€Œè¿™æ®µå†…å­˜æ˜¯<code>newm()</code>å‡½æ•°åœ¨åˆ›å»º<code>m</code>ç»“æ„ä½“å¯¹è±¡æ—¶ä»è¿›ç¨‹çš„å †ä¸Šåˆ†é…è€Œæ¥çš„ã€‚</li>
</ol>
</li>
<li><code>M *mp</code>ï¼šå·¥ä½œçº¿ç¨‹ <code>M</code> çš„ä¿¡æ¯è®°å½•ã€‚</li>
<li><code>G *gp</code>ï¼š<code>g0</code>æ ˆä¿¡æ¯è®°å½•ã€‚</li>
<li><code>void (*fn)(void)</code>ï¼šå­çº¿ç¨‹ç¨‹åºå…¥å£å‡½æ•°ã€‚</li>
<li>ä¸Šé¢ä¸‰ä¸ªå‚æ•°ï¼ˆ<code>M *mp</code>ã€<code>G *gp</code>ã€<code>void (*fn)(void)</code>ï¼‰ä¿å­˜åˆ°å¯„å­˜å™¨ï¼ˆ<code>R13</code>ã€<code>R9</code>ã€<code>R12</code>ï¼‰ä¸­ï¼š
<ol>
<li>ä¹‹æ‰€ä»¥éœ€è¦åœ¨ç³»ç»Ÿè°ƒç”¨ä¹‹å‰ä¿å­˜è¿™å‡ ä¸ªå‚æ•°ï¼ŒåŸå› åœ¨äºè¿™å‡ ä¸ªå‚æ•°ç›®å‰è¿˜ä½äºçˆ¶çº¿ç¨‹çš„æ ˆä¹‹ä¸­ã€‚</li>
<li>ä¸€æ—¦é€šè¿‡ç³»ç»Ÿè°ƒç”¨æŠŠå­çº¿ç¨‹åˆ›å»ºå‡ºæ¥ä¹‹åï¼Œå­çº¿ç¨‹å°†ä¼šä½¿ç”¨æˆ‘ä»¬åœ¨<code>clone</code>ç³»ç»Ÿè°ƒç”¨æ—¶ç»™å®ƒæŒ‡å®šçš„æ ˆã€‚</li>
<li>æ‰€ä»¥è¿™é‡Œéœ€è¦æŠŠè¿™å‡ ä¸ªå‚æ•°å…ˆä¿å­˜åˆ°å¯„å­˜å™¨ï¼Œç­‰å­çº¿ç¨‹ä»ç³»ç»Ÿè°ƒç”¨è¿”å›åç›´æ¥åœ¨å¯„å­˜å™¨ä¸­è·å–è¿™å‡ ä¸ªå‚æ•°ã€‚</li>
<li>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯è™½ç„¶è¿™ä¸ªå‡ ä¸ªå‚æ•°å€¼ä¿å­˜åœ¨äº†çˆ¶çº¿ç¨‹çš„å¯„å­˜å™¨ä¹‹ä¸­ï¼Œä½†åˆ›å»ºå­çº¿ç¨‹æ—¶ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¼šæŠŠçˆ¶çº¿ç¨‹çš„æ‰€æœ‰å¯„å­˜å™¨å¸®æˆ‘ä»¬å¤åˆ¶ä¸€ä»½ç»™å­çº¿ç¨‹ï¼Œæ‰€ä»¥å½“å­çº¿ç¨‹å¼€å§‹è¿è¡Œæ—¶å°±èƒ½æ‹¿åˆ°çˆ¶çº¿ç¨‹ä¿å­˜åœ¨å¯„å­˜å™¨ä¸­çš„å€¼ï¼Œä»è€Œæ‹¿åˆ°è¿™å‡ ä¸ªå‚æ•°ã€‚</li>
</ol>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/sys_linux_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span><span class="lnt">671
</span><span class="lnt">672
</span><span class="lnt">673
</span><span class="lnt">674
</span><span class="lnt">675
</span><span class="lnt">676
</span><span class="lnt">677
</span><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1"># int32 clone(int32 flags, void *stk, M *mp, G *gp, void (*fn)(void));
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">clone</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="p">,</span><span class="no">$0</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 1) æ¥å—å‚æ•°åˆ†è˜–æ”¾å…¥ DIã€SIã€R13ã€R9ã€R12å¯„å­˜å™¨ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æ¸…é™¤ DXã€R10ã€D8å¯„å­˜å™¨çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ç¬¬ä¸€ä¸ªå‚æ•° flagsï¼Œcloneéœ€è¦çš„å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVL</span>    <span class="no">flags</span><span class="err">+</span><span class="mi">0</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">DI</span> <span class="c1"># DI = flags
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ç¬¬äºŒä¸ªå‚æ•° stkï¼Œg0æ ˆç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">stk</span><span class="err">+</span><span class="mi">8</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">SI</span>   <span class="c1"># SI = stk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$0</span><span class="p">,</span> <span class="no">DX</span>          <span class="c1"># æ¸…é™¤DXå¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$0</span><span class="p">,</span> <span class="no">R10</span>         <span class="c1"># æ¸…é™¤R10å¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$0</span><span class="p">,</span> <span class="no">R8</span>          <span class="c1"># æ¸…é™¤R8å¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># Copy mp, gp, fn off parent stack for use by child.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># Careful: Linux system call clobbers CX and R11.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä»çˆ¶å †æ ˆä¸­å¤åˆ¶ mpã€gpã€fn ä»¥ä¾›å­çº§ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å°å¿ƒï¼šLinuxç³»ç»Ÿè°ƒç”¨clobbers CXå’ŒR11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ç¬¬ä¸‰ä¸ªå‚æ•° mp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># åœ¨cloneåå­çº¿ç¨‹å¼€å§‹è¿è¡Œæ—¶ï¼ŒR13ã€R9ã€R12çš„å€¼ä¼šè¢«æ‹·è´ç»™å­çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">mp</span><span class="err">+</span><span class="mi">16</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">R13</span>  <span class="c1"># R13 = mp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ç¬¬å››ä¸ªå‚æ•° gpï¼Œè¿™é‡Œæ˜¯ g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">gp</span><span class="err">+</span><span class="mi">24</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">R9</span>   <span class="c1"># R9 = gp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ç¬¬äº”ä¸ªå‚æ•° fnï¼Œmstart()å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">fn</span><span class="err">+</span><span class="mi">32</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">R12</span>  <span class="c1"># R12 = fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1"># 2) åˆ¤æ–­ mp å’Œ gp çš„å€¼æ˜¯ä¸º nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1"># åˆ¤æ–­mp==nilå’Œg0=nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># m å¦‚æœR13ä¸º0åˆ™è·³è½¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPQ</span>    <span class="no">R13</span><span class="p">,</span> <span class="no">$0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JEQ</span>	<span class="no">nog1</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># g	å¦‚æœR9ä¸º0åˆ™è·³è½¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPQ</span>    <span class="no">R9</span><span class="p">,</span> <span class="no">$0</span>    		
</span></span><span class="line"><span class="cl">    <span class="no">JEQ</span>	<span class="no">nog1</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 3) æ‰¾åˆ°éœ€è¦è®¾ç½®TLSçš„åœ°å€å€¼ï¼Œä¹Ÿå°±æ˜¯&amp;m.tls[1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è°ƒç”¨ç³»ç»ŸSYS_cloneå‡½æ•°å…‹éš†çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1"># æŠŠm.tlsåœ°å€å­˜å…¥R8å¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">LEAQ</span>    <span class="no">m_tls</span><span class="p">(</span><span class="no">R13</span><span class="p">),</span> <span class="no">R8</span>  <span class="c1"># R8 = TLS 
</span></span></span><span class="line"><span class="cl"><span class="c1">#ifdef GOOS_android
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># Android stores the TLS offset in runtimeÂ·tls_g.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">SUBQ</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">tls_g</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">R8</span>
</span></span><span class="line"><span class="cl"><span class="c1">#else
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># R8 = -8(FS); R8=&amp;m.tls[1]å¤„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ADDQ</span>    <span class="no">$8</span><span class="p">,</span> <span class="no">R8</span>	<span class="c1"># ELF wants to use -8(FS)
</span></span></span><span class="line"><span class="cl"><span class="c1">#endif
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æ·»åŠ CLONE_SETTLSæ ‡å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ORQ</span>     <span class="no">$0x00080000</span><span class="p">,</span> <span class="no">DI</span> <span class="c1">#add flag CLONE_SETTLS(0x00080000) to call clone
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">nog1:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">$SYS_clone</span><span class="p">,</span> <span class="no">AX</span>  <span class="c1"># å†™å…¥cloneå‡½æ•°æ ‡å¿—ï¼Œç„¶åè°ƒç”¨ç³»ç»Ÿå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ç³»ç»Ÿè°ƒç”¨çº¦å®šå¯„å­˜å™¨ DI SI DX R10 R8 R9 å‚æ•°ä¼ å‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># DI = flags
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># SI = stk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># DX = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># R10 = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># R8 = R8=&amp;m.tls[1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># R9 = gp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">SYSCALL</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 4) ç³»ç»Ÿè°ƒç”¨åï¼Œæ–°åˆ›å»ºçš„å­çº¿ç¨‹å’Œå½“å‰çº¿ç¨‹éƒ½ä¼šä»ç³»ç»Ÿè°ƒç”¨ä¸­è¿”å›ç„¶åæ‰§è¡Œåé¢çš„ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># é‚£ä¹ˆä»ç³»ç»Ÿè°ƒç”¨è¿”å›ä¹‹åæˆ‘ä»¬æ€ä¹ˆçŸ¥é“å“ªä¸ªæ˜¯çˆ¶çº¿ç¨‹å“ªä¸ªæ˜¯å­çº¿ç¨‹ï¼Œä»è€Œæ¥å†³å®šå®ƒä»¬çš„æ‰§è¡Œæµç¨‹ï¼Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä½¿ç”¨è¿‡forkç³»ç»Ÿè°ƒç”¨çš„è¯»è€…åº”è¯¥çŸ¥é“ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡è¿”å›å€¼æ¥åˆ¤æ–­çˆ¶å­çº¿ç¨‹ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   1. ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼å¦‚æœæ˜¯0åˆ™è¡¨ç¤ºè¿™æ˜¯å­çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   2. ä¸ä¸º0åˆ™è¡¨ç¤ºè¿™ä¸ªæ˜¯çˆ¶çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 4.1) çˆ¶çº¿ç¨‹çš„å¤„ç†é€»è¾‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># In parent, return.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># åœ¨çˆ¶çº¿ç¨‹ä¸­ï¼Œç›´æ¥è¿”å›ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># åˆ¤æ–­ç³»ç»Ÿè°ƒç”¨SYS_cloneçš„è¿”å›å€¼AXä¸0æ¯”è¾ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">$0</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># JEQ è¡¨ç¤ºAXæ˜¯0åˆ™æ‰§è¡Œ 3(PC)è·³è¿‡3æ¡æŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JEQ</span>	<span class="mi">3</span><span class="p">(</span><span class="no">PC</span><span class="p">)</span>   <span class="c1">#è·³è½¬åˆ°å­çº¿ç¨‹éƒ¨åˆ†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è¿™é‡Œæ˜¯çˆ¶çº¿ç¨‹ç›´æ¥æŠŠè¿”å›å€¼å†™å…¥æ ˆï¼Œç„¶åé€€å‡ºå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVL</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">ret</span><span class="err">+</span><span class="mi">40</span><span class="p">(</span><span class="no">FP</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">    <span class="no">RET</span>			
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 4.2) å­çº¿ç¨‹çš„å¤„ç†é€»è¾‘ï¼Œè®¾ç½®SPï¼Œåˆ¤æ–­mpå’Œgpï¼Œè®¾ç½®mp.procid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># In child, on new stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># åœ¨å­çº¿ç¨‹ä¸­ï¼Œåœ¨newæ ˆä¸Šã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æ–°åˆ›å»ºçš„å­çº¿ç¨‹ä»è¿™é‡Œå¼€å§‹ï¼Œæ³¨æ„ä¸€ä¸‹ä»£ç æ˜¯åœ¨å­çº¿ç¨‹ä¸­ï¼Œå¯„å­˜å™¨ä¹Ÿæ˜¯å­çº¿ç¨‹çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è®¾ç½®CPUæ ˆé¡¶å¯„å­˜å™¨æŒ‡å‘å­çº¿ç¨‹çš„æ ˆé¡¶ï¼Œè¿™æ¡æŒ‡ä»¤çœ‹èµ·æ¥æ˜¯å¤šä½™çš„ï¼Ÿå†…æ ¸åº”è¯¥å·²ç»æŠŠSPè®¾ç½®å¥½äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">SI</span><span class="p">,</span> <span class="no">SP</span>   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># If g or m are nil, skip Go-related setup.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å¦‚æœ g æˆ– m ä¸º nilï¼Œè·³è¿‡ Go-related è®¾ç½®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># m	æ–°åˆ›å»ºçš„mç»“æ„ä½“å¯¹è±¡çš„åœ°å€ï¼Œç”±çˆ¶çº¿ç¨‹ä¿å­˜åœ¨R13å¯„å­˜å™¨ä¸­çš„å€¼è¢«å¤åˆ¶åˆ°äº†å­çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPQ</span>    <span class="no">R13</span><span class="p">,</span> <span class="no">$0</span> <span class="c1"># R13 = mp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JEQ</span>	<span class="no">nog2</span> <span class="c1"># R13 ä¸º 0 æ—¶è·³è½¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># g	m.g0çš„åœ°å€ï¼Œç”±çˆ¶çº¿ç¨‹ä¿å­˜åœ¨R9å¯„å­˜å™¨ä¸­çš„å€¼è¢«å¤åˆ¶åˆ°äº†å­çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPQ</span>    <span class="no">R9</span><span class="p">,</span> <span class="no">$0</span>  <span class="c1"># R9 = gp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JEQ</span>	<span class="no">nog2</span> <span class="c1"># R9 ä¸º 0 æ—¶è·³è½¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize m-&gt;procid to Linux tid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å°†m-&gt;procidåˆå§‹åŒ–ä¸ºLinux tidã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVL</span>    <span class="no">$SYS_gettid</span><span class="p">,</span> <span class="no">AX</span>	<span class="c1"># é€šè¿‡gettid()ç³»ç»Ÿè°ƒç”¨è·å–çº¿ç¨‹IDï¼ˆtidï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">SYSCALL</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">m_procid</span><span class="p">(</span><span class="no">R13</span><span class="p">)</span>   <span class="c1"># m.procid = tid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1"># Set FS to point at m-&gt;tls.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æ–°çº¿ç¨‹åˆšåˆšåˆ›å»ºå‡ºæ¥ï¼Œè¿˜æœªè®¾ç½®çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œå³mç»“æ„ä½“å¯¹è±¡è¿˜æœªä¸å·¥ä½œçº¿ç¨‹å…³è”èµ·æ¥ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä¸‹é¢çš„æŒ‡ä»¤è´Ÿè´£è®¾ç½®æ–°çº¿ç¨‹çš„TLSï¼ŒæŠŠmå¯¹è±¡å’Œå·¥ä½œçº¿ç¨‹å…³è”èµ·æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è¿™ä¸¤è¡Œä»£ç åœ¨go1.18ä¸­æ¶ˆå¤±äº†ï¼ŒåŸå› åœ¨äºCLONE_SETTLSé…åˆå‚æ•°å’ŒR8å¯„å­˜å™¨åœ¨cloneä¸­è¢«è®¾ç½®äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># LEAQ  m_tls(R13), DI  # å–m.tlså­—æ®µçš„åœ°å€	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># CALL  runtimeÂ·settls(SB)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># In child, set up new stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">get_tls</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>	<span class="c1"># CX=&amp;m.tls[1]; CX=TLS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">R13</span><span class="p">,</span> <span class="no">g_m</span><span class="p">(</span><span class="no">R9</span><span class="p">)</span> <span class="c1"># g0.m = m
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">R9</span><span class="p">,</span> <span class="no">g</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>    <span class="c1"># m.tls[0]=&amp;g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># R14=&amp;g0 R14å¯„å­˜å™¨ä¸»è¦å­˜å‚¨å½“å‰æ­£åœ¨è¿è¡Œçš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">R9</span><span class="p">,</span> <span class="no">R14</span> <span class="c1"># set g register 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">stackcheck</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># æ£€æŸ¥ SP æ˜¯å¦åœ¨ [g-&gt;stack.lo, g-&gt;stack.hi) èŒƒå›´å†…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl"><span class="nl">nog2:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Call fn. This is the PC of an ABI0 function.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è°ƒç”¨mstart()å‡½æ•°å¼€å§‹è°ƒåº¦å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">R12</span>	<span class="c1"># æ°¸ä¸è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># It shouldn&#39;t return. If it does, exit that thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVL</span>    <span class="no">$111</span><span class="p">,</span> <span class="no">DI</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">$SYS_exit</span><span class="p">,</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">SYSCALL</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JMP</span>	<span class="p">-</span><span class="mi">3</span><span class="p">(</span><span class="no">PC</span><span class="p">)</span>  <span class="c1">// keep exiting
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="stackcheck">stackcheck()<a hidden class="anchor" aria-hidden="true" href="#stackcheck">#</a></h3>
<ol>
<li>æ£€æŸ¥SPæ˜¯å¦åœ¨<code>[g-&gt;stack.lo, g-&gt;stack.hi)</code>èŒƒå›´å†…ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/sys_linux_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1061
</span><span class="lnt">1062
</span><span class="lnt">1063
</span><span class="lnt">1064
</span><span class="lnt">1065
</span><span class="lnt">1066
</span><span class="lnt">1067
</span><span class="lnt">1068
</span><span class="lnt">1069
</span><span class="lnt">1070
</span><span class="lnt">1071
</span><span class="lnt">1072
</span><span class="lnt">1073
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1"># check that SP is in range [g-&gt;stack.lo, g-&gt;stack.hi)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">stackcheck</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">NOSPLIT</span><span class="p">,</span> <span class="no">$0-0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">get_tls</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>         <span class="c1"># CX=TLS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">g</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">AX</span>   <span class="c1"># AX=g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># g0.stack.hi ä¸ SP æ¯”è¾ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPQ</span>    <span class="p">(</span><span class="no">g_stack</span><span class="err">+</span><span class="no">stack_hi</span><span class="p">)(</span><span class="no">AX</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JHI</span>	<span class="mi">2</span><span class="p">(</span><span class="no">PC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">abort</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># g0.stack.lo ä¸ SP æ¯”è¾ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPQ</span>    <span class="no">SP</span><span class="p">,</span> <span class="p">(</span><span class="no">g_stack</span><span class="err">+</span><span class="no">stack_lo</span><span class="p">)(</span><span class="no">AX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JHI</span>	<span class="mi">2</span><span class="p">(</span><span class="no">PC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">abort</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://helium-chain.github.io/tags/golang/">Golang</a></li>
      <li><a href="https://helium-chain.github.io/tags/goroutine/">Goroutine</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://helium-chain.github.io/posts/golang/goroutine/sysmon/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>sysmon ç›‘æ§çº¿ç¨‹</span>
  </a>
  <a class="next" href="https://helium-chain.github.io/posts/golang/goroutine/gosched/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>ä¸»åŠ¨è®©å‡ºè°ƒåº¦</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
    </span>
    <span id="busuanzi_container_site_uv">
        æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
    </span>
    </div>
        <span>Copyright Â© 2024 èœ€ICPå¤‡2024091074å· <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
