<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>è¢«åŠ¨è®©å‡ºè°ƒåº¦ | Helium</title>
<meta name="keywords" content="golang, Goroutine">
<meta name="description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬">
<meta name="author" content="helium">
<link rel="canonical" href="https://helium.github.io/posts/golang/goroutine/retake/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://helium.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://helium.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://helium.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://helium.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://helium.github.io/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://helium.github.io/posts/golang/goroutine/retake/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="è¢«åŠ¨è®©å‡ºè°ƒåº¦" />
<meta property="og:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://helium.github.io/posts/golang/goroutine/retake/" />
<meta property="og:image" content="https://helium.github.io/favicon-32x32.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-07-31T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-07-31T00:00:00+00:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://helium.github.io/favicon-32x32.png" />
<meta name="twitter:title" content="è¢«åŠ¨è®©å‡ºè°ƒåº¦"/>
<meta name="twitter:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://helium.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Golang",
      "item": "https://helium.github.io/posts/golang/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ç¬¬12ç«  Goroutine",
      "item": "https://helium.github.io/posts/golang/goroutine/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "è¢«åŠ¨è®©å‡ºè°ƒåº¦",
      "item": "https://helium.github.io/posts/golang/goroutine/retake/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "è¢«åŠ¨è®©å‡ºè°ƒåº¦",
  "name": "è¢«åŠ¨è®©å‡ºè°ƒåº¦",
  "description": "ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18+ç‰ˆæœ¬",
  "keywords": [
    "golang", "Goroutine"
  ],
  "articleBody": " æŠ¢å è°ƒåº¦ï¼ˆgoroutineå› è¿è¡Œæ—¶é—´è¿‡é•¿ï¼‰ã€‚ æŠ¢å è°ƒåº¦ï¼šå› goroutineè¿è¡Œæ—¶é—´è¿‡é•¿è€Œå‘ç”Ÿçš„ã€‚ goroutineå› è¯»å†™channelç­‰é˜»å¡è€Œå¯¼è‡´çš„è¢«åŠ¨è°ƒåº¦ï¼Œä»¥åŠé€šè¿‡è°ƒç”¨Gosched()å‡½æ•°å‘èµ·çš„ä¸»åŠ¨è°ƒåº¦ã€‚ æŠ¢å æ ‡è¯† retake() _Prunningï¼Œè¡¨ç¤ºå¯¹åº”çš„goroutineæ­£åœ¨è¿è¡Œï¼Œå¦‚æœå…¶è¿è¡Œæ—¶é—´è¶…è¿‡äº†10æ¯«ç§’åˆ™å¯¹éœ€è¦æŠ¢å ã€‚ _Psyscallï¼Œè¡¨ç¤ºå¯¹åº”çš„goroutineæ­£åœ¨å†…æ ¸æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œæ­¤æ—¶éœ€è¦æ ¹æ®å¤šä¸ªæ¡ä»¶æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦æŠ¢å ã€‚ è¯¥å‡½æ•°åªåœ¨sysmonç›‘æ§çº¿ç¨‹ä¸­è¢«è°ƒç”¨ã€‚ å‚æ•°now int64ï¼šå½“å‰æ—¶é—´ã€‚ è¿”å›å€¼uint32ï¼šå¤„äºç³»ç»Ÿè°ƒç”¨ä¸­éœ€è¦æŠ¢å Pçš„æ•°é‡ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ // forcePreemptNS is the time slice given to a G before it is // preempted. // // forcePreemptNS æ˜¯åœ¨Gè¢«æŠ¢å ä¹‹å‰ç»™å®ƒçš„æ—¶é—´ç‰‡ã€‚ const forcePreemptNS = 10 * 1000 * 1000 // 10ms 5285 5286 5287 5288 5289 5290 5291 5292 5293 5294 5295 5296 5297 5298 5299 5300 5301 5302 5303 5304 5305 5306 5307 5308 5309 5310 5311 5312 5313 5314 5315 5316 5317 5318 5319 5320 5321 5322 5323 5324 5325 5326 5327 5328 5329 5330 5331 5332 5333 5334 5335 5336 5337 5338 5339 5340 5341 5342 5343 5344 5345 5346 5347 5348 5349 5350 5351 5352 5353 5354 5355 5356 5357 5358 5359 5360 5361 5362 5363 5364 5365 5366 5367 5368 5369 5370 5371 5372 5373 5374 5375 5376 5377 5378 5379 5380 5381 5382 5383 5384 5385 5386 5387 5388 5389 5390 5391 5392 5393 5394 5395 5396 5397 5398 5399 5400 5401 5402 5403 5404 5405 5406 5407 5408 5409 5410 5411 5412 5413 5414 5415 5416 5417 5418 5419 5420 5421 5422 5423 5424 5425 5426 5427 5428 5429 5430 5431 5432 5433 5434 5435 5436 5437 5438 5439 5440 5441 5442 5443 5444 5445 // æ£€æŸ¥æ‰€æœ‰çš„PæŸ¥çœ‹æ˜¯å¦å­˜åœ¨è¿è¡Œæ—¶é—´å¤ªé•¿çš„Géœ€è¦è®¾ç½®æŠ¢å è¯·æ±‚ã€‚ // 1. goroutineè¿è¡Œæ—¶é—´è¶…è¿‡10msæ—¶éœ€è¦æŠ¢å ã€‚ // 2. goroutineé™·å…¥ç³»ç»Ÿè°ƒç”¨ï¼Œè¿è¡Œæ—¶é—´è¶…è¿‡10msæˆ–åœ¨ç¬¬äºŒè½®æ¥æ˜¯sysmonç³»ç»Ÿè°ƒç”¨è¿˜æ²¡è¿”å›æ—¶ã€‚ // é™·å…¥ç³»ç»Ÿè°ƒç”¨è€ŒæŠ¢å Pçš„æƒ…å†µï¼š // 1. è¿è¡Œæ—¶é—´è¶…è¿‡10msï¼Œå¯èƒ½ä¸€å¼€å§‹å°±é™·å…¥ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ–ä¸­é€”é™·å…¥ç³»ç»Ÿè°ƒç”¨ã€‚ä¸è®ºé‚£ç§æƒ…å†µéƒ½åº”è¯¥æŠ¢å ã€‚ // 2. è¿è¡Œæ—¶é—´æ²¡åˆ°10msï¼Œä½†æ˜¯ä¸¤è½®sysmonäº†è¿˜æ˜¯åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­ï¼Œéœ€è¦æŠ¢å Pã€‚ func retake(now int64) uint32 { n := 0 // 1) é”ä½ allpï¼Œç°åœ¨éœ€è¦éå†æ‰€æœ‰çš„PæŸ¥çœ‹æ˜¯å¦å­˜åœ¨è¿è¡Œæ—¶é—´è¿‡é•¿è€Œéœ€è¦æŠ¢å çš„Gã€‚ // Prevent allp slice changes. This lock will be completely // uncontended unless we're already stopping the world. // // é˜²æ­¢ allp åˆ‡ç‰‡æ›´æ”¹ã€‚ é™¤éæˆ‘ä»¬å·²ç»STWï¼Œå¦åˆ™è¿™æŠŠé”å°†æ˜¯å®Œå…¨æ— äººäº‰å¤ºçš„ lock(\u0026allpLock) // allpåŠ é” // 2) éå†æ‰€æœ‰çš„Pï¼Œæ ¹æ®è¿è¡Œæ—¶é—´æ˜¯å¦è®¾ç½®æŠ¢å æ ‡å¿—ã€‚ // We can't use a range loop over allp because we may // temporarily drop the allpLock. Hence, we need to re-fetch // allp each time around the loop. // // æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨rangeæ¥éå†allpï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½ä¼šæš‚æ—¶æ”¾å¼ƒallpLocké”ï¼ˆä¼šæš‚æ—¶è§£é”ï¼‰ã€‚ // å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ¯æ¬¡å¾ªç¯ä¸­é‡æ–°è·å–allpã€‚ // rangeä¼šæ‹·è´ï¼Œå› æ­¤å¢é•¿æˆ–ç¼©å°äº†allpä¸ä¼šå®æ—¶å˜åŒ–ã€‚ for i := 0; i \u003c len(allp); i++ { // éå†æ‰€æœ‰çš„P _p_ := allp[i] // 2.1) æœªåˆå§‹åŒ–çš„Pè·³è¿‡ã€‚å¯èƒ½æ­£åœ¨å¢é•¿Pã€‚ if _p_ == nil { // This can happen if procresize has grown // allp but not yet created new Ps. // // å¦‚æœprocresizeå·²ç»å¢é•¿äº†æ‰€æœ‰pï¼Œä½†è¿˜æ²¡æœ‰åˆ›å»ºæ–°çš„pï¼Œåˆ™å¯èƒ½å‘ç”Ÿè¿™ç§æƒ…å†µã€‚ continue } // 2.2) åˆ¤æ–­æ˜¯å¦è¿è¡Œæ—¶é—´è¿‡é•¿ // _p_.sysmontickç”¨äºsysmonçº¿ç¨‹è®°å½•è¢«ç›‘æ§pçš„ç³»ç»Ÿè°ƒç”¨æ—¶é—´å’Œè¿è¡Œæ—¶é—´ // type sysmontick struct { // schedtick uint32 // è°ƒåº¦å™¨è°ƒåº¦æ¬¡æ•° // schedwhen int64 // ä¸Šæ¬¡è°ƒåº¦æ—¶é—´ // // syscalltick uint32 // ç³»ç»Ÿè°ƒç”¨æ¬¡æ•° // syscallwhen int64 // ä¸Šæ¬¡è°ƒåº¦æ—¶é—´ // } pd := \u0026_p_.sysmontick // ä¸sysmonçº¿ç¨‹ç›¸å…³ // _Prunningï¼šå¯¹åº”çš„goroutineæ­£åœ¨è¿è¡Œ // _Psyscallï¼šå¯¹åº”çš„goroutineæ­£åœ¨å†…æ ¸æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ s := _p_.status // På½“å‰æ‰€å¤„çŠ¶æ€ _Prunningï¼Œ_Psyscall // æ ‡è®°å½“å‰Pæ˜¯å¦å·²è®¾ç½®æŠ¢å è¯·æ±‚ // false.æœªè®¾ç½® true.å·²è®¾ç½® sysretake := false // 2.3) å…ˆåˆ¤æ–­ schedtick å’Œ schedwhen æ—¶é—´æ˜¯å¦è¿è¡Œæ—¶é—´è¿‡é•¿ã€‚ // Gçš„è¿è¡Œæ—¶é—´æ˜¯åŒ…æ‹¬ç³»ç»Ÿè°ƒç”¨çš„æ—¶é—´çš„ã€‚ if s == _Prunning || s == _Psyscall { // Preempt G if it's running for too long.\t// // å¦‚æœGè¿è¡Œå¤ªä¹…ï¼Œå°±æŠ¢å å®ƒã€‚ // _p_.schedtickè°ƒåº¦æ¬¡æ•°ï¼Œè¯¥å€¼æ˜¯åœ¨Pä¸Šçš„ï¼Œè®°å½•å½“å‰çš„è°ƒåº¦æ¬¡æ•°ã€‚ // æ³¨æ„åŒºåˆ«sysmontickä¸Šçš„schedtick t := int64(_p_.schedtick) // _p_.schedtickï¼šæ¯å‘ç”Ÿä¸€æ¬¡è°ƒåº¦ï¼Œè°ƒåº¦å™¨++è¯¥å€¼ // pd.schedtick == tè¯´æ˜(pd.schedwhenï½now)è¿™æ®µæ—¶é—´æœªå‘ç”Ÿè¿‡è°ƒåº¦ï¼ˆè¿™ç§æƒ…å†µä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦å¤„ç†çš„æŠ¢å æƒ…å†µï¼‰ï¼Œ // æ‰€ä»¥è¿™æ®µæ—¶é—´æ˜¯åŒä¸€ä¸ªgoroutineä¸€ç›´åœ¨è¿è¡Œï¼Œä¸‹é¢æ£€æŸ¥ä¸€ç›´è¿è¡Œæ˜¯å¦è¶…è¿‡äº†10æ¯«ç§’ï¼Œå¦åˆ™åˆ™æ˜¯å‘ç”Ÿè¿‡è°ƒåº¦ if int64(pd.schedtick) != t { // å¦‚æœä¸ç›¸ç­‰è¯´æ˜æ˜¯ä¸€æ¬¡æ–°çš„è°ƒåº¦ // ç›‘æ§çº¿ç¨‹ç›‘æ§åˆ°ä¸€æ¬¡æ–°çš„è°ƒåº¦ï¼Œæ‰€ä»¥é‡ç½®è·Ÿsysmonç›¸å…³çš„schedtickå’Œschedwhenå˜é‡ // 2.4) æ£€æµ‹åˆ°ä¸‹æ¬¡è°ƒåº¦ï¼Œæ›´æ–°è°ƒåº¦æ—¶é—´ pd.schedtick = uint32(t) pd.schedwhen = now } else if pd.schedwhen+forcePreemptNS \u003c= now { // 2.4) æœ¬æ¬¡è°ƒåº¦å·²è¶…è¿‡ 10msï¼Œè®¾ç½®æŠ¢å æ ‡è¯†ã€‚ // ä»æŸgoroutineç¬¬ä¸€æ¬¡è¢«sysmonçº¿ç¨‹ç›‘æ§åˆ°æ­£åœ¨è¿è¡Œä¸€ç›´è¿è¡Œåˆ°ç°åœ¨è¶…è¿‡äº†10æ¯«ç§’ // æŠ¢å ç”¨æˆ·ä»£ç çš„goroutineæ—¶æ˜¯éœ€è¦åˆ¤æ–­æ˜¯å¦èƒ½æŠ¢å çš„æ¡ä»¶çš„ã€‚ preemptone(_p_) // è®¾ç½®æŠ¢å è¯·æ±‚ï¼Œéç³»ç»Ÿè°ƒç”¨æ—¶åœ¨è¿™é‡Œåå°±ç»“æŸäº†ã€‚ // In case of syscall, preemptone() doesn't // work, because there is no M wired to P. // // åœ¨ç³»ç»Ÿè°ƒç”¨çš„æƒ…å†µä¸‹ï¼Œpreemptone()ä¸èµ·ä½œç”¨ï¼Œå› ä¸ºMæ²¡æœ‰è¿æ¥åˆ°Pã€‚æ­¤æ—¶å·²ç»é™·å…¥åˆ°ç³»ç»Ÿè°ƒåº¦ä¸­ï¼Œä¸ä¼šå“åº”è¯·æ±‚ã€‚ sysretake = true // å·²æ ‡è®°äº†æŠ¢å  } // 2.4) æœ¬åœ°è°ƒåº¦è¿è¡Œæ—¶é—´è¿˜æœªåˆ°10msã€‚ } // 2.5) På¤„äºç³»ç»Ÿè°ƒç”¨ä¹‹ä¸­æ—¶ã€‚ if s == _Psyscall { // Retake P from syscall if it's there for more than 1 sysmon tick (at least 20us). // // å¦‚æœPå­˜åœ¨è¶…è¿‡1ä¸ªsysmon tick(è‡³å°‘20us)ï¼Œåˆ™ä»sycallä¸­é‡æ–°å–Pã€‚ // _p_.syscalltickç”¨äºè®°å½•ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°ï¼Œä¸»è¦ç”±å·¥ä½œçº¿ç¨‹åœ¨å®Œæˆç³»ç»Ÿè°ƒç”¨ä¹‹å++ t := int64(_p_.syscalltick)\t// sysretake = falseï¼šå‰é¢æ²¡æœ‰è®¾ç½®æŠ¢å æ ‡å¿—ã€‚ // 1. æœ¬è½®è°ƒåº¦Gè¿˜æ²¡åˆ°è¾¾10msã€‚ // 2. æ–°çš„ä¸€è½®è°ƒåº¦ï¼Œå·²ç»é‡ç½®äº†ã€‚ // int64(pd.syscalltick) != tï¼šæ–°çš„ä¸€è½®ç³»ç»Ÿè°ƒåº¦äº†ã€‚ if !sysretake \u0026\u0026 int64(pd.syscalltick) != t { pd.syscalltick = uint32(t) // update syscalltick pd.syscallwhen = now // update syscallwhen continue } // 2.6) sysretake == true || (sysretake == false \u0026\u0026 int64(pd.syscalltick) == t) // 1. sysretake == trueï¼šå‰é¢å·²ç»è®¾ç½®äº†æŠ¢å è¯·æ±‚ï¼ŒGè¿è¡Œæ—¶é—´è¶…è¿‡äº†10msï¼Œç°åœ¨å¤„äºç³»ç»Ÿè°ƒç”¨ä¸­ã€‚ // 2. (sysretake == false \u0026\u0026 int64(pd.syscalltick) == t)ï¼š // goroutineæ²¡æœ‰è¶…è¿‡10msï¼Œä½†æ˜¯ç›‘æ§å…ˆåˆ°ç¬¬äºŒè½®äº†ï¼Œç°åœ¨å¤„äºç³»ç»Ÿè°ƒç”¨ä¸­ã€‚ // å› æ­¤è¿™ç§æƒ…å†µå–å†³äºç›‘æ§çº¿ç¨‹çš„è°ƒåº¦æ—¶é—´é—´éš”ã€‚ // On the one hand we don't want to retake Ps if there is no other work to do, // but on the other hand we want to retake them eventually // because they can prevent the sysmon thread from deep sleep. // // ä¸€æ–¹é¢æˆ‘ä»¬ä¸æƒ³åœ¨æ²¡æœ‰å…¶ä»–å·¥ä½œçš„æƒ…å†µä¸‹é‡æ–°è·å– Psï¼Œ // å¦ä¸€æ–¹é¢æˆ‘ä»¬å¸Œæœ›æœ€ç»ˆé‡æ–°è·å–å®ƒä»¬ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥é˜²æ­¢ sysmon çº¿ç¨‹æ·±åº¦ç¡çœ ã€‚ // åªè¦æ»¡è¶³ä¸‹é¢ä¸‰ä¸ªæ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œåˆ™æŠ¢å è¯¥pï¼Œå¦åˆ™ä¸æŠ¢å  // 1. pçš„è¿è¡Œé˜Ÿåˆ—é‡Œé¢æœ‰ç­‰å¾…è¿è¡Œçš„goroutineã€‚ï¼ˆæœ‰éœ€è¦è¿è¡Œçš„goroutineï¼Œéœ€è¦æŠ¢å Pï¼‰ // 2. æ²¡æœ‰æ— æ‰€äº‹äº‹çš„pï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰è‡ªæ—‹çš„Pæˆ–ç©ºé—²çš„Pã€‚ï¼ˆç³»ç»Ÿå¾ˆå¿™ï¼Œéœ€è¦æŠ¢å Pï¼‰ // 3. ä»ä¸Šä¸€æ¬¡ç›‘æ§çº¿ç¨‹è§‚å¯Ÿåˆ°på¯¹åº”çš„må¤„äºç³»ç»Ÿè°ƒç”¨ä¹‹ä¸­åˆ°ç°åœ¨å·²ç»è¶…è¿‡10äº†æ¯«ç§’ã€‚ï¼ˆç³»ç»Ÿè°ƒç”¨æ—¶é—´å¤ªé•¿ï¼Œéœ€è¦æŠ¢å Pï¼‰ if runqempty(_p_) \u0026\u0026 atomic.Load(\u0026sched.nmspinning)+atomic.Load(\u0026sched.npidle) \u003e 0 \u0026\u0026 pd.syscallwhen+10*1000*1000 \u003e now { // ä¸éœ€è¦æŠ¢å ï¼š_p_æœ¬åœ°é˜Ÿåˆ—ä¸ºç©º \u0026\u0026 å­˜åœ¨è‡ªæ—‹æˆ–ç©ºé—²çš„Pï¼ˆç³»ç»Ÿä¸å¿™ï¼‰ \u0026\u0026 ç³»ç»Ÿè°ƒç”¨æ—¶é—´è¿˜æ²¡æœ‰è¶…è¿‡äº†10ms continue } // Drop allpLock so we can take sched.lock. // // è¿™é‡Œæ˜¯å‰é¢ä¸èƒ½æœ‰for rangeçš„åŸå› ï¼Œè§£é”è¿™æ®µæ—¶é—´å¯èƒ½allpä¼šå‘ç”Ÿå˜åŒ–ã€‚ unlock(\u0026allpLock) // è§£é” allpLock // Need to decrement number of idle locked M's // (pretending that one more is running) before the CAS. // Otherwise the M from which we retake can exit the syscall, // increment nmidle and report deadlock. // // éœ€è¦åœ¨CASä¹‹å‰å‡å°‘ç©ºé—²é”å®šMçš„æ•°é‡(å‡è£…è¿˜æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œ)ã€‚ // å¦åˆ™ï¼Œæˆ‘ä»¬é‡æ–°è·å–çš„Må¯ä»¥é€€å‡ºç³»ç»Ÿè°ƒç”¨ï¼Œå¢åŠ nmidå¹¶æŠ¥å‘Šæ­»é”ã€‚ incidlelocked(-1) // sched.nmidlelocked += -1 // è¿™é‡Œä½¿ç”¨Casä¿®æ”¹Pçš„ä½¿ç”¨æƒï¼ŒåŸå› æ˜¯æ­¤æ—¶æ­¤åˆ»æ­£å¥½å­˜åœ¨ç³»ç»Ÿè°ƒç”¨è¿”å›äº†ï¼Œä¹Ÿæ­£åœ¨è·å–Pçš„ä½¿ç”¨æƒ // å¦‚æœä½¿ç”¨æƒè·å–æˆåŠŸåˆ™è°ƒç”¨handoffp()å¯»æ‰¾æ–°çš„å·¥ä½œçº¿ç¨‹æ¥æ¥ç®¡è¿™ä¸ªp // _Pidleï¼šç©ºé—²çŠ¶æ€ã€‚æ­¤æ—¶çš„Pæ²¡æœ‰è¢«ç”¨æ¥æ‰§è¡Œç”¨æˆ·ä»£ç æˆ–è°ƒåº¦å™¨ä»£ç ï¼Œé€šå¸¸ä½äºç©ºé—²é“¾è¡¨ä¸­ï¼Œèƒ½å¤Ÿè¢«è°ƒåº¦å™¨è·å–ï¼Œ // å®ƒçš„çŠ¶æ€å¯èƒ½æ­£åœ¨ç”±ç©ºé—²è½¬å˜æˆå…¶ä»–çŠ¶æ€ã€‚Pçš„æ‰€æœ‰æƒå½’ç©ºé—²é“¾è¡¨æˆ–æŸä¸ªæ­£åœ¨æ”¹å˜å®ƒçŠ¶æ€çš„çº¿ç¨‹æ‰€æœ‰ï¼Œæœ¬åœ°runqä¸ºç©ºã€‚ if atomic.Cas(\u0026_p_.status, s, _Pidle) { if trace.enabled { traceGoSysBlock(_p_) traceProcStop(_p_) } n++ _p_.syscalltick++ // ç³»ç»Ÿè°ƒåº¦æ¬¡æ•°åŠ ä¸€ // å°è¯•å¯»æ‰¾ä¸€ä¸ªæ–°çš„må‡ºæ¥æ¥ç®¡P // æŠ¢å é™·å…¥ç³»ç»Ÿè°ƒç”¨çš„Pæ—¶ï¼Œæ²¡æœ‰å¤šä½™çš„æ¡ä»¶ handoffp(_p_)\t} incidlelocked(1) lock(\u0026allpLock) } } unlock(\u0026allpLock) return uint32(n) } incidlelocked() æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5505 5506 5507 5508 5509 5510 5511 5512 5513 5514 func incidlelocked(v int32) { lock(\u0026sched.lock) // nmidlelocked é”å®šç­‰å¾…å·¥ä½œçš„Mçš„æ•°é‡ // åªä¼šåœ¨è¯¥å‡½æ•°ä¸­åŠ å‡ï¼Œåœ¨checkdead()å‡½æ•°ä¸­åˆ¤æ–­ sched.nmidlelocked += v if v \u003e 0 { checkdead() } unlock(\u0026sched.lock) } preemptone() sysmonçº¿ç¨‹å¦‚æœç›‘æ§åˆ°æŸä¸ªgoroutineè¿ç»­è¿è¡Œè¶…è¿‡äº†10æ¯«ç§’ï¼Œåˆ™ä¼šè°ƒç”¨preemptone()å‡½æ•°å‘è¯¥goroutineå‘å‡ºæŠ¢å è¯·æ±‚ã€‚ å‘Šè¯‰åœ¨å¤„ç†å™¨Pä¸Šè¿è¡Œçš„goroutineåœæ­¢ã€‚ è¿™ä¸ªå‡½æ•°åªæ˜¯å°½äº†æœ€å¤§åŠªåŠ›ã€‚å®ƒå¯èƒ½ä¼šé”™è¯¯åœ°æ²¡æœ‰é€šçŸ¥goroutineã€‚ä¹Ÿå¯èƒ½ä¼šé€šçŸ¥é”™è¯¯çš„goroutineã€‚ å³ä½¿å®ƒé€šçŸ¥äº†æ­£ç¡®çš„goroutineï¼Œå¦‚æœgoroutineåŒæ—¶æ‰§è¡Œnewstackï¼Œå®ƒå¯èƒ½ä¼šå¿½ç•¥è¯·æ±‚ã€‚ ä¸éœ€è¦é”ã€‚å¦‚æœå‘å‡ºæŠ¢å è¯·æ±‚ï¼Œåˆ™è¿”å›trueã€‚ å®é™…çš„æŠ¢å å°†åœ¨æœªæ¥çš„æŸä¸ªæ—¶é—´ç‚¹å‘ç”Ÿï¼Œå¹¶ä¸”å°†ç”±gp-\u003estatusä¸å†æ˜¯Grunningè¡¨ç¤ºã€‚è®¾ç½®æŠ¢å è¯·æ±‚ã€‚ è¯¥å‡½æ•°ä¼šåœ¨retake()å‡½æ•°ä¸­è°ƒç”¨ï¼ŒGCæœŸé—´è°ƒç”¨ã€‚ å¯ä»¥çœ‹å‡ºï¼Œpreemptoneå‡½æ•°åªæ˜¯ç®€å•çš„è®¾ç½®äº†è¢«æŠ¢å goroutineå¯¹åº”çš„gç»“æ„ä½“ä¸­çš„ preemptæˆå‘˜ä¸ºtrueå’Œstackguard0æˆå‘˜ä¸ºstackPreemptï¼ˆstackPreemptæ˜¯ä¸€ä¸ªå¸¸é‡0xfffffffffffffadeï¼Œæ˜¯éå¸¸å¤§çš„ä¸€ä¸ªæ•°ï¼‰å°±è¿”å›äº†ï¼Œå¹¶æœªçœŸæ­£å¼ºåˆ¶è¢«æŠ¢å çš„goroutineæš‚åœä¸‹æ¥ã€‚ æ—¢ç„¶è®¾ç½®äº†ä¸€äº›æŠ¢å æ ‡å¿—ï¼Œé‚£ä¹ˆå°±ä¸€å®šéœ€è¦å¯¹è¿™äº›æ ‡å¿—è¿›è¡Œå¤„ç†ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥åˆ†æè¢«æŠ¢å çš„goroutineå¦‚ä½•å¤„ç†è¿™äº›æ ‡å¿—å»å“åº”ç›‘æ§çº¿ç¨‹æå‡ºçš„æŠ¢å è¯·æ±‚ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 5378 5379 5380 5381 5382 5383 5384 5385 5386 5387 5388 5389 5390 5391 5392 5393 5394 5395 5396 5397 5398 5399 5400 5401 5402 5403 5404 5405 5406 5407 5408 5409 5410 5411 5412 5413 5414 5415 5416 5417 5418 5419 5420 5421 5422 5423 5424 5425 5426 5427 5428 5429 5430 5431 5432 5433 5434 5435 // Tell the goroutine running on processor P to stop. // This function is purely best-effort. It can incorrectly fail to inform the // goroutine. It can inform the wrong goroutine. Even if it informs the // correct goroutine, that goroutine might ignore the request if it is // simultaneously executing newstack. // No lock needs to be held. // Returns true if preemption request was issued. // The actual preemption will happen at some point in the future // and will be indicated by the gp-\u003estatus no longer being // Grunning func preemptone(_p_ *p) bool { // 1) æŠ¢å Pçš„å…³è”çš„m mp := _p_.m.ptr() // mp := m // 2) æŠ¢å çš„Pæ²¡æœ‰ç»‘å®šMï¼Œæˆ–æŠ¢å çš„Pçš„Mä¸å½“å‰è¿è¡ŒGçš„Mä¸€è‡´ã€ä¸è®¾ç½®æŠ¢å æ ‡å¿—ã€‘ // 1. mp == nilï¼šå¯èƒ½æ¥è‡ªsysmonæŠ¢å ç©ºé—²çš„Pçš„æ—¶å€™ï¼Œè¿™æ—¶å€™Pæ˜¯æ²¡æœ‰ç»‘å®šMçš„ã€‚ // 2. mp == getg().mï¼šæŠ¢å çš„æ˜¯è‡ªå·±ï¼Œå¾ˆå¤§å¯èƒ½è¿™ç§æƒ…å†µæ¥è‡ªGCåœ¨ç­‰å¾…å…¶ä»–Påœä¸‹æ¥çš„æ—¶å€™ã€‚ if mp == nil || mp == getg().m { return false } // 3) æŠ¢å çš„å·¥ä½œçº¿ç¨‹åˆšå¥½å¤„ç†å®Œgoroutineï¼Œæˆ–æŠ¢å çš„å·¥ä½œçº¿ç¨‹æ­£åœ¨g0ä¸­ã€ä¸è®¾ç½®æŠ¢å æ ‡å¿—ã€‘ gp := mp.curg // mpå·¥ä½œçº¿ç¨‹ä¸Šæ­£åœ¨è¿è¡Œçš„goroutine // 1. gp == nilï¼šå½“å‰å·¥ä½œçº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„goroutineåˆšå¥½è¿è¡Œå®Œè¢«è°ƒç¦»Mæ—¶ã€‚ // 2. gp == mp.g0ï¼šå½“å‰æ­£åœ¨g0ä¸Šï¼Œå¯èƒ½åœ¨æ‰§è¡Œè°ƒåº¦ä»£ç ã€‚ if gp == nil || gp == mp.g0 { return false } gp.preempt = true // æ ‡è®°æ­£åœ¨è¿è¡Œçš„Pçš„gè®¾ç½®æŠ¢å æ ‡å¿— // Every call in a goroutine checks for stack overflow by // comparing the current stack pointer to gp-\u003estackguard0. // Setting gp-\u003estackguard0 to StackPreempt folds // preemption into the normal stack overflow check. // // goroutineä¸­çš„æ¯ä¸ªè°ƒç”¨éƒ½é€šè¿‡å°†å½“å‰å †æ ˆæŒ‡é’ˆä¸gp-\u003estackguard0è¿›è¡Œæ¯”è¾ƒæ¥æ£€æŸ¥å †æ ˆæº¢å‡ºã€‚ // è®¾ç½®gp-\u003estackguard0ä¸ºStackPreemptå°†æŠ¢å è½¬æ¢ä¸ºæ­£å¸¸çš„æ ˆæº¢å‡ºæ£€æŸ¥ã€‚ // stackPreemptæ˜¯ä¸€ä¸ªå¸¸é‡0xfffffffffffffadeï¼Œæ˜¯éå¸¸å¤§çš„ä¸€ä¸ªæ•°ã€‚ gp.stackguard0 = stackPreempt // è®¾ç½®stackguard0ä½¿è¢«æŠ¢å çš„goroutineå»å¤„ç†æŠ¢å è¯·æ±‚ // Request an async preemption of this P. // // è¯·æ±‚è¿™ä¸ªPçš„å¼‚æ­¥æŠ¢å ã€‚è¿™ç§æƒ…å†µæ˜¯å¯¹äºæ²¡æœ‰è°ƒç”¨ä»»ä½•å‡½æ•°çš„goroutineï¼Œæ²¡æœ‰æŠ¢å æœºä¼šçš„æƒ…å†µä¸‹ã€‚ // 1. preemptMSupportedï¼šå…¶ä¸­çš„ preemptMSupported æ˜¯ä¸ªå¸¸é‡ï¼Œå› ä¸ºå—ç¡¬ä»¶ç‰¹æ€§çš„é™åˆ¶ï¼Œ // åœ¨æŸäº›å¹³å°ä¸Šæ˜¯æ— æ³•æ”¯æŒè¿™ç§æŠ¢å çš„ã€‚ // 2. debug.asyncpreemptoffï¼šåˆ™æ˜¯è®©ç”¨æˆ·å¯ä»¥é€šè¿‡ GODEBUG ç¯å¢ƒå˜é‡æ¥ç¦ç”¨å¼‚æ­¥æŠ¢å ï¼Œ // é»˜è®¤æƒ…å†µä¸‹æ˜¯è¢«å¯ç”¨çš„ã€‚ if preemptMSupported \u0026\u0026 debug.asyncpreemptoff == 0 { // åœ¨Pçš„æ•°æ®ç»“æ„ä¸­ä¹Ÿæ–°å¢äº†ä¸€ä¸ªpreemptå­—æ®µï¼Œè¿™é‡Œä¼šæŠŠå®ƒè®¾ç½®ä¸ºtrueã€‚ _p_.preempt = true // å®é™…ä¸ŠæŠ¢å æ“ä½œæ˜¯ç”± preemptM å‡½æ•°å®Œæˆçš„ã€‚ preemptM(mp)\t// è¯¥å‡½æ•°å‘èµ·å¼‚æ­¥æŠ¢å ç»™MPå‘é€æŠ¢å ä¿¡å· } return true } handoffp() ä»ç³»ç»Ÿè°ƒç”¨ä¸­å…³é—­Pæˆ–é”å®šMã€‚æ€»æ˜¯åœ¨æ²¡æœ‰Pçš„æƒ…å†µä¸‹è¿è¡Œï¼Œå› æ­¤ä¸å…è®¸æœ‰å†™å±éšœã€‚ handoffp()å‡½æ•°ä¸»è¦ä»»åŠ¡æ˜¯é€šè¿‡å„ç§æ¡ä»¶åˆ¤æ–­æ˜¯å¦éœ€è¦å¯åŠ¨å·¥ä½œçº¿ç¨‹æ¥æ¥ç®¡_p_ï¼Œå¦‚æœä¸éœ€è¦åˆ™æŠŠ_p_æ”¾å…¥Pçš„å…¨å±€ç©ºé—²é˜Ÿåˆ—ã€‚ _p_çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—æˆ–å…¨å±€è¿è¡Œé˜Ÿåˆ—é‡Œé¢æœ‰å¾…è¿è¡Œçš„goroutineã€‚ éœ€è¦å¸®åŠ©gcå®Œæˆæ ‡è®°å·¥ä½œã€‚ ç³»ç»Ÿæ¯”è¾ƒå¿™ï¼Œæ‰€æœ‰å…¶å®ƒ_p_éƒ½åœ¨è¿è¡Œgoroutineï¼Œéœ€è¦å¸®å¿™ã€‚ æ‰€æœ‰å…¶å®ƒPéƒ½å·²ç»å¤„äºç©ºé—²çŠ¶æ€ï¼Œå¦‚æœéœ€è¦ç›‘æ§ç½‘ç»œè¿æ¥è¯»å†™äº‹ä»¶ï¼Œåˆ™éœ€è¦å¯åŠ¨æ–°çš„mæ¥pollç½‘ç»œè¿æ¥ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 2350 2351 2352 2353 2354 2355 2356 2357 2358 2359 2360 2361 2362 2363 2364 2365 2366 2367 2368 2369 2370 2371 2372 2373 2374 2375 2376 2377 2378 2379 2380 2381 2382 2383 2384 2385 2386 2387 2388 2389 2390 2391 2392 2393 2394 2395 2396 2397 2398 2399 2400 2401 2402 2403 2404 2405 2406 2407 2408 2409 2410 2411 2412 2413 2414 2415 2416 2417 2418 2419 2420 2421 2422 2423 2424 2425 2426 2427 2428 2429 2430 2431 2432 2433 2434 2435 2436 2437 2438 2439 // Hands off P from syscall or locked M. // Always runs without a P, so write barriers are not allowed. // //go:nowritebarrierrec func handoffp(_p_ *p) { // handoffp must start an M in any situation where // findrunnable would return a G to run on _p_. // // åœ¨findrunnableè¿”å›Gå¹¶åœ¨_p_ä¸Šè¿è¡Œçš„ä»»ä½•æƒ…å†µä¸‹ï¼Œhandffpå¿…é¡»å¼€å§‹ä¸€ä¸ªMã€‚ // if it has local work, start it straight away // // å¦‚æœå®ƒæœ‰æœ¬åœ°å·¥ä½œï¼Œéœ€è¦å¯åŠ¨mæ¥æ¥ç®¡ if !runqempty(_p_) || sched.runqsize != 0 { startm(_p_, false) // åˆ›å»ºMæ¥æ¥ç®¡P return } // if there's trace work to do, start it straight away if (trace.enabled || trace.shutdown) \u0026\u0026 traceReaderAvailable() { startm(_p_, false) return } // if it has GC work, start it straight away // // GCæ­£åœ¨å·¥ä½œï¼Œä¹Ÿéœ€è¦å¯åŠ¨mæ¥æ¥ç®¡ if gcBlackenEnabled != 0 \u0026\u0026 gcMarkWorkAvailable(_p_) { startm(_p_, false) return } // no local work, check that there are no spinning/idle M's, // otherwise our help is not required // // æ²¡æœ‰æœ¬åœ°å·¥ä½œï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ spinning/idle çš„Mï¼Œå¦åˆ™ä¸éœ€è¦æˆ‘ä»¬çš„å¸®åŠ©ã€‚ // 1. atomic.Load(\u0026sched.nmspinning)+atomic.Load(\u0026sched.npidle) == 0ï¼šæ²¡æœ‰è‡ªæ—‹çš„Må’Œç©ºé—²çš„Pæ—¶ã€‚ // 2. atomic.Cas(\u0026sched.nmspinning, 0, 1)ï¼šsched.nmspinning = 1ã€‚ if atomic.Load(\u0026sched.nmspinning)+atomic.Load(\u0026sched.npidle) == 0 \u0026\u0026 atomic.Cas(\u0026sched.nmspinning, 0, 1) { // TODO: fast atomic startm(_p_, true) // è¿™æ—¶å€™å¯åŠ¨çš„Mç»‘å®šPå¯ä»¥èµ·å»å…¶ä»–Pä¸­å·å–ä»»åŠ¡ï¼Œå¦‚æœå­˜åœ¨ç©ºé—²çš„Påˆ™è¡¨ç¤ºå…¶ä»–Pä¸å¿™ return } lock(\u0026sched.lock) // GCæ­£åœ¨STWç­‰å¾…æ—¶ã€‚ if sched.gcwaiting != 0 { _p_.status = _Pgcstop // ä¿®æ”¹çŠ¶æ€ä¸ºGCè€Œåœä¸‹ sched.stopwait-- // å› ä¸ºGCè€Œåœä¸‹æ¥ // å½“å‰STWè¦æ±‚çš„På…¨éƒ¨åœä¸‹æ¥æ—¶ï¼Œå°±å¯ä»¥å”¤é†’ç­‰å¾…åœ¨sched.stopnoteä¸Šçš„å‘èµ·STWçš„çº¿ç¨‹äº†ã€‚ if sched.stopwait == 0 { notewakeup(\u0026sched.stopnote) } unlock(\u0026sched.lock) return } if _p_.runSafePointFn != 0 \u0026\u0026 atomic.Cas(\u0026_p_.runSafePointFn, 1, 0) { sched.safePointFn(_p_) sched.safePointWait-- if sched.safePointWait == 0 { notewakeup(\u0026sched.safePointNote) } } // å…¨å±€é˜Ÿåˆ—æ± æœ‰Géœ€è¦å¤„ç†æ—¶ã€‚ if sched.runqsize != 0 { unlock(\u0026sched.lock) startm(_p_, false) return } // If this is the last running P and nobody is polling network, // need to wakeup another M to poll network. // // å¦‚æœè¿™æ˜¯æœ€åä¸€ä¸ªè¿è¡Œçš„På¹¶ä¸”æ²¡æœ‰å…¶ä»–çº¿ç¨‹åœ¨é˜»å¡å¼ç­‰å¾…netpollï¼Œéœ€è¦å”¤é†’ä¸€ä¸ªMæ¥å¤„ç†netpollã€‚ // 1. sched.npidle == uint32(gomaxprocs-1)ï¼šå½“å‰æ˜¯æœ€åä¸€ä¸ªç©ºé—²P // 2. atomic.Load64(\u0026sched.lastpoll) != 0ï¼šæ²¡æœ‰å…¶ä»–çº¿ç¨‹åœ¨é˜»å¡å¼è®¿é—®netpollã€‚ if sched.npidle == uint32(gomaxprocs-1) \u0026\u0026 atomic.Load64(\u0026sched.lastpoll) != 0 { unlock(\u0026sched.lock) startm(_p_, false) return } // The scheduler lock cannot be held when calling wakeNetPoller below // because wakeNetPoller may call wakep which may call startm. // // å½“è°ƒç”¨wakeNetPolleræ—¶ï¼Œè°ƒåº¦å™¨é”ä¸èƒ½ä¿æŒï¼Œå› ä¸ºwakeNetPollerå¯èƒ½ä¼šè°ƒç”¨wakeepï¼Œè€Œåè€…å¯èƒ½ä¼šè°ƒç”¨startmã€‚ when := nobarrierWakeTime(_p_) // æœ€æ–°timerè§¦å‘æ—¶é—´ç‚¹ pidleput(_p_, 0) //æ— äº‹å¯åšï¼ŒæŠŠpæ”¾å…¥å…¨å±€ç©ºé—²é˜Ÿåˆ— unlock(\u0026sched.lock) if when != 0 { wakeNetPoller(when) } // èµ°åˆ°è¿™é‡Œä¸ä¼šæŠ¢å P } å“åº”æŠ¢å è¯·æ±‚ æŠ¢å çš„ç›¸å…³å‡½æ•°è°ƒç”¨é“¾morestack_noctxt()-\u003emorestack()-\u003enewstack()ã€‚ ä»æºä»£ç ä¸­morestack()å‡½æ•°çš„æ³¨é‡Šå¯ä»¥çŸ¥é“ï¼Œè¯¥å‡½æ•°ä¼šè¢«ç¼–è¯‘å™¨è‡ªåŠ¨æ’å…¥åˆ°å‡½æ•° åºè¨€(prologue) ä¸­ã€‚ morestack_noctxt() æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ 574 575 576 577 # morestack but not preserving ctxt. TEXT runtimeÂ·morestack_noctxt(SB),NOSPLIT,$0 MOVL $0, DX # DX = 0ï¼ŒDXå¯„å­˜å™¨è¢«ç”¨ä½œå‡½æ•°è°ƒç”¨çš„éšè—ä¼ å€¼ JMP\truntimeÂ·morestack(SB) # æ³¨æ„è¿™é‡Œä½¿ç”¨çš„æ˜¯JMPä¸æ˜¯CALLå› æ­¤ä¸æ˜¯å‡½æ•°è°ƒç”¨ æˆ‘ä»¬å‡è®¾æ˜¯åœ¨main.mainå‡½æ•°åºè¨€ä¸­è°ƒç”¨äº†morestack_noctxt()å‡½æ•°ï¼Œåˆ™å‡½æ•°çš„æ ˆå¸§ç»“æ„å¦‚ä¸‹ï¼š // +10 | // ---------------------------- runtime.main SP // +08 | runtime.main callback // ---------------------------- main.main SP // +00 | main.main callback // ---------------------------- morestack_noctxt SP // // runtimeÂ·morestack(SB)æ˜¯é€šè¿‡JMPè°ƒç”¨çš„ï¼Œæ‰€ä»¥æ²¡æœ‰é‡æ–°åˆ†é…æ ˆå¸§ morestack() å½“éœ€è¦æ›´å¤šæ ˆæ—¶ï¼Œåœ¨å‡½æ•°prologæœŸé—´è°ƒç”¨ã€‚ å›æº¯ä¾‹ç¨‹å°†g0ä¸Šçš„morestackè§†ä¸ºæ ˆçš„é¡¶éƒ¨(ä¾‹å¦‚ï¼Œmorestackè°ƒç”¨newstackè°ƒç”¨è°ƒåº¦å™¨è°ƒç”¨newmè°ƒç”¨gc)ï¼Œ å› æ­¤æˆ‘ä»¬å¿…é¡»è®°å½•å‚æ•°å¤§å°ã€‚ä¸ºæ­¤ï¼Œå®ƒæ²¡æœ‰å‚æ•°ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ è¯¥å‡½æ•°ï¼Œä¿æŠ¤è°ƒç”¨è€…ä¿¡æ¯ï¼Œåˆ‡æ¢åˆ°g0æ ˆè°ƒç”¨runtimeÂ·newstackæ–¹æ³•ã€‚ 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 # Called during function prolog when more stack is needed. # # The traceback routines see morestack on a g0 as being # the top of a stack (for example, morestack calling newstack # calling the scheduler calling newm calling gc), so we must # record an argument size. For that purpose, it has no arguments. TEXT runtimeÂ·morestack(SB),NOSPLIT,$0-0 # Cannot grow scheduler stack (m-\u003eg0). get_tls(CX) # CX = \u0026m.tls[1] MOVQ g(CX), BX # BX = m.tls[0] = g MOVQ g_m(BX), BX # BX = g.m MOVQ m_g0(BX), SI # SI = m.g0 CMPQ g(CX), SI # æ¯”è¾ƒå½“å‰gæ˜¯å¦æ˜¯g0 JNE\t3(PC) # åˆ¤æ–­ä¸ä¸ºé›¶æ—¶åˆ™è·³è½¬ # runtimeÂ·badmorestackg0 é”™è¯¯ä¿¡æ¯ \"morestack()å‡½æ•°åœ¨g0æ ˆä¸Šè¢«è°ƒç”¨\" CALL runtimeÂ·badmorestackg0(SB) # int 3 è¿›å…¥ä¸­æ–­æŒ‡ä»¤ï¼Œè¿™æ˜¯ä¸€ä¸ªè°ƒè¯•æŒ‡ä»¤ CALL runtimeÂ·abort(SB) # Cannot grow signal stack (m-\u003egsignal). MOVQ m_gsignal(BX), SI # SI = m.gsignal CMPQ g(CX), SI JNE\t3(PC) # åˆ¤æ–­ä¸ä¸ºé›¶æ—¶åˆ™è·³è½¬ # runtimeÂ·badmorestackgsignal é”™è¯¯ä¿¡æ¯ \"morestack()å‡½æ•°åœ¨gsignalä¸Šè¢«è°ƒç”¨\" CALL runtimeÂ·badmorestackgsignal(SB) CALL runtimeÂ·abort(SB) # Called from f. # Set m-\u003emorebuf to f's caller. # # ä»fè°ƒç”¨ã€‚è®¾ç½®m-\u003emorebufä¸ºfçš„è°ƒç”¨è€…ã€‚ # NOP SP æŒ‡ä»¤æ„ä¹‰ï¼š # 1. NOP SPæŒ‡ä»¤ä¸åšä»»ä½•æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä¼šå°†å †æ ˆæŒ‡é’ˆ(SP)å‘åç§»åŠ¨0ä¸ªå­—èŠ‚ï¼Œè¿™å®é™…ä¸Šæ˜¯æ²¡æœ‰ä»»ä½•æ•ˆæœçš„ã€‚ # 2. åœ¨ Go çš„æ±‡ç¼–è¯­è¨€ä¸­ï¼Œæœ‰æ—¶éœ€è¦ä½¿ç”¨ \"NOP SP\" è¿™æ¡æŒ‡ä»¤æ¥è¿›è¡ŒæŒ‡ä»¤å¯¹é½ï¼Œä½†è¿™ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´ vet å·¥å…·äº§ç”Ÿè¯¯æŠ¥ï¼Œå› ä¸ºå®ƒä¼šè®¤ä¸ºè¿™ä¼šå¯¼è‡´å †æ ˆåç§»é‡çš„æ”¹å˜ã€‚ # \"# tell vet SP changed - stop checking offsets\" è¿™è¡Œæ³¨é‡Šçš„æ„ä¹‰ï¼š # 1. ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œç¨‹åºå‘˜å¯ä»¥æ·»åŠ è¿™ä¸ªæ³¨é‡Šæ¥å‘Šè¯‰vetå·¥å…·ï¼Œå®é™…ä¸Šæ²¡æœ‰å¯¹å †æ ˆåç§»é‡è¿›è¡Œä»»ä½•æ›´æ”¹ï¼Œå› æ­¤vetå·¥å…·å¯ä»¥åœæ­¢æ£€æŸ¥å †æ ˆåç§»é‡ã€‚ # 2. è¿™å¥è¯çš„æ„æ€æ˜¯ï¼Œç¨‹åºå‘˜åœ¨æ·»åŠ NOP SPæŒ‡ä»¤æ—¶é‡åˆ°äº†vetå·¥å…·çš„è¯¯æŠ¥é—®é¢˜ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä»–ä»¬æ·»åŠ äº†è¿™ä¸ªæ³¨é‡Šï¼Œå‘Šè¯‰vetå·¥å…·ä¸éœ€è¦ç»§ç»­æ£€æŸ¥å †æ ˆåç§»é‡ã€‚ # æŒ‡ä»¤å¯¹é½ï¼šæ˜¯æŒ‡å°†æŒ‡ä»¤åœ°å€å¯¹é½åˆ°ä¸€å®šçš„è¾¹ç•Œä¸Šï¼Œä½¿å¾—æŒ‡ä»¤çš„æ‰§è¡Œæ•ˆç‡æ›´é«˜ã€‚ # 1. åœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼ŒCPU é€šå¸¸éœ€è¦ä»å†…å­˜ä¸­è¯»å–æŒ‡ä»¤å¹¶æ‰§è¡Œå®ƒä»¬ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸è€—æ—¶çš„è¿‡ç¨‹ã€‚ # 2. ä¸ºäº†æé«˜æ‰§è¡Œæ•ˆç‡ï¼ŒCPU éœ€è¦åœ¨è®¿é—®å†…å­˜æ—¶ä¿æŒä¸€å®šçš„å¯¹é½æ–¹å¼ï¼Œä»¥ä¾¿æ›´å¿«åœ°è¯»å–æŒ‡ä»¤å¹¶è¿›è¡Œå¤„ç†ã€‚ # 3. åœ¨æŒ‡ä»¤å¯¹é½ä¸­ï¼ŒæŒ‡ä»¤åœ°å€é€šå¸¸è¢«è¦æ±‚å¯¹é½åˆ°ä¸€ä¸ªç‰¹å®šçš„è¾¹ç•Œï¼Œé€šå¸¸æ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Œå¦‚2ã€4ã€8ç­‰ã€‚ # 4. è¿™æ„å‘³ç€æŒ‡ä»¤åœ°å€çš„ä½ä½å¿…é¡»æ˜¯0ï¼Œè¿™ä½¿å¾— CPU å¯ä»¥æ›´å¿«åœ°è¯»å–æŒ‡ä»¤å¹¶è¿›è¡Œå¤„ç†ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚ # 5. åœ¨ç¼–å†™æ±‡ç¼–è¯­è¨€ç¨‹åºæ—¶ï¼Œç¨‹åºå‘˜é€šå¸¸éœ€è¦æ‰‹åŠ¨å¯¹æŒ‡ä»¤è¿›è¡Œå¯¹é½ã€‚è¿™å¯ä»¥é€šè¿‡æ·»åŠ ä¸€äº›æ— æ“ä½œæŒ‡ä»¤ï¼Œå¦‚NOPæŒ‡ä»¤ï¼Œæ¥å®ç°ã€‚ # 6. è¿™äº›æŒ‡ä»¤ä¸ä¼šå¯¹ç¨‹åºçš„æ‰§è¡Œäº§ç”Ÿä»»ä½•å½±å“ï¼Œåªæ˜¯ç”¨æ¥å¡«å……æŒ‡ä»¤æµä¸­çš„ç©ºéš™ï¼Œä»¥ç¡®ä¿æŒ‡ä»¤åœ°å€å¯¹é½ã€‚ # 7. è¿™äº›æ“ä½œå¯ä»¥å¸®åŠ© CPU æ›´å¿«åœ°è¯»å–æŒ‡ä»¤å¹¶æé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚ NOP\tSP\t# tell vet SP changed - stop checking offsets # ä»¥ä¸‹ä»£ç ä¿å­˜è°ƒç”¨è€…ä¿¡æ¯ï¼Œæ¯”å¦‚åœ¨main.mainçš„åºè¨€ä¸­è°ƒäº†morestack_noctxt()-\u003emorestack()å‡½æ•°ï¼Œéœ€è¦ä¿å­˜çš„æ˜¯main.mainçš„ä¿¡æ¯ # 8(SP)ï¼šmainå‡½æ•°åœ¨è°ƒç”¨morestack_noctxtä¹‹å‰çš„rspå¯„å­˜å™¨ # é€šè¿‡ä¸Šé¢å‡½æ•°æ ˆå¸§çš„åˆ†é… 8(SP) æ˜¯runtime.mainå‡½æ•°çš„è¿”å›åœ°å€ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ä¿å­˜åœ¨mä¸Šçš„ï¼Œm-\u003emorebuf # ä¿å­˜åˆ°m-\u003emorebufç”¨äºæä¾›ç»™æ¥ä¸‹æ¥çš„newstack()å‡½æ•°ä½¿ç”¨ MOVQ 8(SP), AX\t# f's caller's PC; MOVQ AX, (m_morebuf+gobuf_pc)(BX) # m.morebuf.gobuf.pc=AX # 16(SP)ï¼šè°ƒç”¨è€…å‡½æ•°çš„SPï¼Œä¹Ÿå°±æ˜¯runtime.mainçš„SPå¯„å­˜å™¨åœ°å€ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ LEAQ æŒ‡ä»¤ LEAQ 16(SP), AX\t# f's caller's SP # AX = 16(SP); è¯¥å€¼æ˜¯runtime.mainå‡½æ•°çš„rspå¯„å­˜å™¨å­˜å‚¨çš„åœ°å€ MOVQ AX, (m_morebuf+gobuf_sp)(BX) # m.morebuf.gobuf.sp=AX get_tls(CX) # CX = \u0026m.tls[1] MOVQ g(CX), SI # SI = m.tls[0] = g; è¿™é‡Œæ˜¯gï¼Œä¸æ˜¯g0 MOVQ SI, (m_morebuf+gobuf_g)(BX) # m.morebuf.gobuf.g = g # åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»åœ¨m-\u003emorebufä¿å­˜å¥½äº†è°ƒç”¨è€…runtime.mainçš„ripã€rspã€gç›¸å…³ä¿¡æ¯ # Set g-\u003esched to context in f. # # å°† g-\u003esched è®¾ç½®ä¸ºfçš„ä¸Šä¸‹æ–‡ï¼Œè¿™æ‰æ˜¯éœ€è¦æ¢å¤çš„ç°åœºæ•°æ® # SPæ ˆé¡¶å¯„å­˜å™¨ç°åœ¨æŒ‡å‘çš„æ˜¯morestack_noctxtå‡½æ•°çš„è¿”å›åœ°å€ï¼Œæ³¨æ„ä¸‹é¢éƒ½æ˜¯ä¿å­˜åœ¨gä¸Šçš„ï¼Œg-\u003eschedä¸æ˜¯g0ä¸Š # 0(SP)ï¼šé€šè¿‡ä¸Šé¢å‡½æ•°æ ˆå¸§çš„åˆ†é… 0(SP) æ˜¯main.mainå‡½æ•°çš„è¿”å›åœ°å€ï¼Œä¹Ÿå°±æ˜¯ripä¸­çš„å€¼å°±æ˜¯main.mainçš„ä¸‹æ¡ä»£ç åœ°å€ MOVQ 0(SP), AX # f's PC # g.sched.gobuf.pc = AX MOVQ AX, (g_sched+gobuf_pc)(SI) # æ‰§è¡Œå®Œmorestack_noctxtå‡½æ•°ä¹‹ååº”è¯¥è¿”å›å»ç»§ç»­æ‰§è¡ŒæŒ‡ä»¤çš„åœ°å€ AX # 8(SP)ï¼šè°ƒç”¨è€…å‡½æ•°çš„SPï¼Œä¹Ÿå°±æ˜¯main.mainçš„SPå¯„å­˜å™¨åœ°å€ï¼Œè¿™ä¸ªåœ°å€æ˜¯æ²¡æœ‰å‹å…¥ripæŒ‡ä»¤æ•°æ®å‰çš„åœ°å€ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ LEAQ æŒ‡ä»¤ LEAQ 8(SP), AX # f's SP; MOVQ AX, (g_sched+gobuf_sp)(SI) # g.sched.gobuf.sp = AX # ç”±äºBPå¯„å­˜å™¨çš„å€¼ä¸€è‡´æ²¡æœ‰å˜ï¼Œæ‰€ä»¥è¿™é‡ŒBPå¯„å­˜å™¨è¿˜æ˜¯æŒ‡å‘main.mainçš„æ ˆåº• MOVQ BP, (g_sched+gobuf_bp)(SI) # g.sched.gobuf.bp = BP # DXå¯„å­˜å™¨è¢«è®¾ç½®ä¸ºäº†0ï¼Œåœ¨runtimeÂ·morestack_noctxt()å‡½æ•°ä¸­ MOVQ DX, (g_sched+gobuf_ctxt)(SI)# g.sched.gobuf.ctxt = DX; # åˆ°è¿™é‡Œå½“å‰g-\u003eschedå·²ä¿å­˜å¥½äº†æ¢å¤åˆ°main.mainçš„ç°åœºï¼ŒåŒ…æ‹¬ripã€rspã€rbpã€rdx # Call newstack on m-\u003eg0's stack. # åˆ‡æ¢åˆ°g0æ ˆï¼Œå¹¶è®¾ç½®tlsçš„gä¸ºg0 MOVQ m_g0(BX), BX # BX = g0 # è®¾ç½®TLSä¸­çš„gä¸ºg0 MOVQ BX, g(CX) # m.tls[0] = g0 # æŠŠg0æ ˆçš„æ ˆé¡¶å¯„å­˜å™¨çš„å€¼æ¢å¤åˆ°CPUçš„å¯„å­˜å™¨ï¼Œè¾¾åˆ°åˆ‡æ¢æ ˆçš„ç›®çš„ï¼Œä¸‹é¢è¿™ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œä¹‹å‰ï¼Œ # CPUè¿˜æ˜¯ä½¿ç”¨çš„è°ƒç”¨æ­¤å‡½æ•°çš„gçš„æ ˆï¼Œæ‰§è¡Œä¹‹åCPUå°±å¼€å§‹ä½¿ç”¨g0çš„æ ˆäº† MOVQ (g_sched+gobuf_sp)(BX), SP # rsp = g0.sched.gobuf.sp CALL runtimeÂ·newstack(SB) # è°ƒç”¨ newstack() å‡½æ•° CALL runtimeÂ·abort(SB) # crash if newstack returns RET æ±‡ç¼–è¯­è¨€\"int 3\"æ˜¯ä¸€ä¸ªä¸­æ–­æŒ‡ä»¤ï¼Œå®ƒå‘æ“ä½œç³»ç»Ÿå‘å‡ºä¸€ä¸ªè°ƒè¯•ä¿¡å·ï¼Œè¦æ±‚åœ¨ç¨‹åºçš„å½“å‰ä½ç½®åœæ­¢æ‰§è¡Œå¹¶è¿›å…¥è°ƒè¯•å™¨ã€‚ é€šå¸¸ï¼Œè°ƒè¯•å™¨ä¼šåœ¨æ­¤å¤„æš‚åœç¨‹åºçš„æ‰§è¡Œï¼Œå¹¶å…è®¸ç¨‹åºå‘˜æ£€æŸ¥ç¨‹åºçŠ¶æ€ã€å˜é‡å€¼å’Œç¨‹åºæµç¨‹ç­‰ä¿¡æ¯ï¼Œä»¥å¸®åŠ©ä»–ä»¬è°ƒè¯•ç¨‹åºã€‚ TEXT runtimeÂ·abort(SB),NOSPLIT,$0-0 INT\t$3 loop: JMP\tloop newstack() è¯¥å‡½æ•°ä¸»è¦æœ‰ä¸¤ä¸ªèŒè´£ï¼šä¸€ä¸ªæ˜¯ã€æ‰©æ ˆã€‘ï¼Œå¦ä¸€ä¸ªæ˜¯å“åº”sysmonæå‡ºçš„ã€æŠ¢å è¯·æ±‚ã€‘ã€‚ newstack()å‡½æ•°é¦–å…ˆæ£€æŸ¥g.stackguard0æ˜¯å¦è¢«è®¾ç½®ä¸ºstackPreemptï¼Œå¦‚æœæ˜¯åˆ™è¡¨ç¤ºsysmonå·²ç»å‘ç°æˆ‘ä»¬è¿è¡Œå¾—å¤ªä¹…äº†å¹¶å¯¹æˆ‘ä»¬å‘èµ·äº†æŠ¢å è¯·æ±‚ã€‚ å½“éœ€è¦æ›´å¤šå †æ ˆæ—¶ä»runtimeÂ·morestackè°ƒç”¨ã€‚åˆ†é…æ›´å¤§çš„å †æ ˆå¹¶é‡æ–°å®šä½åˆ°æ–°å †æ ˆã€‚å¯¹äºå›ºå®šçš„å¹³æ‘Šä»£ä»·ï¼Œå †æ ˆå¢é•¿æ˜¯ä¹˜æ³•çš„ã€‚ g-\u003eatomicstatuså°†åœ¨è¿›å…¥æ—¶è¿›è¡ŒGrunningæˆ–Gscanrunningã€‚è°ƒåº¦ç¨‹åºè¯•å›¾åœæ­¢è¿™ä¸ªgï¼Œç„¶åå®ƒå°†è®¾ç½®preemptStopã€‚ è¿™å¿…é¡»æ˜¯nowritebarrierrecï¼Œå› ä¸ºå®ƒå¯ä»¥ä½œä¸ºå †æ ˆå¢é•¿çš„ä¸€éƒ¨åˆ†ä»å…¶ä»–nowritebarrierrecå‡½æ•°è°ƒç”¨ï¼Œä½†ç¼–è¯‘å™¨ä¸ä¼šæ£€æŸ¥è¿™ä¸€ç‚¹ã€‚ go:nowritebarrierrecï¼šç¼–è¯‘å™¨ä¸æ’å…¥å†™å±éšœç›¸å…³ä»£ç ï¼ŒåŒ…æ‹¬å½“å‰å‡½æ•°ä»¥åŠè°ƒç”¨çš„ä»»ä½•å‡½æ•°ä¸­ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/stack.goã€‚ 950 951 952 953 954 955 956 957 958 959 960 961 962 963 964 965 966 967 968 969 970 971 972 973 974 975 976 977 978 979 980 981 982 983 984 985 986 987 988 989 990 991 992 993 994 995 996 997 998 999 1000 1001 1002 1003 1004 1005 1006 1007 1008 1009 1010 1011 1012 1013 1014 1015 1016 1017 1018 1019 1020 1021 1022 1023 1024 1025 1026 1027 1028 1029 1030 1031 1032 1033 1034 1035 1036 1037 1038 1039 1040 1041 1042 1043 1044 1045 1046 1047 1048 1049 1050 1051 1052 1053 1054 1055 1056 1057 1058 1059 1060 1061 1062 1063 1064 1065 1066 1067 1068 1069 1070 1071 1072 1073 1074 1075 1076 1077 1078 1079 1080 1081 1082 1083 1084 1085 1086 1087 1088 1089 1090 1091 1092 1093 1094 1095 1096 1097 1098 1099 1100 1101 1102 1103 1104 1105 1106 1107 1108 1109 1110 1111 1112 1113 1114 1115 1116 1117 1118 1119 1120 1121 1122 1123 1124 1125 1126 1127 1128 1129 1130 1131 1132 1133 1134 1135 1136 1137 1138 1139 1140 1141 1142 // Called from runtimeÂ·morestack when more stack is needed. // Allocate larger stack and relocate to new stack. // Stack growth is multiplicative, for constant amortized cost. // // g-\u003eatomicstatus will be Grunning or Gscanrunning upon entry. // If the scheduler is trying to stop this g, then it will set preemptStop. // // This must be nowritebarrierrec because it can be called as part of // stack growth from other nowritebarrierrec functions, but the // compiler doesn't check this. // //go:nowritebarrierrec func newstack() { thisg := getg() // thisg = g0; æ ¹æ®morestack()å‡½æ•°çš„ç›¸å…³ä»£ç  // TODO: double check all gp. shouldn't be getg(). // // æ ¹æ®morestack()å‡½æ•°çš„ç›¸å…³ä»£ç ï¼Œè¿™é‡Œthisg.m.morebuf.g.ptr()æ˜¯gä¸æ˜¯g0 if thisg.m.morebuf.g.ptr().stackguard0 == stackFork { throw(\"stack growth after fork\") } // m-\u003ecurg æ˜¯å½“å‰mä¸Šæ­£åœ¨è¿è¡Œçš„g if thisg.m.morebuf.g.ptr() != thisg.m.curg { print(\"runtime: newstack called from g=\", hex(thisg.m.morebuf.g), \"\\n\"+\"\\tm=\", thisg.m, \" m-\u003ecurg=\", thisg.m.curg, \" m-\u003eg0=\", thisg.m.g0, \" m-\u003egsignal=\", thisg.m.gsignal, \"\\n\") morebuf := thisg.m.morebuf traceback(morebuf.pc, morebuf.sp, morebuf.lr, morebuf.g.ptr()) throw(\"runtime: wrong goroutine in newstack\") } gp := thisg.m.curg // gp åœ¨è¿™é‡Œä¾‹å­æ˜¯runtime.mainçš„goroutine // g.throwsplit åœ¨ç³»ç»Ÿè°ƒç”¨å‰ä¼šè¢«è®¾ç½®ä¸ºtrueæˆ–å…¶ä»–åœ°æ–¹ã€‚å› æ­¤gå‡ºç°åœ¨è¿™é‡Œä¸åˆé€‚ã€‚ if thisg.m.curg.throwsplit { // Update syscallsp, syscallpc in case traceback uses them. morebuf := thisg.m.morebuf gp.syscallsp = morebuf.sp gp.syscallpc = morebuf.pc pcname, pcoff := \"(unknown)\", uintptr(0) f := findfunc(gp.sched.pc) if f.valid() { pcname = funcname(f) pcoff = gp.sched.pc - f.entry() } print(\"runtime: newstack at \", pcname, \"+\", hex(pcoff), \" sp=\", hex(gp.sched.sp), \" stack=[\", hex(gp.stack.lo), \", \", hex(gp.stack.hi), \"]\\n\", \"\\tmorebuf={pc:\", hex(morebuf.pc), \" sp:\", hex(morebuf.sp), \" lr:\", hex(morebuf.lr), \"}\\n\", \"\\tsched={pc:\", hex(gp.sched.pc), \" sp:\", hex(gp.sched.sp), \" lr:\", hex(gp.sched.lr), \" ctxt:\", gp.sched.ctxt, \"}\\n\") thisg.m.traceback = 2 // Include runtime frames traceback(morebuf.pc, morebuf.sp, morebuf.lr, gp) throw(\"runtime: stack split at bad time\") } // m.morebuf åœ¨ä¸Šé¢çš„morestackå‡½æ•°ä¸­è¢«è®¾ç½®ä¸ºè°ƒç”¨å‡½æ•°çš„ç›¸å…³ä¿¡æ¯ã€‚ morebuf := thisg.m.morebuf thisg.m.morebuf.pc = 0 thisg.m.morebuf.lr = 0 thisg.m.morebuf.sp = 0 thisg.m.morebuf.g = 0 // NOTE: stackguard0 may change underfoot, if another thread // is about to try to preempt gp. Read it just once and use that same // value now and below. // // æ³¨æ„ï¼šå¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹å³å°†å°è¯•æŠ¢å gpï¼Œstackguard0å¯èƒ½ä¼šåœ¨è„šä¸‹å‘ç”Ÿå˜åŒ–ã€‚ // åªéœ€é˜…è¯»ä¸€æ¬¡å¹¶åœ¨ç°åœ¨å’Œä¸‹é¢ä½¿ç”¨ç›¸åŒçš„å€¼ stackguard0 := atomic.Loaduintptr(\u0026gp.stackguard0) // è·å–gp.stackguard0 // Be conservative about where we preempt. // We are interested in preempting user Go code, not runtime code. // If we're holding locks, mallocing, or preemption is disabled, don't // preempt. // This check is very early in newstack so that even the status change // from Grunning to Gwaiting and back doesn't happen in this case. // That status change by itself can be viewed as a small preemption, // because the GC might change Gwaiting to Gscanwaiting, and then // this goroutine has to wait for the GC to finish before continuing. // If the GC is in some way dependent on this goroutine (for example, // it needs a lock held by the goroutine), that small preemption turns // into a real deadlock. preempt := stackguard0 == stackPreempt // åˆ¤æ–­å½“å‰æ˜¯å¦çœŸéœ€è¦è¢«æŠ¢å  if preempt { // canPreemptM -\u003e mp.locks == 0 \u0026\u0026 mp.mallocing == 0 \u0026\u0026 mp.preemptoff == \"\" \u0026\u0026 mp.p.ptr().status == _Prunning if !canPreemptM(thisg.m) { // canPreemptM(thisg.m); true.å¯ä»¥æŠ¢å ; false.ä¸å…è®¸æŠ¢å  // ä»¥ä¸‹æ˜¯ã€ä¸å…è®¸ã€‘æŠ¢å æ—¶ï¼Œå†æ¬¡æ¢å¤gpã€‚ // Let the goroutine keep running for now. // gp-\u003epreempt is set, so it will be preempted next time. // // ç°åœ¨è®©goroutineç»§ç»­è¿è¡Œã€‚gp-\u003epreemptå·²è®¾ç½®ï¼Œå› æ­¤ä¸‹æ¬¡å°†è¢«æŠ¢å ã€‚ // (gp-\u003epreemptåœ¨å‰é¢å·²è¢«è®¾ç½®ä¸ºtrue) // è¿˜åŸstackguard0ä¸ºæ­£å¸¸å€¼ï¼Œè¡¨ç¤ºæˆ‘ä»¬å·²ç»å¤„ç†è¿‡æŠ¢å è¯·æ±‚äº† gp.stackguard0 = gp.stack.lo + _StackGuard // æ¢å¤gpï¼Œè¿™é‡Œæ°¸è¿œä¸ä¼šè¿”å› gogo(\u0026gp.sched) // never return } } if gp.stack.lo == 0 { throw(\"missing stack in newstack\") } sp := gp.sched.sp if goarch.ArchFamily == goarch.AMD64 || goarch.ArchFamily == goarch.I386 || goarch.ArchFamily == goarch.WASM { // The call to morestack cost a word. sp -= goarch.PtrSize } if stackDebug \u003e= 1 || sp \u003c gp.stack.lo { print(\"runtime: newstack sp=\", hex(sp), \" stack=[\", hex(gp.stack.lo), \", \", hex(gp.stack.hi), \"]\\n\", \"\\tmorebuf={pc:\", hex(morebuf.pc), \" sp:\", hex(morebuf.sp), \" lr:\", hex(morebuf.lr), \"}\\n\", \"\\tsched={pc:\", hex(gp.sched.pc), \" sp:\", hex(gp.sched.sp), \" lr:\", hex(gp.sched.lr), \" ctxt:\", gp.sched.ctxt, \"}\\n\") } if sp \u003c gp.stack.lo { print(\"runtime: gp=\", gp, \", goid=\", gp.goid, \", gp-\u003estatus=\", hex(readgstatus(gp)), \"\\n \") print(\"runtime: split stack overflow: \", hex(sp), \" \u003c \", hex(gp.stack.lo), \"\\n\") throw(\"runtime: split stack overflow\") } // åˆ¤æ–­æŠ¢å ï¼Œå‘èµ·æŠ¢å  if preempt { if gp == thisg.m.g0 { throw(\"runtime: preempt g0\") } if thisg.m.p == 0 \u0026\u0026 thisg.m.locks == 0 { throw(\"runtime: g is running but p is not\") } if gp.preemptShrink { // We're at a synchronous safe point now, so // do the pending stack shrink. gp.preemptShrink = false shrinkstack(gp) } // åœæ­¢æŠ¢å ï¼Œå¼€å¯ä¸‹ä¸€æ¬¡è°ƒåº¦å¾ªç¯,makerootæœŸé—´æ”¹å€¼ä¼šè¢«è®¾ç½®ä¸ºtrueã€‚ if gp.preemptStop {\tpreemptPark(gp) // never returns } // Act like goroutine called runtime.Gosched. // // åƒè°ƒç”¨ runtime.Gosched çš„ goroutine ä¸€æ · // è°ƒç”¨gopreempt_mæŠŠgpåˆ‡æ¢å‡ºå»ï¼ŒæŠ¢å è¿™ä¸ªgoroutineæˆåŠŸäº† gopreempt_m(gp) // never return } // ä¸‹é¢ä»£ç æ˜¯æ‰©å¤§æ ˆç›¸å…³ä»£ç  // Allocate a bigger segment and move the stack. oldsize := gp.stack.hi - gp.stack.lo newsize := oldsize * 2 // æ‰©å¤§ä¸ºåŸæ¥çš„2å€ // Make sure we grow at least as much as needed to fit the new frame. // (This is just an optimization - the caller of morestack will // recheck the bounds on return.) if f := findfunc(gp.sched.pc); f.valid() { max := uintptr(funcMaxSPDelta(f)) needed := max + _StackGuard used := gp.stack.hi - gp.sched.sp for newsize-used \u003c needed { newsize *= 2 } } if stackguard0 == stackForceMove { // Forced stack movement used for debugging. // Don't double the stack (or we may quickly run out // if this is done repeatedly). newsize = oldsize } if newsize \u003e maxstacksize || newsize \u003e maxstackceiling { if maxstacksize \u003c maxstackceiling { print(\"runtime: goroutine stack exceeds \", maxstacksize, \"-byte limit\\n\") } else { print(\"runtime: goroutine stack exceeds \", maxstackceiling, \"-byte limit\\n\") } print(\"runtime: sp=\", hex(sp), \" stack=[\", hex(gp.stack.lo), \", \", hex(gp.stack.hi), \"]\\n\") throw(\"stack overflow\") } // The goroutine must be executing in order to call newstack, // so it must be Grunning (or Gscanrunning). casgstatus(gp, _Grunning, _Gcopystack) // The concurrent GC will not scan the stack while we are doing the copy since // the gp is in a Gcopystack status. copystack(gp, newsize) if stackDebug \u003e= 1 { print(\"stack grow done\\n\") } casgstatus(gp, _Gcopystack, _Grunning) gogo(\u0026gp.sched) // å†æ¬¡æ¢å¤è¿™ä¸ªgoroutine } canPreemptM canPreemptMæŠ¥å‘Šmpæ˜¯å¦å¤„äºå¯ä»¥å®‰å…¨æŠ¢å çš„çŠ¶æ€ã€‚ å®ƒæ˜¯nosplitå› ä¸ºå®ƒæœ‰nosplitçš„è°ƒç”¨è€…ã€‚ go:nosplitï¼šå‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦åœ¨å½“å‰å‡½æ•°ä¸­æ’å…¥ä»»ä½•æ ˆæ‰©å±•ä»£ç ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿å½“å‰å‡½æ•°ä¸ä¼šå¯¼è‡´æ ˆçš„å¤§å°å‘ç”Ÿå˜åŒ–ã€‚ åœ¨Goè¯­è¨€ä¸­ï¼Œæ¯ä¸ªgoroutineéƒ½æœ‰ä¸€ä¸ªå›ºå®šçš„æ ˆå¤§å°ï¼Œå½“æ ˆçš„å¤§å°ä¸è¶³ä»¥å®¹çº³å½“å‰å‡½æ•°çš„æ‰§è¡Œæ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ ˆæº¢å‡ºé”™è¯¯ã€‚ å› æ­¤ï¼Œä½¿ç”¨\"go:nosplit\"æŒ‡ä»¤å¯ä»¥ç¡®ä¿å‡½æ•°çš„æ‰§è¡Œä¸ä¼šå¯¼è‡´æ ˆçš„å¤§å°å‘ç”Ÿå˜åŒ–ï¼Œä»è€Œé¿å…æ ˆæº¢å‡ºé”™è¯¯çš„å‘ç”Ÿã€‚è¿™ä¸ªæŒ‡ä»¤é€šå¸¸ç”¨äºä¸€äº›å…³é”®æ€§çš„å‡½æ•°ä¸­ï¼Œæ¯”å¦‚åƒåœ¾å›æ”¶å™¨å’Œè°ƒåº¦å™¨ç­‰ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨\"go:nosplit\"æŒ‡ä»¤å¯èƒ½ä¼šå½±å“ç¨‹åºçš„æ€§èƒ½ã€‚å› ä¸ºä¸å†æ’å…¥æ ˆæ‰©å±•ä»£ç ï¼Œè¿™æ„å‘³ç€åœ¨æ‰§è¡Œå‡½æ•°æ—¶ï¼Œæ ˆçš„å¤§å°ä¸ä¼šåŠ¨æ€è°ƒæ•´ã€‚å› æ­¤ï¼Œç¨‹åºå‘˜éœ€è¦åœ¨ä½¿ç”¨\"go:nosplit\"æŒ‡ä»¤æ—¶ä»”ç»†è€ƒè™‘æ€§èƒ½å’Œæ ˆæº¢å‡ºé”™è¯¯ä¹‹é—´çš„æƒè¡¡ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/preempt.goã€‚ 282 283 284 285 286 287 288 289 290 291 292 293 294 295 // canPreemptM reports whether mp is in a state that is safe to preempt. // // It is nosplit because it has nosplit callers. // //go:nosplit func canPreemptM(mp *m) bool { // èƒ½å¦æŠ¢å æ¡ä»¶ï¼štrue.èƒ½æŠ¢å ï¼Œfalse.ä¸èƒ½æŠ¢å ã€‚ // 1. mp.locks == 0ï¼šè¡¨ç¤ºå½“å‰goroutineæŒæœ‰çš„äº’æ–¥é”æ•°é‡ï¼Œæ²¡åˆ°0æ—¶ï¼Œä¸åº”è¯¥è¢«æŠ¢å ã€‚ // 2. mp.mallocing == 0ï¼šå½“å‰goroutineæ­£åœ¨åˆ†é…å†…å­˜ï¼Œä¸åº”è¯¥è¢«æŠ¢å ã€‚ // 3. mp.preemptoffï¼šå¦‚æœè¯¥å€¼è¢«è®¾ç½®ä¸ºéç©ºå­—ç¬¦ä¸²ï¼Œåˆ™è¡¨ç¤ºå½“å‰goroutineä¸åº”è¯¥è¢«æŠ¢å ã€‚ // 4. mp.p.ptr().status == _Prunningï¼šå½“å‰Pæ­£åœ¨è¿è¡Œä¸­ã€‚ // æ»¡è¶³ä»¥ä¸Šæ¡ä»¶åˆ™èƒ½æŠ¢å gã€‚è¯¥å‡½æ•°ä¹Ÿä¼šåœ¨ä¿¡å·æŠ¢å å‡½æ•°isAsyncPreempt()å‡½æ•°ä¸­è°ƒç”¨ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦å…è®¸æŠ¢å  return mp.locks == 0 \u0026\u0026 mp.mallocing == 0 \u0026\u0026 mp.preemptoff == \"\" \u0026\u0026 mp.p.ptr().status == _Prunning } gopreempt_m æŠ¢å è°ƒåº¦ï¼Œåé€»è¾‘å’Œruntime.Goschedä¸€æ ·ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 3402 3403 3404 3405 3406 3407 func gopreempt_m(gp *g) { if trace.enabled { traceGoPreempt() } goschedImpl(gp) } ç³»ç»Ÿè°ƒç”¨å‰å handoffp()ï¼Œå¯¹æ­£åœ¨è¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„goroutineçš„æŠ¢å å®è´¨ä¸Šæ˜¯å‰¥å¤ºä¸å…¶å¯¹åº”çš„å·¥ä½œçº¿ç¨‹æ‰€ç»‘å®šçš„pã€‚ è™½ç„¶è¯´å¤„äºç³»ç»Ÿè°ƒç”¨ä¹‹ä¸­çš„å·¥ä½œçº¿ç¨‹å¹¶ä¸éœ€è¦pï¼Œä½†ä¸€æ—¦ä»æ“ä½œç³»ç»Ÿå†…æ ¸è¿”å›åˆ°ç”¨æˆ·ç©ºé—´ä¹‹åå°±å¿…é¡»ç»‘å®šä¸€ä¸ªpæ‰èƒ½è¿è¡Œgoä»£ç ã€‚ ç³»ç»Ÿè°ƒç”¨ Syscall6() ç³»ç»Ÿè°ƒç”¨æ—¶æœ€ç»ˆä¼šè°ƒç”¨è¯¥æ±‡ç¼–å‡½æ•°ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/syscall/asm_unix_amd64.sã€‚ å‡½æ•°åŸå‹ï¼šfunc Syscall6(num, a1, a2, a3, a4, a5, a6 uintptr) (r1, r2, errno uintptr)ã€‚ 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 TEXT Â·Syscall6(SB),NOSPLIT,$0-80 # è°ƒç”¨ runtime.entersyscall å‡½æ•°ï¼Œä¿å­˜ç°åœºè§£é™¤ç»‘å®šå…³ç³» CALL runtimeÂ·entersyscall\u003cABIInternal\u003e(SB) # ç³»ç»Ÿè°ƒç”¨å‚æ•°ï¼ŒæŒ‰ç…§linuxç³»ç»Ÿçº¦å®šå¯„å­˜å™¨å¹¶è°ƒç”¨SYSCALLæ‰§è¡Œè¿›å…¥å†…æ ¸ã€‚ # ç³»ç»Ÿè°ƒç”¨ç¼–å·æ”¾å…¥AXã€‚ MOVQ trap+0(FP), AX # syscall entry MOVQ a1+8(FP), DI MOVQ a2+16(FP), SI MOVQ a3+24(FP), DX MOVQ a4+32(FP), R10 MOVQ a5+40(FP), R8 MOVQ a6+48(FP), R9 SYSCALL # è¿›å…¥å†…æ ¸ # ä»å†…æ ¸è¿”å›ï¼Œåˆ¤æ–­æ ‡è¯†æ˜¯å¦è·³è½¬ JCC\tok6 MOVQ $-1, r1+56(FP) # r1 MOVQ $0, r2+64(FP) # r2 MOVQ AX, err+72(FP) # errno CALL runtimeÂ·exitsyscall\u003cABIInternal\u003e(SB) RET ok6: # ç³»ç»Ÿè°ƒç”¨è¿”å›çš„å€¼ä¿å­˜æ ˆ MOVQ AX, r1+56(FP) # r1 MOVQ DX, r2+64(FP) # r2 MOVQ $0, err+72(FP) # errno CALL runtimeÂ·exitsyscall\u003cABIInternal\u003e(SB) RET ç³»ç»Ÿè°ƒç”¨å‰ entersyscall() goç³»ç»Ÿè°ƒç”¨åº“å’Œæ™®é€šcgoè°ƒç”¨ä½¿ç”¨çš„æ ‡å‡†ç³»ç»Ÿè°ƒç”¨é¡¹ã€‚ è¿™æ˜¯é€šè¿‡syscallåŒ…å’Œx/sysä¸­çš„é“¾æ¥åå¯¼å‡ºåˆ°ç¨‹åºé›†çš„ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 3672 3673 3674 3675 3676 3677 3678 3679 3680 3681 3682 // Standard syscall entry used by the go syscall library and normal cgo calls. // // This is exported via linkname to assembly in the syscall package and x/sys. // //go:nosplit //go:linkname entersyscall func entersyscall() { // getcallerpc()ï¼šè°ƒç”¨è€…å½“å‰PCå€¼ã€‚ // getcallersp()ï¼šè°ƒç”¨è€…å½“å‰SPå€¼ã€‚ reentersyscall(getcallerpc(), getcallersp()) } reentersyscall() æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 3575 3576 3577 3578 3579 3580 3581 3582 3583 3584 3585 3586 3587 3588 3589 3590 3591 3592 3593 3594 3595 3596 3597 3598 3599 3600 3601 3602 3603 3604 3605 3606 3607 3608 3609 3610 3611 3612 3613 3614 3615 3616 3617 3618 3619 3620 3621 3622 3623 3624 3625 3626 3627 3628 3629 3630 3631 3632 3633 3634 3635 3636 3637 3638 3639 3640 3641 3642 3643 3644 3645 3646 3647 3648 3649 3650 3651 3652 3653 3654 3655 3656 3657 3658 3659 3660 3661 3662 3663 3664 3665 3666 3667 3668 3669 3670 3671 3672 3673 3674 3675 3676 3677 3678 3679 3680 3681 3682 3683 3684 3685 3686 3687 3688 // The goroutine g is about to enter a system call. // Record that it's not using the cpu anymore. // This is called only from the go syscall library and cgocall, // not from the low-level system calls used by the runtime. // // Entersyscall cannot split the stack: the save must // make g-\u003esched refer to the caller's stack segment, because // entersyscall is going to return immediately after. // // Nothing entersyscall calls can split the stack either. // We cannot safely move the stack during an active call to syscall, // because we do not know which of the uintptr arguments are // really pointers (back into the stack). // In practice, this means that we make the fast path run through // entersyscall doing no-split things, and the slow path has to use systemstack // to run bigger things on the system stack. // // reentersyscall is the entry point used by cgo callbacks, where explicitly // saved SP and PC are restored. This is needed when exitsyscall will be called // from a function further up in the call stack than the parent, as g-\u003esyscallsp // must always point to a valid stack frame. entersyscall below is the normal // entry point for syscalls, which obtains the SP and PC from the caller. // // Syscall tracing: // At the start of a syscall we emit traceGoSysCall to capture the stack trace. // If the syscall does not block, that is it, we do not emit any other events. // If the syscall blocks (that is, P is retaken), retaker emits traceGoSysBlock; // when syscall returns we emit traceGoSysExit and when the goroutine starts running // (potentially instantly, if exitsyscallfast returns true) we emit traceGoStart. // To ensure that traceGoSysExit is emitted strictly after traceGoSysBlock, // we remember current value of syscalltick in m (_g_.m.syscalltick = _g_.m.p.ptr().syscalltick), // whoever emits traceGoSysBlock increments p.syscalltick afterwards; // and we wait for the increment before emitting traceGoSysExit. // Note that the increment is done even if tracing is not enabled, // because tracing can be enabled in the middle of syscall. We don't want the wait to hang. // //go:nosplit func reentersyscall(pc, sp uintptr) { // user goroutine _g_ := getg() // æ‰§è¡Œç³»ç»Ÿè°ƒç”¨çš„goroutine // Disable preemption because during this function g is in Gsyscall status, // but can have inconsistent g-\u003esched, do not let GC observe it. // // ç¦ç”¨æŠ¢å ï¼Œå› ä¸ºåœ¨è¿™ä¸ªåŠŸèƒ½æœŸé—´gå¤„äºGsyscallçŠ¶æ€ï¼Œä½†å¯èƒ½æœ‰ä¸ä¸€è‡´çš„g-\u003eschedï¼Œä¸è¦è®©GCè§‚å¯Ÿå®ƒã€‚ _g_.m.locks++ // Entersyscall must not call any function that might split/grow the stack. // (See details in comment above.) // Catch calls that might, by replacing the stack guard with something that // will trip any stack check and leaving a flag to tell newstack to die. _g_.stackguard0 = stackPreempt // è®¾ç½®æŠ¢å ï¼Œåœ¨è°ƒç”¨è¿”å›æ—¶ä¼šä¿®æ”¹å›æ¥ // ä¸èƒ½æ‰©å±•æ ˆï¼Œåœ¨è°ƒç”¨è¿”å›æ—¶ä¼šä¿®æ”¹å›æ¥ _g_.throwsplit = true // Leave SP around for GC and traceback. save(pc, sp) // ä¿å­˜gçš„ç°åœºä¿¡æ¯ï¼Œrspï¼Œrbpï¼Œripç­‰ _g_.syscallsp = sp _g_.syscallpc = pc // ç›‘æ§çº¿ç¨‹ä¾èµ–_GsyscallçŠ¶æ€å®æ–½ç³»ç»Ÿè°ƒç”¨æ—¶çš„æŠ¢å  casgstatus(_g_, _Grunning, _Gsyscall) // åˆ‡æ¢gçŠ¶æ€ä¸ºç³»ç»Ÿè°ƒç”¨ä¸­ // SPæ˜¯å¦åœ¨goroutineçš„æ ˆèŒƒå›´å†… if _g_.syscallsp \u003c _g_.stack.lo || _g_.stack.hi \u003c _g_.syscallsp { systemstack(func() { print(\"entersyscall inconsistent \", hex(_g_.syscallsp), \" [\", hex(_g_.stack.lo), \",\", hex(_g_.stack.hi), \"]\\n\") throw(\"entersyscall\") }) } if trace.enabled { systemstack(traceGoSysCall) // systemstack itself clobbers g.sched.{pc,sp} and we might // need them later when the G is genuinely blocked in a // syscall save(pc, sp) } // sysmon ç›‘æ§çº¿ç¨‹æ­£æŒ‚èµ·åœ¨ sched.sysmonwait if atomic.Load(\u0026sched.sysmonwait) != 0 { // åˆ‡æ¢åˆ°g0æ ˆè°ƒç”¨ entersyscall_sysmon å‡½æ•° // entersyscall_sysmon å‡½æ•°å”¤é†’ sysmon ç›‘æ§çº¿ç¨‹ systemstack(entersyscall_sysmon) save(pc, sp) } if _g_.m.p.ptr().runSafePointFn != 0 { // runSafePointFn may stack split if run on this stack systemstack(runSafePointFn) save(pc, sp) } // æŠŠPçš„è°ƒç”¨æ¬¡æ•°æ‹·è´ç»™M _g_.m.syscalltick = _g_.m.p.ptr().syscalltick _g_.sysblocktraced = true // Må’ŒPç›¸äº’è§£é™¤å…³è”ï¼Œå¹¶æŠŠPæš‚å­˜ä¸m.oldpä¸­ï¼Œ // ç­‰å¾…ç³»ç»Ÿè°ƒç”¨å®Œåä½¿ç”¨ // è§£é™¤p.må…³è”çš„m pp := _g_.m.p.ptr() // pp = p pp.m = 0 // m.oldp = pp _g_.m.oldp.set(pp) // è§£é™¤ m.p çš„å…³ç³» p _g_.m.p = 0 atomic.Store(\u0026pp.status, _Psyscall) // pp.status = _Psyscall // STWæ­£åœ¨ç­‰å¾…æ—¶ if sched.gcwaiting != 0 { // åˆ‡æ¢åˆ°g0æ ˆè°ƒç”¨entersyscall_gcwaitå‡½æ•° // entersyscall_gcwaitå‡½æ•°ï¼Œå°†PçŠ¶æ€è®¾ç½®ä¸º _Pgcstopï¼Œå¦‚æœSTWå·²å®Œæˆåˆ™å”¤é†’åœ¨sched.stopnoteä¸Šç­‰å¾…çš„STWå‘èµ·çš„çº¿ç¨‹ã€‚ systemstack(entersyscall_gcwait) save(pc, sp) } _g_.m.locks-- } save() ä¿å­˜goroutineç°åœºã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 3543 3544 3545 3546 3547 3548 3549 3550 3551 3552 3553 3554 3555 3556 3557 3558 3559 3560 3561 3562 3563 3564 3565 3566 3567 3568 3569 3570 3571 3572 3573 // save updates getg().sched to refer to pc and sp so that a following // gogo will restore pc and sp. // // save must not have write barriers because invoking a write barrier // can clobber getg().sched. // //go:nosplit //go:nowritebarrierrec func save(pc, sp uintptr) { gp := getg() if gp == gp.m.g0 || gp == gp.m.gsignal { // m.g0.sched is special and must describe the context // for exiting the thread. mstart1 writes to it directly. // m.gsignal.sched should not be used at all. // This check makes sure save calls do not accidentally // run in contexts where they'd write to system g's. throw(\"save on system g not allowed\") } gp.sched.pc = pc gp.sched.sp = sp gp.sched.lr = 0 gp.sched.ret = 0 // We need to ensure ctxt is zero, but can't have a write // barrier here. However, it should always already be zero. // Assert that. if gp.sched.ctxt != nil { badctxt() } } ç³»ç»Ÿè°ƒç”¨å exitsyscall() è¿™ä¸ªgoroutine gé€€å‡ºç³»ç»Ÿè°ƒç”¨ã€‚å®‰æ’å®ƒå†æ¬¡åœ¨cpuä¸Šè¿è¡Œã€‚ è¿™ä»…ä»goç³»ç»Ÿè°ƒç”¨åº“ä¸­è°ƒç”¨ï¼Œè€Œä¸æ˜¯ä»è¿è¡Œæ—¶ä½¿ç”¨çš„ä½çº§ç³»ç»Ÿè°ƒç”¨ä¸­è°ƒç”¨ã€‚ å†™å±éšœæ˜¯ä¸è¢«å…è®¸çš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„På¯èƒ½è¢«å·äº†ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 3761 3762 3763 3764 3765 3766 3767 3768 3769 3770 3771 3772 3773 3774 3775 3776 3777 3778 3779 3780 3781 3782 3783 3784 3785 3786 3787 3788 3789 3790 3791 3792 3793 3794 3795 3796 3797 3798 3799 3800 3801 3802 3803 3804 3805 3806 3807 3808 3809 3810 3811 3812 3813 3814 3815 3816 3817 3818 3819 3820 3821 3822 3823 3824 3825 3826 3827 3828 3829 3830 3831 3832 3833 3834 3835 3836 3837 3838 3839 3840 3841 3842 3843 3844 3845 3846 3847 3848 3849 3850 3851 3852 3853 3854 3855 3856 3857 3858 3859 3860 3861 3862 3863 3864 3865 3866 // The goroutine g exited its system call. // Arrange for it to run on a cpu again. // This is called only from the go syscall library, not // from the low-level system calls used by the runtime. // // Write barriers are not allowed because our P may have been stolen. // // This is exported via linkname to assembly in the syscall package. // //go:nosplit //go:nowritebarrierrec //go:linkname exitsyscall func exitsyscall() { // user goroutine _g_ := getg() // goroutine g _g_.m.locks++ // see comment in entersyscall if getcallersp() \u003e _g_.syscallsp { throw(\"exitsyscall: syscall frame is no longer valid\") } // g.waitsinceï¼Œgè¢«é˜»å¡çš„å¤§çº¦æ—¶é—´ _g_.waitsince = 0 // è¿›å…¥ç³»ç»Ÿè°ƒç”¨ä¹‹å‰æ‰€ç»‘å®šçš„p oldp := _g_.m.oldp.ptr() _g_.m.oldp = 0 // exitsyscallfast å°è¯•ç»‘å®šPï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›falseã€‚ if exitsyscallfast(oldp) { // When exitsyscallfast returns success, we have a P so can now use // write barriers if goroutineProfile.active { // Make sure that gp has had its stack written out to the goroutine // profile, exactly as it was when the goroutine profiler first // stopped the world. systemstack(func() { tryRecordGoroutineProfileWB(_g_) }) } if trace.enabled { if oldp != _g_.m.p.ptr() || _g_.m.syscalltick != _g_.m.p.ptr().syscalltick { systemstack(traceGoStart) } } // There's a cpu for us, so we can run. _g_.m.p.ptr().syscalltick++ // We need to cas the status and scan before resuming... casgstatus(_g_, _Gsyscall, _Grunning) // Garbage collector isn't running (since we are), // so okay to clear syscallsp. _g_.syscallsp = 0 _g_.m.locks-- if _g_.preempt { // restore the preemption request in case we've cleared it in newstack // æ¢å¤æŠ¢å è¯·æ±‚ï¼Œä»¥é˜²æˆ‘ä»¬åœ¨newstackä¸­æ¸…é™¤äº†å®ƒ _g_.stackguard0 = stackPreempt } else { // otherwise restore the real _StackGuard, we've spoiled it in entersyscall/entersyscallblock // å¦åˆ™æ¢å¤çœŸæ­£çš„_StackGuardï¼Œæˆ‘ä»¬å·²ç»åœ¨entersyscall/entersyscallblockä¸­ç ´åäº†å®ƒ _g_.stackguard0 = _g_.stack.lo + _StackGuard } _g_.throwsplit = false // sched.disable.user == trueï¼Œç”¨æˆ·goroutineè¢«ç¦æ­¢è¿è¡Œ // schedEnabledåˆ¤æ–­gæ˜¯å¦æ˜¯ç³»ç»Ÿgoroutine if sched.disable.user \u0026\u0026 !schedEnabled(_g_) { // Scheduling of this goroutine is disabled. Gosched() // è®©å‡ºCPUï¼Œå½“å‰goroutineã€‚ } return } // Mç»‘å®šPæ²¡æœ‰æˆåŠŸæ—¶ã€‚ _g_.sysexitticks = 0 if trace.enabled { // Wait till traceGoSysBlock event is emitted. // This ensures consistency of the trace (the goroutine is started after it is blocked). for oldp != nil \u0026\u0026 oldp.syscalltick == _g_.m.syscalltick { osyield() } // We can't trace syscall exit right now because we don't have a P. // Tracing code can invoke write barriers that cannot run without a P. // So instead we remember the syscall exit time and emit the event // in execute when we have a P. _g_.sysexitticks = cputicks() } _g_.m.locks-- // Call the scheduler. // // æ²¡æœ‰ç»‘å®šåˆ°pï¼Œè°ƒç”¨mcallåˆ‡æ¢åˆ°g0æ ˆæ‰§è¡Œexitsyscall0å‡½æ•° mcall(exitsyscall0) // mcallå‡½æ•°ä¼šä¿å­˜ç°åœºï¼Œåˆ‡æ¢g0è°ƒç”¨exitsyscall0å‡½æ•° // Scheduler returned, so we're allowed to run now. // Delete the syscallsp information that we left for // the garbage collector during the system call. // Must wait until now because until gosched returns // we don't know for sure that the garbage collector // is not running. _g_.syscallsp = 0 _g_.m.p.ptr().syscalltick++ _g_.throwsplit = false } exitsyscallfast() å°è¯•ç»‘å®šä¸€ä¸ªç©ºé—²çš„Pã€‚true.ç»‘å®šæˆåŠŸï¼Œfalse.ç»‘å®šå¤±è´¥ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 3856 3857 3858 3859 3860 3861 3862 3863 3864 3865 3866 3867 3868 3869 3870 3871 3872 3873 3874 3875 3876 3877 3878 3879 3880 3881 3882 3883 3884 3885 3886 3887 3888 3889 3890 3891 3892 3893 3894 3895 3896 3897 3898 3899 3900 3901 3902 3903 3904 //go:nosplit func exitsyscallfast(oldp *p) bool { _g_ := getg() // g // Freezetheworld sets stopwait but does not retake P's. // // Freezetheworld è®¾ç½®åœæ­¢ç­‰å¾…ï¼Œä½†ä¸é‡æ–°è·å–Pã€‚ // const freezeStopWait int = 0x7fffffff if sched.stopwait == freezeStopWait { return false } // Try to re-acquire the last P. // // è¯•ç€é‡æ–°è·å–last Pã€‚ if oldp != nil \u0026\u0026 oldp.status == _Psyscall \u0026\u0026 atomic.Cas(\u0026oldp.status, _Psyscall, _Pidle) { // There's a cpu for us, so we can run. // æˆ‘ä»¬æœ‰cpuï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿è¡Œã€‚ wirep(oldp) // ç»‘å®šP exitsyscallfast_reacquired() // å¤„ç†Pçš„syscalltickå­—æ®µ return true } // Try to get any other idle P. // // å°è¯•è·å–ä¸€ä¸ªç©ºé—²çš„Pã€‚ if sched.pidle != 0 { var ok bool // åˆ‡æ¢åˆ°g0æ ˆ systemstack(func() { // ä»å…¨å±€é˜Ÿåˆ—ä¸­å¯»æ‰¾ç©ºé—²çš„pï¼Œéœ€è¦åŠ é”ï¼Œæ¯”è¾ƒæ…¢ ok = exitsyscallfast_pidle() // æ¬åˆ°æˆåŠŸè¿”å›trueï¼Œç»‘å®šå¤±è´¥è¿”å›falseã€‚ if ok \u0026\u0026 trace.enabled { if oldp != nil { // Wait till traceGoSysBlock event is emitted. // This ensures consistency of the trace (the goroutine is started after it is blocked). for oldp.syscalltick == _g_.m.syscalltick { osyield() } } traceGoSysExit(0) } }) if ok { return true } } return false } exitsyscallfast_pidle() æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 3913 3914 3915 3916 3917 3918 3919 3920 3921 3922 3923 3924 3925 3926 3927 func exitsyscallfast_pidle() bool { lock(\u0026sched.lock) _p_, _ := pidleget(0) // å¤„ç†sysmonï¼Œå› ä¸ºåœ¨é™·å…¥åˆ°ç³»ç»Ÿè°ƒç”¨æ˜¯sysmonå¯èƒ½è‡ªå·±æŠŠè‡ªå·±æŒ‚èµ·ï¼Œæ‰€ä»¥éœ€è¦æ¢å¤ if _p_ != nil \u0026\u0026 atomic.Load(\u0026sched.sysmonwait) != 0 { atomic.Store(\u0026sched.sysmonwait, 0) notewakeup(\u0026sched.sysmonnote) } unlock(\u0026sched.lock) if _p_ != nil { acquirep(_p_) // ç»‘å®šPå¦‚æœæœ‰çš„è¯ return true } return false } exitsyscall0() exitsyscallåœ¨g0ä¸Šçš„æ…¢è·¯å¾„ã€‚è·å–På¤±è´¥å°†gpæ”¾å…¥å¯è¿è¡Œé˜Ÿåˆ—ä¸­ã€‚ é€šè¿‡mcall()è°ƒç”¨ï¼Œgpæ˜¯ä»è¿™ä¸ªMè°ƒç”¨gã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 3934 3935 3936 3937 3938 3939 3940 3941 3942 3943 3944 3945 3946 3947 3948 3949 3950 3951 3952 3953 3954 3955 3956 3957 3958 3959 3960 3961 3962 3963 3964 3965 3966 3967 3968 3969 3970 3971 3972 3973 3974 3975 3976 3977 3978 3979 3980 3981 3982 3983 3984 3985 3986 3987 // exitsyscall slow path on g0. // Failed to acquire P, enqueue gp as runnable. // // Called via mcall, so gp is the calling g from this M. // //go:nowritebarrierrec func exitsyscall0(gp *g) { // ä¿®æ”¹gpçŠ¶æ€ä¸º_Grunnable casgstatus(gp, _Gsyscall, _Grunnable) dropg() // è§£é™¤gå…³è”å…³ç³» lock(\u0026sched.lock) var _p_ *p // åˆ¤æ–­gpæ˜¯å¦æ˜¯ç³»ç»Ÿgoroutineï¼Œå¦‚æœæ˜¯çš„è¯å†æ¬¡å°è¯•è·å–Pã€‚ if schedEnabled(gp) { _p_, _ = pidleget(0) } var locked bool if _p_ == nil { globrunqput(gp) // gpåŠ å…¥å…¨å±€å¯è¿è¡Œé˜Ÿåˆ— // Below, we stoplockedm if gp is locked. globrunqput releases // ownership of gp, so we must check if gp is locked prior to // committing the release by unlocking sched.lock, otherwise we // could race with another M transitioning gp from unlocked to // locked. // // ä¸‹é¢ï¼Œå¦‚æœgpè¢«é”å®šï¼Œæˆ‘ä»¬å°†åœæ­¢é˜»å¡ã€‚ // globrunqputé‡Šæ”¾äº†gpçš„æ‰€æœ‰æƒï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»åœ¨é‡Šæ”¾ä¹‹å‰é€šè¿‡è§£é”sched.lockæ£€æŸ¥gpæ˜¯å¦è¢«é”å®šï¼Œå¦åˆ™æˆ‘ä»¬å¯ä»¥ä¸å¦ä¸€ä¸ªMè½¬æ¢gpä»è§£é”åˆ°é”å®šã€‚ locked = gp.lockedm != 0 } else if atomic.Load(\u0026sched.sysmonwait) != 0 { // å°è¯•å”¤é†’sysmonï¼Œå¦‚æœæœ‰ atomic.Store(\u0026sched.sysmonwait, 0) notewakeup(\u0026sched.sysmonnote) } unlock(\u0026sched.lock) if _p_ != nil { acquirep(_p_) // ç»‘å®šP // gp è¢«è°ƒåº¦èµ·æ¥è¿è¡Œ execute(gp, false) // Never returns. } if locked { // Wait until another thread schedules gp and so m again. // // N.B. lockedm must be this M, as this g was running on this M // before entersyscall. // // ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹è°ƒåº¦gpï¼Œç„¶åå†è°ƒåº¦mã€‚ // æ³¨æ„ï¼Œlockedmä¸€å®šæ˜¯è¿™ä¸ªMï¼Œå› ä¸ºè¿™ä¸ªgåœ¨entersyscallä¹‹å‰æ˜¯åœ¨è¿™ä¸ªMä¸Šè¿è¡Œçš„ã€‚ stoplockedm() execute(gp, false) // Never returns. } stopm() // å½“å‰å·¥ä½œçº¿ç¨‹è¢«æŒ‚èµ·ï¼Œç­‰å¾…è¢«å”¤é†’è·å–Pç„¶åè¿è¡Œèµ·æ¥ // è°ƒåº¦å¾ªç¯å¼€å§‹ schedule() // Never returns. } ä¿¡å·å½¢å¼å‘é€æŠ¢å  preemptM() preemptMå‘mpå‘é€æŠ¢å è¯·æ±‚ã€‚è¯¥è¯·æ±‚å¯ä»¥å¼‚æ­¥å¤„ç†ï¼Œå¹¶ä¸”å¯ä»¥ä¸å¯¹Mçš„å…¶ä»–è¯·æ±‚åˆå¹¶ã€‚ å½“æ¥æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œå¦‚æœæ­£åœ¨è¿è¡Œçš„Gæˆ–Pè¢«æ ‡è®°ä¸ºæŠ¢å ï¼Œå¹¶ä¸”goroutineå¤„äºå¼‚æ­¥å®‰å…¨ç‚¹ï¼Œåˆ™å®ƒå°†æŠ¢å  goroutineã€‚ å®ƒæ€»æ˜¯åœ¨å¤„ç†æŠ¢å è¯·æ±‚åè‡ªåŠ¨é€’å¢mp.preemptGenã€‚ é€šè¿‡runtime.signalM()å‡½æ•°å‘æ‰§è¡ŒMå‘é€sigPreemptä¿¡å·ã€‚ è‡³äºsignalM()å‡½æ•°ï¼Œå°±æ˜¯è°ƒç”¨æ“ä½œç³»ç»Ÿçš„ä¿¡å·ç›¸å…³ç³»ç»Ÿè°ƒç”¨ï¼Œå°†æŒ‡å®šä¿¡å·å‘é€ç»™ç›®æ ‡çº¿ç¨‹ã€‚ è‡³æ­¤ï¼Œå¼‚æ­¥æŠ¢å é€»è¾‘çš„ä¸»è¦å·¥ä½œå°±ç®—å®Œæˆäº†å‰ä¸€åŠã€‚ preemptMè¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨signalMå°†åœ¨åˆå§‹åŒ–çš„å®‰è£…çš„_SIGURGä¿¡å·å‘é€åˆ°æŒ‡å®šçš„Mä¸Šã€‚ ä½¿ç”¨ preemptM å‘é€æŠ¢å ä¿¡å·çš„åœ°æ–¹ä¸»è¦æœ‰ä¸‹é¢å‡ ä¸ªï¼š Go åå°ç›‘æ§ runtime.sysmon æ£€æµ‹è¶…æ—¶å‘é€æŠ¢å ä¿¡å·ï¼› Go GC æ ˆæ‰«æå‘é€æŠ¢å ä¿¡å·ï¼› Go GC STW çš„æ—¶å€™è°ƒç”¨ preemptall æŠ¢å æ‰€æœ‰ Pï¼Œè®©å…¶æš‚åœï¼› æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/signal_unix.goã€‚ å‚æ•°mp *mï¼šè¢«æŠ¢å çš„På…³è”çš„Mã€‚ 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 // preemptM sends a preemption request to mp. This request may be // handled asynchronously and may be coalesced with other requests to // the M. When the request is received, if the running G or P are // marked for preemption and the goroutine is at an asynchronous // safe-point, it will preempt the goroutine. It always atomically // increments mp.preemptGen after handling a preemption request. func preemptM(mp *m) { // On Darwin, don't try to preempt threads during exec. // Issue #41702. if GOOS == \"darwin\" || GOOS == \"ios\" { execLock.rlock() } // mp.signalPending: è¿™ä¸ªMä¸Šæ˜¯å¦æœ‰ä¸€ä¸ªå¾…å¤„ç†çš„æŠ¢å ä¿¡å·ã€‚åŸå­æ“ä½œã€‚ if atomic.Cas(\u0026mp.signalPending, 0, 1) { if GOOS == \"darwin\" || GOOS == \"ios\" { atomic.Xadd(\u0026pendingPreemptSignals, 1) } // If multiple threads are preempting the same M, it may send many // signals to the same M such that it hardly make progress, causing // live-lock problem. Apparently this could happen on darwin. See // issue #37741. // Only send a signal if there isn't already one pending. // // å¦‚æœå¤šä¸ªçº¿ç¨‹æŠ¢å åŒä¸€ä¸ªMï¼Œå®ƒå¯èƒ½ä¼šå‘åŒä¸€ä¸ªMå‘é€è®¸å¤šä¿¡å·ï¼Œ // ä½¿å…¶å‡ ä¹æ— æ³•å–å¾—è¿›å±•ï¼Œä»è€Œå¯¼è‡´å®æ—¶é”å®šé—®é¢˜ã€‚ // æ˜¾ç„¶è¿™å¯èƒ½å‘ç”Ÿåœ¨darwinèº«ä¸Šã€‚åªæœ‰åœ¨è¿˜æ²¡æœ‰æŒ‚èµ·çš„æƒ…å†µä¸‹æ‰å‘é€ä¿¡å·ã€‚ // const sigPreempt int = _SIGURG // const _SIGURG = 0x17 signalM(mp, sigPreempt) } if GOOS == \"darwin\" || GOOS == \"ios\" { execLock.runlock() } } signalM() signalMå‘mpå‘é€ä¿¡å·ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/os_linux.goã€‚ 551 552 553 554 555 556 557 558 559 560 561 562 // signalM sends a signal to mp. func signalM(mp *m, sig int) { // å°†ä¿¡å·sigå‘é€åˆ°çº¿ç¨‹ç»„tgidä¸­å…·æœ‰çº¿ç¨‹ID tidçš„çº¿ç¨‹ã€‚ // int tgkill(int tgid, int tid, int sig); // 1. tgidï¼šä¸ºçº¿ç¨‹ç»„ä¸­ä¸»çº¿ç¨‹çš„çº¿ç¨‹IDï¼Œæˆ–è€…ç§°ä¸ºè¿›ç¨‹å·ã€‚ // å…¶å®å®ƒèƒ½èµ·åˆ°ä¿æŠ¤çš„ä½œç”¨ï¼Œé˜²æ­¢å‘é”™è¯¯çš„çº¿ç¨‹å‘é€ä¿¡å·ã€‚ // æ¯”å¦‚å‘çº¿ç¨‹IDä¸º1234çš„çº¿ç¨‹å‘é€ä¿¡å·æ—¶ï¼Œå¾ˆå¯èƒ½çº¿ç¨‹1234æ—©å°±é€€å‡ºäº†ï¼Œ // è€Œçº¿ç¨‹ID 1234æ°å¥½è¢«å†…æ ¸åˆ†é…ç»™äº†å¦ä¸€ä¸ªä¸ç›¸å¹²çš„è¿›ç¨‹ã€‚ // 2. tidï¼šçº¿ç¨‹IDã€‚ // 3. sigï¼šä¿¡å·å€¼ã€‚sigPreempt = _SIGURG = 0x17ã€‚ tgkill(getpid(), int(mp.procid), sig) } tgkill() ç³»ç»Ÿè°ƒç”¨ tgkill() å‡½æ•°å‘è¿›ç¨‹å†…çš„çº¿ç¨‹å‘é€ä¿¡å·ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/sys_linux_amd64.sã€‚ 176 177 178 179 180 181 182 TEXT Â·tgkill(SB),NOSPLIT,$0 MOVQ tgid+0(FP), DI MOVQ tid+8(FP), SI MOVQ sig+16(FP), DX MOVL $SYS_tgkill, AX SYSCALL # è¿›å…¥ç³»ç»Ÿè°ƒç”¨ RET å…¨å±€ä¿¡å·å¤„ç†æ³¨å†Œ mstart1() ä¸»çº¿ç¨‹å¯åŠ¨è¿è¡Œåˆ°mstart()-\u003emstart0()-\u003emstart1()å‡½æ•°å†…æ—¶ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 1394 1395 1396 1397 1398 1399 1400 1401 1402 1403 1404 1405 1406 1407 1408 1409 1410 1411 1412 // The go:noinline is to guarantee the getcallerpc/getcallersp below are safe, // so that we can set up g0.sched to return to the call of mstart1 above. // //go:noinline func mstart1() { // ... asminit() minit() // Install signal handlers; after minit so that minit can // prepare the thread to be able to handle the signals. // // å®‰è£…ä¿¡å·å¤„ç†ç¨‹åº;åœ¨minitä¹‹åï¼Œä»¥ä¾¿minitå¯ä»¥å‡†å¤‡çº¿ç¨‹ï¼Œä»¥ä¾¿èƒ½å¤Ÿå¤„ç†ä¿¡å·ã€‚ if gp.m == \u0026m0 { mstartm0() } // ... } mstartm0() initsig(false)åˆ™æ˜¯æ³¨å†Œä¿¡å·å¤„ç†ç›¸å…³ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 1435 1436 1437 1438 1439 1440 1441 1442 1443 1444 1445 1446 1447 1448 1449 1450 // mstartm0 implements part of mstart1 that only runs on the m0. // // Write barriers are allowed here because we know the GC can't be // running yet, so they'll be no-ops. // //go:yeswritebarrierrec func mstartm0() { // Create an extra M for callbacks on threads not created by Go. // An extra M is also needed on Windows for callbacks created by // syscall.NewCallback. See issue #6751 for details. if (iscgo || GOOS == \"windows\") \u0026\u0026 !cgoHasExtraM { cgoHasExtraM = true newextram() } initsig(false) } initsig() ä¿¡å·æ³¨å†Œã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/signal_unix.goã€‚ 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 // Initialize signals. // Called by libpreinit so runtime may not be initialized. // //go:nosplit //go:nowritebarrierrec func initsig(preinit bool) { if !preinit { // It's now OK for signal handlers to run. // // ç°åœ¨å¯ä»¥è¿è¡Œä¿¡å·å¤„ç†ç¨‹åºäº†ã€‚ signalsOK = true } // For c-archive/c-shared this is called by libpreinit with // preinit == true. if (isarchive || islibrary) \u0026\u0026 !preinit { return } // éå†ä¿¡å·æ•°ç»„ // const _NSIG int = 65; for i := uint32(0); i \u003c _NSIG; i++ { // sigtable å…¨å±€å˜é‡å­˜å‚¨çš„æ˜¯æ‰€æœ‰ä¿¡å·åŠæè¿° t := \u0026sigtable[i] // const _SigDefault int = 16; // å¦‚æœä¿¡å·æ²¡æœ‰è¢«æ˜¾å¼è¯·æ±‚ï¼Œå°±ä¸è¦ç›‘è§†å®ƒ // ç•¥è¿‡ä¿¡å·ï¼ŒSIGKILLã€SIGSTOPã€SIGTSTPã€SIGCONTã€SIGTTINã€SIGTTOU if t.flags == 0 || t.flags\u0026_SigDefault != 0 { continue } // We don't need to use atomic operations here because // there shouldn't be any other goroutines running yet. fwdSig[i] = getsig(i) if !sigInstallGoHandler(i) { // Even if we are not installing a signal handler, // set SA_ONSTACK if necessary. if fwdSig[i] != _SIG_DFL \u0026\u0026 fwdSig[i] != _SIG_IGN { setsigstack(i) } else if fwdSig[i] == _SIG_IGN { sigInitIgnored(i) } continue } handlingSig[i] = 1 setsig(i, abi.FuncPCABIInternal(sighandler)) } } setsig() è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ fn ç­‰äº sighandler çš„æ—¶å€™ï¼Œè°ƒç”¨çš„å‡½æ•°ä¼šè¢«æ›¿æ¢æˆ sigtrampã€‚ sigaction å‡½æ•°åœ¨ Linux ä¸‹ä¼šè°ƒç”¨ç³»ç»Ÿè°ƒç”¨å‡½æ•° sys_signal ä»¥åŠ sys_rt_sigaction å®ç°å®‰è£…ä¿¡å·ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/os_linux.goã€‚ 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 //go:nosplit //go:nowritebarrierrec func setsig(i uint32, fn uintptr) { var sa sigactiont sa.sa_flags = _SA_SIGINFO | _SA_ONSTACK | _SA_RESTORER | _SA_RESTART sigfillset(\u0026sa.sa_mask) // Although Linux manpage says \"sa_restorer element is obsolete and // should not be used\". x86_64 kernel requires it. Only use it on // x86. if GOARCH == \"386\" || GOARCH == \"amd64\" { sa.sa_restorer = abi.FuncPCABI0(sigreturn) } if fn == abi.FuncPCABIInternal(sighandler) { // abi.FuncPCABIInternal(sighandler) matches the callers in signal_unix.go if iscgo { fn = abi.FuncPCABI0(cgoSigtramp) } else { // æ›¿æ¢ä¸ºè°ƒç”¨ sigtramp fn = abi.FuncPCABI0(sigtramp) } } sa.sa_handler = fn sigaction(i, \u0026sa, nil) } ä¿¡å·å½¢å¼å“åº”æŠ¢å  sigtramp() å‡½æ•°åŸå‹ï¼šfunc sigtramp()ã€‚ sigtramp()å®é™…ä¸Šæ˜¯çœŸæ­£çš„ä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¿›ç¨‹ä»å†…æ ¸æ€æ”¶åˆ°ä¿¡å·å›åˆ°ç”¨æˆ·æ€è°ƒç”¨çš„å¤„ç†å‡½æ•°å°±æ˜¯å®ƒã€‚ æ³¨é‡Šä¸­è¡¨æ˜è¿™ä¸ªå‡½æ•°ä»¥Cè¯­è¨€çš„è°ƒç”¨æƒ¯ä¾‹è¢«è°ƒç”¨ï¼ŒGoåœ¨è¿™é‡Œé€šè¿‡PUSH_REGS_HOST_TO_ABI0ä¿å­˜goè‡ªå·±è°ƒç”¨æƒ¯ä¾‹ç”¨çš„å¯„å­˜å™¨åï¼Œ è½¬æ¢æˆè‡ªå·±çš„è°ƒç”¨è§„èŒƒï¼Œç­‰å‡½æ•°è°ƒç”¨å®Œæ¯•ä¹‹åï¼Œå†é€šè¿‡POP_REGS_HOST_TO_ABI0æ¢å¤è¿™äº›å¯„å­˜å™¨çš„å€¼ã€‚ è°ƒåº¦è·¯å¾„sigtramp()-\u003esigtrampgo()-\u003esighandler()-\u003edoSigPreempt()ã€‚ è¿™é‡Œä¼šè¢«è°ƒç”¨è¯´æ˜ä¿¡å·å·²ç»å‘é€å“åº”äº†ï¼ŒruntimeÂ·sigtrampä¼šè¿›è¡Œä¿¡å·çš„å¤„ç†ã€‚ runtimeÂ·sigtrampä¼šç»§ç»­è°ƒç”¨runtimeÂ·sigtrampgoã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/sys_linux_amd64.sã€‚ 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 # Called using C ABI. TEXT runtimeÂ·sigtramp(SB),NOSPLIT|TOPFRAME,$0 # Transition from C ABI to Go ABI. PUSH_REGS_HOST_TO_ABI0() # Set up ABIInternal environment: g in R14, cleared X15. get_tls(R12) # TLS MOVQ g(R12), R14 # R14 = g PXOR X15, X15 # Reserve space for spill slots. NOP SP # disable vet stack checking ADJSP $24 # Call into the Go signal handler # # å†…æ ¸ä¿®æ”¹ç”¨æˆ·æ€å¯„å­˜å™¨æ—¶è®¾ç½®çš„ rdiã€rsiã€rdx # ä¸‰ä¸ªå¯„å­˜å™¨çš„å€¼å°±æ˜¯å†…æ ¸æ¨¡ä»¿è°ƒç”¨sigtrampæ—¶ä¼ å…¥çš„å‚æ•° MOVQ DI, AX\t# sig MOVQ SI, BX\t# info MOVQ DX, CX\t# ctx CALL Â·sigtrampgo\u003cABIInternal\u003e(SB) ADJSP $-24 POP_REGS_HOST_TO_ABI0() RET sigtrampgo() æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/signal_unix.goã€‚ 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 // sigtrampgo is called from the signal handler function, sigtramp, // written in assembly code. // This is called by the signal handler, and the world may be stopped. // // It must be nosplit because getg() is still the G that was running // (if any) when the signal was delivered, but it's (usually) called // on the gsignal stack. Until this switches the G to gsignal, the // stack bounds check won't work. // //go:nosplit //go:nowritebarrierrec func sigtrampgo(sig uint32, info *siginfo, ctx unsafe.Pointer) { if sigfwdgo(sig, info, ctx) { return } c := \u0026sigctxt{info, ctx} gp := sigFetchG(c) // g setg(gp) if gp == nil { if sig == _SIGPROF { // Some platforms (Linux) have per-thread timers, which we use in // combination with the process-wide timer. Avoid double-counting. if validSIGPROF(nil, c) { sigprofNonGoPC(c.sigpc()) } return } if sig == sigPreempt \u0026\u0026 preemptMSupported \u0026\u0026 debug.asyncpreemptoff == 0 { // This is probably a signal from preemptM sent // while executing Go code but received while // executing non-Go code. // We got past sigfwdgo, so we know that there is // no non-Go signal handler for sigPreempt. // The default behavior for sigPreempt is to ignore // the signal, so badsignal will be a no-op anyway. if GOOS == \"darwin\" || GOOS == \"ios\" { pendingPreemptSignals.Add(-1) } return } c.fixsigcode(sig) badsignal(uintptr(sig), c) return } setg(gp.m.gsignal) // If some non-Go code called sigaltstack, adjust. var gsignalStack gsignalStack setStack := adjustSignalStack(sig, gp.m, \u0026gsignalStack) if setStack { gp.m.gsignal.stktopsp = getcallersp() } if gp.stackguard0 == stackFork { signalDuringFork(sig) } c.fixsigcode(sig) sighandler(sig, info, ctx, gp) setg(gp) if setStack { restoreGsignalStack(\u0026gsignalStack) } } sighander() å“åº”æŠ¢å ã€‚è°ƒåº¦è·¯å¾„sigtramp()-\u003esigtrampgo()-\u003esighandler()-\u003edoSigPreempt()ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/signal_unix.goã€‚ 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 // sighandler is invoked when a signal occurs. The global g will be // set to a gsignal goroutine and we will be running on the alternate // signal stack. The parameter g will be the value of the global g // when the signal occurred. The sig, info, and ctxt parameters are // from the system signal handler: they are the parameters passed when // the SA is passed to the sigaction system call. // // The garbage collector may have stopped the world, so write barriers // are not allowed. // //go:nowritebarrierrec func sighandler(sig uint32, info *siginfo, ctxt unsafe.Pointer, gp *g) { // ... ... // sig == sigPreemptï¼šæŠ¢å ä¿¡å· // debug.asyncpreemptoff == 0ï¼šæ²¡æœ‰ç¦æ­¢æŠ¢å  // delayedSignalï¼šå»¶è¿Ÿä¿¡å·? if sig == sigPreempt \u0026\u0026 debug.asyncpreemptoff == 0 \u0026\u0026 !delayedSignal { // Might be a preemption signal. // å¯èƒ½æ˜¯ä¸€ä¸ªæŠ¢å ä¿¡å·ã€‚ doSigPreempt(gp, c) // Even if this was definitely a preemption signal, it // may have been coalesced with another signal, so we // still let it through to the application. // å³ä½¿è¿™ç¡®å®æ˜¯ä¸€ä¸ªæŠ¢å ä¿¡å·ï¼Œå®ƒå¯èƒ½å·²ç»ä¸å¦ä¸€ä¸ªä¿¡å·åˆå¹¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»ç„¶è®©å®ƒé€šè¿‡åº”ç”¨ç¨‹åºã€‚ } // ... ... } doSigPreempt() doSigPreemptå¤„ç†gpä¸Šçš„æŠ¢å ä¿¡å·ã€‚ è°ƒç”¨åˆ°doSigPreemptæ—¶ï¼Œä¼šå°†ctxè¿™ä¸ªå‚æ•°ä¼ å…¥ï¼Œå…¶ä¸­åŒ…å«äº†è¿›ç¨‹ç”¨æˆ·æ€ç¡¬ä»¶ä¸Šä¸‹æ–‡ ctxtçš„ç±»å‹ä¸º*sigctxtï¼ŒæŒ‡å‘çš„æ˜¯ç”¨æˆ·æ€å †æ ˆä¸­å­˜æ”¾å†…æ ¸æ€å †æ ˆå†…å®¹çš„åœ°å€ã€‚ ç„¶åä¿¡å·å¤„ç†ç¨‹åºé€šè¿‡isAsyncSafePointæ¥åˆ¤æ–­æŠ¢å ä½ç½®æ˜¯å¦å®‰å…¨ï¼Œå¹¶è¿”å›å®‰å…¨çš„æŠ¢å åœ°å€ã€‚ å¦‚æœç¡®è®¤æŠ¢å æ²¡æœ‰é—®é¢˜ï¼Œæ¥ç€ä¼šè°ƒç”¨pushCallæ–¹æ³•æ¥ä¿®æ”¹ctxtä¸­çš„ç”¨æˆ·æ€ç¡¬ä»¶ä¸Šä¸‹æ–‡ï¼Œ ç”¨äºç¨åå†ä¸€æ¬¡ä»å†…æ ¸æ€è¿”å›ç”¨æˆ·æ€æ—¶æ¨¡æ‹Ÿå‡ºä¸€ä¸ªç”¨æˆ·æ€ç¨‹åºè°ƒç”¨asyncPreemptçš„å‡è±¡ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/signal_unix.goã€‚ 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 // doSigPreempt handles a preemption signal on gp. func doSigPreempt(gp *g, ctxt *sigctxt) { // Check if this G wants to be preempted and is safe to // preempt. // æ£€æŸ¥è¿™ä¸ªGæ˜¯å¦å¸Œæœ›è¢«æŠ¢å ï¼Œå¹¶ä¸”æŠ¢å æ˜¯å®‰å…¨çš„ã€‚ // é€šè¿‡ wantAsyncPreempt å‡½æ•°ç¡®è®¤runtimeç¡®å®æƒ³è¦å¯¹æŒ‡å®šçš„Gå®æ–½å¼‚æ­¥æŠ¢å  if wantAsyncPreempt(gp) { // é€šè¿‡isAsyncSafePointå‡½æ•°ç¡®è®¤Gå½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡æ˜¯èƒ½å¤Ÿå®‰å…¨åœ°è¿›è¡Œå¼‚æ­¥æŠ¢å çš„ã€‚ if ok, newpc := isAsyncSafePoint(gp, ctxt.sigpc(), ctxt.sigsp(), ctxt.siglr()); ok { // Adjust the PC and inject a call to asyncPreempt. // ä»¥ä¸Šä¸¤ä¸ªå‡½æ•°éƒ½ç¡®è®¤æ— è¯¯åï¼Œæ‰é€šè¿‡pushCallå‘Gçš„æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­æ³¨å…¥ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œ // è¦è°ƒç”¨çš„ç›®æ ‡å‡½æ•°æ˜¯ runtime.asyncPreempt å‡½æ•°ã€‚è¿™æ˜¯ä¸€ä¸ªæ±‡ç¼–å‡½æ•°ï¼Œå®ƒä¼šå…ˆæŠŠå„ä¸ªå¯„å­˜å™¨çš„å€¼ä¿å­˜åœ¨æ ˆä¸Šï¼Œ // ä¹Ÿå°±æ˜¯å°†ç°åœºä¿å­˜åœ¨æ ˆä¸Šï¼Œç„¶åè°ƒç”¨ runtime.asyncPreempt2å‡½æ•°ã€‚ ctxt.pushCall(abi.FuncPCABI0(asyncPreempt), newpc) // å°±æ˜¯å‘å½“å‰è¿è¡Œçš„goroutineæ³¨å†ŒåŠ å…¥asyncPreemptå‡½æ•° } } // Acknowledge the preemption. atomic.Xadd(\u0026gp.m.preemptGen, 1) atomic.Store(\u0026gp.m.signalPending, 0) if GOOS == \"darwin\" || GOOS == \"ios\" { atomic.Xadd(\u0026pendingPreemptSignals, -1) } } wantAsyncPreempt() wantAsyncPreemptè¿”å›å¼‚æ­¥æŠ¢å æ˜¯å¦ä¸ºgpæ’é˜Ÿã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/preempt.goã€‚ 340 341 342 343 344 345 346 347 348 349 350 // wantAsyncPreempt returns whether an asynchronous preemption is // queued for gp. func wantAsyncPreempt(gp *g) bool { // Check both the G and the P. // åŒæ—¶æ£€æŸ¥Gå’ŒPçš„preemptå­—æ®µï¼Œå¹¶ä¸”Gå½“å‰éœ€è¦å¤„äº_GrunningçŠ¶æ€ã€‚ // åœ¨æ¯è½®è°ƒåº¦å¾ªç¯ä¸­ï¼ŒPå’ŒGçš„preemptå­—æ®µéƒ½ä¼šè¢«ç½®ä¸ºfalseï¼Œæ‰€ä»¥è¿™ä¸ªæ£€æµ‹èƒ½å¤Ÿé¿å…åˆšåˆšåˆ‡æ¢è‡³ä¸€ä¸ªæ–°çš„Gåé©¬ä¸Šåˆè¢«æŠ¢å ã€‚ // gp.preempt || gp.m.p != 0 \u0026\u0026 gp.m.p.ptr().preemptï¼šåˆ¤æ–­Gæˆ–Pçš„preemptæŠ¢å æ ‡è¯†ä½ã€‚ // readgstatus(gp)\u0026^_Gscan == _Grunningï¼šå½“å‰Gæ­£åœ¨è¿è¡ŒçŠ¶æ€ã€‚ // ç¡®è®¤æ˜¯å¦è®¾ç½®äº†æŠ¢å æ ‡å¿— return (gp.preempt || gp.m.p != 0 \u0026\u0026 gp.m.p.ptr().preempt) \u0026\u0026 readgstatus(gp)\u0026^_Gscan == _Grunning } isAsyncSafePoint() å®ƒä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥ä¿è¯åœ¨å½“å‰ä½ç½®è¿›è¡Œå¼‚æ­¥æŠ¢å æ˜¯å®‰å…¨çš„ã€‚ å¯ä»¥æŒ‚èµ·Gå¹¶å®‰å…¨çš„æ‰«æå®ƒçš„æ ˆå’Œå¯„å­˜å™¨ï¼Œæ²¡æœ‰æ½œåœ¨çš„éšè—æŒ‡é’ˆï¼Œè€Œä¸”å½“å‰å¹¶æ²¡æœ‰æ‰“æ–­ä¸€ä¸ªå†™å±éšœã€‚ Gè¿˜æœ‰è¶³å¤Ÿçš„æ ˆç©ºé—´æ¥æ³¨å…¥ä¸€ä¸ªå¯¹asyncPreempt()å‡½æ•°çš„è°ƒç”¨ã€‚ å¯ä»¥å®‰å…¨åœ°å’Œ runtime è¿›è¡Œäº¤äº’ï¼Œä¾‹å¦‚æœªæŒæœ‰ runtime ç›¸å…³çš„é”ï¼Œå› æ­¤åœ¨å°è¯•è·å¾—é”æ—¶ä¸ä¼šé€ æˆæ­»é”ã€‚ isAsyncSafePointæŠ¥å‘ŠæŒ‡ä»¤PCä¸Šçš„gpæ˜¯å¦æ˜¯å¼‚æ­¥å®‰å…¨ç‚¹ã€‚è¿™è¡¨æ˜ï¼š æš‚åœgpå¹¶ä¿å®ˆåœ°æ‰«æå®ƒçš„å †æ ˆå’Œå¯„å­˜å™¨æ˜¯å®‰å…¨çš„ã€‚å®ƒæ²¡æœ‰æ½œåœ¨çš„éšè—æŒ‡é’ˆå€¼ï¼Œä¹Ÿä¸åƒå†™å±éšœé‚£æ ·ä½äºåŸå­åºåˆ—çš„ä¸­é—´ã€‚ gpæœ‰è¶³å¤Ÿçš„å †æ ˆç©ºé—´æ³¨å…¥asyncPreemptè°ƒç”¨ã€‚ é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸è¿è¡Œæ—¶äº¤äº’æ˜¯å®‰å…¨çš„ï¼Œå³ä½¿æˆ‘ä»¬åœ¨ä¿¡å·å¤„ç†ç¨‹åºä¸­å°±åœåœ¨è¿™é‡Œã€‚ä¾‹å¦‚ï¼Œæ²¡æœ‰æŒæœ‰è¿è¡Œæ—¶é”ï¼Œå› æ­¤è·å–è¿è¡Œæ—¶é”ä¸ä¼šè‡ªæ­»é”ã€‚ åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒPCæ˜¯å®‰å…¨çš„å¼‚æ­¥æŠ¢å ï¼Œä½†å®ƒä¹Ÿéœ€è¦è°ƒæ•´æ¢å¤PCã€‚æ–°çš„PCåœ¨ç¬¬äºŒä¸ªç»“æœä¸­è¿”å›ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/preempt.goã€‚ 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 // isAsyncSafePoint reports whether gp at instruction PC is an // asynchronous safe point. This indicates that: // // 1. It's safe to suspend gp and conservatively scan its stack and // registers. There are no potentially hidden pointer values and it's // not in the middle of an atomic sequence like a write barrier. // // 2. gp has enough stack space to inject the asyncPreempt call. // // 3. It's generally safe to interact with the runtime, even if we're // in a signal handler stopped here. For example, there are no runtime // locks held, so acquiring a runtime lock won't self-deadlock. // // In some cases the PC is safe for asynchronous preemption but it // also needs to adjust the resumption PC. The new PC is returned in // the second result. func isAsyncSafePoint(gp *g, pc, sp, lr uintptr) (bool, uintptr) { mp := gp.m // Only user Gs can have safe-points. We check this first // because it's extremely common that we'll catch mp in the // scheduler processing this G preemption. // // åªæœ‰ç”¨æˆ·Gså¯ä»¥æœ‰å®‰å…¨ç‚¹ã€‚æˆ‘ä»¬é¦–å…ˆæ£€æŸ¥è¿™ä¸ªï¼Œå› ä¸ºåœ¨å¤„ç†GæŠ¢å çš„è°ƒåº¦å™¨ä¸­æ•è·mpæ˜¯éå¸¸å¸¸è§çš„ã€‚ if mp.curg != gp { return false, 0 } // Check M state. // æ£€æŸ¥MçŠ¶æ€ã€‚ // canPreemptM(mp) -\u003e mp.locks == 0 \u0026\u0026 mp.mallocing == 0 \u0026\u0026 mp.preemptoff == \"\" \u0026\u0026 mp.p.ptr().status == _Prunning if mp.p == 0 || !canPreemptM(mp) { return false, 0 } // Check stack space. // æ£€æŸ¥æ ˆç©ºé—´ã€‚ // asyncPreemptStackæ˜¯æ³¨å…¥ä¸€ä¸ªasyncPreemptè°ƒç”¨æ‰€éœ€çš„æ ˆç©ºé—´çš„å­—èŠ‚ã€‚ if sp \u003c gp.stack.lo || sp-gp.stack.lo \u003c asyncPreemptStack { return false, 0 } // Check if PC is an unsafe-point. // æ£€æŸ¥PCæ˜¯å¦ä¸ºä¸å®‰å…¨ç‚¹ã€‚ f := findfunc(pc) if !f.valid() { // Not Go code. return false, 0 } if (GOARCH == \"mips\" || GOARCH == \"mipsle\" || GOARCH == \"mips64\" || GOARCH == \"mips64le\") \u0026\u0026 lr == pc+8 \u0026\u0026 funcspdelta(f, pc, nil) == 0 { // We probably stopped at a half-executed CALL instruction, // where the LR is updated but the PC has not. If we preempt // here we'll see a seemingly self-recursive call, which is in // fact not. // This is normally ok, as we use the return address saved on // stack for unwinding, not the LR value. But if this is a // call to morestack, we haven't created the frame, and we'll // use the LR for unwinding, which will be bad. return false, 0 } up, startpc := pcdatavalue2(f, _PCDATA_UnsafePoint, pc) if up == _PCDATA_UnsafePointUnsafe { // Unsafe-point marked by compiler. This includes // atomic sequences (e.g., write barrier) and nosplit // functions (except at calls). return false, 0 } if fd := funcdata(f, _FUNCDATA_LocalsPointerMaps); fd == nil || f.flag\u0026funcFlag_ASM != 0 { // This is assembly code. Don't assume it's well-formed. // TODO: Empirically we still need the fd == nil check. Why? // // TODO: Are there cases that are safe but don't have a // locals pointer map, like empty frame functions? // It might be possible to preempt any assembly functions // except the ones that have funcFlag_SPWRITE set in f.flag. return false, 0 } name := funcname(f) if inldata := funcdata(f, _FUNCDATA_InlTree); inldata != nil { inltree := (*[1 \u003c\u003c 20]inlinedCall)(inldata) ix := pcdatavalue(f, _PCDATA_InlTreeIndex, pc, nil) if ix \u003e= 0 { name = funcnameFromNameoff(f, inltree[ix].func_) } } if hasPrefix(name, \"runtime.\") || hasPrefix(name, \"runtime/internal/\") || hasPrefix(name, \"reflect.\") { // For now we never async preempt the runtime or // anything closely tied to the runtime. Known issues // include: various points in the scheduler (\"don't // preempt between here and here\"), much of the defer // implementation (untyped info on stack), bulk write // barriers (write barrier check), // reflect.{makeFuncStub,methodValueCall}. // // TODO(austin): We should improve this, or opt things // in incrementally. return false, 0 } switch up { case _PCDATA_Restart1, _PCDATA_Restart2: // Restartable instruction sequence. Back off PC to // the start PC. if startpc == 0 || startpc \u003e pc || pc-startpc \u003e 20 { throw(\"bad restart PC\") } return true, startpc case _PCDATA_RestartAtEntry: // Restart from the function entry at resumption. return true, f.entry() } return true, pc } pushCall() pushCallå¹²äº†ä¸¤ä»¶äº‹ï¼š ä¿®æ”¹ç¨‹åºè®¡æ•°å™¨çš„æŒ‡å‘ä¸ºasyncPreemptå‡½æ•°çš„åœ°å€ã€‚ ä¿®æ”¹æ ˆé¡¶æŒ‡é’ˆï¼Œå°†å½“å‰ goroutine çš„åŸæœ¬ä¸­æ–­åœ°å€æ”¾å…¥å †æ ˆã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/signal_amd64.goã€‚ å…ˆæŠŠSPå‘ä¸‹ç§»åŠ¨ä¸€ä¸ªæŒ‡é’ˆå¤§å°çš„ä½ç½®ï¼ŒæŠŠPCçš„å€¼å­˜å…¥æ ˆä¸ŠSPæŒ‡å‘çš„ä½ç½®ï¼Œç„¶åå°†PCçš„å€¼æ›´æ–°ä¸ºtargetPCã€‚ è¿™æ ·å°±æ¨¡æ‹Ÿäº†ä¸€æ¡CALLæŒ‡ä»¤çš„æ•ˆæœï¼Œæ ˆä¸Šå­˜å…¥çš„PCçš„æ—§å€¼å°±ç›¸å½“äºè¿”å›åœ°å€ã€‚ æ­¤æ—¶æ•´ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡çš„çŠ¶æ€å°±åƒæ˜¯goroutineåœ¨è¢«ä¿¡å·æ‰“æ–­çš„ä½ç½®é¢å¤–æ‰§è¡Œäº†ä¸€æ¡CALL targetPCæŒ‡ä»¤ã€‚ ç”±äºæ‰§è¡Œæµç¨‹åˆšåˆšè·³è½¬åˆ°targetPCåœ°å€å¤„ï¼Œæ‰€ä»¥è¿˜æ²¡æ¥å¾—åŠæ‰§è¡Œç›®æ ‡åœ°å€å¤„çš„æŒ‡ä»¤ã€‚ å½“sighandler()å‡½æ•°å¤„ç†å®Œä¿¡å·å¹¶è¿”å›åï¼Œè¢«æ‰“æ–­çš„goroutineå¾—ä»¥ç»§ç»­æ‰§è¡Œï¼Œä¼šç«‹å³è°ƒç”¨è¢«æ³¨å…¥çš„asyncPreempt()å‡½æ•°ã€‚ç»è¿‡ä¸€è¿ä¸²çš„å‡½æ•°è°ƒç”¨ï¼Œæœ€ç»ˆæ‰§è¡Œåˆ°schedule()å‡½æ•°ã€‚ å‚æ•°ï¼š targetPC uintptrï¼šasyncPreempt å‡½æ•°çš„æ‰§è¡Œå…¥å£åœ°å€ã€‚ resumePC uintptrï¼šå…¶å®å°±æ˜¯å‘ç”Ÿä¸­æ–­å‰å½“å‰goroutineçš„ä¸‹ä¸€æŒ‡ä»¤åœ°å€ï¼Œä¹Ÿå°±æ˜¯PCçš„å€¼ã€‚ 80 81 82 83 84 85 86 87 88 89 func (c *sigctxt) pushCall(targetPC, resumePC uintptr) { // Make it look like we called target at resumePC. // è®©å®ƒçœ‹èµ·æ¥åƒæˆ‘ä»¬åœ¨resumePCä¸Šè°ƒç”¨äº†targetã€‚ sp := uintptr(c.rsp()) // å½“å‰goroutineçš„SP sp -= goarch.PtrSize *(*uintptr)(unsafe.Pointer(sp)) = resumePC // è®¾ç½®å½“å‰ä¸­æ–­ä¿å­˜çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå› ä¸ºä¸­æ–­ç»“æŸåä»è¿™é‡Œæ¢å¤ã€‚ c.set_rsp(uint64(sp)) // ä¿®æ”¹ä¸­æ–­ä¿å­˜çš„ä¸Šä¸‹æ–‡SP c.set_rip(uint64(targetPC)) // ä¿®æ”¹ä¸­æ–­ä¿å­˜çš„ä¸Šä¸‹æ–‡PC } asyncPreempt() ä¸­æ–­ä¿¡å·å‡½æ•°å¤„ç†å®Œåï¼Œgoroutineå¾—åˆ°è¿è¡Œï¼Œç»§ç»­ä»åµŒå…¥çš„æœ¬å‡½æ•°å¼€å§‹æ‰§è¡Œã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/preempt_amd64.sã€‚ 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 TEXT Â·asyncPreempt(SB),NOSPLIT|NOFRAME,$0-0 PUSHQ BP # BPå…¥æ ˆ MOVQ SP, BP # BP = SP # Save flags before clobbering them PUSHFQ # obj doesn't understand ADD/SUB on SP, but does understand ADJSP ADJSP $368 # But vet doesn't know ADJSP, so suppress vet stack checking NOP SP MOVQ AX, 0(SP) MOVQ CX, 8(SP) MOVQ DX, 16(SP) MOVQ BX, 24(SP) MOVQ SI, 32(SP) MOVQ DI, 40(SP) MOVQ R8, 48(SP) MOVQ R9, 56(SP) MOVQ R10, 64(SP) MOVQ R11, 72(SP) MOVQ R12, 80(SP) MOVQ R13, 88(SP) MOVQ R14, 96(SP) MOVQ R15, 104(SP) #ifdef GOOS_darwin CMPB internalâˆ•cpuÂ·X86+const_offsetX86HasAVX(SB), $0 JE 2(PC) VZEROUPPER #endif MOVUPS X0, 112(SP) MOVUPS X1, 128(SP) MOVUPS X2, 144(SP) MOVUPS X3, 160(SP) MOVUPS X4, 176(SP) MOVUPS X5, 192(SP) MOVUPS X6, 208(SP) MOVUPS X7, 224(SP) MOVUPS X8, 240(SP) MOVUPS X9, 256(SP) MOVUPS X10, 272(SP) MOVUPS X11, 288(SP) MOVUPS X12, 304(SP) MOVUPS X13, 320(SP) MOVUPS X14, 336(SP) MOVUPS X15, 352(SP) CALL Â·asyncPreempt2(SB) # è°ƒç”¨asyncPreempt2 # ä¸‹æ¬¡goroutineå†åº¦è¢«è¿è¡Œèµ·æ¥æ—¶ï¼Œä»è¿™é‡Œæ¢å¤ã€‚ MOVUPS 352(SP), X15 MOVUPS 336(SP), X14 MOVUPS 320(SP), X13 MOVUPS 304(SP), X12 MOVUPS 288(SP), X11 MOVUPS 272(SP), X10 MOVUPS 256(SP), X9 MOVUPS 240(SP), X8 MOVUPS 224(SP), X7 MOVUPS 208(SP), X6 MOVUPS 192(SP), X5 MOVUPS 176(SP), X4 MOVUPS 160(SP), X3 MOVUPS 144(SP), X2 MOVUPS 128(SP), X1 MOVUPS 112(SP), X0 MOVQ 104(SP), R15 MOVQ 96(SP), R14 MOVQ 88(SP), R13 MOVQ 80(SP), R12 MOVQ 72(SP), R11 MOVQ 64(SP), R10 MOVQ 56(SP), R9 MOVQ 48(SP), R8 MOVQ 40(SP), DI MOVQ 32(SP), SI MOVQ 24(SP), BX MOVQ 16(SP), DX MOVQ 8(SP), CX MOVQ 0(SP), AX ADJSP $-368 POPFQ POPQ BP RET # è¿”å›ç»§ç»­å»æ‰§è¡ŒåŸæ¥çš„goroutineä»£ç  asyncPreempt2() æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/preempt.goã€‚ 301 302 303 304 305 306 307 308 309 310 311 312 313 314 //go:nosplit func asyncPreempt2() { gp := getg() gp.asyncSafePoint = true // preemptStop ä¸»è¦åœ¨GCæ ‡è®°æœŸé—´è¢«ç”¨æ¥æŒ‚èµ·è¿è¡Œä¸­çš„ goroutine if gp.preemptStop { // preemptParkä¼šæŠŠå½“å‰gåˆ‡æ¢è‡³_GpreemptedçŠ¶æ€ï¼Œç„¶åè°ƒç”¨scheduleå‡½æ•° mcall(preemptPark) } else { // é€šè¿‡preemptoneå‡½æ•°å‘èµ·çš„å¼‚æ­¥æŠ¢å ä¼šè°ƒç”¨gopreempt_må‡½æ•°ï¼Œå®ƒæœ€ç»ˆä¹Ÿä¼šè°ƒç”¨scheduleå‡½æ•° mcall(gopreempt_m) } gp.asyncSafePoint = false } gopreempt_m() æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 3402 3403 3404 3405 3406 3407 func gopreempt_m(gp *g) { if trace.enabled { traceGoPreempt() } goschedImpl(gp) } goschedImpl() GåŠ å…¥å…¨å±€é˜Ÿåˆ—ï¼Œè§£é™¤Gä¸Mçš„å…³ç³»ï¼Œå†æ¬¡å‘èµ·è°ƒåº¦å¾ªç¯ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 3366 3367 3368 3369 3370 3371 3372 3373 3374 3375 3376 3377 3378 3379 3380 func goschedImpl(gp *g) { status := readgstatus(gp) // è·å–GçŠ¶æ€ if status\u0026^_Gscan != _Grunning { dumpgstatus(gp) throw(\"bad g status\") } // ä¿®æ”¹GçŠ¶æ€ _Grunnable casgstatus(gp, _Grunning, _Grunnable) dropg() // è§£é™¤ç»‘å®šå…³ç³» lock(\u0026sched.lock) globrunqput(gp) // åŠ å…¥å…¨å±€é“¾è¡¨ unlock(\u0026sched.lock) schedule() // è°ƒåº¦å¾ªç¯ } ",
  "wordCount" : "8774",
  "inLanguage": "zh",
  "image": "https://helium.github.io/favicon-32x32.png","datePublished": "2024-07-31T00:00:00Z",
  "dateModified": "2024-07-31T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://helium.github.io/posts/golang/goroutine/retake/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://helium.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://helium.github.io/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://helium.github.io/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://helium.github.io/" title="ä¸»é¡µ">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/posts" title="æ–‡ç« ">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/archives" title="æ—¶é—´è½´">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/tags/" title="æ ‡ç­¾">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/search/" title="æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/support" title="æ‰“èµ">
                    <span>ğŸ«¶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://helium.github.io/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://helium.github.io/posts/">Article</a>&nbsp;Â»&nbsp;<a href="https://helium.github.io/posts/golang/">Golang</a>&nbsp;Â»&nbsp;<a href="https://helium.github.io/posts/golang/goroutine/">ç¬¬12ç«  Goroutine</a></div>
    <h1 class="post-title entry-hint-parent">
      è¢«åŠ¨è®©å‡ºè°ƒåº¦
    </h1>
    <div class="post-description">
      ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬
    </div>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2024-07-31</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2024-07-31</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>8774å­—</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>42åˆ†é’Ÿ</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &nbsp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://helium.github.io/tags/golang/" target="_blank" rel="noopener">Golang</a>
            <a href="https://helium.github.io/tags/goroutine/" target="_blank" rel="noopener">Goroutine</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &nbsp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e6%8a%a2%e5%8d%a0%e6%a0%87%e8%af%86" aria-label="æŠ¢å æ ‡è¯†">æŠ¢å æ ‡è¯†</a><ul>
                            
                    <li>
                        <a href="#retake" aria-label="retake()">retake()</a><ul>
                            
                    <li>
                        <a href="#incidlelocked" aria-label="incidlelocked()">incidlelocked()</a></li></ul>
                    </li>
                    <li>
                        <a href="#preemptone" aria-label="preemptone()">preemptone()</a></li>
                    <li>
                        <a href="#handoffp" aria-label="handoffp()">handoffp()</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%93%8d%e5%ba%94%e6%8a%a2%e5%8d%a0%e8%af%b7%e6%b1%82" aria-label="å“åº”æŠ¢å è¯·æ±‚">å“åº”æŠ¢å è¯·æ±‚</a><ul>
                            
                    <li>
                        <a href="#morestack_noctxt" aria-label="morestack_noctxt()">morestack_noctxt()</a></li>
                    <li>
                        <a href="#morestack" aria-label="morestack()">morestack()</a></li>
                    <li>
                        <a href="#newstack" aria-label="newstack()">newstack()</a><ul>
                            
                    <li>
                        <a href="#canpreemptm" aria-label="canPreemptM">canPreemptM</a></li>
                    <li>
                        <a href="#gopreempt_m" aria-label="gopreempt_m">gopreempt_m</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8%e5%89%8d%e5%90%8e" aria-label="ç³»ç»Ÿè°ƒç”¨å‰å">ç³»ç»Ÿè°ƒç”¨å‰å</a><ul>
                            
                    <li>
                        <a href="#%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8" aria-label="ç³»ç»Ÿè°ƒç”¨">ç³»ç»Ÿè°ƒç”¨</a><ul>
                            
                    <li>
                        <a href="#syscall6" aria-label="Syscall6()">Syscall6()</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8%e5%89%8d" aria-label="ç³»ç»Ÿè°ƒç”¨å‰">ç³»ç»Ÿè°ƒç”¨å‰</a><ul>
                            
                    <li>
                        <a href="#entersyscall" aria-label="entersyscall()">entersyscall()</a></li>
                    <li>
                        <a href="#reentersyscall" aria-label="reentersyscall()">reentersyscall()</a></li>
                    <li>
                        <a href="#save" aria-label="save()">save()</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8%e5%90%8e" aria-label="ç³»ç»Ÿè°ƒç”¨å">ç³»ç»Ÿè°ƒç”¨å</a><ul>
                            
                    <li>
                        <a href="#exitsyscall" aria-label="exitsyscall()">exitsyscall()</a></li>
                    <li>
                        <a href="#exitsyscallfast" aria-label="exitsyscallfast()">exitsyscallfast()</a></li>
                    <li>
                        <a href="#exitsyscallfast_pidle" aria-label="exitsyscallfast_pidle()">exitsyscallfast_pidle()</a></li>
                    <li>
                        <a href="#exitsyscall0" aria-label="exitsyscall0()">exitsyscall0()</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e4%bf%a1%e5%8f%b7%e5%bd%a2%e5%bc%8f%e5%8f%91%e9%80%81%e6%8a%a2%e5%8d%a0" aria-label="ä¿¡å·å½¢å¼å‘é€æŠ¢å ">ä¿¡å·å½¢å¼å‘é€æŠ¢å </a><ul>
                            
                    <li>
                        <a href="#preemptm" aria-label="preemptM()">preemptM()</a></li>
                    <li>
                        <a href="#signalm" aria-label="signalM()">signalM()</a></li>
                    <li>
                        <a href="#tgkill" aria-label="tgkill()">tgkill()</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%85%a8%e5%b1%80%e4%bf%a1%e5%8f%b7%e5%a4%84%e7%90%86%e6%b3%a8%e5%86%8c" aria-label="å…¨å±€ä¿¡å·å¤„ç†æ³¨å†Œ">å…¨å±€ä¿¡å·å¤„ç†æ³¨å†Œ</a><ul>
                            
                    <li>
                        <a href="#mstart1" aria-label="mstart1()">mstart1()</a></li>
                    <li>
                        <a href="#mstartm0" aria-label="mstartm0()">mstartm0()</a></li>
                    <li>
                        <a href="#initsig" aria-label="initsig()">initsig()</a></li>
                    <li>
                        <a href="#setsig" aria-label="setsig()">setsig()</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%bf%a1%e5%8f%b7%e5%bd%a2%e5%bc%8f%e5%93%8d%e5%ba%94%e6%8a%a2%e5%8d%a0" aria-label="ä¿¡å·å½¢å¼å“åº”æŠ¢å ">ä¿¡å·å½¢å¼å“åº”æŠ¢å </a><ul>
                            
                    <li>
                        <a href="#sigtramp" aria-label="sigtramp()">sigtramp()</a></li>
                    <li>
                        <a href="#sigtrampgo" aria-label="sigtrampgo()">sigtrampgo()</a></li>
                    <li>
                        <a href="#sighander" aria-label="sighander()">sighander()</a></li>
                    <li>
                        <a href="#dosigpreempt" aria-label="doSigPreempt()">doSigPreempt()</a></li>
                    <li>
                        <a href="#wantasyncpreempt" aria-label="wantAsyncPreempt()">wantAsyncPreempt()</a></li>
                    <li>
                        <a href="#isasyncsafepoint" aria-label="isAsyncSafePoint()">isAsyncSafePoint()</a></li>
                    <li>
                        <a href="#pushcall" aria-label="pushCall()">pushCall()</a></li>
                    <li>
                        <a href="#asyncpreempt" aria-label="asyncPreempt()">asyncPreempt()</a></li>
                    <li>
                        <a href="#asyncpreempt2" aria-label="asyncPreempt2()">asyncPreempt2()</a></li>
                    <li>
                        <a href="#gopreempt_m-1" aria-label="gopreempt_m()">gopreempt_m()</a></li>
                    <li>
                        <a href="#goschedimpl" aria-label="goschedImpl()">goschedImpl()</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><ol>
<li>æŠ¢å è°ƒåº¦ï¼ˆgoroutineå› è¿è¡Œæ—¶é—´è¿‡é•¿ï¼‰ã€‚
<ul>
<li><strong>æŠ¢å è°ƒåº¦</strong>ï¼šå› <code>goroutine</code>è¿è¡Œæ—¶é—´è¿‡é•¿è€Œå‘ç”Ÿçš„ã€‚</li>
<li><code>goroutine</code>å› è¯»å†™<code>channel</code>ç­‰é˜»å¡è€Œå¯¼è‡´çš„<strong>è¢«åŠ¨è°ƒåº¦</strong>ï¼Œä»¥åŠé€šè¿‡è°ƒç”¨<code>Gosched()</code>å‡½æ•°å‘èµ·çš„<strong>ä¸»åŠ¨è°ƒåº¦</strong>ã€‚</li>
</ul>
</li>
</ol>
<h2 id="æŠ¢å æ ‡è¯†">æŠ¢å æ ‡è¯†<a hidden class="anchor" aria-hidden="true" href="#æŠ¢å æ ‡è¯†">#</a></h2>
<h3 id="retake">retake()<a hidden class="anchor" aria-hidden="true" href="#retake">#</a></h3>
<ol>
<li><strong>_Prunning</strong>ï¼Œè¡¨ç¤ºå¯¹åº”çš„<code>goroutine</code>æ­£åœ¨è¿è¡Œï¼Œå¦‚æœå…¶è¿è¡Œæ—¶é—´è¶…è¿‡äº†10æ¯«ç§’åˆ™å¯¹éœ€è¦æŠ¢å ã€‚</li>
<li><strong>_Psyscall</strong>ï¼Œè¡¨ç¤ºå¯¹åº”çš„<code>goroutine</code>æ­£åœ¨å†…æ ¸æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œæ­¤æ—¶éœ€è¦æ ¹æ®å¤šä¸ªæ¡ä»¶æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦æŠ¢å ã€‚</li>
<li>è¯¥å‡½æ•°<strong>åªåœ¨</strong><code>sysmon</code>ç›‘æ§çº¿ç¨‹ä¸­è¢«è°ƒç”¨ã€‚</li>
<li>å‚æ•°<code>now int64</code>ï¼šå½“å‰æ—¶é—´ã€‚</li>
<li>è¿”å›å€¼<code>uint32</code>ï¼šå¤„äºç³»ç»Ÿè°ƒç”¨ä¸­éœ€è¦æŠ¢å <code>P</code>çš„æ•°é‡ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// forcePreemptNS is the time slice given to a G before it is
</span></span></span><span class="line"><span class="cl"><span class="c1">// preempted.
</span></span></span><span class="line"><span class="cl"><span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1">// forcePreemptNS æ˜¯åœ¨Gè¢«æŠ¢å ä¹‹å‰ç»™å®ƒçš„æ—¶é—´ç‰‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">const</span> <span class="nx">forcePreemptNS</span> <span class="p">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span> <span class="c1">// 10ms
</span></span></span></code></pre></div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5285
</span><span class="lnt">5286
</span><span class="lnt">5287
</span><span class="lnt">5288
</span><span class="lnt">5289
</span><span class="lnt">5290
</span><span class="lnt">5291
</span><span class="lnt">5292
</span><span class="lnt">5293
</span><span class="lnt">5294
</span><span class="lnt">5295
</span><span class="lnt">5296
</span><span class="lnt">5297
</span><span class="lnt">5298
</span><span class="lnt">5299
</span><span class="lnt">5300
</span><span class="lnt">5301
</span><span class="lnt">5302
</span><span class="lnt">5303
</span><span class="lnt">5304
</span><span class="lnt">5305
</span><span class="lnt">5306
</span><span class="lnt">5307
</span><span class="lnt">5308
</span><span class="lnt">5309
</span><span class="lnt">5310
</span><span class="lnt">5311
</span><span class="lnt">5312
</span><span class="lnt">5313
</span><span class="lnt">5314
</span><span class="lnt">5315
</span><span class="lnt">5316
</span><span class="lnt">5317
</span><span class="lnt">5318
</span><span class="lnt">5319
</span><span class="lnt">5320
</span><span class="lnt">5321
</span><span class="lnt">5322
</span><span class="lnt">5323
</span><span class="lnt">5324
</span><span class="lnt">5325
</span><span class="lnt">5326
</span><span class="lnt">5327
</span><span class="lnt">5328
</span><span class="lnt">5329
</span><span class="lnt">5330
</span><span class="lnt">5331
</span><span class="lnt">5332
</span><span class="lnt">5333
</span><span class="lnt">5334
</span><span class="lnt">5335
</span><span class="lnt">5336
</span><span class="lnt">5337
</span><span class="lnt">5338
</span><span class="lnt">5339
</span><span class="lnt">5340
</span><span class="lnt">5341
</span><span class="lnt">5342
</span><span class="lnt">5343
</span><span class="lnt">5344
</span><span class="lnt">5345
</span><span class="lnt">5346
</span><span class="lnt">5347
</span><span class="lnt">5348
</span><span class="lnt">5349
</span><span class="lnt">5350
</span><span class="lnt">5351
</span><span class="lnt">5352
</span><span class="lnt">5353
</span><span class="lnt">5354
</span><span class="lnt">5355
</span><span class="lnt">5356
</span><span class="lnt">5357
</span><span class="lnt">5358
</span><span class="lnt">5359
</span><span class="lnt">5360
</span><span class="lnt">5361
</span><span class="lnt">5362
</span><span class="lnt">5363
</span><span class="lnt">5364
</span><span class="lnt">5365
</span><span class="lnt">5366
</span><span class="lnt">5367
</span><span class="lnt">5368
</span><span class="lnt">5369
</span><span class="lnt">5370
</span><span class="lnt">5371
</span><span class="lnt">5372
</span><span class="lnt">5373
</span><span class="lnt">5374
</span><span class="lnt">5375
</span><span class="lnt">5376
</span><span class="lnt">5377
</span><span class="lnt">5378
</span><span class="lnt">5379
</span><span class="lnt">5380
</span><span class="lnt">5381
</span><span class="lnt">5382
</span><span class="lnt">5383
</span><span class="lnt">5384
</span><span class="lnt">5385
</span><span class="lnt">5386
</span><span class="lnt">5387
</span><span class="lnt">5388
</span><span class="lnt">5389
</span><span class="lnt">5390
</span><span class="lnt">5391
</span><span class="lnt">5392
</span><span class="lnt">5393
</span><span class="lnt">5394
</span><span class="lnt">5395
</span><span class="lnt">5396
</span><span class="lnt">5397
</span><span class="lnt">5398
</span><span class="lnt">5399
</span><span class="lnt">5400
</span><span class="lnt">5401
</span><span class="lnt">5402
</span><span class="lnt">5403
</span><span class="lnt">5404
</span><span class="lnt">5405
</span><span class="lnt">5406
</span><span class="lnt">5407
</span><span class="lnt">5408
</span><span class="lnt">5409
</span><span class="lnt">5410
</span><span class="lnt">5411
</span><span class="lnt">5412
</span><span class="lnt">5413
</span><span class="lnt">5414
</span><span class="lnt">5415
</span><span class="lnt">5416
</span><span class="lnt">5417
</span><span class="lnt">5418
</span><span class="lnt">5419
</span><span class="lnt">5420
</span><span class="lnt">5421
</span><span class="lnt">5422
</span><span class="lnt">5423
</span><span class="lnt">5424
</span><span class="lnt">5425
</span><span class="lnt">5426
</span><span class="lnt">5427
</span><span class="lnt">5428
</span><span class="lnt">5429
</span><span class="lnt">5430
</span><span class="lnt">5431
</span><span class="lnt">5432
</span><span class="lnt">5433
</span><span class="lnt">5434
</span><span class="lnt">5435
</span><span class="lnt">5436
</span><span class="lnt">5437
</span><span class="lnt">5438
</span><span class="lnt">5439
</span><span class="lnt">5440
</span><span class="lnt">5441
</span><span class="lnt">5442
</span><span class="lnt">5443
</span><span class="lnt">5444
</span><span class="lnt">5445
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// æ£€æŸ¥æ‰€æœ‰çš„PæŸ¥çœ‹æ˜¯å¦å­˜åœ¨è¿è¡Œæ—¶é—´å¤ªé•¿çš„Géœ€è¦è®¾ç½®æŠ¢å è¯·æ±‚ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">//  1. goroutineè¿è¡Œæ—¶é—´è¶…è¿‡10msæ—¶éœ€è¦æŠ¢å ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">//  2. goroutineé™·å…¥ç³»ç»Ÿè°ƒç”¨ï¼Œè¿è¡Œæ—¶é—´è¶…è¿‡10msæˆ–åœ¨ç¬¬äºŒè½®æ¥æ˜¯sysmonç³»ç»Ÿè°ƒç”¨è¿˜æ²¡è¿”å›æ—¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">// é™·å…¥ç³»ç»Ÿè°ƒç”¨è€ŒæŠ¢å Pçš„æƒ…å†µï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1">//  1. è¿è¡Œæ—¶é—´è¶…è¿‡10msï¼Œå¯èƒ½ä¸€å¼€å§‹å°±é™·å…¥ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ–ä¸­é€”é™·å…¥ç³»ç»Ÿè°ƒç”¨ã€‚ä¸è®ºé‚£ç§æƒ…å†µéƒ½åº”è¯¥æŠ¢å ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">//  2. è¿è¡Œæ—¶é—´æ²¡åˆ°10msï¼Œä½†æ˜¯ä¸¤è½®sysmonäº†è¿˜æ˜¯åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­ï¼Œéœ€è¦æŠ¢å Pã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">retake</span><span class="p">(</span><span class="nx">now</span> <span class="kt">int64</span><span class="p">)</span> <span class="kt">uint32</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">n</span> <span class="o">:=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) é”ä½ allpï¼Œç°åœ¨éœ€è¦éå†æ‰€æœ‰çš„PæŸ¥çœ‹æ˜¯å¦å­˜åœ¨è¿è¡Œæ—¶é—´è¿‡é•¿è€Œéœ€è¦æŠ¢å çš„Gã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Prevent allp slice changes. This lock will be completely
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// uncontended unless we&#39;re already stopping the world.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é˜²æ­¢ allp åˆ‡ç‰‡æ›´æ”¹ã€‚ é™¤éæˆ‘ä»¬å·²ç»STWï¼Œå¦åˆ™è¿™æŠŠé”å°†æ˜¯å®Œå…¨æ— äººäº‰å¤ºçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">allpLock</span><span class="p">)</span> <span class="c1">// allpåŠ é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// 2) éå†æ‰€æœ‰çš„Pï¼Œæ ¹æ®è¿è¡Œæ—¶é—´æ˜¯å¦è®¾ç½®æŠ¢å æ ‡å¿—ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// We can&#39;t use a range loop over allp because we may
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// temporarily drop the allpLock. Hence, we need to re-fetch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// allp each time around the loop.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨rangeæ¥éå†allpï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½ä¼šæš‚æ—¶æ”¾å¼ƒallpLocké”ï¼ˆä¼šæš‚æ—¶è§£é”ï¼‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ¯æ¬¡å¾ªç¯ä¸­é‡æ–°è·å–allpã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// rangeä¼šæ‹·è´ï¼Œå› æ­¤å¢é•¿æˆ–ç¼©å°äº†allpä¸ä¼šå®æ—¶å˜åŒ–ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">allp</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span> <span class="c1">// éå†æ‰€æœ‰çš„P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_p_</span> <span class="o">:=</span> <span class="nx">allp</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 2.1) æœªåˆå§‹åŒ–çš„Pè·³è¿‡ã€‚å¯èƒ½æ­£åœ¨å¢é•¿Pã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">_p_</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// This can happen if procresize has grown
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// allp but not yet created new Ps.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦‚æœprocresizeå·²ç»å¢é•¿äº†æ‰€æœ‰pï¼Œä½†è¿˜æ²¡æœ‰åˆ›å»ºæ–°çš„pï¼Œåˆ™å¯èƒ½å‘ç”Ÿè¿™ç§æƒ…å†µã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// 2.2) åˆ¤æ–­æ˜¯å¦è¿è¡Œæ—¶é—´è¿‡é•¿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// _p_.sysmontickç”¨äºsysmonçº¿ç¨‹è®°å½•è¢«ç›‘æ§pçš„ç³»ç»Ÿè°ƒç”¨æ—¶é—´å’Œè¿è¡Œæ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  type sysmontick struct {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//      schedtick   uint32      // è°ƒåº¦å™¨è°ƒåº¦æ¬¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//      schedwhen   int64       // ä¸Šæ¬¡è°ƒåº¦æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//      syscalltick uint32      // ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//      syscallwhen int64       // ä¸Šæ¬¡è°ƒåº¦æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">pd</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">sysmontick</span>           <span class="c1">// ä¸sysmonçº¿ç¨‹ç›¸å…³
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1">// _Prunningï¼šå¯¹åº”çš„goroutineæ­£åœ¨è¿è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// _Psyscallï¼šå¯¹åº”çš„goroutineæ­£åœ¨å†…æ ¸æ‰§è¡Œç³»ç»Ÿè°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">s</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span> <span class="c1">// På½“å‰æ‰€å¤„çŠ¶æ€ _Prunningï¼Œ_Psyscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1">// æ ‡è®°å½“å‰Pæ˜¯å¦å·²è®¾ç½®æŠ¢å è¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// false.æœªè®¾ç½® true.å·²è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sysretake</span> <span class="o">:=</span> <span class="kc">false</span> 
</span></span><span class="line"><span class="cl">        <span class="c1">// 2.3) å…ˆåˆ¤æ–­ schedtick å’Œ schedwhen æ—¶é—´æ˜¯å¦è¿è¡Œæ—¶é—´è¿‡é•¿ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Gçš„è¿è¡Œæ—¶é—´æ˜¯åŒ…æ‹¬ç³»ç»Ÿè°ƒç”¨çš„æ—¶é—´çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">s</span> <span class="o">==</span> <span class="nx">_Prunning</span> <span class="o">||</span> <span class="nx">s</span> <span class="o">==</span> <span class="nx">_Psyscall</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Preempt G if it&#39;s running for too long.	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦‚æœGè¿è¡Œå¤ªä¹…ï¼Œå°±æŠ¢å å®ƒã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            
</span></span><span class="line"><span class="cl">            <span class="c1">// _p_.schedtickè°ƒåº¦æ¬¡æ•°ï¼Œè¯¥å€¼æ˜¯åœ¨Pä¸Šçš„ï¼Œè®°å½•å½“å‰çš„è°ƒåº¦æ¬¡æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æ³¨æ„åŒºåˆ«sysmontickä¸Šçš„schedtick
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">t</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">schedtick</span><span class="p">)</span> <span class="c1">// _p_.schedtickï¼šæ¯å‘ç”Ÿä¸€æ¬¡è°ƒåº¦ï¼Œè°ƒåº¦å™¨++è¯¥å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            
</span></span><span class="line"><span class="cl">            <span class="c1">// pd.schedtick == tè¯´æ˜(pd.schedwhenï½now)è¿™æ®µæ—¶é—´æœªå‘ç”Ÿè¿‡è°ƒåº¦ï¼ˆè¿™ç§æƒ…å†µä¹Ÿå°±æ˜¯æˆ‘ä»¬è¦å¤„ç†çš„æŠ¢å æƒ…å†µï¼‰ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æ‰€ä»¥è¿™æ®µæ—¶é—´æ˜¯åŒä¸€ä¸ªgoroutineä¸€ç›´åœ¨è¿è¡Œï¼Œä¸‹é¢æ£€æŸ¥ä¸€ç›´è¿è¡Œæ˜¯å¦è¶…è¿‡äº†10æ¯«ç§’ï¼Œå¦åˆ™åˆ™æ˜¯å‘ç”Ÿè¿‡è°ƒåº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">pd</span><span class="p">.</span><span class="nx">schedtick</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">t</span> <span class="p">{</span> <span class="c1">// å¦‚æœä¸ç›¸ç­‰è¯´æ˜æ˜¯ä¸€æ¬¡æ–°çš„è°ƒåº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// ç›‘æ§çº¿ç¨‹ç›‘æ§åˆ°ä¸€æ¬¡æ–°çš„è°ƒåº¦ï¼Œæ‰€ä»¥é‡ç½®è·Ÿsysmonç›¸å…³çš„schedtickå’Œschedwhenå˜é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 2.4) æ£€æµ‹åˆ°ä¸‹æ¬¡è°ƒåº¦ï¼Œæ›´æ–°è°ƒåº¦æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">pd</span><span class="p">.</span><span class="nx">schedtick</span> <span class="p">=</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nx">pd</span><span class="p">.</span><span class="nx">schedwhen</span> <span class="p">=</span> <span class="nx">now</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">pd</span><span class="p">.</span><span class="nx">schedwhen</span><span class="o">+</span><span class="nx">forcePreemptNS</span> <span class="o">&lt;=</span> <span class="nx">now</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 2.4) æœ¬æ¬¡è°ƒåº¦å·²è¶…è¿‡ 10msï¼Œè®¾ç½®æŠ¢å æ ‡è¯†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// ä»æŸgoroutineç¬¬ä¸€æ¬¡è¢«sysmonçº¿ç¨‹ç›‘æ§åˆ°æ­£åœ¨è¿è¡Œä¸€ç›´è¿è¡Œåˆ°ç°åœ¨è¶…è¿‡äº†10æ¯«ç§’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// æŠ¢å ç”¨æˆ·ä»£ç çš„goroutineæ—¶æ˜¯éœ€è¦åˆ¤æ–­æ˜¯å¦èƒ½æŠ¢å çš„æ¡ä»¶çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">preemptone</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="c1">// è®¾ç½®æŠ¢å è¯·æ±‚ï¼Œéç³»ç»Ÿè°ƒç”¨æ—¶åœ¨è¿™é‡Œåå°±ç»“æŸäº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                
</span></span><span class="line"><span class="cl">                <span class="c1">// In case of syscall, preemptone() doesn&#39;t
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// work, because there is no M wired to P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// åœ¨ç³»ç»Ÿè°ƒç”¨çš„æƒ…å†µä¸‹ï¼Œpreemptone()ä¸èµ·ä½œç”¨ï¼Œå› ä¸ºMæ²¡æœ‰è¿æ¥åˆ°Pã€‚æ­¤æ—¶å·²ç»é™·å…¥åˆ°ç³»ç»Ÿè°ƒåº¦ä¸­ï¼Œä¸ä¼šå“åº”è¯·æ±‚ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">sysretake</span> <span class="p">=</span> <span class="kc">true</span> <span class="c1">// å·²æ ‡è®°äº†æŠ¢å 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 2.4) æœ¬åœ°è°ƒåº¦è¿è¡Œæ—¶é—´è¿˜æœªåˆ°10msã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// 2.5) På¤„äºç³»ç»Ÿè°ƒç”¨ä¹‹ä¸­æ—¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">s</span> <span class="o">==</span> <span class="nx">_Psyscall</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Retake P from syscall if it&#39;s there for more than 1 sysmon tick (at least 20us).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦‚æœPå­˜åœ¨è¶…è¿‡1ä¸ªsysmon tick(è‡³å°‘20us)ï¼Œåˆ™ä»sycallä¸­é‡æ–°å–Pã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// _p_.syscalltickç”¨äºè®°å½•ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°ï¼Œä¸»è¦ç”±å·¥ä½œçº¿ç¨‹åœ¨å®Œæˆç³»ç»Ÿè°ƒç”¨ä¹‹å++
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">t</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">syscalltick</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">            <span class="c1">// sysretake = falseï¼šå‰é¢æ²¡æœ‰è®¾ç½®æŠ¢å æ ‡å¿—ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  1. æœ¬è½®è°ƒåº¦Gè¿˜æ²¡åˆ°è¾¾10msã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  2. æ–°çš„ä¸€è½®è°ƒåº¦ï¼Œå·²ç»é‡ç½®äº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// int64(pd.syscalltick) != tï¼šæ–°çš„ä¸€è½®ç³»ç»Ÿè°ƒåº¦äº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">!</span><span class="nx">sysretake</span> <span class="o">&amp;&amp;</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">pd</span><span class="p">.</span><span class="nx">syscalltick</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">t</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">pd</span><span class="p">.</span><span class="nx">syscalltick</span> <span class="p">=</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="c1">// update syscalltick
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">pd</span><span class="p">.</span><span class="nx">syscallwhen</span> <span class="p">=</span> <span class="nx">now</span> <span class="c1">// update syscallwhen
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// 2.6) sysretake == true || (sysretake == false &amp;&amp; int64(pd.syscalltick) == t)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  1. sysretake == trueï¼šå‰é¢å·²ç»è®¾ç½®äº†æŠ¢å è¯·æ±‚ï¼ŒGè¿è¡Œæ—¶é—´è¶…è¿‡äº†10msï¼Œç°åœ¨å¤„äºç³»ç»Ÿè°ƒç”¨ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  2. (sysretake == false &amp;&amp; int64(pd.syscalltick) == t)ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//      goroutineæ²¡æœ‰è¶…è¿‡10msï¼Œä½†æ˜¯ç›‘æ§å…ˆåˆ°ç¬¬äºŒè½®äº†ï¼Œç°åœ¨å¤„äºç³»ç»Ÿè°ƒç”¨ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//      å› æ­¤è¿™ç§æƒ…å†µå–å†³äºç›‘æ§çº¿ç¨‹çš„è°ƒåº¦æ—¶é—´é—´éš”ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            
</span></span><span class="line"><span class="cl">            <span class="c1">// On the one hand we don&#39;t want to retake Ps if there is no other work to do,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// but on the other hand we want to retake them eventually
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// because they can prevent the sysmon thread from deep sleep.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ä¸€æ–¹é¢æˆ‘ä»¬ä¸æƒ³åœ¨æ²¡æœ‰å…¶ä»–å·¥ä½œçš„æƒ…å†µä¸‹é‡æ–°è·å– Psï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦ä¸€æ–¹é¢æˆ‘ä»¬å¸Œæœ›æœ€ç»ˆé‡æ–°è·å–å®ƒä»¬ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥é˜²æ­¢ sysmon çº¿ç¨‹æ·±åº¦ç¡çœ ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// åªè¦æ»¡è¶³ä¸‹é¢ä¸‰ä¸ªæ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œåˆ™æŠ¢å è¯¥pï¼Œå¦åˆ™ä¸æŠ¢å 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  1. pçš„è¿è¡Œé˜Ÿåˆ—é‡Œé¢æœ‰ç­‰å¾…è¿è¡Œçš„goroutineã€‚ï¼ˆæœ‰éœ€è¦è¿è¡Œçš„goroutineï¼Œéœ€è¦æŠ¢å Pï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  2. æ²¡æœ‰æ— æ‰€äº‹äº‹çš„pï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰è‡ªæ—‹çš„Pæˆ–ç©ºé—²çš„Pã€‚ï¼ˆç³»ç»Ÿå¾ˆå¿™ï¼Œéœ€è¦æŠ¢å Pï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  3. ä»ä¸Šä¸€æ¬¡ç›‘æ§çº¿ç¨‹è§‚å¯Ÿåˆ°på¯¹åº”çš„må¤„äºç³»ç»Ÿè°ƒç”¨ä¹‹ä¸­åˆ°ç°åœ¨å·²ç»è¶…è¿‡10äº†æ¯«ç§’ã€‚ï¼ˆç³»ç»Ÿè°ƒç”¨æ—¶é—´å¤ªé•¿ï¼Œéœ€è¦æŠ¢å Pï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nf">runqempty</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">)</span><span class="o">+</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">npidle</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">pd</span><span class="p">.</span><span class="nx">syscallwhen</span><span class="o">+</span><span class="mi">10</span><span class="o">*</span><span class="mi">1000</span><span class="o">*</span><span class="mi">1000</span> <span class="p">&gt;</span> <span class="nx">now</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="c1">// ä¸éœ€è¦æŠ¢å ï¼š_p_æœ¬åœ°é˜Ÿåˆ—ä¸ºç©º &amp;&amp; å­˜åœ¨è‡ªæ—‹æˆ–ç©ºé—²çš„Pï¼ˆç³»ç»Ÿä¸å¿™ï¼‰ &amp;&amp; ç³»ç»Ÿè°ƒç”¨æ—¶é—´è¿˜æ²¡æœ‰è¶…è¿‡äº†10ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                  <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// Drop allpLock so we can take sched.lock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿™é‡Œæ˜¯å‰é¢ä¸èƒ½æœ‰for rangeçš„åŸå› ï¼Œè§£é”è¿™æ®µæ—¶é—´å¯èƒ½allpä¼šå‘ç”Ÿå˜åŒ–ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">allpLock</span><span class="p">)</span>   <span class="c1">// è§£é” allpLock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            
</span></span><span class="line"><span class="cl">            <span class="c1">// Need to decrement number of idle locked M&#39;s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// (pretending that one more is running) before the CAS.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Otherwise the M from which we retake can exit the syscall,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// increment nmidle and report deadlock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// éœ€è¦åœ¨CASä¹‹å‰å‡å°‘ç©ºé—²é”å®šMçš„æ•°é‡(å‡è£…è¿˜æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œ)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦åˆ™ï¼Œæˆ‘ä»¬é‡æ–°è·å–çš„Må¯ä»¥é€€å‡ºç³»ç»Ÿè°ƒç”¨ï¼Œå¢åŠ nmidå¹¶æŠ¥å‘Šæ­»é”ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">incidlelocked</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>   <span class="c1">// sched.nmidlelocked += -1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿™é‡Œä½¿ç”¨Casä¿®æ”¹Pçš„ä½¿ç”¨æƒï¼ŒåŸå› æ˜¯æ­¤æ—¶æ­¤åˆ»æ­£å¥½å­˜åœ¨ç³»ç»Ÿè°ƒç”¨è¿”å›äº†ï¼Œä¹Ÿæ­£åœ¨è·å–Pçš„ä½¿ç”¨æƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦‚æœä½¿ç”¨æƒè·å–æˆåŠŸåˆ™è°ƒç”¨handoffp()å¯»æ‰¾æ–°çš„å·¥ä½œçº¿ç¨‹æ¥æ¥ç®¡è¿™ä¸ªp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// _Pidleï¼šç©ºé—²çŠ¶æ€ã€‚æ­¤æ—¶çš„Pæ²¡æœ‰è¢«ç”¨æ¥æ‰§è¡Œç”¨æˆ·ä»£ç æˆ–è°ƒåº¦å™¨ä»£ç ï¼Œé€šå¸¸ä½äºç©ºé—²é“¾è¡¨ä¸­ï¼Œèƒ½å¤Ÿè¢«è°ƒåº¦å™¨è·å–ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å®ƒçš„çŠ¶æ€å¯èƒ½æ­£åœ¨ç”±ç©ºé—²è½¬å˜æˆå…¶ä»–çŠ¶æ€ã€‚Pçš„æ‰€æœ‰æƒå½’ç©ºé—²é“¾è¡¨æˆ–æŸä¸ªæ­£åœ¨æ”¹å˜å®ƒçŠ¶æ€çš„çº¿ç¨‹æ‰€æœ‰ï¼Œæœ¬åœ°runqä¸ºç©ºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Cas</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">_Pidle</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">traceGoSysBlock</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">traceProcStop</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nx">n</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">                <span class="nx">_p_</span><span class="p">.</span><span class="nx">syscalltick</span><span class="o">++</span> <span class="c1">// ç³»ç»Ÿè°ƒåº¦æ¬¡æ•°åŠ ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// å°è¯•å¯»æ‰¾ä¸€ä¸ªæ–°çš„må‡ºæ¥æ¥ç®¡P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// æŠ¢å é™·å…¥ç³»ç»Ÿè°ƒç”¨çš„Pæ—¶ï¼Œæ²¡æœ‰å¤šä½™çš„æ¡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">handoffp</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nf">incidlelocked</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">allpLock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">allpLock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="incidlelocked">incidlelocked()<a hidden class="anchor" aria-hidden="true" href="#incidlelocked">#</a></h4>
<ol>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5505
</span><span class="lnt">5506
</span><span class="lnt">5507
</span><span class="lnt">5508
</span><span class="lnt">5509
</span><span class="lnt">5510
</span><span class="lnt">5511
</span><span class="lnt">5512
</span><span class="lnt">5513
</span><span class="lnt">5514
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">incidlelocked</span><span class="p">(</span><span class="nx">v</span> <span class="kt">int32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// nmidlelocked é”å®šç­‰å¾…å·¥ä½œçš„Mçš„æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åªä¼šåœ¨è¯¥å‡½æ•°ä¸­åŠ å‡ï¼Œåœ¨checkdead()å‡½æ•°ä¸­åˆ¤æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sched</span><span class="p">.</span><span class="nx">nmidlelocked</span> <span class="o">+=</span> <span class="nx">v</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">v</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">checkdead</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="preemptone">preemptone()<a hidden class="anchor" aria-hidden="true" href="#preemptone">#</a></h3>
<ol>
<li><code>sysmon</code>çº¿ç¨‹å¦‚æœç›‘æ§åˆ°æŸä¸ª<code>goroutine</code>è¿ç»­è¿è¡Œè¶…è¿‡äº†10æ¯«ç§’ï¼Œåˆ™ä¼šè°ƒç”¨<code>preemptone()</code>å‡½æ•°å‘è¯¥<code>goroutine</code>å‘å‡ºæŠ¢å è¯·æ±‚ã€‚</li>
<li>å‘Šè¯‰åœ¨å¤„ç†å™¨<code>P</code>ä¸Šè¿è¡Œçš„<code>goroutine</code>åœæ­¢ã€‚</li>
<li>è¿™ä¸ªå‡½æ•°åªæ˜¯å°½äº†æœ€å¤§åŠªåŠ›ã€‚å®ƒå¯èƒ½ä¼šé”™è¯¯åœ°æ²¡æœ‰é€šçŸ¥<code>goroutine</code>ã€‚ä¹Ÿå¯èƒ½ä¼šé€šçŸ¥é”™è¯¯çš„<code>goroutine</code>ã€‚</li>
<li>å³ä½¿å®ƒé€šçŸ¥äº†æ­£ç¡®çš„<code>goroutine</code>ï¼Œå¦‚æœ<code>goroutine</code>åŒæ—¶æ‰§è¡Œ<code>newstack</code>ï¼Œå®ƒå¯èƒ½ä¼šå¿½ç•¥è¯·æ±‚ã€‚</li>
<li>ä¸éœ€è¦é”ã€‚å¦‚æœå‘å‡ºæŠ¢å è¯·æ±‚ï¼Œåˆ™è¿”å›trueã€‚</li>
<li>å®é™…çš„æŠ¢å å°†åœ¨æœªæ¥çš„æŸä¸ªæ—¶é—´ç‚¹å‘ç”Ÿï¼Œå¹¶ä¸”å°†ç”±<code>gp-&gt;status</code>ä¸å†æ˜¯<code>Grunning</code>è¡¨ç¤ºã€‚è®¾ç½®æŠ¢å è¯·æ±‚ã€‚</li>
<li>è¯¥å‡½æ•°ä¼šåœ¨<code>retake()</code>å‡½æ•°ä¸­è°ƒç”¨ï¼Œ<code>GC</code>æœŸé—´è°ƒç”¨ã€‚</li>
<li>å¯ä»¥çœ‹å‡ºï¼Œ<code>preemptone</code>å‡½æ•°åªæ˜¯ç®€å•çš„è®¾ç½®äº†è¢«æŠ¢å <code>goroutine</code>å¯¹åº”çš„<code>g</code>ç»“æ„ä½“ä¸­çš„ <strong>preempt</strong>æˆå‘˜ä¸º<code>true</code>å’Œ<strong>stackguard0</strong>æˆå‘˜ä¸º<code>stackPreempt</code>ï¼ˆ<code>stackPreempt</code>æ˜¯ä¸€ä¸ªå¸¸é‡<code>0xfffffffffffffade</code>ï¼Œæ˜¯éå¸¸å¤§çš„ä¸€ä¸ªæ•°ï¼‰å°±è¿”å›äº†ï¼Œå¹¶æœªçœŸæ­£å¼ºåˆ¶è¢«æŠ¢å çš„<code>goroutine</code>æš‚åœä¸‹æ¥ã€‚</li>
<li>æ—¢ç„¶è®¾ç½®äº†ä¸€äº›æŠ¢å æ ‡å¿—ï¼Œé‚£ä¹ˆå°±ä¸€å®šéœ€è¦å¯¹è¿™äº›æ ‡å¿—è¿›è¡Œå¤„ç†ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥åˆ†æè¢«æŠ¢å çš„<code>goroutine</code>å¦‚ä½•å¤„ç†è¿™äº›æ ‡å¿—å»å“åº”ç›‘æ§çº¿ç¨‹æå‡ºçš„æŠ¢å è¯·æ±‚ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">5378
</span><span class="lnt">5379
</span><span class="lnt">5380
</span><span class="lnt">5381
</span><span class="lnt">5382
</span><span class="lnt">5383
</span><span class="lnt">5384
</span><span class="lnt">5385
</span><span class="lnt">5386
</span><span class="lnt">5387
</span><span class="lnt">5388
</span><span class="lnt">5389
</span><span class="lnt">5390
</span><span class="lnt">5391
</span><span class="lnt">5392
</span><span class="lnt">5393
</span><span class="lnt">5394
</span><span class="lnt">5395
</span><span class="lnt">5396
</span><span class="lnt">5397
</span><span class="lnt">5398
</span><span class="lnt">5399
</span><span class="lnt">5400
</span><span class="lnt">5401
</span><span class="lnt">5402
</span><span class="lnt">5403
</span><span class="lnt">5404
</span><span class="lnt">5405
</span><span class="lnt">5406
</span><span class="lnt">5407
</span><span class="lnt">5408
</span><span class="lnt">5409
</span><span class="lnt">5410
</span><span class="lnt">5411
</span><span class="lnt">5412
</span><span class="lnt">5413
</span><span class="lnt">5414
</span><span class="lnt">5415
</span><span class="lnt">5416
</span><span class="lnt">5417
</span><span class="lnt">5418
</span><span class="lnt">5419
</span><span class="lnt">5420
</span><span class="lnt">5421
</span><span class="lnt">5422
</span><span class="lnt">5423
</span><span class="lnt">5424
</span><span class="lnt">5425
</span><span class="lnt">5426
</span><span class="lnt">5427
</span><span class="lnt">5428
</span><span class="lnt">5429
</span><span class="lnt">5430
</span><span class="lnt">5431
</span><span class="lnt">5432
</span><span class="lnt">5433
</span><span class="lnt">5434
</span><span class="lnt">5435
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Tell the goroutine running on processor P to stop.
</span></span></span><span class="line"><span class="cl"><span class="c1">// This function is purely best-effort. It can incorrectly fail to inform the
</span></span></span><span class="line"><span class="cl"><span class="c1">// goroutine. It can inform the wrong goroutine. Even if it informs the
</span></span></span><span class="line"><span class="cl"><span class="c1">// correct goroutine, that goroutine might ignore the request if it is
</span></span></span><span class="line"><span class="cl"><span class="c1">// simultaneously executing newstack.
</span></span></span><span class="line"><span class="cl"><span class="c1">// No lock needs to be held.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Returns true if preemption request was issued.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The actual preemption will happen at some point in the future
</span></span></span><span class="line"><span class="cl"><span class="c1">// and will be indicated by the gp-&gt;status no longer being
</span></span></span><span class="line"><span class="cl"><span class="c1">// Grunning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">preemptone</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) æŠ¢å Pçš„å…³è”çš„m
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mp</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>   <span class="c1">// mp := m
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// 2) æŠ¢å çš„Pæ²¡æœ‰ç»‘å®šMï¼Œæˆ–æŠ¢å çš„Pçš„Mä¸å½“å‰è¿è¡ŒGçš„Mä¸€è‡´ã€ä¸è®¾ç½®æŠ¢å æ ‡å¿—ã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. mp == nilï¼šå¯èƒ½æ¥è‡ªsysmonæŠ¢å ç©ºé—²çš„Pçš„æ—¶å€™ï¼Œè¿™æ—¶å€™Pæ˜¯æ²¡æœ‰ç»‘å®šMçš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. mp == getg().mï¼šæŠ¢å çš„æ˜¯è‡ªå·±ï¼Œå¾ˆå¤§å¯èƒ½è¿™ç§æƒ…å†µæ¥è‡ªGCåœ¨ç­‰å¾…å…¶ä»–Påœä¸‹æ¥çš„æ—¶å€™ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">mp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">mp</span> <span class="o">==</span> <span class="nf">getg</span><span class="p">().</span><span class="nx">m</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 3) æŠ¢å çš„å·¥ä½œçº¿ç¨‹åˆšå¥½å¤„ç†å®Œgoroutineï¼Œæˆ–æŠ¢å çš„å·¥ä½œçº¿ç¨‹æ­£åœ¨g0ä¸­ã€ä¸è®¾ç½®æŠ¢å æ ‡å¿—ã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">curg</span>   <span class="c1">// mpå·¥ä½œçº¿ç¨‹ä¸Šæ­£åœ¨è¿è¡Œçš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 1. gp == nilï¼šå½“å‰å·¥ä½œçº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„goroutineåˆšå¥½è¿è¡Œå®Œè¢«è°ƒç¦»Mæ—¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2. gp == mp.g0ï¼šå½“å‰æ­£åœ¨g0ä¸Šï¼Œå¯èƒ½åœ¨æ‰§è¡Œè°ƒåº¦ä»£ç ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">gp</span> <span class="o">==</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">g0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">preempt</span> <span class="p">=</span> <span class="kc">true</span> <span class="c1">// æ ‡è®°æ­£åœ¨è¿è¡Œçš„Pçš„gè®¾ç½®æŠ¢å æ ‡å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Every call in a goroutine checks for stack overflow by
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// comparing the current stack pointer to gp-&gt;stackguard0.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Setting gp-&gt;stackguard0 to StackPreempt folds
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// preemption into the normal stack overflow check.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// goroutineä¸­çš„æ¯ä¸ªè°ƒç”¨éƒ½é€šè¿‡å°†å½“å‰å †æ ˆæŒ‡é’ˆä¸gp-&gt;stackguard0è¿›è¡Œæ¯”è¾ƒæ¥æ£€æŸ¥å †æ ˆæº¢å‡ºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è®¾ç½®gp-&gt;stackguard0ä¸ºStackPreemptå°†æŠ¢å è½¬æ¢ä¸ºæ­£å¸¸çš„æ ˆæº¢å‡ºæ£€æŸ¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// stackPreemptæ˜¯ä¸€ä¸ªå¸¸é‡0xfffffffffffffadeï¼Œæ˜¯éå¸¸å¤§çš„ä¸€ä¸ªæ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">stackPreempt</span> <span class="c1">// è®¾ç½®stackguard0ä½¿è¢«æŠ¢å çš„goroutineå»å¤„ç†æŠ¢å è¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Request an async preemption of this P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¯·æ±‚è¿™ä¸ªPçš„å¼‚æ­¥æŠ¢å ã€‚è¿™ç§æƒ…å†µæ˜¯å¯¹äºæ²¡æœ‰è°ƒç”¨ä»»ä½•å‡½æ•°çš„goroutineï¼Œæ²¡æœ‰æŠ¢å æœºä¼šçš„æƒ…å†µä¸‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. preemptMSupportedï¼šå…¶ä¸­çš„ preemptMSupported æ˜¯ä¸ªå¸¸é‡ï¼Œå› ä¸ºå—ç¡¬ä»¶ç‰¹æ€§çš„é™åˆ¶ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     åœ¨æŸäº›å¹³å°ä¸Šæ˜¯æ— æ³•æ”¯æŒè¿™ç§æŠ¢å çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. debug.asyncpreemptoffï¼šåˆ™æ˜¯è®©ç”¨æˆ·å¯ä»¥é€šè¿‡ GODEBUG ç¯å¢ƒå˜é‡æ¥ç¦ç”¨å¼‚æ­¥æŠ¢å ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     é»˜è®¤æƒ…å†µä¸‹æ˜¯è¢«å¯ç”¨çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">preemptMSupported</span> <span class="o">&amp;&amp;</span> <span class="nx">debug</span><span class="p">.</span><span class="nx">asyncpreemptoff</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åœ¨Pçš„æ•°æ®ç»“æ„ä¸­ä¹Ÿæ–°å¢äº†ä¸€ä¸ªpreemptå­—æ®µï¼Œè¿™é‡Œä¼šæŠŠå®ƒè®¾ç½®ä¸ºtrueã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_p_</span><span class="p">.</span><span class="nx">preempt</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å®é™…ä¸ŠæŠ¢å æ“ä½œæ˜¯ç”± preemptM å‡½æ•°å®Œæˆçš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">preemptM</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>	<span class="c1">// è¯¥å‡½æ•°å‘èµ·å¼‚æ­¥æŠ¢å ç»™MPå‘é€æŠ¢å ä¿¡å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="handoffp">handoffp()<a hidden class="anchor" aria-hidden="true" href="#handoffp">#</a></h3>
<ol>
<li>ä»ç³»ç»Ÿè°ƒç”¨ä¸­å…³é—­<code>P</code>æˆ–é”å®š<code>M</code>ã€‚æ€»æ˜¯åœ¨æ²¡æœ‰<code>P</code>çš„æƒ…å†µä¸‹è¿è¡Œï¼Œå› æ­¤ä¸å…è®¸æœ‰å†™å±éšœã€‚</li>
<li><code>handoffp()</code>å‡½æ•°ä¸»è¦ä»»åŠ¡æ˜¯é€šè¿‡å„ç§æ¡ä»¶åˆ¤æ–­æ˜¯å¦éœ€è¦å¯åŠ¨å·¥ä½œçº¿ç¨‹æ¥æ¥ç®¡<code>_p_</code>ï¼Œå¦‚æœä¸éœ€è¦åˆ™æŠŠ<code>_p_</code>æ”¾å…¥<code>P</code>çš„å…¨å±€ç©ºé—²é˜Ÿåˆ—ã€‚
<ol>
<li><code>_p_</code>çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—æˆ–å…¨å±€è¿è¡Œé˜Ÿåˆ—é‡Œé¢æœ‰å¾…è¿è¡Œçš„<code>goroutine</code>ã€‚</li>
<li>éœ€è¦å¸®åŠ©<code>gc</code>å®Œæˆæ ‡è®°å·¥ä½œã€‚</li>
<li>ç³»ç»Ÿæ¯”è¾ƒå¿™ï¼Œæ‰€æœ‰å…¶å®ƒ<code>_p_</code>éƒ½åœ¨è¿è¡Œ<code>goroutine</code>ï¼Œéœ€è¦å¸®å¿™ã€‚</li>
<li>æ‰€æœ‰å…¶å®ƒ<code>P</code>éƒ½å·²ç»å¤„äºç©ºé—²çŠ¶æ€ï¼Œå¦‚æœéœ€è¦ç›‘æ§ç½‘ç»œè¿æ¥è¯»å†™äº‹ä»¶ï¼Œåˆ™éœ€è¦å¯åŠ¨æ–°çš„<code>m</code>æ¥<code>poll</code>ç½‘ç»œè¿æ¥ã€‚</li>
</ol>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2350
</span><span class="lnt">2351
</span><span class="lnt">2352
</span><span class="lnt">2353
</span><span class="lnt">2354
</span><span class="lnt">2355
</span><span class="lnt">2356
</span><span class="lnt">2357
</span><span class="lnt">2358
</span><span class="lnt">2359
</span><span class="lnt">2360
</span><span class="lnt">2361
</span><span class="lnt">2362
</span><span class="lnt">2363
</span><span class="lnt">2364
</span><span class="lnt">2365
</span><span class="lnt">2366
</span><span class="lnt">2367
</span><span class="lnt">2368
</span><span class="lnt">2369
</span><span class="lnt">2370
</span><span class="lnt">2371
</span><span class="lnt">2372
</span><span class="lnt">2373
</span><span class="lnt">2374
</span><span class="lnt">2375
</span><span class="lnt">2376
</span><span class="lnt">2377
</span><span class="lnt">2378
</span><span class="lnt">2379
</span><span class="lnt">2380
</span><span class="lnt">2381
</span><span class="lnt">2382
</span><span class="lnt">2383
</span><span class="lnt">2384
</span><span class="lnt">2385
</span><span class="lnt">2386
</span><span class="lnt">2387
</span><span class="lnt">2388
</span><span class="lnt">2389
</span><span class="lnt">2390
</span><span class="lnt">2391
</span><span class="lnt">2392
</span><span class="lnt">2393
</span><span class="lnt">2394
</span><span class="lnt">2395
</span><span class="lnt">2396
</span><span class="lnt">2397
</span><span class="lnt">2398
</span><span class="lnt">2399
</span><span class="lnt">2400
</span><span class="lnt">2401
</span><span class="lnt">2402
</span><span class="lnt">2403
</span><span class="lnt">2404
</span><span class="lnt">2405
</span><span class="lnt">2406
</span><span class="lnt">2407
</span><span class="lnt">2408
</span><span class="lnt">2409
</span><span class="lnt">2410
</span><span class="lnt">2411
</span><span class="lnt">2412
</span><span class="lnt">2413
</span><span class="lnt">2414
</span><span class="lnt">2415
</span><span class="lnt">2416
</span><span class="lnt">2417
</span><span class="lnt">2418
</span><span class="lnt">2419
</span><span class="lnt">2420
</span><span class="lnt">2421
</span><span class="lnt">2422
</span><span class="lnt">2423
</span><span class="lnt">2424
</span><span class="lnt">2425
</span><span class="lnt">2426
</span><span class="lnt">2427
</span><span class="lnt">2428
</span><span class="lnt">2429
</span><span class="lnt">2430
</span><span class="lnt">2431
</span><span class="lnt">2432
</span><span class="lnt">2433
</span><span class="lnt">2434
</span><span class="lnt">2435
</span><span class="lnt">2436
</span><span class="lnt">2437
</span><span class="lnt">2438
</span><span class="lnt">2439
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Hands off P from syscall or locked M.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Always runs without a P, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">handoffp</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// handoffp must start an M in any situation where
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// findrunnable would return a G to run on _p_.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨findrunnableè¿”å›Gå¹¶åœ¨_p_ä¸Šè¿è¡Œçš„ä»»ä½•æƒ…å†µä¸‹ï¼Œhandffpå¿…é¡»å¼€å§‹ä¸€ä¸ªMã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// if it has local work, start it straight away
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœå®ƒæœ‰æœ¬åœ°å·¥ä½œï¼Œéœ€è¦å¯åŠ¨mæ¥æ¥ç®¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nf">runqempty</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="o">||</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">runqsize</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">startm</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span> <span class="c1">// åˆ›å»ºMæ¥æ¥ç®¡P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// if there&#39;s trace work to do, start it straight away
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">||</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">shutdown</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nf">traceReaderAvailable</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">startm</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// if it has GC work, start it straight away
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// GCæ­£åœ¨å·¥ä½œï¼Œä¹Ÿéœ€è¦å¯åŠ¨mæ¥æ¥ç®¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gcBlackenEnabled</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nf">gcMarkWorkAvailable</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">startm</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// no local work, check that there are no spinning/idle M&#39;s,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// otherwise our help is not required
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ²¡æœ‰æœ¬åœ°å·¥ä½œï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ spinning/idle çš„Mï¼Œå¦åˆ™ä¸éœ€è¦æˆ‘ä»¬çš„å¸®åŠ©ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. atomic.Load(&amp;sched.nmspinning)+atomic.Load(&amp;sched.npidle) == 0ï¼šæ²¡æœ‰è‡ªæ—‹çš„Må’Œç©ºé—²çš„Pæ—¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. atomic.Cas(&amp;sched.nmspinning, 0, 1)ï¼šsched.nmspinning = 1ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">)</span><span class="o">+</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">npidle</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Cas</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// TODO: fast atomic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">startm</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="c1">// è¿™æ—¶å€™å¯åŠ¨çš„Mç»‘å®šPå¯ä»¥èµ·å»å…¶ä»–Pä¸­å·å–ä»»åŠ¡ï¼Œå¦‚æœå­˜åœ¨ç©ºé—²çš„Påˆ™è¡¨ç¤ºå…¶ä»–Pä¸å¿™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// GCæ­£åœ¨STWç­‰å¾…æ—¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">gcwaiting</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span> <span class="p">=</span> <span class="nx">_Pgcstop</span> <span class="c1">// ä¿®æ”¹çŠ¶æ€ä¸ºGCè€Œåœä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sched</span><span class="p">.</span><span class="nx">stopwait</span><span class="o">--</span>      <span class="c1">// å› ä¸ºGCè€Œåœä¸‹æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å½“å‰STWè¦æ±‚çš„På…¨éƒ¨åœä¸‹æ¥æ—¶ï¼Œå°±å¯ä»¥å”¤é†’ç­‰å¾…åœ¨sched.stopnoteä¸Šçš„å‘èµ·STWçš„çº¿ç¨‹äº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">stopwait</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">notewakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">stopnote</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runSafePointFn</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Cas</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runSafePointFn</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sched</span><span class="p">.</span><span class="nf">safePointFn</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sched</span><span class="p">.</span><span class="nx">safePointWait</span><span class="o">--</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">safePointWait</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">notewakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">safePointNote</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å…¨å±€é˜Ÿåˆ—æ± æœ‰Géœ€è¦å¤„ç†æ—¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">runqsize</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">startm</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// If this is the last running P and nobody is polling network,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// need to wakeup another M to poll network.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœè¿™æ˜¯æœ€åä¸€ä¸ªè¿è¡Œçš„På¹¶ä¸”æ²¡æœ‰å…¶ä»–çº¿ç¨‹åœ¨é˜»å¡å¼ç­‰å¾…netpollï¼Œéœ€è¦å”¤é†’ä¸€ä¸ªMæ¥å¤„ç†netpollã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. sched.npidle == uint32(gomaxprocs-1)ï¼šå½“å‰æ˜¯æœ€åä¸€ä¸ªç©ºé—²P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. atomic.Load64(&amp;sched.lastpoll) != 0ï¼šæ²¡æœ‰å…¶ä»–çº¿ç¨‹åœ¨é˜»å¡å¼è®¿é—®netpollã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">npidle</span> <span class="o">==</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">gomaxprocs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lastpoll</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">startm</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// The scheduler lock cannot be held when calling wakeNetPoller below
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// because wakeNetPoller may call wakep which may call startm.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“è°ƒç”¨wakeNetPolleræ—¶ï¼Œè°ƒåº¦å™¨é”ä¸èƒ½ä¿æŒï¼Œå› ä¸ºwakeNetPollerå¯èƒ½ä¼šè°ƒç”¨wakeepï¼Œè€Œåè€…å¯èƒ½ä¼šè°ƒç”¨startmã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">when</span> <span class="o">:=</span> <span class="nf">nobarrierWakeTime</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="c1">// æœ€æ–°timerè§¦å‘æ—¶é—´ç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">pidleput</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">//æ— äº‹å¯åšï¼ŒæŠŠpæ”¾å…¥å…¨å±€ç©ºé—²é˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">when</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">wakeNetPoller</span><span class="p">(</span><span class="nx">when</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// èµ°åˆ°è¿™é‡Œä¸ä¼šæŠ¢å P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å“åº”æŠ¢å è¯·æ±‚">å“åº”æŠ¢å è¯·æ±‚<a hidden class="anchor" aria-hidden="true" href="#å“åº”æŠ¢å è¯·æ±‚">#</a></h2>
<ol>
<li>æŠ¢å çš„ç›¸å…³å‡½æ•°è°ƒç”¨é“¾<code>morestack_noctxt()</code>-&gt;<code>morestack()</code>-&gt;<code>newstack()</code>ã€‚</li>
<li>ä»æºä»£ç ä¸­<code>morestack()</code>å‡½æ•°çš„æ³¨é‡Šå¯ä»¥çŸ¥é“ï¼Œè¯¥å‡½æ•°ä¼šè¢«ç¼–è¯‘å™¨è‡ªåŠ¨æ’å…¥åˆ°å‡½æ•° <strong>åºè¨€(prologue)</strong> ä¸­ã€‚</li>
</ol>
<h3 id="morestack_noctxt">morestack_noctxt()<a hidden class="anchor" aria-hidden="true" href="#morestack_noctxt">#</a></h3>
<ol>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1"># morestack but not preserving ctxt.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">morestack_noctxt</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="p">,</span><span class="no">$0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">$0</span><span class="p">,</span> <span class="no">DX</span>              <span class="c1"># DX = 0ï¼ŒDXå¯„å­˜å™¨è¢«ç”¨ä½œå‡½æ•°è°ƒç”¨çš„éšè—ä¼ å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JMP</span>	<span class="no">runtime</span><span class="err">Â·</span><span class="no">morestack</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>   <span class="c1"># æ³¨æ„è¿™é‡Œä½¿ç”¨çš„æ˜¯JMPä¸æ˜¯CALLå› æ­¤ä¸æ˜¯å‡½æ•°è°ƒç”¨
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>æˆ‘ä»¬å‡è®¾æ˜¯åœ¨<code>main.main</code>å‡½æ•°åºè¨€ä¸­è°ƒç”¨äº†<code>morestack_noctxt()</code>å‡½æ•°ï¼Œåˆ™å‡½æ•°çš„æ ˆå¸§ç»“æ„å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">//  +10 | 
</span></span><span class="line"><span class="cl">//      ----------------------------    runtime.main SP
</span></span><span class="line"><span class="cl">//  +08 | runtime.main callback
</span></span><span class="line"><span class="cl">//      ----------------------------    main.main SP
</span></span><span class="line"><span class="cl">//  +00 | main.main callback
</span></span><span class="line"><span class="cl">//      ----------------------------    morestack_noctxt SP
</span></span><span class="line"><span class="cl">//
</span></span><span class="line"><span class="cl">//      runtimeÂ·morestack(SB)æ˜¯é€šè¿‡JMPè°ƒç”¨çš„ï¼Œæ‰€ä»¥æ²¡æœ‰é‡æ–°åˆ†é…æ ˆå¸§
</span></span></code></pre></div><h3 id="morestack">morestack()<a hidden class="anchor" aria-hidden="true" href="#morestack">#</a></h3>
<ol>
<li>å½“éœ€è¦æ›´å¤šæ ˆæ—¶ï¼Œåœ¨å‡½æ•°<code>prolog</code>æœŸé—´è°ƒç”¨ã€‚</li>
<li>å›æº¯ä¾‹ç¨‹å°†<code>g0</code>ä¸Šçš„<code>morestack</code>è§†ä¸ºæ ˆçš„é¡¶éƒ¨(ä¾‹å¦‚ï¼Œ<code>morestack</code>è°ƒç”¨<code>newstack</code>è°ƒç”¨è°ƒåº¦å™¨è°ƒç”¨<code>newm</code>è°ƒç”¨<code>gc</code>)ï¼Œ</li>
<li>å› æ­¤æˆ‘ä»¬å¿…é¡»è®°å½•å‚æ•°å¤§å°ã€‚ä¸ºæ­¤ï¼Œå®ƒæ²¡æœ‰å‚æ•°ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚</li>
<li>è¯¥å‡½æ•°ï¼Œä¿æŠ¤è°ƒç”¨è€…ä¿¡æ¯ï¼Œåˆ‡æ¢åˆ°g0æ ˆè°ƒç”¨runtimeÂ·newstackæ–¹æ³•ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1"># Called during function prolog when more stack is needed.
</span></span></span><span class="line"><span class="cl"><span class="c1">#
</span></span></span><span class="line"><span class="cl"><span class="c1"># The traceback routines see morestack on a g0 as being
</span></span></span><span class="line"><span class="cl"><span class="c1"># the top of a stack (for example, morestack calling newstack
</span></span></span><span class="line"><span class="cl"><span class="c1"># calling the scheduler calling newm calling gc), so we must
</span></span></span><span class="line"><span class="cl"><span class="c1"># record an argument size. For that purpose, it has no arguments.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">morestack</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="p">,</span><span class="no">$0-0</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Cannot grow scheduler stack (m-&gt;g0).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">get_tls</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>             <span class="c1"># CX = &amp;m.tls[1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">g</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">BX</span>       <span class="c1"># BX = m.tls[0] = g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">g_m</span><span class="p">(</span><span class="no">BX</span><span class="p">),</span> <span class="no">BX</span>     <span class="c1"># BX = g.m
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">m_g0</span><span class="p">(</span><span class="no">BX</span><span class="p">),</span> <span class="no">SI</span>    <span class="c1"># SI = m.g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPQ</span>    <span class="no">g</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">SI</span>       <span class="c1"># æ¯”è¾ƒå½“å‰gæ˜¯å¦æ˜¯g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JNE</span>	<span class="mi">3</span><span class="p">(</span><span class="no">PC</span><span class="p">)</span> <span class="c1"># åˆ¤æ–­ä¸ä¸ºé›¶æ—¶åˆ™è·³è½¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># runtimeÂ·badmorestackg0 é”™è¯¯ä¿¡æ¯ &#34;morestack()å‡½æ•°åœ¨g0æ ˆä¸Šè¢«è°ƒç”¨&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">badmorestackg0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># int 3 è¿›å…¥ä¸­æ–­æŒ‡ä»¤ï¼Œè¿™æ˜¯ä¸€ä¸ªè°ƒè¯•æŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">abort</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Cannot grow signal stack (m-&gt;gsignal).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">m_gsignal</span><span class="p">(</span><span class="no">BX</span><span class="p">),</span> <span class="no">SI</span>   <span class="c1"># SI = m.gsignal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPQ</span>    <span class="no">g</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">SI</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JNE</span>	<span class="mi">3</span><span class="p">(</span><span class="no">PC</span><span class="p">)</span> <span class="c1"># åˆ¤æ–­ä¸ä¸ºé›¶æ—¶åˆ™è·³è½¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># runtimeÂ·badmorestackgsignal é”™è¯¯ä¿¡æ¯ &#34;morestack()å‡½æ•°åœ¨gsignalä¸Šè¢«è°ƒç”¨&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">badmorestackgsignal</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">abort</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Called from f.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># Set m-&gt;morebuf to f&#39;s caller.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä»fè°ƒç”¨ã€‚è®¾ç½®m-&gt;morebufä¸ºfçš„è°ƒç”¨è€…ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># NOP SP æŒ‡ä»¤æ„ä¹‰ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   1. NOP SPæŒ‡ä»¤ä¸åšä»»ä½•æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒä¼šå°†å †æ ˆæŒ‡é’ˆ(SP)å‘åç§»åŠ¨0ä¸ªå­—èŠ‚ï¼Œè¿™å®é™…ä¸Šæ˜¯æ²¡æœ‰ä»»ä½•æ•ˆæœçš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   2. åœ¨ Go çš„æ±‡ç¼–è¯­è¨€ä¸­ï¼Œæœ‰æ—¶éœ€è¦ä½¿ç”¨ &#34;NOP SP&#34; è¿™æ¡æŒ‡ä»¤æ¥è¿›è¡ŒæŒ‡ä»¤å¯¹é½ï¼Œä½†è¿™ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´ vet å·¥å…·äº§ç”Ÿè¯¯æŠ¥ï¼Œå› ä¸ºå®ƒä¼šè®¤ä¸ºè¿™ä¼šå¯¼è‡´å †æ ˆåç§»é‡çš„æ”¹å˜ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># &#34;# tell vet SP changed - stop checking offsets&#34; è¿™è¡Œæ³¨é‡Šçš„æ„ä¹‰ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   1. ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œç¨‹åºå‘˜å¯ä»¥æ·»åŠ è¿™ä¸ªæ³¨é‡Šæ¥å‘Šè¯‰vetå·¥å…·ï¼Œå®é™…ä¸Šæ²¡æœ‰å¯¹å †æ ˆåç§»é‡è¿›è¡Œä»»ä½•æ›´æ”¹ï¼Œå› æ­¤vetå·¥å…·å¯ä»¥åœæ­¢æ£€æŸ¥å †æ ˆåç§»é‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   2. è¿™å¥è¯çš„æ„æ€æ˜¯ï¼Œç¨‹åºå‘˜åœ¨æ·»åŠ NOP SPæŒ‡ä»¤æ—¶é‡åˆ°äº†vetå·¥å…·çš„è¯¯æŠ¥é—®é¢˜ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä»–ä»¬æ·»åŠ äº†è¿™ä¸ªæ³¨é‡Šï¼Œå‘Šè¯‰vetå·¥å…·ä¸éœ€è¦ç»§ç»­æ£€æŸ¥å †æ ˆåç§»é‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æŒ‡ä»¤å¯¹é½ï¼šæ˜¯æŒ‡å°†æŒ‡ä»¤åœ°å€å¯¹é½åˆ°ä¸€å®šçš„è¾¹ç•Œä¸Šï¼Œä½¿å¾—æŒ‡ä»¤çš„æ‰§è¡Œæ•ˆç‡æ›´é«˜ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   1. åœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼ŒCPU é€šå¸¸éœ€è¦ä»å†…å­˜ä¸­è¯»å–æŒ‡ä»¤å¹¶æ‰§è¡Œå®ƒä»¬ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸è€—æ—¶çš„è¿‡ç¨‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   2. ä¸ºäº†æé«˜æ‰§è¡Œæ•ˆç‡ï¼ŒCPU éœ€è¦åœ¨è®¿é—®å†…å­˜æ—¶ä¿æŒä¸€å®šçš„å¯¹é½æ–¹å¼ï¼Œä»¥ä¾¿æ›´å¿«åœ°è¯»å–æŒ‡ä»¤å¹¶è¿›è¡Œå¤„ç†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   3. åœ¨æŒ‡ä»¤å¯¹é½ä¸­ï¼ŒæŒ‡ä»¤åœ°å€é€šå¸¸è¢«è¦æ±‚å¯¹é½åˆ°ä¸€ä¸ªç‰¹å®šçš„è¾¹ç•Œï¼Œé€šå¸¸æ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Œå¦‚2ã€4ã€8ç­‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   4. è¿™æ„å‘³ç€æŒ‡ä»¤åœ°å€çš„ä½ä½å¿…é¡»æ˜¯0ï¼Œè¿™ä½¿å¾— CPU å¯ä»¥æ›´å¿«åœ°è¯»å–æŒ‡ä»¤å¹¶è¿›è¡Œå¤„ç†ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   5. åœ¨ç¼–å†™æ±‡ç¼–è¯­è¨€ç¨‹åºæ—¶ï¼Œç¨‹åºå‘˜é€šå¸¸éœ€è¦æ‰‹åŠ¨å¯¹æŒ‡ä»¤è¿›è¡Œå¯¹é½ã€‚è¿™å¯ä»¥é€šè¿‡æ·»åŠ ä¸€äº›æ— æ“ä½œæŒ‡ä»¤ï¼Œå¦‚NOPæŒ‡ä»¤ï¼Œæ¥å®ç°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   6. è¿™äº›æŒ‡ä»¤ä¸ä¼šå¯¹ç¨‹åºçš„æ‰§è¡Œäº§ç”Ÿä»»ä½•å½±å“ï¼Œåªæ˜¯ç”¨æ¥å¡«å……æŒ‡ä»¤æµä¸­çš„ç©ºéš™ï¼Œä»¥ç¡®ä¿æŒ‡ä»¤åœ°å€å¯¹é½ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#   7. è¿™äº›æ“ä½œå¯ä»¥å¸®åŠ© CPU æ›´å¿«åœ°è¯»å–æŒ‡ä»¤å¹¶æé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">NOP</span>	<span class="no">SP</span>	<span class="c1"># tell vet SP changed - stop checking offsets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1"># ä»¥ä¸‹ä»£ç ä¿å­˜è°ƒç”¨è€…ä¿¡æ¯ï¼Œæ¯”å¦‚åœ¨main.mainçš„åºè¨€ä¸­è°ƒäº†morestack_noctxt()-&gt;morestack()å‡½æ•°ï¼Œéœ€è¦ä¿å­˜çš„æ˜¯main.mainçš„ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1"># 8(SP)ï¼šmainå‡½æ•°åœ¨è°ƒç”¨morestack_noctxtä¹‹å‰çš„rspå¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># é€šè¿‡ä¸Šé¢å‡½æ•°æ ˆå¸§çš„åˆ†é… 8(SP) æ˜¯runtime.mainå‡½æ•°çš„è¿”å›åœ°å€ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ä¿å­˜åœ¨mä¸Šçš„ï¼Œm-&gt;morebuf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä¿å­˜åˆ°m-&gt;morebufç”¨äºæä¾›ç»™æ¥ä¸‹æ¥çš„newstack()å‡½æ•°ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="mi">8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>	<span class="c1"># f&#39;s caller&#39;s PC; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="p">(</span><span class="no">m_morebuf</span><span class="err">+</span><span class="no">gobuf_pc</span><span class="p">)(</span><span class="no">BX</span><span class="p">)</span>    <span class="c1"># m.morebuf.gobuf.pc=AX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 16(SP)ï¼šè°ƒç”¨è€…å‡½æ•°çš„SPï¼Œä¹Ÿå°±æ˜¯runtime.mainçš„SPå¯„å­˜å™¨åœ°å€ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ LEAQ æŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">LEAQ</span>    <span class="mi">16</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>	<span class="c1"># f&#39;s caller&#39;s SP   # AX = 16(SP); è¯¥å€¼æ˜¯runtime.mainå‡½æ•°çš„rspå¯„å­˜å™¨å­˜å‚¨çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="p">(</span><span class="no">m_morebuf</span><span class="err">+</span><span class="no">gobuf_sp</span><span class="p">)(</span><span class="no">BX</span><span class="p">)</span>    <span class="c1"># m.morebuf.gobuf.sp=AX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">get_tls</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>         <span class="c1"># CX = &amp;m.tls[1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">g</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">SI</span>   <span class="c1"># SI = m.tls[0] = g;    è¿™é‡Œæ˜¯gï¼Œä¸æ˜¯g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">SI</span><span class="p">,</span> <span class="p">(</span><span class="no">m_morebuf</span><span class="err">+</span><span class="no">gobuf_g</span><span class="p">)(</span><span class="no">BX</span><span class="p">)</span> <span class="c1"># m.morebuf.gobuf.g = g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»åœ¨m-&gt;morebufä¿å­˜å¥½äº†è°ƒç”¨è€…runtime.mainçš„ripã€rspã€gç›¸å…³ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Set g-&gt;sched to context in f.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å°† g-&gt;sched è®¾ç½®ä¸ºfçš„ä¸Šä¸‹æ–‡ï¼Œè¿™æ‰æ˜¯éœ€è¦æ¢å¤çš„ç°åœºæ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1"># SPæ ˆé¡¶å¯„å­˜å™¨ç°åœ¨æŒ‡å‘çš„æ˜¯morestack_noctxtå‡½æ•°çš„è¿”å›åœ°å€ï¼Œæ³¨æ„ä¸‹é¢éƒ½æ˜¯ä¿å­˜åœ¨gä¸Šçš„ï¼Œg-&gt;schedä¸æ˜¯g0ä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 0(SP)ï¼šé€šè¿‡ä¸Šé¢å‡½æ•°æ ˆå¸§çš„åˆ†é… 0(SP) æ˜¯main.mainå‡½æ•°çš„è¿”å›åœ°å€ï¼Œä¹Ÿå°±æ˜¯ripä¸­çš„å€¼å°±æ˜¯main.mainçš„ä¸‹æ¡ä»£ç åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>   <span class="c1"># f&#39;s PC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># g.sched.gobuf.pc = AX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="p">(</span><span class="no">g_sched</span><span class="err">+</span><span class="no">gobuf_pc</span><span class="p">)(</span><span class="no">SI</span><span class="p">)</span>  <span class="c1"># æ‰§è¡Œå®Œmorestack_noctxtå‡½æ•°ä¹‹ååº”è¯¥è¿”å›å»ç»§ç»­æ‰§è¡ŒæŒ‡ä»¤çš„åœ°å€ AX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 8(SP)ï¼šè°ƒç”¨è€…å‡½æ•°çš„SPï¼Œä¹Ÿå°±æ˜¯main.mainçš„SPå¯„å­˜å™¨åœ°å€ï¼Œè¿™ä¸ªåœ°å€æ˜¯æ²¡æœ‰å‹å…¥ripæŒ‡ä»¤æ•°æ®å‰çš„åœ°å€ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ LEAQ æŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">LEAQ</span>    <span class="mi">8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>                   <span class="c1"># f&#39;s SP;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="p">(</span><span class="no">g_sched</span><span class="err">+</span><span class="no">gobuf_sp</span><span class="p">)(</span><span class="no">SI</span><span class="p">)</span>  <span class="c1"># g.sched.gobuf.sp = AX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ç”±äºBPå¯„å­˜å™¨çš„å€¼ä¸€è‡´æ²¡æœ‰å˜ï¼Œæ‰€ä»¥è¿™é‡ŒBPå¯„å­˜å™¨è¿˜æ˜¯æŒ‡å‘main.mainçš„æ ˆåº•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">BP</span><span class="p">,</span> <span class="p">(</span><span class="no">g_sched</span><span class="err">+</span><span class="no">gobuf_bp</span><span class="p">)(</span><span class="no">SI</span><span class="p">)</span>  <span class="c1"># g.sched.gobuf.bp = BP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># DXå¯„å­˜å™¨è¢«è®¾ç½®ä¸ºäº†0ï¼Œåœ¨runtimeÂ·morestack_noctxt()å‡½æ•°ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">DX</span><span class="p">,</span> <span class="p">(</span><span class="no">g_sched</span><span class="err">+</span><span class="no">gobuf_ctxt</span><span class="p">)(</span><span class="no">SI</span><span class="p">)</span><span class="c1"># g.sched.gobuf.ctxt = DX;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># åˆ°è¿™é‡Œå½“å‰g-&gt;schedå·²ä¿å­˜å¥½äº†æ¢å¤åˆ°main.mainçš„ç°åœºï¼ŒåŒ…æ‹¬ripã€rspã€rbpã€rdx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Call newstack on m-&gt;g0&#39;s stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># åˆ‡æ¢åˆ°g0æ ˆï¼Œå¹¶è®¾ç½®tlsçš„gä¸ºg0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">m_g0</span><span class="p">(</span><span class="no">BX</span><span class="p">),</span> <span class="no">BX</span>                <span class="c1"># BX = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è®¾ç½®TLSä¸­çš„gä¸ºg0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">BX</span><span class="p">,</span> <span class="no">g</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>                   <span class="c1"># m.tls[0] = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æŠŠg0æ ˆçš„æ ˆé¡¶å¯„å­˜å™¨çš„å€¼æ¢å¤åˆ°CPUçš„å¯„å­˜å™¨ï¼Œè¾¾åˆ°åˆ‡æ¢æ ˆçš„ç›®çš„ï¼Œä¸‹é¢è¿™ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œä¹‹å‰ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># CPUè¿˜æ˜¯ä½¿ç”¨çš„è°ƒç”¨æ­¤å‡½æ•°çš„gçš„æ ˆï¼Œæ‰§è¡Œä¹‹åCPUå°±å¼€å§‹ä½¿ç”¨g0çš„æ ˆäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="p">(</span><span class="no">g_sched</span><span class="err">+</span><span class="no">gobuf_sp</span><span class="p">)(</span><span class="no">BX</span><span class="p">),</span> <span class="no">SP</span>  <span class="c1"># rsp = g0.sched.gobuf.sp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">newstack</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>        <span class="c1"># è°ƒç”¨ newstack() å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">abort</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>           <span class="c1"># crash if newstack returns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>æ±‡ç¼–è¯­è¨€<code>&quot;int 3&quot;</code>æ˜¯ä¸€ä¸ªä¸­æ–­æŒ‡ä»¤ï¼Œå®ƒå‘æ“ä½œç³»ç»Ÿå‘å‡ºä¸€ä¸ªè°ƒè¯•ä¿¡å·ï¼Œè¦æ±‚åœ¨ç¨‹åºçš„å½“å‰ä½ç½®åœæ­¢æ‰§è¡Œå¹¶è¿›å…¥è°ƒè¯•å™¨ã€‚</li>
<li>é€šå¸¸ï¼Œè°ƒè¯•å™¨ä¼šåœ¨æ­¤å¤„æš‚åœç¨‹åºçš„æ‰§è¡Œï¼Œå¹¶å…è®¸ç¨‹åºå‘˜æ£€æŸ¥ç¨‹åºçŠ¶æ€ã€å˜é‡å€¼å’Œç¨‹åºæµç¨‹ç­‰ä¿¡æ¯ï¼Œä»¥å¸®åŠ©ä»–ä»¬è°ƒè¯•ç¨‹åºã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">abort</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="p">,</span><span class="no">$0-0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">INT</span>	<span class="no">$3</span>
</span></span><span class="line"><span class="cl"><span class="nl">loop:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JMP</span>	<span class="no">loop</span>
</span></span></code></pre></div><h3 id="newstack">newstack()<a hidden class="anchor" aria-hidden="true" href="#newstack">#</a></h3>
<ol>
<li>è¯¥å‡½æ•°ä¸»è¦æœ‰ä¸¤ä¸ªèŒè´£ï¼šä¸€ä¸ªæ˜¯ã€æ‰©æ ˆã€‘ï¼Œå¦ä¸€ä¸ªæ˜¯å“åº”sysmonæå‡ºçš„ã€æŠ¢å è¯·æ±‚ã€‘ã€‚</li>
<li><code>newstack()</code>å‡½æ•°é¦–å…ˆæ£€æŸ¥<code>g.stackguard0</code>æ˜¯å¦è¢«è®¾ç½®ä¸º<code>stackPreempt</code>ï¼Œå¦‚æœæ˜¯åˆ™è¡¨ç¤º<code>sysmon</code>å·²ç»å‘ç°æˆ‘ä»¬è¿è¡Œå¾—å¤ªä¹…äº†å¹¶å¯¹æˆ‘ä»¬å‘èµ·äº†æŠ¢å è¯·æ±‚ã€‚</li>
<li>å½“éœ€è¦æ›´å¤šå †æ ˆæ—¶ä»<code>runtimeÂ·morestack</code>è°ƒç”¨ã€‚åˆ†é…æ›´å¤§çš„å †æ ˆå¹¶é‡æ–°å®šä½åˆ°æ–°å †æ ˆã€‚å¯¹äºå›ºå®šçš„å¹³æ‘Šä»£ä»·ï¼Œå †æ ˆå¢é•¿æ˜¯ä¹˜æ³•çš„ã€‚</li>
<li><code>g-&gt;atomicstatus</code>å°†åœ¨è¿›å…¥æ—¶è¿›è¡Œ<code>Grunning</code>æˆ–<code>Gscanrunning</code>ã€‚è°ƒåº¦ç¨‹åºè¯•å›¾åœæ­¢è¿™ä¸ª<code>g</code>ï¼Œç„¶åå®ƒå°†è®¾ç½®<code>preemptStop</code>ã€‚</li>
<li>è¿™å¿…é¡»æ˜¯<code>nowritebarrierrec</code>ï¼Œå› ä¸ºå®ƒå¯ä»¥ä½œä¸ºå †æ ˆå¢é•¿çš„ä¸€éƒ¨åˆ†ä»å…¶ä»–<code>nowritebarrierrec</code>å‡½æ•°è°ƒç”¨ï¼Œä½†ç¼–è¯‘å™¨ä¸ä¼šæ£€æŸ¥è¿™ä¸€ç‚¹ã€‚</li>
<li><strong>go:nowritebarrierrec</strong>ï¼šç¼–è¯‘å™¨ä¸æ’å…¥å†™å±éšœç›¸å…³ä»£ç ï¼ŒåŒ…æ‹¬å½“å‰å‡½æ•°ä»¥åŠè°ƒç”¨çš„ä»»ä½•å‡½æ•°ä¸­ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/stack.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 950
</span><span class="lnt"> 951
</span><span class="lnt"> 952
</span><span class="lnt"> 953
</span><span class="lnt"> 954
</span><span class="lnt"> 955
</span><span class="lnt"> 956
</span><span class="lnt"> 957
</span><span class="lnt"> 958
</span><span class="lnt"> 959
</span><span class="lnt"> 960
</span><span class="lnt"> 961
</span><span class="lnt"> 962
</span><span class="lnt"> 963
</span><span class="lnt"> 964
</span><span class="lnt"> 965
</span><span class="lnt"> 966
</span><span class="lnt"> 967
</span><span class="lnt"> 968
</span><span class="lnt"> 969
</span><span class="lnt"> 970
</span><span class="lnt"> 971
</span><span class="lnt"> 972
</span><span class="lnt"> 973
</span><span class="lnt"> 974
</span><span class="lnt"> 975
</span><span class="lnt"> 976
</span><span class="lnt"> 977
</span><span class="lnt"> 978
</span><span class="lnt"> 979
</span><span class="lnt"> 980
</span><span class="lnt"> 981
</span><span class="lnt"> 982
</span><span class="lnt"> 983
</span><span class="lnt"> 984
</span><span class="lnt"> 985
</span><span class="lnt"> 986
</span><span class="lnt"> 987
</span><span class="lnt"> 988
</span><span class="lnt"> 989
</span><span class="lnt"> 990
</span><span class="lnt"> 991
</span><span class="lnt"> 992
</span><span class="lnt"> 993
</span><span class="lnt"> 994
</span><span class="lnt"> 995
</span><span class="lnt"> 996
</span><span class="lnt"> 997
</span><span class="lnt"> 998
</span><span class="lnt"> 999
</span><span class="lnt">1000
</span><span class="lnt">1001
</span><span class="lnt">1002
</span><span class="lnt">1003
</span><span class="lnt">1004
</span><span class="lnt">1005
</span><span class="lnt">1006
</span><span class="lnt">1007
</span><span class="lnt">1008
</span><span class="lnt">1009
</span><span class="lnt">1010
</span><span class="lnt">1011
</span><span class="lnt">1012
</span><span class="lnt">1013
</span><span class="lnt">1014
</span><span class="lnt">1015
</span><span class="lnt">1016
</span><span class="lnt">1017
</span><span class="lnt">1018
</span><span class="lnt">1019
</span><span class="lnt">1020
</span><span class="lnt">1021
</span><span class="lnt">1022
</span><span class="lnt">1023
</span><span class="lnt">1024
</span><span class="lnt">1025
</span><span class="lnt">1026
</span><span class="lnt">1027
</span><span class="lnt">1028
</span><span class="lnt">1029
</span><span class="lnt">1030
</span><span class="lnt">1031
</span><span class="lnt">1032
</span><span class="lnt">1033
</span><span class="lnt">1034
</span><span class="lnt">1035
</span><span class="lnt">1036
</span><span class="lnt">1037
</span><span class="lnt">1038
</span><span class="lnt">1039
</span><span class="lnt">1040
</span><span class="lnt">1041
</span><span class="lnt">1042
</span><span class="lnt">1043
</span><span class="lnt">1044
</span><span class="lnt">1045
</span><span class="lnt">1046
</span><span class="lnt">1047
</span><span class="lnt">1048
</span><span class="lnt">1049
</span><span class="lnt">1050
</span><span class="lnt">1051
</span><span class="lnt">1052
</span><span class="lnt">1053
</span><span class="lnt">1054
</span><span class="lnt">1055
</span><span class="lnt">1056
</span><span class="lnt">1057
</span><span class="lnt">1058
</span><span class="lnt">1059
</span><span class="lnt">1060
</span><span class="lnt">1061
</span><span class="lnt">1062
</span><span class="lnt">1063
</span><span class="lnt">1064
</span><span class="lnt">1065
</span><span class="lnt">1066
</span><span class="lnt">1067
</span><span class="lnt">1068
</span><span class="lnt">1069
</span><span class="lnt">1070
</span><span class="lnt">1071
</span><span class="lnt">1072
</span><span class="lnt">1073
</span><span class="lnt">1074
</span><span class="lnt">1075
</span><span class="lnt">1076
</span><span class="lnt">1077
</span><span class="lnt">1078
</span><span class="lnt">1079
</span><span class="lnt">1080
</span><span class="lnt">1081
</span><span class="lnt">1082
</span><span class="lnt">1083
</span><span class="lnt">1084
</span><span class="lnt">1085
</span><span class="lnt">1086
</span><span class="lnt">1087
</span><span class="lnt">1088
</span><span class="lnt">1089
</span><span class="lnt">1090
</span><span class="lnt">1091
</span><span class="lnt">1092
</span><span class="lnt">1093
</span><span class="lnt">1094
</span><span class="lnt">1095
</span><span class="lnt">1096
</span><span class="lnt">1097
</span><span class="lnt">1098
</span><span class="lnt">1099
</span><span class="lnt">1100
</span><span class="lnt">1101
</span><span class="lnt">1102
</span><span class="lnt">1103
</span><span class="lnt">1104
</span><span class="lnt">1105
</span><span class="lnt">1106
</span><span class="lnt">1107
</span><span class="lnt">1108
</span><span class="lnt">1109
</span><span class="lnt">1110
</span><span class="lnt">1111
</span><span class="lnt">1112
</span><span class="lnt">1113
</span><span class="lnt">1114
</span><span class="lnt">1115
</span><span class="lnt">1116
</span><span class="lnt">1117
</span><span class="lnt">1118
</span><span class="lnt">1119
</span><span class="lnt">1120
</span><span class="lnt">1121
</span><span class="lnt">1122
</span><span class="lnt">1123
</span><span class="lnt">1124
</span><span class="lnt">1125
</span><span class="lnt">1126
</span><span class="lnt">1127
</span><span class="lnt">1128
</span><span class="lnt">1129
</span><span class="lnt">1130
</span><span class="lnt">1131
</span><span class="lnt">1132
</span><span class="lnt">1133
</span><span class="lnt">1134
</span><span class="lnt">1135
</span><span class="lnt">1136
</span><span class="lnt">1137
</span><span class="lnt">1138
</span><span class="lnt">1139
</span><span class="lnt">1140
</span><span class="lnt">1141
</span><span class="lnt">1142
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Called from runtimeÂ·morestack when more stack is needed.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Allocate larger stack and relocate to new stack.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Stack growth is multiplicative, for constant amortized cost.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// g-&gt;atomicstatus will be Grunning or Gscanrunning upon entry.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If the scheduler is trying to stop this g, then it will set preemptStop.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// This must be nowritebarrierrec because it can be called as part of
</span></span></span><span class="line"><span class="cl"><span class="c1">// stack growth from other nowritebarrierrec functions, but the
</span></span></span><span class="line"><span class="cl"><span class="c1">// compiler doesn&#39;t check this.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newstack</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">thisg</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// thisg = g0; æ ¹æ®morestack()å‡½æ•°çš„ç›¸å…³ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// TODO: double check all gp. shouldn&#39;t be getg().
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ ¹æ®morestack()å‡½æ•°çš„ç›¸å…³ä»£ç ï¼Œè¿™é‡Œthisg.m.morebuf.g.ptr()æ˜¯gä¸æ˜¯g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">morebuf</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">stackguard0</span> <span class="o">==</span> <span class="nx">stackFork</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;stack growth after fork&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// m-&gt;curg æ˜¯å½“å‰mä¸Šæ­£åœ¨è¿è¡Œçš„g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">morebuf</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">curg</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;runtime: newstack called from g=&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">morebuf</span><span class="p">.</span><span class="nx">g</span><span class="p">),</span> <span class="s">&#34;\n&#34;</span><span class="o">+</span><span class="s">&#34;\tm=&#34;</span><span class="p">,</span> <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span> <span class="s">&#34; m-&gt;curg=&#34;</span><span class="p">,</span> <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">curg</span><span class="p">,</span> <span class="s">&#34; m-&gt;g0=&#34;</span><span class="p">,</span> <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">g0</span><span class="p">,</span> <span class="s">&#34; m-&gt;gsignal=&#34;</span><span class="p">,</span> <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">gsignal</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">morebuf</span> <span class="o">:=</span> <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">morebuf</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceback</span><span class="p">(</span><span class="nx">morebuf</span><span class="p">.</span><span class="nx">pc</span><span class="p">,</span> <span class="nx">morebuf</span><span class="p">.</span><span class="nx">sp</span><span class="p">,</span> <span class="nx">morebuf</span><span class="p">.</span><span class="nx">lr</span><span class="p">,</span> <span class="nx">morebuf</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nf">ptr</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runtime: wrong goroutine in newstack&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">curg</span>  <span class="c1">// gp åœ¨è¿™é‡Œä¾‹å­æ˜¯runtime.mainçš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// g.throwsplit åœ¨ç³»ç»Ÿè°ƒç”¨å‰ä¼šè¢«è®¾ç½®ä¸ºtrueæˆ–å…¶ä»–åœ°æ–¹ã€‚å› æ­¤gå‡ºç°åœ¨è¿™é‡Œä¸åˆé€‚ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">curg</span><span class="p">.</span><span class="nx">throwsplit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Update syscallsp, syscallpc in case traceback uses them.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">morebuf</span> <span class="o">:=</span> <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">morebuf</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span><span class="p">.</span><span class="nx">syscallsp</span> <span class="p">=</span> <span class="nx">morebuf</span><span class="p">.</span><span class="nx">sp</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span><span class="p">.</span><span class="nx">syscallpc</span> <span class="p">=</span> <span class="nx">morebuf</span><span class="p">.</span><span class="nx">pc</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pcname</span><span class="p">,</span> <span class="nx">pcoff</span> <span class="o">:=</span> <span class="s">&#34;(unknown)&#34;</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">f</span> <span class="o">:=</span> <span class="nf">findfunc</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">pc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nf">valid</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">pcname</span> <span class="p">=</span> <span class="nf">funcname</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">pcoff</span> <span class="p">=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">pc</span> <span class="o">-</span> <span class="nx">f</span><span class="p">.</span><span class="nf">entry</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;runtime: newstack at &#34;</span><span class="p">,</span> <span class="nx">pcname</span><span class="p">,</span> <span class="s">&#34;+&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">pcoff</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34; sp=&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sp</span><span class="p">),</span> <span class="s">&#34; stack=[&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span><span class="p">),</span> <span class="s">&#34;, &#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span><span class="p">),</span> <span class="s">&#34;]\n&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;\tmorebuf={pc:&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">morebuf</span><span class="p">.</span><span class="nx">pc</span><span class="p">),</span> <span class="s">&#34; sp:&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">morebuf</span><span class="p">.</span><span class="nx">sp</span><span class="p">),</span> <span class="s">&#34; lr:&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">morebuf</span><span class="p">.</span><span class="nx">lr</span><span class="p">),</span> <span class="s">&#34;}\n&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;\tsched={pc:&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">pc</span><span class="p">),</span> <span class="s">&#34; sp:&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sp</span><span class="p">),</span> <span class="s">&#34; lr:&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lr</span><span class="p">),</span> <span class="s">&#34; ctxt:&#34;</span><span class="p">,</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">ctxt</span><span class="p">,</span> <span class="s">&#34;}\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">traceback</span> <span class="p">=</span> <span class="mi">2</span> <span class="c1">// Include runtime frames
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">traceback</span><span class="p">(</span><span class="nx">morebuf</span><span class="p">.</span><span class="nx">pc</span><span class="p">,</span> <span class="nx">morebuf</span><span class="p">.</span><span class="nx">sp</span><span class="p">,</span> <span class="nx">morebuf</span><span class="p">.</span><span class="nx">lr</span><span class="p">,</span> <span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runtime: stack split at bad time&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// m.morebuf åœ¨ä¸Šé¢çš„morestackå‡½æ•°ä¸­è¢«è®¾ç½®ä¸ºè°ƒç”¨å‡½æ•°çš„ç›¸å…³ä¿¡æ¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">morebuf</span> <span class="o">:=</span> <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">morebuf</span>
</span></span><span class="line"><span class="cl">    <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">morebuf</span><span class="p">.</span><span class="nx">pc</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">morebuf</span><span class="p">.</span><span class="nx">lr</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">morebuf</span><span class="p">.</span><span class="nx">sp</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">morebuf</span><span class="p">.</span><span class="nx">g</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// NOTE: stackguard0 may change underfoot, if another thread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// is about to try to preempt gp. Read it just once and use that same
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// value now and below.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ³¨æ„ï¼šå¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹å³å°†å°è¯•æŠ¢å gpï¼Œstackguard0å¯èƒ½ä¼šåœ¨è„šä¸‹å‘ç”Ÿå˜åŒ–ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åªéœ€é˜…è¯»ä¸€æ¬¡å¹¶åœ¨ç°åœ¨å’Œä¸‹é¢ä½¿ç”¨ç›¸åŒçš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">stackguard0</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Loaduintptr</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stackguard0</span><span class="p">)</span>  <span class="c1">// è·å–gp.stackguard0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Be conservative about where we preempt.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// We are interested in preempting user Go code, not runtime code.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// If we&#39;re holding locks, mallocing, or preemption is disabled, don&#39;t
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// preempt.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This check is very early in newstack so that even the status change
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// from Grunning to Gwaiting and back doesn&#39;t happen in this case.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// That status change by itself can be viewed as a small preemption,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// because the GC might change Gwaiting to Gscanwaiting, and then
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// this goroutine has to wait for the GC to finish before continuing.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// If the GC is in some way dependent on this goroutine (for example,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// it needs a lock held by the goroutine), that small preemption turns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// into a real deadlock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">preempt</span> <span class="o">:=</span> <span class="nx">stackguard0</span> <span class="o">==</span> <span class="nx">stackPreempt</span>  <span class="c1">// åˆ¤æ–­å½“å‰æ˜¯å¦çœŸéœ€è¦è¢«æŠ¢å 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">preempt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// canPreemptM -&gt; mp.locks == 0 &amp;&amp; mp.mallocing == 0 &amp;&amp; mp.preemptoff == &#34;&#34; &amp;&amp; mp.p.ptr().status == _Prunning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nf">canPreemptM</span><span class="p">(</span><span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// canPreemptM(thisg.m); true.å¯ä»¥æŠ¢å ; false.ä¸å…è®¸æŠ¢å 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ä»¥ä¸‹æ˜¯ã€ä¸å…è®¸ã€‘æŠ¢å æ—¶ï¼Œå†æ¬¡æ¢å¤gpã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            
</span></span><span class="line"><span class="cl">            <span class="c1">// Let the goroutine keep running for now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// gp-&gt;preempt is set, so it will be preempted next time.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ç°åœ¨è®©goroutineç»§ç»­è¿è¡Œã€‚gp-&gt;preemptå·²è®¾ç½®ï¼Œå› æ­¤ä¸‹æ¬¡å°†è¢«æŠ¢å ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// (gp-&gt;preemptåœ¨å‰é¢å·²è¢«è®¾ç½®ä¸ºtrue)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿˜åŸstackguard0ä¸ºæ­£å¸¸å€¼ï¼Œè¡¨ç¤ºæˆ‘ä»¬å·²ç»å¤„ç†è¿‡æŠ¢å è¯·æ±‚äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">gp</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">+</span> <span class="nx">_StackGuard</span> 
</span></span><span class="line"><span class="cl">            <span class="c1">// æ¢å¤gpï¼Œè¿™é‡Œæ°¸è¿œä¸ä¼šè¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">gogo</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">)</span> <span class="c1">// never return
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;missing stack in newstack&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sp</span> <span class="o">:=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sp</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">goarch</span><span class="p">.</span><span class="nx">ArchFamily</span> <span class="o">==</span> <span class="nx">goarch</span><span class="p">.</span><span class="nx">AMD64</span> <span class="o">||</span> <span class="nx">goarch</span><span class="p">.</span><span class="nx">ArchFamily</span> <span class="o">==</span> <span class="nx">goarch</span><span class="p">.</span><span class="nx">I386</span> <span class="o">||</span> <span class="nx">goarch</span><span class="p">.</span><span class="nx">ArchFamily</span> <span class="o">==</span> <span class="nx">goarch</span><span class="p">.</span><span class="nx">WASM</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// The call to morestack cost a word.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sp</span> <span class="o">-=</span> <span class="nx">goarch</span><span class="p">.</span><span class="nx">PtrSize</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">stackDebug</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">sp</span> <span class="p">&lt;</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;runtime: newstack sp=&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">sp</span><span class="p">),</span> <span class="s">&#34; stack=[&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span><span class="p">),</span> <span class="s">&#34;, &#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span><span class="p">),</span> <span class="s">&#34;]\n&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;\tmorebuf={pc:&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">morebuf</span><span class="p">.</span><span class="nx">pc</span><span class="p">),</span> <span class="s">&#34; sp:&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">morebuf</span><span class="p">.</span><span class="nx">sp</span><span class="p">),</span> <span class="s">&#34; lr:&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">morebuf</span><span class="p">.</span><span class="nx">lr</span><span class="p">),</span> <span class="s">&#34;}\n&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;\tsched={pc:&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">pc</span><span class="p">),</span> <span class="s">&#34; sp:&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sp</span><span class="p">),</span> <span class="s">&#34; lr:&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lr</span><span class="p">),</span> <span class="s">&#34; ctxt:&#34;</span><span class="p">,</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">ctxt</span><span class="p">,</span> <span class="s">&#34;}\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">sp</span> <span class="p">&lt;</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;runtime: gp=&#34;</span><span class="p">,</span> <span class="nx">gp</span><span class="p">,</span> <span class="s">&#34;, goid=&#34;</span><span class="p">,</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">goid</span><span class="p">,</span> <span class="s">&#34;, gp-&gt;status=&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nf">readgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">)),</span> <span class="s">&#34;\n &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;runtime: split stack overflow: &#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">sp</span><span class="p">),</span> <span class="s">&#34; &lt; &#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span><span class="p">),</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runtime: split stack overflow&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ¤æ–­æŠ¢å ï¼Œå‘èµ·æŠ¢å 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">preempt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">g0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runtime: preempt g0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">thisg</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">locks</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runtime: g is running but p is not&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">preemptShrink</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// We&#39;re at a synchronous safe point now, so
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// do the pending stack shrink.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">gp</span><span class="p">.</span><span class="nx">preemptShrink</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">            <span class="nf">shrinkstack</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// åœæ­¢æŠ¢å ï¼Œå¼€å¯ä¸‹ä¸€æ¬¡è°ƒåº¦å¾ªç¯,makerootæœŸé—´æ”¹å€¼ä¼šè¢«è®¾ç½®ä¸ºtrueã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">preemptStop</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">            <span class="nf">preemptPark</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span> <span class="c1">// never returns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Act like goroutine called runtime.Gosched.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åƒè°ƒç”¨ runtime.Gosched çš„ goroutine ä¸€æ ·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è°ƒç”¨gopreempt_mæŠŠgpåˆ‡æ¢å‡ºå»ï¼ŒæŠ¢å è¿™ä¸ªgoroutineæˆåŠŸäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">gopreempt_m</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span> <span class="c1">// never return
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¸‹é¢ä»£ç æ˜¯æ‰©å¤§æ ˆç›¸å…³ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Allocate a bigger segment and move the stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">oldsize</span> <span class="o">:=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span> <span class="o">-</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newsize</span> <span class="o">:=</span> <span class="nx">oldsize</span> <span class="o">*</span> <span class="mi">2</span> <span class="c1">// æ‰©å¤§ä¸ºåŸæ¥çš„2å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Make sure we grow at least as much as needed to fit the new frame.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// (This is just an optimization - the caller of morestack will
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// recheck the bounds on return.)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">f</span> <span class="o">:=</span> <span class="nf">findfunc</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">pc</span><span class="p">);</span> <span class="nx">f</span><span class="p">.</span><span class="nf">valid</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">max</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nf">funcMaxSPDelta</span><span class="p">(</span><span class="nx">f</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">needed</span> <span class="o">:=</span> <span class="nx">max</span> <span class="o">+</span> <span class="nx">_StackGuard</span>
</span></span><span class="line"><span class="cl">        <span class="nx">used</span> <span class="o">:=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span> <span class="o">-</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sp</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">newsize</span><span class="o">-</span><span class="nx">used</span> <span class="p">&lt;</span> <span class="nx">needed</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">newsize</span> <span class="o">*=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">stackguard0</span> <span class="o">==</span> <span class="nx">stackForceMove</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Forced stack movement used for debugging.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Don&#39;t double the stack (or we may quickly run out
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// if this is done repeatedly).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">newsize</span> <span class="p">=</span> <span class="nx">oldsize</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">newsize</span> <span class="p">&gt;</span> <span class="nx">maxstacksize</span> <span class="o">||</span> <span class="nx">newsize</span> <span class="p">&gt;</span> <span class="nx">maxstackceiling</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">maxstacksize</span> <span class="p">&lt;</span> <span class="nx">maxstackceiling</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s">&#34;runtime: goroutine stack exceeds &#34;</span><span class="p">,</span> <span class="nx">maxstacksize</span><span class="p">,</span> <span class="s">&#34;-byte limit\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s">&#34;runtime: goroutine stack exceeds &#34;</span><span class="p">,</span> <span class="nx">maxstackceiling</span><span class="p">,</span> <span class="s">&#34;-byte limit\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;runtime: sp=&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">sp</span><span class="p">),</span> <span class="s">&#34; stack=[&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span><span class="p">),</span> <span class="s">&#34;, &#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span><span class="p">),</span> <span class="s">&#34;]\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;stack overflow&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// The goroutine must be executing in order to call newstack,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// so it must be Grunning (or Gscanrunning).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">,</span> <span class="nx">_Gcopystack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// The concurrent GC will not scan the stack while we are doing the copy since
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the gp is in a Gcopystack status.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">copystack</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">newsize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">stackDebug</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;stack grow done\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Gcopystack</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gogo</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">)</span> <span class="c1">// å†æ¬¡æ¢å¤è¿™ä¸ªgoroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="canpreemptm">canPreemptM<a hidden class="anchor" aria-hidden="true" href="#canpreemptm">#</a></h4>
<ol>
<li><code>canPreemptM</code>æŠ¥å‘Š<code>mp</code>æ˜¯å¦å¤„äºå¯ä»¥å®‰å…¨æŠ¢å çš„çŠ¶æ€ã€‚</li>
<li>å®ƒæ˜¯<code>nosplit</code>å› ä¸ºå®ƒæœ‰<code>nosplit</code>çš„è°ƒç”¨è€…ã€‚</li>
<li><strong>go:nosplit</strong>ï¼šå‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦åœ¨å½“å‰å‡½æ•°ä¸­æ’å…¥ä»»ä½•æ ˆæ‰©å±•ä»£ç ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿å½“å‰å‡½æ•°ä¸ä¼šå¯¼è‡´æ ˆçš„å¤§å°å‘ç”Ÿå˜åŒ–ã€‚
<ol>
<li>åœ¨<code>Go</code>è¯­è¨€ä¸­ï¼Œæ¯ä¸ª<code>goroutine</code>éƒ½æœ‰ä¸€ä¸ªå›ºå®šçš„æ ˆå¤§å°ï¼Œå½“æ ˆçš„å¤§å°ä¸è¶³ä»¥å®¹çº³å½“å‰å‡½æ•°çš„æ‰§è¡Œæ—¶ï¼Œå°±ä¼šå‘ç”Ÿæ ˆæº¢å‡ºé”™è¯¯ã€‚</li>
<li>å› æ­¤ï¼Œä½¿ç”¨<code>&quot;go:nosplit&quot;</code>æŒ‡ä»¤å¯ä»¥ç¡®ä¿å‡½æ•°çš„æ‰§è¡Œä¸ä¼šå¯¼è‡´æ ˆçš„å¤§å°å‘ç”Ÿå˜åŒ–ï¼Œä»è€Œé¿å…æ ˆæº¢å‡ºé”™è¯¯çš„å‘ç”Ÿã€‚è¿™ä¸ªæŒ‡ä»¤é€šå¸¸ç”¨äºä¸€äº›å…³é”®æ€§çš„å‡½æ•°ä¸­ï¼Œæ¯”å¦‚åƒåœ¾å›æ”¶å™¨å’Œè°ƒåº¦å™¨ç­‰ã€‚</li>
<li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨<code>&quot;go:nosplit&quot;</code>æŒ‡ä»¤å¯èƒ½ä¼šå½±å“ç¨‹åºçš„æ€§èƒ½ã€‚å› ä¸ºä¸å†æ’å…¥æ ˆæ‰©å±•ä»£ç ï¼Œè¿™æ„å‘³ç€åœ¨æ‰§è¡Œå‡½æ•°æ—¶ï¼Œæ ˆçš„å¤§å°ä¸ä¼šåŠ¨æ€è°ƒæ•´ã€‚å› æ­¤ï¼Œç¨‹åºå‘˜éœ€è¦åœ¨ä½¿ç”¨<code>&quot;go:nosplit&quot;</code>æŒ‡ä»¤æ—¶ä»”ç»†è€ƒè™‘æ€§èƒ½å’Œæ ˆæº¢å‡ºé”™è¯¯ä¹‹é—´çš„æƒè¡¡ã€‚</li>
</ol>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/preempt.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// canPreemptM reports whether mp is in a state that is safe to preempt.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// It is nosplit because it has nosplit callers.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">canPreemptM</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// èƒ½å¦æŠ¢å æ¡ä»¶ï¼štrue.èƒ½æŠ¢å ï¼Œfalse.ä¸èƒ½æŠ¢å ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. mp.locks == 0ï¼šè¡¨ç¤ºå½“å‰goroutineæŒæœ‰çš„äº’æ–¥é”æ•°é‡ï¼Œæ²¡åˆ°0æ—¶ï¼Œä¸åº”è¯¥è¢«æŠ¢å ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. mp.mallocing == 0ï¼šå½“å‰goroutineæ­£åœ¨åˆ†é…å†…å­˜ï¼Œä¸åº”è¯¥è¢«æŠ¢å ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  3. mp.preemptoffï¼šå¦‚æœè¯¥å€¼è¢«è®¾ç½®ä¸ºéç©ºå­—ç¬¦ä¸²ï¼Œåˆ™è¡¨ç¤ºå½“å‰goroutineä¸åº”è¯¥è¢«æŠ¢å ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  4. mp.p.ptr().status == _Prunningï¼šå½“å‰Pæ­£åœ¨è¿è¡Œä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ»¡è¶³ä»¥ä¸Šæ¡ä»¶åˆ™èƒ½æŠ¢å gã€‚è¯¥å‡½æ•°ä¹Ÿä¼šåœ¨ä¿¡å·æŠ¢å å‡½æ•°isAsyncPreempt()å‡½æ•°ä¸­è°ƒç”¨ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦å…è®¸æŠ¢å 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">locks</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">mallocing</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">preemptoff</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">status</span> <span class="o">==</span> <span class="nx">_Prunning</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="gopreempt_m">gopreempt_m<a hidden class="anchor" aria-hidden="true" href="#gopreempt_m">#</a></h4>
<ol>
<li>æŠ¢å è°ƒåº¦ï¼Œåé€»è¾‘å’Œ<code>runtime.Gosched</code>ä¸€æ ·ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">3402
</span><span class="lnt">3403
</span><span class="lnt">3404
</span><span class="lnt">3405
</span><span class="lnt">3406
</span><span class="lnt">3407
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">gopreempt_m</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceGoPreempt</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">goschedImpl</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ç³»ç»Ÿè°ƒç”¨å‰å">ç³»ç»Ÿè°ƒç”¨å‰å<a hidden class="anchor" aria-hidden="true" href="#ç³»ç»Ÿè°ƒç”¨å‰å">#</a></h2>
<ol>
<li><code>handoffp()</code>ï¼Œ<strong>å¯¹æ­£åœ¨è¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„goroutineçš„æŠ¢å å®è´¨ä¸Šæ˜¯å‰¥å¤ºä¸å…¶å¯¹åº”çš„å·¥ä½œçº¿ç¨‹æ‰€ç»‘å®šçš„p</strong>ã€‚</li>
<li>è™½ç„¶è¯´å¤„äºç³»ç»Ÿè°ƒç”¨ä¹‹ä¸­çš„å·¥ä½œçº¿ç¨‹å¹¶ä¸éœ€è¦<code>p</code>ï¼Œä½†ä¸€æ—¦ä»æ“ä½œç³»ç»Ÿå†…æ ¸è¿”å›åˆ°ç”¨æˆ·ç©ºé—´ä¹‹åå°±å¿…é¡»ç»‘å®šä¸€ä¸ª<code>p</code>æ‰èƒ½è¿è¡Œ<code>go</code>ä»£ç ã€‚</li>
</ol>
<h3 id="ç³»ç»Ÿè°ƒç”¨">ç³»ç»Ÿè°ƒç”¨<a hidden class="anchor" aria-hidden="true" href="#ç³»ç»Ÿè°ƒç”¨">#</a></h3>
<h4 id="syscall6">Syscall6()<a hidden class="anchor" aria-hidden="true" href="#syscall6">#</a></h4>
<ol>
<li>ç³»ç»Ÿè°ƒç”¨æ—¶<strong>æœ€ç»ˆ</strong>ä¼šè°ƒç”¨è¯¥æ±‡ç¼–å‡½æ•°ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/syscall/asm_unix_amd64.sã€‚</li>
<li>å‡½æ•°åŸå‹ï¼š<code>func Syscall6(num, a1, a2, a3, a4, a5, a6 uintptr) (r1, r2, errno uintptr)</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span>    <span class="err">Â·</span><span class="no">Syscall6</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="p">,</span><span class="no">$0-80</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è°ƒç”¨ runtime.entersyscall å‡½æ•°ï¼Œä¿å­˜ç°åœºè§£é™¤ç»‘å®šå…³ç³»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">entersyscall</span><span class="err">&lt;</span><span class="no">ABIInternal</span><span class="err">&gt;</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ç³»ç»Ÿè°ƒç”¨å‚æ•°ï¼ŒæŒ‰ç…§linuxç³»ç»Ÿçº¦å®šå¯„å­˜å™¨å¹¶è°ƒç”¨SYSCALLæ‰§è¡Œè¿›å…¥å†…æ ¸ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ç³»ç»Ÿè°ƒç”¨ç¼–å·æ”¾å…¥AXã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">trap</span><span class="err">+</span><span class="mi">0</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">AX</span>  <span class="c1"># syscall entry
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">a1</span><span class="err">+</span><span class="mi">8</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">DI</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">a2</span><span class="err">+</span><span class="mi">16</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">SI</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">a3</span><span class="err">+</span><span class="mi">24</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">DX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">a4</span><span class="err">+</span><span class="mi">32</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">R10</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">a5</span><span class="err">+</span><span class="mi">40</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">R8</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">a6</span><span class="err">+</span><span class="mi">48</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">R9</span>
</span></span><span class="line"><span class="cl">    <span class="nf">SYSCALL</span> <span class="c1"># è¿›å…¥å†…æ ¸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä»å†…æ ¸è¿”å›ï¼Œåˆ¤æ–­æ ‡è¯†æ˜¯å¦è·³è½¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JCC</span>	<span class="no">ok6</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">$-1</span><span class="p">,</span> <span class="no">r1</span><span class="err">+</span><span class="mi">56</span><span class="p">(</span><span class="no">FP</span><span class="p">)</span>  <span class="c1"># r1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$0</span><span class="p">,</span> <span class="no">r2</span><span class="err">+</span><span class="mi">64</span><span class="p">(</span><span class="no">FP</span><span class="p">)</span>   <span class="c1"># r2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">err</span><span class="err">+</span><span class="mi">72</span><span class="p">(</span><span class="no">FP</span><span class="p">)</span>  <span class="c1"># errno
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">exitsyscall</span><span class="err">&lt;</span><span class="no">ABIInternal</span><span class="err">&gt;</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">RET</span>
</span></span><span class="line"><span class="cl"><span class="nl">ok6:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ç³»ç»Ÿè°ƒç”¨è¿”å›çš„å€¼ä¿å­˜æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">r1</span><span class="err">+</span><span class="mi">56</span><span class="p">(</span><span class="no">FP</span><span class="p">)</span>   <span class="c1"># r1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">DX</span><span class="p">,</span> <span class="no">r2</span><span class="err">+</span><span class="mi">64</span><span class="p">(</span><span class="no">FP</span><span class="p">)</span>   <span class="c1"># r2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">$0</span><span class="p">,</span> <span class="no">err</span><span class="err">+</span><span class="mi">72</span><span class="p">(</span><span class="no">FP</span><span class="p">)</span>  <span class="c1"># errno
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">exitsyscall</span><span class="err">&lt;</span><span class="no">ABIInternal</span><span class="err">&gt;</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ç³»ç»Ÿè°ƒç”¨å‰">ç³»ç»Ÿè°ƒç”¨å‰<a hidden class="anchor" aria-hidden="true" href="#ç³»ç»Ÿè°ƒç”¨å‰">#</a></h3>
<h4 id="entersyscall">entersyscall()<a hidden class="anchor" aria-hidden="true" href="#entersyscall">#</a></h4>
<ol>
<li><code>go</code>ç³»ç»Ÿè°ƒç”¨åº“å’Œæ™®é€š<code>cgo</code>è°ƒç”¨ä½¿ç”¨çš„æ ‡å‡†ç³»ç»Ÿè°ƒç”¨é¡¹ã€‚</li>
<li>è¿™æ˜¯é€šè¿‡<code>syscall</code>åŒ…å’Œ<code>x/sys</code>ä¸­çš„é“¾æ¥åå¯¼å‡ºåˆ°ç¨‹åºé›†çš„ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">3672
</span><span class="lnt">3673
</span><span class="lnt">3674
</span><span class="lnt">3675
</span><span class="lnt">3676
</span><span class="lnt">3677
</span><span class="lnt">3678
</span><span class="lnt">3679
</span><span class="lnt">3680
</span><span class="lnt">3681
</span><span class="lnt">3682
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Standard syscall entry used by the go syscall library and normal cgo calls.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// This is exported via linkname to assembly in the syscall package and x/sys.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:linkname entersyscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">entersyscall</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// getcallerpc()ï¼šè°ƒç”¨è€…å½“å‰PCå€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// getcallersp()ï¼šè°ƒç”¨è€…å½“å‰SPå€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">reentersyscall</span><span class="p">(</span><span class="nf">getcallerpc</span><span class="p">(),</span> <span class="nf">getcallersp</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="reentersyscall">reentersyscall()<a hidden class="anchor" aria-hidden="true" href="#reentersyscall">#</a></h4>
<ol>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">3575
</span><span class="lnt">3576
</span><span class="lnt">3577
</span><span class="lnt">3578
</span><span class="lnt">3579
</span><span class="lnt">3580
</span><span class="lnt">3581
</span><span class="lnt">3582
</span><span class="lnt">3583
</span><span class="lnt">3584
</span><span class="lnt">3585
</span><span class="lnt">3586
</span><span class="lnt">3587
</span><span class="lnt">3588
</span><span class="lnt">3589
</span><span class="lnt">3590
</span><span class="lnt">3591
</span><span class="lnt">3592
</span><span class="lnt">3593
</span><span class="lnt">3594
</span><span class="lnt">3595
</span><span class="lnt">3596
</span><span class="lnt">3597
</span><span class="lnt">3598
</span><span class="lnt">3599
</span><span class="lnt">3600
</span><span class="lnt">3601
</span><span class="lnt">3602
</span><span class="lnt">3603
</span><span class="lnt">3604
</span><span class="lnt">3605
</span><span class="lnt">3606
</span><span class="lnt">3607
</span><span class="lnt">3608
</span><span class="lnt">3609
</span><span class="lnt">3610
</span><span class="lnt">3611
</span><span class="lnt">3612
</span><span class="lnt">3613
</span><span class="lnt">3614
</span><span class="lnt">3615
</span><span class="lnt">3616
</span><span class="lnt">3617
</span><span class="lnt">3618
</span><span class="lnt">3619
</span><span class="lnt">3620
</span><span class="lnt">3621
</span><span class="lnt">3622
</span><span class="lnt">3623
</span><span class="lnt">3624
</span><span class="lnt">3625
</span><span class="lnt">3626
</span><span class="lnt">3627
</span><span class="lnt">3628
</span><span class="lnt">3629
</span><span class="lnt">3630
</span><span class="lnt">3631
</span><span class="lnt">3632
</span><span class="lnt">3633
</span><span class="lnt">3634
</span><span class="lnt">3635
</span><span class="lnt">3636
</span><span class="lnt">3637
</span><span class="lnt">3638
</span><span class="lnt">3639
</span><span class="lnt">3640
</span><span class="lnt">3641
</span><span class="lnt">3642
</span><span class="lnt">3643
</span><span class="lnt">3644
</span><span class="lnt">3645
</span><span class="lnt">3646
</span><span class="lnt">3647
</span><span class="lnt">3648
</span><span class="lnt">3649
</span><span class="lnt">3650
</span><span class="lnt">3651
</span><span class="lnt">3652
</span><span class="lnt">3653
</span><span class="lnt">3654
</span><span class="lnt">3655
</span><span class="lnt">3656
</span><span class="lnt">3657
</span><span class="lnt">3658
</span><span class="lnt">3659
</span><span class="lnt">3660
</span><span class="lnt">3661
</span><span class="lnt">3662
</span><span class="lnt">3663
</span><span class="lnt">3664
</span><span class="lnt">3665
</span><span class="lnt">3666
</span><span class="lnt">3667
</span><span class="lnt">3668
</span><span class="lnt">3669
</span><span class="lnt">3670
</span><span class="lnt">3671
</span><span class="lnt">3672
</span><span class="lnt">3673
</span><span class="lnt">3674
</span><span class="lnt">3675
</span><span class="lnt">3676
</span><span class="lnt">3677
</span><span class="lnt">3678
</span><span class="lnt">3679
</span><span class="lnt">3680
</span><span class="lnt">3681
</span><span class="lnt">3682
</span><span class="lnt">3683
</span><span class="lnt">3684
</span><span class="lnt">3685
</span><span class="lnt">3686
</span><span class="lnt">3687
</span><span class="lnt">3688
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// The goroutine g is about to enter a system call.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Record that it&#39;s not using the cpu anymore.
</span></span></span><span class="line"><span class="cl"><span class="c1">// This is called only from the go syscall library and cgocall,
</span></span></span><span class="line"><span class="cl"><span class="c1">// not from the low-level system calls used by the runtime.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Entersyscall cannot split the stack: the save must
</span></span></span><span class="line"><span class="cl"><span class="c1">// make g-&gt;sched refer to the caller&#39;s stack segment, because
</span></span></span><span class="line"><span class="cl"><span class="c1">// entersyscall is going to return immediately after.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Nothing entersyscall calls can split the stack either.
</span></span></span><span class="line"><span class="cl"><span class="c1">// We cannot safely move the stack during an active call to syscall,
</span></span></span><span class="line"><span class="cl"><span class="c1">// because we do not know which of the uintptr arguments are
</span></span></span><span class="line"><span class="cl"><span class="c1">// really pointers (back into the stack).
</span></span></span><span class="line"><span class="cl"><span class="c1">// In practice, this means that we make the fast path run through
</span></span></span><span class="line"><span class="cl"><span class="c1">// entersyscall doing no-split things, and the slow path has to use systemstack
</span></span></span><span class="line"><span class="cl"><span class="c1">// to run bigger things on the system stack.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// reentersyscall is the entry point used by cgo callbacks, where explicitly
</span></span></span><span class="line"><span class="cl"><span class="c1">// saved SP and PC are restored. This is needed when exitsyscall will be called
</span></span></span><span class="line"><span class="cl"><span class="c1">// from a function further up in the call stack than the parent, as g-&gt;syscallsp
</span></span></span><span class="line"><span class="cl"><span class="c1">// must always point to a valid stack frame. entersyscall below is the normal
</span></span></span><span class="line"><span class="cl"><span class="c1">// entry point for syscalls, which obtains the SP and PC from the caller.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Syscall tracing:
</span></span></span><span class="line"><span class="cl"><span class="c1">// At the start of a syscall we emit traceGoSysCall to capture the stack trace.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If the syscall does not block, that is it, we do not emit any other events.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If the syscall blocks (that is, P is retaken), retaker emits traceGoSysBlock;
</span></span></span><span class="line"><span class="cl"><span class="c1">// when syscall returns we emit traceGoSysExit and when the goroutine starts running
</span></span></span><span class="line"><span class="cl"><span class="c1">// (potentially instantly, if exitsyscallfast returns true) we emit traceGoStart.
</span></span></span><span class="line"><span class="cl"><span class="c1">// To ensure that traceGoSysExit is emitted strictly after traceGoSysBlock,
</span></span></span><span class="line"><span class="cl"><span class="c1">// we remember current value of syscalltick in m (_g_.m.syscalltick = _g_.m.p.ptr().syscalltick),
</span></span></span><span class="line"><span class="cl"><span class="c1">// whoever emits traceGoSysBlock increments p.syscalltick afterwards;
</span></span></span><span class="line"><span class="cl"><span class="c1">// and we wait for the increment before emitting traceGoSysExit.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Note that the increment is done even if tracing is not enabled,
</span></span></span><span class="line"><span class="cl"><span class="c1">// because tracing can be enabled in the middle of syscall. We don&#39;t want the wait to hang.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">reentersyscall</span><span class="p">(</span><span class="nx">pc</span><span class="p">,</span> <span class="nx">sp</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// user goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// æ‰§è¡Œç³»ç»Ÿè°ƒç”¨çš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Disable preemption because during this function g is in Gsyscall status,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// but can have inconsistent g-&gt;sched, do not let GC observe it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç¦ç”¨æŠ¢å ï¼Œå› ä¸ºåœ¨è¿™ä¸ªåŠŸèƒ½æœŸé—´gå¤„äºGsyscallçŠ¶æ€ï¼Œä½†å¯èƒ½æœ‰ä¸ä¸€è‡´çš„g-&gt;schedï¼Œä¸è¦è®©GCè§‚å¯Ÿå®ƒã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">locks</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Entersyscall must not call any function that might split/grow the stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// (See details in comment above.)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Catch calls that might, by replacing the stack guard with something that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// will trip any stack check and leaving a flag to tell newstack to die.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">stackPreempt</span> <span class="c1">// è®¾ç½®æŠ¢å ï¼Œåœ¨è°ƒç”¨è¿”å›æ—¶ä¼šä¿®æ”¹å›æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸èƒ½æ‰©å±•æ ˆï¼Œåœ¨è°ƒç”¨è¿”å›æ—¶ä¼šä¿®æ”¹å›æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">throwsplit</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Leave SP around for GC and traceback.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">save</span><span class="p">(</span><span class="nx">pc</span><span class="p">,</span> <span class="nx">sp</span><span class="p">)</span> <span class="c1">// ä¿å­˜gçš„ç°åœºä¿¡æ¯ï¼Œrspï¼Œrbpï¼Œripç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">syscallsp</span> <span class="p">=</span> <span class="nx">sp</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">syscallpc</span> <span class="p">=</span> <span class="nx">pc</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç›‘æ§çº¿ç¨‹ä¾èµ–_GsyscallçŠ¶æ€å®æ–½ç³»ç»Ÿè°ƒç”¨æ—¶çš„æŠ¢å 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">_g_</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">,</span> <span class="nx">_Gsyscall</span><span class="p">)</span> <span class="c1">// åˆ‡æ¢gçŠ¶æ€ä¸ºç³»ç»Ÿè°ƒç”¨ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// SPæ˜¯å¦åœ¨goroutineçš„æ ˆèŒƒå›´å†…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">syscallsp</span> <span class="p">&lt;</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">||</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span> <span class="p">&lt;</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">syscallsp</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s">&#34;entersyscall inconsistent &#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">syscallsp</span><span class="p">),</span> <span class="s">&#34; [&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span><span class="p">),</span> <span class="s">&#34;,&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span><span class="p">),</span> <span class="s">&#34;]\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;entersyscall&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">systemstack</span><span class="p">(</span><span class="nx">traceGoSysCall</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// systemstack itself clobbers g.sched.{pc,sp} and we might
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// need them later when the G is genuinely blocked in a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// syscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">save</span><span class="p">(</span><span class="nx">pc</span><span class="p">,</span> <span class="nx">sp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// sysmon ç›‘æ§çº¿ç¨‹æ­£æŒ‚èµ·åœ¨ sched.sysmonwait
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sysmonwait</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆ‡æ¢åˆ°g0æ ˆè°ƒç”¨ entersyscall_sysmon å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// entersyscall_sysmon å‡½æ•°å”¤é†’ sysmon ç›‘æ§çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">systemstack</span><span class="p">(</span><span class="nx">entersyscall_sysmon</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">save</span><span class="p">(</span><span class="nx">pc</span><span class="p">,</span> <span class="nx">sp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">runSafePointFn</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// runSafePointFn may stack split if run on this stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">systemstack</span><span class="p">(</span><span class="nx">runSafePointFn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">save</span><span class="p">(</span><span class="nx">pc</span><span class="p">,</span> <span class="nx">sp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æŠŠPçš„è°ƒç”¨æ¬¡æ•°æ‹·è´ç»™M
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">syscalltick</span> <span class="p">=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">syscalltick</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">sysblocktraced</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Må’ŒPç›¸äº’è§£é™¤å…³è”ï¼Œå¹¶æŠŠPæš‚å­˜ä¸m.oldpä¸­ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç­‰å¾…ç³»ç»Ÿè°ƒç”¨å®Œåä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è§£é™¤p.må…³è”çš„m
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">pp</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span> <span class="c1">// pp = p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">pp</span><span class="p">.</span><span class="nx">m</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// m.oldp = pp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">oldp</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">pp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è§£é™¤ m.p çš„å…³ç³» p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pp</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">_Psyscall</span><span class="p">)</span> <span class="c1">// pp.status = _Psyscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// STWæ­£åœ¨ç­‰å¾…æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">gcwaiting</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆ‡æ¢åˆ°g0æ ˆè°ƒç”¨entersyscall_gcwaitå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// entersyscall_gcwaitå‡½æ•°ï¼Œå°†PçŠ¶æ€è®¾ç½®ä¸º _Pgcstopï¼Œå¦‚æœSTWå·²å®Œæˆåˆ™å”¤é†’åœ¨sched.stopnoteä¸Šç­‰å¾…çš„STWå‘èµ·çš„çº¿ç¨‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">systemstack</span><span class="p">(</span><span class="nx">entersyscall_gcwait</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">save</span><span class="p">(</span><span class="nx">pc</span><span class="p">,</span> <span class="nx">sp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">locks</span><span class="o">--</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="save">save()<a hidden class="anchor" aria-hidden="true" href="#save">#</a></h4>
<ol>
<li>ä¿å­˜<code>goroutine</code>ç°åœºã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">3543
</span><span class="lnt">3544
</span><span class="lnt">3545
</span><span class="lnt">3546
</span><span class="lnt">3547
</span><span class="lnt">3548
</span><span class="lnt">3549
</span><span class="lnt">3550
</span><span class="lnt">3551
</span><span class="lnt">3552
</span><span class="lnt">3553
</span><span class="lnt">3554
</span><span class="lnt">3555
</span><span class="lnt">3556
</span><span class="lnt">3557
</span><span class="lnt">3558
</span><span class="lnt">3559
</span><span class="lnt">3560
</span><span class="lnt">3561
</span><span class="lnt">3562
</span><span class="lnt">3563
</span><span class="lnt">3564
</span><span class="lnt">3565
</span><span class="lnt">3566
</span><span class="lnt">3567
</span><span class="lnt">3568
</span><span class="lnt">3569
</span><span class="lnt">3570
</span><span class="lnt">3571
</span><span class="lnt">3572
</span><span class="lnt">3573
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// save updates getg().sched to refer to pc and sp so that a following
</span></span></span><span class="line"><span class="cl"><span class="c1">// gogo will restore pc and sp.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// save must not have write barriers because invoking a write barrier
</span></span></span><span class="line"><span class="cl"><span class="c1">// can clobber getg().sched.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">save</span><span class="p">(</span><span class="nx">pc</span><span class="p">,</span> <span class="nx">sp</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">g0</span> <span class="o">||</span> <span class="nx">gp</span> <span class="o">==</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">gsignal</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// m.g0.sched is special and must describe the context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// for exiting the thread. mstart1 writes to it directly.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// m.gsignal.sched should not be used at all.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// This check makes sure save calls do not accidentally
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// run in contexts where they&#39;d write to system g&#39;s.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;save on system g not allowed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">pc</span> <span class="p">=</span> <span class="nx">pc</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sp</span> <span class="p">=</span> <span class="nx">sp</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lr</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">ret</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// We need to ensure ctxt is zero, but can&#39;t have a write
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// barrier here. However, it should always already be zero.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Assert that.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">ctxt</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">badctxt</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ç³»ç»Ÿè°ƒç”¨å">ç³»ç»Ÿè°ƒç”¨å<a hidden class="anchor" aria-hidden="true" href="#ç³»ç»Ÿè°ƒç”¨å">#</a></h3>
<h4 id="exitsyscall">exitsyscall()<a hidden class="anchor" aria-hidden="true" href="#exitsyscall">#</a></h4>
<ol>
<li>è¿™ä¸ª<code>goroutine g</code>é€€å‡ºç³»ç»Ÿè°ƒç”¨ã€‚å®‰æ’å®ƒå†æ¬¡åœ¨<code>cpu</code>ä¸Šè¿è¡Œã€‚</li>
<li>è¿™ä»…ä»<code>go</code>ç³»ç»Ÿè°ƒç”¨åº“ä¸­è°ƒç”¨ï¼Œè€Œä¸æ˜¯ä»è¿è¡Œæ—¶ä½¿ç”¨çš„ä½çº§ç³»ç»Ÿè°ƒç”¨ä¸­è°ƒç”¨ã€‚</li>
<li>å†™å±éšœæ˜¯ä¸è¢«å…è®¸çš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„<code>P</code>å¯èƒ½è¢«å·äº†ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">3761
</span><span class="lnt">3762
</span><span class="lnt">3763
</span><span class="lnt">3764
</span><span class="lnt">3765
</span><span class="lnt">3766
</span><span class="lnt">3767
</span><span class="lnt">3768
</span><span class="lnt">3769
</span><span class="lnt">3770
</span><span class="lnt">3771
</span><span class="lnt">3772
</span><span class="lnt">3773
</span><span class="lnt">3774
</span><span class="lnt">3775
</span><span class="lnt">3776
</span><span class="lnt">3777
</span><span class="lnt">3778
</span><span class="lnt">3779
</span><span class="lnt">3780
</span><span class="lnt">3781
</span><span class="lnt">3782
</span><span class="lnt">3783
</span><span class="lnt">3784
</span><span class="lnt">3785
</span><span class="lnt">3786
</span><span class="lnt">3787
</span><span class="lnt">3788
</span><span class="lnt">3789
</span><span class="lnt">3790
</span><span class="lnt">3791
</span><span class="lnt">3792
</span><span class="lnt">3793
</span><span class="lnt">3794
</span><span class="lnt">3795
</span><span class="lnt">3796
</span><span class="lnt">3797
</span><span class="lnt">3798
</span><span class="lnt">3799
</span><span class="lnt">3800
</span><span class="lnt">3801
</span><span class="lnt">3802
</span><span class="lnt">3803
</span><span class="lnt">3804
</span><span class="lnt">3805
</span><span class="lnt">3806
</span><span class="lnt">3807
</span><span class="lnt">3808
</span><span class="lnt">3809
</span><span class="lnt">3810
</span><span class="lnt">3811
</span><span class="lnt">3812
</span><span class="lnt">3813
</span><span class="lnt">3814
</span><span class="lnt">3815
</span><span class="lnt">3816
</span><span class="lnt">3817
</span><span class="lnt">3818
</span><span class="lnt">3819
</span><span class="lnt">3820
</span><span class="lnt">3821
</span><span class="lnt">3822
</span><span class="lnt">3823
</span><span class="lnt">3824
</span><span class="lnt">3825
</span><span class="lnt">3826
</span><span class="lnt">3827
</span><span class="lnt">3828
</span><span class="lnt">3829
</span><span class="lnt">3830
</span><span class="lnt">3831
</span><span class="lnt">3832
</span><span class="lnt">3833
</span><span class="lnt">3834
</span><span class="lnt">3835
</span><span class="lnt">3836
</span><span class="lnt">3837
</span><span class="lnt">3838
</span><span class="lnt">3839
</span><span class="lnt">3840
</span><span class="lnt">3841
</span><span class="lnt">3842
</span><span class="lnt">3843
</span><span class="lnt">3844
</span><span class="lnt">3845
</span><span class="lnt">3846
</span><span class="lnt">3847
</span><span class="lnt">3848
</span><span class="lnt">3849
</span><span class="lnt">3850
</span><span class="lnt">3851
</span><span class="lnt">3852
</span><span class="lnt">3853
</span><span class="lnt">3854
</span><span class="lnt">3855
</span><span class="lnt">3856
</span><span class="lnt">3857
</span><span class="lnt">3858
</span><span class="lnt">3859
</span><span class="lnt">3860
</span><span class="lnt">3861
</span><span class="lnt">3862
</span><span class="lnt">3863
</span><span class="lnt">3864
</span><span class="lnt">3865
</span><span class="lnt">3866
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// The goroutine g exited its system call.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Arrange for it to run on a cpu again.
</span></span></span><span class="line"><span class="cl"><span class="c1">// This is called only from the go syscall library, not
</span></span></span><span class="line"><span class="cl"><span class="c1">// from the low-level system calls used by the runtime.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Write barriers are not allowed because our P may have been stolen.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// This is exported via linkname to assembly in the syscall package.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:linkname exitsyscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">exitsyscall</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// user goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// goroutine g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">locks</span><span class="o">++</span> <span class="c1">// see comment in entersyscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">getcallersp</span><span class="p">()</span> <span class="p">&gt;</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">syscallsp</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;exitsyscall: syscall frame is no longer valid&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// g.waitsinceï¼Œgè¢«é˜»å¡çš„å¤§çº¦æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">waitsince</span> <span class="p">=</span> <span class="mi">0</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿›å…¥ç³»ç»Ÿè°ƒç”¨ä¹‹å‰æ‰€ç»‘å®šçš„p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">oldp</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">oldp</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">oldp</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// exitsyscallfast å°è¯•ç»‘å®šPï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›falseã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">exitsyscallfast</span><span class="p">(</span><span class="nx">oldp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// When exitsyscallfast returns success, we have a P so can now use
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// write barriers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">goroutineProfile</span><span class="p">.</span><span class="nx">active</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Make sure that gp has had its stack written out to the goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// profile, exactly as it was when the goroutine profiler first
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// stopped the world.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">tryRecordGoroutineProfileWB</span><span class="p">(</span><span class="nx">_g_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">oldp</span> <span class="o">!=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span> <span class="o">||</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">syscalltick</span> <span class="o">!=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">syscalltick</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">systemstack</span><span class="p">(</span><span class="nx">traceGoStart</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// There&#39;s a cpu for us, so we can run.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">syscalltick</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// We need to cas the status and scan before resuming...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">_g_</span><span class="p">,</span> <span class="nx">_Gsyscall</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Garbage collector isn&#39;t running (since we are),
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// so okay to clear syscallsp.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_g_</span><span class="p">.</span><span class="nx">syscallsp</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">locks</span><span class="o">--</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">preempt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// restore the preemption request in case we&#39;ve cleared it in newstack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æ¢å¤æŠ¢å è¯·æ±‚ï¼Œä»¥é˜²æˆ‘ä»¬åœ¨newstackä¸­æ¸…é™¤äº†å®ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">_g_</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">stackPreempt</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// otherwise restore the real _StackGuard, we&#39;ve spoiled it in entersyscall/entersyscallblock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦åˆ™æ¢å¤çœŸæ­£çš„_StackGuardï¼Œæˆ‘ä»¬å·²ç»åœ¨entersyscall/entersyscallblockä¸­ç ´åäº†å®ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">_g_</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">+</span> <span class="nx">_StackGuard</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_g_</span><span class="p">.</span><span class="nx">throwsplit</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// sched.disable.user == trueï¼Œç”¨æˆ·goroutineè¢«ç¦æ­¢è¿è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// schedEnabledåˆ¤æ–­gæ˜¯å¦æ˜¯ç³»ç»Ÿgoroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">disable</span><span class="p">.</span><span class="nx">user</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nf">schedEnabled</span><span class="p">(</span><span class="nx">_g_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Scheduling of this goroutine is disabled.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">Gosched</span><span class="p">()</span> <span class="c1">// è®©å‡ºCPUï¼Œå½“å‰goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Mç»‘å®šPæ²¡æœ‰æˆåŠŸæ—¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">sysexitticks</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Wait till traceGoSysBlock event is emitted.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// This ensures consistency of the trace (the goroutine is started after it is blocked).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="nx">oldp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">oldp</span><span class="p">.</span><span class="nx">syscalltick</span> <span class="o">==</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">syscalltick</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">osyield</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// We can&#39;t trace syscall exit right now because we don&#39;t have a P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Tracing code can invoke write barriers that cannot run without a P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// So instead we remember the syscall exit time and emit the event
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// in execute when we have a P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_g_</span><span class="p">.</span><span class="nx">sysexitticks</span> <span class="p">=</span> <span class="nf">cputicks</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">locks</span><span class="o">--</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Call the scheduler.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ²¡æœ‰ç»‘å®šåˆ°pï¼Œè°ƒç”¨mcallåˆ‡æ¢åˆ°g0æ ˆæ‰§è¡Œexitsyscall0å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">mcall</span><span class="p">(</span><span class="nx">exitsyscall0</span><span class="p">)</span> <span class="c1">// mcallå‡½æ•°ä¼šä¿å­˜ç°åœºï¼Œåˆ‡æ¢g0è°ƒç”¨exitsyscall0å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Scheduler returned, so we&#39;re allowed to run now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Delete the syscallsp information that we left for
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the garbage collector during the system call.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Must wait until now because until gosched returns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// we don&#39;t know for sure that the garbage collector
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// is not running.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span><span class="p">.</span><span class="nx">syscallsp</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">syscalltick</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">throwsplit</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="exitsyscallfast">exitsyscallfast()<a hidden class="anchor" aria-hidden="true" href="#exitsyscallfast">#</a></h4>
<ol>
<li>å°è¯•ç»‘å®šä¸€ä¸ªç©ºé—²çš„<code>P</code>ã€‚true.ç»‘å®šæˆåŠŸï¼Œfalse.ç»‘å®šå¤±è´¥ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">3856
</span><span class="lnt">3857
</span><span class="lnt">3858
</span><span class="lnt">3859
</span><span class="lnt">3860
</span><span class="lnt">3861
</span><span class="lnt">3862
</span><span class="lnt">3863
</span><span class="lnt">3864
</span><span class="lnt">3865
</span><span class="lnt">3866
</span><span class="lnt">3867
</span><span class="lnt">3868
</span><span class="lnt">3869
</span><span class="lnt">3870
</span><span class="lnt">3871
</span><span class="lnt">3872
</span><span class="lnt">3873
</span><span class="lnt">3874
</span><span class="lnt">3875
</span><span class="lnt">3876
</span><span class="lnt">3877
</span><span class="lnt">3878
</span><span class="lnt">3879
</span><span class="lnt">3880
</span><span class="lnt">3881
</span><span class="lnt">3882
</span><span class="lnt">3883
</span><span class="lnt">3884
</span><span class="lnt">3885
</span><span class="lnt">3886
</span><span class="lnt">3887
</span><span class="lnt">3888
</span><span class="lnt">3889
</span><span class="lnt">3890
</span><span class="lnt">3891
</span><span class="lnt">3892
</span><span class="lnt">3893
</span><span class="lnt">3894
</span><span class="lnt">3895
</span><span class="lnt">3896
</span><span class="lnt">3897
</span><span class="lnt">3898
</span><span class="lnt">3899
</span><span class="lnt">3900
</span><span class="lnt">3901
</span><span class="lnt">3902
</span><span class="lnt">3903
</span><span class="lnt">3904
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">exitsyscallfast</span><span class="p">(</span><span class="nx">oldp</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Freezetheworld sets stopwait but does not retake P&#39;s.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Freezetheworld è®¾ç½®åœæ­¢ç­‰å¾…ï¼Œä½†ä¸é‡æ–°è·å–Pã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// const freezeStopWait int = 0x7fffffff
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">stopwait</span> <span class="o">==</span> <span class="nx">freezeStopWait</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Try to re-acquire the last P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¯•ç€é‡æ–°è·å–last Pã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">oldp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">oldp</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="nx">_Psyscall</span> <span class="o">&amp;&amp;</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Cas</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">oldp</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">_Psyscall</span><span class="p">,</span> <span class="nx">_Pidle</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// There&#39;s a cpu for us, so we can run.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æˆ‘ä»¬æœ‰cpuï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿è¡Œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">wirep</span><span class="p">(</span><span class="nx">oldp</span><span class="p">)</span> <span class="c1">// ç»‘å®šP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">exitsyscallfast_reacquired</span><span class="p">()</span> <span class="c1">// å¤„ç†Pçš„syscalltickå­—æ®µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Try to get any other idle P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å°è¯•è·å–ä¸€ä¸ªç©ºé—²çš„Pã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">pidle</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">ok</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆ‡æ¢åˆ°g0æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">            <span class="c1">// ä»å…¨å±€é˜Ÿåˆ—ä¸­å¯»æ‰¾ç©ºé—²çš„pï¼Œéœ€è¦åŠ é”ï¼Œæ¯”è¾ƒæ…¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">ok</span> <span class="p">=</span> <span class="nf">exitsyscallfast_pidle</span><span class="p">()</span> <span class="c1">// æ¬åˆ°æˆåŠŸè¿”å›trueï¼Œç»‘å®šå¤±è´¥è¿”å›falseã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">oldp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Wait till traceGoSysBlock event is emitted.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// This ensures consistency of the trace (the goroutine is started after it is blocked).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">for</span> <span class="nx">oldp</span><span class="p">.</span><span class="nx">syscalltick</span> <span class="o">==</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">syscalltick</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">osyield</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nf">traceGoSysExit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="exitsyscallfast_pidle">exitsyscallfast_pidle()<a hidden class="anchor" aria-hidden="true" href="#exitsyscallfast_pidle">#</a></h4>
<ol>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">3913
</span><span class="lnt">3914
</span><span class="lnt">3915
</span><span class="lnt">3916
</span><span class="lnt">3917
</span><span class="lnt">3918
</span><span class="lnt">3919
</span><span class="lnt">3920
</span><span class="lnt">3921
</span><span class="lnt">3922
</span><span class="lnt">3923
</span><span class="lnt">3924
</span><span class="lnt">3925
</span><span class="lnt">3926
</span><span class="lnt">3927
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">exitsyscallfast_pidle</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_p_</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nf">pidleget</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¤„ç†sysmonï¼Œå› ä¸ºåœ¨é™·å…¥åˆ°ç³»ç»Ÿè°ƒç”¨æ˜¯sysmonå¯èƒ½è‡ªå·±æŠŠè‡ªå·±æŒ‚èµ·ï¼Œæ‰€ä»¥éœ€è¦æ¢å¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_p_</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sysmonwait</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sysmonwait</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">notewakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sysmonnote</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_p_</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="c1">// ç»‘å®šPå¦‚æœæœ‰çš„è¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="exitsyscall0">exitsyscall0()<a hidden class="anchor" aria-hidden="true" href="#exitsyscall0">#</a></h4>
<ol>
<li><code>exitsyscall</code>åœ¨<code>g0</code>ä¸Šçš„æ…¢è·¯å¾„ã€‚è·å–<code>P</code>å¤±è´¥å°†<code>gp</code>æ”¾å…¥å¯è¿è¡Œé˜Ÿåˆ—ä¸­ã€‚</li>
<li>é€šè¿‡<code>mcall()</code>è°ƒç”¨ï¼Œ<code>gp</code>æ˜¯ä»è¿™ä¸ª<code>M</code>è°ƒç”¨<code>g</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">3934
</span><span class="lnt">3935
</span><span class="lnt">3936
</span><span class="lnt">3937
</span><span class="lnt">3938
</span><span class="lnt">3939
</span><span class="lnt">3940
</span><span class="lnt">3941
</span><span class="lnt">3942
</span><span class="lnt">3943
</span><span class="lnt">3944
</span><span class="lnt">3945
</span><span class="lnt">3946
</span><span class="lnt">3947
</span><span class="lnt">3948
</span><span class="lnt">3949
</span><span class="lnt">3950
</span><span class="lnt">3951
</span><span class="lnt">3952
</span><span class="lnt">3953
</span><span class="lnt">3954
</span><span class="lnt">3955
</span><span class="lnt">3956
</span><span class="lnt">3957
</span><span class="lnt">3958
</span><span class="lnt">3959
</span><span class="lnt">3960
</span><span class="lnt">3961
</span><span class="lnt">3962
</span><span class="lnt">3963
</span><span class="lnt">3964
</span><span class="lnt">3965
</span><span class="lnt">3966
</span><span class="lnt">3967
</span><span class="lnt">3968
</span><span class="lnt">3969
</span><span class="lnt">3970
</span><span class="lnt">3971
</span><span class="lnt">3972
</span><span class="lnt">3973
</span><span class="lnt">3974
</span><span class="lnt">3975
</span><span class="lnt">3976
</span><span class="lnt">3977
</span><span class="lnt">3978
</span><span class="lnt">3979
</span><span class="lnt">3980
</span><span class="lnt">3981
</span><span class="lnt">3982
</span><span class="lnt">3983
</span><span class="lnt">3984
</span><span class="lnt">3985
</span><span class="lnt">3986
</span><span class="lnt">3987
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// exitsyscall slow path on g0.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Failed to acquire P, enqueue gp as runnable.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Called via mcall, so gp is the calling g from this M.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">exitsyscall0</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¿®æ”¹gpçŠ¶æ€ä¸º_Grunnable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Gsyscall</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">dropg</span><span class="p">()</span> <span class="c1">// è§£é™¤gå…³è”å…³ç³»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ¤æ–­gpæ˜¯å¦æ˜¯ç³»ç»Ÿgoroutineï¼Œå¦‚æœæ˜¯çš„è¯å†æ¬¡å°è¯•è·å–Pã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">schedEnabled</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_p_</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nf">pidleget</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">locked</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_p_</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">globrunqput</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span> <span class="c1">// gpåŠ å…¥å…¨å±€å¯è¿è¡Œé˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Below, we stoplockedm if gp is locked. globrunqput releases
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ownership of gp, so we must check if gp is locked prior to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// committing the release by unlocking sched.lock, otherwise we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// could race with another M transitioning gp from unlocked to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// locked.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä¸‹é¢ï¼Œå¦‚æœgpè¢«é”å®šï¼Œæˆ‘ä»¬å°†åœæ­¢é˜»å¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// globrunqputé‡Šæ”¾äº†gpçš„æ‰€æœ‰æƒï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»åœ¨é‡Šæ”¾ä¹‹å‰é€šè¿‡è§£é”sched.lockæ£€æŸ¥gpæ˜¯å¦è¢«é”å®šï¼Œå¦åˆ™æˆ‘ä»¬å¯ä»¥ä¸å¦ä¸€ä¸ªMè½¬æ¢gpä»è§£é”åˆ°é”å®šã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">locked</span> <span class="p">=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">lockedm</span> <span class="o">!=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sysmonwait</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// å°è¯•å”¤é†’sysmonï¼Œå¦‚æœæœ‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sysmonwait</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">notewakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sysmonnote</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_p_</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span> <span class="c1">// ç»‘å®šP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// gp è¢«è°ƒåº¦èµ·æ¥è¿è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">execute</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span> <span class="c1">// Never returns.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">locked</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Wait until another thread schedules gp and so m again.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// N.B. lockedm must be this M, as this g was running on this M
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// before entersyscall.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹è°ƒåº¦gpï¼Œç„¶åå†è°ƒåº¦mã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ³¨æ„ï¼Œlockedmä¸€å®šæ˜¯è¿™ä¸ªMï¼Œå› ä¸ºè¿™ä¸ªgåœ¨entersyscallä¹‹å‰æ˜¯åœ¨è¿™ä¸ªMä¸Šè¿è¡Œçš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">stoplockedm</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nf">execute</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span> <span class="c1">// Never returns.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">stopm</span><span class="p">()</span> <span class="c1">// å½“å‰å·¥ä½œçº¿ç¨‹è¢«æŒ‚èµ·ï¼Œç­‰å¾…è¢«å”¤é†’è·å–Pç„¶åè¿è¡Œèµ·æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è°ƒåº¦å¾ªç¯å¼€å§‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">schedule</span><span class="p">()</span> <span class="c1">// Never returns.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ä¿¡å·å½¢å¼å‘é€æŠ¢å ">ä¿¡å·å½¢å¼å‘é€æŠ¢å <a hidden class="anchor" aria-hidden="true" href="#ä¿¡å·å½¢å¼å‘é€æŠ¢å ">#</a></h2>
<h3 id="preemptm">preemptM()<a hidden class="anchor" aria-hidden="true" href="#preemptm">#</a></h3>
<ol>
<li><code>preemptM</code>å‘<code>mp</code>å‘é€æŠ¢å è¯·æ±‚ã€‚è¯¥è¯·æ±‚å¯ä»¥å¼‚æ­¥å¤„ç†ï¼Œå¹¶ä¸”å¯ä»¥ä¸å¯¹<code>M</code>çš„å…¶ä»–è¯·æ±‚åˆå¹¶ã€‚</li>
<li>å½“æ¥æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œå¦‚æœæ­£åœ¨è¿è¡Œçš„<code>G</code>æˆ–<code>P</code>è¢«æ ‡è®°ä¸ºæŠ¢å ï¼Œå¹¶ä¸”<code>goroutine</code>å¤„äºå¼‚æ­¥å®‰å…¨ç‚¹ï¼Œåˆ™å®ƒå°†æŠ¢å  <code>goroutine</code>ã€‚</li>
<li>å®ƒæ€»æ˜¯åœ¨å¤„ç†æŠ¢å è¯·æ±‚åè‡ªåŠ¨é€’å¢<code>mp.preemptGen</code>ã€‚</li>
<li>é€šè¿‡<code>runtime.signalM()</code>å‡½æ•°å‘æ‰§è¡Œ<code>M</code>å‘é€<code>sigPreempt</code>ä¿¡å·ã€‚</li>
<li>è‡³äº<code>signalM()</code>å‡½æ•°ï¼Œå°±æ˜¯è°ƒç”¨æ“ä½œç³»ç»Ÿçš„ä¿¡å·ç›¸å…³ç³»ç»Ÿè°ƒç”¨ï¼Œå°†æŒ‡å®šä¿¡å·å‘é€ç»™ç›®æ ‡çº¿ç¨‹ã€‚</li>
<li>è‡³æ­¤ï¼Œå¼‚æ­¥æŠ¢å é€»è¾‘çš„ä¸»è¦å·¥ä½œå°±ç®—å®Œæˆäº†å‰ä¸€åŠã€‚</li>
<li><code>preemptM</code>è¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨<code>signalM</code>å°†åœ¨åˆå§‹åŒ–çš„å®‰è£…çš„<code>_SIGURG</code>ä¿¡å·å‘é€åˆ°æŒ‡å®šçš„<code>M</code>ä¸Šã€‚</li>
<li>ä½¿ç”¨ preemptM å‘é€æŠ¢å ä¿¡å·çš„åœ°æ–¹ä¸»è¦æœ‰ä¸‹é¢å‡ ä¸ªï¼š
<ol>
<li>Go åå°ç›‘æ§ runtime.sysmon æ£€æµ‹è¶…æ—¶å‘é€æŠ¢å ä¿¡å·ï¼›</li>
<li>Go GC æ ˆæ‰«æå‘é€æŠ¢å ä¿¡å·ï¼›</li>
<li>Go GC STW çš„æ—¶å€™è°ƒç”¨ preemptall æŠ¢å æ‰€æœ‰ Pï¼Œè®©å…¶æš‚åœï¼›</li>
</ol>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/signal_unix.goã€‚</li>
<li>å‚æ•°<code>mp *m</code>ï¼šè¢«æŠ¢å çš„På…³è”çš„Mã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// preemptM sends a preemption request to mp. This request may be
</span></span></span><span class="line"><span class="cl"><span class="c1">// handled asynchronously and may be coalesced with other requests to
</span></span></span><span class="line"><span class="cl"><span class="c1">// the M. When the request is received, if the running G or P are
</span></span></span><span class="line"><span class="cl"><span class="c1">// marked for preemption and the goroutine is at an asynchronous
</span></span></span><span class="line"><span class="cl"><span class="c1">// safe-point, it will preempt the goroutine. It always atomically
</span></span></span><span class="line"><span class="cl"><span class="c1">// increments mp.preemptGen after handling a preemption request.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">preemptM</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// On Darwin, don&#39;t try to preempt threads during exec.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Issue #41702.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;darwin&#34;</span> <span class="o">||</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;ios&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">execLock</span><span class="p">.</span><span class="nf">rlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// mp.signalPending: è¿™ä¸ªMä¸Šæ˜¯å¦æœ‰ä¸€ä¸ªå¾…å¤„ç†çš„æŠ¢å ä¿¡å·ã€‚åŸå­æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Cas</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mp</span><span class="p">.</span><span class="nx">signalPending</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;darwin&#34;</span> <span class="o">||</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;ios&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pendingPreemptSignals</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// If multiple threads are preempting the same M, it may send many
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// signals to the same M such that it hardly make progress, causing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// live-lock problem. Apparently this could happen on darwin. See
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// issue #37741.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Only send a signal if there isn&#39;t already one pending.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å¦‚æœå¤šä¸ªçº¿ç¨‹æŠ¢å åŒä¸€ä¸ªMï¼Œå®ƒå¯èƒ½ä¼šå‘åŒä¸€ä¸ªMå‘é€è®¸å¤šä¿¡å·ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä½¿å…¶å‡ ä¹æ— æ³•å–å¾—è¿›å±•ï¼Œä»è€Œå¯¼è‡´å®æ—¶é”å®šé—®é¢˜ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ˜¾ç„¶è¿™å¯èƒ½å‘ç”Ÿåœ¨darwinèº«ä¸Šã€‚åªæœ‰åœ¨è¿˜æ²¡æœ‰æŒ‚èµ·çš„æƒ…å†µä¸‹æ‰å‘é€ä¿¡å·ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// const sigPreempt int = _SIGURG
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// const _SIGURG = 0x17
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">signalM</span><span class="p">(</span><span class="nx">mp</span><span class="p">,</span> <span class="nx">sigPreempt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;darwin&#34;</span> <span class="o">||</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;ios&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">execLock</span><span class="p">.</span><span class="nf">runlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="signalm">signalM()<a hidden class="anchor" aria-hidden="true" href="#signalm">#</a></h3>
<ol>
<li><code>signalM</code>å‘<code>mp</code>å‘é€ä¿¡å·ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/os_linux.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// signalM sends a signal to mp.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">signalM</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">,</span> <span class="nx">sig</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å°†ä¿¡å·sigå‘é€åˆ°çº¿ç¨‹ç»„tgidä¸­å…·æœ‰çº¿ç¨‹ID tidçš„çº¿ç¨‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// int tgkill(int tgid, int tid, int sig);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. tgidï¼šä¸ºçº¿ç¨‹ç»„ä¸­ä¸»çº¿ç¨‹çš„çº¿ç¨‹IDï¼Œæˆ–è€…ç§°ä¸ºè¿›ç¨‹å·ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    å…¶å®å®ƒèƒ½èµ·åˆ°ä¿æŠ¤çš„ä½œç”¨ï¼Œé˜²æ­¢å‘é”™è¯¯çš„çº¿ç¨‹å‘é€ä¿¡å·ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    æ¯”å¦‚å‘çº¿ç¨‹IDä¸º1234çš„çº¿ç¨‹å‘é€ä¿¡å·æ—¶ï¼Œå¾ˆå¯èƒ½çº¿ç¨‹1234æ—©å°±é€€å‡ºäº†ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    è€Œçº¿ç¨‹ID 1234æ°å¥½è¢«å†…æ ¸åˆ†é…ç»™äº†å¦ä¸€ä¸ªä¸ç›¸å¹²çš„è¿›ç¨‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. tidï¼šçº¿ç¨‹IDã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  3. sigï¼šä¿¡å·å€¼ã€‚sigPreempt = _SIGURG = 0x17ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">tgkill</span><span class="p">(</span><span class="nf">getpid</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="nx">mp</span><span class="p">.</span><span class="nx">procid</span><span class="p">),</span> <span class="nx">sig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="tgkill">tgkill()<a hidden class="anchor" aria-hidden="true" href="#tgkill">#</a></h3>
<ol>
<li>ç³»ç»Ÿè°ƒç”¨ <code>tgkill()</code> å‡½æ•°å‘è¿›ç¨‹å†…çš„çº¿ç¨‹å‘é€ä¿¡å·ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/sys_linux_amd64.sã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="err">Â·</span><span class="no">tgkill</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="p">,</span><span class="no">$0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">tgid</span><span class="err">+</span><span class="mi">0</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">DI</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">tid</span><span class="err">+</span><span class="mi">8</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">SI</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span>    <span class="no">sig</span><span class="err">+</span><span class="mi">16</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">DX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>    <span class="no">$SYS_tgkill</span><span class="p">,</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">SYSCALL</span> <span class="c1"># è¿›å…¥ç³»ç»Ÿè°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å…¨å±€ä¿¡å·å¤„ç†æ³¨å†Œ">å…¨å±€ä¿¡å·å¤„ç†æ³¨å†Œ<a hidden class="anchor" aria-hidden="true" href="#å…¨å±€ä¿¡å·å¤„ç†æ³¨å†Œ">#</a></h2>
<h3 id="mstart1">mstart1()<a hidden class="anchor" aria-hidden="true" href="#mstart1">#</a></h3>
<ol>
<li>ä¸»çº¿ç¨‹å¯åŠ¨è¿è¡Œåˆ°<code>mstart()</code>-&gt;<code>mstart0()</code>-&gt;<code>mstart1()</code>å‡½æ•°å†…æ—¶ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1394
</span><span class="lnt">1395
</span><span class="lnt">1396
</span><span class="lnt">1397
</span><span class="lnt">1398
</span><span class="lnt">1399
</span><span class="lnt">1400
</span><span class="lnt">1401
</span><span class="lnt">1402
</span><span class="lnt">1403
</span><span class="lnt">1404
</span><span class="lnt">1405
</span><span class="lnt">1406
</span><span class="lnt">1407
</span><span class="lnt">1408
</span><span class="lnt">1409
</span><span class="lnt">1410
</span><span class="lnt">1411
</span><span class="lnt">1412
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// The go:noinline is to guarantee the getcallerpc/getcallersp below are safe,
</span></span></span><span class="line"><span class="cl"><span class="c1">// so that we can set up g0.sched to return to the call of mstart1 above.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mstart1</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="nf">asminit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">minit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Install signal handlers; after minit so that minit can
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// prepare the thread to be able to handle the signals.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å®‰è£…ä¿¡å·å¤„ç†ç¨‹åº;åœ¨minitä¹‹åï¼Œä»¥ä¾¿minitå¯ä»¥å‡†å¤‡çº¿ç¨‹ï¼Œä»¥ä¾¿èƒ½å¤Ÿå¤„ç†ä¿¡å·ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span> <span class="o">==</span> <span class="o">&amp;</span><span class="nx">m0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">mstartm0</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="mstartm0">mstartm0()<a hidden class="anchor" aria-hidden="true" href="#mstartm0">#</a></h3>
<ol>
<li><code>initsig(false)</code>åˆ™æ˜¯æ³¨å†Œä¿¡å·å¤„ç†ç›¸å…³ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1435
</span><span class="lnt">1436
</span><span class="lnt">1437
</span><span class="lnt">1438
</span><span class="lnt">1439
</span><span class="lnt">1440
</span><span class="lnt">1441
</span><span class="lnt">1442
</span><span class="lnt">1443
</span><span class="lnt">1444
</span><span class="lnt">1445
</span><span class="lnt">1446
</span><span class="lnt">1447
</span><span class="lnt">1448
</span><span class="lnt">1449
</span><span class="lnt">1450
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// mstartm0 implements part of mstart1 that only runs on the m0.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Write barriers are allowed here because we know the GC can&#39;t be
</span></span></span><span class="line"><span class="cl"><span class="c1">// running yet, so they&#39;ll be no-ops.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:yeswritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mstartm0</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Create an extra M for callbacks on threads not created by Go.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// An extra M is also needed on Windows for callbacks created by
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// syscall.NewCallback. See issue #6751 for details.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">iscgo</span> <span class="o">||</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;windows&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">cgoHasExtraM</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">cgoHasExtraM</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="nf">newextram</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">initsig</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="initsig">initsig()<a hidden class="anchor" aria-hidden="true" href="#initsig">#</a></h3>
<ol>
<li>ä¿¡å·æ³¨å†Œã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/signal_unix.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Initialize signals.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Called by libpreinit so runtime may not be initialized.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">initsig</span><span class="p">(</span><span class="nx">preinit</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">preinit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// It&#39;s now OK for signal handlers to run.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ç°åœ¨å¯ä»¥è¿è¡Œä¿¡å·å¤„ç†ç¨‹åºäº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">signalsOK</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// For c-archive/c-shared this is called by libpreinit with
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// preinit == true.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">isarchive</span> <span class="o">||</span> <span class="nx">islibrary</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">preinit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// éå†ä¿¡å·æ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// const _NSIG int = 65; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">_NSIG</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// sigtable å…¨å±€å˜é‡å­˜å‚¨çš„æ˜¯æ‰€æœ‰ä¿¡å·åŠæè¿°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">t</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sigtable</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// const _SigDefault int = 16;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å¦‚æœä¿¡å·æ²¡æœ‰è¢«æ˜¾å¼è¯·æ±‚ï¼Œå°±ä¸è¦ç›‘è§†å®ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ç•¥è¿‡ä¿¡å·ï¼ŒSIGKILLã€SIGSTOPã€SIGTSTPã€SIGCONTã€SIGTTINã€SIGTTOU
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">flags</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">t</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">_SigDefault</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// We don&#39;t need to use atomic operations here because
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// there shouldn&#39;t be any other goroutines running yet.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">fwdSig</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nf">getsig</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nf">sigInstallGoHandler</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Even if we are not installing a signal handler,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// set SA_ONSTACK if necessary.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">fwdSig</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">_SIG_DFL</span> <span class="o">&amp;&amp;</span> <span class="nx">fwdSig</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">_SIG_IGN</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">setsigstack</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">fwdSig</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">_SIG_IGN</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">sigInitIgnored</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">handlingSig</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="nf">setsig</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABIInternal</span><span class="p">(</span><span class="nx">sighandler</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="setsig">setsig()<a hidden class="anchor" aria-hidden="true" href="#setsig">#</a></h3>
<ol>
<li>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ fn ç­‰äº sighandler çš„æ—¶å€™ï¼Œè°ƒç”¨çš„å‡½æ•°ä¼šè¢«æ›¿æ¢æˆ sigtrampã€‚</li>
<li>sigaction å‡½æ•°åœ¨ Linux ä¸‹ä¼šè°ƒç”¨ç³»ç»Ÿè°ƒç”¨å‡½æ•° sys_signal ä»¥åŠ sys_rt_sigaction å®ç°å®‰è£…ä¿¡å·ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/os_linux.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">setsig</span><span class="p">(</span><span class="nx">i</span> <span class="kt">uint32</span><span class="p">,</span> <span class="nx">fn</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">sa</span> <span class="nx">sigactiont</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sa</span><span class="p">.</span><span class="nx">sa_flags</span> <span class="p">=</span> <span class="nx">_SA_SIGINFO</span> <span class="p">|</span> <span class="nx">_SA_ONSTACK</span> <span class="p">|</span> <span class="nx">_SA_RESTORER</span> <span class="p">|</span> <span class="nx">_SA_RESTART</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sigfillset</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sa</span><span class="p">.</span><span class="nx">sa_mask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Although Linux manpage says &#34;sa_restorer element is obsolete and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// should not be used&#34;. x86_64 kernel requires it. Only use it on
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// x86.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">GOARCH</span> <span class="o">==</span> <span class="s">&#34;386&#34;</span> <span class="o">||</span> <span class="nx">GOARCH</span> <span class="o">==</span> <span class="s">&#34;amd64&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sa</span><span class="p">.</span><span class="nx">sa_restorer</span> <span class="p">=</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABI0</span><span class="p">(</span><span class="nx">sigreturn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">fn</span> <span class="o">==</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABIInternal</span><span class="p">(</span><span class="nx">sighandler</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// abi.FuncPCABIInternal(sighandler) matches the callers in signal_unix.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">iscgo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">fn</span> <span class="p">=</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABI0</span><span class="p">(</span><span class="nx">cgoSigtramp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æ›¿æ¢ä¸ºè°ƒç”¨ sigtramp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">fn</span> <span class="p">=</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABI0</span><span class="p">(</span><span class="nx">sigtramp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sa</span><span class="p">.</span><span class="nx">sa_handler</span> <span class="p">=</span> <span class="nx">fn</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sigaction</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">sa</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ä¿¡å·å½¢å¼å“åº”æŠ¢å ">ä¿¡å·å½¢å¼å“åº”æŠ¢å <a hidden class="anchor" aria-hidden="true" href="#ä¿¡å·å½¢å¼å“åº”æŠ¢å ">#</a></h2>
<h3 id="sigtramp">sigtramp()<a hidden class="anchor" aria-hidden="true" href="#sigtramp">#</a></h3>
<ol>
<li>å‡½æ•°åŸå‹ï¼š<code>func sigtramp()</code>ã€‚</li>
<li><code>sigtramp()</code>å®é™…ä¸Šæ˜¯çœŸæ­£çš„ä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¿›ç¨‹ä»å†…æ ¸æ€æ”¶åˆ°ä¿¡å·å›åˆ°ç”¨æˆ·æ€è°ƒç”¨çš„å¤„ç†å‡½æ•°å°±æ˜¯å®ƒã€‚</li>
<li>æ³¨é‡Šä¸­è¡¨æ˜è¿™ä¸ªå‡½æ•°ä»¥<code>C</code>è¯­è¨€çš„è°ƒç”¨æƒ¯ä¾‹è¢«è°ƒç”¨ï¼Œ<code>Go</code>åœ¨è¿™é‡Œé€šè¿‡<code>PUSH_REGS_HOST_TO_ABI0</code>ä¿å­˜<code>go</code>è‡ªå·±è°ƒç”¨æƒ¯ä¾‹ç”¨çš„å¯„å­˜å™¨åï¼Œ</li>
<li>è½¬æ¢æˆè‡ªå·±çš„è°ƒç”¨è§„èŒƒï¼Œç­‰å‡½æ•°è°ƒç”¨å®Œæ¯•ä¹‹åï¼Œå†é€šè¿‡<code>POP_REGS_HOST_TO_ABI0</code>æ¢å¤è¿™äº›å¯„å­˜å™¨çš„å€¼ã€‚</li>
<li>è°ƒåº¦è·¯å¾„<code>sigtramp()</code>-&gt;<code>sigtrampgo()</code>-&gt;<code>sighandler()</code>-&gt;<code>doSigPreempt()</code>ã€‚</li>
<li>è¿™é‡Œä¼šè¢«è°ƒç”¨è¯´æ˜ä¿¡å·å·²ç»å‘é€å“åº”äº†ï¼Œ<code>runtimeÂ·sigtramp</code>ä¼šè¿›è¡Œä¿¡å·çš„å¤„ç†ã€‚</li>
<li><code>runtimeÂ·sigtramp</code>ä¼šç»§ç»­è°ƒç”¨<code>runtimeÂ·sigtrampgo</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/sys_linux_amd64.sã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1"># Called using C ABI.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">sigtramp</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="err">|</span><span class="no">TOPFRAME</span><span class="p">,</span><span class="no">$0</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Transition from C ABI to Go ABI.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">PUSH_REGS_HOST_TO_ABI0</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Set up ABIInternal environment: g in R14, cleared X15.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">get_tls</span><span class="p">(</span><span class="no">R12</span><span class="p">)</span>        <span class="c1"># TLS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">g</span><span class="p">(</span><span class="no">R12</span><span class="p">),</span> <span class="no">R14</span> <span class="c1"># R14 = g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">PXOR</span>    <span class="no">X15</span><span class="p">,</span> <span class="no">X15</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Reserve space for spill slots.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">NOP</span> <span class="no">SP</span>  <span class="c1"># disable vet stack checking
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ADJSP</span>   <span class="no">$24</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Call into the Go signal handler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># å†…æ ¸ä¿®æ”¹ç”¨æˆ·æ€å¯„å­˜å™¨æ—¶è®¾ç½®çš„ rdiã€rsiã€rdx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä¸‰ä¸ªå¯„å­˜å™¨çš„å€¼å°±æ˜¯å†…æ ¸æ¨¡ä»¿è°ƒç”¨sigtrampæ—¶ä¼ å…¥çš„å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">DI</span><span class="p">,</span> <span class="no">AX</span>	<span class="c1"># sig
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">SI</span><span class="p">,</span> <span class="no">BX</span>	<span class="c1"># info
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">DX</span><span class="p">,</span> <span class="no">CX</span>	<span class="c1"># ctx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="err">Â·</span><span class="no">sigtrampgo</span><span class="err">&lt;</span><span class="no">ABIInternal</span><span class="err">&gt;</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">ADJSP</span>   <span class="no">$-24</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">POP_REGS_HOST_TO_ABI0</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="sigtrampgo">sigtrampgo()<a hidden class="anchor" aria-hidden="true" href="#sigtrampgo">#</a></h3>
<ol>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/signal_unix.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// sigtrampgo is called from the signal handler function, sigtramp,
</span></span></span><span class="line"><span class="cl"><span class="c1">// written in assembly code.
</span></span></span><span class="line"><span class="cl"><span class="c1">// This is called by the signal handler, and the world may be stopped.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// It must be nosplit because getg() is still the G that was running
</span></span></span><span class="line"><span class="cl"><span class="c1">// (if any) when the signal was delivered, but it&#39;s (usually) called
</span></span></span><span class="line"><span class="cl"><span class="c1">// on the gsignal stack. Until this switches the G to gsignal, the
</span></span></span><span class="line"><span class="cl"><span class="c1">// stack bounds check won&#39;t work.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">sigtrampgo</span><span class="p">(</span><span class="nx">sig</span> <span class="kt">uint32</span><span class="p">,</span> <span class="nx">info</span> <span class="o">*</span><span class="nx">siginfo</span><span class="p">,</span> <span class="nx">ctx</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nf">sigfwdgo</span><span class="p">(</span><span class="nx">sig</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sigctxt</span><span class="p">{</span><span class="nx">info</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">sigFetchG</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="c1">// g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">setg</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">sig</span> <span class="o">==</span> <span class="nx">_SIGPROF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Some platforms (Linux) have per-thread timers, which we use in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// combination with the process-wide timer. Avoid double-counting.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nf">validSIGPROF</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">sigprofNonGoPC</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nf">sigpc</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">sig</span> <span class="o">==</span> <span class="nx">sigPreempt</span> <span class="o">&amp;&amp;</span> <span class="nx">preemptMSupported</span> <span class="o">&amp;&amp;</span> <span class="nx">debug</span><span class="p">.</span><span class="nx">asyncpreemptoff</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// This is probably a signal from preemptM sent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// while executing Go code but received while
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// executing non-Go code.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// We got past sigfwdgo, so we know that there is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// no non-Go signal handler for sigPreempt.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// The default behavior for sigPreempt is to ignore
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// the signal, so badsignal will be a no-op anyway.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;darwin&#34;</span> <span class="o">||</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;ios&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">pendingPreemptSignals</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nf">fixsigcode</span><span class="p">(</span><span class="nx">sig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">badsignal</span><span class="p">(</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">sig</span><span class="p">),</span> <span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">setg</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">gsignal</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// If some non-Go code called sigaltstack, adjust.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">gsignalStack</span> <span class="nx">gsignalStack</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setStack</span> <span class="o">:=</span> <span class="nf">adjustSignalStack</span><span class="p">(</span><span class="nx">sig</span><span class="p">,</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">gsignalStack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">setStack</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">gsignal</span><span class="p">.</span><span class="nx">stktopsp</span> <span class="p">=</span> <span class="nf">getcallersp</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="o">==</span> <span class="nx">stackFork</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">signalDuringFork</span><span class="p">(</span><span class="nx">sig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">.</span><span class="nf">fixsigcode</span><span class="p">(</span><span class="nx">sig</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sighandler</span><span class="p">(</span><span class="nx">sig</span><span class="p">,</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">ctx</span><span class="p">,</span> <span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setg</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">setStack</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">restoreGsignalStack</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gsignalStack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="sighander">sighander()<a hidden class="anchor" aria-hidden="true" href="#sighander">#</a></h3>
<ol>
<li>å“åº”æŠ¢å ã€‚è°ƒåº¦è·¯å¾„<code>sigtramp()</code>-&gt;<code>sigtrampgo()</code>-&gt;<code>sighandler()</code>-&gt;<code>doSigPreempt()</code>ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/signal_unix.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// sighandler is invoked when a signal occurs. The global g will be
</span></span></span><span class="line"><span class="cl"><span class="c1">// set to a gsignal goroutine and we will be running on the alternate
</span></span></span><span class="line"><span class="cl"><span class="c1">// signal stack. The parameter g will be the value of the global g
</span></span></span><span class="line"><span class="cl"><span class="c1">// when the signal occurred. The sig, info, and ctxt parameters are
</span></span></span><span class="line"><span class="cl"><span class="c1">// from the system signal handler: they are the parameters passed when
</span></span></span><span class="line"><span class="cl"><span class="c1">// the SA is passed to the sigaction system call.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// The garbage collector may have stopped the world, so write barriers
</span></span></span><span class="line"><span class="cl"><span class="c1">// are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">sighandler</span><span class="p">(</span><span class="nx">sig</span> <span class="kt">uint32</span><span class="p">,</span> <span class="nx">info</span> <span class="o">*</span><span class="nx">siginfo</span><span class="p">,</span> <span class="nx">ctxt</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ... ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// sig == sigPreemptï¼šæŠ¢å ä¿¡å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// debug.asyncpreemptoff == 0ï¼šæ²¡æœ‰ç¦æ­¢æŠ¢å 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// delayedSignalï¼šå»¶è¿Ÿä¿¡å·?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">sig</span> <span class="o">==</span> <span class="nx">sigPreempt</span> <span class="o">&amp;&amp;</span> <span class="nx">debug</span><span class="p">.</span><span class="nx">asyncpreemptoff</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">delayedSignal</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Might be a preemption signal.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¯èƒ½æ˜¯ä¸€ä¸ªæŠ¢å ä¿¡å·ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">doSigPreempt</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Even if this was definitely a preemption signal, it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// may have been coalesced with another signal, so we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// still let it through to the application.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å³ä½¿è¿™ç¡®å®æ˜¯ä¸€ä¸ªæŠ¢å ä¿¡å·ï¼Œå®ƒå¯èƒ½å·²ç»ä¸å¦ä¸€ä¸ªä¿¡å·åˆå¹¶ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»ç„¶è®©å®ƒé€šè¿‡åº”ç”¨ç¨‹åºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// ... ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dosigpreempt">doSigPreempt()<a hidden class="anchor" aria-hidden="true" href="#dosigpreempt">#</a></h3>
<ol>
<li>doSigPreemptå¤„ç†gpä¸Šçš„æŠ¢å ä¿¡å·ã€‚</li>
<li>è°ƒç”¨åˆ°<code>doSigPreempt</code>æ—¶ï¼Œä¼šå°†<code>ctx</code>è¿™ä¸ªå‚æ•°ä¼ å…¥ï¼Œå…¶ä¸­åŒ…å«äº†è¿›ç¨‹ç”¨æˆ·æ€ç¡¬ä»¶ä¸Šä¸‹æ–‡</li>
<li><code>ctxt</code>çš„ç±»å‹ä¸º<code>*sigctxt</code>ï¼ŒæŒ‡å‘çš„æ˜¯ç”¨æˆ·æ€å †æ ˆä¸­å­˜æ”¾å†…æ ¸æ€å †æ ˆå†…å®¹çš„åœ°å€ã€‚</li>
<li>ç„¶åä¿¡å·å¤„ç†ç¨‹åºé€šè¿‡<code>isAsyncSafePoint</code>æ¥åˆ¤æ–­æŠ¢å ä½ç½®æ˜¯å¦å®‰å…¨ï¼Œå¹¶è¿”å›å®‰å…¨çš„æŠ¢å åœ°å€ã€‚</li>
<li>å¦‚æœç¡®è®¤æŠ¢å æ²¡æœ‰é—®é¢˜ï¼Œæ¥ç€ä¼šè°ƒç”¨<code>pushCall</code>æ–¹æ³•æ¥ä¿®æ”¹<code>ctxt</code>ä¸­çš„ç”¨æˆ·æ€ç¡¬ä»¶ä¸Šä¸‹æ–‡ï¼Œ</li>
<li>ç”¨äºç¨åå†ä¸€æ¬¡ä»å†…æ ¸æ€è¿”å›ç”¨æˆ·æ€æ—¶æ¨¡æ‹Ÿå‡ºä¸€ä¸ªç”¨æˆ·æ€ç¨‹åºè°ƒç”¨<code>asyncPreempt</code>çš„å‡è±¡ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/signal_unix.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// doSigPreempt handles a preemption signal on gp.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">doSigPreempt</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">ctxt</span> <span class="o">*</span><span class="nx">sigctxt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Check if this G wants to be preempted and is safe to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// preempt.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ£€æŸ¥è¿™ä¸ªGæ˜¯å¦å¸Œæœ›è¢«æŠ¢å ï¼Œå¹¶ä¸”æŠ¢å æ˜¯å®‰å…¨çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é€šè¿‡ wantAsyncPreempt å‡½æ•°ç¡®è®¤runtimeç¡®å®æƒ³è¦å¯¹æŒ‡å®šçš„Gå®æ–½å¼‚æ­¥æŠ¢å 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">wantAsyncPreempt</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// é€šè¿‡isAsyncSafePointå‡½æ•°ç¡®è®¤Gå½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡æ˜¯èƒ½å¤Ÿå®‰å…¨åœ°è¿›è¡Œå¼‚æ­¥æŠ¢å çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">ok</span><span class="p">,</span> <span class="nx">newpc</span> <span class="o">:=</span> <span class="nf">isAsyncSafePoint</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">ctxt</span><span class="p">.</span><span class="nf">sigpc</span><span class="p">(),</span> <span class="nx">ctxt</span><span class="p">.</span><span class="nf">sigsp</span><span class="p">(),</span> <span class="nx">ctxt</span><span class="p">.</span><span class="nf">siglr</span><span class="p">());</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Adjust the PC and inject a call to asyncPreempt.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ä»¥ä¸Šä¸¤ä¸ªå‡½æ•°éƒ½ç¡®è®¤æ— è¯¯åï¼Œæ‰é€šè¿‡pushCallå‘Gçš„æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­æ³¨å…¥ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¦è°ƒç”¨çš„ç›®æ ‡å‡½æ•°æ˜¯ runtime.asyncPreempt å‡½æ•°ã€‚è¿™æ˜¯ä¸€ä¸ªæ±‡ç¼–å‡½æ•°ï¼Œå®ƒä¼šå…ˆæŠŠå„ä¸ªå¯„å­˜å™¨çš„å€¼ä¿å­˜åœ¨æ ˆä¸Šï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ä¹Ÿå°±æ˜¯å°†ç°åœºä¿å­˜åœ¨æ ˆä¸Šï¼Œç„¶åè°ƒç”¨ runtime.asyncPreempt2å‡½æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">ctxt</span><span class="p">.</span><span class="nf">pushCall</span><span class="p">(</span><span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABI0</span><span class="p">(</span><span class="nx">asyncPreempt</span><span class="p">),</span> <span class="nx">newpc</span><span class="p">)</span> <span class="c1">// å°±æ˜¯å‘å½“å‰è¿è¡Œçš„goroutineæ³¨å†ŒåŠ å…¥asyncPreemptå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Acknowledge the preemption.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">preemptGen</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">signalPending</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;darwin&#34;</span> <span class="o">||</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;ios&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pendingPreemptSignals</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="wantasyncpreempt">wantAsyncPreempt()<a hidden class="anchor" aria-hidden="true" href="#wantasyncpreempt">#</a></h3>
<ol>
<li>wantAsyncPreemptè¿”å›å¼‚æ­¥æŠ¢å æ˜¯å¦ä¸ºgpæ’é˜Ÿã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/preempt.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// wantAsyncPreempt returns whether an asynchronous preemption is
</span></span></span><span class="line"><span class="cl"><span class="c1">// queued for gp.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">wantAsyncPreempt</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Check both the G and the P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åŒæ—¶æ£€æŸ¥Gå’ŒPçš„preemptå­—æ®µï¼Œå¹¶ä¸”Gå½“å‰éœ€è¦å¤„äº_GrunningçŠ¶æ€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨æ¯è½®è°ƒåº¦å¾ªç¯ä¸­ï¼ŒPå’ŒGçš„preemptå­—æ®µéƒ½ä¼šè¢«ç½®ä¸ºfalseï¼Œæ‰€ä»¥è¿™ä¸ªæ£€æµ‹èƒ½å¤Ÿé¿å…åˆšåˆšåˆ‡æ¢è‡³ä¸€ä¸ªæ–°çš„Gåé©¬ä¸Šåˆè¢«æŠ¢å ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// gp.preempt || gp.m.p != 0 &amp;&amp; gp.m.p.ptr().preemptï¼šåˆ¤æ–­Gæˆ–Pçš„preemptæŠ¢å æ ‡è¯†ä½ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// readgstatus(gp)&amp;^_Gscan == _Grunningï¼šå½“å‰Gæ­£åœ¨è¿è¡ŒçŠ¶æ€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç¡®è®¤æ˜¯å¦è®¾ç½®äº†æŠ¢å æ ‡å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">preempt</span> <span class="o">||</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">preempt</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nf">readgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span><span class="o">&amp;^</span><span class="nx">_Gscan</span> <span class="o">==</span> <span class="nx">_Grunning</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="isasyncsafepoint">isAsyncSafePoint()<a hidden class="anchor" aria-hidden="true" href="#isasyncsafepoint">#</a></h3>
<ol>
<li>å®ƒä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥ä¿è¯åœ¨å½“å‰ä½ç½®è¿›è¡Œå¼‚æ­¥æŠ¢å æ˜¯å®‰å…¨çš„ã€‚
<ol>
<li>å¯ä»¥æŒ‚èµ·Gå¹¶å®‰å…¨çš„æ‰«æå®ƒçš„æ ˆå’Œå¯„å­˜å™¨ï¼Œæ²¡æœ‰æ½œåœ¨çš„éšè—æŒ‡é’ˆï¼Œè€Œä¸”å½“å‰å¹¶æ²¡æœ‰æ‰“æ–­ä¸€ä¸ªå†™å±éšœã€‚</li>
<li>Gè¿˜æœ‰è¶³å¤Ÿçš„æ ˆç©ºé—´æ¥æ³¨å…¥ä¸€ä¸ªå¯¹asyncPreempt()å‡½æ•°çš„è°ƒç”¨ã€‚</li>
<li>å¯ä»¥å®‰å…¨åœ°å’Œ runtime è¿›è¡Œäº¤äº’ï¼Œä¾‹å¦‚æœªæŒæœ‰ runtime ç›¸å…³çš„é”ï¼Œå› æ­¤åœ¨å°è¯•è·å¾—é”æ—¶ä¸ä¼šé€ æˆæ­»é”ã€‚</li>
</ol>
</li>
<li>isAsyncSafePointæŠ¥å‘ŠæŒ‡ä»¤PCä¸Šçš„gpæ˜¯å¦æ˜¯å¼‚æ­¥å®‰å…¨ç‚¹ã€‚è¿™è¡¨æ˜ï¼š
<ol>
<li>æš‚åœgpå¹¶ä¿å®ˆåœ°æ‰«æå®ƒçš„å †æ ˆå’Œå¯„å­˜å™¨æ˜¯å®‰å…¨çš„ã€‚å®ƒæ²¡æœ‰æ½œåœ¨çš„éšè—æŒ‡é’ˆå€¼ï¼Œä¹Ÿä¸åƒå†™å±éšœé‚£æ ·ä½äºåŸå­åºåˆ—çš„ä¸­é—´ã€‚</li>
<li>gpæœ‰è¶³å¤Ÿçš„å †æ ˆç©ºé—´æ³¨å…¥asyncPreemptè°ƒç”¨ã€‚</li>
<li>é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸è¿è¡Œæ—¶äº¤äº’æ˜¯å®‰å…¨çš„ï¼Œå³ä½¿æˆ‘ä»¬åœ¨ä¿¡å·å¤„ç†ç¨‹åºä¸­å°±åœåœ¨è¿™é‡Œã€‚ä¾‹å¦‚ï¼Œæ²¡æœ‰æŒæœ‰è¿è¡Œæ—¶é”ï¼Œå› æ­¤è·å–è¿è¡Œæ—¶é”ä¸ä¼šè‡ªæ­»é”ã€‚</li>
</ol>
</li>
<li>åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒPCæ˜¯å®‰å…¨çš„å¼‚æ­¥æŠ¢å ï¼Œä½†å®ƒä¹Ÿéœ€è¦è°ƒæ•´æ¢å¤PCã€‚æ–°çš„PCåœ¨ç¬¬äºŒä¸ªç»“æœä¸­è¿”å›ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/preempt.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// isAsyncSafePoint reports whether gp at instruction PC is an
</span></span></span><span class="line"><span class="cl"><span class="c1">// asynchronous safe point. This indicates that:
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// 1. It&#39;s safe to suspend gp and conservatively scan its stack and
</span></span></span><span class="line"><span class="cl"><span class="c1">// registers. There are no potentially hidden pointer values and it&#39;s
</span></span></span><span class="line"><span class="cl"><span class="c1">// not in the middle of an atomic sequence like a write barrier.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// 2. gp has enough stack space to inject the asyncPreempt call.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// 3. It&#39;s generally safe to interact with the runtime, even if we&#39;re
</span></span></span><span class="line"><span class="cl"><span class="c1">// in a signal handler stopped here. For example, there are no runtime
</span></span></span><span class="line"><span class="cl"><span class="c1">// locks held, so acquiring a runtime lock won&#39;t self-deadlock.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// In some cases the PC is safe for asynchronous preemption but it
</span></span></span><span class="line"><span class="cl"><span class="c1">// also needs to adjust the resumption PC. The new PC is returned in
</span></span></span><span class="line"><span class="cl"><span class="c1">// the second result.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">isAsyncSafePoint</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">pc</span><span class="p">,</span> <span class="nx">sp</span><span class="p">,</span> <span class="nx">lr</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span> <span class="o">:=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Only user Gs can have safe-points. We check this first
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// because it&#39;s extremely common that we&#39;ll catch mp in the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// scheduler processing this G preemption.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åªæœ‰ç”¨æˆ·Gså¯ä»¥æœ‰å®‰å…¨ç‚¹ã€‚æˆ‘ä»¬é¦–å…ˆæ£€æŸ¥è¿™ä¸ªï¼Œå› ä¸ºåœ¨å¤„ç†GæŠ¢å çš„è°ƒåº¦å™¨ä¸­æ•è·mpæ˜¯éå¸¸å¸¸è§çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">curg</span> <span class="o">!=</span> <span class="nx">gp</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Check M state.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ£€æŸ¥MçŠ¶æ€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// canPreemptM(mp) -&gt; mp.locks == 0 &amp;&amp; mp.mallocing == 0 &amp;&amp; mp.preemptoff == &#34;&#34; &amp;&amp; mp.p.ptr().status == _Prunning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">!</span><span class="nf">canPreemptM</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Check stack space.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ£€æŸ¥æ ˆç©ºé—´ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// asyncPreemptStackæ˜¯æ³¨å…¥ä¸€ä¸ªasyncPreemptè°ƒç”¨æ‰€éœ€çš„æ ˆç©ºé—´çš„å­—èŠ‚ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sp</span> <span class="p">&lt;</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">||</span> <span class="nx">sp</span><span class="o">-</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="p">&lt;</span> <span class="nx">asyncPreemptStack</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Check if PC is an unsafe-point.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ£€æŸ¥PCæ˜¯å¦ä¸ºä¸å®‰å…¨ç‚¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">f</span> <span class="o">:=</span> <span class="nf">findfunc</span><span class="p">(</span><span class="nx">pc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">f</span><span class="p">.</span><span class="nf">valid</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Not Go code.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">GOARCH</span> <span class="o">==</span> <span class="s">&#34;mips&#34;</span> <span class="o">||</span> <span class="nx">GOARCH</span> <span class="o">==</span> <span class="s">&#34;mipsle&#34;</span> <span class="o">||</span> <span class="nx">GOARCH</span> <span class="o">==</span> <span class="s">&#34;mips64&#34;</span> <span class="o">||</span> <span class="nx">GOARCH</span> <span class="o">==</span> <span class="s">&#34;mips64le&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">lr</span> <span class="o">==</span> <span class="nx">pc</span><span class="o">+</span><span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="nf">funcspdelta</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">pc</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// We probably stopped at a half-executed CALL instruction,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// where the LR is updated but the PC has not. If we preempt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// here we&#39;ll see a seemingly self-recursive call, which is in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// fact not.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// This is normally ok, as we use the return address saved on
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// stack for unwinding, not the LR value. But if this is a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// call to morestack, we haven&#39;t created the frame, and we&#39;ll
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// use the LR for unwinding, which will be bad.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">up</span><span class="p">,</span> <span class="nx">startpc</span> <span class="o">:=</span> <span class="nf">pcdatavalue2</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">_PCDATA_UnsafePoint</span><span class="p">,</span> <span class="nx">pc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">up</span> <span class="o">==</span> <span class="nx">_PCDATA_UnsafePointUnsafe</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Unsafe-point marked by compiler. This includes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// atomic sequences (e.g., write barrier) and nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// functions (except at calls).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">fd</span> <span class="o">:=</span> <span class="nf">funcdata</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">_FUNCDATA_LocalsPointerMaps</span><span class="p">);</span> <span class="nx">fd</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">f</span><span class="p">.</span><span class="nx">flag</span><span class="o">&amp;</span><span class="nx">funcFlag_ASM</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// This is assembly code. Don&#39;t assume it&#39;s well-formed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// TODO: Empirically we still need the fd == nil check. Why?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// TODO: Are there cases that are safe but don&#39;t have a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// locals pointer map, like empty frame functions?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// It might be possible to preempt any assembly functions
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// except the ones that have funcFlag_SPWRITE set in f.flag.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span> <span class="o">:=</span> <span class="nf">funcname</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">inldata</span> <span class="o">:=</span> <span class="nf">funcdata</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">_FUNCDATA_InlTree</span><span class="p">);</span> <span class="nx">inldata</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">inltree</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">]</span><span class="nx">inlinedCall</span><span class="p">)(</span><span class="nx">inldata</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ix</span> <span class="o">:=</span> <span class="nf">pcdatavalue</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">_PCDATA_InlTreeIndex</span><span class="p">,</span> <span class="nx">pc</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">ix</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">name</span> <span class="p">=</span> <span class="nf">funcnameFromNameoff</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">inltree</span><span class="p">[</span><span class="nx">ix</span><span class="p">].</span><span class="nx">func_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nf">hasPrefix</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="s">&#34;runtime.&#34;</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="nf">hasPrefix</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="s">&#34;runtime/internal/&#34;</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="nf">hasPrefix</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="s">&#34;reflect.&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// For now we never async preempt the runtime or
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// anything closely tied to the runtime. Known issues
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// include: various points in the scheduler (&#34;don&#39;t
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// preempt between here and here&#34;), much of the defer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// implementation (untyped info on stack), bulk write
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// barriers (write barrier check),
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// reflect.{makeFuncStub,methodValueCall}.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// TODO(austin): We should improve this, or opt things
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// in incrementally.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="nx">up</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">_PCDATA_Restart1</span><span class="p">,</span> <span class="nx">_PCDATA_Restart2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Restartable instruction sequence. Back off PC to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// the start PC.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">startpc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">startpc</span> <span class="p">&gt;</span> <span class="nx">pc</span> <span class="o">||</span> <span class="nx">pc</span><span class="o">-</span><span class="nx">startpc</span> <span class="p">&gt;</span> <span class="mi">20</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad restart PC&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">startpc</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">_PCDATA_RestartAtEntry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Restart from the function entry at resumption.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">f</span><span class="p">.</span><span class="nf">entry</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">pc</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="pushcall">pushCall()<a hidden class="anchor" aria-hidden="true" href="#pushcall">#</a></h3>
<ol>
<li><code>pushCall</code>å¹²äº†ä¸¤ä»¶äº‹ï¼š
<ul>
<li>ä¿®æ”¹ç¨‹åºè®¡æ•°å™¨çš„æŒ‡å‘ä¸º<code>asyncPreempt</code>å‡½æ•°çš„åœ°å€ã€‚</li>
<li>ä¿®æ”¹æ ˆé¡¶æŒ‡é’ˆï¼Œå°†å½“å‰ goroutine çš„åŸæœ¬ä¸­æ–­åœ°å€æ”¾å…¥å †æ ˆã€‚</li>
</ul>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/signal_amd64.goã€‚</li>
<li>å…ˆæŠŠSPå‘ä¸‹ç§»åŠ¨ä¸€ä¸ªæŒ‡é’ˆå¤§å°çš„ä½ç½®ï¼ŒæŠŠPCçš„å€¼å­˜å…¥æ ˆä¸ŠSPæŒ‡å‘çš„ä½ç½®ï¼Œç„¶åå°†PCçš„å€¼æ›´æ–°ä¸ºtargetPCã€‚</li>
<li>è¿™æ ·å°±æ¨¡æ‹Ÿäº†ä¸€æ¡CALLæŒ‡ä»¤çš„æ•ˆæœï¼Œæ ˆä¸Šå­˜å…¥çš„PCçš„æ—§å€¼å°±ç›¸å½“äºè¿”å›åœ°å€ã€‚</li>
<li>æ­¤æ—¶æ•´ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡çš„çŠ¶æ€å°±åƒæ˜¯goroutineåœ¨è¢«ä¿¡å·æ‰“æ–­çš„ä½ç½®é¢å¤–æ‰§è¡Œäº†ä¸€æ¡CALL targetPCæŒ‡ä»¤ã€‚</li>
<li>ç”±äºæ‰§è¡Œæµç¨‹åˆšåˆšè·³è½¬åˆ°targetPCåœ°å€å¤„ï¼Œæ‰€ä»¥è¿˜æ²¡æ¥å¾—åŠæ‰§è¡Œç›®æ ‡åœ°å€å¤„çš„æŒ‡ä»¤ã€‚</li>
<li>å½“sighandler()å‡½æ•°å¤„ç†å®Œä¿¡å·å¹¶è¿”å›åï¼Œè¢«æ‰“æ–­çš„goroutineå¾—ä»¥ç»§ç»­æ‰§è¡Œï¼Œä¼šç«‹å³è°ƒç”¨è¢«æ³¨å…¥çš„asyncPreempt()å‡½æ•°ã€‚ç»è¿‡ä¸€è¿ä¸²çš„å‡½æ•°è°ƒç”¨ï¼Œæœ€ç»ˆæ‰§è¡Œåˆ°schedule()å‡½æ•°ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>targetPC uintptr</code>ï¼šasyncPreempt å‡½æ•°çš„æ‰§è¡Œå…¥å£åœ°å€ã€‚</li>
<li><code>resumePC uintptr</code>ï¼šå…¶å®å°±æ˜¯å‘ç”Ÿä¸­æ–­å‰å½“å‰goroutineçš„ä¸‹ä¸€æŒ‡ä»¤åœ°å€ï¼Œä¹Ÿå°±æ˜¯PCçš„å€¼ã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">sigctxt</span><span class="p">)</span> <span class="nf">pushCall</span><span class="p">(</span><span class="nx">targetPC</span><span class="p">,</span> <span class="nx">resumePC</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Make it look like we called target at resumePC.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è®©å®ƒçœ‹èµ·æ¥åƒæˆ‘ä»¬åœ¨resumePCä¸Šè°ƒç”¨äº†targetã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sp</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nf">rsp</span><span class="p">())</span> <span class="c1">// å½“å‰goroutineçš„SP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sp</span> <span class="o">-=</span> <span class="nx">goarch</span><span class="p">.</span><span class="nx">PtrSize</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">uintptr</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">sp</span><span class="p">))</span> <span class="p">=</span> <span class="nx">resumePC</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è®¾ç½®å½“å‰ä¸­æ–­ä¿å­˜çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå› ä¸ºä¸­æ–­ç»“æŸåä»è¿™é‡Œæ¢å¤ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span><span class="p">.</span><span class="nf">set_rsp</span><span class="p">(</span><span class="nb">uint64</span><span class="p">(</span><span class="nx">sp</span><span class="p">))</span>       <span class="c1">// ä¿®æ”¹ä¸­æ–­ä¿å­˜çš„ä¸Šä¸‹æ–‡SP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span><span class="p">.</span><span class="nf">set_rip</span><span class="p">(</span><span class="nb">uint64</span><span class="p">(</span><span class="nx">targetPC</span><span class="p">))</span> <span class="c1">// ä¿®æ”¹ä¸­æ–­ä¿å­˜çš„ä¸Šä¸‹æ–‡PC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/goroutine-015.png" alt=""  />
</p>
<h3 id="asyncpreempt">asyncPreempt()<a hidden class="anchor" aria-hidden="true" href="#asyncpreempt">#</a></h3>
<ol>
<li>ä¸­æ–­ä¿¡å·å‡½æ•°å¤„ç†å®Œåï¼Œgoroutineå¾—åˆ°è¿è¡Œï¼Œç»§ç»­ä»åµŒå…¥çš„æœ¬å‡½æ•°å¼€å§‹æ‰§è¡Œã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/preempt_amd64.sã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="err">Â·</span><span class="no">asyncPreempt</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="err">|</span><span class="no">NOFRAME</span><span class="p">,</span><span class="no">$0-0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">PUSHQ</span> <span class="no">BP</span>        <span class="c1"># BPå…¥æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span> <span class="no">SP</span><span class="p">,</span> <span class="no">BP</span>     <span class="c1"># BP = SP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># Save flags before clobbering them
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">PUSHFQ</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># obj doesn&#39;t understand ADD/SUB on SP, but does understand ADJSP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ADJSP</span> <span class="no">$368</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># But vet doesn&#39;t know ADJSP, so suppress vet stack checking
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">NOP</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">16</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="no">BX</span><span class="p">,</span> <span class="mi">24</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="no">SI</span><span class="p">,</span> <span class="mi">32</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="no">DI</span><span class="p">,</span> <span class="mi">40</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="no">R8</span><span class="p">,</span> <span class="mi">48</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="no">R9</span><span class="p">,</span> <span class="mi">56</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="no">R10</span><span class="p">,</span> <span class="mi">64</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="no">R11</span><span class="p">,</span> <span class="mi">72</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="no">R12</span><span class="p">,</span> <span class="mi">80</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="no">R13</span><span class="p">,</span> <span class="mi">88</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="no">R14</span><span class="p">,</span> <span class="mi">96</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="no">R15</span><span class="p">,</span> <span class="mi">104</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#ifdef GOOS_darwin
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPB</span> <span class="no">internal</span><span class="err">âˆ•</span><span class="no">cpu</span><span class="err">Â·</span><span class="no">X86</span><span class="err">+</span><span class="no">const_offsetX86HasAVX</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">$0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JE</span> <span class="mi">2</span><span class="p">(</span><span class="no">PC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">VZEROUPPER</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#endif
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVUPS</span> <span class="no">X0</span><span class="p">,</span> <span class="mi">112</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="no">X1</span><span class="p">,</span> <span class="mi">128</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="no">X2</span><span class="p">,</span> <span class="mi">144</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="no">X3</span><span class="p">,</span> <span class="mi">160</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="no">X4</span><span class="p">,</span> <span class="mi">176</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="no">X5</span><span class="p">,</span> <span class="mi">192</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="no">X6</span><span class="p">,</span> <span class="mi">208</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="no">X7</span><span class="p">,</span> <span class="mi">224</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="no">X8</span><span class="p">,</span> <span class="mi">240</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="no">X9</span><span class="p">,</span> <span class="mi">256</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="no">X10</span><span class="p">,</span> <span class="mi">272</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="no">X11</span><span class="p">,</span> <span class="mi">288</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="no">X12</span><span class="p">,</span> <span class="mi">304</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="no">X13</span><span class="p">,</span> <span class="mi">320</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="no">X14</span><span class="p">,</span> <span class="mi">336</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="no">X15</span><span class="p">,</span> <span class="mi">352</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">CALL</span> <span class="err">Â·</span><span class="no">asyncPreempt2</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="c1"># è°ƒç”¨asyncPreempt2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ä¸‹æ¬¡goroutineå†åº¦è¢«è¿è¡Œèµ·æ¥æ—¶ï¼Œä»è¿™é‡Œæ¢å¤ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVUPS</span> <span class="mi">352</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">X15</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="mi">336</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">X14</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="mi">320</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">X13</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="mi">304</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">X12</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="mi">288</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">X11</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="mi">272</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">X10</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="mi">256</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">X9</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="mi">240</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">X8</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="mi">224</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">X7</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="mi">208</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">X6</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="mi">192</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">X5</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="mi">176</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">X4</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="mi">160</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">X3</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="mi">144</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">X2</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="mi">128</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">X1</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVUPS</span> <span class="mi">112</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">X0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="mi">104</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">R15</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="mi">96</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">R14</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="mi">88</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">R13</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="mi">80</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">R12</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="mi">72</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">R11</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="mi">64</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">R10</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="mi">56</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">R9</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="mi">48</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">R8</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="mi">40</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DI</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="mi">32</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">SI</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="mi">24</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="mi">16</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="mi">8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ADJSP</span> <span class="no">$-368</span>
</span></span><span class="line"><span class="cl">    <span class="nf">POPFQ</span>
</span></span><span class="line"><span class="cl">    <span class="nf">POPQ</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">RET</span> <span class="c1"># è¿”å›ç»§ç»­å»æ‰§è¡ŒåŸæ¥çš„goroutineä»£ç 
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="asyncpreempt2">asyncPreempt2()<a hidden class="anchor" aria-hidden="true" href="#asyncpreempt2">#</a></h3>
<ol>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/preempt.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">asyncPreempt2</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">asyncSafePoint</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// preemptStop ä¸»è¦åœ¨GCæ ‡è®°æœŸé—´è¢«ç”¨æ¥æŒ‚èµ·è¿è¡Œä¸­çš„ goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">preemptStop</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// preemptParkä¼šæŠŠå½“å‰gåˆ‡æ¢è‡³_GpreemptedçŠ¶æ€ï¼Œç„¶åè°ƒç”¨scheduleå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">mcall</span><span class="p">(</span><span class="nx">preemptPark</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// é€šè¿‡preemptoneå‡½æ•°å‘èµ·çš„å¼‚æ­¥æŠ¢å ä¼šè°ƒç”¨gopreempt_må‡½æ•°ï¼Œå®ƒæœ€ç»ˆä¹Ÿä¼šè°ƒç”¨scheduleå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">mcall</span><span class="p">(</span><span class="nx">gopreempt_m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">asyncSafePoint</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="gopreempt_m-1">gopreempt_m()<a hidden class="anchor" aria-hidden="true" href="#gopreempt_m-1">#</a></h3>
<ol>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">3402
</span><span class="lnt">3403
</span><span class="lnt">3404
</span><span class="lnt">3405
</span><span class="lnt">3406
</span><span class="lnt">3407
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">gopreempt_m</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceGoPreempt</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">goschedImpl</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="goschedimpl">goschedImpl()<a hidden class="anchor" aria-hidden="true" href="#goschedimpl">#</a></h3>
<ol>
<li>GåŠ å…¥å…¨å±€é˜Ÿåˆ—ï¼Œè§£é™¤Gä¸Mçš„å…³ç³»ï¼Œå†æ¬¡å‘èµ·è°ƒåº¦å¾ªç¯ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">3366
</span><span class="lnt">3367
</span><span class="lnt">3368
</span><span class="lnt">3369
</span><span class="lnt">3370
</span><span class="lnt">3371
</span><span class="lnt">3372
</span><span class="lnt">3373
</span><span class="lnt">3374
</span><span class="lnt">3375
</span><span class="lnt">3376
</span><span class="lnt">3377
</span><span class="lnt">3378
</span><span class="lnt">3379
</span><span class="lnt">3380
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">goschedImpl</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">status</span> <span class="o">:=</span> <span class="nf">readgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span> <span class="c1">// è·å–GçŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">status</span><span class="o">&amp;^</span><span class="nx">_Gscan</span> <span class="o">!=</span> <span class="nx">_Grunning</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">dumpgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad g status&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¿®æ”¹GçŠ¶æ€ _Grunnable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">dropg</span><span class="p">()</span> <span class="c1">// è§£é™¤ç»‘å®šå…³ç³»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">globrunqput</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span> <span class="c1">// åŠ å…¥å…¨å±€é“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">schedule</span><span class="p">()</span> <span class="c1">// è°ƒåº¦å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://helium.github.io/tags/golang/">Golang</a></li>
      <li><a href="https://helium.github.io/tags/goroutine/">Goroutine</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://helium.github.io/posts/golang/goroutine/gosched/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>ä¸»åŠ¨è®©å‡ºè°ƒåº¦</span>
  </a>
  <a class="next" href="https://helium.github.io/posts/golang/goroutine/struct/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>runtimeä¸­é‡è¦çš„ç»“æ„ä½“</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
    </span>
    <span id="busuanzi_container_site_uv">
        æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
    </span>
    </div>
        <span>Copyright Â© 2024 èœ€ICPå¤‡2024091074å· <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
