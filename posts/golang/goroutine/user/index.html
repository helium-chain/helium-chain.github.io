<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>user goroutine | Helium</title>
<meta name="keywords" content="golang, Goroutine">
<meta name="description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬">
<meta name="author" content="helium">
<link rel="canonical" href="https://helium-chain.github.io/posts/golang/goroutine/user/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://helium-chain.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://helium-chain.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://helium-chain.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://helium-chain.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://helium-chain.github.io/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://helium-chain.github.io/posts/golang/goroutine/user/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="user goroutine" />
<meta property="og:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://helium-chain.github.io/posts/golang/goroutine/user/" />
<meta property="og:image" content="https://helium-chain.github.io/favicon-32x32.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-07-29T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-07-29T00:00:00+00:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://helium-chain.github.io/favicon-32x32.png" />
<meta name="twitter:title" content="user goroutine"/>
<meta name="twitter:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://helium-chain.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Golang",
      "item": "https://helium-chain.github.io/posts/golang/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ç¬¬12ç«  Goroutine",
      "item": "https://helium-chain.github.io/posts/golang/goroutine/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "user goroutine",
      "item": "https://helium-chain.github.io/posts/golang/goroutine/user/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "user goroutine",
  "name": "user goroutine",
  "description": "ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18+ç‰ˆæœ¬",
  "keywords": [
    "golang", "Goroutine"
  ],
  "articleBody": " æœ¬ç¯‡æ˜¯æ¥ç€ä¸Šä¸€ç¯‡ã€Šgoå…³é”®å­—ã€‹çš„åç»­ï¼Œgoroutineè¿è¡Œå®Œåçš„å›æ”¶é˜¶æ®µã€‚ goexit() goroutineè¿è¡Œç»“æŸåè¿”å›åˆ°goexit+PCQuantumå¤„ã€‚const PCQuantum = 1ã€‚ ä¹Ÿå°±æ˜¯æ¥ç€æ‰§è¡ŒCALL runtimeÂ·goexit1(SB)è¿™æ¡æŒ‡ä»¤ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ 1591 1592 1593 1594 1595 1596 1597 1598 // The top-most function running on a goroutine // returns to goexit+PCQuantum. TEXT runtimeÂ·goexit(SB),NOSPLIT|TOPFRAME,$0-0 BYTE $0x90 // NOP ä»ä¸‹ä¸€æ¡æŒ‡ä»¤å¼€å§‹æ‰§è¡Œ CALL runtimeÂ·goexit1(SB) // è¿™æ¡æŒ‡ä»¤è°ƒç”¨å‡½æ•°å°†æ°¸ä¸è¿”å› // traceback from goexit1 must hit code range of goexit // ä»goexit1å›æº¯å¿…é¡»è¾¾åˆ°goexitçš„ä»£ç èŒƒå›´ BYTE $0x90 // NOP goexit1() goexit1()å‡½æ•°é€šè¿‡è°ƒç”¨mcallä»å½“å‰è¿è¡Œçš„g2 goroutineåˆ‡æ¢åˆ°g0ï¼Œç„¶ååœ¨g0æ ˆä¸Šè°ƒç”¨å’Œæ‰§è¡Œgoexit0()è¿™ä¸ªå‡½æ•°ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/proc.goã€‚ 3468 3469 3470 3471 3472 3473 3474 3475 3476 3477 3478 3479 3480 3481 3482 3483 // Finishes execution of the current goroutine. func goexit1() { if raceenabled { //ä¸ç«æ€æ£€æŸ¥æœ‰å…³ï¼Œä¸å…³æ³¨ racegoend() } if trace.enabled { //ä¸backtraceæœ‰å…³ï¼Œä¸å…³æ³¨ traceGoEnd() } // æ³¨æ„ï¼Œmcallå‡½æ•°çš„å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°goexit0 // Function Value ç»“æ„ // type funcval struct { // fn uintptr // // é—­åŒ…æ•è·çš„å‚æ•°åœ¨è¿™ // } mcall(goexit0) } mcall() å‡½æ•°åŸå‹ï¼šfunc mcall(fn func(*g))ã€‚ runtime.mcall()å‡½æ•°å’Œsystemstack()å‡½æ•°å¾ˆåƒï¼Œä¹Ÿæ˜¯åˆ‡æ¢åˆ°ç³»ç»Ÿæ ˆå»æ‰§è¡ŒæŸä¸ªFunction Valueã€‚ ä½†æ˜¯ä¹Ÿæœ‰äº›ä¸åŒï¼Œmcall()å‡½æ•°ä¸èƒ½åœ¨g0æ ˆä¸Šè°ƒç”¨ï¼Œè€Œä¸”ä¹Ÿä¸ä¼šå†åˆ‡æ¢å›æ¥ã€‚ åˆ‡æ¢åˆ°m.g0æ ˆï¼Œè°ƒç”¨fn(g)ã€‚ Fnå¿…é¡»æ°¸ä¸è¿”å›ã€‚å®ƒåº”è¯¥è°ƒç”¨gogo(\u0026g-\u003esched)æ¥ä¿æŒgçš„è¿è¡Œã€‚è¿™é‡Œçš„gåº”è¯¥æ˜¯g0ã€‚ ä»å½“å‰è¿è¡Œçš„gåˆ‡æ¢åˆ°g0ï¼Œè¿™ä¸€æ­¥åŒ…æ‹¬ä¿å­˜å½“å‰gçš„è°ƒåº¦ä¿¡æ¯ï¼ŒæŠŠg0è®¾ç½®åˆ°tlsä¸­ï¼Œä¿®æ”¹CPUçš„rspå¯„å­˜å™¨ä½¿å…¶æŒ‡å‘g0çš„æ ˆã€‚ ä»¥å½“å‰è¿è¡Œçš„gä¸ºå‚æ•°è°ƒç”¨fnå‡½æ•°(æ­¤å¤„ä¸ºgoexit0)ã€‚ mcallå‡½æ•°ä¸èƒ½åœ¨g0æ ˆä¸Šè°ƒç”¨ï¼Œè€Œä¸”ä¹Ÿä¸ä¼šå†åˆ‡æ¢å›æ¥ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/asm_amd64.sã€‚ 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 # func mcall(fn func(*g)) # Switch to m-\u003eg0's stack, call fn(g). # Fn must never return. It should gogo(\u0026g-\u003esched) # to keep running g. TEXT runtimeÂ·mcall\u003cABIInternal\u003e(SB), NOSPLIT, $0-8 # 1) ä»AXä¸­è·å–å‚æ•°ï¼Œæ³¨æ„è¿™é‡Œè¿˜æ˜¯å†æ™®é€šgoroutineä¸­ä¸æ˜¯g0 # åœ¨go1.17åç‰ˆæœ¬ä¸­é‡‡ç”¨å¯„å­˜å™¨ä¼ å‚ï¼Œå› æ­¤AXä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°å­˜å‚¨çš„æ˜¯macllçš„å‚æ•° # ä¼ å‚é¡ºåº AXã€BXã€CXã€DIã€SIã€R8ã€R9ã€R10ã€R11 MOVQ AX, DX # DX = \u0026funcval; \u0026funcval -\u003e goexit0 # 2) ä¿å­˜çŠ¶æ€åˆ° g-\u003eschedã€‚è¿™é‡Œçš„gæ˜¯å½“å‰æ­£åœ¨è¿è¡Œçš„goroutineã€‚ # save state in g-\u003esched # ä»¥ä¸‹ä¿å­˜å½“å‰çŠ¶æ€åˆ°g-\u003eschedä¸­ï¼Œåœ¨go 1.17ç‰ˆæœ¬åR14å¯„å­˜å™¨å­˜å‚¨çš„æ˜¯å½“å‰å·¥ä½œçº¿ç¨‹è¿è¡Œçš„goroutine # 0(SP)ï¼šå­˜å‚¨çš„æ˜¯goexit1å‡½æ•°è°ƒç”¨mallå‡½æ•°çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ã€‚ä¹Ÿå°±æ˜¯goexit1()å‡½æ•°çš„è¿”å›åœ°å€ MOVQ 0(SP), BX # caller's PC\tmcallè¿”å›åœ°å€æ”¾å…¥BX # g.sched.pc = BX MOVQ BX, (g_sched+gobuf_pc)(R14) # g.sched.pc = BXï¼Œä¿å­˜gçš„rip # fn+0(FP)è¡¨å½“å‰å‚æ•°æ‰€åœ¨æ ˆä½ç½®ï¼Œä¹Ÿå°±æ˜¯goexit1å‡½æ•°çš„SPä½ç½®å¤„ã€‚å› ä¸ºå‚æ•°åœ¨è°ƒç”¨è€…æ ˆä¸Šã€‚ LEAQ fn+0(FP), BX # caller's SP MOVQ BX, (g_sched+gobuf_sp)(R14) # g.sched.sp = BXï¼Œä¿å­˜gçš„rsp # g.sched.bp = BP MOVQ BP, (g_sched+gobuf_bp)(R14) # g.sched.bp = BPï¼Œä¿å­˜gçš„rbp # 3) åˆ‡æ¢åˆ° m-\u003eg0 åŠå…¶å †æ ˆï¼Œè°ƒç”¨fnå‡½æ•°ã€‚ # switch to m-\u003eg0 \u0026 its stack, call fn # # BX = m MOVQ g_m(R14), BX # BX = g.mï¼Œæ‹¿åˆ°å½“å‰å·¥ä½œçº¿ç¨‹M # SI = g0 MOVQ m_g0(BX), SI # SI = g.m.g0ï¼Œé‚£å½“å½“å‰å·¥ä½œçº¿ç¨‹Mçš„g0æ ˆ # æ­¤åˆ»ï¼ŒSI = g0ï¼Œ R14 = gï¼Œæ‰€ä»¥è¿™é‡Œåœ¨åˆ¤æ–­gæ˜¯å¦æ˜¯g0ï¼Œå¦‚æœg == g0åˆ™ä¸€å®šæ˜¯å“ªé‡Œä»£ç å†™é”™äº† CMPQ SI, R14 # if g == m-\u003eg0 call badmcall JNE goodm # SIå’ŒR14ä¸ç›¸ç­‰åˆ™è·³è½¬ JMP runtimeÂ·badmcall(SB) goodm: # æ­£å¸¸æµç¨‹è·³è½¬åˆ°è¿™é‡Œ # AX = g MOVQ R14, AX # AX (and arg 0) = gï¼ŒAX = g2ï¼Œå½“å‰gä¸æ˜¯g0ï¼ŒAXä¹Ÿæ˜¯goexit0å‡½æ•°éœ€è¦çš„å‚æ•° # R14 = g0 MOVQ SI, R14 # g = g.m.g0ï¼ŒR14 = g0ï¼Œè®¾ç½®å½“å‰æ­£åœ¨è¿è¡Œçš„æ˜¯g0 # CX = \u0026m.tls[1] get_tls(CX) # Set G in TLS # TLS = g0 MOVQ R14, g(CX) # sp = g0.sched.sp MOVQ (g_sched+gobuf_sp)(R14), SP # AX = g å…¥æ ˆï¼Œæ­¤æ—¶å·²ç»åœ¨g0çš„æ ˆä¸Šäº† # AXå­˜å‚¨çš„æ—¶æ™®é€šçš„goroutineï¼Œè¿™é‡Œå…¥æ ˆä¹Ÿæ˜¯goexit0()å‡½æ•°çš„å‚æ•° PUSHQ AX # open up space for fn's arg spill slot # R12 = funcval.fn; DX = \u0026funcval MOVQ 0(DX), R12 # fnçš„ç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯goexit0å‡½æ•°ä»£ç åœ°å€å¤„ï¼ŒR12 = fn.fn # è°ƒç”¨goexit0()å‡½æ•°ï¼Œå‚æ•°å†AXå¯„å­˜å™¨ä¸­ï¼Œä¸Šä¸‹æ–‡åœ¨DXå¯„å­˜å™¨ä¸­ã€‚ CALL R12 # è°ƒç”¨ goexit0(g)ï¼Œè¿™é‡Œã€æ°¸ä¸ä¼šè¿”å›ã€‘ POPQ AX JMP\truntimeÂ·badmcall2(SB) RET goexit0() åœ¨g0ä¸Šç»§ç»­æ‰§è¡Œgoexit0()ã€‚å‚æ•°ï¼šgp *gï¼Œå½“å‰è¿è¡Œå®Œçš„æ™®é€šçš„goroutineã€‚ ä»g2æ ˆåˆ‡æ¢åˆ°g0æ ˆä¹‹åï¼Œä¸‹é¢å¼€å§‹åœ¨g0æ ˆæ‰§è¡Œgoexit0()å‡½æ•°ï¼Œè¯¥å‡½æ•°å®Œæˆæœ€åçš„æ¸…ç†å·¥ä½œï¼š æŠŠgçš„çŠ¶æ€ä»_Grunningå˜æ›´ä¸º_Gdeadã€‚ ç„¶åæŠŠgçš„ä¸€äº›å­—æ®µæ¸…ç©ºæˆé›¶å€¼ã€‚ è°ƒç”¨dropgå‡½æ•°è§£é™¤gå’Œmä¹‹é—´çš„å…³ç³»ï¼Œå…¶å®å°±æ˜¯è®¾ç½® g-\u003em = nil,m-\u003ecurrg = nilã€‚ æŠŠgæ”¾å…¥pçš„freegé˜Ÿåˆ—ç¼“å­˜èµ·æ¥ä¾›ä¸‹æ¬¡åˆ›å»ºgæ—¶å¿«é€Ÿè·å–è€Œä¸ç”¨ä»å†…å­˜åˆ†é…ã€‚freegå°±æ˜¯gçš„ä¸€ä¸ªå¯¹è±¡æ± ã€‚ è°ƒç”¨schedule()å‡½æ•°å†æ¬¡è¿›è¡Œè°ƒåº¦ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/runtime/proc.goã€‚ 3479 3480 3481 3482 3483 3484 3485 3486 3487 3488 3489 3490 3491 3492 3493 3494 3495 3496 3497 3498 3499 3500 3501 3502 3503 3504 3505 3506 3507 3508 3509 3510 3511 3512 3513 3514 3515 3516 3517 3518 3519 3520 3521 3522 3523 3524 3525 3526 3527 3528 3529 3530 3531 3532 3533 3534 3535 3536 3537 3538 3539 3540 3541 3542 3543 3544 3545 3546 3547 3548 3549 3550 3551 3552 3553 3554 3555 3556 3557 3558 3559 3560 3561 3562 3563 3564 3565 // goexit continuation on g0. func goexit0(gp *g) { _g_ := getg() // _g_ = g0 _p_ := _g_.m.p.ptr() // _p_ = g0.m.p // _Grunningï¼š2 è¡¨ç¤ºè¿™ä¸ª goroutine å¯ä»¥æ‰§è¡Œç”¨æˆ·ä»£ç ã€‚ å †æ ˆç”±è¿™ä¸ª goroutine æ‹¥æœ‰ã€‚ // å®ƒä¸åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­ã€‚å®ƒè¢«åˆ†é…äº†ä¸€ä¸ª M å’Œä¸€ä¸ª Pï¼ˆg.m å’Œ g.m.p æ˜¯æœ‰æ•ˆçš„ï¼‰ // _Gdeadï¼š6 è¡¨ç¤ºè¿™ä¸ª goroutine å½“å‰æœªè¢«ä½¿ç”¨ï¼Œå®ƒå¯èƒ½åˆšåˆšé€€å‡ºï¼Œåœ¨ç©ºé—²åˆ—è¡¨ä¸­ï¼Œæˆ–è€…åˆšåˆšè¢«åˆå§‹åŒ– casgstatus(gp, _Grunning, _Gdead) // gé©¬ä¸Šé€€å‡ºï¼Œæ‰€ä»¥è®¾ç½®å…¶çŠ¶æ€ä¸º_Gdead gcController.addScannableStack(_p_, -int64(gp.stack.hi-gp.stack.lo)) // å·²åˆ†é…æ ˆæ€»é‡ // sSystemGoroutine æŠ¥å‘Šåœ¨å †æ ˆè½¬å‚¨å’Œæ­»é”æ£€æµ‹å™¨ä¸­æ˜¯å¦å¿…é¡»çœç•¥ goroutine g // è¿™æ˜¯åœ¨ runtime.* å…¥å£ç‚¹å¯åŠ¨çš„ä»»ä½• goroutineï¼Œé™¤äº† runtime.mainã€runtime.handleAsyncEvent // ï¼ˆä»…é™ wasmï¼‰å’Œæœ‰æ—¶ runtime.runfinq // å¦‚æœ fixed ä¸ºçœŸï¼Œä»»ä½•å¯ä»¥åœ¨ç”¨æˆ·å’Œç³»ç»Ÿä¹‹é—´å˜åŒ–çš„ goroutineï¼ˆå³ç»ˆç»“å™¨ goroutineï¼‰éƒ½è¢«è®¤ä¸ºæ˜¯ç”¨æˆ· goroutine if isSystemGoroutine(gp, false) { atomic.Xadd(\u0026sched.ngsys, -1) // sched.ngsys è®°å½•ç³»ç»Ÿgoroutineçš„æ•°é‡ } // æ¸…ç©ºgä¿å­˜çš„ä¸€äº›ä¿¡æ¯ gp.m = nil // lockedm å…³è”åˆ°ä¸å½“å‰Gç»‘å®šçš„Mï¼Œå¯ä»¥å‚è€ƒä¸‹ LockOSThreadã€‚ locked := gp.lockedm != 0 gp.lockedm = 0 _g_.m.lockedg = 0 gp.preemptStop = false gp.paniconfault = false gp._defer = nil // should be true already but just in case. gp._panic = nil // non-nil for Goexit during panic. points at stack-allocated data. gp.writebuf = nil gp.waitreason = 0 gp.param = nil gp.labels = nil gp.timer = nil // gcBlackenEnabledï¼šè¡¨ç¤ºè¾…åŠ©åŠ©æ‰‹å’Œåå°æ ‡è®°çº¿ç¨‹å…è®¸å°†å¯¹è±¡ç½®ä¸ºé»‘è‰²; // gcAssistBytesï¼šè¡¨ç¤ºå½“å‰goroutineè¿˜æœ‰ä¿¡ç”¨å€¼ã€‚ï¼ˆGCç›¸å…³ï¼‰ if gcBlackenEnabled != 0 \u0026\u0026 gp.gcAssistBytes \u003e 0 { // Flush assist credit to the global pool. This gives // better information to pacing if the application is // rapidly creating an exiting goroutines. assistWorkPerByte := gcController.assistWorkPerByte.Load() scanCredit := int64(assistWorkPerByte * float64(gp.gcAssistBytes)) atomic.Xaddint64(\u0026gcController.bgScanCredit, scanCredit) gp.gcAssistBytes = 0 } // g2-\u003em = nil, m-\u003ecurrg = nil è§£ç»‘gå’Œmä¹‹å…³ç³» // m-\u003ecurrgè®°å½•ç€å‰ä¸€ä¸ªgä¿¡æ¯ // func dropg() { // _g_ := getg() // _g_ = g0 // setMNoWB(\u0026_g_.m.curg.m, nil) // g2-\u003em = nil // setGNoWB(\u0026_g_.m.curg, nil) // m-\u003ecurrg = nil // } // // func setMNoWB(mp **m, new *m) { // (*muintptr)(unsafe.Pointer(mp)).set(new) // } dropg() // è§£ç»‘gpçš„må’Œå½“å‰m.currgå€¼ if GOARCH == \"wasm\" { // no threads yet on wasm gfput(_p_, gp) schedule() // never returns } // lockedInt å†…éƒ¨lockOSThreadçš„è·Ÿè¸ª if _g_.m.lockedInt != 0 { print(\"invalid m-\u003elockedInt = \", _g_.m.lockedInt, \"\\n\") throw(\"internal lockOSThread error\") } // go keyword æ–‡æ¡£å…³äº gfput å’Œ gfget å‡½æ•°æ³¨è§£ã€‚ gfput(_p_, gp) // g2æ”¾å…¥pçš„freegé˜Ÿåˆ—ï¼Œæ–¹ä¾¿ä¸‹æ¬¡é‡ç”¨ï¼Œå…å¾—å†å»ç”³è¯·å†…å­˜ï¼Œæé«˜æ•ˆç‡ if locked { // The goroutine may have locked this thread because // it put it in an unusual kernel state. Kill it // rather than returning it to the thread pool. // Return to mstart, which will release the P and exit // the thread. if GOOS != \"plan9\" { // See golang.org/issue/22227. gogo(\u0026_g_.m.g0.sched) } else { // Clear lockedExt on plan9 since we may end up re-using // this thread. _g_.m.lockedExt = 0 } } schedule() // ä¸‹é¢å†æ¬¡è°ƒç”¨schedule } ",
  "wordCount" : "943",
  "inLanguage": "zh",
  "image": "https://helium-chain.github.io/favicon-32x32.png","datePublished": "2024-07-29T00:00:00Z",
  "dateModified": "2024-07-29T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://helium-chain.github.io/posts/golang/goroutine/user/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://helium-chain.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://helium-chain.github.io/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://helium-chain.github.io/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://helium-chain.github.io/" title="ä¸»é¡µ">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://helium-chain.github.io/posts" title="æ–‡ç« ">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://helium-chain.github.io/archives" title="æ—¶é—´è½´">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://helium-chain.github.io/tags/" title="æ ‡ç­¾">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://helium-chain.github.io/search/" title="æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://helium-chain.github.io/support" title="æ‰“èµ">
                    <span>ğŸ«¶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://helium-chain.github.io/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://helium-chain.github.io/posts/">Article</a>&nbsp;Â»&nbsp;<a href="https://helium-chain.github.io/posts/golang/">Golang</a>&nbsp;Â»&nbsp;<a href="https://helium-chain.github.io/posts/golang/goroutine/">ç¬¬12ç«  Goroutine</a></div>
    <h1 class="post-title entry-hint-parent">
      user goroutine
    </h1>
    <div class="post-description">
      ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬
    </div>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2024-07-29</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2024-07-29</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>943å­—</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>5åˆ†é’Ÿ</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &nbsp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://helium-chain.github.io/tags/golang/" target="_blank" rel="noopener">Golang</a>
            <a href="https://helium-chain.github.io/tags/goroutine/" target="_blank" rel="noopener">Goroutine</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &nbsp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#goexit" aria-label="goexit()">goexit()</a></li>
                    <li>
                        <a href="#goexit1" aria-label="goexit1()">goexit1()</a></li>
                    <li>
                        <a href="#mcall" aria-label="mcall()">mcall()</a></li>
                    <li>
                        <a href="#goexit0" aria-label="goexit0()">goexit0()</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><ul>
<li>æœ¬ç¯‡æ˜¯æ¥ç€ä¸Šä¸€ç¯‡ã€Šgoå…³é”®å­—ã€‹çš„åç»­ï¼Œgoroutineè¿è¡Œå®Œåçš„å›æ”¶é˜¶æ®µã€‚</li>
</ul>
<h2 id="goexit">goexit()<a hidden class="anchor" aria-hidden="true" href="#goexit">#</a></h2>
<ol>
<li><code>goroutine</code>è¿è¡Œç»“æŸåè¿”å›åˆ°<code>goexit+PCQuantum</code>å¤„ã€‚<code>const PCQuantum = 1</code>ã€‚</li>
<li>ä¹Ÿå°±æ˜¯æ¥ç€æ‰§è¡Œ<code>CALL runtimeÂ·goexit1(SB)</code>è¿™æ¡æŒ‡ä»¤ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/asm_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1591
</span><span class="lnt">1592
</span><span class="lnt">1593
</span><span class="lnt">1594
</span><span class="lnt">1595
</span><span class="lnt">1596
</span><span class="lnt">1597
</span><span class="lnt">1598
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1">// The top-most function running on a goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1">// returns to goexit+PCQuantum.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">goexit</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="err">|</span><span class="no">TOPFRAME</span><span class="p">,</span><span class="no">$0-0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">BYTE</span>    <span class="no">$0x90</span>               <span class="c1">// NOP ä»ä¸‹ä¸€æ¡æŒ‡ä»¤å¼€å§‹æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">runtime</span><span class="err">Â·</span><span class="no">goexit1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="c1">// è¿™æ¡æŒ‡ä»¤è°ƒç”¨å‡½æ•°å°†æ°¸ä¸è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// traceback from goexit1 must hit code range of goexit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä»goexit1å›æº¯å¿…é¡»è¾¾åˆ°goexitçš„ä»£ç èŒƒå›´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">BYTE</span>    <span class="no">$0x90</span>               <span class="c1">// NOP
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="goexit1">goexit1()<a hidden class="anchor" aria-hidden="true" href="#goexit1">#</a></h2>
<ol>
<li><code>goexit1()</code>å‡½æ•°é€šè¿‡è°ƒç”¨<code>mcall</code>ä»å½“å‰è¿è¡Œçš„<code>g2 goroutine</code>åˆ‡æ¢åˆ°<code>g0</code>ï¼Œç„¶ååœ¨<code>g0</code>æ ˆä¸Šè°ƒç”¨å’Œæ‰§è¡Œ<code>goexit0()</code>è¿™ä¸ªå‡½æ•°ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">3468
</span><span class="lnt">3469
</span><span class="lnt">3470
</span><span class="lnt">3471
</span><span class="lnt">3472
</span><span class="lnt">3473
</span><span class="lnt">3474
</span><span class="lnt">3475
</span><span class="lnt">3476
</span><span class="lnt">3477
</span><span class="lnt">3478
</span><span class="lnt">3479
</span><span class="lnt">3480
</span><span class="lnt">3481
</span><span class="lnt">3482
</span><span class="lnt">3483
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Finishes execution of the current goroutine.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">goexit1</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>    <span class="c1">//ä¸ç«æ€æ£€æŸ¥æœ‰å…³ï¼Œä¸å…³æ³¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">racegoend</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>  <span class="c1">//ä¸backtraceæœ‰å…³ï¼Œä¸å…³æ³¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">traceGoEnd</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ³¨æ„ï¼Œmcallå‡½æ•°çš„å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°goexit0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Function Value ç»“æ„ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// type funcval struct {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      fn uintptr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      // é—­åŒ…æ•è·çš„å‚æ•°åœ¨è¿™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">mcall</span><span class="p">(</span><span class="nx">goexit0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="mcall">mcall()<a hidden class="anchor" aria-hidden="true" href="#mcall">#</a></h2>
<ol>
<li>å‡½æ•°åŸå‹ï¼š<strong><code>func mcall(fn func(*g))</code></strong>ã€‚</li>
<li><code>runtime.mcall()</code>å‡½æ•°å’Œ<code>systemstack()</code>å‡½æ•°å¾ˆåƒï¼Œä¹Ÿæ˜¯åˆ‡æ¢åˆ°ç³»ç»Ÿæ ˆå»æ‰§è¡ŒæŸä¸ª<code>Function Value</code>ã€‚</li>
<li>ä½†æ˜¯ä¹Ÿæœ‰äº›ä¸åŒï¼Œ<code>mcall()</code>å‡½æ•°ä¸èƒ½åœ¨<code>g0</code>æ ˆä¸Šè°ƒç”¨ï¼Œè€Œä¸”ä¹Ÿä¸ä¼šå†åˆ‡æ¢å›æ¥ã€‚</li>
<li>åˆ‡æ¢åˆ°<code>m.g0</code>æ ˆï¼Œè°ƒç”¨<code>fn(g)</code>ã€‚</li>
<li><code>Fn</code>å¿…é¡»æ°¸ä¸è¿”å›ã€‚å®ƒåº”è¯¥è°ƒç”¨<code>gogo(&amp;g-&gt;sched)</code>æ¥ä¿æŒ<code>g</code>çš„è¿è¡Œã€‚è¿™é‡Œçš„<code>g</code>åº”è¯¥æ˜¯<code>g0</code>ã€‚</li>
<li>ä»å½“å‰è¿è¡Œçš„<code>g</code>åˆ‡æ¢åˆ°<code>g0</code>ï¼Œè¿™ä¸€æ­¥åŒ…æ‹¬ä¿å­˜å½“å‰<code>g</code>çš„è°ƒåº¦ä¿¡æ¯ï¼ŒæŠŠ<code>g0</code>è®¾ç½®åˆ°<code>tls</code>ä¸­ï¼Œä¿®æ”¹<code>CPU</code>çš„<code>rsp</code>å¯„å­˜å™¨ä½¿å…¶æŒ‡å‘<code>g0</code>çš„æ ˆã€‚</li>
<li>ä»¥å½“å‰è¿è¡Œçš„<code>g</code>ä¸ºå‚æ•°è°ƒç”¨<code>fn</code>å‡½æ•°(æ­¤å¤„ä¸º<code>goexit0</code>)ã€‚</li>
<li><code>mcall</code>å‡½æ•°ä¸èƒ½åœ¨<code>g0</code>æ ˆä¸Šè°ƒç”¨ï¼Œè€Œä¸”ä¹Ÿä¸ä¼šå†åˆ‡æ¢å›æ¥ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/asm_amd64.s</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1"># func mcall(fn func(*g))
</span></span></span><span class="line"><span class="cl"><span class="c1"># Switch to m-&gt;g0&#39;s stack, call fn(g).
</span></span></span><span class="line"><span class="cl"><span class="c1"># Fn must never return. It should gogo(&amp;g-&gt;sched)
</span></span></span><span class="line"><span class="cl"><span class="c1"># to keep running g.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">mcall</span><span class="err">&lt;</span><span class="no">ABIInternal</span><span class="err">&gt;</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">NOSPLIT</span><span class="p">,</span> <span class="no">$0-8</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 1) ä»AXä¸­è·å–å‚æ•°ï¼Œæ³¨æ„è¿™é‡Œè¿˜æ˜¯å†æ™®é€šgoroutineä¸­ä¸æ˜¯g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1"># åœ¨go1.17åç‰ˆæœ¬ä¸­é‡‡ç”¨å¯„å­˜å™¨ä¼ å‚ï¼Œå› æ­¤AXä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°å­˜å‚¨çš„æ˜¯macllçš„å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä¼ å‚é¡ºåº AXã€BXã€CXã€DIã€SIã€R8ã€R9ã€R10ã€R11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">AX</span><span class="p">,</span> <span class="no">DX</span>  <span class="c1"># DX = &amp;funcval; &amp;funcval -&gt; goexit0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 2) ä¿å­˜çŠ¶æ€åˆ° g-&gt;schedã€‚è¿™é‡Œçš„gæ˜¯å½“å‰æ­£åœ¨è¿è¡Œçš„goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># save state in g-&gt;sched
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># ä»¥ä¸‹ä¿å­˜å½“å‰çŠ¶æ€åˆ°g-&gt;schedä¸­ï¼Œåœ¨go 1.17ç‰ˆæœ¬åR14å¯„å­˜å™¨å­˜å‚¨çš„æ˜¯å½“å‰å·¥ä½œçº¿ç¨‹è¿è¡Œçš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 0(SP)ï¼šå­˜å‚¨çš„æ˜¯goexit1å‡½æ•°è°ƒç”¨mallå‡½æ•°çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ã€‚ä¹Ÿå°±æ˜¯goexit1()å‡½æ•°çš„è¿”å›åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BX</span>                   <span class="c1"># caller&#39;s PC	mcallè¿”å›åœ°å€æ”¾å…¥BX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># g.sched.pc = BX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">BX</span><span class="p">,</span> <span class="p">(</span><span class="no">g_sched</span><span class="err">+</span><span class="no">gobuf_pc</span><span class="p">)(</span><span class="no">R14</span><span class="p">)</span> <span class="c1"># g.sched.pc = BXï¼Œä¿å­˜gçš„rip
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># fn+0(FP)è¡¨å½“å‰å‚æ•°æ‰€åœ¨æ ˆä½ç½®ï¼Œä¹Ÿå°±æ˜¯goexit1å‡½æ•°çš„SPä½ç½®å¤„ã€‚å› ä¸ºå‚æ•°åœ¨è°ƒç”¨è€…æ ˆä¸Šã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">LEAQ</span>    <span class="no">fn</span><span class="err">+</span><span class="mi">0</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">BX</span>                <span class="c1"># caller&#39;s SP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">BX</span><span class="p">,</span> <span class="p">(</span><span class="no">g_sched</span><span class="err">+</span><span class="no">gobuf_sp</span><span class="p">)(</span><span class="no">R14</span><span class="p">)</span> <span class="c1"># g.sched.sp = BXï¼Œä¿å­˜gçš„rsp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># g.sched.bp = BP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">BP</span><span class="p">,</span> <span class="p">(</span><span class="no">g_sched</span><span class="err">+</span><span class="no">gobuf_bp</span><span class="p">)(</span><span class="no">R14</span><span class="p">)</span> <span class="c1"># g.sched.bp = BPï¼Œä¿å­˜gçš„rbp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 3) åˆ‡æ¢åˆ° m-&gt;g0 åŠå…¶å †æ ˆï¼Œè°ƒç”¨fnå‡½æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># switch to m-&gt;g0 &amp; its stack, call fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># BX = m
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">g_m</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">BX</span>    <span class="c1"># BX = g.mï¼Œæ‹¿åˆ°å½“å‰å·¥ä½œçº¿ç¨‹M
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># SI = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">m_g0</span><span class="p">(</span><span class="no">BX</span><span class="p">),</span> <span class="no">SI</span>    <span class="c1"># SI = g.m.g0ï¼Œé‚£å½“å½“å‰å·¥ä½œçº¿ç¨‹Mçš„g0æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># æ­¤åˆ»ï¼ŒSI = g0ï¼Œ R14 = gï¼Œæ‰€ä»¥è¿™é‡Œåœ¨åˆ¤æ–­gæ˜¯å¦æ˜¯g0ï¼Œå¦‚æœg == g0åˆ™ä¸€å®šæ˜¯å“ªé‡Œä»£ç å†™é”™äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CMPQ</span>    <span class="no">SI</span><span class="p">,</span> <span class="no">R14</span>         <span class="c1"># if g == m-&gt;g0 call badmcall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JNE</span> <span class="no">goodm</span> <span class="c1"># SIå’ŒR14ä¸ç›¸ç­‰åˆ™è·³è½¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JMP</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">badmcall</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">goodm:</span>  <span class="c1"># æ­£å¸¸æµç¨‹è·³è½¬åˆ°è¿™é‡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># AX = g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">R14</span><span class="p">,</span> <span class="no">AX</span>     <span class="c1"># AX (and arg 0) = gï¼ŒAX = g2ï¼Œå½“å‰gä¸æ˜¯g0ï¼ŒAXä¹Ÿæ˜¯goexit0å‡½æ•°éœ€è¦çš„å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># R14 = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">SI</span><span class="p">,</span> <span class="no">R14</span>     <span class="c1"># g = g.m.g0ï¼ŒR14 = g0ï¼Œè®¾ç½®å½“å‰æ­£åœ¨è¿è¡Œçš„æ˜¯g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># CX = &amp;m.tls[1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">get_tls</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>         <span class="c1"># Set G in TLS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># TLS = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="no">R14</span><span class="p">,</span> <span class="no">g</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># sp = g0.sched.sp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="p">(</span><span class="no">g_sched</span><span class="err">+</span><span class="no">gobuf_sp</span><span class="p">)(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># AX = g å…¥æ ˆï¼Œæ­¤æ—¶å·²ç»åœ¨g0çš„æ ˆä¸Šäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># AXå­˜å‚¨çš„æ—¶æ™®é€šçš„goroutineï¼Œè¿™é‡Œå…¥æ ˆä¹Ÿæ˜¯goexit0()å‡½æ•°çš„å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">PUSHQ</span>   <span class="no">AX</span>          <span class="c1"># open up space for fn&#39;s arg spill slot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># R12 = funcval.fn; DX = &amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">MOVQ</span>    <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">R12</span>  <span class="c1"># fnçš„ç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯goexit0å‡½æ•°ä»£ç åœ°å€å¤„ï¼ŒR12 = fn.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># è°ƒç”¨goexit0()å‡½æ•°ï¼Œå‚æ•°å†AXå¯„å­˜å™¨ä¸­ï¼Œä¸Šä¸‹æ–‡åœ¨DXå¯„å­˜å™¨ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">CALL</span>    <span class="no">R12</span>         <span class="c1"># è°ƒç”¨ goexit0(g)ï¼Œè¿™é‡Œã€æ°¸ä¸ä¼šè¿”å›ã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">POPQ</span>    <span class="no">AX</span>
</span></span><span class="line"><span class="cl">    <span class="nf">JMP</span>	<span class="no">runtime</span><span class="err">Â·</span><span class="no">badmcall2</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="goexit0">goexit0()<a hidden class="anchor" aria-hidden="true" href="#goexit0">#</a></h2>
<ol>
<li>åœ¨<code>g0</code>ä¸Šç»§ç»­æ‰§è¡Œ<code>goexit0()</code>ã€‚å‚æ•°ï¼š<code>gp *g</code>ï¼Œå½“å‰è¿è¡Œå®Œçš„æ™®é€šçš„<code>goroutine</code>ã€‚</li>
<li>ä»<code>g2</code>æ ˆåˆ‡æ¢åˆ°<code>g0</code>æ ˆä¹‹åï¼Œä¸‹é¢å¼€å§‹åœ¨<code>g0</code>æ ˆæ‰§è¡Œ<code>goexit0()</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°å®Œæˆæœ€åçš„æ¸…ç†å·¥ä½œï¼š
<ol>
<li>æŠŠ<code>g</code>çš„çŠ¶æ€ä»<code>_Grunning</code>å˜æ›´ä¸º<code>_Gdead</code>ã€‚</li>
<li>ç„¶åæŠŠ<code>g</code>çš„ä¸€äº›å­—æ®µæ¸…ç©ºæˆé›¶å€¼ã€‚</li>
<li>è°ƒç”¨<code>dropg</code>å‡½æ•°è§£é™¤<code>g</code>å’Œ<code>m</code>ä¹‹é—´çš„å…³ç³»ï¼Œå…¶å®å°±æ˜¯è®¾ç½® <strong><code>g-&gt;m = nil</code></strong>,<strong><code>m-&gt;currg = nil</code></strong>ã€‚</li>
<li>æŠŠ<code>g</code>æ”¾å…¥<code>p</code>çš„<code>freeg</code>é˜Ÿåˆ—ç¼“å­˜èµ·æ¥ä¾›ä¸‹æ¬¡åˆ›å»º<code>g</code>æ—¶å¿«é€Ÿè·å–è€Œä¸ç”¨ä»å†…å­˜åˆ†é…ã€‚<code>freeg</code>å°±æ˜¯<code>g</code>çš„ä¸€ä¸ªå¯¹è±¡æ± ã€‚</li>
<li>è°ƒç”¨<code>schedule()</code>å‡½æ•°å†æ¬¡è¿›è¡Œè°ƒåº¦ã€‚</li>
</ol>
</li>
<li>æ–‡ä»¶ä½ç½®ï¼š<code>go1.19.3/src/runtime/runtime/proc.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">3479
</span><span class="lnt">3480
</span><span class="lnt">3481
</span><span class="lnt">3482
</span><span class="lnt">3483
</span><span class="lnt">3484
</span><span class="lnt">3485
</span><span class="lnt">3486
</span><span class="lnt">3487
</span><span class="lnt">3488
</span><span class="lnt">3489
</span><span class="lnt">3490
</span><span class="lnt">3491
</span><span class="lnt">3492
</span><span class="lnt">3493
</span><span class="lnt">3494
</span><span class="lnt">3495
</span><span class="lnt">3496
</span><span class="lnt">3497
</span><span class="lnt">3498
</span><span class="lnt">3499
</span><span class="lnt">3500
</span><span class="lnt">3501
</span><span class="lnt">3502
</span><span class="lnt">3503
</span><span class="lnt">3504
</span><span class="lnt">3505
</span><span class="lnt">3506
</span><span class="lnt">3507
</span><span class="lnt">3508
</span><span class="lnt">3509
</span><span class="lnt">3510
</span><span class="lnt">3511
</span><span class="lnt">3512
</span><span class="lnt">3513
</span><span class="lnt">3514
</span><span class="lnt">3515
</span><span class="lnt">3516
</span><span class="lnt">3517
</span><span class="lnt">3518
</span><span class="lnt">3519
</span><span class="lnt">3520
</span><span class="lnt">3521
</span><span class="lnt">3522
</span><span class="lnt">3523
</span><span class="lnt">3524
</span><span class="lnt">3525
</span><span class="lnt">3526
</span><span class="lnt">3527
</span><span class="lnt">3528
</span><span class="lnt">3529
</span><span class="lnt">3530
</span><span class="lnt">3531
</span><span class="lnt">3532
</span><span class="lnt">3533
</span><span class="lnt">3534
</span><span class="lnt">3535
</span><span class="lnt">3536
</span><span class="lnt">3537
</span><span class="lnt">3538
</span><span class="lnt">3539
</span><span class="lnt">3540
</span><span class="lnt">3541
</span><span class="lnt">3542
</span><span class="lnt">3543
</span><span class="lnt">3544
</span><span class="lnt">3545
</span><span class="lnt">3546
</span><span class="lnt">3547
</span><span class="lnt">3548
</span><span class="lnt">3549
</span><span class="lnt">3550
</span><span class="lnt">3551
</span><span class="lnt">3552
</span><span class="lnt">3553
</span><span class="lnt">3554
</span><span class="lnt">3555
</span><span class="lnt">3556
</span><span class="lnt">3557
</span><span class="lnt">3558
</span><span class="lnt">3559
</span><span class="lnt">3560
</span><span class="lnt">3561
</span><span class="lnt">3562
</span><span class="lnt">3563
</span><span class="lnt">3564
</span><span class="lnt">3565
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// goexit continuation on g0.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">goexit0</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>           <span class="c1">// _g_ = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>    <span class="c1">// _p_ = g0.m.p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// _Grunningï¼š2 è¡¨ç¤ºè¿™ä¸ª goroutine å¯ä»¥æ‰§è¡Œç”¨æˆ·ä»£ç ã€‚ å †æ ˆç”±è¿™ä¸ª goroutine æ‹¥æœ‰ã€‚ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å®ƒä¸åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­ã€‚å®ƒè¢«åˆ†é…äº†ä¸€ä¸ª M å’Œä¸€ä¸ª Pï¼ˆg.m å’Œ g.m.p æ˜¯æœ‰æ•ˆçš„ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _Gdeadï¼š6 è¡¨ç¤ºè¿™ä¸ª goroutine å½“å‰æœªè¢«ä½¿ç”¨ï¼Œå®ƒå¯èƒ½åˆšåˆšé€€å‡ºï¼Œåœ¨ç©ºé—²åˆ—è¡¨ä¸­ï¼Œæˆ–è€…åˆšåˆšè¢«åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">,</span> <span class="nx">_Gdead</span><span class="p">)</span> <span class="c1">// gé©¬ä¸Šé€€å‡ºï¼Œæ‰€ä»¥è®¾ç½®å…¶çŠ¶æ€ä¸º_Gdead
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gcController</span><span class="p">.</span><span class="nf">addScannableStack</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="o">-</span><span class="nb">int64</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span><span class="o">-</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span><span class="p">))</span> <span class="c1">// å·²åˆ†é…æ ˆæ€»é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sSystemGoroutine æŠ¥å‘Šåœ¨å †æ ˆè½¬å‚¨å’Œæ­»é”æ£€æµ‹å™¨ä¸­æ˜¯å¦å¿…é¡»çœç•¥ goroutine g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™æ˜¯åœ¨ runtime.* å…¥å£ç‚¹å¯åŠ¨çš„ä»»ä½• goroutineï¼Œé™¤äº† runtime.mainã€runtime.handleAsyncEvent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ï¼ˆä»…é™ wasmï¼‰å’Œæœ‰æ—¶ runtime.runfinq
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœ fixed ä¸ºçœŸï¼Œä»»ä½•å¯ä»¥åœ¨ç”¨æˆ·å’Œç³»ç»Ÿä¹‹é—´å˜åŒ–çš„ goroutineï¼ˆå³ç»ˆç»“å™¨ goroutineï¼‰éƒ½è¢«è®¤ä¸ºæ˜¯ç”¨æˆ· goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">isSystemGoroutine</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">ngsys</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>   <span class="c1">// sched.ngsys è®°å½•ç³»ç»Ÿgoroutineçš„æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// æ¸…ç©ºgä¿å­˜çš„ä¸€äº›ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// lockedm å…³è”åˆ°ä¸å½“å‰Gç»‘å®šçš„Mï¼Œå¯ä»¥å‚è€ƒä¸‹ LockOSThreadã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">locked</span> <span class="o">:=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">lockedm</span> <span class="o">!=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">lockedm</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">lockedg</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">preemptStop</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">paniconfault</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">_defer</span> <span class="p">=</span> <span class="kc">nil</span> <span class="c1">// should be true already but just in case.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span> <span class="p">=</span> <span class="kc">nil</span> <span class="c1">// non-nil for Goexit during panic. points at stack-allocated data.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">writebuf</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">waitreason</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">param</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">labels</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">timer</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// gcBlackenEnabledï¼šè¡¨ç¤ºè¾…åŠ©åŠ©æ‰‹å’Œåå°æ ‡è®°çº¿ç¨‹å…è®¸å°†å¯¹è±¡ç½®ä¸ºé»‘è‰²;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// gcAssistBytesï¼šè¡¨ç¤ºå½“å‰goroutineè¿˜æœ‰ä¿¡ç”¨å€¼ã€‚ï¼ˆGCç›¸å…³ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gcBlackenEnabled</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">gcAssistBytes</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Flush assist credit to the global pool. This gives
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// better information to pacing if the application is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// rapidly creating an exiting goroutines.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">assistWorkPerByte</span> <span class="o">:=</span> <span class="nx">gcController</span><span class="p">.</span><span class="nx">assistWorkPerByte</span><span class="p">.</span><span class="nf">Load</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">scanCredit</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">assistWorkPerByte</span> <span class="o">*</span> <span class="nb">float64</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">gcAssistBytes</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xaddint64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gcController</span><span class="p">.</span><span class="nx">bgScanCredit</span><span class="p">,</span> <span class="nx">scanCredit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span><span class="p">.</span><span class="nx">gcAssistBytes</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// g2-&gt;m = nil, m-&gt;currg = nil è§£ç»‘gå’Œmä¹‹å…³ç³»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// m-&gt;currgè®°å½•ç€å‰ä¸€ä¸ªgä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// func dropg() {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      _g_ := getg()                   // _g_ = g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      setMNoWB(&amp;_g_.m.curg.m, nil)    // g2-&gt;m = nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      setGNoWB(&amp;_g_.m.curg, nil)      // m-&gt;currg = nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// func setMNoWB(mp **m, new *m) {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      (*muintptr)(unsafe.Pointer(mp)).set(new)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">dropg</span><span class="p">()</span> <span class="c1">// è§£ç»‘gpçš„må’Œå½“å‰m.currgå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">GOARCH</span> <span class="o">==</span> <span class="s">&#34;wasm&#34;</span> <span class="p">{</span> <span class="c1">// no threads yet on wasm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">gfput</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">schedule</span><span class="p">()</span> <span class="c1">// never returns
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// lockedInt å†…éƒ¨lockOSThreadçš„è·Ÿè¸ª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">lockedInt</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;invalid m-&gt;lockedInt = &#34;</span><span class="p">,</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">lockedInt</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;internal lockOSThread error&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// go keyword æ–‡æ¡£å…³äº gfput å’Œ gfget å‡½æ•°æ³¨è§£ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">gfput</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">gp</span><span class="p">)</span>  <span class="c1">// g2æ”¾å…¥pçš„freegé˜Ÿåˆ—ï¼Œæ–¹ä¾¿ä¸‹æ¬¡é‡ç”¨ï¼Œå…å¾—å†å»ç”³è¯·å†…å­˜ï¼Œæé«˜æ•ˆç‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">locked</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// The goroutine may have locked this thread because
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// it put it in an unusual kernel state. Kill it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// rather than returning it to the thread pool.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Return to mstart, which will release the P and exit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// the thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">GOOS</span> <span class="o">!=</span> <span class="s">&#34;plan9&#34;</span> <span class="p">{</span> <span class="c1">// See golang.org/issue/22227.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">gogo</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">g0</span><span class="p">.</span><span class="nx">sched</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Clear lockedExt on plan9 since we may end up re-using
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// this thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">lockedExt</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">schedule</span><span class="p">()</span>  <span class="c1">// ä¸‹é¢å†æ¬¡è°ƒç”¨schedule
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://helium-chain.github.io/tags/golang/">Golang</a></li>
      <li><a href="https://helium-chain.github.io/tags/goroutine/">Goroutine</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://helium-chain.github.io/posts/golang/goroutine/newproc/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>go å…³é”®å­—</span>
  </a>
  <a class="next" href="https://helium-chain.github.io/posts/golang/goroutine/main/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>main goroutine</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
    </span>
    <span id="busuanzi_container_site_uv">
        æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
    </span>
    </div>
        <span>Copyright Â© 2024 èœ€ICPå¤‡2024091074å· <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
