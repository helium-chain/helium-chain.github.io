<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>sync.Mutex | Helium</title>
<meta name="keywords" content="golang, sync, Mutex">
<meta name="description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18ç‰ˆæœ¬">
<meta name="author" content="helium">
<link rel="canonical" href="https://heliu.site/posts/golang/sync/mutex/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://heliu.site/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://heliu.site/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://heliu.site/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://heliu.site/apple-touch-icon.png">
<link rel="mask-icon" href="https://heliu.site/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://heliu.site/posts/golang/sync/mutex/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="sync.Mutex" />
<meta property="og:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18ç‰ˆæœ¬" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://heliu.site/posts/golang/sync/mutex/" />
<meta property="og:image" content="https://heliu.site/images/Mutex-cover.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-03-10T17:42:36+08:00" />
<meta property="article:modified_time" content="2023-02-14T00:40:08+08:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://heliu.site/images/Mutex-cover.png" />
<meta name="twitter:title" content="sync.Mutex"/>
<meta name="twitter:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18ç‰ˆæœ¬"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://heliu.site/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "golang åˆé›†",
      "item": "https://heliu.site/posts/golang/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "sync",
      "item": "https://heliu.site/posts/golang/sync/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "sync.Mutex",
      "item": "https://heliu.site/posts/golang/sync/mutex/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "sync.Mutex",
  "name": "sync.Mutex",
  "description": "ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18ç‰ˆæœ¬",
  "keywords": [
    "golang", "sync", "Mutex"
  ],
  "articleBody": "type Mutex struct ğŸš€ åŒ…è¯´æ˜ï¼š\nsync åŒ…æä¾›äº†åŸºæœ¬çš„åŒæ­¥åŸè¯­ï¼Œå¦‚äº’æ–¥é”ã€‚ é™¤äº† Once å’Œ WaitGroup ç±»å‹ä¹‹å¤–ï¼Œå¤§å¤šæ•°éƒ½ä¾›åº•å±‚åº“ä¾‹ç¨‹ä½¿ç”¨ã€‚ æ›´é«˜å±‚æ¬¡çš„åŒæ­¥æœ€å¥½é€šè¿‡ channels å’Œé€šä¿¡æ¥å®Œæˆã€‚ åŒ…å«åœ¨æ­¤åŒ…ä¸­å®šä¹‰çš„ç±»å‹çš„å€¼ä¸åº”è¢«å¤åˆ¶ã€‚ 1 2 3 4 5 6 7 // Package sync provides basic synchronization primitives such as mutual // exclusion locks. Other than the Once and WaitGroup types, most are intended // for use by low-level library routines. Higher-level synchronization is // better done via channels and communication. // // Values containing the types defined in this package should not be copied. package sync Mutex æ˜¯ä¸€æŠŠäº’æ–¥é”ã€‚äº’æ–¥é”çš„é›¶å€¼æ˜¯æœªé”å®šçš„ã€‚ Mutex åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨åä¸èƒ½è¢«å¤åˆ¶ã€‚ åœ¨ Go å†…å­˜æ¨¡å‹çš„æœ¯è¯­ä¸­ï¼Œç¬¬ n æ¬¡è°ƒç”¨ Unlockï¼Œç¬¬ m æ¬¡è°ƒç”¨ Lock åœ¨åŒæ­¥å®Œæˆä»¥å‰ ä»»ä½• n \u003c mã€‚ æˆåŠŸè°ƒç”¨ TryLock ç­‰åŒäºè°ƒç”¨ Lockã€‚è°ƒç”¨ TryLock å¤±è´¥æ ¹æœ¬ä¸ä¼šå»ºç«‹ä»»ä½•å…³ç³» åœ¨åŒæ­¥å®Œæˆä»¥å‰ã€‚ å®ƒæ˜¯ä¸€æŠŠç»“åˆäº†ã€è‡ªæ—‹é”ã€‘å’Œã€ä¿¡å·é‡ã€‘ä¼˜åŒ–è¿‡çš„é”ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // A Mutex is a mutual exclusion lock. // The zero value for a Mutex is an unlocked mutex. // // A Mutex must not be copied after first use. // // In the terminology of the Go memory model, // the n'th call to Unlock â€œsynchronizes beforeâ€ the m'th call to Lock // for any n \u003c m. // A successful call to TryLock is equivalent to a call to Lock. // A failed call to TryLock does not establish any â€œsynchronizes beforeâ€ // relation at all. type Mutex struct { // Mutex çš„çŠ¶æ€ä¿¡æ¯ state int32\t// åˆå§‹æ—¶ä¸º 0 // semaphore ç›¸å…³å­—æ®µï¼Œè¯¥å­—æ®µä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Mutex ä¸è®©æ‹·è´çš„åŸå›  sema uint32 // åˆå§‹æ—¶ä¸º 0 } Mutex çš„å†…å­˜å¸ƒå±€ï¼š Mutex æ˜¯ä¸€ä¸ªäº’æ–¥é”ï¼Œå¯ä»¥åˆ›å»ºä¸ºå…¶ä»–ç»“æ„ä½“çš„å­—æ®µï¼Œé›¶å€¼ä¸ºè§£é”çŠ¶æ€ã€‚ Mutex ç±»å‹çš„é”å’Œçº¿ç¨‹æ— å…³ï¼Œå¯ä»¥ç”±ä¸åŒçš„çº¿ç¨‹åŠ é”å’Œè§£é”ã€‚ Mutex ç»“æ„å¸ƒå±€ï¼š state è®°å½• Mutex çš„ç›¸å…³ä¿¡æ¯ã€‚ sema åœ¨ Mutex ä¸­æ²¡æœ‰ä»»ä½•ä½œç”¨ï¼Œä¸»è¦æ˜¯åœ¨ semaphore ä¸­ï¼Œè¯¥å­—æ®µæ˜¯ Mutex ä¸èƒ½è¢«æ‹·è´çš„æ ¹æœ¬åŸå› ï¼Œåœ¨ semaphore ä¸­ä¸»è¦æ ‡è¯†æœ‰ wakeup å‘ç”Ÿã€‚ ã€æ­£å¸¸æ¨¡å¼ã€‘å’Œã€é¥¥é¥¿æ¨¡å¼ã€‘ï¼š æ­£å¸¸æ¨¡å¼ï¼šä¸€ä¸ªå°è¯•åŠ é”çš„ goroutine ä¼šå…ˆè‡ªæ—‹å‡ æ¬¡ï¼Œå°è¯•é€šè¿‡åŸå­æ“ä½œè·å¾—é”ï¼Œè‹¥å‡ æ¬¡è‡ªæ—‹ä¹‹åä»ä¸èƒ½è·å¾—é”ï¼Œåˆ™é€šè¿‡ä¿¡å·é‡ï¼ˆsemaphoreï¼‰æ’é˜Ÿç­‰å¾…ã€‚æ‰€æœ‰çš„ç­‰å¾…è€…ä¼šæŒ‰ç…§å…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰çš„é¡ºåºæ’é˜Ÿï¼Œä½†æ˜¯å½“ä¸€ä¸ªç­‰å¾…è€…è¢«å”¤é†’åå¹¶ä¸ä¼šç›´æ¥æ‹¥æœ‰é”ï¼Œè€Œæ˜¯éœ€è¦å’Œåæ¥è€…ï¼ˆå¤„äºè‡ªæ—‹é˜¶æ®µï¼Œå°šæœªæ’é˜Ÿç­‰å¾…çš„åç¨‹ï¼‰ç«äº‰ã€‚è¿™ç§æƒ…å†µä¸‹åæ¥è€…æ›´æœ‰ä¼˜åŠ¿ï¼Œä¸€æ–¹é¢åŸå› æ˜¯åæ¥è€…æ­£åœ¨CPUä¸Šè¿è¡Œï¼Œè‡ªç„¶æ¯”åˆšå”¤é†’çš„ goroutine æ›´æœ‰ä¼˜åŠ¿ï¼Œå¦ä¸€æ–¹é¢å¤„äºè‡ªæ—‹çŠ¶æ€çš„ goroutine å¯ä»¥æœ‰å¾ˆå¤šï¼Œè€Œè¢«å”¤é†’çš„ goroutine æ¯æ¬¡åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥è¢«å”¤é†’çš„ goroutine æœ‰å¾ˆå¤§æ¦‚ç‡è·å–ä¸åˆ°é”ï¼Œè¿™ç§æƒ…å†µä¸‹å®ƒä¼šè¢«é‡æ–°æ’å…¥é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œè€Œä¸æ˜¯å°¾éƒ¨ã€‚å½“ä¸€ä¸ª goroutine æœ¬æ¬¡åŠ é”ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº† 1ms åï¼Œå®ƒä¼šæŠŠå½“å‰ Mutex åˆ‡æ¢è‡³é¥¥é¥¿çŠ¶æ€ã€‚ é¥¥é¥¿æ¨¡å¼ï¼šMutex çš„æ‰€æœ‰æƒä»æ‰§è¡Œ Unlock çš„ goroutine ç›´æ¥ä¼ é€’ç»™ç­‰å¾…é˜Ÿåˆ—å¤´éƒ¨çš„ goroutineã€‚åæ¥è€…ä¸ä¼šè‡ªæ—‹ï¼Œä¹Ÿä¸ä¼šå°è¯•è·å¾—é”ï¼Œå®ƒä»¬ä¼šç›´æ¥ä»é˜Ÿåˆ—çš„å°¾éƒ¨æ’é˜Ÿç­‰å¾…ï¼Œå³ä½¿ Mutex å¤„äº Unlocked çŠ¶æ€ã€‚å½“ä¸€ä¸ªç­‰å¾…è€…è·å¾—äº†é”ä¹‹åï¼Œå®ƒä¼šåœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µæ—¶å°† Mutex ç”±é¥¥é¥¿æ¨¡å¼åˆ‡æ¢å›æ­£å¸¸æ¨¡å¼ï¼š(1)å®ƒæ˜¯æœ€åä¸€ä¸ªç­‰å¾…è€…ï¼Œå³ç­‰å¾…é˜Ÿåˆ—ç©ºäº†ã€‚(2)å®ƒçš„ç­‰å¾…æ—¶é—´å°äº1msï¼Œä¹Ÿå°±æ˜¯å®ƒåˆšæ¥ä¸ä¹…ï¼Œåé¢è‡ªç„¶æ›´æ²¡æœ‰é¥¥é¥¿çš„ goroutine äº†ã€‚ æ­£å¸¸æ¨¡å¼ä¸‹ Mutex æœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œä½†æ˜¯é¥¥é¥¿æ¨¡å¼å¯¹äºé˜²æ­¢å°¾ç«¯å»¶é•¿ï¼ˆé˜Ÿåˆ—å°¾ç«¯çš„ goroutine è¿Ÿè¿ŸæŠ¢ä¸åˆ°é”ï¼‰æ¥è®²ç‰¹åˆ«é‡è¦ã€‚ const 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 const ( // æ˜¯å¦ä¸Šé”æ ‡å¿—ä½ï¼›0-æœªä¸Šé”ï¼Œ1-å·²ä¸Šé”ï¼› mutexLocked = 1 \u003c\u003c iota\t// 001 // æ˜¯å¦æœ‰ goroutine ä»é˜»å¡ä¸­è¢«å”¤é†’ï¼›0-æ²¡æœ‰ï¼›1-æœ‰ï¼› // å½“è¯¥æ ‡å¿—ä½è¢«è®¾ç½®æ—¶ï¼ŒUnlock æ“ä½œä¸ä¼šå”¤é†’æ’é˜Ÿçš„ goroutineã€‚ mutexWoken\t// 010 // æ˜¯å¦å¤„äºé¥¥é¥¿æ¨¡å¼ï¼›0-éé¥¥é¥¿ï¼Œ1-é¥¥é¥¿ï¼› mutexStarving\t// 100 // æœ€ä½ä½å­˜åœ¨3ä¸ªbitä½æ ‡è¯†ç‰¹ä¿—ä¿¡æ¯ï¼Œåˆ†åˆ«ä¸ºä¸Šè¿°çš„ mutexLockedã€mutexWokenã€mutexStarving mutexWaiterShift = iota\t// 3 // äº’æ–¥å…¬å¹³ // äº’æ–¥é‡å¯ä»¥æœ‰ä¸¤ç§æ“ä½œæ¨¡å¼:æ­£å¸¸(normal)å’Œé¥¥é¥¿(starvation)ã€‚ // åœ¨æ­£å¸¸æ¨¡å¼(normal mode)ä¸‹ï¼šç­‰å¾…çš„waitersæŒ‰FIFO(å…ˆè¿›å…ˆå‡º)é¡ºåºæ’é˜Ÿï¼Œä½†è¢«å”¤é†’çš„waiterä¸æ‹¥æœ‰äº’æ–¥é”ï¼Œå¹¶ä¸æ–°åˆ°è¾¾çš„goroutinesç«äº‰æ‰€æœ‰æƒã€‚ // æ–°åŠ å…¥çš„goroutinesæœ‰ä¸€ä¸ªä¼˜åŠ¿ï¼Œå®ƒä»¬å·²ç»åœ¨CPUä¸Šè¿è¡Œï¼Œå¹¶ä¸”å¯èƒ½æœ‰å¾ˆå¤šï¼Œæ‰€ä»¥å”¤é†’çš„waiterså¾ˆæœ‰å¯èƒ½ä¼šå¤±è´¥ã€‚ // åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒè¢«é‡æ–°å®‰æ’åœ¨ç­‰å¾…é˜Ÿåˆ—çš„å‰é¢ã€‚å¦‚æœwaiterè¶…è¿‡1msæœªèƒ½è·å–äº’æ–¥é”ï¼Œå®ƒå°†äº’æ–¥é”åˆ‡æ¢åˆ°é¥¥é¥¿æ¨¡å¼ã€‚ // åœ¨é¥¥é¥¿æ¨¡å¼(starvation mode)ä¸‹ï¼šäº’æ–¥é”çš„æ‰€æœ‰æƒç›´æ¥ä»æ­£åœ¨è§£é”çš„goroutineç§»äº¤ç»™é˜Ÿåˆ—å‰é¢çš„waiterã€‚ // æ–°åˆ°è¾¾çš„goroutinesä¸ä¼šå°è¯•è·å–äº’æ–¥é”ï¼Œå³ä½¿å®ƒçœ‹èµ·æ¥å·²ç»è§£é”ï¼Œä¹Ÿä¸ä¼šå°è¯•æ—‹è½¬ã€‚ç›¸åï¼Œå®ƒä»¬æŠŠè‡ªå·±æ’åœ¨ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚ // å¦‚æœä¸€ä¸ªwaiteræ”¶åˆ°äº’æ–¥é”çš„æ‰€æœ‰æƒï¼Œå¹¶ä¸”å‘ç° //\t1) å®ƒæ˜¯é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªwaiterï¼Œæˆ–è€… //\t2) å®ƒç­‰å¾…çš„æ—¶é—´å°‘äº1æ¯«ç§’ï¼Œå®ƒä¼šå°†äº’æ–¥é”åˆ‡æ¢å›æ­£å¸¸å·¥ä½œæ¨¡å¼ã€‚ // æ™®é€šæ¨¡å¼(Normal mode)å…·æœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œå› ä¸ºgoroutineå¯ä»¥è¿ç»­å¤šæ¬¡è·å–äº’æ–¥é‡ï¼Œå³ä½¿æœ‰é˜»å¡çš„ç­‰å¾…ã€‚ // é¥¥é¥¿æ¨¡å¼(Starvation mode)å¯¹äºé¢„é˜²æœ‰äº›gä¸€å€¼è·å–ä¸åˆ°é”çš„å°¾å»¶è¿Ÿå…·æœ‰é‡è¦æ„ä¹‰ã€‚(è¯¥æ¨¡å¼é˜²æ­¢æœ‰äº›å§‹ç»ˆæ‹¿ä¸åˆ°é”çš„ä¸€ç›´ç­‰å¾…åœ¨ä¿¡å·æ± é‡Œé¢çš„goroutine) // æ­£å¸¸æ¨¡å¼ \u003c-\u003e é¥¥é¥¿æ¨¡å¼ ç›¸äº’è½¬æ¢çš„æ—¶é—´é˜€é—¨ // é¥¥é¥¿æ¨¡å¼ï¼Œå½“å‰ä»semaphoreä¸­wakeupçš„goroutineçš„sleepæ—¶é—´è¶…è¿‡1msï¼Œå†æ¬¡è·å–é”å¤±è´¥æ—¶ä¼šè¢«æ ‡è®°ä¸ºé¥¥é¥¿æ¨¡å¼ // é¥¥é¥¿æ¨¡å¼ä¸‹ï¼šstate å€¼çš„ mutexLockedå’ŒmutexWoken ä½å¯èƒ½ä¸º0æˆ–1ï¼Œè¢«å”¤é†’çš„goroutine mutexLockedå’ŒmutexWoken ä½éƒ½ä¸º0 starvationThresholdNs = 1e6\t// sync.Mutex è¿›å…¥é¥¥é¥¿æ¨¡å¼çš„ç­‰å¾…æ—¶é—´é˜ˆå€¼1msã€‚ ) Lock() Lock é”ä½ mã€‚ å¦‚æœé”å·²ç»è¢«ä½¿ç”¨ï¼Œè°ƒç”¨ goroutine ä¼šé˜»å¡ï¼Œç›´åˆ° mutex å¯ç”¨ã€‚ Lock å’Œ Unlock æ˜¯ä¸€å¯¹æ“ä½œã€‚ è¯¥æ–¹æ³•ä¸»è¦é€šè¿‡ atomic å‡½æ•°å®ç°äº†Fast pathï¼Œç›¸åº”çš„Slow pathè¢«å•ç‹¬æ”¾åœ¨äº†lockSlow()æ–¹æ³•ä¸­ã€‚ æ ¹æ®æºç æ³¨é‡Šçš„è¯´æ³•ï¼Œè¿™æ ·æ˜¯ä¸ºäº†ä¾¿äºç¼–è¯‘å™¨å¯¹ Fast path è¿›è¡Œå†…è”ä¼˜åŒ–ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 // Lock locks m. // If the lock is already in use, the calling goroutine // blocks until the mutex is available. func (m *Mutex) Lock() { // 1) ä½¿ç”¨CASå°è¯•è·å–é” // Fast pathæœŸæœ› Mutex å¤„äº Unlocked çŠ¶æ€ï¼Œæ²¡æœ‰ goroutine åœ¨æ’é˜Ÿï¼Œæ›´ä¸ä¼šé¥¥é¥¿ã€‚ // ç†æƒ³çŠ¶æ€ä¸‹ï¼Œä¸€ä¸ªCASæ“ä½œå°±å¯ä»¥è·å¾—é”ã€‚ // Fast path: grab unlocked mutex. // // å¿«é€Ÿè·¯å¾„ï¼šè·å–è§£é”çš„äº’æ–¥é‡ã€‚ // åŸå­æ“ä½œæ¯”è¾ƒ m.state çš„æ—§å€¼ä¸º 0 å¹¶äº¤æ¢æˆæ–°å€¼ 1ï¼ŒæˆåŠŸåˆ™è¡¨ç¤ºè·å–åˆ°é”ã€‚ // è¿™ç§æƒ…å†µå‘ç”Ÿåœ¨ state=0 æ—¶ï¼Œæ²¡æœ‰ç­‰å¾…çš„goroutineã€‚ if atomic.CompareAndSwapInt32(\u0026m.state, 0, mutexLocked) { if race.Enabled { race.Acquire(unsafe.Pointer(m)) } return } // 2) m.state != 0 æ—¶éƒ½ä¼šèµ° Slow path // CAS æ“ä½œæ²¡èƒ½è·å¾—é”ï¼Œå°±éœ€è¦è¿›å…¥ Slow pathäº†ã€‚ // Slow path (outlined so that the fast path can be inlined) // // å¦‚æœä¸Šé¢å¿«é€Ÿæ–¹å¼æ‹¿å–ä¸åˆ°é”ï¼Œåˆ™å»å’Œå…¶ä»–ç«äº‰ã€‚ä¸Šé¢æƒ…å†µæ‹¿ä¸åˆ°é”ï¼Œå¯èƒ½ï¼š // 1. å­˜åœ¨æœ‰å…¶ä»–goroutineæ­£åœ¨æŒæœ‰é”ã€‚ // 2. ä¸å­˜åœ¨å…¶ä»–goroutineæŒæœ‰é”ï¼Œå­˜åœ¨è¢«å”¤é†’çš„goroutineæˆ–è¿˜æœ‰ç­‰å¾…çš„goroutineã€‚ // å½“å‰å¯èƒ½å¤„äºã€æ­£å¸¸æ¨¡å¼ã€‘æˆ–ã€é¥¥é¥¿æ¨¡å¼ã€‘ m.lockSlow() } lockSlow() å¦‚æœè°ƒç”¨è€…æ‹¿å–ä¸åˆ°é”ï¼Œåˆ™ä¸‹é¢æ“ä½œæµç¨‹æ˜¯å…ˆè‡ªæ—‹è¯•å›¾æ‹¿å»é”ï¼Œå®åœ¨æ‹¿å–ä¸åˆ°é”åˆ™è¿›å…¥ä¿¡å·æ± å»ç­‰å¾…æ‹¿å–é”ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 // ç«äº‰è·å–é” // 1. å…ˆè‡ªæ—‹ç­‰å¾…å…¶ä»–goroutineè§£é”ï¼ˆæ»¡è¶³è‡ªæ—‹æ¡ä»¶æ—¶ï¼‰ // 2. å°è¯•ä¿®æ”¹ state å€¼ç«äº‰é” // 3. ç«äº‰æˆåŠŸï¼Œè·å–é”é€€å‡º // 4. ç«äº‰å¤±è´¥ï¼Œsleep goroutine func (m *Mutex) lockSlow() { // 1. å½“å‰goroutineé¦–æ¬¡è¿›å…¥semaphoreæ± sleepçš„æ—¶é—´/çº³ç§’ï¼Œä¸‹æ¬¡wakeupåç”¨äºåˆ¤æ–­ æ­£å¸¸æ¨¡å¼ \u003c-\u003e é¥¥é¥¿æ¨¡å¼ è½¬æ¢ // 2. queueLifo := waitStartTime != 0; è¿›å…¥ semaphore æ± çš„é¦–æˆ–å°¾ï¼Œfalse.å°¾ true.é¦– var waitStartTime int64\t// mutexæ¨¡å¼ ã€false.æ­£å¸¸æ¨¡å¼ã€‘ ã€true.é¥¥é¥¿æ¨¡å¼ã€‘ // 1. æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œæ–°æ¥è·å–é”çš„goroutineå¦‚æœæ»¡è¶³æ¡ä»¶ä¼šè¿›è¡Œè‡ªæ—‹ç­‰å¾…é”è¢«é‡Šæ”¾ï¼Œå¦‚æœè¿˜æ‹¿å–ä¸åˆ°é”åˆ™å»ä¿¡å·æ± æœ€å‰é¢ç­‰å¾…ã€‚ // 2. é¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œæ–°æ¥è·å–é”çš„goroutineä¸ä¼šè¿›è¡Œè‡ªæ—‹ï¼Œç›´æ¥å»ä¿¡å·æ± çš„æœ«å°¾å»ç­‰å¾…ã€‚ starving := false\t// æ˜¯å¦æœ‰goroutineè¢«å”¤é†’ false.æ²¡æœ‰ // æœ‰è¢«å”¤é†’çš„goroutineæ—¶ï¼Œä¼šè¯•å›¾å»æ‹¿å»é”ï¼Œå¯èƒ½æ˜¯è·Ÿå½“å‰æ­£åœ¨è·å–é”çš„goroutineç«äº‰ // 1. åœ¨è‡ªæ—‹æƒ…å†µä¸‹æ»¡è¶³æ¡ä»¶è®¾ç½® awoke ä¸º true // 2. éé¥¥é¥¿æ¨¡å¼ä¸‹è¢«å”¤é†’çš„goroutine awoke ä¼šè¢«è®¾ç½®ä¸º true // 3. åœ¨é¥¥é¥¿æ¨¡å¼ä¸‹ awoke å˜é‡æ²¡æœ‰ç”¨ awoke := false\t// ç”¨äºåŸå­è®¾ç½® mutexWoken ä½ï¼Œé€šçŸ¥ Unlock å‡½æ•°æœ‰ woken çš„goroutineäº†ï¼Œä¸è¦å»wakeup goroutine // è®°å½•æ—‹è½¬çš„æ¬¡æ•°ï¼Œå½“æ²¡æœ‰è·å–é”æ—¶ï¼Œä¼šå°è¯•4æ¬¡å»è‡ªæ—‹è·å– iter := 0\t// è‡ªæ—‹è®¡æ•°å™¨\t// ä»¥ä¸‹ä»£ç éƒ½æ˜¯ä» old -\u003e new çš„åŸå­æ“ä½œï¼Œå»å°è¯•ä¿®æ”¹ state å€¼ old := m.state\t// æ—§å€¼state // è¯¥å¾ªç¯åªæœ‰åœ¨è·å–åˆ°é”çš„æ—¶å€™æ‰ä¼šé€€å‡ºï¼Œå› æ­¤æ‰€æœ‰æœªè·å–åˆ°é”çš„goroutineéƒ½å°†åœ¨è¿™é‡Œç­‰å¾…è·å–é” for { // 1) é¥¥é¥¿æ¨¡å¼ä¸‹ä¸è¦è‡ªæ—‹ï¼Œå› ä¸ºæ‰€æœ‰æƒæŒ‰ç…§é¡ºåºä¼ é€’ï¼Œè‡ªæ—‹æ²¡æœ‰æ„ä¹‰ã€‚ // æ­£å¸¸æ¨¡å¼ä¸‹é”æ²¡æœ‰è¢«é‡Šæ”¾æ»¡è¶³è‡ªæ—‹æ¡ä»¶éœ€è¦è‡ªæ—‹ã€‚ // Don't spin in starvation mode, ownership is handed off to waiters // so we won't be able to acquire the mutex anyway. // // ä¸è¦åœ¨é¥¥é¥¿æ¨¡å¼ä¸‹æ—‹è½¬ï¼Œæ‰€æœ‰æƒå·²ç§»äº¤ç»™waitersï¼Œå› æ­¤æˆ‘ä»¬æ— è®ºå¦‚ä½•éƒ½æ— æ³•è·å¾—äº’æ–¥é” // 1. old\u0026(mutexLocked|mutexStarving) == mutexLocked; Mutexæ²¡æœ‰å¤„äºé¥¥é¥¿æ¨¡å¼å¹¶ä¸”å·²è¢«é”å®šã€‚ // 2. runtime_canSpin(iter); æŠ¥å‘Šå½“å‰æ—‹è½¬è¦æ±‚æ¡ä»¶ã€‚ //\tä¸»åŠ¨æ—‹è½¬æ¡ä»¶ï¼š //\tæ—‹è½¬æ¬¡æ•°å°äº4æ¬¡ å¹¶ä¸” å¤šæ ¸CPUè¿è¡Œ å¹¶ä¸”é™¤äº†å½“å‰Pè¿˜æœ‰å…¶ä»–Pæ­£åœ¨è¿è¡Œï¼ˆä¸æ˜¯ç©ºé—²æˆ–è‡ªæ—‹çŠ¶æ€çš„Pï¼‰å¹¶ä¸” å½“å‰Pæ²¡æœ‰å…¶ä»–gäº† //\tè¿™ç§æƒ…å†µéœ€è¦å»å°è¯•è‡ªæ—‹è·å–ä¸‹é”ï¼Œå…¶ä»–æƒ…å†µåˆ™ä¸éœ€è¦è‡ªæ—‹å»è·å–é” // ä»¥ä¸‹è‡ªæ—‹çš„æ„ä¹‰ï¼Œåœç•™ç‰‡åˆ»ç­‰å¾…å…¶ä»–goroutineè®©å‡ºé”ï¼Œç„¶åæ ‡è®°mutexWokenå­˜åœ¨è¢«å”¤é†’çš„goroutineä½¿è‡ªå·±è·å–é”ä¼˜å…ˆçº§æ›´é«˜ if old\u0026(mutexLocked|mutexStarving) == mutexLocked \u0026\u0026 runtime_canSpin(iter) {\t// è‡ªæ—‹åœ¨è¿™é‡Œ // Active spinning makes sense. // Try to set mutexWoken flag to inform Unlock // to not wake other blocked goroutines. // // ä¸»åŠ¨æ—‹è½¬æ˜¯æœ‰é“ç†çš„ã€‚ // å°è¯•è®¾ç½® mutexflag æ¥é€šçŸ¥ Unlock ä¸è¦å”¤é†’å…¶ä»–è¢«é˜»å¡åœ¨ä¿¡å·æ± çš„goroutinesã€‚ // ä»¥ä¸‹é€»è¾‘æ˜¯å¤„äºè‡ªæ—‹ï¼Œè‡ªæ—‹çš„æ„ä¹‰åœ¨äºæ ‡è®°æœ‰æ­£åœ¨è¢«å”¤é†’çš„goroutineï¼Œå…¶ä»–çº¿ç¨‹ä¸è¦å†æ¬¡å”¤é†’å¯¼è‡´è¿‡å¤šgoroutineè¢«å”¤é†’ // // 1. !awoke; ï¼šæ²¡æœ‰æ ‡è®°å½“å‰goroutineè¢«å”¤é†’ // 2. old\u0026mutexWoken == 0; ï¼šæ²¡æœ‰è¢«å”¤é†’çš„goroutineï¼ŒåŒ…æ‹¬å…¶ä»–gå’Œå½“å‰g // 3. old\u003e\u003emutexWaiterShift != 0; ï¼šå­˜åœ¨ç­‰å¾…æ’é˜Ÿåœ¨ä¿¡å·æ± çš„goroutine // 4. atomic.CompareAndSwapInt32(\u0026m.state, old, old|mutexWoken); //\tè®¾ç½®æ ‡å¿—æœ‰goroutineè¢«å”¤é†’ï¼Œè¿™é‡Œè®¾ç½®æˆåŠŸé‚£unlockåˆ™ä¸ä¼šå†å»å”¤é†’goroutine if !awoke \u0026\u0026 old\u0026mutexWoken == 0 \u0026\u0026 old\u003e\u003emutexWaiterShift != 0 \u0026\u0026 atomic.CompareAndSwapInt32(\u0026m.state, old, old|mutexWoken) { // æ ‡è®°ä¸ºå”¤é†’çŠ¶æ€ï¼Œä¸»è¦æ˜¯å‘Šè¯‰unlockä¸è¦å†å»å”¤é†’goroutineäº†ï¼Œè¿™é‡Œæœ‰è‡ªæ—‹çš„åœ¨ç­‰å¾… awoke = true } // çŸ­æš‚å»¶è¿Ÿä¸€æ®µæ—¶é—´ï¼Œä¸»è¦æ˜¯ç­‰å¾…å…¶ä»–gè§£é” // å¦‚æœæ­¤æ—¶Unlockäº†ç¬¬ä¸€ä¸ªifåˆ™ä¸ä¼šå†åˆ¤æ–­ä¸ºtrueï¼Œç›´æ¥å»äº‰æŠ¢é”äº† runtime_doSpin()\titer++ old = m.state\t// ä»æ–°èµ‹å€¼ç»™old continue } // 2) é”å¯èƒ½å·²è¢«é‡Šæ”¾å°è¯•ç«äº‰è·å–ï¼Œæˆ–é”è¿˜æœªè§£é™¤å»sleepã€‚ // ä»£ç æ‰§è¡Œåˆ°è¿™é‡Œï¼Œåªå¯èƒ½å¤„äºä»¥ä¸‹å‡ ç§æƒ…å†µ // 1. è‡ªæ—‹æ¬¡æ•°ä»¥å®Œï¼ŒçŠ¶æ€ä¾ç„¶æ˜¯ mutexLockedã€‚ // 2. çŠ¶æ€æ˜¯ mutexStarving å¤„äºé¥¥é¥¿çŠ¶æ€ã€‚ // 3. çŠ¶æ€æ˜¯æœªåŠ é”çŠ¶æ€ï¼Œé”å·²è¢«è§£é™¤ã€‚ // ï¼ˆå¤„äºé¥¥é¥¿æ¨¡å¼ï¼‰ æˆ– ï¼ˆè‡ªæ—‹æ¬¡æ•°è¶…è¿‡4æ¬¡ï¼‰ æˆ– ï¼ˆå½“å‰å…¶ä»–goroutineå·²Unlockï¼‰æˆ– ï¼ˆä¸æ»¡è¶³è‡ªæ—‹æ¡ä»¶ï¼‰ //\tå¦‚æœé”å·²Unlockï¼Œé‚£ä¹ˆå°è¯•å»è·å–é”ï¼›å¦‚æœé”å¤„äºLockï¼Œé‚£ä¹ˆä¹Ÿå°è¯•è·å–ï¼Œå¦åˆ™åŠ å…¥åˆ°ä¿¡å·æ± ä¸­ç­‰å¾… // old æ˜¯æœ¬è½®åŸå­æ“ä½œçš„ state å€¼ // new æ˜¯æœ¬è½®éœ€è¦äº‰æŠ¢é”ä¿®æ”¹åçš„ state å€¼ // æ­£å¸¸æ¨¡å¼ä¸‹: // 1. åœ¨oldæœªæŒæœ‰é”æƒ…å†µä¸‹ï¼Œè°å…ˆåŸå­æ“ä½œä» old ä¿®æ”¹ä¸º new è°å°±å…ˆè·å–åˆ°é” // 2. åœ¨oldæŒæœ‰é”æƒ…å†µä¸‹ï¼Œå½“å‰goroutineéœ€è¦sleep new := old // 2.1) æ­£å¸¸æ¨¡å¼ä¸‹éœ€è¦äº‰æŠ¢é”ï¼Œå› æ­¤éœ€è¦è®¾ç½®mutexLockedçŠ¶æ€ // Don't try to acquire starving mutex, new arriving goroutines must queue. // // ä¸è¦å°è¯•è·å–å¤„äºé¥¥é¥¿çš„Mutexï¼Œåæ¥çš„goroutineså¿…é¡»æ’é˜Ÿã€‚ // // å¤„äºé¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œä¸ºä»€ä¹ˆä¸éœ€è¦è®¾ç½®mutexLockedæ ‡å¿—å‘¢ï¼Ÿ // 1. å¤„äºé¥¥é¥¿æ¨¡å¼ä¸‹é”çš„æŒæœ‰æƒæ˜¯æ‰‹æŠŠæ‰‹äº¤ç»™åé¢ç­‰å¾…çš„goroutineï¼Œå› æ­¤mutexLockedæ ‡å¿—è®¾ç½®ä¸è®¾ç½®ä¸é‡è¦ // 2. å¯¹äºæ–°æ¥çš„goroutineï¼ŒmutexLockedä½å¯èƒ½ä¸º0æˆ–1ï¼Œä½†æ˜¯å½“å‰goroutineä¸ä¼šå»æŒ£æŠ¢é”ç›´æ¥sleepï¼Œå› æ­¤mutexLockedä½ä¸é‡è¦ // 3. å¯¹äºä»sleepä¸­wakeupçš„goroutineï¼Œä¸€å®šæ˜¯æ¥è‡ªUnlockå‡½æ•°è€Œæ¥è‡ªè¯¥å‡½æ•°mutexLockedä½ä¸€å®šæ˜¯0ï¼Œå·²è¢«è§£é” if old\u0026mutexStarving == 0 {\t// å¤„äºæ­£å¸¸æ¨¡å¼ // newè¡¨ç¤ºæ–°å€¼ä¿®æ”¹çš„çŠ¶æ€ mutexLockedéœ€è¦é”ï¼Œä¸ç®¡å½“å‰æ˜¯Lockæˆ–Unlockå½“å‰éƒ½éœ€è¦è®¾ç½®mutexLockedè¡¨ç¤ºéœ€è¦å»äº‰æŠ¢é” new |= mutexLocked\t} // 2.2) é”è¿˜æœªè¢«é‡Šæ”¾ æˆ– å¤„äºé¥¥é¥¿æ¨¡å¼ä¸‹ è¿™ä¸¤ç§æƒ…å†µä¸‹éƒ½ä¼šå»sleepï¼Œå› æ­¤éœ€è¦åŠ ä¸€ã€‚ // å¦‚æœoldé”æ²¡é‡Šæ”¾ æˆ– å¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œé‚£ä¹ˆå½“å‰çš„goroutineåˆ™æ˜¯éœ€è¦è¢«åŠ å…¥åˆ°ä¿¡å·æ± é‡Œé¢å»çš„ if old\u0026(mutexLocked|mutexStarving) != 0 {\t// å¤„äºLockæˆ–åˆ™é¥¥é¥¿æ¨¡å¼å½“å‰géœ€è¦åŠ å…¥åˆ°ä¿¡å·æ±  new += 1 \u003c\u003c mutexWaiterShift\t// æ•°é‡å¢åŠ 1 } // 2.3) å½“å‰ goroutine å°† mutex åˆ‡æ¢è‡³é¥¥é¥¿æ¨¡å¼ // å¦‚æœ mutex å·²ç»å¤„äº unlocked çŠ¶æ€ï¼Œå°±ä¸è¦åˆ‡æ¢äº†ï¼Œ // å› ä¸º Unlock() å‡½æ•°è®¤ä¸ºå¤„äºé¥¥é¥¿æ¨¡å¼çš„ mutex ç­‰å¾…é˜Ÿåˆ—ä¸ä¸ºç©ºã€‚ // The current goroutine switches mutex to starvation mode. // But if the mutex is currently unlocked, don't do the switch. // Unlock expects that starving mutex has waiters, which will not // be true in this case. // // å½“å‰çš„ goroutine å°†äº’æ–¥é”åˆ‡æ¢åˆ°é¥¥é¥¿æ¨¡å¼ï¼Œä½†å¦‚æœäº’æ–¥é”å½“å‰å·²è§£é”ï¼Œå°±ä¸è¦åˆ‡æ¢ã€‚ // UnlockæœŸæœ›å¤„äºé¥¥é¥¿çŠ¶æ€çš„äº’æ–¥é”æœ‰waitersï¼Œä½†åœ¨æœ¬ä¾‹ä¸­å¹¶éå¦‚æ­¤ã€‚ // // starving=true å‘ç”Ÿåœ¨ï¼šè¿™ä¸ªgoroutineè¢«åŠ å…¥åˆ°ä¿¡å·æ± åå†åº¦è¢«å”¤é†’å»äº‰æŠ¢é”æ—¶ï¼Œå‘ç°ç­‰å¾…æ—¶é—´å·²ç»è¶…è¿‡1msæ—¶ // old\u0026mutexLocked != 0ï¼Œè¡¨ç¤ºè¿™ä¸ªè¢«å”¤é†’çš„goroutineå†æ¬¡äº‰æŠ¢é”æ—¶é”æ²¡è¢«å…¶ä»–gorutineé‡Šæ”¾ï¼Œè¿™æ¬¡å†äº‰æŠ¢å°†å¤±è´¥åˆ™ä¼šæ ‡è®°æˆé¥¥é¥¿æ¨¡å¼ if starving \u0026\u0026 old\u0026mutexLocked != 0 {\t// è¿™ç§æƒ…å†µä¸‹å½“å‰goroutineåŸºæœ¬æ‹¿å»ä¸åˆ°é” new |= mutexStarving // æ ‡è®°æˆé¥¥é¥¿æ¨¡å¼æ—¶ï¼Œé”ä¸€å®šè¢«å…¶ä»–æŒæœ‰ï¼›ä½†æ˜¯å”¤é†’çš„gå¤„äºé¥¥é¥¿æ¨¡å¼æ—¶ï¼Œé”ä¸€å®šæ˜¯UnlockçŠ¶æ€ } // 2.4) å½“å‰goroutineæ˜¯è¢«å”¤é†’çš„ï¼Œæ£€æŸ¥å¹¶æ¸…é™¤æ ‡å¿—ä½ // awoke=true è¡¨ç¤ºæ¥è‡ªè‡ªæ—‹æˆ–è¢«å”¤é†’çš„goroutineä¸¤ç§å½¢å¼ // 1. è‡ªæ—‹çŠ¶æ€ä¸‹ awoke=trueï¼Œstate ä¸­ mutexWoken ä½å·²è¢«è®¾ç½®ä¸º 1 // 2. è¢«å”¤é†’çš„goroutineä¸‹ awoke=true åœ¨æœ¬å‡½æ•°çš„å”¤é†’åè¢«è®¾ç½®ï¼Œè€Œ state ä¸­ mutexWoken ä½åœ¨Unlockå‡½æ•°ä¸­è¢«è®¾ç½® // å› æ­¤ awoke=true å°±ä¸€å®šå­˜åœ¨ state ä¸­ mutexWoken ä½ä¸º1ï¼Œnew\u0026mutexWoken != 0æˆç«‹ if awoke {\t// awokeæœ‰ç­‰å¾…çš„goroutineè¢«å”¤é†’ // The goroutine has been woken from sleep, // so we need to reset the flag in either case. // // goroutine å·²ç»ä»ç¡çœ ä¸­å”¤é†’ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ä»»ä½•ä¸€ç§æƒ…å†µä¸‹é‡ç½®æ ‡å¿— if new\u0026mutexWoken == 0 {\t// ä¸è®ºæ¥è‡ªè‡ªæ—‹æˆ–è¢«å”¤é†’çš„goroutineè¿™é‡Œéƒ½ä¸èƒ½ä¸º0ï¼Œæ­£å¸¸çŠ¶å†µä¸‹ throw(\"sync: inconsistent mutex state\") } new \u0026^= mutexWoken // æ¸…é™¤è¢«å”¤é†’æ ‡å¿—ä½mutexWokenï¼Œå› ä¸ºä¸‹é¢å³å°†å»äº‰æŠ¢é”ï¼Œæˆ–è€…è½½å…¥å»ä¿¡å·æ± ç­‰å¾… } // å°è¯•ä½¿ç”¨åŸå­ä¿®æ”¹stateï¼Œæ‰€æœ‰çš„goroutineéƒ½ä¼šé€šè¿‡è¯¥æ¡ä»¶ï¼Œä½†æ˜¯ä¸€è½®åªèƒ½æˆåŠŸä¸€ä¸ª // è¿™é‡Œä¿®æ”¹m.stateæˆåŠŸäº†ï¼Œå¹¶ä¸ä»£è¡¨ä¸€å®šè·å–åˆ°äº†é”ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å½“å‰géœ€è¦åŠ å…¥åˆ°ä¿¡å·æ± ä¸­å» if atomic.CompareAndSwapInt32(\u0026m.state, old, new) {\t// å¦‚æœä¸Šä¸€ä¸ªæ‹¿å»åˆ°é”çš„stateæ˜¯æ­£å¸¸æ¨¡å¼å¹¶æ²¡æœ‰é”ï¼Œåˆ™è¿™é‡Œç›´æ¥é€€å‡ºï¼Œè¿™é‡Œè¡¨ç¤ºå½“å‰goroutineè·å–åˆ°äº†é”ï¼Œæ­£å¸¸æ¨¡å¼éƒ½æ˜¯ä»è¿™é‡Œé€€å‡ºçš„ // æ­£å¸¸æ¨¡å¼ä¸‹è·å–åˆ°é”çš„æƒ…å†µï¼Œè¿™é‡Œä¸ä¼šå‡ºç°æ ‡è®°æˆé¥¥é¥¿æ¨¡å¼ä½†è¿™é‡Œåˆåˆ¤æ–­ä¸ºtrueé€€å‡ºäº†çš„æƒ…å†µï¼ŒåŸå› æ˜¯æ ‡è®°æˆé¥¥é¥¿æ¨¡å¼çš„å‰ç½®æ¡ä»¶æ˜¯å½“å‰oldæ˜¯Lock if old\u0026(mutexLocked|mutexStarving) == 0 {\t// è°å…ˆæ‹¿åˆ°é”é€€å‡ºï¼Œæ¥åˆ°æ‰§è¡Œgoroutineåé¢ä»£ç  break // locked the mutex with CAS } // åé¢å¤„ç†é€»è¾‘æ˜¯ä¹‹å‰æœ‰é”ï¼Œè¿™ä¸ªgoroutineéœ€è¦å»æ’é˜Ÿæƒ…å†µï¼Œæˆ–å½“å‰æ¨¡å¼å¤„äºé¥¥é¥¿æ¨¡å¼ï¼Œç›´æ¥æŠŠè¯¥goroutineåŠ å…¥åˆ°å°¾éƒ¨ // If we were already waiting before, queue at the front of the queue. // // å¦‚æœæˆ‘ä»¬ä¹‹å‰å·²ç»åœ¨ç­‰å¾…ï¼Œè¯·åœ¨é˜Ÿåˆ—çš„å‰é¢æ’é˜Ÿ // waitStartTimeå¦‚æœä¸ç­‰äº0è¯´æ˜å…ˆå‰å…¥é˜Ÿè¿‡æœ‰è¢«å”¤é†’è¿‡ï¼Œæ­£å¸¸ç¬¬ä¸€æ¬¡å…¥é˜Ÿè¿™é‡Œæ˜¯false // è¢«å”¤é†’ä¹‹åæ²¡æœ‰æŠ¢åˆ°é”ï¼Œéœ€è¦æ’å…¥é˜Ÿåˆ—å¤´éƒ¨ï¼Œè€Œä¸æ˜¯å°¾éƒ¨ã€‚ queueLifo := waitStartTime != 0 // é¦–æ¬¡è¿›å…¥ä¿¡å·æ± å»ç­‰å¾…æ—¶ if waitStartTime == 0 {\t// è¿™é‡Œè¡¨ç¤ºè¿™ä¸ªgoroutineä»ä¿¡å·æ± ä¸­ç¬¬ä¸€æ¬¡è¢«å”¤é†’ä¾ç„¶æ²¡æœ‰è·å–åˆ°é”ï¼Œä»æ–°è®¾ç½®æ—¶é—´ waitStartTime = runtime_nanotime()\t// æ³¨æ„ï¼šé™¤ç¬¬ä¸€æ¬¡å…¥é˜Ÿååé¢æ¯æ¬¡ç¼“å­˜waitStartTimeæ—¶é—´éƒ½ä¸ä¼šè¢«åˆ·æ–° } // è¿™é‡Œå­˜åœ¨è¢«å”¤é†’ä½†æ˜¯è¿˜æ˜¯æ²¡æ‹¿åˆ°é”çš„æƒ…å†µä¼šå†æ¬¡è¢«å…¥é˜Ÿ // runtime_SemacquireMutexçš„queueLifoå‚æ•°ä¸ºtrueåˆ™æ˜¯æ’å…¥çš„ä¿¡å·æ± å¤´éƒ¨ï¼Œfalseæ’å…¥åˆ°å°¾éƒ¨ //\té¦–æ¬¡è¿›å…¥ä¿¡å·æ± ï¼Œåˆ™ç›´æ¥æ’åœ¨å°¾éƒ¨ //\tä»ä¿¡å·æ± ä¸­å‡ºæ¥åˆäº‰æŠ¢å¤±è´¥è¿›å…¥ä¿¡å·æ± æ’åœ¨å¤´éƒ¨ // å¦‚æˆ‘ä»¬å–å‡ºgorutineåˆ™æ˜¯ä»å¤´éƒ¨å¼€å§‹å¾€åå–ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„å…ˆè¿›å…ˆå‡º // å› ä¸ºç¬¬ä¸€æ¬¡åŠ å…¥ä¿¡å·æ± çš„éƒ½æ˜¯æ’å…¥åˆ°å°¾éƒ¨ï¼Œå½“å†è¢«å”¤é†’ä¾ç„¶æ²¡æœ‰è·å–åˆ°é”æ—¶ï¼Œåˆ™æ˜¯è¢«æ”¾å›åˆ°å¤´éƒ¨ // å½“å‰goroutineå»æ’é˜Ÿï¼Œè¿™é‡Œå½“å‰groutineè¢«è°ƒç¦»å·¥ä½œçº¿ç¨‹ç­‰å¾…æŠ¢åˆ°é”åç»§ç»­åé¢æ‰§è¡Œ runtime_SemacquireMutex(\u0026m.sema, queueLifo, 1)\t// è¢«å”¤é†’çš„gï¼Œæ¥åˆ°ä»è¿™é‡Œæ‰§è¡Œå°è¯•å»è·å–é”ï¼›å¯èƒ½å½“å‰å¤„äºé¥¥é¥¿æ¨¡å¼æˆ–å¤„äºæ­£å¸¸æ¨¡å¼ï¼Œå”¤é†’gçš„ç›¸å…³ä»£ç ä½äºUnlockå‡½æ•° // å¦‚æœç­‰å¾…çš„æ—¶é—´å¤§äº1msåˆ™æ ‡è®°æˆé¥¥é¥¿æ¨¡å¼ï¼Œä»¥ä¸‹é€»è¾‘æ˜¯å½“å‰goroutineè¢«å”¤é†’åå†æ¬¡å°è¯•è·å–é” // ç­‰å¾…æ—¶é—´è¶…è¿‡äº†1msï¼Œç­‰å¾…æ—¶é—´å¤ªä¹…éœ€è¦è¢«æ ‡è®°ä¸ºé¥¥é¥¿çŠ¶æ€ starving = starving || runtime_nanotime()-waitStartTime \u003e starvationThresholdNs old = m.state\t// è·å–å½“å‰çš„çŠ¶æ€ // å¦‚æœå¤„äºé¥¥é¥¿æ¨¡å¼ï¼Œå¤„äºé¥¥é¥¿æ¨¡å¼ä¸‹å”¤é†’çš„goroutineç«‹å³è·å–é”ï¼Œå› ä¸ºæ­£å¸¸æ¥æŠ¢çš„goroutineéƒ½ä¼šè¢«å…¥é˜Ÿï¼Œ // ç„¶åä¸€ä¸ªä¸ªæ¥è·å– // æ‰€æœ‰é¥¥é¥¿æ¨¡å¼ä¸‹è·å–é”çš„å‡ºå£éƒ½åœ¨è¿™é‡Œï¼Œè¯¥æ¡ä»¶æ»¡è¶³è¯´æ˜å½“å‰goroutineè·å–åˆ°é”æŒæœ‰æƒ if old\u0026mutexStarving != 0 {\t// If this goroutine was woken and mutex is in starvation mode, // ownership was handed off to us but mutex is in somewhat // inconsistent state: mutexLocked is not set and we are still // accounted as waiter. Fix that. // // å½“å‰ä»£ç ä½ç½®çš„ goroutine è‚¯å®šæ˜¯è¢«å”¤é†’çš„ï¼Œè€Œä¸” Mutex å¤„äºé¥¥é¥¿æ¨¡å¼ // æ‰€æœ‰æƒè¢«ç›´æ¥äº¤ç»™å½“å‰ goroutine // ä½†æ˜¯è¿™ç§æƒ…å†µä¸‹ mutex çš„ state ä¼šä¸å®é™…æƒ…å†µä¸ä¸€è‡´ // mutexLocked æ ‡å¿—ä½æ²¡æœ‰è®¾ç½® // è€Œä¸”ç­‰å¾…è€…è®¡æ•°ä¸­ä¹Ÿæ²¡æœ‰å‡å»å½“å‰ goroutineã€‚éœ€è¦ä¿®å¤ state // æ³¨æ„é¥¥é¥¿æ¨¡å¼ä¸‹ä¼ é€’ mutex æ‰€æœ‰æƒä¸ä¼šè®¾ç½® mutexWoken æ ‡å¿—ï¼Œåªæœ‰æ­£å¸¸æ¨¡å¼ä¸‹å”¤é†’æ‰ä¼š // // é¥¥é¥¿æ¨¡å¼ä¸‹ old\u003e\u003emutexWaiterShift != 0ï¼Œå½“å‰ä¸€å®šä¸èƒ½æ˜¯æœ€åä¸€ä¸ªï¼Œ // å› ä¸ºä¸‹é¢ old\u003e\u003emutexWaiterShift == 1 ä¼šé€€å‡ºé¥¥é¥¿æ¨¡å¼ // old\u0026(mutexLocked|mutexWoken) != 0 å› ä¸ºå¤„äºé¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰çš„goroutineéƒ½ä¼šå»æ’é˜Ÿsleepï¼Œ // è¢«wakeupçš„goroutineä¸€å®šæ¥è‡ªUnlockå‡½æ•°ï¼Œ // æ­¤æ—¶mutexLockedä¸€å®šè§£é”ï¼ŒmutexWokenä¸€å®šæ˜¯è¢«æ¸…é™¤çš„ if old\u0026(mutexLocked|mutexWoken) != 0 || old\u003e\u003emutexWaiterShift == 0 { // é¥¥é¥¿æ¨¡å¼ä¸‹ï¼ŒmutexLockedå’ŒmutexWokenå¿…å®šä¸º0ï¼Œå‚çœ‹ä¸Šé¢ä»£ç ã€‚ throw(\"sync: inconsistent mutex state\") } // +mutexLocked -1\u003c",
  "wordCount" : "3402",
  "inLanguage": "zh",
  "image":"https://heliu.site/images/Mutex-cover.png","datePublished": "2020-03-10T17:42:36+08:00",
  "dateModified": "2023-02-14T00:40:08+08:00",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://heliu.site/posts/golang/sync/mutex/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://heliu.site/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://heliu.site/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://heliu.site/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://heliu.site/" title="ä¸»é¡µ">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/posts" title="æ–‡ç« ">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/archives" title="æ—¶é—´è½´">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/tags/" title="æ ‡ç­¾">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/search/" title="æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/support" title="æ‰“èµ">
                    <span>ğŸ«¶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://heliu.site/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/">Article</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/golang/">golang åˆé›†</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/golang/sync/">sync</a></div>
    <h1 class="post-title entry-hint-parent">
      sync.Mutex
    </h1>
    <div class="post-description">
      ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18ç‰ˆæœ¬
    </div>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2020-03-10</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2023-02-14</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>3402å­—</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>16åˆ†é’Ÿ</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &ensp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://heliu.site/tags/golang/" target="_blank" rel="noopener">Golang</a>
            <a href="https://heliu.site/tags/sync/" target="_blank" rel="noopener">Sync</a>
            <a href="https://heliu.site/tags/mutex/" target="_blank" rel="noopener">Mutex</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &ensp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> 
<figure class="entry-cover1">
        <img loading="eager" srcset="https://heliu.site/posts/golang/sync/mutex/images/Mutex-cover_huc2ccb710628246fc3a8289f0c5ffc978_48767_360x0_resize_box_3.png 360w ,https://heliu.site/posts/golang/sync/mutex/images/Mutex-cover_huc2ccb710628246fc3a8289f0c5ffc978_48767_480x0_resize_box_3.png 480w ,https://heliu.site/posts/golang/sync/mutex/images/Mutex-cover_huc2ccb710628246fc3a8289f0c5ffc978_48767_720x0_resize_box_3.png 720w ,https://heliu.site/posts/golang/sync/mutex/images/Mutex-cover.png 800w" 
            sizes="(min-width: 768px) 720px, 100vw" src="https://heliu.site/posts/golang/sync/mutex/images/Mutex-cover.png" alt="" 
            width="800" height="600">
        
</figure><aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#type-mutex-struct-" aria-label="type Mutex struct ğŸš€">type Mutex struct ğŸš€</a><ul>
                            
                    <li>
                        <a href="#const" aria-label="const">const</a></li>
                    <li>
                        <a href="#lock" aria-label="Lock()">Lock()</a><ul>
                            
                    <li>
                        <a href="#lockslow" aria-label="lockSlow()">lockSlow()</a></li>
                    <li>
                        <a href="#sync_runtime_canspin" aria-label="sync_runtime_canSpin()">sync_runtime_canSpin()</a></li>
                    <li>
                        <a href="#sync_runtime_dospin" aria-label="sync_runtime_doSpin()">sync_runtime_doSpin()</a></li>
                    <li>
                        <a href="#procyield" aria-label="procyield()">procyield()</a></li></ul>
                    </li>
                    <li>
                        <a href="#unlock" aria-label="Unlock()">Unlock()</a><ul>
                            
                    <li>
                        <a href="#unlockslow" aria-label="unlockSlow()">unlockSlow()</a></li></ul>
                    </li>
                    <li>
                        <a href="#trylock" aria-label="TryLock()">TryLock()</a></li></ul>
                    </li>
                    <li>
                        <a href="#type-locker-interface" aria-label="type Locker interface">type Locker interface</a></li>
                    <li>
                        <a href="#%e4%bd%bf%e7%94%a8%e7%a4%ba%e4%be%8b" aria-label="ä½¿ç”¨ç¤ºä¾‹">ä½¿ç”¨ç¤ºä¾‹</a><ul>
                            
                    <li>
                        <a href="#syncmutex" aria-label="sync.Mutex">sync.Mutex</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9" aria-label="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><h2 id="type-mutex-struct-">type Mutex struct ğŸš€<a hidden class="anchor" aria-hidden="true" href="#type-mutex-struct-">#</a></h2>
<p>åŒ…è¯´æ˜ï¼š</p>
<ol>
<li>sync åŒ…æä¾›äº†åŸºæœ¬çš„<strong>åŒæ­¥åŸè¯­</strong>ï¼Œå¦‚äº’æ–¥é”ã€‚</li>
<li>é™¤äº† Once å’Œ WaitGroup ç±»å‹ä¹‹å¤–ï¼Œå¤§å¤šæ•°éƒ½ä¾›åº•å±‚åº“ä¾‹ç¨‹ä½¿ç”¨ã€‚</li>
<li>æ›´é«˜å±‚æ¬¡çš„åŒæ­¥æœ€å¥½é€šè¿‡ channels å’Œé€šä¿¡æ¥å®Œæˆã€‚</li>
<li>åŒ…å«åœ¨æ­¤åŒ…ä¸­å®šä¹‰çš„ç±»å‹çš„å€¼<strong>ä¸åº”è¢«å¤åˆ¶</strong>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Package sync provides basic synchronization primitives such as mutual
</span></span></span><span class="line"><span class="cl"><span class="c1">// exclusion locks. Other than the Once and WaitGroup types, most are intended
</span></span></span><span class="line"><span class="cl"><span class="c1">// for use by low-level library routines. Higher-level synchronization is
</span></span></span><span class="line"><span class="cl"><span class="c1">// better done via channels and communication.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Values containing the types defined in this package should not be copied.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kn">package</span> <span class="nx">sync</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<ol>
<li>Mutex æ˜¯ä¸€æŠŠäº’æ–¥é”ã€‚äº’æ–¥é”çš„é›¶å€¼æ˜¯æœªé”å®šçš„ã€‚</li>
<li>Mutex åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨åä¸èƒ½è¢«å¤åˆ¶ã€‚</li>
<li>åœ¨ Go å†…å­˜æ¨¡å‹çš„æœ¯è¯­ä¸­ï¼Œç¬¬ n æ¬¡è°ƒç”¨ Unlockï¼Œç¬¬ m æ¬¡è°ƒç”¨ Lock åœ¨åŒæ­¥å®Œæˆä»¥å‰ ä»»ä½• n &lt; mã€‚</li>
<li>æˆåŠŸè°ƒç”¨ TryLock ç­‰åŒäºè°ƒç”¨ Lockã€‚è°ƒç”¨ TryLock å¤±è´¥æ ¹æœ¬ä¸ä¼šå»ºç«‹ä»»ä½•å…³ç³» åœ¨åŒæ­¥å®Œæˆä»¥å‰ã€‚</li>
<li>å®ƒæ˜¯ä¸€æŠŠç»“åˆäº†ã€è‡ªæ—‹é”ã€‘å’Œã€ä¿¡å·é‡ã€‘ä¼˜åŒ–è¿‡çš„é”ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// A Mutex is a mutual exclusion lock.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The zero value for a Mutex is an unlocked mutex.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// A Mutex must not be copied after first use.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// In the terminology of the Go memory model,
</span></span></span><span class="line"><span class="cl"><span class="c1">// the n&#39;th call to Unlock â€œsynchronizes beforeâ€ the m&#39;th call to Lock
</span></span></span><span class="line"><span class="cl"><span class="c1">// for any n &lt; m.
</span></span></span><span class="line"><span class="cl"><span class="c1">// A successful call to TryLock is equivalent to a call to Lock.
</span></span></span><span class="line"><span class="cl"><span class="c1">// A failed call to TryLock does not establish any â€œsynchronizes beforeâ€
</span></span></span><span class="line"><span class="cl"><span class="c1">// relation at all.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Mutex</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Mutex çš„çŠ¶æ€ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">state</span> <span class="kt">int32</span>	<span class="c1">// åˆå§‹æ—¶ä¸º 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// semaphore ç›¸å…³å­—æ®µï¼Œè¯¥å­—æ®µä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Mutex ä¸è®©æ‹·è´çš„åŸå› 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sema</span>  <span class="kt">uint32</span> <span class="c1">// åˆå§‹æ—¶ä¸º 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="images/Mutex-001.png" alt=""  />
</p>


<p><details >
  <summary markdown="span">Mutex çš„å†…å­˜å¸ƒå±€ï¼š</summary>
  <blockquote>
<ol>
<li>Mutex æ˜¯ä¸€ä¸ªäº’æ–¥é”ï¼Œå¯ä»¥åˆ›å»ºä¸ºå…¶ä»–ç»“æ„ä½“çš„å­—æ®µï¼Œé›¶å€¼ä¸ºè§£é”çŠ¶æ€ã€‚</li>
<li>Mutex ç±»å‹çš„é”å’Œçº¿ç¨‹æ— å…³ï¼Œå¯ä»¥ç”±ä¸åŒçš„çº¿ç¨‹åŠ é”å’Œè§£é”ã€‚</li>
<li><strong>Mutex</strong> ç»“æ„å¸ƒå±€ï¼š
<ul>
<li><strong>state</strong> è®°å½• Mutex çš„ç›¸å…³ä¿¡æ¯ã€‚</li>
<li><strong>sema</strong> åœ¨ Mutex ä¸­æ²¡æœ‰ä»»ä½•ä½œç”¨ï¼Œä¸»è¦æ˜¯åœ¨ semaphore ä¸­ï¼Œè¯¥å­—æ®µæ˜¯ Mutex ä¸èƒ½è¢«æ‹·è´çš„æ ¹æœ¬åŸå› ï¼Œåœ¨ semaphore ä¸­ä¸»è¦æ ‡è¯†æœ‰ wakeup å‘ç”Ÿã€‚</li>
</ul>
</li>
</ol>
</blockquote>

</details></p>



<p><details >
  <summary markdown="span">ã€<strong>æ­£å¸¸æ¨¡å¼</strong>ã€‘å’Œã€<strong>é¥¥é¥¿æ¨¡å¼</strong>ã€‘ï¼š</summary>
  <blockquote>
<ol>
<li><strong>æ­£å¸¸æ¨¡å¼</strong>ï¼šä¸€ä¸ªå°è¯•åŠ é”çš„ goroutine ä¼šå…ˆè‡ªæ—‹å‡ æ¬¡ï¼Œå°è¯•é€šè¿‡åŸå­æ“ä½œè·å¾—é”ï¼Œè‹¥å‡ æ¬¡è‡ªæ—‹ä¹‹åä»ä¸èƒ½è·å¾—é”ï¼Œåˆ™é€šè¿‡ä¿¡å·é‡ï¼ˆsemaphoreï¼‰æ’é˜Ÿç­‰å¾…ã€‚æ‰€æœ‰çš„ç­‰å¾…è€…ä¼šæŒ‰ç…§å…ˆå…¥å…ˆå‡ºï¼ˆFIFOï¼‰çš„é¡ºåºæ’é˜Ÿï¼Œä½†æ˜¯å½“ä¸€ä¸ªç­‰å¾…è€…è¢«å”¤é†’åå¹¶ä¸ä¼šç›´æ¥æ‹¥æœ‰é”ï¼Œè€Œæ˜¯éœ€è¦å’Œåæ¥è€…ï¼ˆå¤„äºè‡ªæ—‹é˜¶æ®µï¼Œå°šæœªæ’é˜Ÿç­‰å¾…çš„åç¨‹ï¼‰ç«äº‰ã€‚è¿™ç§æƒ…å†µä¸‹åæ¥è€…æ›´æœ‰ä¼˜åŠ¿ï¼Œä¸€æ–¹é¢åŸå› æ˜¯åæ¥è€…æ­£åœ¨CPUä¸Šè¿è¡Œï¼Œè‡ªç„¶æ¯”åˆšå”¤é†’çš„ goroutine æ›´æœ‰ä¼˜åŠ¿ï¼Œå¦ä¸€æ–¹é¢å¤„äºè‡ªæ—‹çŠ¶æ€çš„ goroutine å¯ä»¥æœ‰å¾ˆå¤šï¼Œè€Œè¢«å”¤é†’çš„ goroutine æ¯æ¬¡åªæœ‰ä¸€ä¸ªï¼Œæ‰€ä»¥è¢«å”¤é†’çš„ goroutine æœ‰å¾ˆå¤§æ¦‚ç‡è·å–ä¸åˆ°é”ï¼Œè¿™ç§æƒ…å†µä¸‹å®ƒä¼šè¢«é‡æ–°æ’å…¥é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œè€Œä¸æ˜¯å°¾éƒ¨ã€‚å½“ä¸€ä¸ª goroutine æœ¬æ¬¡åŠ é”ç­‰å¾…çš„æ—¶é—´è¶…è¿‡äº† 1ms åï¼Œå®ƒä¼šæŠŠå½“å‰ Mutex åˆ‡æ¢è‡³é¥¥é¥¿çŠ¶æ€ã€‚</li>
<li><strong>é¥¥é¥¿æ¨¡å¼</strong>ï¼šMutex çš„æ‰€æœ‰æƒä»æ‰§è¡Œ Unlock çš„ goroutine ç›´æ¥ä¼ é€’ç»™ç­‰å¾…é˜Ÿåˆ—å¤´éƒ¨çš„ goroutineã€‚åæ¥è€…ä¸ä¼šè‡ªæ—‹ï¼Œä¹Ÿä¸ä¼šå°è¯•è·å¾—é”ï¼Œå®ƒä»¬ä¼šç›´æ¥ä»é˜Ÿåˆ—çš„å°¾éƒ¨æ’é˜Ÿç­‰å¾…ï¼Œå³ä½¿ Mutex å¤„äº Unlocked çŠ¶æ€ã€‚å½“ä¸€ä¸ªç­‰å¾…è€…è·å¾—äº†é”ä¹‹åï¼Œå®ƒä¼šåœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µæ—¶å°† Mutex ç”±é¥¥é¥¿æ¨¡å¼åˆ‡æ¢å›æ­£å¸¸æ¨¡å¼ï¼š(1)å®ƒæ˜¯æœ€åä¸€ä¸ªç­‰å¾…è€…ï¼Œå³ç­‰å¾…é˜Ÿåˆ—ç©ºäº†ã€‚(2)å®ƒçš„ç­‰å¾…æ—¶é—´å°äº1msï¼Œä¹Ÿå°±æ˜¯å®ƒåˆšæ¥ä¸ä¹…ï¼Œåé¢è‡ªç„¶æ›´æ²¡æœ‰é¥¥é¥¿çš„ goroutine äº†ã€‚</li>
</ol>
<ul>
<li>æ­£å¸¸æ¨¡å¼ä¸‹ Mutex æœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œä½†æ˜¯é¥¥é¥¿æ¨¡å¼å¯¹äºé˜²æ­¢å°¾ç«¯å»¶é•¿ï¼ˆé˜Ÿåˆ—å°¾ç«¯çš„ goroutine è¿Ÿè¿ŸæŠ¢ä¸åˆ°é”ï¼‰æ¥è®²ç‰¹åˆ«é‡è¦ã€‚</li>
</ul>
</blockquote>

</details></p>

<h3 id="const">const<a hidden class="anchor" aria-hidden="true" href="#const">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ˜¯å¦ä¸Šé”æ ‡å¿—ä½ï¼›0-æœªä¸Šé”ï¼Œ1-å·²ä¸Šé”ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mutexLocked</span> <span class="p">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="kc">iota</span>	   <span class="c1">// 001
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ˜¯å¦æœ‰ goroutine ä»é˜»å¡ä¸­è¢«å”¤é†’ï¼›0-æ²¡æœ‰ï¼›1-æœ‰ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“è¯¥æ ‡å¿—ä½è¢«è®¾ç½®æ—¶ï¼ŒUnlock æ“ä½œä¸ä¼šå”¤é†’æ’é˜Ÿçš„ goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mutexWoken</span>				   <span class="c1">// 010
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ˜¯å¦å¤„äºé¥¥é¥¿æ¨¡å¼ï¼›0-éé¥¥é¥¿ï¼Œ1-é¥¥é¥¿ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mutexStarving</span>			   <span class="c1">// 100
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æœ€ä½ä½å­˜åœ¨3ä¸ªbitä½æ ‡è¯†ç‰¹ä¿—ä¿¡æ¯ï¼Œåˆ†åˆ«ä¸ºä¸Šè¿°çš„ mutexLockedã€mutexWokenã€mutexStarving
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mutexWaiterShift</span> <span class="p">=</span> <span class="kc">iota</span>		<span class="c1">// 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// äº’æ–¥å…¬å¹³
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// äº’æ–¥é‡å¯ä»¥æœ‰ä¸¤ç§æ“ä½œæ¨¡å¼:æ­£å¸¸(normal)å’Œé¥¥é¥¿(starvation)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨æ­£å¸¸æ¨¡å¼(normal mode)ä¸‹ï¼šç­‰å¾…çš„waitersæŒ‰FIFO(å…ˆè¿›å…ˆå‡º)é¡ºåºæ’é˜Ÿï¼Œä½†è¢«å”¤é†’çš„waiterä¸æ‹¥æœ‰äº’æ–¥é”ï¼Œå¹¶ä¸æ–°åˆ°è¾¾çš„goroutinesç«äº‰æ‰€æœ‰æƒã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 		æ–°åŠ å…¥çš„goroutinesæœ‰ä¸€ä¸ªä¼˜åŠ¿ï¼Œå®ƒä»¬å·²ç»åœ¨CPUä¸Šè¿è¡Œï¼Œå¹¶ä¸”å¯èƒ½æœ‰å¾ˆå¤šï¼Œæ‰€ä»¥å”¤é†’çš„waiterså¾ˆæœ‰å¯èƒ½ä¼šå¤±è´¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 		åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒè¢«é‡æ–°å®‰æ’åœ¨ç­‰å¾…é˜Ÿåˆ—çš„å‰é¢ã€‚å¦‚æœwaiterè¶…è¿‡1msæœªèƒ½è·å–äº’æ–¥é”ï¼Œå®ƒå°†äº’æ–¥é”åˆ‡æ¢åˆ°é¥¥é¥¿æ¨¡å¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨é¥¥é¥¿æ¨¡å¼(starvation mode)ä¸‹ï¼šäº’æ–¥é”çš„æ‰€æœ‰æƒç›´æ¥ä»æ­£åœ¨è§£é”çš„goroutineç§»äº¤ç»™é˜Ÿåˆ—å‰é¢çš„waiterã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 		æ–°åˆ°è¾¾çš„goroutinesä¸ä¼šå°è¯•è·å–äº’æ–¥é”ï¼Œå³ä½¿å®ƒçœ‹èµ·æ¥å·²ç»è§£é”ï¼Œä¹Ÿä¸ä¼šå°è¯•æ—‹è½¬ã€‚ç›¸åï¼Œå®ƒä»¬æŠŠè‡ªå·±æ’åœ¨ç­‰å¾…é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœä¸€ä¸ªwaiteræ”¶åˆ°äº’æ–¥é”çš„æ‰€æœ‰æƒï¼Œå¹¶ä¸”å‘ç°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//		1) å®ƒæ˜¯é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªwaiterï¼Œæˆ–è€… 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//		2) å®ƒç­‰å¾…çš„æ—¶é—´å°‘äº1æ¯«ç§’ï¼Œå®ƒä¼šå°†äº’æ–¥é”åˆ‡æ¢å›æ­£å¸¸å·¥ä½œæ¨¡å¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ™®é€šæ¨¡å¼(Normal mode)å…·æœ‰æ›´å¥½çš„æ€§èƒ½ï¼Œå› ä¸ºgoroutineå¯ä»¥è¿ç»­å¤šæ¬¡è·å–äº’æ–¥é‡ï¼Œå³ä½¿æœ‰é˜»å¡çš„ç­‰å¾…ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é¥¥é¥¿æ¨¡å¼(Starvation mode)å¯¹äºé¢„é˜²æœ‰äº›gä¸€å€¼è·å–ä¸åˆ°é”çš„å°¾å»¶è¿Ÿå…·æœ‰é‡è¦æ„ä¹‰ã€‚(è¯¥æ¨¡å¼é˜²æ­¢æœ‰äº›å§‹ç»ˆæ‹¿ä¸åˆ°é”çš„ä¸€ç›´ç­‰å¾…åœ¨ä¿¡å·æ± é‡Œé¢çš„goroutine)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// æ­£å¸¸æ¨¡å¼ &lt;-&gt; é¥¥é¥¿æ¨¡å¼ ç›¸äº’è½¬æ¢çš„æ—¶é—´é˜€é—¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é¥¥é¥¿æ¨¡å¼ï¼Œå½“å‰ä»semaphoreä¸­wakeupçš„goroutineçš„sleepæ—¶é—´è¶…è¿‡1msï¼Œå†æ¬¡è·å–é”å¤±è´¥æ—¶ä¼šè¢«æ ‡è®°ä¸ºé¥¥é¥¿æ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é¥¥é¥¿æ¨¡å¼ä¸‹ï¼šstate å€¼çš„ mutexLockedå’ŒmutexWoken ä½å¯èƒ½ä¸º0æˆ–1ï¼Œè¢«å”¤é†’çš„goroutine mutexLockedå’ŒmutexWoken ä½éƒ½ä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">starvationThresholdNs</span> <span class="p">=</span> <span class="mf">1e6</span>	<span class="c1">// sync.Mutex è¿›å…¥é¥¥é¥¿æ¨¡å¼çš„ç­‰å¾…æ—¶é—´é˜ˆå€¼1msã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="lock">Lock()<a hidden class="anchor" aria-hidden="true" href="#lock">#</a></h3>
<ol>
<li>Lock é”ä½ mã€‚</li>
<li>å¦‚æœé”å·²ç»è¢«ä½¿ç”¨ï¼Œè°ƒç”¨ goroutine ä¼šé˜»å¡ï¼Œç›´åˆ° mutex å¯ç”¨ã€‚</li>
<li>Lock å’Œ Unlock æ˜¯ä¸€å¯¹æ“ä½œã€‚</li>
<li>è¯¥æ–¹æ³•ä¸»è¦é€šè¿‡ atomic å‡½æ•°å®ç°äº†Fast pathï¼Œç›¸åº”çš„Slow pathè¢«å•ç‹¬æ”¾åœ¨äº†lockSlow()æ–¹æ³•ä¸­ã€‚</li>
<li>æ ¹æ®æºç æ³¨é‡Šçš„è¯´æ³•ï¼Œè¿™æ ·æ˜¯ä¸ºäº†ä¾¿äºç¼–è¯‘å™¨å¯¹ Fast path è¿›è¡Œå†…è”ä¼˜åŒ–ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Lock locks m.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If the lock is already in use, the calling goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1">// blocks until the mutex is available.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Mutex</span><span class="p">)</span> <span class="nf">Lock</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) ä½¿ç”¨CASå°è¯•è·å–é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Fast pathæœŸæœ› Mutex å¤„äº Unlocked çŠ¶æ€ï¼Œæ²¡æœ‰ goroutine åœ¨æ’é˜Ÿï¼Œæ›´ä¸ä¼šé¥¥é¥¿ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç†æƒ³çŠ¶æ€ä¸‹ï¼Œä¸€ä¸ªCASæ“ä½œå°±å¯ä»¥è·å¾—é”ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Fast path: grab unlocked mutex.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¿«é€Ÿè·¯å¾„ï¼šè·å–è§£é”çš„äº’æ–¥é‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åŸå­æ“ä½œæ¯”è¾ƒ m.state çš„æ—§å€¼ä¸º 0 å¹¶äº¤æ¢æˆæ–°å€¼ 1ï¼ŒæˆåŠŸåˆ™è¡¨ç¤ºè·å–åˆ°é”ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™ç§æƒ…å†µå‘ç”Ÿåœ¨ state=0 æ—¶ï¼Œæ²¡æœ‰ç­‰å¾…çš„goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">CompareAndSwapInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">mutexLocked</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">race</span><span class="p">.</span><span class="nx">Enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">race</span><span class="p">.</span><span class="nf">Acquire</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">m</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 2) m.state != 0 æ—¶éƒ½ä¼šèµ° Slow path
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// CAS æ“ä½œæ²¡èƒ½è·å¾—é”ï¼Œå°±éœ€è¦è¿›å…¥ Slow pathäº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Slow path (outlined so that the fast path can be inlined)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœä¸Šé¢å¿«é€Ÿæ–¹å¼æ‹¿å–ä¸åˆ°é”ï¼Œåˆ™å»å’Œå…¶ä»–ç«äº‰ã€‚ä¸Šé¢æƒ…å†µæ‹¿ä¸åˆ°é”ï¼Œå¯èƒ½ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. å­˜åœ¨æœ‰å…¶ä»–goroutineæ­£åœ¨æŒæœ‰é”ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. ä¸å­˜åœ¨å…¶ä»–goroutineæŒæœ‰é”ï¼Œå­˜åœ¨è¢«å”¤é†’çš„goroutineæˆ–è¿˜æœ‰ç­‰å¾…çš„goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰å¯èƒ½å¤„äºã€æ­£å¸¸æ¨¡å¼ã€‘æˆ–ã€é¥¥é¥¿æ¨¡å¼ã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">m</span><span class="p">.</span><span class="nf">lockSlow</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="lockslow">lockSlow()<a hidden class="anchor" aria-hidden="true" href="#lockslow">#</a></h4>
<ol>
<li>å¦‚æœè°ƒç”¨è€…æ‹¿å–ä¸åˆ°é”ï¼Œåˆ™ä¸‹é¢æ“ä½œæµç¨‹æ˜¯å…ˆè‡ªæ—‹è¯•å›¾æ‹¿å»é”ï¼Œå®åœ¨æ‹¿å–ä¸åˆ°é”åˆ™è¿›å…¥ä¿¡å·æ± å»ç­‰å¾…æ‹¿å–é”ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// ç«äº‰è·å–é”
</span></span></span><span class="line"><span class="cl"><span class="c1">//  1. å…ˆè‡ªæ—‹ç­‰å¾…å…¶ä»–goroutineè§£é”ï¼ˆæ»¡è¶³è‡ªæ—‹æ¡ä»¶æ—¶ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1">//  2. å°è¯•ä¿®æ”¹ state å€¼ç«äº‰é”
</span></span></span><span class="line"><span class="cl"><span class="c1">//  3. ç«äº‰æˆåŠŸï¼Œè·å–é”é€€å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1">//  4. ç«äº‰å¤±è´¥ï¼Œsleep goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Mutex</span><span class="p">)</span> <span class="nf">lockSlow</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. å½“å‰goroutineé¦–æ¬¡è¿›å…¥semaphoreæ± sleepçš„æ—¶é—´/çº³ç§’ï¼Œä¸‹æ¬¡wakeupåç”¨äºåˆ¤æ–­ æ­£å¸¸æ¨¡å¼ &lt;-&gt; é¥¥é¥¿æ¨¡å¼ è½¬æ¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2. queueLifo := waitStartTime != 0; è¿›å…¥ semaphore æ± çš„é¦–æˆ–å°¾ï¼Œfalse.å°¾ true.é¦–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">waitStartTime</span> <span class="kt">int64</span>		
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// mutexæ¨¡å¼ ã€false.æ­£å¸¸æ¨¡å¼ã€‘ ã€true.é¥¥é¥¿æ¨¡å¼ã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œæ–°æ¥è·å–é”çš„goroutineå¦‚æœæ»¡è¶³æ¡ä»¶ä¼šè¿›è¡Œè‡ªæ—‹ç­‰å¾…é”è¢«é‡Šæ”¾ï¼Œå¦‚æœè¿˜æ‹¿å–ä¸åˆ°é”åˆ™å»ä¿¡å·æ± æœ€å‰é¢ç­‰å¾…ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. é¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œæ–°æ¥è·å–é”çš„goroutineä¸ä¼šè¿›è¡Œè‡ªæ—‹ï¼Œç›´æ¥å»ä¿¡å·æ± çš„æœ«å°¾å»ç­‰å¾…ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">starving</span> <span class="o">:=</span> <span class="kc">false</span>		    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// æ˜¯å¦æœ‰goroutineè¢«å”¤é†’ false.æ²¡æœ‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æœ‰è¢«å”¤é†’çš„goroutineæ—¶ï¼Œä¼šè¯•å›¾å»æ‹¿å»é”ï¼Œå¯èƒ½æ˜¯è·Ÿå½“å‰æ­£åœ¨è·å–é”çš„goroutineç«äº‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. åœ¨è‡ªæ—‹æƒ…å†µä¸‹æ»¡è¶³æ¡ä»¶è®¾ç½® awoke ä¸º true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. éé¥¥é¥¿æ¨¡å¼ä¸‹è¢«å”¤é†’çš„goroutine awoke ä¼šè¢«è®¾ç½®ä¸º true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  3. åœ¨é¥¥é¥¿æ¨¡å¼ä¸‹ awoke å˜é‡æ²¡æœ‰ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">awoke</span> <span class="o">:=</span> <span class="kc">false</span>	<span class="c1">// ç”¨äºåŸå­è®¾ç½® mutexWoken ä½ï¼Œé€šçŸ¥ Unlock å‡½æ•°æœ‰ woken çš„goroutineäº†ï¼Œä¸è¦å»wakeup goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// è®°å½•æ—‹è½¬çš„æ¬¡æ•°ï¼Œå½“æ²¡æœ‰è·å–é”æ—¶ï¼Œä¼šå°è¯•4æ¬¡å»è‡ªæ—‹è·å–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">iter</span> <span class="o">:=</span> <span class="mi">0</span>	<span class="c1">// è‡ªæ—‹è®¡æ•°å™¨	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»¥ä¸‹ä»£ç éƒ½æ˜¯ä» old -&gt; new çš„åŸå­æ“ä½œï¼Œå»å°è¯•ä¿®æ”¹ state å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="nx">old</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">state</span>	<span class="c1">// æ—§å€¼state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// è¯¥å¾ªç¯åªæœ‰åœ¨è·å–åˆ°é”çš„æ—¶å€™æ‰ä¼šé€€å‡ºï¼Œå› æ­¤æ‰€æœ‰æœªè·å–åˆ°é”çš„goroutineéƒ½å°†åœ¨è¿™é‡Œç­‰å¾…è·å–é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 1) é¥¥é¥¿æ¨¡å¼ä¸‹ä¸è¦è‡ªæ—‹ï¼Œå› ä¸ºæ‰€æœ‰æƒæŒ‰ç…§é¡ºåºä¼ é€’ï¼Œè‡ªæ—‹æ²¡æœ‰æ„ä¹‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ­£å¸¸æ¨¡å¼ä¸‹é”æ²¡æœ‰è¢«é‡Šæ”¾æ»¡è¶³è‡ªæ—‹æ¡ä»¶éœ€è¦è‡ªæ—‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1">// Don&#39;t spin in starvation mode, ownership is handed off to waiters
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// so we won&#39;t be able to acquire the mutex anyway.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä¸è¦åœ¨é¥¥é¥¿æ¨¡å¼ä¸‹æ—‹è½¬ï¼Œæ‰€æœ‰æƒå·²ç§»äº¤ç»™waitersï¼Œå› æ­¤æˆ‘ä»¬æ— è®ºå¦‚ä½•éƒ½æ— æ³•è·å¾—äº’æ–¥é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  1. old&amp;(mutexLocked|mutexStarving) == mutexLocked; Mutexæ²¡æœ‰å¤„äºé¥¥é¥¿æ¨¡å¼å¹¶ä¸”å·²è¢«é”å®šã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  2. runtime_canSpin(iter); æŠ¥å‘Šå½“å‰æ—‹è½¬è¦æ±‚æ¡ä»¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//	ä¸»åŠ¨æ—‹è½¬æ¡ä»¶ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//		æ—‹è½¬æ¬¡æ•°å°äº4æ¬¡ å¹¶ä¸” å¤šæ ¸CPUè¿è¡Œ å¹¶ä¸”é™¤äº†å½“å‰Pè¿˜æœ‰å…¶ä»–Pæ­£åœ¨è¿è¡Œï¼ˆä¸æ˜¯ç©ºé—²æˆ–è‡ªæ—‹çŠ¶æ€çš„Pï¼‰å¹¶ä¸” å½“å‰Pæ²¡æœ‰å…¶ä»–gäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//		è¿™ç§æƒ…å†µéœ€è¦å»å°è¯•è‡ªæ—‹è·å–ä¸‹é”ï¼Œå…¶ä»–æƒ…å†µåˆ™ä¸éœ€è¦è‡ªæ—‹å»è·å–é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä»¥ä¸‹è‡ªæ—‹çš„æ„ä¹‰ï¼Œåœç•™ç‰‡åˆ»ç­‰å¾…å…¶ä»–goroutineè®©å‡ºé”ï¼Œç„¶åæ ‡è®°mutexWokenå­˜åœ¨è¢«å”¤é†’çš„goroutineä½¿è‡ªå·±è·å–é”ä¼˜å…ˆçº§æ›´é«˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">old</span><span class="o">&amp;</span><span class="p">(</span><span class="nx">mutexLocked</span><span class="p">|</span><span class="nx">mutexStarving</span><span class="p">)</span> <span class="o">==</span> <span class="nx">mutexLocked</span> <span class="o">&amp;&amp;</span> <span class="nf">runtime_canSpin</span><span class="p">(</span><span class="nx">iter</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// è‡ªæ—‹åœ¨è¿™é‡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Active spinning makes sense.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Try to set mutexWoken flag to inform Unlock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// to not wake other blocked goroutines.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ä¸»åŠ¨æ—‹è½¬æ˜¯æœ‰é“ç†çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å°è¯•è®¾ç½® mutexflag æ¥é€šçŸ¥ Unlock ä¸è¦å”¤é†’å…¶ä»–è¢«é˜»å¡åœ¨ä¿¡å·æ± çš„goroutinesã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ä»¥ä¸‹é€»è¾‘æ˜¯å¤„äºè‡ªæ—‹ï¼Œè‡ªæ—‹çš„æ„ä¹‰åœ¨äºæ ‡è®°æœ‰æ­£åœ¨è¢«å”¤é†’çš„goroutineï¼Œå…¶ä»–çº¿ç¨‹ä¸è¦å†æ¬¡å”¤é†’å¯¼è‡´è¿‡å¤šgoroutineè¢«å”¤é†’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  1. !awoke; ï¼šæ²¡æœ‰æ ‡è®°å½“å‰goroutineè¢«å”¤é†’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  2. old&amp;mutexWoken == 0; ï¼šæ²¡æœ‰è¢«å”¤é†’çš„goroutineï¼ŒåŒ…æ‹¬å…¶ä»–gå’Œå½“å‰g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  3. old&gt;&gt;mutexWaiterShift != 0; ï¼šå­˜åœ¨ç­‰å¾…æ’é˜Ÿåœ¨ä¿¡å·æ± çš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  4. atomic.CompareAndSwapInt32(&amp;m.state, old, old|mutexWoken); 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//		è®¾ç½®æ ‡å¿—æœ‰goroutineè¢«å”¤é†’ï¼Œè¿™é‡Œè®¾ç½®æˆåŠŸé‚£unlockåˆ™ä¸ä¼šå†å»å”¤é†’goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">!</span><span class="nx">awoke</span> <span class="o">&amp;&amp;</span> <span class="nx">old</span><span class="o">&amp;</span><span class="nx">mutexWoken</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">old</span><span class="o">&gt;&gt;</span><span class="nx">mutexWaiterShift</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">atomic</span><span class="p">.</span><span class="nf">CompareAndSwapInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">old</span><span class="p">,</span> <span class="nx">old</span><span class="p">|</span><span class="nx">mutexWoken</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// æ ‡è®°ä¸ºå”¤é†’çŠ¶æ€ï¼Œä¸»è¦æ˜¯å‘Šè¯‰unlockä¸è¦å†å»å”¤é†’goroutineäº†ï¼Œè¿™é‡Œæœ‰è‡ªæ—‹çš„åœ¨ç­‰å¾…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">awoke</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// çŸ­æš‚å»¶è¿Ÿä¸€æ®µæ—¶é—´ï¼Œä¸»è¦æ˜¯ç­‰å¾…å…¶ä»–gè§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦‚æœæ­¤æ—¶Unlockäº†ç¬¬ä¸€ä¸ªifåˆ™ä¸ä¼šå†åˆ¤æ–­ä¸ºtrueï¼Œç›´æ¥å»äº‰æŠ¢é”äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">runtime_doSpin</span><span class="p">()</span>	
</span></span><span class="line"><span class="cl">            <span class="nx">iter</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">            <span class="nx">old</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">state</span>	<span class="c1">// ä»æ–°èµ‹å€¼ç»™old
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// 2) é”å¯èƒ½å·²è¢«é‡Šæ”¾å°è¯•ç«äº‰è·å–ï¼Œæˆ–é”è¿˜æœªè§£é™¤å»sleepã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1">// ä»£ç æ‰§è¡Œåˆ°è¿™é‡Œï¼Œåªå¯èƒ½å¤„äºä»¥ä¸‹å‡ ç§æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  1. è‡ªæ—‹æ¬¡æ•°ä»¥å®Œï¼ŒçŠ¶æ€ä¾ç„¶æ˜¯ mutexLockedã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  2. çŠ¶æ€æ˜¯ mutexStarving å¤„äºé¥¥é¥¿çŠ¶æ€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  3. çŠ¶æ€æ˜¯æœªåŠ é”çŠ¶æ€ï¼Œé”å·²è¢«è§£é™¤ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 	ï¼ˆå¤„äºé¥¥é¥¿æ¨¡å¼ï¼‰ æˆ– ï¼ˆè‡ªæ—‹æ¬¡æ•°è¶…è¿‡4æ¬¡ï¼‰ æˆ– ï¼ˆå½“å‰å…¶ä»–goroutineå·²Unlockï¼‰æˆ– ï¼ˆä¸æ»¡è¶³è‡ªæ—‹æ¡ä»¶ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//	å¦‚æœé”å·²Unlockï¼Œé‚£ä¹ˆå°è¯•å»è·å–é”ï¼›å¦‚æœé”å¤„äºLockï¼Œé‚£ä¹ˆä¹Ÿå°è¯•è·å–ï¼Œå¦åˆ™åŠ å…¥åˆ°ä¿¡å·æ± ä¸­ç­‰å¾…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1">// old æ˜¯æœ¬è½®åŸå­æ“ä½œçš„ state å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// new æ˜¯æœ¬è½®éœ€è¦äº‰æŠ¢é”ä¿®æ”¹åçš„ state å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ­£å¸¸æ¨¡å¼ä¸‹:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  1. åœ¨oldæœªæŒæœ‰é”æƒ…å†µä¸‹ï¼Œè°å…ˆåŸå­æ“ä½œä» old ä¿®æ”¹ä¸º new è°å°±å…ˆè·å–åˆ°é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  2. åœ¨oldæŒæœ‰é”æƒ…å†µä¸‹ï¼Œå½“å‰goroutineéœ€è¦sleep
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">new</span> <span class="o">:=</span> <span class="nx">old</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// 2.1) æ­£å¸¸æ¨¡å¼ä¸‹éœ€è¦äº‰æŠ¢é”ï¼Œå› æ­¤éœ€è¦è®¾ç½®mutexLockedçŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1">// Don&#39;t try to acquire starving mutex, new arriving goroutines must queue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä¸è¦å°è¯•è·å–å¤„äºé¥¥é¥¿çš„Mutexï¼Œåæ¥çš„goroutineså¿…é¡»æ’é˜Ÿã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å¤„äºé¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œä¸ºä»€ä¹ˆä¸éœ€è¦è®¾ç½®mutexLockedæ ‡å¿—å‘¢ï¼Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  1. å¤„äºé¥¥é¥¿æ¨¡å¼ä¸‹é”çš„æŒæœ‰æƒæ˜¯æ‰‹æŠŠæ‰‹äº¤ç»™åé¢ç­‰å¾…çš„goroutineï¼Œå› æ­¤mutexLockedæ ‡å¿—è®¾ç½®ä¸è®¾ç½®ä¸é‡è¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  2. å¯¹äºæ–°æ¥çš„goroutineï¼ŒmutexLockedä½å¯èƒ½ä¸º0æˆ–1ï¼Œä½†æ˜¯å½“å‰goroutineä¸ä¼šå»æŒ£æŠ¢é”ç›´æ¥sleepï¼Œå› æ­¤mutexLockedä½ä¸é‡è¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 	3. å¯¹äºä»sleepä¸­wakeupçš„goroutineï¼Œä¸€å®šæ˜¯æ¥è‡ªUnlockå‡½æ•°è€Œæ¥è‡ªè¯¥å‡½æ•°mutexLockedä½ä¸€å®šæ˜¯0ï¼Œå·²è¢«è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">old</span><span class="o">&amp;</span><span class="nx">mutexStarving</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>	<span class="c1">// å¤„äºæ­£å¸¸æ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// newè¡¨ç¤ºæ–°å€¼ä¿®æ”¹çš„çŠ¶æ€ mutexLockedéœ€è¦é”ï¼Œä¸ç®¡å½“å‰æ˜¯Lockæˆ–Unlockå½“å‰éƒ½éœ€è¦è®¾ç½®mutexLockedè¡¨ç¤ºéœ€è¦å»äº‰æŠ¢é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">new</span> <span class="o">|=</span> <span class="nx">mutexLocked</span>	
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// 2.2) é”è¿˜æœªè¢«é‡Šæ”¾ æˆ– å¤„äºé¥¥é¥¿æ¨¡å¼ä¸‹ è¿™ä¸¤ç§æƒ…å†µä¸‹éƒ½ä¼šå»sleepï¼Œå› æ­¤éœ€è¦åŠ ä¸€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœoldé”æ²¡é‡Šæ”¾ æˆ– å¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œé‚£ä¹ˆå½“å‰çš„goroutineåˆ™æ˜¯éœ€è¦è¢«åŠ å…¥åˆ°ä¿¡å·æ± é‡Œé¢å»çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">old</span><span class="o">&amp;</span><span class="p">(</span><span class="nx">mutexLocked</span><span class="p">|</span><span class="nx">mutexStarving</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>	<span class="c1">// å¤„äºLockæˆ–åˆ™é¥¥é¥¿æ¨¡å¼å½“å‰géœ€è¦åŠ å…¥åˆ°ä¿¡å·æ± 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">new</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="nx">mutexWaiterShift</span>	<span class="c1">// æ•°é‡å¢åŠ 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// 2.3) å½“å‰ goroutine å°† mutex åˆ‡æ¢è‡³é¥¥é¥¿æ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å¦‚æœ mutex å·²ç»å¤„äº unlocked çŠ¶æ€ï¼Œå°±ä¸è¦åˆ‡æ¢äº†ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å› ä¸º Unlock() å‡½æ•°è®¤ä¸ºå¤„äºé¥¥é¥¿æ¨¡å¼çš„ mutex ç­‰å¾…é˜Ÿåˆ—ä¸ä¸ºç©ºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1">// The current goroutine switches mutex to starvation mode.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// But if the mutex is currently unlocked, don&#39;t do the switch.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Unlock expects that starving mutex has waiters, which will not
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// be true in this case.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å½“å‰çš„ goroutine å°†äº’æ–¥é”åˆ‡æ¢åˆ°é¥¥é¥¿æ¨¡å¼ï¼Œä½†å¦‚æœäº’æ–¥é”å½“å‰å·²è§£é”ï¼Œå°±ä¸è¦åˆ‡æ¢ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// UnlockæœŸæœ›å¤„äºé¥¥é¥¿çŠ¶æ€çš„äº’æ–¥é”æœ‰waitersï¼Œä½†åœ¨æœ¬ä¾‹ä¸­å¹¶éå¦‚æ­¤ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// starving=true å‘ç”Ÿåœ¨ï¼šè¿™ä¸ªgoroutineè¢«åŠ å…¥åˆ°ä¿¡å·æ± åå†åº¦è¢«å”¤é†’å»äº‰æŠ¢é”æ—¶ï¼Œå‘ç°ç­‰å¾…æ—¶é—´å·²ç»è¶…è¿‡1msæ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// old&amp;mutexLocked != 0ï¼Œè¡¨ç¤ºè¿™ä¸ªè¢«å”¤é†’çš„goroutineå†æ¬¡äº‰æŠ¢é”æ—¶é”æ²¡è¢«å…¶ä»–gorutineé‡Šæ”¾ï¼Œè¿™æ¬¡å†äº‰æŠ¢å°†å¤±è´¥åˆ™ä¼šæ ‡è®°æˆé¥¥é¥¿æ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">starving</span> <span class="o">&amp;&amp;</span> <span class="nx">old</span><span class="o">&amp;</span><span class="nx">mutexLocked</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>	<span class="c1">// è¿™ç§æƒ…å†µä¸‹å½“å‰goroutineåŸºæœ¬æ‹¿å»ä¸åˆ°é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">new</span> <span class="o">|=</span> <span class="nx">mutexStarving</span> <span class="c1">// æ ‡è®°æˆé¥¥é¥¿æ¨¡å¼æ—¶ï¼Œé”ä¸€å®šè¢«å…¶ä»–æŒæœ‰ï¼›ä½†æ˜¯å”¤é†’çš„gå¤„äºé¥¥é¥¿æ¨¡å¼æ—¶ï¼Œé”ä¸€å®šæ˜¯UnlockçŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// 2.4) å½“å‰goroutineæ˜¯è¢«å”¤é†’çš„ï¼Œæ£€æŸ¥å¹¶æ¸…é™¤æ ‡å¿—ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1">// awoke=true è¡¨ç¤ºæ¥è‡ªè‡ªæ—‹æˆ–è¢«å”¤é†’çš„goroutineä¸¤ç§å½¢å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  1. è‡ªæ—‹çŠ¶æ€ä¸‹ awoke=trueï¼Œstate ä¸­ mutexWoken ä½å·²è¢«è®¾ç½®ä¸º 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  2. è¢«å”¤é†’çš„goroutineä¸‹ awoke=true åœ¨æœ¬å‡½æ•°çš„å”¤é†’åè¢«è®¾ç½®ï¼Œè€Œ state ä¸­ mutexWoken ä½åœ¨Unlockå‡½æ•°ä¸­è¢«è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å› æ­¤ awoke=true å°±ä¸€å®šå­˜åœ¨ state ä¸­ mutexWoken ä½ä¸º1ï¼Œnew&amp;mutexWoken != 0æˆç«‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">awoke</span> <span class="p">{</span>	<span class="c1">// awokeæœ‰ç­‰å¾…çš„goroutineè¢«å”¤é†’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// The goroutine has been woken from sleep,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// so we need to reset the flag in either case.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// goroutine å·²ç»ä»ç¡çœ ä¸­å”¤é†’ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ä»»ä½•ä¸€ç§æƒ…å†µä¸‹é‡ç½®æ ‡å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">new</span><span class="o">&amp;</span><span class="nx">mutexWoken</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>	<span class="c1">// ä¸è®ºæ¥è‡ªè‡ªæ—‹æˆ–è¢«å”¤é†’çš„goroutineè¿™é‡Œéƒ½ä¸èƒ½ä¸º0ï¼Œæ­£å¸¸çŠ¶å†µä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;sync: inconsistent mutex state&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">new</span> <span class="o">&amp;^=</span> <span class="nx">mutexWoken</span> <span class="c1">// æ¸…é™¤è¢«å”¤é†’æ ‡å¿—ä½mutexWokenï¼Œå› ä¸ºä¸‹é¢å³å°†å»äº‰æŠ¢é”ï¼Œæˆ–è€…è½½å…¥å»ä¿¡å·æ± ç­‰å¾…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// å°è¯•ä½¿ç”¨åŸå­ä¿®æ”¹stateï¼Œæ‰€æœ‰çš„goroutineéƒ½ä¼šé€šè¿‡è¯¥æ¡ä»¶ï¼Œä½†æ˜¯ä¸€è½®åªèƒ½æˆåŠŸä¸€ä¸ª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿™é‡Œä¿®æ”¹m.stateæˆåŠŸäº†ï¼Œå¹¶ä¸ä»£è¡¨ä¸€å®šè·å–åˆ°äº†é”ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å½“å‰géœ€è¦åŠ å…¥åˆ°ä¿¡å·æ± ä¸­å»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">CompareAndSwapInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">old</span><span class="p">,</span> <span class="nx">new</span><span class="p">)</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">            <span class="c1">// å¦‚æœä¸Šä¸€ä¸ªæ‹¿å»åˆ°é”çš„stateæ˜¯æ­£å¸¸æ¨¡å¼å¹¶æ²¡æœ‰é”ï¼Œåˆ™è¿™é‡Œç›´æ¥é€€å‡ºï¼Œè¿™é‡Œè¡¨ç¤ºå½“å‰goroutineè·å–åˆ°äº†é”ï¼Œæ­£å¸¸æ¨¡å¼éƒ½æ˜¯ä»è¿™é‡Œé€€å‡ºçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æ­£å¸¸æ¨¡å¼ä¸‹è·å–åˆ°é”çš„æƒ…å†µï¼Œè¿™é‡Œä¸ä¼šå‡ºç°æ ‡è®°æˆé¥¥é¥¿æ¨¡å¼ä½†è¿™é‡Œåˆåˆ¤æ–­ä¸ºtrueé€€å‡ºäº†çš„æƒ…å†µï¼ŒåŸå› æ˜¯æ ‡è®°æˆé¥¥é¥¿æ¨¡å¼çš„å‰ç½®æ¡ä»¶æ˜¯å½“å‰oldæ˜¯Lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">old</span><span class="o">&amp;</span><span class="p">(</span><span class="nx">mutexLocked</span><span class="p">|</span><span class="nx">mutexStarving</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>	<span class="c1">// è°å…ˆæ‹¿åˆ°é”é€€å‡ºï¼Œæ¥åˆ°æ‰§è¡Œgoroutineåé¢ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">break</span> <span class="c1">// locked the mutex with CAS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// åé¢å¤„ç†é€»è¾‘æ˜¯ä¹‹å‰æœ‰é”ï¼Œè¿™ä¸ªgoroutineéœ€è¦å»æ’é˜Ÿæƒ…å†µï¼Œæˆ–å½“å‰æ¨¡å¼å¤„äºé¥¥é¥¿æ¨¡å¼ï¼Œç›´æ¥æŠŠè¯¥goroutineåŠ å…¥åˆ°å°¾éƒ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            
</span></span><span class="line"><span class="cl">            <span class="c1">// If we were already waiting before, queue at the front of the queue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦‚æœæˆ‘ä»¬ä¹‹å‰å·²ç»åœ¨ç­‰å¾…ï¼Œè¯·åœ¨é˜Ÿåˆ—çš„å‰é¢æ’é˜Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// waitStartTimeå¦‚æœä¸ç­‰äº0è¯´æ˜å…ˆå‰å…¥é˜Ÿè¿‡æœ‰è¢«å”¤é†’è¿‡ï¼Œæ­£å¸¸ç¬¬ä¸€æ¬¡å…¥é˜Ÿè¿™é‡Œæ˜¯false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¢«å”¤é†’ä¹‹åæ²¡æœ‰æŠ¢åˆ°é”ï¼Œéœ€è¦æ’å…¥é˜Ÿåˆ—å¤´éƒ¨ï¼Œè€Œä¸æ˜¯å°¾éƒ¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">queueLifo</span> <span class="o">:=</span> <span class="nx">waitStartTime</span> <span class="o">!=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// é¦–æ¬¡è¿›å…¥ä¿¡å·æ± å»ç­‰å¾…æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">waitStartTime</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>	<span class="c1">// è¿™é‡Œè¡¨ç¤ºè¿™ä¸ªgoroutineä»ä¿¡å·æ± ä¸­ç¬¬ä¸€æ¬¡è¢«å”¤é†’ä¾ç„¶æ²¡æœ‰è·å–åˆ°é”ï¼Œä»æ–°è®¾ç½®æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">waitStartTime</span> <span class="p">=</span> <span class="nf">runtime_nanotime</span><span class="p">()</span>	<span class="c1">// æ³¨æ„ï¼šé™¤ç¬¬ä¸€æ¬¡å…¥é˜Ÿååé¢æ¯æ¬¡ç¼“å­˜waitStartTimeæ—¶é—´éƒ½ä¸ä¼šè¢«åˆ·æ–°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// è¿™é‡Œå­˜åœ¨è¢«å”¤é†’ä½†æ˜¯è¿˜æ˜¯æ²¡æ‹¿åˆ°é”çš„æƒ…å†µä¼šå†æ¬¡è¢«å…¥é˜Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// runtime_SemacquireMutexçš„queueLifoå‚æ•°ä¸ºtrueåˆ™æ˜¯æ’å…¥çš„ä¿¡å·æ± å¤´éƒ¨ï¼Œfalseæ’å…¥åˆ°å°¾éƒ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//		é¦–æ¬¡è¿›å…¥ä¿¡å·æ± ï¼Œåˆ™ç›´æ¥æ’åœ¨å°¾éƒ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//		ä»ä¿¡å·æ± ä¸­å‡ºæ¥åˆäº‰æŠ¢å¤±è´¥è¿›å…¥ä¿¡å·æ± æ’åœ¨å¤´éƒ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦‚æˆ‘ä»¬å–å‡ºgorutineåˆ™æ˜¯ä»å¤´éƒ¨å¼€å§‹å¾€åå–ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„å…ˆè¿›å…ˆå‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å› ä¸ºç¬¬ä¸€æ¬¡åŠ å…¥ä¿¡å·æ± çš„éƒ½æ˜¯æ’å…¥åˆ°å°¾éƒ¨ï¼Œå½“å†è¢«å”¤é†’ä¾ç„¶æ²¡æœ‰è·å–åˆ°é”æ—¶ï¼Œåˆ™æ˜¯è¢«æ”¾å›åˆ°å¤´éƒ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å½“å‰goroutineå»æ’é˜Ÿï¼Œè¿™é‡Œå½“å‰groutineè¢«è°ƒç¦»å·¥ä½œçº¿ç¨‹ç­‰å¾…æŠ¢åˆ°é”åç»§ç»­åé¢æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">runtime_SemacquireMutex</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">.</span><span class="nx">sema</span><span class="p">,</span> <span class="nx">queueLifo</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// è¢«å”¤é†’çš„gï¼Œæ¥åˆ°ä»è¿™é‡Œæ‰§è¡Œå°è¯•å»è·å–é”ï¼›å¯èƒ½å½“å‰å¤„äºé¥¥é¥¿æ¨¡å¼æˆ–å¤„äºæ­£å¸¸æ¨¡å¼ï¼Œå”¤é†’gçš„ç›¸å…³ä»£ç ä½äºUnlockå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            
</span></span><span class="line"><span class="cl">            <span class="c1">// å¦‚æœç­‰å¾…çš„æ—¶é—´å¤§äº1msåˆ™æ ‡è®°æˆé¥¥é¥¿æ¨¡å¼ï¼Œä»¥ä¸‹é€»è¾‘æ˜¯å½“å‰goroutineè¢«å”¤é†’åå†æ¬¡å°è¯•è·å–é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ç­‰å¾…æ—¶é—´è¶…è¿‡äº†1msï¼Œç­‰å¾…æ—¶é—´å¤ªä¹…éœ€è¦è¢«æ ‡è®°ä¸ºé¥¥é¥¿çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">starving</span> <span class="p">=</span> <span class="nx">starving</span> <span class="o">||</span> <span class="nf">runtime_nanotime</span><span class="p">()</span><span class="o">-</span><span class="nx">waitStartTime</span> <span class="p">&gt;</span> <span class="nx">starvationThresholdNs</span>
</span></span><span class="line"><span class="cl">            <span class="nx">old</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">state</span>	<span class="c1">// è·å–å½“å‰çš„çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦‚æœå¤„äºé¥¥é¥¿æ¨¡å¼ï¼Œå¤„äºé¥¥é¥¿æ¨¡å¼ä¸‹å”¤é†’çš„goroutineç«‹å³è·å–é”ï¼Œå› ä¸ºæ­£å¸¸æ¥æŠ¢çš„goroutineéƒ½ä¼šè¢«å…¥é˜Ÿï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ç„¶åä¸€ä¸ªä¸ªæ¥è·å–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æ‰€æœ‰é¥¥é¥¿æ¨¡å¼ä¸‹è·å–é”çš„å‡ºå£éƒ½åœ¨è¿™é‡Œï¼Œè¯¥æ¡ä»¶æ»¡è¶³è¯´æ˜å½“å‰goroutineè·å–åˆ°é”æŒæœ‰æƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">old</span><span class="o">&amp;</span><span class="nx">mutexStarving</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">                <span class="c1">// If this goroutine was woken and mutex is in starvation mode,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// ownership was handed off to us but mutex is in somewhat
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// inconsistent state: mutexLocked is not set and we are still
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// accounted as waiter. Fix that.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// å½“å‰ä»£ç ä½ç½®çš„ goroutine è‚¯å®šæ˜¯è¢«å”¤é†’çš„ï¼Œè€Œä¸” Mutex å¤„äºé¥¥é¥¿æ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// æ‰€æœ‰æƒè¢«ç›´æ¥äº¤ç»™å½“å‰ goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// ä½†æ˜¯è¿™ç§æƒ…å†µä¸‹ mutex çš„ state ä¼šä¸å®é™…æƒ…å†µä¸ä¸€è‡´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// mutexLocked æ ‡å¿—ä½æ²¡æœ‰è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// è€Œä¸”ç­‰å¾…è€…è®¡æ•°ä¸­ä¹Ÿæ²¡æœ‰å‡å»å½“å‰ goroutineã€‚éœ€è¦ä¿®å¤ state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// æ³¨æ„é¥¥é¥¿æ¨¡å¼ä¸‹ä¼ é€’ mutex æ‰€æœ‰æƒä¸ä¼šè®¾ç½® mutexWoken æ ‡å¿—ï¼Œåªæœ‰æ­£å¸¸æ¨¡å¼ä¸‹å”¤é†’æ‰ä¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// é¥¥é¥¿æ¨¡å¼ä¸‹ old&gt;&gt;mutexWaiterShift != 0ï¼Œå½“å‰ä¸€å®šä¸èƒ½æ˜¯æœ€åä¸€ä¸ªï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// å› ä¸ºä¸‹é¢ old&gt;&gt;mutexWaiterShift == 1 ä¼šé€€å‡ºé¥¥é¥¿æ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// old&amp;(mutexLocked|mutexWoken) != 0 å› ä¸ºå¤„äºé¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰çš„goroutineéƒ½ä¼šå»æ’é˜Ÿsleepï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// è¢«wakeupçš„goroutineä¸€å®šæ¥è‡ªUnlockå‡½æ•°ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// æ­¤æ—¶mutexLockedä¸€å®šè§£é”ï¼ŒmutexWokenä¸€å®šæ˜¯è¢«æ¸…é™¤çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">old</span><span class="o">&amp;</span><span class="p">(</span><span class="nx">mutexLocked</span><span class="p">|</span><span class="nx">mutexWoken</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">old</span><span class="o">&gt;&gt;</span><span class="nx">mutexWaiterShift</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// é¥¥é¥¿æ¨¡å¼ä¸‹ï¼ŒmutexLockedå’ŒmutexWokenå¿…å®šä¸º0ï¼Œå‚çœ‹ä¸Šé¢ä»£ç ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;sync: inconsistent mutex state&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// +mutexLocked -1&lt;&lt;mutexWaiterShift
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">delta</span> <span class="o">:=</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">mutexLocked</span> <span class="o">-</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="nx">mutexWaiterShift</span><span class="p">)</span>	<span class="c1">// å°†ç­‰å¾…çš„æ•°é‡å‡ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// ç­‰å¾…æ—¶é—´å°äº1ms æˆ– å½“å‰goroutineæ˜¯é˜Ÿåˆ—æœ€åä¸€ä¸ªï¼Œåˆ™æ ‡è®°é€€å‡ºé¥¥é¥¿æ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="p">!</span><span class="nx">starving</span> <span class="o">||</span> <span class="nx">old</span><span class="o">&gt;&gt;</span><span class="nx">mutexWaiterShift</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Exit starvation mode.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// Critical to do it here and consider wait time.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// Starvation mode is so inefficient, that two goroutines
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// can go lock-step infinitely once they switch mutex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// to starvation mode.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nx">delta</span> <span class="o">-=</span> <span class="nx">mutexStarving</span>	<span class="c1">// é€€å‡ºé¥¥é¥¿æ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">delta</span><span class="p">)</span> <span class="c1">// ä¿®æ”¹stateï¼Œè¿”å›ç›´æ¥è¿”å›ï¼Œåº”ä¸ºè¯¥goroutine è·å–åˆ°é”äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">break</span>	<span class="c1">// é¥¥é¥¿æ¨¡å¼ä»è¿™é‡Œé€€å‡ºï¼Œå› æ­¤é¥¥é¥¿æ¨¡å¼ä¸‹è¢«å”¤é†’çš„goroutineç›´æ¥ä»è¿™é‡Œé€€å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œè®¾ç½®ä¸ºå”¤é†’å»äº‰æŠ¢é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            
</span></span><span class="line"><span class="cl">            <span class="nx">awoke</span> <span class="p">=</span> <span class="kc">true</span>	<span class="c1">// stateçš„mutexWokenä½åœ¨Unlockå‡½æ•°ä¸­è¢«è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">iter</span> <span class="p">=</span> <span class="mi">0</span>	<span class="c1">// è‡ªæ—‹æ¬¡æ•°é‡ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ä»old-&gt;new åŸå­è®¾ç½®ï¼Œå¦‚æœè®¾ç½®å¤±è´¥ä»æ–°å†æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">old</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">state</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">race</span><span class="p">.</span><span class="nx">Enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">race</span><span class="p">.</span><span class="nf">Acquire</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">m</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="sync_runtime_canspin">sync_runtime_canSpin()<a hidden class="anchor" aria-hidden="true" href="#sync_runtime_canspin">#</a></h4>
<ol>
<li>sync.Mutex ä¸»åŠ¨æ—‹è½¬æ¡ä»¶ã€‚</li>
<li>ä¸ä¸»åŠ¨æ—‹è½¬æ¡ä»¶ï¼š
<ol>
<li>ã€æ—‹è½¬æ¬¡æ•°å¤§äºç­‰äº4æ¬¡ã€‘æˆ–ã€å•æ ¸CPUåœ¨è¿è¡Œã€‘ æˆ–ã€é™¤äº†å½“å‰På…¶ä»–Péƒ½å¤„äºç©ºé—²æˆ–è‡ªæ—‹çŠ¶æ€ã€‘ï¼Œä¸éœ€è¦ä¸»åŠ¨å»æ—‹è½¬ç­‰å¾…è·å–é”ã€‚</li>
<li>å¦‚æœå½“å‰Pçš„runqä¸ä¸ºç©ºï¼Œä¹Ÿæ²¡å¿…è¦å»è‡ªæ—‹ï¼Œå› ä¸ºé‡Œé¢çš„gè¿˜ç­‰ç€å»æ‰§è¡Œï¼Œç›´æ¥æŠŠå½“å‰gæŒ‚èµ·ã€‚</li>
</ol>
</li>
<li>ä¸»åŠ¨æ—‹è½¬æ¡ä»¶ï¼š
<ol>
<li>ã€æ—‹è½¬æ¬¡æ•°å°äº4æ¬¡ã€‘å¹¶ä¸”ã€å¤šæ ¸CPUè¿è¡Œã€‘å¹¶ä¸”ã€é™¤äº†å½“å‰Pè¿˜æœ‰å…¶ä»–Pæ­£åœ¨è¿è¡Œã€‘ï¼ˆä¸æ˜¯ç©ºé—²æˆ–è‡ªæ—‹çŠ¶æ€çš„Pï¼‰å¹¶ä¸” ã€å½“å‰Pæ²¡æœ‰å…¶ä»–gäº†ã€‘ã€‚</li>
<li>è¿™ç§æƒ…å†µéœ€è¦å»å°è¯•è‡ªæ—‹è·å–ä¸‹é”ï¼Œå…¶ä»–æƒ…å†µåˆ™ä¸éœ€è¦è‡ªæ—‹å»è·å–é”ã€‚</li>
</ol>
</li>
<li><code>runtime/proc.go</code>æ–‡ä»¶ä¸­ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Active spinning for sync.Mutex.
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:linkname sync_runtime_canSpin sync.runtime_canSpin
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">sync_runtime_canSpin</span><span class="p">(</span><span class="nx">i</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// sync.Mutex is cooperative, so we are conservative with spinning.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Spin only few times and only if running on a multicore machine and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// GOMAXPROCS&gt;1 and there is at least one other running P and local runq is empty.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// As opposed to runtime mutex we don&#39;t do passive spinning here,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// because there can be work on global runq or on other Ps.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sync.Mutexæ˜¯åˆä½œæ€§çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯¹spinningæ˜¯ä¿å®ˆçš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åªæ—‹è½¬å‡ æ¬¡ï¼Œä¸”ä»…å½“è¿è¡Œåœ¨å¤šæ ¸è®¡ç®—æœºå’ŒGOMAXPROCS&gt;1ä¸Šï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªå…¶ä»–è¿è¡ŒPä¸”æœ¬åœ°runqä¸ºç©ºæ—¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸è¿è¡Œæ—¶äº’æ–¥é”ç›¸åï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä¸åšè¢«åŠ¨æ—‹è½¬ï¼Œå› ä¸ºå¯ä»¥åœ¨å…¨å±€runqæˆ–å…¶ä»–Pä¸Šè¿›è¡Œå·¥ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä»¥ä¸‹æ¡ä»¶æ»¡è¶³ä¸€é¡¹éƒ½ä¸ä¼šå†æ¬¡è‡ªæ—‹å»è·å–é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 	1. const active_spin = 4; æœ€å¤šå°è¯•4æ¬¡è‡ªæ—‹è·å–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 	2. var ncpu int32 &lt;= 1; å¦‚æœæ˜¯å•æ ¸CPU
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 	3. gomaxprocs &lt;= int32(sched.npidle+sched.nmspinning)+1;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    3.1 gomaxprocsï¼šè¡¨ç¤ºæ€»çš„P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    3.2 sched.npidleç©ºé—²çš„Pæ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    3.3 sched.nmspinningæ­£åœ¨è‡ªæ—‹çš„Mæ•°é‡(è¿™é‡Œé¢å¯èƒ½å­˜åœ¨æ­£åœ¨äº‰æŠ¢é”ï¼Œå¤„åœ¨è‡ªæ—‹éƒ½æ˜¯åªæœ‰ä¸€ä¸ªgçš„æƒ…å†µ)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  é™¤äº†å½“å‰På…¶ä»–çš„Péƒ½å¾ˆé—²ï¼Œä¹Ÿä¸å¿…è¦è‡ªæ—‹äº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="nx">active_spin</span> <span class="o">||</span> <span class="nx">ncpu</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">gomaxprocs</span> <span class="o">&lt;=</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">sched</span><span class="p">.</span><span class="nx">npidle</span><span class="o">+</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿™é‡Œä¸åƒ runtime.mutex é‚£æ ·è¿›è¡Œæ¶ˆæè‡ªæ—‹ï¼Œå› ä¸ºå…¨å±€ runq æˆ–å…¶ä»– P ä¸Šæˆ–è®¸è¿˜æœ‰å¯è¿è¡Œçš„ä»»åŠ¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰æœ¬åœ°Pä¸ä¸ºç©ºï¼Œä¹Ÿä¸éœ€è¦è‡ªæ—‹å†å‡ºå»å°è¯•è·å–é”ï¼Œå…¶ä»–goroutineè¿˜ç­‰èµ·çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">p</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">().</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">();</span> <span class="p">!</span><span class="nf">runqempty</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="sync_runtime_dospin">sync_runtime_doSpin()<a hidden class="anchor" aria-hidden="true" href="#sync_runtime_dospin">#</a></h4>
<ol>
<li>çŸ­æš‚çš„å»¶è¿Ÿã€‚</li>
<li><code>runtime/proc.go</code> æ–‡ä»¶ä¸­ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:linkname sync_runtime_doSpin sync.runtime_doSpin
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">sync_runtime_doSpin</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¾ªç¯30æ¬¡ç­‰å¾…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">procyield</span><span class="p">(</span><span class="nx">active_spin_cnt</span><span class="p">)</span>	<span class="c1">// active_spin_cnt=30
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="procyield">procyield()<a hidden class="anchor" aria-hidden="true" href="#procyield">#</a></h4>
<ol>
<li>çŸ­æš‚çš„å»¶è¿Ÿã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="c1"># runtime/asm_amd.64.s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">TEXT</span> <span class="no">runtime</span><span class="err">Â·</span><span class="no">procyield</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span><span class="no">NOSPLIT</span><span class="p">,</span><span class="no">$0-0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">MOVL</span>	<span class="no">cycles</span><span class="err">+</span><span class="mi">0</span><span class="p">(</span><span class="no">FP</span><span class="p">),</span> <span class="no">AX</span>	<span class="c1"># AX=30 å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nl">again:</span>
</span></span><span class="line"><span class="cl">    <span class="nf">PAUSE</span> <span class="c1"># è‡ªæ—‹é™ä½CPUå‘çƒ­å’Œæ€§èƒ½ä¼˜åŒ–ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">SUBL</span>	<span class="no">$1</span><span class="p">,</span> <span class="no">AX</span>			<span class="c1"># AX -= 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">JNZ</span>	<span class="no">again</span>
</span></span><span class="line"><span class="cl">    <span class="nf">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="unlock">Unlock()<a hidden class="anchor" aria-hidden="true" href="#unlock">#</a></h3>
<ol>
<li>Unlockè§£é”mã€‚</li>
<li>å¦‚æœmåœ¨è¿›å…¥è§£é”æ—¶æ²¡æœ‰è¢«é”å®šï¼Œåˆ™æ˜¯ä¸€ä¸ªè¿è¡Œæ—¶é”™è¯¯ã€‚</li>
<li>ä¸€ä¸ªé”å®šçš„äº’æ–¥é‡ä¸ä¸€ä¸ªç‰¹å®šçš„goroutineæ— å…³ã€‚</li>
<li>å…è®¸ä¸€ä¸ªgoroutineé”å®šä¸€ä¸ªäº’æ–¥é‡ï¼Œç„¶åå®‰æ’å¦ä¸€ä¸ªgoroutineè§£é”å®ƒã€‚</li>
<li>è¯¥æ–¹æ³•ä¸»è¦é€šè¿‡ atomic å‡½æ•°å®ç°äº† Fast pathï¼Œç›¸åº”çš„ Slow pathè¢«å•ç‹¬æ”¾åœ¨äº† unlockSlow() æ–¹æ³•ä¸­ã€‚</li>
<li>æ ¹æ®æºç æ³¨é‡Šçš„è¯´æ³•ï¼Œè¿™æ ·æ˜¯ä¸ºäº†ä¾¿äºç¼–è¯‘å™¨å¯¹ Fast path è¿›è¡Œå†…è”ä¼˜åŒ–ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Unlock unlocks m.
</span></span></span><span class="line"><span class="cl"><span class="c1">// It is a run-time error if m is not locked on entry to Unlock.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// A locked Mutex is not associated with a particular goroutine.
</span></span></span><span class="line"><span class="cl"><span class="c1">// It is allowed for one goroutine to lock a Mutex and then
</span></span></span><span class="line"><span class="cl"><span class="c1">// arrange for another goroutine to unlock it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Mutex</span><span class="p">)</span> <span class="nf">Unlock</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">race</span><span class="p">.</span><span class="nx">Enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">state</span>
</span></span><span class="line"><span class="cl">        <span class="nx">race</span><span class="p">.</span><span class="nf">Release</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">m</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) é€šè¿‡åŸå­æ“ä½œä» state ä¸­å‡å» mutexLockedï¼Œä¹Ÿå°±æ˜¯é‡Šæ”¾é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç„¶åæ ¹æ® state çš„æ–°å€¼(new)æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡Œ Slow pathã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Fast path: drop lock bit.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Fast path: ç›´æ¥æŠŠé”æ ‡å¿—ä½æ”¾å¼€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœä¹‹å‰mutexLockedä½ä¸º1åˆ™ä¿®æ”¹ä¸º0ï¼›å¦‚æœä¹‹å‰mutexLockedä½ä¸º0åˆ™ä¿®æ”¹ä¸º1ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">new</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="o">-</span><span class="nx">mutexLocked</span><span class="p">)</span>	<span class="c1">// å¦‚æœåˆ é™¤äº†é”çš„bitä½ï¼Œstateç­‰äº0è¯´æ˜æ²¡æœ‰ç­‰å¾…æŠ¢é”çš„goroutineç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// newä¸º0ï¼Œæ„å‘³ç€æ²¡æœ‰å…¶ä»– goroutine åœ¨æ’é˜Ÿï¼Œæ‰€ä»¥ä¸éœ€è¦æ‰§è¡Œé¢å¤–æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// newä¸ä¸º0ï¼Œåˆ™å¯èƒ½éœ€è¦å”¤é†’æŸä¸ª goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Unlock æ‰§è¡Œå®Œåmutex.state!=0 åˆ™å­˜åœ¨ä»¥ä¸‹å¯èƒ½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 	æ­£å¸¸æ¨¡å¼ä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 		1. å½“å‰å­˜åœ¨ç­‰å¾…çš„goroutineå»å”¤é†’å®ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//		2. å½“å‰å­˜åœ¨è‡ªæ—‹ç­‰å¾…çš„goroutineï¼Œåˆ™ä¸å”¤é†’å…¶ä»–ç­‰å¾…çš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é¥¥é¥¿æ¨¡å¼ä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 		1. ç›´æ¥å°†é”äº¤ç»™ç­‰å¾…é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªgoroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">new</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>	<span class="c1">// è¿˜å­˜åœ¨å…¶ä»–ç­‰å¾…é˜Ÿåˆ—ä¸­çš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Outlined slow path to allow inlining the fast path.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// To hide unlockSlow during tracing we skip one extra frame when tracing GoUnblock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ¦‚è¿°äº†æ…¢é€Ÿè·¯å¾„ä»¥å…è®¸å†…è”å¿«é€Ÿè·¯å¾„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä¸ºäº†åœ¨è·Ÿè¸ªè¿‡ç¨‹ä¸­éšè— unlockSlowï¼Œæˆ‘ä»¬åœ¨è·Ÿè¸ª GoUnblock æ—¶ä¼šè·³è¿‡ä¸€ä¸ªé¢å¤–çš„å¸§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">m</span><span class="p">.</span><span class="nf">unlockSlow</span><span class="p">(</span><span class="nx">new</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="unlockslow">unlockSlow()<a hidden class="anchor" aria-hidden="true" href="#unlockslow">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Mutex</span><span class="p">)</span> <span class="nf">unlockSlow</span><span class="p">(</span><span class="nx">new</span> <span class="kt">int32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ¤æ–­æœªåŠ é”çš„æƒ…å†µä¸‹ä¸èƒ½å¤šæ¬¡è°ƒç”¨unlock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ­£å¸¸é€»è¾‘è¿™é‡Œ new+mutexLocked åº”è¯¥ä¸º1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">new</span><span class="o">+</span><span class="nx">mutexLocked</span><span class="p">)</span><span class="o">&amp;</span><span class="nx">mutexLocked</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>	<span class="c1">// è¿™ç§æƒ…å†µåˆ¤æ–­ä¹‹å‰æ ¹æœ¬å°±æ²¡åŠ è¿‡é”ï¼Œåˆ™å»è§£é”è¿™ä¼šç›´æ¥æŠ¥é”™è¯¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;sync: unlock of unlocked mutex&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ­£å¸¸æ¨¡å¼ä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">new</span><span class="o">&amp;</span><span class="nx">mutexStarving</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä» old -&gt; new åŸå­æ“ä½œï¼Œä¸»è¦æ˜¯å”¤é†’goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">old</span> <span class="o">:=</span> <span class="nx">new</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">{</span>	<span class="c1">// ä»¥ä¸‹ä»£ç æ˜¯é€šè¿‡å”¤é†’goroutineå’Œå…¶ä»–æ­£åœ¨è¿è¡Œçš„goroutineå»äº‰æŠ¢é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// If there are no waiters or a goroutine has already
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// been woken or grabbed the lock, no need to wake anyone.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// In starvation mode ownership is directly handed off from unlocking
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// goroutine to the next waiter. We are not part of this chain,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// since we did not observe mutexStarving when we unlocked the mutex above.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// So get off the way.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦‚æœæ²¡æœ‰waitersï¼Œæˆ–goroutineå·²ç»è¢«å«é†’æˆ–æŠ¢äº†é”ï¼Œæ²¡æœ‰å¿…è¦å«é†’ä»»ä½•äººã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// åœ¨é¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰æƒä¼šä»è§£é”goroutineç›´æ¥ç§»äº¤ç»™ä¸‹ä¸€ä¸ªwaiterã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æˆ‘ä»¬ä¸æ˜¯è¿™ä¸ªé“¾çš„ä¸€éƒ¨åˆ†ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä¸Šé¢è§£é”äº’æ–¥é”æ—¶æ²¡æœ‰è§‚å¯Ÿåˆ°mutexStarvingã€‚æ‰€ä»¥åˆ«æŒ¡é“ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æ²¡æœ‰ç­‰å¾…çš„goroutine æˆ– (æœ‰å…¶ä»–çš„goroutineå·²è¿‘è·å¾—é” æˆ– æœ‰è¢«å”¤é†’çš„goroutine æˆ– å½“å‰å¤„äºé¥¥é¥¿æ¨¡å¼ä¸‹)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">old</span><span class="o">&gt;&gt;</span><span class="nx">mutexWaiterShift</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">old</span><span class="o">&amp;</span><span class="p">(</span><span class="nx">mutexLocked</span><span class="p">|</span><span class="nx">mutexWoken</span><span class="p">|</span><span class="nx">mutexStarving</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>	<span class="c1">// ç›´æ¥è¿”å›ï¼Œä¸éœ€è¦å†å»åç»­å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// Grab the right to wake someone.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ç­‰åœ¨è¢«å”¤é†’çš„goroutineæ•°é‡å‡ä¸€ï¼Œè®¾ç½®æœ‰è¢«å”¤é†’æ ‡å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">new</span> <span class="p">=</span> <span class="p">(</span><span class="nx">old</span> <span class="o">-</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="nx">mutexWaiterShift</span><span class="p">)</span> <span class="p">|</span> <span class="nx">mutexWoken</span>	<span class="c1">// è®¾ç½®éœ€è¦å”¤é†’ä¸€ä¸ªgoroutineçš„æ–°çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">CompareAndSwapInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">old</span><span class="p">,</span> <span class="nx">new</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// åŸå­è®¾ç½®æˆåŠŸï¼Œè¯´æ˜æ²¡æœ‰å…¶ä»–æ­£åœ¨äº‰æŠ¢æˆ–å½“å‰äº‰æŠ¢æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">runtime_Semrelease</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">.</span><span class="nx">sema</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>	<span class="c1">// å–å‡ºç­‰å¾…çš„goroutineæ”¾å…¥æœ¬åœ°Pç­‰å¾…è¢«è°ƒåº¦ï¼Œé¥­åè¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">old</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">state</span>	<span class="c1">// æ²¡æœ‰è·å–æˆåŠŸï¼Œåˆ™ç›´æ¥æ›¿æ¢æ—§stateï¼Œå†æ¬¡å°è¯•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">// é¥¥é¥¿æ¨¡å¼ä¸‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Starving mode: handoff mutex ownership to the next waiter, and yield
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// our time slice so that the next waiter can start to run immediately.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Note: mutexLocked is not set, the waiter will set it after wakeup.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// But mutex is still considered locked if mutexStarving is set,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// so new coming goroutines won&#39;t acquire it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// é¥¥é¥¿æ¨¡å¼ï¼šå°†mutexæ‰€æœ‰æƒç§»äº¤ç»™ä¸‹ä¸€ä¸ªwaiterï¼Œå¹¶è®©å‡ºæˆ‘ä»¬çš„æ—¶é—´ç‰‡ï¼Œä»¥ä¾¿ä¸‹ä¸€ä¸ªwaiterå¯ä»¥ç«‹å³å¼€å§‹è¿è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ³¨æ„ï¼šmutexLocked æ²¡æœ‰è®¾ç½®ï¼Œwaiterä¼šåœ¨å”¤é†’åè®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä½†æ˜¯å¦‚æœè®¾ç½®äº† mutexStarvingï¼Œmutex ä»ç„¶è¢«è®¤ä¸ºæ˜¯é”å®šçš„ï¼Œæ‰€ä»¥æ–°çš„ goroutines ä¸ä¼šè·å–å®ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å¤„äºé¥¥é¥¿æ¨¡å¼ä¸‹ä»è¿™é‡Œå”¤é†’çš„goroutineï¼Œstateä¸­mutexLockedä½ï¼Œä¸€å®šä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">runtime_Semrelease</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">.</span><span class="nx">sema</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>	<span class="c1">// é¥¥é¥¿æ¨¡å¼ä¸‹åªä»é¦–éƒ¨å–å‡ºgoroutineç­‰å¾…è¢«è°ƒåº¦å³å¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1">// è¿™é‡Œåœ¨é¥¥é¥¿æ¨¡å¼ä¸‹ä¸ºç”šä¸åˆ¤æ–­ç­‰å¾…çš„goroutineæ•°é‡ï¼Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åŸå› æ˜¯ï¼šå¤„äºé¥¥é¥¿æ¨¡å¼ä¸‹ç­‰å¾…çš„goroutineæ•°é‡ä¸€å®šæ˜¯&gt;=1çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å› ä¸ºæœ€åä¸€ä¸ªgoroutineä¼šæŠŠæ¨¡å¼åˆ‡æ¢æˆæ­£å¸¸æ¨¡å¼ï¼Œç›¸å…³ä»£ç ä½äºLockå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="trylock">TryLock()<a hidden class="anchor" aria-hidden="true" href="#trylock">#</a></h3>
<ol>
<li>TryLockè¯•å›¾é”å®šmå¹¶æŠ¥å‘Šæ˜¯å¦æˆåŠŸã€‚</li>
<li>è¯·æ³¨æ„ï¼Œè™½ç„¶ç¡®å®å­˜åœ¨æ­£ç¡®ä½¿ç”¨TryLockçš„æƒ…å†µï¼Œä½†å¾ˆå°‘ï¼Œè€Œä¸”TryLockçš„ä½¿ç”¨é€šå¸¸è¡¨æ˜äº’æ–¥é‡çš„ç‰¹å®šä½¿ç”¨ä¸­å­˜åœ¨æ›´æ·±å±‚çš„é—®é¢˜ã€‚</li>
<li>TryLock å¯ä»¥ç”¨äºåœ¨ä¸šåŠ¡æ¯”è¾ƒç¹å¿™æ—¶å»å°è¯•è·å–é”ï¼Œå¤±è´¥åˆ™æç¤ºç›¸å…³æ–‡æ¡ˆç­‰</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// TryLock tries to lock m and reports whether it succeeded.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Note that while correct uses of TryLock do exist, they are rare,
</span></span></span><span class="line"><span class="cl"><span class="c1">// and use of TryLock is often a sign of a deeper problem
</span></span></span><span class="line"><span class="cl"><span class="c1">// in a particular use of mutexes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Mutex</span><span class="p">)</span> <span class="nf">TryLock</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">old</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">state</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰é”å­˜åœ¨ æˆ– å½“å‰å¤„äºé¥¥é¥¿æ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">old</span><span class="o">&amp;</span><span class="p">(</span><span class="nx">mutexLocked</span><span class="p">|</span><span class="nx">mutexStarving</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span>	<span class="c1">// è·å–å¤±è´¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// There may be a goroutine waiting for the mutex, but we are
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// running now and can try to grab the mutex before that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// goroutine wakes up.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯èƒ½æœ‰ä¸€ä¸ªgoroutineåœ¨ç­‰å¾…äº’æ–¥é‡ï¼Œä½†æˆ‘ä»¬ç°åœ¨æ­£åœ¨è¿è¡Œï¼Œå¹¶ä¸”å¯ä»¥å°è¯•åœ¨goroutineå”¤é†’ä¹‹å‰è·å–äº’æ–¥é‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å°è¯•å»äº‰æŠ¢é”ï¼Œè¿™é‡Œçš„oldä¸€å®šæ˜¯æ²¡åŠ é”å¹¶å¤„äºæ­£å¸¸æ¨¡å¼ä¸‹å»å°è¯•äº‰æŠ¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">CompareAndSwapInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">old</span><span class="p">,</span> <span class="nx">old</span><span class="p">|</span><span class="nx">mutexLocked</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span>	<span class="c1">// äº‰æŠ¢å¤±è´¥æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">race</span><span class="p">.</span><span class="nx">Enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">race</span><span class="p">.</span><span class="nf">Acquire</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">m</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span>	<span class="c1">// äº‰æŠ¢æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="type-locker-interface">type Locker interface<a hidden class="anchor" aria-hidden="true" href="#type-locker-interface">#</a></h2>
<ol>
<li>Lockeræ¥å£ä»£è¡¨ä¸€ä¸ªå¯ä»¥åŠ é”å’Œè§£é”çš„å¯¹è±¡</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// A Locker represents an object that can be locked and unlocked.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Locker</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ä½¿ç”¨ç¤ºä¾‹">ä½¿ç”¨ç¤ºä¾‹<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨ç¤ºä¾‹">#</a></h2>
<h3 id="syncmutex">sync.Mutex<a hidden class="anchor" aria-hidden="true" href="#syncmutex">#</a></h3>
<ul>
<li>äº’æ–¥é”ï¼šæ˜¯ä¼ ç»Ÿçš„å¹¶å‘ç¨‹åºå¯¹<strong>å…±äº«èµ„æº</strong>è¿›è¡Œè®¿é—®æ§åˆ¶çš„ä¸»è¦æ‰‹æ®µï¼Œ<code>Go</code>è¯­è¨€ä¸­æ¨èä½¿ç”¨é€šé“(channel)æ¥å®ç°<strong>èµ„æºå…±äº«</strong>å’Œ<strong>é€šä¿¡</strong></li>
<li>äº’æ–¥é”ï¼šç”±æ ‡å‡†åº“ <strong>sync</strong> åŒ…ä¸­åˆ†çš„ <strong>Mutex</strong> ç»“æ„ä½“ç±»å‹å®ç°
<ul>
<li>åªæœ‰ä¸¤ä¸ªå…¬å¼€æ–¹æ³•ï¼š
<ol>
<li><strong>Lock()</strong> ï¼šè·å¾—é”</li>
<li><strong>Unlock()</strong> ï¼šé‡Šæ”¾é”</li>
</ol>
</li>
</ul>
</li>
<li><strong>åŒä¸€ä¸ªåç¨‹</strong>ä¸­<strong>åŒæ­¥è°ƒç”¨</strong>ä½¿ç”¨Lock()åŠ é”åï¼Œä¸èƒ½å†å¯¹å…¶åŠ é”ï¼Œå¦åˆ™ä¼šå¼•å‘è¿è¡Œæ—¶å¼‚å¸¸ï¼Œåªèƒ½åœ¨ Unlock() ä¹‹åå†æ¬¡ Lock()</li>
<li><strong>å¤šä¸ªåç¨‹</strong>ä¸­<strong>å¼‚æ­¥</strong>è°ƒç”¨Lock()æ²¡æœ‰é—®é¢˜ï¼Œä½†æ¯ä¸ªåç¨‹åªèƒ½è°ƒç”¨ä¸€æ¬¡Lock()ï¼Œç”±äºå¤šä¸ªåç¨‹ä¹‹é—´äº§ç”Ÿäº†é”ç«äº‰ï¼Œå› æ­¤ä¸ä¼šæœ‰è¿è¡Œæ—¶å¼‚å¸¸</li>
<li>äº’æ–¥é”ï¼šé€‚ç”¨äºåªå…è®¸æœ‰ä¸€ä¸ªè¯»æˆ–è€…å†™çš„åœºæ™¯ï¼Œæ‰€ä»¥è¯¥é”ä¹Ÿå«å…¨å±€é”</li>
<li>å¦‚æœåœ¨ä½¿ç”¨ Unlock() å‰æœªåŠ é”ï¼Œå°±ä¼šå¼•èµ·ä¸€ä¸ªè¿è¡Œé”™è¯¯ï¼Œå·²ç»é”å®šçš„ Mutex å¹¶ä¸ä¸ç‰¹å®šçš„åç¨‹ç›¸å…³ï¼Œè¿™æ ·å¯ä»¥åˆ©ç”¨ä¸€ä¸ªåç¨‹å¯¹å…¶åŠ é”ï¼Œåœ¨åˆ©ç”¨å…¶å®ƒåç¨‹å¯¹å…¶è§£é”</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// LockA() ä¸­æœ‰ Lock()
</span></span></span><span class="line"><span class="cl"><span class="c1">// LockB() ä¸­ä¹Ÿæœ‰ Lock()
</span></span></span><span class="line"><span class="cl"><span class="c1">// LockB() çš„ Lock() è¿è¡Œæ—¶ï¼Œé”è¿˜æ²¡æœ‰ Unlock()ï¼Œç¨‹åºå‘ç”Ÿ panic
</span></span></span><span class="line"><span class="cl"><span class="c1">// è¿™æ˜¯åœ¨åŒæ­¥è°ƒç”¨äº’æ–¥é”ä¸­å¸¸è§çš„é—®é¢˜ï¼Œä¸€èˆ¬åœ¨ä¸€å¯¹äº’æ–¥é”ä¸­é—´ä¸è¦è°ƒç”¨å…¶å®ƒå‡½æ•°ï¼Œå³ä½¿è¦ç”¨ä¹Ÿå°½é‡é‡‡ç”¨å¼‚æ­¥æ–¹å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">mutex</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">LockA</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">LockA</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>		<span class="c1">// åŠ é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Lock in A&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">LockB</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Wake up in A&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>		<span class="c1">// è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Unlock in A&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">LockB</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;B&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>		<span class="c1">// åŠ é”	main goroutineåœ¨è¿™é‡Œè¢«é˜»å¡ï¼Œå¯¼è‡´deadlock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Lock in B&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>		<span class="c1">// è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Unlock in B&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">Lock in A
</span></span></span><span class="line"><span class="cl"><span class="cm">B
</span></span></span><span class="line"><span class="cl"><span class="cm">fatal error: all goroutines are asleep - deadlock!
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">goroutine 1 [semacquire]:
</span></span></span><span class="line"><span class="cl"><span class="cm">sync.runtime_SemacquireMutex(0x593b24, 0x0, 0x1)
</span></span></span><span class="line"><span class="cl"><span class="cm">        D:/True-False/Go/src/runtime/sema.go:71 +0x4e
</span></span></span><span class="line"><span class="cl"><span class="cm">sync.(*Mutex).lockSlow(0x593b20)
</span></span></span><span class="line"><span class="cl"><span class="cm">        D:/True-False/Go/src/sync/mutex.go:138 +0x103
</span></span></span><span class="line"><span class="cl"><span class="cm">sync.(*Mutex).Lock(...)
</span></span></span><span class="line"><span class="cl"><span class="cm">        D:/True-False/Go/src/sync/mutex.go:81
</span></span></span><span class="line"><span class="cl"><span class="cm">main.LockB()
</span></span></span><span class="line"><span class="cl"><span class="cm">        D:/True-False/WWW/GoLang/src/xuexi/mutex.go:28 +0x194
</span></span></span><span class="line"><span class="cl"><span class="cm">main.LockA()
</span></span></span><span class="line"><span class="cl"><span class="cm">        D:/True-False/WWW/GoLang/src/xuexi/mutex.go:19 +0xa2
</span></span></span><span class="line"><span class="cl"><span class="cm">main.main()
</span></span></span><span class="line"><span class="cl"><span class="cm">        D:/True-False/WWW/GoLang/src/xuexi/mutex.go:12 +0x29
</span></span></span><span class="line"><span class="cl"><span class="cm">exit status 2
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>æŠŠä¸Šé¢åŒæ­¥æ”¹ä¸ºå¼‚æ­¥ï¼ŒæŠŠLockA()çš„LockB()æ”¹ä¸º<strong>go LockB()</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">mutex</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">LockA</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">LockA</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>		<span class="c1">// åŠ é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Lock in A&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="nf">LockB</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Wake up in A&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>		<span class="c1">// è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Unlock in A&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">LockB</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;B&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>		<span class="c1">// åŠ é”	lockB goroutineç­‰å¾…LockAè§£é”ï¼Œå…ˆè‡ªæ—‹å†æ˜¯è¢«æŒ‚èµ·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Lock in B&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>		<span class="c1">// è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Unlock in B&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">Lock in A
</span></span></span><span class="line"><span class="cl"><span class="cm">B
</span></span></span><span class="line"><span class="cl"><span class="cm">Wake up in A
</span></span></span><span class="line"><span class="cl"><span class="cm">Unlock in A
</span></span></span><span class="line"><span class="cl"><span class="cm">Lock in B
</span></span></span><span class="line"><span class="cl"><span class="cm">Unlock in B
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å»ºè®®ï¼šåŒä¸€ä¸ªäº’æ–¥é”çš„æˆå¯¹é”å®šå’Œè§£é”æ“ä½œå¯ä»¥æ”¾åœ¨åŒä¸€å±‚æ¬¡çš„ä»£ç å—ä¸­</li>
<li>ç»å…¸ç”¨æ³•å¦‚ä¸‹ï¼š</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">lck</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">lck</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>			<span class="c1">// åŠ é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">defer</span> <span class="nx">lck</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>	<span class="c1">// è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ... ... 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// lck.Lock() ä¼šé˜»å¡ç›´åˆ°è·å–é”ï¼Œç„¶ååˆ©ç”¨deferè¯­å¥åœ¨å‡½æ•°è¿”å›æ—¶è‡ªåŠ¨é‡Šæ”¾é”
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ç¤ºä¾‹ä»£ç ï¼Œé€šè¿‡ä¸‰ä¸ªåç¨‹æ¥ä½“ç°sync.Mutexå¯¹èµ„æºçš„è®¿é—®æ§åˆ¶ç‰¹å¾</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//var wg sync.WaitGroup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">wg</span> <span class="o">:=</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">mutex</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Locking (G0)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>		<span class="c1">// åŠ é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;locked (G0)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">i</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Locking (G%d)\n&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">mutex</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>				<span class="c1">// åŠ é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Locked (G%d)\n&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>	<span class="c1">// å»¶è¿Ÿ2s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">mutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>				<span class="c1">// è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;unlocked (G%d)\n&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}(</span><span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;ready unlock (G0)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mutex</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>				<span class="c1">// è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;unlocked (G0)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">// ç¨‹åºè¿è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼Œå½“æœ‰é”é‡Šæ”¾æ—¶ï¼Œæ‰èƒ½è¿›è¡ŒåŠ é”åŠ¨ä½œ
</span></span><span class="line"><span class="cl">// è¿è¡Œç»“æœå¦‚ä¸‹
</span></span><span class="line"><span class="cl">Locking (G0)
</span></span><span class="line"><span class="cl">locked (G0)
</span></span><span class="line"><span class="cl">Locking (G1)
</span></span><span class="line"><span class="cl">Locking (G2)
</span></span><span class="line"><span class="cl">Locking (G3)
</span></span><span class="line"><span class="cl">ready unlock (G0)
</span></span><span class="line"><span class="cl">unlocked (G0)Locked (G1)
</span></span><span class="line"><span class="cl">unlocked (G1)
</span></span><span class="line"><span class="cl">Locked (G2)
</span></span><span class="line"><span class="cl">unlocked (G2)
</span></span><span class="line"><span class="cl">Locked (G3)
</span></span><span class="line"><span class="cl">unlocked (G3)
</span></span></code></pre></div><ul>
<li>Mutex ä¹Ÿå¯ä»¥ä½œä¸ºç»“æ„ä½“çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ ·ç»“æ„ä½“åœ¨è¢«å¤šçº¿ç¨‹å¤„ç†æ—¶æ•°æ®å®‰å…¨æ‰æœ‰ä¿éšœ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Book</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">BookName</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="nx">L</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">bk</span> <span class="o">*</span><span class="nx">Book</span><span class="p">)</span> <span class="nf">SetName</span><span class="p">(</span><span class="nx">wg</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Unlock set name:&#34;</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">bk</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>		<span class="c1">// è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">bk</span><span class="p">.</span><span class="nx">L</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>		<span class="c1">// åŠ é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Lock set name:&#34;</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bk</span><span class="p">.</span><span class="nx">BookName</span> <span class="p">=</span> <span class="nx">name</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bk</span> <span class="o">:=</span> <span class="nx">Book</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//bk.L = &amp;sync.Mutex{}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bk</span><span class="p">.</span><span class="nx">L</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//wg := new(sync.WaitGroup)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">wg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">books</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;&lt;&lt;ä¸‰å›½æ¼”ä¹‰&gt;&gt;&#34;</span><span class="p">,</span> <span class="s">&#34;&lt;&lt;é“å¾·ç»&gt;&gt;&#34;</span><span class="p">,</span> <span class="s">&#34;&lt;&lt;è¥¿æ¸¸è®°&gt;&gt;&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">book</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">books</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">go</span> <span class="nx">bk</span><span class="p">.</span><span class="nf">SetName</span><span class="p">(</span><span class="nx">wg</span><span class="p">,</span> <span class="nx">book</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Lock set name: &lt;&lt;è¥¿æ¸¸è®°&gt;&gt;
</span></span><span class="line"><span class="cl">Unlock set name: &lt;&lt;è¥¿æ¸¸è®°&gt;&gt;
</span></span><span class="line"><span class="cl">Lock set name: &lt;&lt;ä¸‰å›½æ¼”ä¹‰&gt;&gt;
</span></span><span class="line"><span class="cl">Unlock set name: &lt;&lt;ä¸‰å›½æ¼”ä¹‰&gt;&gt;
</span></span><span class="line"><span class="cl">Lock set name: &lt;&lt;é“å¾·ç»&gt;&gt;
</span></span><span class="line"><span class="cl">Unlock set name: &lt;&lt;é“å¾·ç»&gt;&gt;
</span></span></code></pre></div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;sync&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">m</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">m</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">defer</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">m</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>		<span class="c1">// è¿™é‡Œå½“å‰goroutineå°†è¢«æ°¸ä¹…ä¿å­˜åˆ°ä¿¡å·æ± ä¸­å¾—ä¸åˆ°è¿è¡Œæœºä¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">defer</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Output:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹<a hidden class="anchor" aria-hidden="true" href="#æ³¨æ„äº‹é¡¹">#</a></h2>
<ul>
<li>Lock() å’Œ UnLock() æ–¹æ³•åº”è¯¥æˆå¯¹å‡ºç°ã€‚</li>
<li>sync.Mutex ä¸å…è®¸è¢«å€¼æ‹·è´ï¼Œæ‹·è´åœ°å€å¯ä»¥ã€‚</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://heliu.site/tags/golang/">Golang</a></li>
      <li><a href="https://heliu.site/tags/sync/">Sync</a></li>
      <li><a href="https://heliu.site/tags/mutex/">Mutex</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://heliu.site/posts/golang/sync/once/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>sync.Once</span>
  </a>
  <a class="next" href="https://heliu.site/posts/golang/sync/waitgroup/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>sync.WaitGroup</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
    </span>
    <span id="busuanzi_container_site_uv">
        æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
    </span>
    </div>
        <span>Copyright Â© 2020-2024 <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
