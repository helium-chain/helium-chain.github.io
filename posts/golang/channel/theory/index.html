<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Channel(åŸç†) | Helium</title>
<meta name="keywords" content="golang, Channel">
<meta name="description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬">
<meta name="author" content="helium">
<link rel="canonical" href="https://helium-chain.github.io/posts/golang/channel/theory/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://helium-chain.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://helium-chain.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://helium-chain.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://helium-chain.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://helium-chain.github.io/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://helium-chain.github.io/posts/golang/channel/theory/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="Channel(åŸç†)" />
<meta property="og:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://helium-chain.github.io/posts/golang/channel/theory/" />
<meta property="og:image" content="https://helium-chain.github.io/favicon-32x32.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-08-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-08-01T00:00:00+00:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://helium-chain.github.io/favicon-32x32.png" />
<meta name="twitter:title" content="Channel(åŸç†)"/>
<meta name="twitter:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://helium-chain.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Golang",
      "item": "https://helium-chain.github.io/posts/golang/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ç¬¬13ç«  Channel",
      "item": "https://helium-chain.github.io/posts/golang/channel/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Channel(åŸç†)",
      "item": "https://helium-chain.github.io/posts/golang/channel/theory/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Channel(åŸç†)",
  "name": "Channel(åŸç†)",
  "description": "ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18+ç‰ˆæœ¬",
  "keywords": [
    "golang", "Channel"
  ],
  "articleBody": "åŒ…è§£é‡Šï¼š\nè¯¥æ–‡ä»¶åŒ…å« Go channels çš„å®ç°ã€‚ c.sendq å’Œ c.recvq ä¸­è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯ç©ºçš„ï¼Œé™¤äº†ä½¿ç”¨ select è¯­å¥å‘é€å’Œæ¥æ”¶çš„æ— ç¼“å†² chan ä¸Šé˜»æ­¢äº†å•ä¸ª goroutine çš„æƒ…å†µå¤–ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œc.sendq å’Œc.recvq çš„é•¿åº¦ä»…å— select è¯­å¥çš„å¤§å°é™åˆ¶ã€‚ select åŒæ—¶æ“ä½œå•ä¸ªæ— ç¼“å†² chan çš„è¯»å’Œå†™è¿™ç§æƒ…å†µä¸‹å¯èƒ½å­˜åœ¨ c.sendq å’Œ c.recvq éƒ½ä¸ä¸ºç©ºï¼ˆè¿™ç§æƒ…å†µä¸‹ selectä¸èƒ½æœ‰ default åˆ†æ”¯ï¼‰ã€‚ å¯¹äºç¼“å†² channelsï¼Œä¹Ÿæ˜¯: c.qcount \u003e 0 è¡¨ç¤º c.recvq ä¸ºç©ºã€‚ç¼“å­˜åŒºæœ‰å€¼åˆ™ c.recvq ä¸€å®šä¸ºç©ºã€‚ c.qcount \u003c c.dataqsiz æ„å‘³ç€ c.sendq æ˜¯ç©ºçš„ã€‚ç¼“å­˜åŒºæ²¡æœ‰æ»¡åˆ™ c.sendq ä¸€å®šä¸ºç©ºã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 package runtime // This file contains the implementation of Go channels. // Invariants: // At least one of c.sendq and c.recvq is empty, // except for the case of an unbuffered channel with a single goroutine // blocked on it for both sending and receiving using a select statement, // in which case the length of c.sendq and c.recvq is limited only by the // size of the select statement. // // For buffered channels, also: // c.qcount \u003e 0 implies that c.recvq is empty. // c.qcount \u003c c.dataqsiz implies that c.sendq is empty. type hchan struct hchan ç»“æ„å…¶å®å°±æ˜¯ä¸€ä¸ªã€æœ‰ç¼“å†²ã€‘å’Œã€åŒå‘é“¾è¡¨ã€‘ç»„æˆçš„é˜Ÿåˆ—ã€‚ è¿™ä¸ªé˜Ÿåˆ—ç»´æŠ¤ç€é€šä¿¡çš„æ•°æ®ï¼Œä»¥åŠæŒ‚èµ·ç­‰å¾…çš„ goroutineã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 type hchan struct { // å·²æœ‰å…ƒç´ ä¸ªæ•°ï¼ˆä¹Ÿå°±æ˜¯é€šé“ä¸­å…ƒç´ ä¸ªæ•°ï¼‰len(chan) // ç¼“å­˜åŒºå…ƒç´ ä¸ªæ•°ï¼Œä¸åŒ…æ‹¬sendqä¸Šé¢çš„goroutineæ•°é‡(å¦‚æœå­˜åœ¨) qcount uint // total data in the queue // æ•°ç»„å®¹é‡ï¼ˆä¹Ÿå°±æ˜¯chanå®¹é‡ï¼‰cap(chan)\t// ä¹Ÿå°±æ˜¯ make(chan int, size) è¿™é‡Œçš„size dataqsiz uint // size of the circular queue // æœ‰ç¼“å†²æ•°ç»„åœ°å€æŒ‡é’ˆï¼Œè¿™é‡Œæ˜¯æ ¹æ® dataqsiz*elemsize è®¡ç®—åˆ†é…çš„å†…å­˜æ•°ç»„å¤§å° buf unsafe.Pointer // points to an array of dataqsiz elements // å…ƒç´ å¤§å°ï¼Œæ¯”å¦‚intè¿™é‡Œå­˜å‚¨çš„å°±æ˜¯8ï¼Œstringçš„è¯è¿™é‡Œå­˜å‚¨çš„å°±æ˜¯16 elemsize uint16 // é€šé“æ˜¯å¦è¢«å…³é—­ 1.è¢«å…³é—­ 0.æ­£å¸¸ closed uint32 // chanå…ƒç´ ç±»å‹ï¼ŒæŒ‡å‘ç±»å‹å…ƒæ•°æ®ï¼Œæ¯”å¦‚chan intè¿™é‡Œè®°å½•çš„å°±æ˜¯intçš„å…ƒç±»å‹ elemtype *_type // element type // å½“å‰ç´¢å¼•ï¼ˆè®°å½•ä¸‹ä¸€æ¬¡sendä¸‹æ ‡ï¼‰ï¼Œä¸‹ä¸€æ¬¡å†™å–ä½ç½®ã€‚ sendx uint // send index // å½“å‰ç´¢å¼•ï¼ˆè®°å½•ä¸‹ä¸€æ¬¡recvä¸‹æ ‡ï¼‰ï¼Œä¸‹ä¸€æ¬¡è¯»å…¥ä½ç½®ã€‚ recvx uint // receive index // ç­‰å¾…å†™çš„é˜Ÿåˆ—ï¼Œæ˜¯ä¸€ä¸ªåŒå‘çš„goroutineé“¾è¡¨ recvq waitq // list of recv waiters // ç­‰å¾…è¯»çš„é˜Ÿåˆ—ï¼Œæ˜¯ä¸€ä¸ªåŒå‘çš„goroutineé“¾è¡¨ sendq waitq // list of send waiters // lock protects all fields in hchan, as well as several // fields in sudogs blocked on this channel. // // Do not change another G's status while holding this lock // (in particular, do not ready a G), as this can deadlock // with stack shrinking. // // lockä¿æŠ¤hchanä¸­çš„æ‰€æœ‰å­—æ®µï¼Œä»¥åŠsudogsä¸­çš„ä¸€äº›å­—æ®µåœ¨è¿™ä¸ªé€šé“ä¸Šè¢«é˜»å¡ã€‚ // åœ¨æŒæœ‰è¯¥é”æ—¶ï¼Œä¸è¦æ”¹å˜å¦ä¸€ä¸ªGçš„çŠ¶æ€(ç‰¹åˆ«æ˜¯ä¸è¦å‡†å¤‡ä¸€ä¸ªG)ï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šå¯¼è‡´æ ˆæ”¶ç¼©æ­»é”ã€‚ lock mutex\t// runtime.mutex ä¸ºäº†åº”å¯¹å¹¶å‘çš„è¯»å†™chanï¼Œå‚çœ‹runtime.mutexç›¸å…³æ–‡æ¡£ } hchan ç¼“å­˜åŒºå†…å­˜å¸ƒå±€å›¾ï¼ˆå¦‚æœå­˜åœ¨ç¼“å­˜åŒºæ—¶ï¼‰ raceaddr() è¯¥å‡½æ•°ä¸»è¦ç”¨äº make() å‡½æ•°ä¸­ï¼Œå½“ç”³è¯·æ€»å†…å­˜ä¸º0æ—¶ï¼Œè¿”å›å½“å‰bufå­—æ®µåœ°å€ä½œä¸º buf çš„å€¼ã€‚å½¢æˆæŒ‡é’ˆæŒ‡å‘é—­ç¯ã€‚ 1 2 3 4 5 6 7 8 9 10 11 func (c *hchan) raceaddr() unsafe.Pointer { // Treat read-like and write-like operations on the channel to // happen at this address. Avoid using the address of qcount // or dataqsiz, because the len() and cap() builtins read // those addresses, and we don't want them racing with // operations like close(). // // å°†channelä¸Šçš„read-likeå’Œwrite-likeæ“ä½œè§†ä¸ºåœ¨æ­¤åœ°å€å‘ç”Ÿã€‚ // é¿å…ä½¿ç”¨qcountæˆ–dataqsizçš„åœ°å€ï¼Œå› ä¸ºlen()å’Œcap()å†…ç½®å‡½æ•°ä¼šè¯»å–è¿™äº›åœ°å€ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›å®ƒä»¬ä¸close()ç­‰æ“ä½œç«äº‰ã€‚ return unsafe.Pointer(\u0026c.buf) } sortkey() è¯¥å‡½æ•°åœ¨ goselect() å‡½æ•°ä¸­ä½¿ç”¨ï¼Œç”¨äºè¿”å› chan åœ°å€å‡åºæ’åº channelsã€‚ select ä¸­ç›¸å…³ç”¨åˆ°çš„å‡½æ•°ã€‚åœ¨åé¢ä»‹ç»selectæ—¶ï¼Œä¼šè¢«ä½¿ç”¨ã€‚ 1 2 3 func (c *hchan) sortkey() uintptr { return uintptr(unsafe.Pointer(c)) } Constant 1 2 3 4 5 6 7 8 9 10 11 const ( // æœ€å¤§å¯¹é½å­—èŠ‚æ•°ï¼Œä¸»è¦ç”¨äºä¸‹é¢çš„å®šä¹‰ã€‚ maxAlign = 8 // hchan å ç”¨å†…å­˜å¤§å°å­—èŠ‚ï¼Œä½¿ hchan æŒ‰ç…§ maxAlign å¤§å°å¯¹é½ // æ¯”å¦‚ hchan æ˜¯ 12byteï¼Œé‚£ä¹ˆ hchanSize åˆ™æ˜¯ 16byte // ä¸ºä»€ä¹ˆè¦ä½¿ hchan å¯¹é½ maxAlignï¼ŸåŸå› æ˜¯ hchan åæ¥ç€æ˜¯ chan å…ƒç´ çš„å†…å­˜ç©ºé—´å—(å¦‚æœæ˜¯æœ‰ç¼“å†²æƒ…å†µä¸‹) // è¿™ç§æƒ…å†µæ˜¯ä¸ºäº†å…¼å®¹32ä½ï¼Œå› ä¸ºåœ¨64ä½ä¸‹hchanå°±æ˜¯8å­—èŠ‚å¯¹é½çš„ï¼Œè¯¥å­—æ®µç”¨äºmakeå‡½æ•°ä¸­ç”³è¯· chan å†…å­˜éœ€è¦ã€‚ hchanSize = unsafe.Sizeof(hchan{}) + uintptr(-int(unsafe.Sizeof(hchan{}))\u0026(maxAlign-1)) debugChan = false\t// debug ) type waitq struct waitq æ ¹æ® sudog å½¢æˆä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚ å…¶å®å°±æ˜¯ä¸€ä¸ªé˜Ÿåˆ—çš„åŠŸèƒ½ï¼Œå…ƒç´ ã€ä» last å¤„æ·»åŠ ã€‘ï¼Œã€ä» first å¤„å–å‡ºã€‘ã€‚ 1 2 3 4 type waitq struct { first *sudog // æŒ‡å‘é“¾è¡¨çš„é¦–ä¸ª *sudog last *sudog // æŒ‡å‘é“¾è¡¨çš„å°¾éƒ¨ *sudog } dequeue() ä» first ä¸­å–å‡ºä¸€ä¸ª *sudogã€‚ç›¸å½“äºä»é˜Ÿåˆ—å¤´ï¼ˆfirstï¼‰å–å‡ºä¸€ä¸ª *sudogã€‚ è°ƒç”¨è¯¥æ–¹æ³•æ—¶ chan lock é”ä¸€å®šæ˜¯è¢«æŒæœ‰çš„ã€‚ä¸‹é¢å‡½æ•°ä¸­éœ€è¦ for {} çš„åŸå› æ˜¯æœ€åä¸€ä¸ª if æ¡ä»¶çš„ CAS æ“ä½œã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 func (q *waitq) dequeue() *sudog { for { sgp := q.first // ä»firstå¤„å–ä¸€ä¸ª *sudog if sgp == nil { return nil } y := sgp.next if y == nil { // æœ€åä¸€ä¸ª *sudog q.first = nil q.last = nil } else { y.prev = nil q.first = y // æ ‡è®°å·²åˆ é™¤ï¼ˆå‚çœ‹ dequeueSudoGï¼‰ sgp.next = nil // mark as removed (see dequeueSudoG) } // ä¸ºä»€ä¹ˆéœ€è¦ä¸‹é¢çš„åˆ¤æ–­æ¡ä»¶ï¼Ÿ // 1. select è¯­å¥ä¸­é˜»å¡äº†ä¸€ç»„ chan æ—¶ï¼Œæ‰€æœ‰ channels çš„ lock é”éƒ½å·²è¢«æŒæœ‰ã€‚ // 2. å½“å‰æ‰§è¡Œselectè¯­å¥çš„goroutineä¼šè¢«å°è£…åˆ°å¤šä¸ª*sudogä¸­é€šè¿‡waitlinkå­—æ®µå½¢æˆé“¾è¡¨ï¼Œç„¶åæŠŠå„ä¸ª*sudogçš„isSelectå­—æ®µæ ‡è®°ä¸ºtrueã€‚ // 3. æŠŠå„ä¸ª*sudogåˆ†åˆ«æŒ‚åœ¨å„è‡ªçš„sendqæˆ–recvqé“¾è¡¨ä¸­ã€‚ç­‰å¾…goroutineè¢«å”¤é†’ã€‚ // 4. æŸä¸€æ—¶åˆ»*sudogè¢«é€‰ä¸­å”¤é†’ï¼Œåˆ™ä¸€å®šä¼šæ‰§è¡Œå½“å‰å‡½æ•° *sudog.isSelect æ˜¯ trueï¼Œå¹¶ä¸”é€šè¿‡ CAS æŠŠ g.selectDone ä»0æ ‡è®°ä¸º1ã€‚ // 5. æ³¨æ„æ­¤æ—¶å”¤é†’çš„goroutineå¯èƒ½åœ¨å¤šä¸ªchannelä¸Šé¢ç­‰å¾…ã€‚æ­¤æ—¶å¯èƒ½ä¼šå‡ºç°åœ¨å…¶ä»–chanä¸Šè¿™ä¸ªgoroutineä¹Ÿè¢«é€‰ä¸­äº†ï¼Œä¹Ÿåœ¨æ‰§è¡Œå½“å‰å‡½æ•°ã€‚ // 6. åˆ™è¿™é‡Œä¼šç›´æ¥è·³è¿‡ã€‚å› ä¸ºå½“å‰goroutineå·²è¢«å”¤é†’ï¼Œåç»­ä¼šåœ¨å”¤é†’çš„goroutineç§»é™¤è¿™é‡Œgoroutineçš„goselectå‡½æ•°ä¸­ã€‚ // 7. goroutine å”¤é†’åä¼šè·å–æ‰€æœ‰çš„ channels lockï¼Œç„¶åæŠŠselectDoneè®¾ç½®ä¸º0ï¼Œæ­¤æ—¶å› ä¸ºæ‰€æœ‰çš„channel lockå·²è¢«æŒæœ‰æ‰€ä»¥èƒ½ç«‹å³ä¿®æ”¹selectDoneã€‚ // if a goroutine was put on this queue because of a // select, there is a small window between the goroutine // being woken up by a different case and it grabbing the // channel locks. Once it has the lock // it removes itself from the queue, so we won't see it after that. // We use a flag in the G struct to tell us when someone // else has won the race to signal this goroutine but the goroutine // hasn't removed itself from the queue yet. // // å¦‚æœä¸€ä¸ªgoroutineå› ä¸ºselectè¢«æ”¾åˆ°è¿™ä¸ªé˜Ÿåˆ—ä¸Šï¼Œé‚£ä¹ˆåœ¨goroutineè¢«ä¸åŒçš„æƒ…å†µå”¤é†’å’Œå®ƒè·å–é€šé“é”ä¹‹é—´æœ‰ä¸€ä¸ªå°çª—å£ã€‚ // ä¸€æ—¦å®ƒæœ‰äº†é”ï¼Œå®ƒå°±ä¼šä»é˜Ÿåˆ—ä¸­ç§»é™¤è‡ªå·±ï¼Œæ‰€ä»¥åœ¨é‚£ä¹‹åæˆ‘ä»¬å°±çœ‹ä¸åˆ°å®ƒäº†ã€‚ // æˆ‘ä»¬åœ¨Gç»“æ„ä½“ä¸­ä½¿ç”¨ä¸€ä¸ªæ ‡å¿—æ¥å‘Šè¯‰æˆ‘ä»¬ï¼Œå½“æœ‰å…¶ä»–äººèµ¢å¾—æ¯”èµ›æ—¶ï¼Œå‘è¿™ä¸ªgoroutineå‘å‡ºä¿¡å·ï¼Œä½†è¯¥goroutineè¿˜æ²¡æœ‰ä»é˜Ÿåˆ—ä¸­åˆ é™¤è‡ªå·±ã€‚ if sgp.isSelect \u0026\u0026 !atomic.Cas(\u0026sgp.g.selectDone, 0, 1) { continue } return sgp } } enqueue() ä» last æ”¾å…¥ *sudogã€‚ç›¸å½“äºä»é˜Ÿåˆ—å°¾ï¼ˆlastï¼‰æ·»åŠ å…ƒç´ ã€‚ è°ƒç”¨è¯¥æ–¹æ³•æ—¶ chan lock å·²è¢«æŒæœ‰ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 func (q *waitq) enqueue(sgp *sudog) { sgp.next = nil x := q.last if x == nil { // waitq æ˜¯ç©ºçš„ sgp.prev = nil q.first = sgp q.last = sgp return } sgp.prev = x x.next = sgp q.last = sgp } dequeueSudoG() åœ¨ selectgo() å‡½æ•°ä¸­è¢«ç”¨åˆ°ï¼Œç”¨äºå°†æŒ‡å®šçš„ *sudog å–å‡ºã€‚ å› ä¸º select ä¸èƒ½ç«‹å³å®Œæˆæ—¶ä¼šæŒ‚åœ¨æ‰€æœ‰çš„ channelï¼Œå½“æœ‰ channel å°±ç»ªåå…¶ä»– recvqã€sendq ä¸Šçš„éœ€è¦è°ƒç”¨è¿™ä¸ªå‡½æ•°å‰”é™¤æ‰ã€‚ è°ƒç”¨è¯¥å‡½æ•°æ˜¯ç›¸å…³çš„ channel lock å·²è¢«æŒæœ‰ã€‚ å‚æ•°ï¼šsgp *sudog æ˜¯é€šè¿‡ waitlink å­—æ®µç»„æˆçš„ *sudog é“¾è¡¨ã€‚ è¯¥å‡½æ•°ä¹Ÿæ˜¯åœ¨ go1.19.3/src/runtime/select.go æ–‡ä»¶ä¸­ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 func (q *waitq) dequeueSudoG(sgp *sudog) { // å½“å‰ sgp å¯èƒ½å¤„åœ¨é“¾è¡¨çš„ä»»ä½•ä½ç½®ï¼Œæˆ–è€…ä¸åœ¨é“¾è¡¨ä¸­ã€‚ x := sgp.prev y := sgp.next if x != nil { if y != nil { // middle of queue // // åœ¨ queue çš„ä¸­é—´ x.next = y y.prev = x sgp.next = nil sgp.prev = nil return } // end of queue // // åœ¨ queue çš„æœ€å x.next = nil q.last = x sgp.prev = nil return } if y != nil { // start of queue // // åœ¨queueå¼€å¤´ y.prev = nil q.first = y sgp.next = nil return } // x==y==nil. Either sgp is the only element in the queue, // or it has already been removed. Use q.first to disambiguate. // // x==y==nilã€‚ // è¦ä¹ˆ sgp æ˜¯é˜Ÿåˆ—ä¸­å”¯ä¸€çš„æˆå‘˜ï¼Œè¦ä¹ˆå®ƒå·²ç»è¢«åˆ é™¤ã€‚ä½¿ç”¨ q.first æ¥æ¶ˆé™¤æ­§ä¹‰ã€‚ if q.first == sgp { q.first = nil q.last = nil } } type sudog struct sudog è¡¨ç¤ºç­‰å¾…åˆ—è¡¨ä¸­çš„ gï¼Œä¾‹å¦‚ç”¨äºåœ¨ channel ä¸Š sending/receiving ã€‚ sudog æ˜¯å¿…è¦çš„ï¼Œå› ä¸º gâ†”synchronization å¯¹è±¡å…³ç³»æ˜¯å¤šå¯¹å¤šçš„ã€‚ ä¸€ä¸ª g å¯èƒ½ä¼šå‡ºç°åœ¨è®¸å¤šç­‰å¾…åˆ—è¡¨ä¸­ï¼Œæ‰€ä»¥ä¸€ä¸ªgå¯èƒ½ä¼šæœ‰è®¸å¤š sudog; å¹¶ä¸”è®¸å¤š g å¯èƒ½åœ¨åŒä¸€ä¸ª same å¯¹è±¡ä¸Šç­‰å¾…ï¼Œå› æ­¤ä¸€ä¸ªå¯¹è±¡å¯èƒ½æœ‰è®¸å¤š sudogã€‚ sudog æ˜¯ä»ä¸€ä¸ªç‰¹æ®Šçš„æ± ä¸­åˆ†é…çš„ã€‚ä½¿ç”¨ acquireSudog å’Œ releaseSudog æ¥åˆ†é…å’Œé‡Šæ”¾å®ƒä»¬ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime2.goã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 // sudog represents a g in a wait list, such as for sending/receiving // on a channel. // // sudog is necessary because the g â†” synchronization object relation // is many-to-many. A g can be on many wait lists, so there may be // many sudogs for one g; and many gs may be waiting on the same // synchronization object, so there may be many sudogs for one object. // // sudogs are allocated from a special pool. Use acquireSudog and // releaseSudog to allocate and free them. type sudog struct { // The following fields are protected by the hchan.lock of the // channel this sudog is blocking on. shrinkstack depends on // this for sudogs involved in channel ops. g *g // ç­‰å¾…çš„goroutine next *sudog // é“¾æ¥ä¸‹ä¸€ä¸ª*sudog å¯¹äºäºŒå‰æ ‘å°±æ˜¯left prev *sudog // é“¾æ¥å‰ä¸€ä¸ª*sudog å¯¹äºäºŒå‰æ ‘å°±æ˜¯right // seampherä¸­ï¼šä¿å­˜æ¥è‡ªä¿¡å·é‡çš„åœ°å€ï¼›æ¯”å¦‚åœ¨sync.Mutexä¸­åˆ™æ˜¯\u0026sync.Mutex.semaè¯¥å­—æ®µçš„åœ°å€ã€‚ // channelsä¸­ï¼šåˆ™æ˜¯ä¿å­˜éœ€è¦ä¼ é€’çš„å€¼çš„åœ°å€ã€‚ï¼ˆéœ€è¦äº¤æ¢çš„æ•°æ®åœ°å€ï¼‰ elem unsafe.Pointer // data element (may point to stack) // The following fields are never accessed concurrently. // For channels, waitlink is only accessed by g. // For semaphores, all fields (including the ones above) // are only accessed when holding a semaRoot lock. // // ä»¥ä¸‹å­—æ®µæ°¸è¿œä¸ä¼šå¹¶å‘è®¿é—®ã€‚ // å¯¹äº channelsï¼Œwaitlink åªèƒ½ç”± g è®¿é—®ã€‚ // å¯¹äº semaphoresï¼Œæ‰€æœ‰å­—æ®µ(åŒ…æ‹¬ä¸Šé¢çš„å­—æ®µ)åªæœ‰åœ¨æŒæœ‰ semaRoot é”æ—¶æ‰èƒ½è®¿é—®ã€‚ // ä»¥ä¸‹æ—¶é—´éƒ½æ˜¯ä¸ºäº†åˆ†æ sudog acquiretime int64 // è·å¾— sudog çš„æ—¶é—´ releasetime int64 // é‡Šæ”¾æ—¶é—´\t// ticket ç”¨äºå½¢æˆæœ€å°å †ï¼Œä»rootå¾€ä¸‹æŒ‰ç…§ s.ticket \u003c= both s.prev.ticket AND s.next.ticket; æœ€å°å †å°±æ˜¯ä¸€ç§å®Œå…¨äºŒå‰æ ‘ // 1. ticket åœ¨ semaRoot.queue å‡½æ•°ä¸­ä½œä¸ºäºŒå‰æ ‘æå¹²æƒ…å†µä¸‹è¢«åˆå§‹åŒ–ä¸º s.ticket = fastrand() | 1; s.ticket \u003e= 0 // 2. ticket åœ¨ semaRoot.dequeue å‡½æ•°ä¸­è¿”å› sudog æ—¶ï¼Œè¢«é‡ç½®ä¸º0 // 3. ticket åœ¨ sync_runtime_SemacquireMutex å‡½æ•°ä¸­ å¦‚æœæ˜¯é¥¥é¥¿æ¨¡å¼åˆ™æ ‡è®°ä¸º1 // æœ€å°å †ç™¾åº¦ç™¾ç§‘ï¼šhttps://baike.baidu.com/item/%E6%9C%80%E5%B0%8F%E5%A0%86/9139372 ticket uint32 // isSelect indicates g is participating in a select, so // g.selectDone must be CAS'd to win the wake-up race. // // isSelect è¡¨ç¤º g æ­£åœ¨å‚ä¸ä¸€ä¸ª selectï¼Œå› æ­¤ g.selectDone å¿…é¡»ç»è¿‡ CAS å¤„ç†æ‰èƒ½èµ¢å¾—å”¤é†’ç«èµ›ã€‚ // å…·ä½“å‚è€ƒ goselect() å‡½æ•°ã€‚å½“å‰æ˜¯å› ä¸º select è¯­å¥è¢«æŒ‚èµ·æ—¶ï¼Œè¯¥å­—æ®µä¼šè¢«è®¾ç½®ä¸º trueã€‚ isSelect bool // åœ¨selectç»“æ„ä¸­è¢«ä½¿ç”¨ // success indicates whether communication over channel c // succeeded. It is true if the goroutine was awoken because a // value was delivered over channel c, and false if awoken // because c was closed. // // success c é€šé“é€šä¿¡æ˜¯å¦æˆåŠŸã€‚ // å¦‚æœ goroutine å› ä¸ºé€šè¿‡é€šé“ c ä¼ é€’å€¼è€Œè¢«å”¤é†’ï¼Œåˆ™ä¸º trueï¼Œå¦‚æœå› ä¸ºé€šé“ c è¢«å…³é—­è€Œè¢«å”¤é†’ï¼Œåˆ™ä¸º falseã€‚ success bool // åœ¨chanä¸­è¢«ä½¿ç”¨ï¼Œç”¨äºåˆ¤æ–­æœ¬æ¬¡é€šä¿¡æ˜¯å¦æˆåŠŸ // semaRootçš„äºŒå‰æ ‘ parent *sudog // semaRoot binary tree // g.waiting åˆ—è¡¨æˆ– semaRoot çš„ç­‰å¾…é“¾è¡¨ï¼ŒæŒ‡å‘é“¾è¡¨çš„å¤´ã€‚ // åœ¨ goselect() å‡½æ•°ä¸­ï¼ŒæŒ‚èµ·çš„ goroutine ç»„è£…çš„ *sudog é€šè¿‡ waitlink å­—æ®µå½¢æˆé“¾è¡¨ã€‚ // waitlink åªåœ¨ semapher æˆ– select è¯­å¥ä¸­è¢«ç”¨æ¥å½¢æˆé“¾è¡¨ã€‚ waitlink *sudog // g.waiting list or semaRoot // ç­‰å¾…å°¾éƒ¨ semaRootï¼ŒæŒ‡å‘é“¾è¡¨çš„å°¾éƒ¨ waittail *sudog // semaRoot // å½“å‰sudogæ‰€å±*hchanï¼Œselectä¸èƒ½å°±ç»ªè¦è¢«æŒ‚èµ·æ—¶ç”¨åˆ°ã€‚ c *hchan // channel } make() åˆå§‹åŒ– channelã€‚\nmakechan() å‡½æ•°åŸå‹ï¼šmake(chan Type, size int) å‚æ•°ï¼š t *chantypeï¼šchan å…ƒç±»å‹ç»“æ„ã€‚ size intï¼šchan å¤§å°ï¼Œé»˜è®¤0æ— ç¼“å†² chanï¼›\u003e=1 éƒ½æ˜¯æœ‰ç¼“å†² chanã€‚ type chantype struct { typ _type // chanå…ƒç±»å‹ elem *_type // chan å…ƒç´ å…ƒç±»å‹ dir uintptr // é€šé“æ–¹å‘ } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 func makechan(t *chantype, size int) *hchan { elem := t.elem // chanå…ƒç´ å…ƒç±»å‹ // compiler checks this but be safe. // // ç¼–è¯‘å™¨ä¼šæ£€æŸ¥è¿™ä¸€ç‚¹ï¼Œä½†è¿™æ˜¯å®‰å…¨çš„ã€‚ if elem.size \u003e= 1\u003c\u003c16 { // chanå…ƒç´ ç±»å‹å†…å­˜ \u003e= 1\u003c\u003c16æ—¶ä¸é€‚åˆchan throw(\"makechan: invalid channel element type\") } // hchan æ˜¯å¦å¯¹é½ maxAlign if hchanSize%maxAlign != 0 || elem.align \u003e maxAlign { throw(\"makechan: bad alignment\") } // mem = elem.size * uintptr(size) mem, overflow := math.MulUintptr(elem.size, uintptr(size)) if overflow || mem \u003e maxAlloc-hchanSize || size \u003c 0 { // å†…å­˜æº¢å‡º panic(plainError(\"makechan: size out of range\")) } // Hchan does not contain pointers interesting for GC when elements stored in buf do not contain pointers. // buf points into the same allocation, elemtype is persistent. // SudoG's are referenced from their owning thread so they can't be collected. // TODO(dvyukov,rlh): Rethink when collector can move allocated objects. // // å½“å­˜å‚¨åœ¨bufä¸­çš„å…ƒç´ ä¸åŒ…å«æŒ‡é’ˆæ—¶ï¼Œhchanä¸åŒ…å«GCæ„Ÿå…´è¶£çš„æŒ‡é’ˆã€‚ // (å› æ­¤å¯ç›´æ¥åœ¨æ— æŒ‡é’ˆå†…å­˜å—åˆ†é…)ã€‚bufæŒ‡å‘ç›¸åŒçš„å†…å­˜åˆ†é…ï¼Œelemtypeæ˜¯æŒä¹…çš„ã€‚ // Sudog æ˜¯åœ¨å®ƒä»¬è‡ªå·±çš„çº¿ç¨‹ä¸­å¼•ç”¨çš„ï¼Œæ‰€ä»¥å®ƒä»¬æ— æ³•è¢«æ”¶é›†ã€‚ // TODO(dvyukov,rlh):é‡æ–°è€ƒè™‘æ”¶é›†å™¨ä½•æ—¶å¯ä»¥ç§»åŠ¨å·²åˆ†é…çš„å¯¹è±¡ã€‚ var c *hchan // nil switch { // ã€make(chan struct{}, n)ã€‘ OR ã€make(chan int, 0)ã€‘ å½¢å¼ case mem == 0: // channel å†…å­˜ä¸ºé›¶ // Queue or element size is zero. // // Queue æˆ– element çš„å¤§å°ä¸º0ã€‚ // æ³¨æ„è¿™é‡Œç”³è¯·çš„å†…å­˜è§„æ ¼å—æ˜¯æ— æŒ‡é’ˆçš„ï¼Œå…·ä½“åŸå› å‰é¢æ³¨é‡Šæœ‰è§£é‡Š c = (*hchan)(mallocgc(hchanSize, nil, true)) // ç”³è¯·hchanéœ€è¦çš„å†…å­˜ç©ºé—´ // Race detector uses this location for synchronization. // // ç«æ€æ£€æµ‹å™¨ä½¿ç”¨æ­¤ä½ç½®è¿›è¡ŒåŒæ­¥ã€‚ c.buf = c.raceaddr() // c.buf = \u0026c.buf case elem.ptrdata == 0: // channel å†…å­˜ä¸ä¸ºé›¶ï¼Œå…ƒç´ ä¸åŒ…å«æŒ‡é’ˆ // Elements do not contain pointers. // Allocate hchan and buf in one call. // // å…ƒç´ ä¸åŒ…å«æŒ‡é’ˆã€‚ä¸€æ¬¡è°ƒç”¨å³å¯åˆ†é… hchan å’Œ bufã€‚ // hchanSize ä¸»è¦æ˜¯ä¸ºäº†è¿™é‡Œçš„å¯¹é½ã€‚æ³¨æ„è¿™é‡Œç”³è¯·çš„å†…å­˜è§„æ ¼å—æ˜¯æ— æŒ‡é’ˆçš„ï¼Œå…·ä½“åŸå› å‰é¢æ³¨é‡Šæœ‰è§£é‡Š c = (*hchan)(mallocgc(hchanSize+mem, nil, true)) // ç”³è¯·ã€hchan + bufã€‘éœ€è¦å†…å­˜å— c.buf = add(unsafe.Pointer(c), hchanSize) // å¯è§ç”³è¯·çš„æ˜¯ä¸€æ•´å—å†…å­˜ç©ºé—´ default: // channel å†…å­˜ä¸ä¸ºé›¶ï¼Œå…ƒç´ åŒ…å«æŒ‡é’ˆ // Elements contain pointers. // // å…ƒç´ åŒ…å«æŒ‡é’ˆã€‚ c = new(hchan) // ç”³è¯·å…ƒç´ éœ€è¦çš„å†…å­˜å— // æ³¨æ„è¿™é‡Œç”³è¯·çš„æ˜¯æœ‰æŒ‡é’ˆå†…å­˜è§„æ ¼å—ï¼Œå…·ä½“åŸå› æ˜¯chanå…ƒç´ ç±»å‹æœ‰æŒ‡é’ˆå¯èƒ½å­˜åœ¨å¤šçº§æŒ‡é’ˆå¼•ç”¨ï¼Œéœ€è¦GCå¸®åŠ© c.buf = mallocgc(mem, elem, true) } c.elemsize = uint16(elem.size) // chan å…ƒç´ å¤§å° c.elemtype = elem // chanå…ƒç´ å…ƒç±»å‹ c.dataqsiz = uint(size) // æœ‰ç¼“å­˜å®¹é‡ï¼Œä¸€æ—¦åˆå§‹åŒ–å°±æ˜¯ç¡®å®šçš„å€¼ // åˆå§‹åŒ– runtime.mutexï¼Œä¸»è¦æ˜¯åˆå§‹åŒ–é”æ’å lockInit(\u0026c.lock, lockRankHchan)\tif debugChan { print(\"makechan: chan=\", c, \"; elemsize=\", elem.size, \"; dataqsiz=\", size, \"\\n\") } return c } makechan64() 1 2 3 4 5 6 7 func makechan64(t *chantype, size int64) *hchan { if int64(int(size)) != size { // å¦‚æœåœ¨32ä½ç³»ç»Ÿä¸‹è¿™é‡Œä¼šæŠ¥é”™ panic(plainError(\"makechan: size out of range\")) } return makechan(t, int(size)) } c \u003c- ep ep å‘é€åˆ° c ä¸­ã€‚\nchansend1() ç¼–è¯‘åä»£ç ä¸­ c \u003c- x çš„å…¥å£ç‚¹ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 // // c \u003c- ep // // as // // chansend1(c, \u0026ep) // // entry point for c \u003c- x from compiled code // //go:nosplit func chansend1(c *hchan, elem unsafe.Pointer) { chansend(c, elem, true, getcallerpc()) } chansend() é€šç”¨å•é€šé“ send/recvï¼Œå¦‚æœ block ä¸æ˜¯ nilï¼Œé‚£ä¹ˆåè®®å°†ä¸ä¼šè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œå¦‚æœæ— æ³•å®Œæˆåˆ™è¿”å›ã€‚ å½“æ¶‰åŠ sleep çš„é€šé“è¢«å…³é—­æ—¶ï¼Œsleep å¯ä»¥ä½¿ç”¨ g.param == nil å”¤é†’ã€‚å¾ªç¯å¹¶é‡æ–°è¿è¡Œæ“ä½œæ˜¯æœ€ç®€å•çš„;æˆ‘ä»¬ä¼šçœ‹åˆ°å®ƒç°åœ¨å·²ç»å…³é—­äº†ã€‚ å‚æ•°ï¼š c *hchanï¼šhchan ç»“æ„ä½“çš„æŒ‡é’ˆã€‚æŒ‡å‘è¦æ¥ç”¨ send æ•°æ®çš„ channelã€‚ ep unsafe.Pointerï¼šep æ˜¯ c \u003c- ep éœ€è¦å‘é€åˆ° chan çš„æ•°æ®åœ°å€ã€‚ æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘è¦è¢«é€å…¥é€šé“ c çš„æ•°æ®ï¼Œæ•°æ®ç±»å‹è¦å’Œ c çš„å…ƒç´ ç±»å‹ä¸€è‡´ã€‚ block boolï¼šfalse.ä¸èƒ½ç«‹å³å®Œæˆæ—¶ä¸é˜»å¡ã€‚ true.ä¸èƒ½ç«‹å³å®Œæˆæ—¶é˜»å¡ã€‚ è¡¨ç¤ºå¦‚æœ send æ“ä½œä¸èƒ½ç«‹å³å®Œæˆï¼Œæ˜¯å¦æƒ³è¦é˜»å¡ç­‰å¾…ã€‚ block bool å‚æ•° false çŠ¶æ€ç”¨äº select{case: default:} å½¢å¼ä¸­ã€‚true çŠ¶æ€ç”¨äº c \u003c- ep æƒ…å†µä¸‹ã€‚ callerpc uintptrï¼šæ˜¯ c \u003c- ep çš„ä¸‹ä¸€æ¡ä»£ç æŒ‡ä»¤åœ°å€ã€‚ç”¨äºè¿›è¡Œraceç›¸å…³æ£€æµ‹ã€‚ è¿”å›å€¼ï¼š boolï¼štrue.æ•°æ® send å®Œæˆã€‚false.è¡¨ç¤ºç›®å‰ä¸èƒ½å‘é€ï¼Œä½†å› ä¸ºä¸æƒ³é˜»å¡(blockä¸ºfalse)è€Œè¿”å›ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 /* * generic single channel send/recv * If block is not nil, * then the protocol will not * sleep but return if it could * not complete. * * sleep can wake up with g.param == nil * when a channel involved in the sleep has * been closed. it is easiest to loop and re-run * the operation; we'll see that it's now closed. */ func chansend(c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool { // 1) chanæ²¡æœ‰åˆå§‹åŒ–ï¼Œæ¯”å¦‚ var c chan intå½¢å¼ if c == nil { if !block { // select{case: default:} å— return false // è¿”å›falseï¼Œè¡¨ç¤ºæœªå‘é€æ•°æ®ã€‚ } // nil \u003c- xï¼šå¦‚æœblockä¸ºtrueï¼Œå°±è®©å½“å‰åç¨‹æ°¸ä¹…åœ°é˜»å¡åœ¨è¿™ä¸ªnilé€šé“ä¸Šã€‚ // å¤„ç†ç›¸å…³goroutineç„¶åå†æ¬¡è¿›è¡Œæ–°ä¸€è½®è°ƒåº¦ã€‚ // æ³¨æ„ï¼šè¿™é‡Œçš„goroutineå°†æ°¸ä¹…ä¸¢å¤±ï¼Œå› ä¸ºè¿™ä¸ªgoroutineæ²¡æœ‰è¢«æ”¾å…¥é˜Ÿåˆ—ä¸­ç­‰å¾…è¢«è°ƒåº¦ï¼Œ // è¿˜æœ‰å°±æ˜¯c \u003c- xè¿™è¡Œä»£ç åçš„æ‰€æœ‰ä»£ç éƒ½ä¸ä¼šåœ¨è¢«æ‰§è¡Œã€‚ gopark(nil, nil, waitReasonChanSendNilChan, traceEvGoStop, 2) throw(\"unreachable\") } if debugChan { // debug print(\"chansend: chan=\", c, \"\\n\") } if raceenabled { racereadpc(c.raceaddr(), callerpc, abi.FuncPCABIInternal(chansend)) } // Fast path: check for failed non-blocking operation without acquiring the lock. // // After observing that the channel is not closed, we observe that the channel is // not ready for sending. Each of these observations is a single word-sized read // (first c.closed and second full()). // Because a closed channel cannot transition from 'ready for sending' to // 'not ready for sending', even if the channel is closed between the two observations, // they imply a moment between the two when the channel was both not yet closed // and not ready for sending. We behave as if we observed the channel at that moment, // and report that the send cannot proceed. // // It is okay if the reads are reordered here: if we observe that the channel is not // ready for sending and then observe that it is not closed, that implies that the // channel wasn't closed during the first observation. However, nothing here // guarantees forward progress. We rely on the side effects of lock release in // chanrecv() and closechan() to update this thread's view of c.closed and full(). // // Fast path: åœ¨æœªè·å¾—é”çš„æƒ…å†µä¸‹æ£€æŸ¥å¤±è´¥çš„éé˜»å¡æ“ä½œã€‚ // åœ¨è§‚å¯Ÿåˆ°é€šé“æ²¡æœ‰å…³é—­ä¹‹åï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°é€šé“è¿˜æ²¡æœ‰å‡†å¤‡å¥½å‘é€ã€‚æ¯ä¸ªè§‚å¯Ÿå€¼éƒ½æ˜¯å•ä¸ªword-sizedçš„è¯»å–(ç¬¬ä¸€ä¸ªæ˜¯c.closedï¼Œç¬¬äºŒä¸ªæ˜¯full())ã€‚ // å› ä¸ºä¸€ä¸ªå°é—­çš„é€šé“ä¸èƒ½ä»'ready for sending'è¿‡æ¸¡åˆ°'not ready for sending'ï¼Œå³ä½¿åœ¨ä¸¤æ¬¡è§‚æµ‹ä¹‹é—´é€šé“æ˜¯å…³é—­çš„ï¼Œ // å®ƒä»¬ä¹Ÿæ„å‘³ç€åœ¨ä¸¤æ¬¡è§‚æµ‹ä¹‹é—´é€šé“æ—¢æ²¡æœ‰å…³é—­ä¹Ÿæ²¡æœ‰å‡†å¤‡å¥½å‘é€çš„æ—¶åˆ»ã€‚ // æˆ‘ä»¬çš„è¡Œä¸ºå°±åƒæˆ‘ä»¬å½“æ—¶è§‚å¯Ÿåˆ°é€šé“ä¸€æ ·ï¼Œå¹¶æŠ¥å‘Šå‘é€æ— æ³•ç»§ç»­ã€‚ // åœ¨è¿™é‡Œï¼Œå¦‚æœè¯»æ“ä½œè¢«é‡æ–°æ’åºæ˜¯å¯ä»¥çš„:å¦‚æœæˆ‘ä»¬è§‚å¯Ÿåˆ°é€šé“è¿˜æ²¡æœ‰å‡†å¤‡å¥½å‘é€ï¼Œç„¶ååˆè§‚å¯Ÿåˆ°å®ƒæ²¡æœ‰å…³é—­ï¼Œè¿™æ„å‘³ç€åœ¨ç¬¬ä¸€æ¬¡è§‚å¯ŸæœŸé—´é€šé“æ²¡æœ‰å…³é—­ã€‚ // ç„¶è€Œï¼Œè¿™é‡Œæ²¡æœ‰ä»»ä½•ä¸œè¥¿èƒ½ä¿è¯å–å¾—è¿›å±•ã€‚æˆ‘ä»¬ä¾èµ–chanrecv()å’Œclosechan()ä¸­é”é‡Šæ”¾çš„å‰¯ä½œç”¨æ¥æ›´æ–°è¿™ä¸ªçº¿ç¨‹çš„c.closedå’Œfull()è§†å›¾ã€‚ if !block \u0026\u0026 c.closed == 0 \u0026\u0026 full(c) { // selectå—ä¸­ \u0026\u0026 chanæœªå…³é—­ \u0026\u0026 cå·²æ»¡ // å¦‚æœblockä¸ºfalseä¸”closedä¸º0ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸æƒ³é˜»å¡ä¸”é€šé“æœªå…³é—­çš„å‰æä¸‹ï¼Œå¦‚æœé€šé“æ»¡äº†ï¼ˆæ— ç¼“å†²ä¸”recvqä¸ºç©ºï¼Œæˆ–è€…æœ‰ç¼“å­˜ä¸”ç¼“å†²å·²ç”¨å°½ï¼‰ï¼Œ // åˆ™ç›´æ¥è¿”å›falseã€‚ // æœ¬æ­¥åˆ¤æ–­æ˜¯åœ¨ä¸åŠ é”çš„æƒ…å†µä¸‹è¿›è¡Œçš„ï¼Œç›®çš„æ˜¯è®©éé˜»å¡sendåœ¨æ— æ³•ç«‹å³å®Œæˆæ—¶èƒ½çœŸæ­£ä¸é˜»å¡ï¼ˆåŠ é”æ“ä½œå¯èƒ½é˜»å¡ï¼‰ã€‚ return false } var t0 int64 if blockprofilerate \u003e 0 { t0 = cputicks() } // 2) å°è¯•è·å– runtime.mutex äº’æ–¥é” // å¯¹hchanåŠ é”ï¼Œå¦‚æœclosedä¸ä¸º0ï¼Œå³é€šé“å·²ç»å…³é—­ï¼Œåˆ™å…ˆè§£é”ï¼Œç„¶åpanicã€‚å› ä¸ºä¸å…è®¸ç”¨å·²å…³é—­çš„é€šé“è¿›è¡Œsendã€‚ lock(\u0026c.lock) // 3) å‘å·²å…³é—­çš„chan å‘é€æ•°æ®ç›´æ¥panic // è¿™é‡Œå­˜åœ¨è·å–runtime.mutexæœŸé—´å…¶ä»–åç¨‹å·²ç»æŠŠcå…³é—­çš„æƒ…å†µï¼Œè¿™é‡Œä¼šç›´æ¥panic // å› æ­¤chançš„å…³é—­æ˜¯è¦ç¡®ä¿æ‰€æœ‰çš„sendæ“ä½œå·²å®Œæˆåå†è¿›è¡Œ if c.closed != 0 { unlock(\u0026c.lock) panic(plainError(\"send on closed channel\")) } // 4) ä» recvq ä¸­å»æ‰¾å‡ºä¸€ä¸ªæ­£åœ¨ç­‰å¾…çš„ *sudog // å¦‚æœ recvq ä¸ä¸ºç©ºï¼Œéšå«äº†ç¼“å†²åŒºä¸ºç©ºï¼Œå°±ä»ä¸­å–å‡ºç¬¬1ä¸ªæ’é˜Ÿçš„åç¨‹ï¼Œå°†æ•°æ®ä¼ ç»™è¿™ä¸ªåç¨‹ï¼Œå¹¶å°†è¯¥åç¨‹ç½®ä¸ºreadyçŠ¶æ€ //ï¼ˆæ”¾å…¥run queueï¼Œè¿›è€Œå¾—åˆ°è°ƒåº¦ï¼‰ï¼Œç„¶åè§£é”ï¼Œç„¶åè¿”å›trueã€‚ if sg := c.recvq.dequeue(); sg != nil { // å­˜åœ¨ç­‰å¾…çš„ goroutine ç›´æ¥äº¤æ¢æ•°æ®å³å¯ // Found a waiting receiver. We pass the value we want to send // directly to the receiver, bypassing the channel buffer (if any). // // æ‰¾åˆ°äº†ä¸€ä¸ªç­‰å¾…çš„æ¥æ”¶å™¨ã€‚æˆ‘ä»¬å°†æƒ³è¦ç›´æ¥å‘é€çš„å€¼ä¼ é€’ç»™æ¥æ”¶å™¨ï¼Œç»•è¿‡é€šé“ç¼“å†²åŒº(å¦‚æœæœ‰çš„è¯)ã€‚ send(c, sg, ep, func() { unlock(\u0026c.lock) }, 3) return true } // 5) ç¼“å†²åŒºè¿˜æœ‰ç©ºé—´ï¼Œç›´æ¥æŠŠæ•°æ®æ”¾å…¥å³å¯ // é€šè¿‡æ¯”è¾ƒ qcount å’Œ dataqsiz åˆ¤æ–­ç¼“å­˜åŒºæ˜¯å¦è¿˜æœ‰å‰©ä½™ç©ºé—´ï¼Œåœ¨è¿™é‡Œæ— ç¼“å†²çš„é€šé“è¢«è§†ä¸ºæ²¡æœ‰å‰©ä½™ç©ºé—´ã€‚ // å¦‚æœæœ‰å‰©ä½™ç©ºé—´ï¼Œå°†æ•°æ®è¿½åŠ åˆ°ç¼“å†²åŒºä¸­ï¼Œç›¸åº”åœ°ç§»åŠ¨ sendxï¼Œå¢åŠ  qcountï¼Œç„¶åè§£é”ï¼Œè¿”å›å€¼ä¸º trueã€‚ if c.qcount \u003c c.dataqsiz { // Space is available in the channel buffer. Enqueue the element to send. // // é€šé“ç¼“å†²åŒºä¸­æœ‰å¯ç”¨ç©ºé—´ã€‚å¯¹è¦å‘é€çš„å…ƒç´ è¿›è¡Œæ’é˜Ÿã€‚ qp := chanbuf(c, c.sendx) // ä¸‹ä¸€ä¸ªç©ºé—²æ’æ§½åœ°å€ if raceenabled { racenotify(c, c.sendx, nil) } // æŠŠc \u003c- epè¿™é‡Œçš„epå€¼å¤åˆ¶åˆ°qpè¿™ä¸ªåœ°å€ä¸­ï¼Œå®ç°æŠŠepæ”¾å…¥bufä¸­ typedmemmove(c.elemtype, qp, ep) // å¦‚æœå…ƒç´ å¤§å°ä¸º0ä¸ä¼šæœ‰ä»»ä½•æ“ä½œ c.sendx++ // ä¸‹ä¸€æ¬¡ç©ºé—²ä½ç½® if c.sendx == c.dataqsiz { // åˆ°è¾¾æœ€å¤§ç´¢å¼• c.sendx = 0 } c.qcount++ // å·²å­˜å‚¨çš„æ•°é‡åŠ ä¸€ unlock(\u0026c.lock) return true } // 6) å¦‚æœä¸Šé¢4å’Œ5éƒ½ä¸æ»¡è¶³ï¼Œå¹¶ä¸”æ˜¯åœ¨selectä¸­ï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›falseï¼Œè¡¨ç¤ºå½“å‰åˆ†æ”¯ä¸ä¼šé€‰ä¸­ // è¿è¡Œåˆ°è¿™é‡Œè¡¨æ˜é€šé“å·²æ»¡ï¼Œå¦‚æœblockä¸ºfalseï¼Œå³ä¸æƒ³é˜»å¡ï¼Œåˆ™è§£é”ï¼Œè¿”å›å€¼ä¸ºfalseã€‚ if !block { unlock(\u0026c.lock) return false } // 7) ä¸‹é¢æ˜¯ c \u003c- x å†™æ“ä½œéœ€è¦é˜»å¡çš„æƒ…å†µ // Block on the channel. Some receiver will complete our operation for us. // // åœ¨é€šé“ä¸Šé˜»å¡ã€‚æœ‰äººä¼šæ›¿æˆ‘ä»¬å®Œæˆæˆ‘ä»¬çš„æ“ä½œã€‚ gp := getg() // goroutine // è·å–ä¸€ä¸ªç©ºé—²çš„ *sudog mysg := acquireSudog()\tmysg.releasetime = 0 if t0 != 0 { mysg.releasetime = -1 } // No stack splits between assigning elem and enqueuing mysg // on gp.waiting where copystack can find it. // // åœ¨åˆ†é…elemå’Œåœ¨gpä¸Šæ’é˜Ÿmysgä¹‹é—´æ²¡æœ‰å †æ ˆåˆ†è£‚ã€‚åœ¨æ‹·è´å †èƒ½æ‰¾åˆ°çš„åœ°æ–¹ç­‰å¾…ã€‚ mysg.elem = ep // waitlink åªåœ¨ semapher æˆ– select è¯­å¥ä¸­è¢«ä½¿ç”¨åˆ°ã€‚ // ç”¨æ¥é“¾æ¥å¤šä¸ª sudog mysg.waitlink = nil mysg.g = gp // æ ‡è®°å½“å‰ sudog ä¸æ˜¯æ¥è‡ªselectè¯­å¥ mysg.isSelect = false mysg.c = c // æ ‡è®°goroutineæ­£åœ¨*sudogè¿™ä¸­ç­‰å¾…ï¼ˆä¸€ä¸ªæœ‰æ•ˆçš„elem ptrï¼‰; in lock order gp.waiting = mysg gp.param = nil // æ”¾å…¥ sendq queue ä¸­ç­‰å¾… c.sendq.enqueue(mysg)\t// Signal to anyone trying to shrink our stack that we're about // to park on a channel. The window between when this G's status // changes and when we set gp.activeStackChans is not safe for // stack shrinking. // // å‘ä»»ä½•è¯•å›¾ç¼©å°å †æ ˆçš„äººå‘å‡ºä¿¡å·ï¼Œæˆ‘ä»¬å³å°†åœåœ¨ä¸€ä¸ªchannelä¸Šã€‚ // å½“Gçš„çŠ¶æ€æ”¹å˜å’Œæˆ‘ä»¬è®¾ç½®gpä¹‹é—´çš„çª—å£ã€‚activeStackChans å¯¹å †æ ˆæ”¶ç¼©ä¸å®‰å…¨ã€‚ // goroutine.parkingOnChanè¡¨ç¤ºè¯¥goroutineå³å°†åœåœ¨ä¸€ä¸ªchansendæˆ–chanrecvä¸Šã€‚ // ç”¨äºæŒ‡ç¤ºå †æ ˆæ”¶ç¼©çš„ä¸å®‰å…¨ç‚¹ã€‚å®ƒæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œä½†ä¼šè‡ªåŠ¨æ›´æ–°ã€‚ atomic.Store8(\u0026gp.parkingOnChan, 1) // è¡¨ç¤ºè¿™æ®µæ—¶é—´chanæ­£åœ¨parkingä¸­ // goparkâ€”\u003emcall-\u003epark_m-\u003eschedule() gopark(chanparkcommit, unsafe.Pointer(\u0026c.lock), waitReasonChanSend, traceEvGoBlockSend, 2)\t// è°ƒç¦»å½“å‰gè¿›å…¥è°ƒåº¦å¾ªç¯ // å½“å‰gè¢«å†æ¬¡è°ƒåº¦èµ·æ¥æ—¶ï¼Œç»§ç»­è¿™é‡Œæ‰§è¡Œ // Ensure the value being sent is kept alive until the // receiver copies it out. The sudog has a pointer to the // stack object, but sudogs aren't considered as roots of the // stack tracer. // // ç¡®ä¿æ­£åœ¨å‘é€çš„å€¼åœ¨æ¥æ”¶æ–¹å¤åˆ¶å‡ºæ¥ä¹‹å‰éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚ // sudogæœ‰ä¸€ä¸ªæŒ‡å‘æ ˆå¯¹è±¡çš„æŒ‡é’ˆï¼Œä½†sudogsä¸è¢«è®¤ä¸ºæ˜¯æ ˆè·Ÿè¸ªå™¨çš„rootsã€‚ // https://zhuanlan.zhihu.com/p/213744309 KeepAlive(ep) // ä¿æŒepæ˜¯æ´»è·ƒçš„ï¼Œå› ä¸ºepæ¥è‡ªç”¨æˆ·ç«¯å¯èƒ½epä¼šè¢«å›æ”¶ // someone woke us up. // // æœ‰äººæŠŠæˆ‘ä»¬å«é†’äº†ï¼Œå¯èƒ½æ˜¯æ­£å¸¸ \u003c-c æˆ–è€… close() å‡½æ•° if mysg != gp.waiting {\t// å½“å‰ gp æ˜¯å¦ç­‰å¾…åœ¨ mysq ä¸Š throw(\"G waiting list is corrupted\") } gp.waiting = nil // activeStackChansè¡¨ç¤ºæœ‰æœªé”å®šçš„é€šé“æŒ‡å‘è¿™ä¸ªgoroutineçš„å †æ ˆã€‚ // å¦‚æœä¸ºtrueï¼Œå †æ ˆå¤åˆ¶éœ€è¦è·å¾—é€šé“é”æ¥ä¿æŠ¤å †æ ˆçš„è¿™äº›åŒºåŸŸã€‚ // activeStackChans å­—æ®µåœ¨ gopark ä¸­ chanparkcommit å‡½æ•°ä¸­è¢«è®¾ç½®ä¸ºtrueï¼Œå› æ­¤æ˜¯goè¢«è°ƒç¦»CPUæ—¶å€™è®¾ç½®ä¸ºtrueï¼Œåœ¨å”¤é†’åè®¾ç½®ä¸ºfalseã€‚ // å…·ä½“å‚çœ‹æ ˆ runtime.copystack å‡½æ•°ã€‚ gp.activeStackChans = false // æ¥è‡ªclose()å‡½æ•°å”¤é†’æ—¶ï¼Œclosedä¸ºtrueã€‚ closed := !mysg.success // å¦‚æœæ˜¯æœ‰closeå”¤é†’çš„è¿™é‡Œsuccessä¸ºfalseå¹¶closedä¸º1 gp.param = nil if mysg.releasetime \u003e 0 { blockevent(mysg.releasetime-t0, 2) } mysg.c = nil releaseSudog(mysg)\t// å›æ”¶*sudog // è¿™é‡Œä¹Ÿè§£é‡Šäº†å…³é—­channeléœ€è¦è°¨æ…æ“ä½œã€‚ // ä¸€ä¸ªgoroutineæ­£åœ¨sendï¼Œè€Œå¦å¤–ä¸€ä¸ªgoroutineå´closeäº†ï¼Œè¿™é‡Œå°±ä¼španicã€‚ if closed { // æ¥è‡ªclose()å‡½æ•°å”¤é†’æ—¶closedå­—æ®µåº”è¯¥ä¸º1ã€‚ if c.closed == 0 { throw(\"chansend: spurious wakeup\") // chansend è™šå‡å”¤é†’ } // c.closed == 1æ—¶ï¼Œè¿˜å­˜åœ¨sendçš„gå´å…³é—­äº†chanæŠ¥é”™ // å› æ­¤ close() å‡½æ•°ä¸è¦åœ¨è¿˜æœ‰sendæœªå®Œæˆæ—¶è°ƒç”¨ã€‚ panic(plainError(\"send on closed channel\")) // send åœ¨å…³é—­çš„ channel ä¸Š } return true } full() full() æŠ¥å‘Šåœ¨ c ä¸Šçš„å‘é€æ˜¯å¦ä¼šé˜»å¡(å³é€šé“å·²æ»¡)ã€‚ å®ƒä½¿ç”¨äº†ä¸€ä¸ªå¯å˜çŠ¶æ€çš„word-sizedçš„è¯»å–ï¼Œå› æ­¤å°½ç®¡ç­”æ¡ˆç«‹å³ä¸ºtrueï¼Œä½†åœ¨è°ƒç”¨å‡½æ•°æ”¶åˆ°è¿”å›å€¼æ—¶ï¼Œæ­£ç¡®çš„ç­”æ¡ˆå¯èƒ½å·²ç»æ”¹å˜äº†ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // full reports whether a send on c would block (that is, the channel is full). // It uses a single word-sized read of mutable state, so although // the answer is instantaneously true, the correct answer may have changed // by the time the calling function receives the return value. func full(c *hchan) bool { // c.dataqsiz is immutable (never written after the channel is created) // so it is safe to read at any time during channel operation. // // c.dataqsizæ˜¯ä¸å¯å˜çš„(åœ¨é€šé“åˆ›å»ºåæ°¸ä¸å†™å…¥)ï¼Œå› æ­¤åœ¨é€šé“æ“ä½œæœŸé—´çš„ä»»ä½•æ—¶å€™è¯»å–éƒ½æ˜¯å®‰å…¨çš„ã€‚ if c.dataqsiz == 0 { // Assumes that a pointer read is relaxed-atomic. // // å‡å®šæŒ‡é’ˆè¯»å–æ˜¯relaxed-atomicçš„ã€‚ return c.recvq.first == nil } // Assumes that a uint read is relaxed-atomic. // // å‡è®¾uint readæ˜¯relax-atomicã€‚ return c.qcount == c.dataqsiz } send() äº¤æ¢æ•°æ®ï¼Œå¹¶è°ƒç”¨goreadyæŠŠç­‰å¾…çš„Gæ”¾å…¥pä¸­ç­‰å¾…è°ƒåº¦ã€‚ send å¤„ç†ç©ºé€šé“ c ä¸Šçš„å‘é€æ“ä½œã€‚ å‘é€ç«¯å‘é€çš„å€¼ ep è¢«å¤åˆ¶åˆ°æ¥æ”¶ç«¯sgã€‚ç„¶åï¼Œæ¥æ”¶è€…è¢«å”¤é†’ï¼Œç»§ç»­å®ƒçš„å¿«ä¹ä¹‹è·¯ã€‚ é€šé“cå¿…é¡»æ˜¯ç©ºçš„å¹¶è¢«é”å®šã€‚ç”¨unlockfå‘é€è§£é”cã€‚sgå¿…é¡»å·²ç»ä»cä¸­é€€å‡ºé˜Ÿåˆ—ã€‚ epå¿…é¡»æ˜¯éç©ºå€¼ï¼Œå¹¶ä¸”æŒ‡å‘å †æˆ–è°ƒç”¨è€…çš„å †æ ˆã€‚ å‚æ•°ï¼š c *hchanï¼šhchan ç»“æ„ä½“æŒ‡é’ˆã€‚ sg *sudogï¼šæ˜¯ç­‰å¾… ep \u003c- c çš„ gã€‚ ep unsafe.Pointerï¼šæ˜¯ c \u003c- ep çš„æ•°æ®åœ°å€ã€‚ unlockf func()ï¼šé—­åŒ…å‡½æ•°è§£é” c.lockã€‚ skip intï¼šskip è·³è¿‡æ­¥éª¤ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 // send processes a send operation on an empty channel c. // The value ep sent by the sender is copied to the receiver sg. // The receiver is then woken up to go on its merry way. // Channel c must be empty and locked. send unlocks c with unlockf. // sg must already be dequeued from c. // ep must be non-nil and point to the heap or the caller's stack. func send(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf func(), skip int) { if raceenabled { if c.dataqsiz == 0 { racesync(c, sg) } else { // Pretend we go through the buffer, even though // we copy directly. Note that we need to increment // the head/tail locations only when raceenabled. racenotify(c, c.recvx, nil) racenotify(c, c.recvx, sg) c.recvx++ if c.recvx == c.dataqsiz { c.recvx = 0 } c.sendx = c.recvx // c.sendx = (c.sendx+1) % c.dataqsiz } } // sg.elem æ˜¯ç­‰å¾…è¯»çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯ep \u003c- cè¿™é‡Œçš„epåœ°å€ if sg.elem != nil { // æŠŠepå¤åˆ¶åˆ°sg.elemä¸­ï¼Œè¿™æ ·å°±å®Œæˆäº†chançš„æ•°æ®äº¤æ¢ sendDirect(c.elemtype, sg, ep) sg.elem = nil } gp := sg.g // å–å‡ºå‡†å¤‡æ¢å¤çš„g // æŠŠ hchan è§£é”ã€‚ unlockf() // å”¤é†’æ—¶ä¼ é€’çš„å‚æ•°ã€‚ä¸»è¦ç”¨ä¸ select è¯­å¥å”¤é†’åä½¿ç”¨ã€‚ // select æ‹¿ç€è¿™ä¸ªå‚æ•°çš„å€¼åšæ¯”å¯¹ï¼Œæ˜¯å“ªä¸ª case å°±ç»ªäº†ã€‚ gp.param = unsafe.Pointer(sg) // g.param = *sudog // æŠŠsg.successæ ‡è®°ä¸ºtrueè¡¨ç¤ºæ•°æ®å·²ç»äº¤æ¢æˆåŠŸ sg.success = true if sg.releasetime != 0 { sg.releasetime = cputicks() } goready(gp, skip+1) } sendDirect() ä» src -\u003e sg.elemã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func sendDirect(t *_type, sg *sudog, src unsafe.Pointer) { // src is on our stack, dst is a slot on another stack. // // srcåœ¨æˆ‘ä»¬çš„å †æ ˆä¸Šï¼Œdstæ˜¯å¦ä¸€ä¸ªå †æ ˆä¸Šçš„æ’æ§½ã€‚ // Once we read sg.elem out of sg, it will no longer // be updated if the destination's stack gets copied (shrunk). // So make sure that no preemption points can happen between read \u0026 use. // // ä¸€æ—¦æˆ‘ä»¬ä»sgä¸­è¯»å…¥sg.elemï¼Œå¦‚æœç›®æ ‡å †æ ˆè¢«å¤åˆ¶(æ”¶ç¼©)ï¼Œå®ƒå°†ä¸å†è¢«æ›´æ–°ã€‚ // å› æ­¤ï¼Œè¯·ç¡®ä¿åœ¨è¯»å–å’Œä½¿ç”¨ä¹‹é—´ä¸ä¼šå‘ç”ŸæŠ¢å ç‚¹ã€‚ dst := sg.elem // typeBitsBulkBarrierå¯¹memmoveä½¿ç”¨ç±»å‹ä½å›¾å®šä½æŒ‡é’ˆæ§½å°†[src, src+size)å¤åˆ¶åˆ°[dst, dst+size)çš„æ¯ä¸ªæŒ‡é’ˆæ‰§è¡Œå†™å±éšœã€‚ // ç±»å‹typå¿…é¡»ç²¾ç¡®å¯¹åº”äº[src, src+size)å’Œ[dst, dst+size)ã€‚dstã€srcå’Œsizeå¿…é¡»æ˜¯æŒ‡é’ˆå¯¹é½çš„ã€‚ typeBitsBulkBarrier(t, uintptr(dst), uintptr(src), t.size) // No need for cgo write barrier checks because dst is always // Go memory. // // ä¸éœ€è¦cgoå†™å±éšœæ£€æŸ¥ï¼Œå› ä¸ºdstæ€»æ˜¯Goå†…å­˜ã€‚ memmove(dst, src, t.size)\t// src -\u003e dst } goready() æ¢å¤gpä¹Ÿå°±æ˜¯goroutineå‰è¿›è¡Œæ ˆåˆ‡æ¢åˆ°g0æ ˆã€‚ 1 2 3 4 5 func goready(gp *g, traceskip int) { systemstack(func() {\t// åˆ‡æ¢åˆ°g0æ ˆ ready(gp, traceskip, true) }) } ready() æ¢å¤gpä¹Ÿå°±æ˜¯è¿™ä¸ªgoroutineç›¸å…³çš„çŠ¶æ€ï¼Œç„¶åæ”¾å…¥Pä¸­ç­‰å¾…è¢«è°ƒåº¦ã€‚ æ ‡è®° gp å‡†å¤‡è¿è¡Œã€‚ å‚æ•°ï¼š gp *gï¼šå½“å‰éœ€è¦æ¢å¤çš„goroutine traceskip intï¼šæ£€æŸ¥è·³è¿‡æ­¥éª¤ next boolï¼šnextä¸ºtrueæ—¶ï¼Œåˆ™å°†gpæ”¾å…¥åˆ°_p_.runnextä¸­ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 // Mark gp ready to run. func ready(gp *g, traceskip int, next bool) { if trace.enabled { traceGoUnpark(gp, traceskip) } // è·å–å½“å‰gpè¿™ä¸ªgoroutineçš„çŠ¶æ€ status := readgstatus(gp) // Mark runnable. _g_ := getg() // å½“å‰æ­£åœ¨è¿è¡Œçš„gè¿™é‡Œæ˜¯g0 // ç¦ç”¨æŠ¢å ï¼Œå› ä¸ºå®ƒå¯ä»¥åœ¨æœ¬åœ°å˜é‡ä¸­æŒæœ‰p mp := acquirem() // disable preemption because it can be holding p in a local var if status\u0026^_Gscan != _Gwaiting { dumpgstatus(gp) throw(\"bad g-\u003estatus in ready\") } // status is Gwaiting or Gscanwaiting, make Grunnable and put on runq casgstatus(gp, _Gwaiting, _Grunnable) // åˆ‡æ¢gpçš„çŠ¶æ€ // gpæ”¾å…¥pçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œè¿™é‡Œnextæ˜¯trueæ—¶ï¼Œä¼šæ”¾å…¥nextå­—æ®µä¼šä¼˜å…ˆè°ƒåº¦èµ·æ¥ runqput(_g_.m.p.ptr(), gp, next) // å› ä¸ºæœ‰goroutineæ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œå°è¯•å”¤é†’å…¶ä»–å·¥ä½œçº¿ç¨‹èµ·æ¥å·¥ä½œ wakep() // æœ‰goroutineè¢«æ”¾å›é˜Ÿåˆ—è¯¥å‡½æ•°å°±ä¼šç´§æ¥ç€è¢«è°ƒç”¨ releasem(mp) } chanbuf() chanbuf(c, i) æ˜¯æŒ‡å‘ç¼“å†²åŒºç¬¬ i ä¸ªæ§½çš„æŒ‡é’ˆã€‚ 1 2 3 4 // chanbuf(c, i) is pointer to the i'th slot in the buffer. func chanbuf(c *hchan, i uint) unsafe.Pointer { return add(c.buf, uintptr(i)*uintptr(c.elemsize)) } ep \u003c- c ä» c ä¸­è¯»å–æ•°æ®ã€‚ ç¼–è¯‘åä»£ç ä¸­ \u003c- c çš„å…¥å£ç‚¹ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 // // ep \u003c- c // // as // // chanrecv1(c, \u0026ep) // // entry points for \u003c- c from compiled code // //go:nosplit func chanrecv1(c *hchan, elem unsafe.Pointer) { chanrecv(c, elem, true) } chanrecv() chanrecv åœ¨é€šé“ c æ¥æ”¶æ•°æ®ï¼Œå¹¶å°†æ¥æ”¶åˆ°çš„æ•°æ®å†™å…¥ epã€‚ epå¯ä»¥æ˜¯nilï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æ¥æ”¶åˆ°çš„æ•°æ®å°†è¢«å¿½ç•¥ã€‚ å¦‚æœblock == falseä¸”æ²¡æœ‰å…ƒç´ å¯ç”¨ï¼Œåˆ™è¿”å›(false, false)ã€‚å¦åˆ™ï¼Œå¦‚æœcæ˜¯å…³é—­çš„ï¼Œåˆ™*epè®¾ç½®æˆé›¶å€¼å¹¶è¿”å›(true, false)ã€‚å¦åˆ™ï¼Œç”¨ä¸€ä¸ªå…ƒç´ å¡«å……*epå¹¶è¿”å›(true, true)ã€‚ énilçš„epå¿…é¡»æŒ‡å‘å †æˆ–è°ƒç”¨è€…çš„å †æ ˆã€‚ å‚æ•°ï¼š c *hchanï¼šhchanç»“æ„ä½“æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯ ep \u003c- c ä¸­ c çš„ç»“æ„ä½“æŒ‡é’ˆã€‚æŒ‡å‘è¦ä»recvæ•°æ®çš„channelã€‚ ep unsafe.Pointerï¼šæ¥æ”¶å˜é‡åœ°å€ï¼Œä¹Ÿå°±æ˜¯ ep \u003c- c ä¸­epå˜é‡çš„åœ°å€ã€‚æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ç”¨æ¥æ¥æ”¶æ•°æ®çš„å†…å­˜ï¼Œæ•°æ®ç±»å‹è¦å’Œcçš„å…ƒç´ ç±»å‹ä¸€è‡´ã€‚ block boolï¼štrue.è¡¨ç¤ºå¦‚æœrecvæ“ä½œä¸èƒ½ç«‹å³å®Œæˆï¼Œæ˜¯å¦æƒ³è¦é˜»å¡ç­‰å¾…ã€‚true.ä¸èƒ½ç«‹å³å®Œæˆåˆ™é˜»å¡ï¼Œfalse.ä¸èƒ½ç«‹å³å®Œæˆä¸é˜»å¡ï¼Œç”¨äºselect{case: default:}å½¢å¼ã€‚ è¿”å›å€¼ï¼šè¿™ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯ç”¨äº select{case: default:}å½¢å¼çš„ã€‚selectedè¡¨ç¤ºå½“å‰caseè¢«é€‰ä¸­ã€‚receivedè¡¨ç¤ºæ•°æ®æœ‰æ²¡äº¤æ¢æˆåŠŸã€‚ selected boolï¼štrue.è¡¨ç¤ºæ“ä½œå®Œæˆï¼ˆå¯èƒ½å› ä¸ºé€šé“å·²ç»å…³é—­ï¼‰ã€‚false.è¡¨ç¤ºç›®å‰ä¸èƒ½ç«‹å³å®Œæˆrecvï¼Œä½†å› ä¸ºä¸æƒ³é˜»å¡ï¼ˆblockä¸ºfalseï¼‰è€Œè¿”å›ã€‚ received boolï¼štrue.è¡¨ç¤ºæ•°æ®ç¡®å®æ˜¯ä»é€šé“ä¸­æ¥æ”¶çš„ï¼Œä¸æ˜¯å› ä¸ºé€šé“å…³é—­è€Œå¾—åˆ°çš„é›¶å€¼ã€‚false.å¯èƒ½æ˜¯å› ä¸ºé€šé“å…³é—­è€Œå¾—åˆ°çš„é›¶å€¼ï¼ˆselectedä¸ºtrueï¼‰ï¼Œæˆ–è€…å› ä¸ºä¸æƒ³é˜»å¡è€Œè¿”å›ï¼ˆselectedä¸ºfalseï¼‰ã€‚ è¿”å›å€¼çš„ç»„æˆï¼š (true, true)ï¼šæ“ä½œå·²å®Œæˆï¼Œç¡®å®æ˜¯ä»channelä¸­æ¥æ”¶çš„ï¼ˆä¸æ˜¯å› ä¸ºchannelå…³é—­è€Œå¾—åˆ°çš„é›¶å€¼ï¼‰ã€‚ï¼ˆå½“å‰åˆ†æ”¯è¢«é€‰ä¸­ï¼Œæ•°æ®ä¹Ÿäº¤æ¢æˆåŠŸäº†ï¼‰ (false, false)ï¼šç›®å‰ä¸èƒ½ç«‹å³å®Œæˆï¼Œå› ä¸ºä¸æƒ³é˜»å¡è€Œè¿”å›ã€‚ï¼ˆå½“å‰åˆ†æ”¯æ²¡è¢«é€‰ä¸­ï¼Œèµ°defaultå§ï¼‰ (true, false)ï¼šæ“ä½œå·²å®Œæˆï¼Œå› ä¸ºé€šé“å…³é—­è€Œè¿”å›é›¶å€¼ã€‚ï¼ˆå½“å‰åˆ†æ”¯è¢«é€‰ä¸­ï¼Œå› closeè€Œè¿”å›é»˜è®¤é›¶å€¼ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 // chanrecv receives on channel c and writes the received data to ep. // ep may be nil, in which case received data is ignored. // If block == false and no elements are available, returns (false, false). // Otherwise, if c is closed, zeros *ep and returns (true, false). // Otherwise, fills in *ep with an element and returns (true, true). // A non-nil ep must point to the heap or the caller's stack. func chanrecv(c *hchan, ep unsafe.Pointer, block bool) (selected, received bool) { // raceenabled: don't need to check ep, as it is always on the stack // or is new memory allocated by reflect. // // Raceenabled:ä¸éœ€è¦æ£€æŸ¥epï¼Œå› ä¸ºå®ƒæ€»æ˜¯åœ¨å †æ ˆä¸Šæˆ–ç”±reflectåˆ†é…æ–°çš„å†…å­˜ã€‚ if debugChan { // debug print(\"chanrecv: chan=\", c, \"\\n\") } // 1) chanæœªåˆå§‹åŒ–æ—¶ï¼Œæ¯”å¦‚ var c chan int if c == nil { if !block { // æ¥è‡ªselect{case: default:}å— return // false, false } // \u003c- nil // è¿™é‡Œåœ¨nilçš„chanä¸­è¯»å–æ•°æ®ï¼Œç›´æ¥åˆ‡æ¢åˆ°è°ƒåº¦å¾ªç¯è¿›è¡Œæ–°ä¸€è½®è°ƒåº¦ // è¿™ä¸ªGåé¢çš„ä»£ç å°†ä¸ä¼šå¾—åˆ°æ‰§è¡Œï¼Œåº”è¯¥å½“å‰Gæ—¢æ²¡æœ‰åŠ å…¥åˆ°Pä¸­ç­‰å¾…è°ƒåº¦ï¼Œä¹Ÿæ²¡æœ‰åœ¨chanä¸­ï¼Œæ°¸ä¹…ä¸¢å¤±äº† gopark(nil, nil, waitReasonChanReceiveNilChan, traceEvGoStop, 2) throw(\"unreachable\") } // 2) Fast pathï¼šåœ¨æœªåŠ é”ä¸‹ï¼Œåˆ¤æ–­blockä¸ºfalseæ—¶ï¼Œsendä¸ºç©ºæ—¶ã€‚ // Fast path: check for failed non-blocking operation without acquiring the lock. // // Fast path: æ£€æŸ¥æœªè·å¾—é”çš„å¤±è´¥çš„éé˜»å¡æ“ä½œã€‚ if !block \u0026\u0026 empty(c) { // select{case: default:}å—ï¼Œcä¸ºç©º // After observing that the channel is not ready for receiving, we observe whether the // channel is closed. // // Reordering of these checks could lead to incorrect behavior when racing with a close. // For example, if the channel was open and not empty, was closed, and then drained, // reordered reads could incorrectly indicate \"open and empty\". To prevent reordering, // we use atomic loads for both checks, and rely on emptying and closing to happen in // separate critical sections under the same lock. This assumption fails when closing // an unbuffered channel with a blocked send, but that is an error condition anyway. // // åœ¨è§‚å¯Ÿåˆ°é€šé“è¿˜æ²¡æœ‰å‡†å¤‡å¥½æ¥æ”¶ä¹‹åï¼Œæˆ‘ä»¬è§‚å¯Ÿé€šé“æ˜¯å¦å…³é—­ã€‚ // // åœ¨ä¸closeç«äº‰æ—¶ï¼Œè¿™äº›æ£€æŸ¥çš„é‡æ–°æ’åºå¯èƒ½ä¼šå¯¼è‡´é”™è¯¯çš„è¡Œä¸ºã€‚ // ä¾‹å¦‚ï¼Œå¦‚æœchannelæ˜¯æ‰“å¼€çš„ä¸”ä¸æ˜¯ç©ºçš„ï¼Œè¢«å…³é—­ï¼Œç„¶åå…¨éƒ¨å–å‡ºï¼Œé‡æ–°æ’åºçš„è¯»æ•°å¯èƒ½ä¼šé”™è¯¯åœ°æŒ‡ç¤º\"open and empty\"ã€‚ // ä¸ºäº†é˜²æ­¢é‡æ–°æ’åºï¼Œæˆ‘ä»¬å¯¹è¿™ä¸¤ç§æ£€æŸ¥éƒ½ä½¿ç”¨äº†åŸå­åŠ è½½ï¼Œå¹¶ä¾èµ–äºåœ¨åŒä¸€é”ä¸‹çš„ä¸åŒä¸´ç•ŒåŒºä¸­è¿›è¡Œæ¸…ç©ºå’Œå…³é—­æ“ä½œã€‚ // å½“ä»¥é˜»å¡çš„å‘é€æ–¹å¼å…³é—­æ— ç¼“å†²çš„é€šé“æ—¶ï¼Œè¿™ä¸ªå‡è®¾å°±å¤±è´¥äº†ï¼Œä½†æ— è®ºå¦‚ä½•è¿™éƒ½æ˜¯ä¸€ä¸ªé”™è¯¯æ¡ä»¶ã€‚ if atomic.Load(\u0026c.closed) == 0 { // sendä¸ºç©º å¹¶ closed æœªå…³é—­ï¼Œè¿”å› (false, false) // Because a channel cannot be reopened, the later observation of the channel // being not closed implies that it was also not closed at the moment of the // first observation. We behave as if we observed the channel at that moment // and report that the receive cannot proceed. // // å› ä¸ºchannelä¸èƒ½é‡æ–°æ‰“å¼€ï¼Œæ‰€ä»¥åæ¥è§‚å¯Ÿåˆ°çš„channelæ²¡æœ‰å…³é—­æ„å‘³ç€åœ¨ç¬¬ä¸€æ¬¡è§‚å¯Ÿçš„æ—¶å€™å®ƒä¹Ÿæ²¡æœ‰å…³é—­ã€‚ // æˆ‘ä»¬çš„è¡Œä¸ºå°±åƒæˆ‘ä»¬å½“æ—¶è§‚å¯Ÿåˆ°äº†channelï¼Œå¹¶æŠ¥å‘Šè¯´æ¥æ”¶æ— æ³•ç»§ç»­ã€‚ return } // The channel is irreversibly closed. Re-check whether the channel has any pending data // to receive, which could have arrived between the empty and closed checks above. // Sequential consistency is also required here, when racing with such a send. // // channelæ˜¯ä¸å¯é€†å…³é—­çš„ã€‚é‡æ–°æ£€æŸ¥ä¿¡é“æ˜¯å¦æœ‰å¾…å¤„ç†çš„æ•°æ®è¦æ¥æ”¶ï¼Œè¿™äº›æ•°æ®å¯èƒ½æ˜¯åœ¨ä¸Šé¢çš„ç©ºæ£€æŸ¥å’Œå…³é—­æ£€æŸ¥ä¹‹é—´åˆ°è¾¾çš„ã€‚ // å½“ä½¿ç”¨è¿™æ ·çš„å‘é€æ–¹å¼æ¯”èµ›æ—¶ï¼Œé¡ºåºçš„ä¸€è‡´æ€§ä¹Ÿæ˜¯å¿…éœ€çš„ã€‚ if empty(c) { // sendä¸ºç©º å¹¶ä¸” closed å·²å…³é—­ï¼Œè¿”å› (true, false) // The channel is irreversibly closed and empty. if raceenabled { raceacquire(c.raceaddr()) } if ep != nil { typedmemclr(c.elemtype, ep) } return true, false } } var t0 int64 if blockprofilerate \u003e 0 { t0 = cputicks() } // 3) åŠ é”æƒ…å†µä¸‹å»åˆ¤æ–­ send å’Œ sendq æ˜¯å¦æœ‰ç­‰å¾… send çš„æ•°æ®ã€‚ lock(\u0026c.lock) // è·å–runtime.mutex // channel å·²å…³é—­ if c.closed != 0 {\t// send bufç¼“å†²åŒºæ²¡æ•°æ® if c.qcount == 0 {\tif raceenabled { raceacquire(c.raceaddr()) } unlock(\u0026c.lock) // æ‹·è´å¯¹åº”ç±»å‹çš„é›¶å€¼ if ep != nil { // Typedmemclræ¸…é™¤ç±»å‹ä¸ºtypçš„ptrçš„ç±»å‹åŒ–å†…å­˜ã€‚ typedmemclr(c.elemtype, ep) // ep èµ‹å€¼chanå…ƒç´ ç±»å‹çš„é»˜è®¤å€¼ } return true, false } // The channel has been closed, but the channel's buffer have data. // // channel å·²ç»å…³é—­ï¼Œä½†é€šé“çš„ç¼“å†²åŒºæœ‰æ•°æ®ã€‚ } else { // channel æœªå…³é—­ // Just found waiting sender with not closed. // // åˆšåˆšå‘ç°ç­‰å¾…sendæœªå…³é—­ã€‚å–å‡ºfirstä¸Šçš„ç¬¬ä¸€ä¸ª*sudogï¼Œè¿™ä¸ªéœ€è¦å¤„ç† // è¿™é‡Œéšå«äº† buf ç¼“å­˜åŒºä¸ºç©ºçš„æƒ…å†µã€‚ if sg := c.sendq.dequeue(); sg != nil { // Found a waiting sender. If buffer is size 0, receive value // directly from sender. Otherwise, receive from head of queue // and add sender's value to the tail of the queue (both map to // the same buffer slot because the queue is full). // // å‘ç°ä¸€ä¸ªç­‰å¾…å‘é€è€…ã€‚å¦‚æœç¼“å†²åŒºå¤§å°æ˜¯0ï¼Œæ¥æ”¶å€¼ç›´æ¥ä»å‘é€æ–¹ã€‚ // å¦åˆ™ï¼Œä»é˜Ÿåˆ—çš„å¤´éƒ¨æ¥æ”¶å¹¶å°†å‘é€æ–¹çš„å€¼æ·»åŠ åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨(ä¸¤è€…æ˜ å°„åˆ°ç›¸åŒçš„ç¼“å†²æ§½ï¼Œå› ä¸ºé˜Ÿåˆ—å·²æ»¡)ã€‚ recv(c, sg, ep, func() { unlock(\u0026c.lock) }, 3) return true, true } } // buf ç¼“å†²åŒºæœ‰æ•°æ® if c.qcount \u003e 0 { // Receive directly from queue // ç›´æ¥ä»ç¼“å­˜åŒºé˜Ÿåˆ—ä¸­æ¥æ”¶æ•°æ® qp := chanbuf(c, c.recvx) if raceenabled { racenotify(c, c.recvx, nil) } // äº¤æ¢æ•°æ® if ep != nil { typedmemmove(c.elemtype, ep, qp) // ep = qp } typedmemclr(c.elemtype, qp) // æ¸…é™¤ qp c.recvx++ if c.recvx == c.dataqsiz { c.recvx = 0 } c.qcount-- // ç¼“å­˜åŒºå…ƒç´ ä¸ªæ•° unlock(\u0026c.lock) return true, true } // ä¸‹é¢ä»£ç æ˜¯éœ€è¦è¢«é˜»å¡çš„æƒ…å†µï¼Œå½“å‰goroutineè¢«åŠ¨æ‰§è¡Œè°ƒåº¦åˆ°c.sendqä¸­å»ç­‰å¾… // block ä¸º falseï¼Œä¸æƒ³é˜»å¡è€Œè¿”å›ã€‚ if !block { unlock(\u0026c.lock) return false, false } // 4) send bufå–æ²¡æœ‰æ•°æ®æˆ–sendqä¸­æ²¡æœ‰ç­‰å¾…çš„goroutineæ—¶ã€‚ // no sender available: block on this channel. // æ²¡æœ‰å¯ç”¨çš„å‘é€è€…:åœ¨æ­¤é€šé“ä¸Šé˜»å¡ã€‚ gp := getg() // g mysg := acquireSudog() // è·å–ä¸€ä¸ªç©ºé—²çš„ *sudog mysg.releasetime = 0 if t0 != 0 { mysg.releasetime = -1 } // No stack splits between assigning elem and enqueuing mysg // on gp.waiting where copystack can find it. // åœ¨åˆ†é…elemå’Œåœ¨gp.waitingä¸Šå¯¹mysgè¿›è¡Œæ’é˜Ÿä¹‹é—´æ²¡æœ‰æ ˆæ‹†åˆ†ï¼Œå› ä¸ºåœ¨gp.waitingä¸Šcopystackå¯ä»¥æ‰¾åˆ°å®ƒã€‚ mysg.elem = ep mysg.waitlink = nil gp.waiting = mysg mysg.g = gp mysg.isSelect = false // æ ‡è®°ä¸æ˜¯åœ¨selectå—ä¸­æ¥çš„ mysg.c = c gp.param = nil c.recvq.enqueue(mysg) // åŠ å…¥ recvq é˜Ÿåˆ—ä¸­ // Signal to anyone trying to shrink our stack that we're about // to park on a channel. The window between when this G's status // changes and when we set gp.activeStackChans is not safe for // stack shrinking. // å‘ä»»ä½•è¯•å›¾ç¼©å°å †æ ˆçš„äººå‘å‡ºä¿¡å·ï¼Œæˆ‘ä»¬å³å°†åœåœ¨ä¸€ä¸ªchannelä¸Šã€‚ // å½“Gçš„çŠ¶æ€æ”¹å˜å’Œæˆ‘ä»¬è®¾ç½®gpä¹‹é—´çš„çª—å£ã€‚activeStackChans å¯¹å †æ ˆæ”¶ç¼©ä¸å®‰å…¨ã€‚ // goroutine.parkingOnChanè¡¨ç¤ºè¯¥goroutineå³å°†åœåœ¨ä¸€ä¸ªchansendæˆ–chanrecvä¸Šã€‚ç”¨äºæŒ‡ç¤ºå †æ ˆæ”¶ç¼©çš„ä¸å®‰å…¨ç‚¹ã€‚å®ƒæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œä½†ä¼šè‡ªåŠ¨æ›´æ–°ã€‚ atomic.Store8(\u0026gp.parkingOnChan, 1) // gopark ä¿å­˜å½“å‰goroutineçº¿ç¨‹; è°ƒç”¨ releasem(mp) è§£é™¤å½“å‰må’ŒPçš„ç»‘å®š // è°ƒç”¨mcall(park_m) mcallåˆ‡æ¢æ ˆåˆ°g0 park_m è§£é™¤må’Œgçš„å…³è” è°ƒç”¨scheduleå†æ¬¡å¼€å¯è°ƒåº¦å¾ªç¯ gopark(chanparkcommit, unsafe.Pointer(\u0026c.lock), waitReasonChanReceive, traceEvGoBlockRecv, 2) // someone woke us up if mysg != gp.waiting { throw(\"G waiting list is corrupted\") } gp.waiting = nil gp.activeStackChans = false if mysg.releasetime \u003e 0 { blockevent(mysg.releasetime-t0, 2) } success := mysg.success gp.param = nil mysg.c = nil releaseSudog(mysg) // å›æ”¶ sudog return true, success } empty() EmptyæŠ¥å‘Šä»cè¯»å–æ•°æ®æ˜¯å¦ä¼šé˜»å¡(å³channelæ˜¯ç©ºçš„)ã€‚å®ƒä½¿ç”¨å•ä¸ªåŸå­è¯»å–å¯å˜çŠ¶æ€ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 // empty reports whether a read from c would block (that is, the channel is // empty). It uses a single atomic read of mutable state. func empty(c *hchan) bool { // c.dataqsiz is immutable. // // c.dataqsiz æ˜¯ä¸å¯å˜çš„ if c.dataqsiz == 0 { // æ˜¯å¦æœ‰ç­‰å¾… send çš„ goroutine return atomic.Loadp(unsafe.Pointer(\u0026c.sendq.first)) == nil } // ç¼“å­˜åŒºæ˜¯å¦æœ‰æ•°æ® return atomic.Loaduint(\u0026c.qcount) == 0 } recv() recv åœ¨ä¸€ä¸ªæ»¡çš„ç¼“å­˜åŒºçš„channel cä¸Šå¤„ç†æ¥æ”¶æ“ä½œ æœ‰ä»¥ä¸‹ä¸¤éƒ¨åˆ†ï¼š å‘é€æ”¾sgå‘é€çš„å€¼è¢«æ”¾å…¥channelï¼Œå‘é€æ–¹è¢«å”¤é†’ æ¥æ”¶ç«¯æ¥æ”¶åˆ°çš„å€¼(å½“å‰G)è¢«å†™å…¥ep å¯¹äºåŒæ­¥channelï¼Œè¿™ä¸¤ä¸ªå€¼æ˜¯ç›¸åŒçš„ å¯¹äºå¼‚æ­¥channelï¼Œæ¥æ”¶æ–¹ä»é€šé“ç¼“å†²åŒºè·å–æ•°æ®ï¼Œå‘é€æ–¹çš„æ•°æ®æ”¾åœ¨é€šé“ç¼“å†²åŒºä¸­ã€‚ é€šé“cå¿…é¡»å·²æ»¡ä¸”å·²é”å®šã€‚recvç”¨unlockfè§£é”cã€‚sgå¿…é¡»å·²ç»ä»cä¸­é€€å‡ºé˜Ÿåˆ—ã€‚ énilçš„epå¿…é¡»æŒ‡å‘å †æˆ–è°ƒç”¨è€…çš„å †æ ˆã€‚ å‚æ•°ï¼š c *hchanï¼šå½“å‰ chan sg *sudogï¼šä» recvq ä¸­çš„firstå–å‡ºçš„ç¬¬ä¸€ä¸ª *sudog ep unsafe.Pointerï¼šv \u003c- c ä¸­çš„våœ°å€ unlockf func()ï¼šè§£é” runtime.mutex çš„é—­åŒ…å‡½æ•° skip intï¼šè°ƒè¯•ç›¸å…³ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 // recv processes a receive operation on a full channel c. // There are 2 parts: // 1. The value sent by the sender sg is put into the channel // and the sender is woken up to go on its merry way. // 2. The value received by the receiver (the current G) is // written to ep. // // For synchronous channels, both values are the same. // For asynchronous channels, the receiver gets its data from // the channel buffer and the sender's data is put in the // channel buffer. // Channel c must be full and locked. recv unlocks c with unlockf. // sg must already be dequeued from c. // A non-nil ep must point to the heap or the caller's stack. func recv(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf func(), skip int) { if c.dataqsiz == 0 { // æ— ç¼“å†² chan if raceenabled { racesync(c, sg) } if ep != nil { // copy data from sender // ä»å‘é€æ–¹å¤åˆ¶æ•°æ® recvDirect(c.elemtype, sg, ep) // ep = sg } } else { // æœ‰ç¼“å†² chan // Queue is full. Take the item at the // head of the queue. Make the sender enqueue // its item at the tail of the queue. Since the // queue is full, those are both the same slot. // é˜Ÿåˆ—å·²æ»¡ã€‚ä»¥é˜Ÿåˆ—æœ€å‰é¢çš„é¡¹ä¸ºä¾‹ã€‚ // è®©å‘é€æ–¹åœ¨é˜Ÿåˆ—çš„å°¾éƒ¨å°†å…¶é¡¹ç›®å…¥é˜Ÿã€‚ // å› ä¸ºé˜Ÿåˆ—å·²ç»æ»¡äº†ï¼Œæ‰€ä»¥å®ƒä»¬æ˜¯åŒä¸€ä¸ªæ§½ã€‚ // ä»¥ä¸Šæ„æ€æ˜¯ä»sendq.firstå–å‡ºçš„*sudogéœ€è¦æ¢å¤è¿™ä¸ªgå¹¶æŠŠæ•°æ®æ”¾å…¥ç¼“å­˜åŒºï¼Œä»ç¼“å­˜åŒºå–å‡ºä¸‹ä¸€ä¸ªæ•°æ®äº¤æ¢ qp := chanbuf(c, c.recvx) // æ•°æ®åŒºçš„ä¸‹ä¸€ä¸ªéœ€è¦äº¤æ¢çš„æ•°æ® if raceenabled { racenotify(c, c.recvx, nil) racenotify(c, c.recvx, sg) } // copy data from queue to receiver // å°†æ•°æ®ä»é˜Ÿåˆ—å¤åˆ¶åˆ°æ¥æ”¶å™¨ if ep != nil { typedmemmove(c.elemtype, ep, qp) // ep = qp } // copy data from sender to queue // ä»å‘é€ç«¯å¤åˆ¶æ•°æ®åˆ°é˜Ÿåˆ— typedmemmove(c.elemtype, qp, sg.elem) // qp = sg.elem c.recvx++\t// ä¸‹ä¸€æ¬¡recvæ•°æ®ç´¢å¼• if c.recvx == c.dataqsiz {\t// å¦‚æœè¶…è¿‡æœ€å¤§é‡ç½®ä¸º0 c.recvx = 0 } // è®¾ç½®ç¼“å­˜åŒºæ˜¯æ»¡çš„ï¼Œå› ä¸ºè¿™ç§æƒ…å†µç¼“å­˜åŒºä¸€å®šæ˜¯full // æ­¤æ—¶éœ€è¦è°ƒæ•´ sendx çš„å€¼ï¼Œå› ä¸ºä¹‹å‰å°±æ˜¯æ»¡çš„ è¯´æ˜ä¹‹å‰ c.sendx == c.recvx c.sendx = c.recvx // c.sendx = (c.sendx+1) % c.dataqsiz } // sg ä¸­çš„ *sudog çš„géœ€è¦è¢«æ¢å¤è®©å…¶ä»æ–°è¢«è°ƒåº¦ sg.elem = nil // æ•°æ®å·²è¢«æ”¾å…¥ç¼“å­˜åŒºï¼Œæƒ…å†µå³å¯ gp := sg.g // éœ€è¦æ¢å¤çš„g unlockf() // runtime.mutex è§£é” // å½“ä¸€ä¸ªchannelæ“ä½œå”¤é†’ä¸€ä¸ªè¢«é˜»å¡çš„goroutineæ—¶ï¼Œå®ƒå°†paramè®¾ç½®ä¸ºæŒ‡å‘å·²å®Œæˆé˜»å¡æ“ä½œçš„sudogã€‚ // select æ‹¿ç€è¿™ä¸ªå‚æ•°çš„å€¼åšæ¯”å¯¹ï¼Œæ˜¯å“ªä¸ª case å°±ç»ªäº†ã€‚ gp.param = unsafe.Pointer(sg) // ä¸»è¦ç”¨ä¸ select è¯­å¥å”¤é†’åä½¿ç”¨ã€‚ sg.success = true // success æ ‡è®°äº† trueï¼Œäº¤æ¢æ•°æ®æˆåŠŸ if sg.releasetime != 0 { sg.releasetime = cputicks() } goready(gp, skip+1)\t// æ”¾å…¥é˜Ÿåˆ—ä¸­ç­‰å¾…å”¤é†’g } goready() æ¢å¤gpä¹Ÿå°±æ˜¯goroutineå‰è¿›è¡Œæ ˆåˆ‡æ¢åˆ°g0æ ˆã€‚ 1 2 3 4 5 func goready(gp *g, traceskip int) { systemstack(func() { // åˆ‡æ¢åˆ° g0 æ ˆ ready(gp, traceskip, true) }) } ready() æ ‡è®°gpå‡†å¤‡è¿è¡Œã€‚ å‚æ•°ï¼š gp *gï¼šå‡†å¤‡æ¢å¤çš„ goroutine traceskip intï¼šæµ‹è¯•ç›¸å…³ next boolï¼štrue.ä¸‹æ¬¡è°ƒåº¦ä¼˜å…ˆè°ƒåº¦å½“å‰goroutine 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // Mark gp ready to run. func ready(gp *g, traceskip int, next bool) { if trace.enabled { traceGoUnpark(gp, traceskip) } // goroutine çŠ¶æ€ status := readgstatus(gp) // Mark runnable. _g_ := getg() // å½“å‰g0 // ç¦æ­¢å½“å‰mè¢«æŠ¢å ï¼Œå› ä¸ºå³å°†æŠŠgpæ”¾å…¥må…³è”çš„æœ¬åœ°Pä¸­å» mp := acquirem() // disable preemption because it can be holding p in a local var // å¦‚æœå½“å‰gpçŠ¶æ€å¤„ç†åä¸ç­‰äº_Gwaitingç­‰å¾…ä¸­ï¼Œé‚£è¯´æ˜è¿™ä¸ªgpæ˜¯æœ‰é—®é¢˜çš„ if status\u0026^_Gscan != _Gwaiting { dumpgstatus(gp) throw(\"bad g-\u003estatus in ready\") } // status is Gwaiting or Gscanwaiting, make Grunnable and put on runq // æŠŠå½“å‰gpè¿™ä¸ªgoroutineçŠ¶æ€ä»_Gwaitingç­‰å¾…ä¸­ä¿®æ”¹ä¸º_Grunnableå¯ä»¥è¿è¡Œçš„çŠ¶æ€ casgstatus(gp, _Gwaiting, _Grunnable) // ç„¶åæŠŠgpæ”¾å…¥mçš„æœ¬åœ°å…³è”Pä¸­ï¼Œnextä¸ºtrueè¡¨ç¤ºæ”¾å…¥å‰é¢ runqput(_g_.m.p.ptr(), gp, next) wakep() // å°è¯•å”¤é†’å…¶ä»–çº¿ç¨‹ releasem(mp) // è§£é™¤å‰é¢çš„ acquirem() å‡½æ•°çš„æŠ¢å ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦æœ‰æŠ¢å å‘ç”Ÿ } runqput() runqput è¯•å›¾å°†gæ”¾åˆ°æœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ—ä¸Šã€‚ å¦‚æœ next ä¸º false, runqput å°† g æ·»åŠ åˆ°å¯è¿è¡Œé˜Ÿåˆ—çš„å°¾éƒ¨ã€‚ å¦‚æœ next ä¸º true, runqput å°† g æ”¾å…¥_p_.runnextä½ç½®ã€‚ å¦‚æœå°±ç»ªé˜Ÿåˆ—å·²æ»¡ï¼Œrunnext å°† g æ”¾ç½®åˆ°å…¨å±€é˜Ÿåˆ—ä¸­ã€‚ ä»…ç”±æ‰€æœ‰è€…Pæ‰§è¡Œã€‚ å‚æ•°ï¼š _p_ *pï¼šå½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„ P gp *gï¼šéœ€è¦å¤„ç†çš„ goroutine next boolï¼štrue.ä¸‹æ¬¡è°ƒåº¦ä¼˜å…ˆè°ƒåº¦å½“å‰goroutine 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 // runqput tries to put g on the local runnable queue. // If next is false, runqput adds g to the tail of the runnable queue. // If next is true, runqput puts g in the _p_.runnext slot. // If the run queue is full, runnext puts g on the global queue. // Executed only by the owner P. func runqput(_p_ *p, gp *g, next bool) { // è¿™é‡Œæ˜¯ä¸ºäº†æµ‹è¯•ç”¨ä¾‹å¢åŠ éšæœºæ€§çš„ä»£ç  // randomizeScheduleråœ¨æµ‹è¯•ä»£ç ä¸­è¿™é‡Œä¼šè®¾ç½®ä¸ºtrueï¼Œæ­£å¸¸æ˜¯false if randomizeScheduler \u0026\u0026 next \u0026\u0026 fastrandn(2) == 0 { next = false } // next=trueï¼Œå°†gpæ·»åŠ åˆ°_p_.runnextä¸­ã€‚_p_.runnext å¦‚æœæ˜¯énilï¼Œæ˜¯ä¸€ä¸ªå¯è¿è¡Œçš„G // å¦‚æœåœ¨è¿è¡Œ G çš„æ—¶é—´ç‰‡ä¸­æœ‰å‰©ä½™æ—¶é—´ï¼Œé‚£ä¹ˆåº”è¯¥è¿è¡Œä¸‹ä¸€ä¸ªè€Œä¸æ˜¯ runq ä¸­çš„å†…å®¹ if next { retryNext: oldnext := _p_.runnext // åŸå­äº¤æ¢ if !_p_.runnext.cas(oldnext, guintptr(unsafe.Pointer(gp))) { goto retryNext } if oldnext == 0 { return } // Kick the old runnext out to the regular run queue. // æŠŠæ—§çš„runnextè¸¢åˆ°å¸¸è§„çš„runé˜Ÿåˆ—ã€‚ gp = oldnext.ptr() } retry: // _p_çš„runqæ˜¯ä¸€ä¸ª256å¤§å°çš„å¾ªç¯æ•°ç»„ï¼ŒrunqheadæŒ‡å‘å¼€å§‹ï¼ŒrunqtailæŒ‡å‘å°¾éƒ¨ h := atomic.LoadAcq(\u0026_p_.runqhead) // load-acquire, synchronize with consumers t := _p_.runqtail // è¿™é‡Œä¹‹æ‰€ä»¥æ²¡æœ‰ä½¿ç”¨é”ï¼Œæ˜¯ç”±äºè¿™ä¸ªrunqtailåœ¨å…¶ä»–åœ°æ–¹ä¸ä¼šè¢«ä¿®æ”¹ // å¦‚æœt-hå°äºæ€»runqçš„å¤§å°ï¼Œè¯´æ˜è¿˜æ²¡æœ‰å­˜æ»¡ if t-h \u003c uint32(len(_p_.runq)) { // è¿™é‡Œä½¿ç”¨t%uint32(len(_p_.runq))æ˜¯ç”±äºå¯èƒ½å‡ºç°h \u003e tçš„æƒ…å†µï¼Œé‚£ä¹ˆéœ€è¦å§‹ç»ˆæ”¾åœ¨tçš„åé¢ _p_.runq[t%uint32(len(_p_.runq))].set(gp) atomic.StoreRel(\u0026_p_.runqtail, t+1) // store-release, makes the item available for consumption return } // å¦‚æœæœ¬åœ°På·²ç»å­˜æ»¡ï¼Œé‚£ä¹ˆéœ€è¦å»å…¨å±€é‡Œé¢å­˜æ•°æ® if runqputslow(_p_, gp, h, t) { return } // the queue is not full, now the put above must succeed // å¦‚æœä¸Šé¢éƒ½æ²¡æœ‰å­˜å‚¨æˆåŠŸï¼Œé‚£ä¹ˆè·³è½¬åˆ°retryæ ‡ç­¾ç»§ç»­å­˜å‚¨æ•°æ®ï¼Œç›´åˆ°æˆåŠŸ goto retry } runqputslow() æŠŠgpåŠ_p_ä¸­çš„ä¸€åŠçš„Gå°è¯•åŠ å…¥å…¨å±€Gä¸­å» å°†gå’Œä¸€æ‰¹æ¥è‡ªæœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ—çš„å·¥ä½œæ”¾åˆ°å…¨å±€é˜Ÿåˆ—ä¸Šã€‚ ä»…ç”±æ‰€æœ‰è€…Pæ‰§è¡Œã€‚ å‚æ•°ï¼š _p_ *pï¼šå½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„P gp *gï¼šå½“å‰éœ€è¦å¤„ç†çš„ goroutine h, t uint32ï¼š_p_çš„runqæ˜¯ä¸€ä¸ª256å¤§å°çš„å¾ªç¯æ•°ç»„ï¼ŒrunqheadæŒ‡å‘å¼€å§‹ï¼ŒrunqtailæŒ‡å‘å°¾éƒ¨ è¿”å›å€¼ï¼š boolï¼štrue.æ”¾å…¥æˆåŠŸï¼Œfalse.æ”¾å…¥å¤±è´¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 // Put g and a batch of work from local runnable queue on global queue. // Executed only by the owner P. func runqputslow(_p_ *p, gp *g, h, t uint32) bool { // é¦–å…ˆå®šä¹‰batchæ•°ç»„ï¼Œè¿™æ˜¯éœ€è¦å–å‡ºçš„Gæ”¾å…¥çš„æ•°ç»„ // è¿™é‡Œçš„len(_p_.runq)/2 + 1æ˜¯æŠŠgpæ”¾å…¥è¿™ä¸ª+1è¿™é‡Œç®—åœ¨ä¸€èµ·çš„ var batch [len(_p_.runq)/2 + 1]*g // ä¸´æ—¶å®¹å™¨ // First, grab a batch from local queue. // é¦–å…ˆï¼Œä»æœ¬åœ°é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªæ‰¹ã€‚ n := t - h n = n / 2 // å–ä¸€åŠ if n != uint32(len(_p_.runq)/2) { throw(\"runqputslow: queue is not full\") } // å–å‡ºä¸€åŠæ”¾å…¥å®¹å™¨ for i := uint32(0); i \u003c n; i++ { batch[i] = _p_.runq[(h+i)%uint32(len(_p_.runq))].ptr() } // åŸå­äº¤æ¢headç´¢å¼•å€¼ if !atomic.CasRel(\u0026_p_.runqhead, h, h+n) { // cas-release, commits consume return false } batch[n] = gp // gp æ”¾å…¥æœ€åä¸€ä½ // è¿™é‡Œå¦‚æœå¼€å§‹èµ·äº†éšæœºæ€§ï¼Œé‚£ä¹ˆä¼šæŠŠbatché¡ºåºæ‰“ä¹± if randomizeScheduler { for i := uint32(1); i \u003c= n; i++ { j := fastrandn(i + 1) // fastrand() % (i+1) batch[i], batch[j] = batch[j], batch[i] } } // Link the goroutines. // æŠŠbatchä¸­çš„æ‰€æœ‰Gå½¢æˆä¸€ä¸ªé“¾è¡¨é“¾æ¥èµ·æ¥ for i := uint32(0); i \u003c n; i++ { batch[i].schedlink.set(batch[i+1]) } // æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œheadå’Œtailåˆ†åˆ«è¡¨ç¤ºæ­£åºå’Œå€’å™ var q gQueue q.head.set(batch[0]) // æŠŠbatch[0]æŒ‡å‘q.head q.tail.set(batch[n]) // æŠŠbatch[n]æŒ‡å‘q.tail // Now put the batch on global queue. // ç°åœ¨å°†batchæ”¾åˆ°å…¨å±€é˜Ÿåˆ—ä¸­ã€‚ lock(\u0026sched.lock) // è·å– sched ä¸Šçš„ runtime.mutex // æŠŠè®¾ç½®å¥½çš„Gé“¾è¡¨é“¾æ¥æ‹¿åˆ°shced.runqä¸Šå» globrunqputbatch(\u0026q, int32(n+1)) unlock(\u0026sched.lock) // è§£é” return true } globrunqputbatch() æŠŠè®¾ç½®å¥½çš„Gé“¾è¡¨é“¾æ¥æ‹¿åˆ°shced.runqä¸Šå» å°†ä¸€æ‰¹å¯è¿è¡Œçš„ goroutines æ”¾åˆ°å…¨å±€å¯è¿è¡Œé˜Ÿåˆ—ä¸­ã€‚æ¸…é™¤ *batchã€‚ sched.lock å¿…é¡»è¢«æŒæœ‰ã€‚. å¯èƒ½åœ¨STWæœŸé—´è¿è¡Œï¼Œå› æ­¤ä¸å…è®¸å†™å…¥éšœç¢ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // Put a batch of runnable goroutines on the global runnable queue. // This clears *batch. // sched.lock must be held. // May run during STW, so write barriers are not allowed. // //go:nowritebarrierrec func globrunqputbatch(batch *gQueue, n int32) { // åˆ¤æ–­ sched.lock é”æ˜¯å¦æŒæœ‰ assertLockHeld(\u0026sched.lock) // æŠŠè®¾ç½®å¥½çš„Gé“¾è¡¨é“¾æ¥åˆ°sched.runqä¸Šå» sched.runq.pushBackAll(*batch) sched.runqsize += n // æŠŠå…¨å±€é“¾è¡¨æ€»æ•°é‡åŠ ä¸Šn *batch = gQueue{} // æ¸…ç©ºè¿™ä¸ªbatchï¼Œå‡è½»GCå‹åŠ› } v, ok := \u003c-c ç¼–è¯‘åæ˜¯é€šè¿‡è°ƒç”¨ chanrecv2 å‡½æ•°ã€‚ okï¼štrue.ç¡®å®ä»channelä¸­æ¥æ”¶çš„å€¼ï¼ˆä¸æ˜¯å› ä¸ºchannelå…³é—­è€Œå¾—åˆ°çš„é›¶å€¼ï¼‰ã€‚false.å› ä¸ºchannelå…³é—­è€Œè¿”å›çš„é›¶å€¼ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // é€šè¿‡ç¼–è¯‘åï¼š // // if v, ok := \u003c-c; ok { // ... foo // } // // as // // if _, ok = chanrecv2(c, \u0026v); ok { // ... foo // } //go:nosplit func chanrecv2(c *hchan, elem unsafe.Pointer) (received bool) { // 1. (_, true)ï¼šæ•°æ®äº¤æ¢æˆåŠŸï¼Œå¾—åˆ°å¯¹åº”äº¤æ¢çš„æ•°æ®ã€‚ // 2. (_, false)ï¼šå› closeå¯¼è‡´è·å–åˆ°äº†é›¶å€¼æ•°æ®ã€‚ _, received = chanrecv(c, elem, true) return } gopark() å°†å½“å‰ä¾‹ç¨‹ç½®äºç­‰å¾…çŠ¶æ€å¹¶è°ƒç”¨ç³»ç»Ÿå †æ ˆä¸Šçš„ unlockã€‚ å¦‚æœ unlock è¿”å› falseï¼Œåˆ™ç»§ç»­æ‰§è¡Œè¯¥ goroutineã€‚ unlockf ä¸èƒ½è®¿é—®è¿™ä¸ª G çš„å †æ ˆï¼Œå› ä¸ºå®ƒå¯èƒ½åœ¨è°ƒç”¨ gopark å’Œè°ƒç”¨ unlockf ä¹‹é—´ç§»åŠ¨ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 // Puts the current goroutine into a waiting state and calls unlockf on the // system stack. // // If unlockf returns false, the goroutine is resumed. // // unlockf must not access this G's stack, as it may be moved between // the call to gopark and the call to unlockf. // // Note that because unlockf is called after putting the G into a waiting // state, the G may have already been readied by the time unlockf is called // unless there is external synchronization preventing the G from being // readied. If unlockf returns false, it must guarantee that the G cannot be // externally readied. // // Reason explains why the goroutine has been parked. It is displayed in stack // traces and heap dumps. Reasons should be unique and descriptive. Do not // re-use reasons, add new ones. func gopark(unlockf func(*g, unsafe.Pointer) bool, lock unsafe.Pointer, reason waitReason, traceEv byte, traceskip int) { // const waitReasonSleep = 19 // ç­‰å¾…åŸå› ä¸æ˜¯å› ä¸ºsleepæ—¶ï¼ŒæŒ‰éœ€è°ƒç”¨checkTimeouts()ï¼Œæ£€æŸ¥timerã€‚ if reason != waitReasonSleep { // timeouts å¯èƒ½ä¼šåœ¨ä¸¤ä¸ªgoroutineä½¿è°ƒåº¦ç¨‹åºç¹å¿™æ—¶è¿‡æœŸã€‚ // æ£€æŸ¥ p.timers åœ¨è°ƒåº¦å¾ªç¯æ—¶æˆ– goroutine è¢«è°ƒç¦»CPU æˆ– sysmon ç›‘æ§çº¿ç¨‹ä¸­éƒ½ä¼šè½®è¯¢æŸ¥çœ‹ã€‚ checkTimeouts() // timeouts may expire while two goroutines keep the scheduler busy } mp := acquirem() gp := mp.curg // å½“å‰gp status := readgstatus(gp) // è·å–çŠ¶æ€ if status != _Grunning \u0026\u0026 status != _Gscanrunning { throw(\"gopark: bad g status\") } mp.waitlock = lock // ç­‰å¾…çš„é”ï¼Œunlockfçš„ç¬¬äºŒä¸ªå‚æ•° mp.waitunlockf = unlockf// è°ƒç¦»å‰éœ€è¦æ‰§è¡Œçš„é—­åŒ… gp.waitreason = reason mp.waittraceev = traceEv mp.waittraceskip = traceskip releasem(mp) // can't do anything that might move the G between Ms here. mcall(park_m) // mcallä¿å­˜ç°åœºå¹¶åˆ‡æ¢g0è°ƒç”¨park_må‡½æ•°ã€‚ } park_m() è¯¥å‡½æ•°åœ¨g0ä¸Šã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 // park continuation on g0. func park_m(gp *g) { mp := getg().m if trace.enabled { traceGoPark(mp.waittraceev, mp.waittraceskip) } // N.B. Not using casGToWaiting here because the waitreason is // set by park_m's caller. casgstatus(gp, _Grunning, _Gwaiting) // åˆ‡æ¢gpçš„çŠ¶æ€ dropg() // è§£é™¤mä¸gpçš„ç»‘å®š if fn := mp.waitunlockf; fn != nil { ok := fn(gp, mp.waitlock) // è°ƒç”¨waitunlockf mp.waitunlockf = nil mp.waitlock = nil // è¿”å›falseæ—¶ï¼Œå†æ¬¡è¿è¡Œgp if !ok { if trace.enabled { traceGoUnpark(gp, 2) } casgstatus(gp, _Gwaiting, _Grunnable) execute(gp, true) // Schedule it back, never returns. } } schedule() // è°ƒåº¦å¾ªç¯ } close() å…³é—­ hchanã€‚ å‡ ç§å…³é—­ channel çš„æƒ…å†µï¼š close å…³é—­æ—¶ï¼Œsendq ä¸Šæœ‰ç­‰å¾…çš„ goroutineï¼Œä¼š panicã€‚ã€â€œpanic: send on closed channelâ€ã€‘ã€‚ close å…³é—­æ—¶ï¼Œå†æœ‰ send æ“ä½œï¼Œä¼š panicã€‚ã€â€œpanic: send on closed channelâ€ã€‘ã€‚ close å…³é—­æ—¶ï¼Œbuf ä¸­æœ‰æ•°æ®ï¼Œä¸ä¼š panicï¼Œrecv å¯ä»¥è¯»å–å®ƒä»¬ã€‚ å‘ nil çš„ channelï¼Œsend æˆ– recv æ—¶å½“å‰ goroutine ä¼španicã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 func closechan(c *hchan) { // 1) nil çš„ chan æ˜¯ä¸å…è®¸è¢« close çš„ if c == nil {\tpanic(plainError(\"close of nil channel\")) } lock(\u0026c.lock) // å°è¯•è·å– runtime.mutex // 2) å·²ç»å…³é—­çš„ chan ä¸èƒ½å†æ¬¡å…³é—­ if c.closed != 0 {\tunlock(\u0026c.lock) panic(plainError(\"close of closed channel\")) } if raceenabled { callerpc := getcallerpc() racewritepc(c.raceaddr(), callerpc, abi.FuncPCABIInternal(closechan)) racerelease(c.raceaddr()) } // 3) è·å–åˆ°äº’æ–¥é”åé¦–å…ˆæ ‡è®°closedå­—æ®µ c.closed = 1 // æ ‡è®°chançŠ¶æ€ä¸ºå…³é—­ 0.æœªå…³é—­ 1.å·²å…³é—­ // gListæ˜¯ä¸€ä¸ªgoroutineçš„é“¾è¡¨ // å½“å‰è¦å…³é—­çš„cè¿˜æœªå¤„ç†çš„goroutine var glist gList // 4) å¤„ç† recvq ä¸Šçš„ goroutine // release all readers for { // å¦‚æœåŒä¸€ä¸ªgoroutineåœ¨å¤šä¸ªchannelä¸Šæ—¶ï¼ˆè¿™ç§æƒ…å†µå‘ç”Ÿåœ¨goselectæ—¶ï¼‰ // dequeue() å‡½æ•°æœ‰ç›¸å…³çš„æ’é‡ï¼ŒCASæ“ä½œã€‚ sg := c.recvq.dequeue() if sg == nil { break } if sg.elem != nil { typedmemclr(c.elemtype, sg.elem) sg.elem = nil } if sg.releasetime != 0 { sg.releasetime = cputicks() } gp := sg.g // ä¸»è¦ç”¨ä¸ select è¯­å¥å”¤é†’åä½¿ç”¨ã€‚ gp.param = unsafe.Pointer(sg) // g.param = *sudog sg.success = false if raceenabled { raceacquireg(gp, c.raceaddr()) } glist.push(gp) } // 5) å¤„ç† sendq ä¸Šçš„ goroutineï¼Œè¿™äº›goroutineå¾—åˆ°è¿è¡Œåä¼š panicã€‚ // å› ä¸ºä¸èƒ½å‘closeçš„channelæœ‰sendæ“ä½œï¼Œå…¶ä¸­ä¸€ç§æƒ…å†µä½“ç°åœ¨è¿™é‡Œã€‚ // release all writers (they will panic) for { sg := c.sendq.dequeue() if sg == nil { break } sg.elem = nil if sg.releasetime != 0 { sg.releasetime = cputicks() } gp := sg.g // ä¸»è¦ç”¨ä¸ select è¯­å¥å”¤é†’åä½¿ç”¨ã€‚ gp.param = unsafe.Pointer(sg) // g.param = *sudog sg.success = false if raceenabled { raceacquireg(gp, c.raceaddr()) } glist.push(gp) } unlock(\u0026c.lock) // 6) å°†è¿™äº› goroutine æ”¾å›ç­‰å¾…é˜Ÿåˆ—ä¸­ // Ready all Gs now that we've dropped the channel lock. for !glist.empty() { gp := glist.pop() gp.schedlink = 0 // å°†gpæ”¾å…¥æœ¬åœ°Pçš„é˜Ÿåˆ—ä¸­ goready(gp, 3) } } type guintptr uintptr 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 // A guintptr holds a goroutine pointer, but typed as a uintptr // to bypass write barriers. It is used in the Gobuf goroutine state // and in scheduling lists that are manipulated without a P. // // The Gobuf.g goroutine pointer is almost always updated by assembly code. // In one of the few places it is updated by Go code - func save - it must be // treated as a uintptr to avoid a write barrier being emitted at a bad time. // Instead of figuring out how to emit the write barriers missing in the // assembly manipulation, we change the type of the field to uintptr, // so that it does not require write barriers at all. // // Goroutine structs are published in the allg list and never freed. // That will keep the goroutine structs from being collected. // There is never a time that Gobuf.g's contain the only references // to a goroutine: the publishing of the goroutine in allg comes first. // Goroutine pointers are also kept in non-GC-visible places like TLS, // so I can't see them ever moving. If we did want to start moving data // in the GC, we'd need to allocate the goroutine structs from an // alternate arena. Using guintptr doesn't make that problem any worse. // Note that pollDesc.rg, pollDesc.wg also store g in uintptr form, // so they would need to be updated too if g's start moving. type guintptr uintptr //go:nosplit func (gp guintptr) ptr() *g { return (*g)(unsafe.Pointer(gp)) } //go:nosplit func (gp *guintptr) set(g *g) { *gp = guintptr(unsafe.Pointer(g)) } //go:nosplit func (gp *guintptr) cas(old, new guintptr) bool { return atomic.Casuintptr((*uintptr)(unsafe.Pointer(gp)), uintptr(old), uintptr(new)) } type gList struct 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 // A gList is a list of Gs linked through g.schedlink. A G can only be // on one gQueue or gList at a time. type gList struct { head guintptr } // empty reports whether l is empty. func (l *gList) empty() bool { return l.head == 0 } // push adds gp to the head of l. func (l *gList) push(gp *g) { gp.schedlink = l.head l.head.set(gp) } // pushAll prepends all Gs in q to l. func (l *gList) pushAll(q gQueue) { if !q.empty() { q.tail.ptr().schedlink = l.head l.head = q.head } } // pop removes and returns the head of l. If l is empty, it returns nil. func (l *gList) pop() *g { gp := l.head.ptr() if gp != nil { l.head = gp.schedlink } return gp } len() è·å– chan çš„å…ƒç´ ä¸ªæ•°ã€‚ï¼ˆè·å–çš„æ˜¯ç¼“å­˜åŒºçš„ä¸ªæ•°ï¼Œæ²¡æœ‰æŒ‚åœ¨é“¾è¡¨ä¸­çš„æ•°é‡ï¼‰ 1 2 3 4 5 6 7 //go:linkname reflect_chanlen reflect.chanlen func reflect_chanlen(c *hchan) int { if c == nil { return 0 } return int(c.qcount) } 1 2 3 4 5 6 7 //go:linkname reflectlite_chanlen internal/reflectlite.chanlen func reflectlite_chanlen(c *hchan) int { if c == nil { return 0 } return int(c.qcount) } cap() è¿”å›å€¼å’Œlen()å‡½æ•°ä¸€è‡´ã€‚ 1 2 3 4 5 6 7 //go:linkname reflect_chancap reflect.chancap func reflect_chancap(c *hchan) int { if c == nil { return 0 } return int(c.dataqsiz) } select default ä»¥ä¸‹æ˜¯å­˜åœ¨ default é»˜è®¤åˆ†æ”¯æƒ…å†µã€‚æ„æ€ç±»ä¼¼äº tryLock å‡½æ•°ï¼Œå°è¯•ä¸€æ¬¡ã€‚ ä»¥ä¸‹åªæ˜¯ç‰¹ä¾‹ï¼Œç¼–è¯‘å™¨ä¸é‡‡ç”¨ goselect() å‡½æ•°æ—¶ã€‚éƒ½æ˜¯ select {case: default:} è¿™ç§å½¢å¼ã€‚ select ä¸­ c \u003c- v 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // compiler implements // //\tselect { //\tcase c \u003c- v: //\t... foo //\tdefault: //\t... bar //\t} // // as // //\tif selectnbsend(c, v) { //\t... foo //\t} else { //\t... bar //\t} func selectnbsend(c *hchan, elem unsafe.Pointer) (selected bool) { // true. æ•°æ®sendå®Œæˆã€‚ // false. è¡¨ç¤ºç›®å‰ä¸èƒ½å‘é€ï¼Œå› ä¸ºä¸æƒ³é˜»å¡(blockä¸ºfalse)è€Œè¿”å›ã€‚ // falseåªåœ¨è¿™é‡Œè¢«ä¼ å…¥ä½¿ç”¨ã€‚ return chansend(c, elem, false, getcallerpc()) } éªŒè¯ä¸Šé¢ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 func chanTs() { ch := make(chan int) a, b := 1, 2 select { case ch \u003c- a: a = b default: b = a } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 TEXT main.chanTs(SB) G:/workspace/hello/main.go func chanTs() { 0x490ae0 493b6610 CMPQ 0x10(R14), SP 0x490ae4 0f8685000000 JBE 0x490b6f 0x490aea 4883ec40 SUBQ $0x40, SP 0x490aee 48896c2438 MOVQ BP, 0x38(SP) 0x490af3 488d6c2438 LEAQ 0x38(SP), BP ch := make(chan int) 0x490af8 488d05419b0000 LEAQ runtime.rodata+30272(SB), AX 0x490aff 31db XORL BX, BX 0x490b01 e8da3cf7ff CALL runtime.makechan(SB) 0x490b06 4889442428 MOVQ AX, 0x28(SP) a, b := 1, 2 0x490b0b 48c744241801000000 MOVQ $0x1, 0x18(SP) 0x490b14 48c744241002000000 MOVQ $0x2, 0x10(SP) case ch \u003c- a: 0x490b1d 488b4c2428 MOVQ 0x28(SP), CX 0x490b22 48894c2430 MOVQ CX, 0x30(SP) 0x490b27 488b4c2418 MOVQ 0x18(SP), CX 0x490b2c 48894c2420 MOVQ CX, 0x20(SP) 0x490b31 488b442430 MOVQ 0x30(SP), AX # å‚æ•° c 0x490b36 488d5c2420 LEAQ 0x20(SP), BX # å‚æ•° elem 0x490b3b 0f1f440000 NOPL 0(AX)(AX*1) 0x490b40 e89b55f7ff CALL runtime.selectnbsend(SB) # è°ƒç”¨selectnbsend 0x490b45 84c0 TESTL AL, AL 0x490b47 7502 JNE 0x490b4b 0x490b49 eb0c JMP 0x490b57 a = b 0x490b4b 488b442410 MOVQ 0x10(SP), AX 0x490b50 4889442418 MOVQ AX, 0x18(SP) 0x490b55 eb0c JMP 0x490b63 b = a 0x490b57 488b442418 MOVQ 0x18(SP), AX 0x490b5c 4889442410 MOVQ AX, 0x10(SP) 0x490b61 eb00 JMP 0x490b63 case ch \u003c- a: 0x490b63 eb00 JMP 0x490b65 } 0x490b65 488b6c2438 MOVQ 0x38(SP), BP 0x490b6a 4883c440 ADDQ $0x40, SP 0x490b6e c3 RET func chanTs() { 0x490b6f e8ecb4fcff CALL runtime.morestack_noctxt.abi0(SB) 0x490b74 e967ffffff JMP main.chanTs(SB) 0x490b79 cc INT $0x3 0x490b7a cc INT $0x3 0x490b7b cc INT $0x3 0x490b7c cc INT $0x3 0x490b7d cc INT $0x3 0x490b7e cc INT $0x3 0x490b7f cc INT $0x3 select ä¸­ v \u003c- c åœ¨ go1.18ç‰ˆæœ¬å‰ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 // compiler implements // // select { // case v = \u003c-c: // ... foo // default: // ... bar // } // // as // // if selectnbrecv(\u0026v, c) { // ... foo // } else { // ... bar // } // func selectnbrecv(elem unsafe.Pointer, c *hchan) (selected bool) { // selectedï¼šè¡¨ç¤ºå½“å‰åˆ†æ”¯æ˜¯å¦é€‰ä¸­ selected, _ = chanrecv(c, elem, false) return } select ä¸­ v, ok = \u003c- c åœ¨ go1.18ç‰ˆæœ¬å‰ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // compiler implements // // select { // case v, ok = \u003c-c: // ... foo // default: // ... bar // } // // as // // if c != nil \u0026\u0026 selectnbrecv2(\u0026v, \u0026ok, c) { // ... foo // } else { // ... bar // } // func selectnbrecv2(elem unsafe.Pointer, received *bool, c *hchan) (selected bool) { // TODO(khr): just return 2 values from this function, now that it is in Go. // selectedï¼šè¡¨ç¤ºå½“å‰åˆ†æ”¯æ˜¯å¦é€‰ä¸­ // receivedï¼šè¡¨ç¤ºå½“å‰æ˜¯å¦å› ä¸º close è€Œå…³é—­çš„é›¶å€¼ selected, *received = chanrecv(c, elem, false) return } å…¶ä»–ç‰ˆæœ¬ åœ¨go1.19.3ä¸­ï¼Œ\u003c-c æœ‰æ‰€æ”¹å˜ä½†æ˜¯åŸç†éƒ½ä¸€æ ·ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 // compiler implements // // select { // case v, ok = \u003c-c: // ... foo // default: // ... bar // } // // as // // if selected, ok = selectnbrecv(\u0026v, c); selected { // ... foo // } else { // ... bar // } func selectnbrecv(elem unsafe.Pointer, c *hchan) (selected, received bool) { // selectedï¼šè¡¨ç¤ºå½“å‰åˆ†æ”¯æ˜¯å¦é€‰ä¸­ // receivedï¼šè¡¨ç¤ºå½“å‰æ˜¯å¦å› ä¸º close è€Œå…³é—­çš„é›¶å€¼ return chanrecv(c, elem, false) } // // select { // case v = \u003c-c: // ... foo // default: // ... bar // } // // as // // if selected, _ = selectnbrecv(\u0026v, c); selected { // ... foo // } else { // ... bar // } éªŒè¯ä¸Šé¢ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func chanTs() { ch := make(chan int) a, b := 1, 2 var ok bool select { case a, ok = \u003c-ch: b = a if ok { b = 100 } default: a = b } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 TEXT main.chanTs(SB) G:/workspace/hello/main.go func chanTs() { 0x490ae0 493b6610 CMPQ 0x10(R14), SP 0x490ae4 0f86aa000000 JBE 0x490b94 0x490aea 4883ec48 SUBQ $0x48, SP 0x490aee 48896c2440 MOVQ BP, 0x40(SP) 0x490af3 488d6c2440 LEAQ 0x40(SP), BP ch := make(chan int) 0x490af8 488d05419b0000 LEAQ runtime.rodata+30272(SB), AX 0x490aff 31db XORL BX, BX 0x490b01 e8da3cf7ff CALL runtime.makechan(SB) 0x490b06 4889442430 MOVQ AX, 0x30(SP) a, b := 1, 2 0x490b0b 48c744242001000000 MOVQ $0x1, 0x20(SP) 0x490b14 48c744241802000000 MOVQ $0x2, 0x18(SP) var ok bool 0x490b1d c644241500 MOVB $0x0, 0x15(SP) case a, ok = \u003c-ch: 0x490b22 488b5c2430 MOVQ 0x30(SP), BX 0x490b27 48895c2438 MOVQ BX, 0x38(SP) 0x490b2c 488d442428 LEAQ 0x28(SP), AX 0x490b31 e8aa55f7ff CALL runtime.selectnbrecv(SB) # selectnbrecv 0x490b36 88442416 MOVB AL, 0x16(SP) 0x490b3a 885c2417 MOVB BL, 0x17(SP) 0x490b3e 807c241600 CMPB $0x0, 0x16(SP) if ok { 0x490b64 807c241500 CMPB $0x0, 0x15(SP) 0x490b69 7502 JNE 0x490b6d 0x490b6b eb0b JMP 0x490b78 b = 100 0x490b6d 48c744241864000000 MOVQ $0x64, 0x18(SP) 0x490b76 eb02 JMP 0x490b7a if ok { 0x490b78 eb00 JMP 0x490b7a case a, ok = \u003c-ch: 0x490b7a eb0c JMP 0x490b88 a = b 0x490b7c 488b442418 MOVQ 0x18(SP), AX 0x490b81 4889442420 MOVQ AX, 0x20(SP) 0x490b86 eb00 JMP 0x490b88 case a, ok = \u003c-ch: 0x490b88 eb00 JMP 0x490b8a } 0x490b8a 488b6c2440 MOVQ 0x40(SP), BP 0x490b8f 4883c448 ADDQ $0x48, SP 0x490b93 c3 RET func chanTs() { 0x490b94 e8c7b4fcff CALL runtime.morestack_noctxt.abi0(SB) 0x490b99 e942ffffff JMP main.chanTs(SB) 0x490b9e cc INT $0x3 0x490b9f cc INT $0x3 for range å‚è€ƒ æµç¨‹æ§åˆ¶(rangeè¿­ä»£)ã€‚ æ€»ç»“ å‘(æ²¡åœ¨selectå—ä¸­) nil çš„ channel ä¸­ sendã€recv ä¼š panicã€‚åœ¨selectå—ä¸­ nil çš„ channel ä¼šè¢«ä¸¢å¼ƒã€‚ send æ€»æ˜¯å…ˆåˆ¤æ–­çš„ closeï¼ˆpanicï¼‰ï¼Œå†åˆ¤æ–­çš„æ•°æ®èƒ½å¦äº¤æ¢(selectä¸­çš„ä¹Ÿä¸€æ ·)ã€‚recv ä¹Ÿæ˜¯å…ˆåˆ¤æ–­ close ä½†æ˜¯ä¸ä¼španicï¼Œå†åˆ¤æ–­ buf æœ‰æ²¡æ•°æ®ï¼Œæœ‰åˆ™å–å‡ºï¼Œä¸ä¼šå» sendq ä¸­æŸ¥çœ‹æŒ‚èµ·çš„ sudogã€‚ nil çš„ channel ä¸å…è®¸ close æ“ä½œï¼Œä¼š panicã€‚close å·²ç» close çš„ channel ä¼š panicã€‚ å‚è€ƒ https://mp.weixin.qq.com/s/6ZEGtXRGKm2qP5b-rGLyVg https://mp.weixin.qq.com/s?__biz=Mzg5NjIwNzIxNQ==\u0026mid=2247484471\u0026idx=2\u0026sn=49af599b9c3796857459a14d040586fd\u0026scene=19#wechat_redirect ",
  "wordCount" : "9192",
  "inLanguage": "zh",
  "image": "https://helium-chain.github.io/favicon-32x32.png","datePublished": "2024-08-01T00:00:00Z",
  "dateModified": "2024-08-01T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://helium-chain.github.io/posts/golang/channel/theory/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://helium-chain.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://helium-chain.github.io/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://helium-chain.github.io/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://helium-chain.github.io/" title="ä¸»é¡µ">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://helium-chain.github.io/posts" title="æ–‡ç« ">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://helium-chain.github.io/archives" title="æ—¶é—´è½´">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://helium-chain.github.io/tags/" title="æ ‡ç­¾">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://helium-chain.github.io/search/" title="æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://helium-chain.github.io/support" title="æ‰“èµ">
                    <span>ğŸ«¶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://helium-chain.github.io/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://helium-chain.github.io/posts/">Article</a>&nbsp;Â»&nbsp;<a href="https://helium-chain.github.io/posts/golang/">Golang</a>&nbsp;Â»&nbsp;<a href="https://helium-chain.github.io/posts/golang/channel/">ç¬¬13ç«  Channel</a></div>
    <h1 class="post-title entry-hint-parent">
      Channel(åŸç†)
    </h1>
    <div class="post-description">
      ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬
    </div>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2024-08-01</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2024-08-01</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>9192å­—</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>44åˆ†é’Ÿ</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &nbsp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://helium-chain.github.io/tags/golang/" target="_blank" rel="noopener">Golang</a>
            <a href="https://helium-chain.github.io/tags/channel/" target="_blank" rel="noopener">Channel</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &nbsp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#type-hchan-struct" aria-label="type hchan struct">type hchan struct</a><ul>
                            
                    <li>
                        <a href="#raceaddr" aria-label="raceaddr()">raceaddr()</a></li>
                    <li>
                        <a href="#sortkey" aria-label="sortkey()">sortkey()</a></li></ul>
                    </li>
                    <li>
                        <a href="#constant" aria-label="Constant">Constant</a></li>
                    <li>
                        <a href="#type-waitq-struct" aria-label="type waitq struct">type waitq struct</a><ul>
                            
                    <li>
                        <a href="#dequeue" aria-label="dequeue()">dequeue()</a></li>
                    <li>
                        <a href="#enqueue" aria-label="enqueue()">enqueue()</a></li>
                    <li>
                        <a href="#dequeuesudog" aria-label="dequeueSudoG()">dequeueSudoG()</a></li></ul>
                    </li>
                    <li>
                        <a href="#type-sudog-struct" aria-label="type sudog struct">type sudog struct</a></li>
                    <li>
                        <a href="#make" aria-label="make()">make()</a><ul>
                            
                    <li>
                        <a href="#makechan" aria-label="makechan()">makechan()</a></li>
                    <li>
                        <a href="#makechan64" aria-label="makechan64()">makechan64()</a></li></ul>
                    </li>
                    <li>
                        <a href="#c---ep" aria-label="c &amp;lt;- ep">c &lt;- ep</a><ul>
                            
                    <li>
                        <a href="#chansend1" aria-label="chansend1()">chansend1()</a></li>
                    <li>
                        <a href="#chansend" aria-label="chansend()">chansend()</a></li>
                    <li>
                        <a href="#full" aria-label="full()">full()</a></li>
                    <li>
                        <a href="#send" aria-label="send()">send()</a><ul>
                            
                    <li>
                        <a href="#senddirect" aria-label="sendDirect()">sendDirect()</a></li>
                    <li>
                        <a href="#goready" aria-label="goready()">goready()</a></li>
                    <li>
                        <a href="#ready" aria-label="ready()">ready()</a></li></ul>
                    </li>
                    <li>
                        <a href="#chanbuf" aria-label="chanbuf()">chanbuf()</a></li></ul>
                    </li>
                    <li>
                        <a href="#ep---c" aria-label="ep &amp;lt;- c">ep &lt;- c</a><ul>
                            
                    <li>
                        <a href="#chanrecv" aria-label="chanrecv()">chanrecv()</a></li>
                    <li>
                        <a href="#empty" aria-label="empty()">empty()</a></li>
                    <li>
                        <a href="#recv" aria-label="recv()">recv()</a><ul>
                            
                    <li>
                        <a href="#goready-1" aria-label="goready()">goready()</a></li>
                    <li>
                        <a href="#ready-1" aria-label="ready()">ready()</a></li>
                    <li>
                        <a href="#runqput" aria-label="runqput()">runqput()</a></li>
                    <li>
                        <a href="#runqputslow" aria-label="runqputslow()">runqputslow()</a></li>
                    <li>
                        <a href="#globrunqputbatch" aria-label="globrunqputbatch()">globrunqputbatch()</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#v-ok---c" aria-label="v, ok := &amp;lt;-c">v, ok := &lt;-c</a></li>
                    <li>
                        <a href="#gopark" aria-label="gopark()">gopark()</a><ul>
                            
                    <li>
                        <a href="#park_m" aria-label="park_m()">park_m()</a></li></ul>
                    </li>
                    <li>
                        <a href="#close" aria-label="close()">close()</a><ul>
                            
                    <li>
                        <a href="#type-guintptr-uintptr" aria-label="type guintptr uintptr">type guintptr uintptr</a></li>
                    <li>
                        <a href="#type-glist-struct" aria-label="type gList struct">type gList struct</a></li></ul>
                    </li>
                    <li>
                        <a href="#len" aria-label="len()">len()</a></li>
                    <li>
                        <a href="#cap" aria-label="cap()">cap()</a></li>
                    <li>
                        <a href="#select-default" aria-label="select default">select default</a><ul>
                            
                    <li>
                        <a href="#select-%e4%b8%ad-c---v" aria-label="select ä¸­ c &amp;lt;- v">select ä¸­ c &lt;- v</a></li>
                    <li>
                        <a href="#select-%e4%b8%ad-v---c" aria-label="select ä¸­ v &amp;lt;- c">select ä¸­ v &lt;- c</a></li>
                    <li>
                        <a href="#select-%e4%b8%ad-v-ok----c" aria-label="select ä¸­ v, ok = &amp;lt;- c">select ä¸­ v, ok = &lt;- c</a><ul>
                            
                    <li>
                        <a href="#%e5%85%b6%e4%bb%96%e7%89%88%e6%9c%ac" aria-label="å…¶ä»–ç‰ˆæœ¬">å…¶ä»–ç‰ˆæœ¬</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#for-range" aria-label="for range">for range</a></li>
                    <li>
                        <a href="#%e6%80%bb%e7%bb%93" aria-label="æ€»ç»“">æ€»ç»“</a></li>
                    <li>
                        <a href="#%e5%8f%82%e8%80%83" aria-label="å‚è€ƒ">å‚è€ƒ</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><p><strong>åŒ…è§£é‡Š</strong>ï¼š</p>
<ol>
<li>è¯¥æ–‡ä»¶åŒ…å« Go channels çš„å®ç°ã€‚</li>
<li>c.sendq å’Œ c.recvq ä¸­è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯ç©ºçš„ï¼Œé™¤äº†ä½¿ç”¨ select è¯­å¥å‘é€å’Œæ¥æ”¶çš„æ— ç¼“å†² chan ä¸Šé˜»æ­¢äº†å•ä¸ª goroutine çš„æƒ…å†µå¤–ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œc.sendq å’Œc.recvq çš„é•¿åº¦ä»…å— select è¯­å¥çš„å¤§å°é™åˆ¶ã€‚</li>
<li>select åŒæ—¶æ“ä½œå•ä¸ªæ— ç¼“å†² chan çš„è¯»å’Œå†™è¿™ç§æƒ…å†µä¸‹å¯èƒ½å­˜åœ¨ c.sendq å’Œ c.recvq éƒ½ä¸ä¸ºç©ºï¼ˆè¿™ç§æƒ…å†µä¸‹ selectä¸èƒ½æœ‰ default åˆ†æ”¯ï¼‰ã€‚</li>
<li>å¯¹äºç¼“å†² channelsï¼Œä¹Ÿæ˜¯:
<ul>
<li>c.qcount &gt; 0 è¡¨ç¤º c.recvq ä¸ºç©ºã€‚ç¼“å­˜åŒºæœ‰å€¼åˆ™ c.recvq ä¸€å®šä¸ºç©ºã€‚</li>
<li>c.qcount &lt; c.dataqsiz æ„å‘³ç€ c.sendq æ˜¯ç©ºçš„ã€‚ç¼“å­˜åŒºæ²¡æœ‰æ»¡åˆ™ c.sendq ä¸€å®šä¸ºç©ºã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">runtime</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// This file contains the implementation of Go channels.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Invariants:
</span></span></span><span class="line"><span class="cl"><span class="c1">//  At least one of c.sendq and c.recvq is empty,
</span></span></span><span class="line"><span class="cl"><span class="c1">//  except for the case of an unbuffered channel with a single goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1">//  blocked on it for both sending and receiving using a select statement,
</span></span></span><span class="line"><span class="cl"><span class="c1">//  in which case the length of c.sendq and c.recvq is limited only by the
</span></span></span><span class="line"><span class="cl"><span class="c1">//  size of the select statement.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// For buffered channels, also:
</span></span></span><span class="line"><span class="cl"><span class="c1">//  c.qcount &gt; 0 implies that c.recvq is empty.
</span></span></span><span class="line"><span class="cl"><span class="c1">//  c.qcount &lt; c.dataqsiz implies that c.sendq is empty.
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="type-hchan-struct">type hchan struct<a hidden class="anchor" aria-hidden="true" href="#type-hchan-struct">#</a></h2>
<ol>
<li>hchan ç»“æ„å…¶å®å°±æ˜¯ä¸€ä¸ªã€æœ‰ç¼“å†²ã€‘å’Œã€åŒå‘é“¾è¡¨ã€‘ç»„æˆçš„é˜Ÿåˆ—ã€‚</li>
<li>è¿™ä¸ªé˜Ÿåˆ—ç»´æŠ¤ç€é€šä¿¡çš„æ•°æ®ï¼Œä»¥åŠæŒ‚èµ·ç­‰å¾…çš„ goroutineã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">hchan</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å·²æœ‰å…ƒç´ ä¸ªæ•°ï¼ˆä¹Ÿå°±æ˜¯é€šé“ä¸­å…ƒç´ ä¸ªæ•°ï¼‰len(chan)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç¼“å­˜åŒºå…ƒç´ ä¸ªæ•°ï¼Œä¸åŒ…æ‹¬sendqä¸Šé¢çš„goroutineæ•°é‡(å¦‚æœå­˜åœ¨)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">qcount</span>   <span class="kt">uint</span>   <span class="c1">// total data in the queue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ•°ç»„å®¹é‡ï¼ˆä¹Ÿå°±æ˜¯chanå®¹é‡ï¼‰cap(chan)	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¹Ÿå°±æ˜¯ make(chan int, size) è¿™é‡Œçš„size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">dataqsiz</span> <span class="kt">uint</span>   <span class="c1">// size of the circular queue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æœ‰ç¼“å†²æ•°ç»„åœ°å€æŒ‡é’ˆï¼Œè¿™é‡Œæ˜¯æ ¹æ® dataqsiz*elemsize è®¡ç®—åˆ†é…çš„å†…å­˜æ•°ç»„å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">buf</span>      <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// points to an array of dataqsiz elements
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å…ƒç´ å¤§å°ï¼Œæ¯”å¦‚intè¿™é‡Œå­˜å‚¨çš„å°±æ˜¯8ï¼Œstringçš„è¯è¿™é‡Œå­˜å‚¨çš„å°±æ˜¯16
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">elemsize</span> <span class="kt">uint16</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// é€šé“æ˜¯å¦è¢«å…³é—­ 1.è¢«å…³é—­ 0.æ­£å¸¸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">closed</span>   <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// chanå…ƒç´ ç±»å‹ï¼ŒæŒ‡å‘ç±»å‹å…ƒæ•°æ®ï¼Œæ¯”å¦‚chan intè¿™é‡Œè®°å½•çš„å°±æ˜¯intçš„å…ƒç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">elemtype</span> <span class="o">*</span><span class="nx">_type</span> <span class="c1">// element type
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰ç´¢å¼•ï¼ˆè®°å½•ä¸‹ä¸€æ¬¡sendä¸‹æ ‡ï¼‰ï¼Œä¸‹ä¸€æ¬¡å†™å–ä½ç½®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sendx</span>    <span class="kt">uint</span>   <span class="c1">// send index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰ç´¢å¼•ï¼ˆè®°å½•ä¸‹ä¸€æ¬¡recvä¸‹æ ‡ï¼‰ï¼Œä¸‹ä¸€æ¬¡è¯»å…¥ä½ç½®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">recvx</span>    <span class="kt">uint</span>   <span class="c1">// receive index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç­‰å¾…å†™çš„é˜Ÿåˆ—ï¼Œæ˜¯ä¸€ä¸ªåŒå‘çš„goroutineé“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">recvq</span>    <span class="nx">waitq</span>  <span class="c1">// list of recv waiters
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç­‰å¾…è¯»çš„é˜Ÿåˆ—ï¼Œæ˜¯ä¸€ä¸ªåŒå‘çš„goroutineé“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sendq</span>    <span class="nx">waitq</span>  <span class="c1">// list of send waiters
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// lock protects all fields in hchan, as well as several
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// fields in sudogs blocked on this channel.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Do not change another G&#39;s status while holding this lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// (in particular, do not ready a G), as this can deadlock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// with stack shrinking.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// lockä¿æŠ¤hchanä¸­çš„æ‰€æœ‰å­—æ®µï¼Œä»¥åŠsudogsä¸­çš„ä¸€äº›å­—æ®µåœ¨è¿™ä¸ªé€šé“ä¸Šè¢«é˜»å¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨æŒæœ‰è¯¥é”æ—¶ï¼Œä¸è¦æ”¹å˜å¦ä¸€ä¸ªGçš„çŠ¶æ€(ç‰¹åˆ«æ˜¯ä¸è¦å‡†å¤‡ä¸€ä¸ªG)ï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šå¯¼è‡´æ ˆæ”¶ç¼©æ­»é”ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">lock</span> <span class="nx">mutex</span>	<span class="c1">// runtime.mutex ä¸ºäº†åº”å¯¹å¹¶å‘çš„è¯»å†™chanï¼Œå‚çœ‹runtime.mutexç›¸å…³æ–‡æ¡£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>hchan ç¼“å­˜åŒºå†…å­˜å¸ƒå±€å›¾ï¼ˆå¦‚æœå­˜åœ¨ç¼“å­˜åŒºæ—¶ï¼‰</li>
</ol>
<p><img loading="lazy" src="../images/channel-001.png" alt=""  />
</p>
<h3 id="raceaddr">raceaddr()<a hidden class="anchor" aria-hidden="true" href="#raceaddr">#</a></h3>
<ol>
<li>è¯¥å‡½æ•°ä¸»è¦ç”¨äº make() å‡½æ•°ä¸­ï¼Œå½“ç”³è¯·æ€»å†…å­˜ä¸º0æ—¶ï¼Œè¿”å›å½“å‰bufå­—æ®µåœ°å€ä½œä¸º buf çš„å€¼ã€‚å½¢æˆæŒ‡é’ˆæŒ‡å‘é—­ç¯ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">)</span> <span class="nf">raceaddr</span><span class="p">()</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Treat read-like and write-like operations on the channel to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// happen at this address. Avoid using the address of qcount
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// or dataqsiz, because the len() and cap() builtins read
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// those addresses, and we don&#39;t want them racing with
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// operations like close().
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å°†channelä¸Šçš„read-likeå’Œwrite-likeæ“ä½œè§†ä¸ºåœ¨æ­¤åœ°å€å‘ç”Ÿã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é¿å…ä½¿ç”¨qcountæˆ–dataqsizçš„åœ°å€ï¼Œå› ä¸ºlen()å’Œcap()å†…ç½®å‡½æ•°ä¼šè¯»å–è¿™äº›åœ°å€ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›å®ƒä»¬ä¸close()ç­‰æ“ä½œç«äº‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="sortkey">sortkey()<a hidden class="anchor" aria-hidden="true" href="#sortkey">#</a></h3>
<ol>
<li>è¯¥å‡½æ•°åœ¨ goselect() å‡½æ•°ä¸­ä½¿ç”¨ï¼Œç”¨äºè¿”å› chan åœ°å€å‡åºæ’åº channelsã€‚</li>
<li>select ä¸­ç›¸å…³ç”¨åˆ°çš„å‡½æ•°ã€‚åœ¨åé¢ä»‹ç»selectæ—¶ï¼Œä¼šè¢«ä½¿ç”¨ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">)</span> <span class="nf">sortkey</span><span class="p">()</span> <span class="kt">uintptr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">c</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="constant">Constant<a hidden class="anchor" aria-hidden="true" href="#constant">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æœ€å¤§å¯¹é½å­—èŠ‚æ•°ï¼Œä¸»è¦ç”¨äºä¸‹é¢çš„å®šä¹‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">maxAlign</span>  <span class="p">=</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// hchan å ç”¨å†…å­˜å¤§å°å­—èŠ‚ï¼Œä½¿ hchan æŒ‰ç…§ maxAlign å¤§å°å¯¹é½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ¯”å¦‚ hchan æ˜¯ 12byteï¼Œé‚£ä¹ˆ hchanSize åˆ™æ˜¯ 16byte
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸ºä»€ä¹ˆè¦ä½¿ hchan å¯¹é½ maxAlignï¼ŸåŸå› æ˜¯ hchan åæ¥ç€æ˜¯ chan å…ƒç´ çš„å†…å­˜ç©ºé—´å—(å¦‚æœæ˜¯æœ‰ç¼“å†²æƒ…å†µä¸‹)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™ç§æƒ…å†µæ˜¯ä¸ºäº†å…¼å®¹32ä½ï¼Œå› ä¸ºåœ¨64ä½ä¸‹hchanå°±æ˜¯8å­—èŠ‚å¯¹é½çš„ï¼Œè¯¥å­—æ®µç”¨äºmakeå‡½æ•°ä¸­ç”³è¯· chan å†…å­˜éœ€è¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">hchanSize</span> <span class="p">=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">hchan</span><span class="p">{})</span> <span class="o">+</span> <span class="nb">uintptr</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">hchan</span><span class="p">{}))</span><span class="o">&amp;</span><span class="p">(</span><span class="nx">maxAlign</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">debugChan</span> <span class="p">=</span> <span class="kc">false</span>	<span class="c1">// debug
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="type-waitq-struct">type waitq struct<a hidden class="anchor" aria-hidden="true" href="#type-waitq-struct">#</a></h2>
<ol>
<li>waitq æ ¹æ® sudog å½¢æˆä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚</li>
<li>å…¶å®å°±æ˜¯ä¸€ä¸ªé˜Ÿåˆ—çš„åŠŸèƒ½ï¼Œå…ƒç´ ã€ä» last å¤„æ·»åŠ ã€‘ï¼Œã€ä» first å¤„å–å‡ºã€‘ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">waitq</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">first</span> <span class="o">*</span><span class="nx">sudog</span>    <span class="c1">// æŒ‡å‘é“¾è¡¨çš„é¦–ä¸ª *sudog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">last</span>  <span class="o">*</span><span class="nx">sudog</span>    <span class="c1">// æŒ‡å‘é“¾è¡¨çš„å°¾éƒ¨ *sudog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/channel-002.png" alt=""  />
</p>
<h3 id="dequeue">dequeue()<a hidden class="anchor" aria-hidden="true" href="#dequeue">#</a></h3>
<ol>
<li>ä» first ä¸­å–å‡ºä¸€ä¸ª *sudogã€‚ç›¸å½“äºä»é˜Ÿåˆ—å¤´ï¼ˆfirstï¼‰å–å‡ºä¸€ä¸ª *sudogã€‚</li>
<li>è°ƒç”¨è¯¥æ–¹æ³•æ—¶ chan lock é”ä¸€å®šæ˜¯è¢«æŒæœ‰çš„ã€‚ä¸‹é¢å‡½æ•°ä¸­éœ€è¦ <code>for {}</code> çš„åŸå› æ˜¯æœ€åä¸€ä¸ª <code>if</code> æ¡ä»¶çš„ <code>CAS</code> æ“ä½œã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">q</span> <span class="o">*</span><span class="nx">waitq</span><span class="p">)</span> <span class="nf">dequeue</span><span class="p">()</span> <span class="o">*</span><span class="nx">sudog</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sgp</span> <span class="o">:=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">first</span>  <span class="c1">// ä»firstå¤„å–ä¸€ä¸ª *sudog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">sgp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">y</span> <span class="o">:=</span> <span class="nx">sgp</span><span class="p">.</span><span class="nx">next</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">y</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>   <span class="c1">// æœ€åä¸€ä¸ª *sudog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">q</span><span class="p">.</span><span class="nx">first</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">            <span class="nx">q</span><span class="p">.</span><span class="nx">last</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">y</span><span class="p">.</span><span class="nx">prev</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">            <span class="nx">q</span><span class="p">.</span><span class="nx">first</span> <span class="p">=</span> <span class="nx">y</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æ ‡è®°å·²åˆ é™¤ï¼ˆå‚çœ‹ dequeueSudoGï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">sgp</span><span class="p">.</span><span class="nx">next</span> <span class="p">=</span> <span class="kc">nil</span> <span class="c1">// mark as removed (see dequeueSudoG)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ä¸ºä»€ä¹ˆéœ€è¦ä¸‹é¢çš„åˆ¤æ–­æ¡ä»¶ï¼Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  1. select è¯­å¥ä¸­é˜»å¡äº†ä¸€ç»„ chan æ—¶ï¼Œæ‰€æœ‰ channels çš„ lock é”éƒ½å·²è¢«æŒæœ‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  2. å½“å‰æ‰§è¡Œselectè¯­å¥çš„goroutineä¼šè¢«å°è£…åˆ°å¤šä¸ª*sudogä¸­é€šè¿‡waitlinkå­—æ®µå½¢æˆé“¾è¡¨ï¼Œç„¶åæŠŠå„ä¸ª*sudogçš„isSelectå­—æ®µæ ‡è®°ä¸ºtrueã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  3. æŠŠå„ä¸ª*sudogåˆ†åˆ«æŒ‚åœ¨å„è‡ªçš„sendqæˆ–recvqé“¾è¡¨ä¸­ã€‚ç­‰å¾…goroutineè¢«å”¤é†’ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  4. æŸä¸€æ—¶åˆ»*sudogè¢«é€‰ä¸­å”¤é†’ï¼Œåˆ™ä¸€å®šä¼šæ‰§è¡Œå½“å‰å‡½æ•° *sudog.isSelect æ˜¯ trueï¼Œå¹¶ä¸”é€šè¿‡ CAS æŠŠ g.selectDone ä»0æ ‡è®°ä¸º1ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  5. æ³¨æ„æ­¤æ—¶å”¤é†’çš„goroutineå¯èƒ½åœ¨å¤šä¸ªchannelä¸Šé¢ç­‰å¾…ã€‚æ­¤æ—¶å¯èƒ½ä¼šå‡ºç°åœ¨å…¶ä»–chanä¸Šè¿™ä¸ªgoroutineä¹Ÿè¢«é€‰ä¸­äº†ï¼Œä¹Ÿåœ¨æ‰§è¡Œå½“å‰å‡½æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  6. åˆ™è¿™é‡Œä¼šç›´æ¥è·³è¿‡ã€‚å› ä¸ºå½“å‰goroutineå·²è¢«å”¤é†’ï¼Œåç»­ä¼šåœ¨å”¤é†’çš„goroutineç§»é™¤è¿™é‡Œgoroutineçš„goselectå‡½æ•°ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  7. goroutine å”¤é†’åä¼šè·å–æ‰€æœ‰çš„ channels lockï¼Œç„¶åæŠŠselectDoneè®¾ç½®ä¸º0ï¼Œæ­¤æ—¶å› ä¸ºæ‰€æœ‰çš„channel lockå·²è¢«æŒæœ‰æ‰€ä»¥èƒ½ç«‹å³ä¿®æ”¹selectDoneã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1">// if a goroutine was put on this queue because of a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// select, there is a small window between the goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// being woken up by a different case and it grabbing the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// channel locks. Once it has the lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// it removes itself from the queue, so we won&#39;t see it after that.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// We use a flag in the G struct to tell us when someone
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// else has won the race to signal this goroutine but the goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// hasn&#39;t removed itself from the queue yet.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å¦‚æœä¸€ä¸ªgoroutineå› ä¸ºselectè¢«æ”¾åˆ°è¿™ä¸ªé˜Ÿåˆ—ä¸Šï¼Œé‚£ä¹ˆåœ¨goroutineè¢«ä¸åŒçš„æƒ…å†µå”¤é†’å’Œå®ƒè·å–é€šé“é”ä¹‹é—´æœ‰ä¸€ä¸ªå°çª—å£ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä¸€æ—¦å®ƒæœ‰äº†é”ï¼Œå®ƒå°±ä¼šä»é˜Ÿåˆ—ä¸­ç§»é™¤è‡ªå·±ï¼Œæ‰€ä»¥åœ¨é‚£ä¹‹åæˆ‘ä»¬å°±çœ‹ä¸åˆ°å®ƒäº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æˆ‘ä»¬åœ¨Gç»“æ„ä½“ä¸­ä½¿ç”¨ä¸€ä¸ªæ ‡å¿—æ¥å‘Šè¯‰æˆ‘ä»¬ï¼Œå½“æœ‰å…¶ä»–äººèµ¢å¾—æ¯”èµ›æ—¶ï¼Œå‘è¿™ä¸ªgoroutineå‘å‡ºä¿¡å·ï¼Œä½†è¯¥goroutineè¿˜æ²¡æœ‰ä»é˜Ÿåˆ—ä¸­åˆ é™¤è‡ªå·±ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">sgp</span><span class="p">.</span><span class="nx">isSelect</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Cas</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sgp</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nx">selectDone</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">sgp</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="enqueue">enqueue()<a hidden class="anchor" aria-hidden="true" href="#enqueue">#</a></h3>
<ol>
<li>ä» last æ”¾å…¥ *sudogã€‚ç›¸å½“äºä»é˜Ÿåˆ—å°¾ï¼ˆlastï¼‰æ·»åŠ å…ƒç´ ã€‚</li>
<li>è°ƒç”¨è¯¥æ–¹æ³•æ—¶ chan lock å·²è¢«æŒæœ‰ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">q</span> <span class="o">*</span><span class="nx">waitq</span><span class="p">)</span> <span class="nf">enqueue</span><span class="p">(</span><span class="nx">sgp</span> <span class="o">*</span><span class="nx">sudog</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sgp</span><span class="p">.</span><span class="nx">next</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nx">x</span> <span class="o">:=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">last</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">x</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>   <span class="c1">// waitq æ˜¯ç©ºçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sgp</span><span class="p">.</span><span class="nx">prev</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nx">q</span><span class="p">.</span><span class="nx">first</span> <span class="p">=</span> <span class="nx">sgp</span>
</span></span><span class="line"><span class="cl">        <span class="nx">q</span><span class="p">.</span><span class="nx">last</span> <span class="p">=</span> <span class="nx">sgp</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sgp</span><span class="p">.</span><span class="nx">prev</span> <span class="p">=</span> <span class="nx">x</span>
</span></span><span class="line"><span class="cl">    <span class="nx">x</span><span class="p">.</span><span class="nx">next</span> <span class="p">=</span> <span class="nx">sgp</span>
</span></span><span class="line"><span class="cl">    <span class="nx">q</span><span class="p">.</span><span class="nx">last</span> <span class="p">=</span> <span class="nx">sgp</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="dequeuesudog">dequeueSudoG()<a hidden class="anchor" aria-hidden="true" href="#dequeuesudog">#</a></h3>
<ol>
<li>åœ¨ selectgo() å‡½æ•°ä¸­è¢«ç”¨åˆ°ï¼Œç”¨äºå°†<strong>æŒ‡å®š</strong>çš„ *sudog å–å‡ºã€‚</li>
<li>å› ä¸º select ä¸èƒ½ç«‹å³å®Œæˆæ—¶ä¼šæŒ‚åœ¨æ‰€æœ‰çš„ channelï¼Œå½“æœ‰ channel å°±ç»ªåå…¶ä»– recvqã€sendq ä¸Šçš„éœ€è¦è°ƒç”¨è¿™ä¸ªå‡½æ•°å‰”é™¤æ‰ã€‚</li>
<li>è°ƒç”¨è¯¥å‡½æ•°æ˜¯ç›¸å…³çš„ channel lock å·²è¢«æŒæœ‰ã€‚</li>
<li>å‚æ•°ï¼š<code>sgp *sudog</code> æ˜¯é€šè¿‡ waitlink å­—æ®µç»„æˆçš„ *sudog é“¾è¡¨ã€‚</li>
<li>è¯¥å‡½æ•°ä¹Ÿæ˜¯åœ¨ <code>go1.19.3/src/runtime/select.go</code> æ–‡ä»¶ä¸­ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">q</span> <span class="o">*</span><span class="nx">waitq</span><span class="p">)</span> <span class="nf">dequeueSudoG</span><span class="p">(</span><span class="nx">sgp</span> <span class="o">*</span><span class="nx">sudog</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰ sgp å¯èƒ½å¤„åœ¨é“¾è¡¨çš„ä»»ä½•ä½ç½®ï¼Œæˆ–è€…ä¸åœ¨é“¾è¡¨ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">x</span> <span class="o">:=</span> <span class="nx">sgp</span><span class="p">.</span><span class="nx">prev</span>
</span></span><span class="line"><span class="cl">    <span class="nx">y</span> <span class="o">:=</span> <span class="nx">sgp</span><span class="p">.</span><span class="nx">next</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">x</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">y</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// middle of queue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// åœ¨ queue çš„ä¸­é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">x</span><span class="p">.</span><span class="nx">next</span> <span class="p">=</span> <span class="nx">y</span>
</span></span><span class="line"><span class="cl">            <span class="nx">y</span><span class="p">.</span><span class="nx">prev</span> <span class="p">=</span> <span class="nx">x</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sgp</span><span class="p">.</span><span class="nx">next</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sgp</span><span class="p">.</span><span class="nx">prev</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// end of queue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åœ¨ queue çš„æœ€å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">x</span><span class="p">.</span><span class="nx">next</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nx">q</span><span class="p">.</span><span class="nx">last</span> <span class="p">=</span> <span class="nx">x</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sgp</span><span class="p">.</span><span class="nx">prev</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">y</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// start of queue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åœ¨queueå¼€å¤´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">y</span><span class="p">.</span><span class="nx">prev</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nx">q</span><span class="p">.</span><span class="nx">first</span> <span class="p">=</span> <span class="nx">y</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sgp</span><span class="p">.</span><span class="nx">next</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// x==y==nil. Either sgp is the only element in the queue,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// or it has already been removed. Use q.first to disambiguate.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// x==y==nilã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¦ä¹ˆ sgp æ˜¯é˜Ÿåˆ—ä¸­å”¯ä¸€çš„æˆå‘˜ï¼Œè¦ä¹ˆå®ƒå·²ç»è¢«åˆ é™¤ã€‚ä½¿ç”¨ q.first æ¥æ¶ˆé™¤æ­§ä¹‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">q</span><span class="p">.</span><span class="nx">first</span> <span class="o">==</span> <span class="nx">sgp</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">q</span><span class="p">.</span><span class="nx">first</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nx">q</span><span class="p">.</span><span class="nx">last</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="type-sudog-struct">type sudog struct<a hidden class="anchor" aria-hidden="true" href="#type-sudog-struct">#</a></h2>
<ol>
<li>sudog è¡¨ç¤ºç­‰å¾…åˆ—è¡¨ä¸­çš„ gï¼Œä¾‹å¦‚ç”¨äºåœ¨ channel ä¸Š sending/receiving ã€‚</li>
<li>sudog æ˜¯å¿…è¦çš„ï¼Œå› ä¸º gâ†”synchronization å¯¹è±¡å…³ç³»æ˜¯å¤šå¯¹å¤šçš„ã€‚</li>
<li>ä¸€ä¸ª g å¯èƒ½ä¼šå‡ºç°åœ¨è®¸å¤šç­‰å¾…åˆ—è¡¨ä¸­ï¼Œæ‰€ä»¥ä¸€ä¸ªgå¯èƒ½ä¼šæœ‰è®¸å¤š sudog;</li>
<li>å¹¶ä¸”è®¸å¤š g å¯èƒ½åœ¨åŒä¸€ä¸ª same å¯¹è±¡ä¸Šç­‰å¾…ï¼Œå› æ­¤ä¸€ä¸ªå¯¹è±¡å¯èƒ½æœ‰è®¸å¤š sudogã€‚</li>
<li>sudog æ˜¯ä»ä¸€ä¸ªç‰¹æ®Šçš„æ± ä¸­åˆ†é…çš„ã€‚ä½¿ç”¨ acquireSudog å’Œ releaseSudog æ¥åˆ†é…å’Œé‡Šæ”¾å®ƒä»¬ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime2.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// sudog represents a g in a wait list, such as for sending/receiving
</span></span></span><span class="line"><span class="cl"><span class="c1">// on a channel.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// sudog is necessary because the g â†” synchronization object relation
</span></span></span><span class="line"><span class="cl"><span class="c1">// is many-to-many. A g can be on many wait lists, so there may be
</span></span></span><span class="line"><span class="cl"><span class="c1">// many sudogs for one g; and many gs may be waiting on the same
</span></span></span><span class="line"><span class="cl"><span class="c1">// synchronization object, so there may be many sudogs for one object.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// sudogs are allocated from a special pool. Use acquireSudog and
</span></span></span><span class="line"><span class="cl"><span class="c1">// releaseSudog to allocate and free them.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">sudog</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The following fields are protected by the hchan.lock of the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// channel this sudog is blocking on. shrinkstack depends on
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// this for sudogs involved in channel ops.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">g</span> <span class="o">*</span><span class="nx">g</span>        <span class="c1">// ç­‰å¾…çš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">next</span> <span class="o">*</span><span class="nx">sudog</span> <span class="c1">// é“¾æ¥ä¸‹ä¸€ä¸ª*sudog     å¯¹äºäºŒå‰æ ‘å°±æ˜¯left
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">prev</span> <span class="o">*</span><span class="nx">sudog</span> <span class="c1">// é“¾æ¥å‰ä¸€ä¸ª*sudog     å¯¹äºäºŒå‰æ ‘å°±æ˜¯right
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// seampherä¸­ï¼šä¿å­˜æ¥è‡ªä¿¡å·é‡çš„åœ°å€ï¼›æ¯”å¦‚åœ¨sync.Mutexä¸­åˆ™æ˜¯&amp;sync.Mutex.semaè¯¥å­—æ®µçš„åœ°å€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// channelsä¸­ï¼šåˆ™æ˜¯ä¿å­˜éœ€è¦ä¼ é€’çš„å€¼çš„åœ°å€ã€‚ï¼ˆéœ€è¦äº¤æ¢çš„æ•°æ®åœ°å€ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">elem</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// data element (may point to stack)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The following fields are never accessed concurrently.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// For channels, waitlink is only accessed by g.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// For semaphores, all fields (including the ones above)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// are only accessed when holding a semaRoot lock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä»¥ä¸‹å­—æ®µæ°¸è¿œä¸ä¼šå¹¶å‘è®¿é—®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯¹äº channelsï¼Œwaitlink åªèƒ½ç”± g è®¿é—®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯¹äº semaphoresï¼Œæ‰€æœ‰å­—æ®µ(åŒ…æ‹¬ä¸Šé¢çš„å­—æ®µ)åªæœ‰åœ¨æŒæœ‰ semaRoot é”æ—¶æ‰èƒ½è®¿é—®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»¥ä¸‹æ—¶é—´éƒ½æ˜¯ä¸ºäº†åˆ†æ sudog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">acquiretime</span> <span class="kt">int64</span>   <span class="c1">// è·å¾— sudog çš„æ—¶é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">releasetime</span> <span class="kt">int64</span>   <span class="c1">// é‡Šæ”¾æ—¶é—´	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// ticket ç”¨äºå½¢æˆæœ€å°å †ï¼Œä»rootå¾€ä¸‹æŒ‰ç…§ s.ticket &lt;= both s.prev.ticket AND s.next.ticket; æœ€å°å †å°±æ˜¯ä¸€ç§å®Œå…¨äºŒå‰æ ‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. ticket åœ¨ semaRoot.queue å‡½æ•°ä¸­ä½œä¸ºäºŒå‰æ ‘æå¹²æƒ…å†µä¸‹è¢«åˆå§‹åŒ–ä¸º s.ticket = fastrand() | 1;  s.ticket &gt;= 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. ticket åœ¨ semaRoot.dequeue å‡½æ•°ä¸­è¿”å› sudog æ—¶ï¼Œè¢«é‡ç½®ä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  3. ticket åœ¨ sync_runtime_SemacquireMutex å‡½æ•°ä¸­ å¦‚æœæ˜¯é¥¥é¥¿æ¨¡å¼åˆ™æ ‡è®°ä¸º1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æœ€å°å †ç™¾åº¦ç™¾ç§‘ï¼šhttps://baike.baidu.com/item/%E6%9C%80%E5%B0%8F%E5%A0%86/9139372
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ticket</span>      <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// isSelect indicates g is participating in a select, so
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// g.selectDone must be CAS&#39;d to win the wake-up race.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// isSelect è¡¨ç¤º g æ­£åœ¨å‚ä¸ä¸€ä¸ª selectï¼Œå› æ­¤ g.selectDone å¿…é¡»ç»è¿‡ CAS å¤„ç†æ‰èƒ½èµ¢å¾—å”¤é†’ç«èµ›ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å…·ä½“å‚è€ƒ goselect() å‡½æ•°ã€‚å½“å‰æ˜¯å› ä¸º select è¯­å¥è¢«æŒ‚èµ·æ—¶ï¼Œè¯¥å­—æ®µä¼šè¢«è®¾ç½®ä¸º trueã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">isSelect</span> <span class="kt">bool</span> <span class="c1">// åœ¨selectç»“æ„ä¸­è¢«ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// success indicates whether communication over channel c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// succeeded. It is true if the goroutine was awoken because a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// value was delivered over channel c, and false if awoken
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// because c was closed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// success c é€šé“é€šä¿¡æ˜¯å¦æˆåŠŸã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœ goroutine å› ä¸ºé€šè¿‡é€šé“ c ä¼ é€’å€¼è€Œè¢«å”¤é†’ï¼Œåˆ™ä¸º trueï¼Œå¦‚æœå› ä¸ºé€šé“ c è¢«å…³é—­è€Œè¢«å”¤é†’ï¼Œåˆ™ä¸º falseã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">success</span> <span class="kt">bool</span>  <span class="c1">// åœ¨chanä¸­è¢«ä½¿ç”¨ï¼Œç”¨äºåˆ¤æ–­æœ¬æ¬¡é€šä¿¡æ˜¯å¦æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// semaRootçš„äºŒå‰æ ‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">parent</span>   <span class="o">*</span><span class="nx">sudog</span> <span class="c1">// semaRoot binary tree
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// g.waiting åˆ—è¡¨æˆ– semaRoot çš„ç­‰å¾…é“¾è¡¨ï¼ŒæŒ‡å‘é“¾è¡¨çš„å¤´ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨ goselect() å‡½æ•°ä¸­ï¼ŒæŒ‚èµ·çš„ goroutine ç»„è£…çš„ *sudog é€šè¿‡ waitlink å­—æ®µå½¢æˆé“¾è¡¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// waitlink åªåœ¨ semapher æˆ– select è¯­å¥ä¸­è¢«ç”¨æ¥å½¢æˆé“¾è¡¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">waitlink</span> <span class="o">*</span><span class="nx">sudog</span> <span class="c1">// g.waiting list or semaRoot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç­‰å¾…å°¾éƒ¨ semaRootï¼ŒæŒ‡å‘é“¾è¡¨çš„å°¾éƒ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">waittail</span> <span class="o">*</span><span class="nx">sudog</span> <span class="c1">// semaRoot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰sudogæ‰€å±*hchanï¼Œselectä¸èƒ½å°±ç»ªè¦è¢«æŒ‚èµ·æ—¶ç”¨åˆ°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span>        <span class="o">*</span><span class="nx">hchan</span> <span class="c1">// channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="make">make()<a hidden class="anchor" aria-hidden="true" href="#make">#</a></h2>
<p>åˆå§‹åŒ– channelã€‚</p>
<h3 id="makechan">makechan()<a hidden class="anchor" aria-hidden="true" href="#makechan">#</a></h3>
<ol>
<li>å‡½æ•°åŸå‹ï¼šmake(chan Type, size int)</li>
<li>å‚æ•°ï¼š
<ul>
<li><strong>t *chantype</strong>ï¼šchan å…ƒç±»å‹ç»“æ„ã€‚</li>
<li><strong>size int</strong>ï¼šchan å¤§å°ï¼Œé»˜è®¤0æ— ç¼“å†² chanï¼›&gt;=1 éƒ½æ˜¯æœ‰ç¼“å†² chanã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">chantype</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">typ</span>  <span class="nx">_type</span>      <span class="c1">// chanå…ƒç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">elem</span> <span class="o">*</span><span class="nx">_type</span>     <span class="c1">// chan å…ƒç´ å…ƒç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">dir</span>  <span class="kt">uintptr</span>    <span class="c1">// é€šé“æ–¹å‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">makechan</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">chantype</span><span class="p">,</span> <span class="nx">size</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="nx">hchan</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">elem</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">elem</span>  <span class="c1">// chanå…ƒç´ å…ƒç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// compiler checks this but be safe.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç¼–è¯‘å™¨ä¼šæ£€æŸ¥è¿™ä¸€ç‚¹ï¼Œä½†è¿™æ˜¯å®‰å…¨çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">size</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span> <span class="p">{</span> <span class="c1">// chanå…ƒç´ ç±»å‹å†…å­˜ &gt;= 1&lt;&lt;16æ—¶ä¸é€‚åˆchan
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;makechan: invalid channel element type&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// hchan æ˜¯å¦å¯¹é½ maxAlign
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">hchanSize</span><span class="o">%</span><span class="nx">maxAlign</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">align</span> <span class="p">&gt;</span> <span class="nx">maxAlign</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;makechan: bad alignment&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// mem = elem.size * uintptr(size)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mem</span><span class="p">,</span> <span class="nx">overflow</span> <span class="o">:=</span> <span class="nx">math</span><span class="p">.</span><span class="nf">MulUintptr</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">overflow</span> <span class="o">||</span> <span class="nx">mem</span> <span class="p">&gt;</span> <span class="nx">maxAlloc</span><span class="o">-</span><span class="nx">hchanSize</span> <span class="o">||</span> <span class="nx">size</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// å†…å­˜æº¢å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">panic</span><span class="p">(</span><span class="nf">plainError</span><span class="p">(</span><span class="s">&#34;makechan: size out of range&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Hchan does not contain pointers interesting for GC when elements stored in buf do not contain pointers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// buf points into the same allocation, elemtype is persistent.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// SudoG&#39;s are referenced from their owning thread so they can&#39;t be collected.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// TODO(dvyukov,rlh): Rethink when collector can move allocated objects.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å­˜å‚¨åœ¨bufä¸­çš„å…ƒç´ ä¸åŒ…å«æŒ‡é’ˆæ—¶ï¼Œhchanä¸åŒ…å«GCæ„Ÿå…´è¶£çš„æŒ‡é’ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// (å› æ­¤å¯ç›´æ¥åœ¨æ— æŒ‡é’ˆå†…å­˜å—åˆ†é…)ã€‚bufæŒ‡å‘ç›¸åŒçš„å†…å­˜åˆ†é…ï¼Œelemtypeæ˜¯æŒä¹…çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Sudog æ˜¯åœ¨å®ƒä»¬è‡ªå·±çš„çº¿ç¨‹ä¸­å¼•ç”¨çš„ï¼Œæ‰€ä»¥å®ƒä»¬æ— æ³•è¢«æ”¶é›†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// TODO(dvyukov,rlh):é‡æ–°è€ƒè™‘æ”¶é›†å™¨ä½•æ—¶å¯ä»¥ç§»åŠ¨å·²åˆ†é…çš„å¯¹è±¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span> <span class="c1">// nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ã€make(chan struct{}, n)ã€‘ OR ã€make(chan int, 0)ã€‘ å½¢å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="nx">mem</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">// channel å†…å­˜ä¸ºé›¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Queue or element size is zero.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Queue æˆ– element çš„å¤§å°ä¸º0ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ³¨æ„è¿™é‡Œç”³è¯·çš„å†…å­˜è§„æ ¼å—æ˜¯æ— æŒ‡é’ˆçš„ï¼Œå…·ä½“åŸå› å‰é¢æ³¨é‡Šæœ‰è§£é‡Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">c</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">hchan</span><span class="p">)(</span><span class="nf">mallocgc</span><span class="p">(</span><span class="nx">hchanSize</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span> <span class="c1">// ç”³è¯·hchanéœ€è¦çš„å†…å­˜ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Race detector uses this location for synchronization.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ç«æ€æ£€æµ‹å™¨ä½¿ç”¨æ­¤ä½ç½®è¿›è¡ŒåŒæ­¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">c</span><span class="p">.</span><span class="nx">buf</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">raceaddr</span><span class="p">()</span> <span class="c1">// c.buf = &amp;c.buf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">ptrdata</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">// channel å†…å­˜ä¸ä¸ºé›¶ï¼Œå…ƒç´ ä¸åŒ…å«æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Elements do not contain pointers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Allocate hchan and buf in one call.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å…ƒç´ ä¸åŒ…å«æŒ‡é’ˆã€‚ä¸€æ¬¡è°ƒç”¨å³å¯åˆ†é… hchan å’Œ bufã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// hchanSize ä¸»è¦æ˜¯ä¸ºäº†è¿™é‡Œçš„å¯¹é½ã€‚æ³¨æ„è¿™é‡Œç”³è¯·çš„å†…å­˜è§„æ ¼å—æ˜¯æ— æŒ‡é’ˆçš„ï¼Œå…·ä½“åŸå› å‰é¢æ³¨é‡Šæœ‰è§£é‡Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">c</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">hchan</span><span class="p">)(</span><span class="nf">mallocgc</span><span class="p">(</span><span class="nx">hchanSize</span><span class="o">+</span><span class="nx">mem</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">true</span><span class="p">))</span> <span class="c1">// ç”³è¯·ã€hchan + bufã€‘éœ€è¦å†…å­˜å—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">c</span><span class="p">.</span><span class="nx">buf</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">c</span><span class="p">),</span> <span class="nx">hchanSize</span><span class="p">)</span> <span class="c1">// å¯è§ç”³è¯·çš„æ˜¯ä¸€æ•´å—å†…å­˜ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">default</span><span class="p">:</span> <span class="c1">// channel å†…å­˜ä¸ä¸ºé›¶ï¼Œå…ƒç´ åŒ…å«æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Elements contain pointers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å…ƒç´ åŒ…å«æŒ‡é’ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">c</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">hchan</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="c1">// ç”³è¯·å…ƒç´ éœ€è¦çš„å†…å­˜å—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ³¨æ„è¿™é‡Œç”³è¯·çš„æ˜¯æœ‰æŒ‡é’ˆå†…å­˜è§„æ ¼å—ï¼Œå…·ä½“åŸå› æ˜¯chanå…ƒç´ ç±»å‹æœ‰æŒ‡é’ˆå¯èƒ½å­˜åœ¨å¤šçº§æŒ‡é’ˆå¼•ç”¨ï¼Œéœ€è¦GCå¸®åŠ©
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">c</span><span class="p">.</span><span class="nx">buf</span> <span class="p">=</span> <span class="nf">mallocgc</span><span class="p">(</span><span class="nx">mem</span><span class="p">,</span> <span class="nx">elem</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">.</span><span class="nx">elemsize</span> <span class="p">=</span> <span class="nb">uint16</span><span class="p">(</span><span class="nx">elem</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span> <span class="c1">// chan å…ƒç´ å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span> <span class="p">=</span> <span class="nx">elem</span>              <span class="c1">// chanå…ƒç´ å…ƒç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span><span class="p">.</span><span class="nx">dataqsiz</span> <span class="p">=</span> <span class="nb">uint</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span>        <span class="c1">// æœ‰ç¼“å­˜å®¹é‡ï¼Œä¸€æ—¦åˆå§‹åŒ–å°±æ˜¯ç¡®å®šçš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åˆå§‹åŒ– runtime.mutexï¼Œä¸»è¦æ˜¯åˆå§‹åŒ–é”æ’å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">,</span> <span class="nx">lockRankHchan</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">debugChan</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;makechan: chan=&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="s">&#34;; elemsize=&#34;</span><span class="p">,</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="s">&#34;; dataqsiz=&#34;</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/channel-003.png" alt=""  />
</p>
<h3 id="makechan64">makechan64()<a hidden class="anchor" aria-hidden="true" href="#makechan64">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">makechan64</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">chantype</span><span class="p">,</span> <span class="nx">size</span> <span class="kt">int64</span><span class="p">)</span> <span class="o">*</span><span class="nx">hchan</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">int64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">size</span><span class="p">))</span> <span class="o">!=</span> <span class="nx">size</span> <span class="p">{</span> <span class="c1">// å¦‚æœåœ¨32ä½ç³»ç»Ÿä¸‹è¿™é‡Œä¼šæŠ¥é”™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">panic</span><span class="p">(</span><span class="nf">plainError</span><span class="p">(</span><span class="s">&#34;makechan: size out of range&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">makechan</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">size</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="c---ep">c &lt;- ep<a hidden class="anchor" aria-hidden="true" href="#c---ep">#</a></h2>
<p>ep å‘é€åˆ° c ä¸­ã€‚</p>
<h3 id="chansend1">chansend1()<a hidden class="anchor" aria-hidden="true" href="#chansend1">#</a></h3>
<ol>
<li>ç¼–è¯‘åä»£ç ä¸­ <strong>c &lt;- x</strong> çš„å…¥å£ç‚¹ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// c &lt;- ep
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// as 
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// chansend1(c, &amp;ep)
</span></span></span><span class="line"><span class="cl"><span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// entry point for c &lt;- x from compiled code
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">chansend1</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">,</span> <span class="nx">elem</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">chansend</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">elem</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nf">getcallerpc</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="chansend">chansend()<a hidden class="anchor" aria-hidden="true" href="#chansend">#</a></h3>
<ol>
<li>é€šç”¨å•é€šé“ send/recvï¼Œå¦‚æœ block ä¸æ˜¯ nilï¼Œé‚£ä¹ˆåè®®å°†ä¸ä¼šè¿›å…¥ç¡çœ çŠ¶æ€ï¼Œå¦‚æœæ— æ³•å®Œæˆåˆ™è¿”å›ã€‚</li>
<li>å½“æ¶‰åŠ sleep çš„é€šé“è¢«å…³é—­æ—¶ï¼Œsleep å¯ä»¥ä½¿ç”¨ g.param == nil å”¤é†’ã€‚å¾ªç¯å¹¶é‡æ–°è¿è¡Œæ“ä½œæ˜¯æœ€ç®€å•çš„;æˆ‘ä»¬ä¼šçœ‹åˆ°å®ƒç°åœ¨å·²ç»å…³é—­äº†ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><strong><code>c *hchan</code></strong>ï¼šhchan ç»“æ„ä½“çš„æŒ‡é’ˆã€‚æŒ‡å‘è¦æ¥ç”¨ send æ•°æ®çš„ channelã€‚</li>
<li><strong><code>ep unsafe.Pointer</code></strong>ï¼šep æ˜¯ c &lt;- ep éœ€è¦å‘é€åˆ° chan çš„æ•°æ®åœ°å€ã€‚
<ul>
<li>æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘è¦è¢«é€å…¥é€šé“ c çš„æ•°æ®ï¼Œæ•°æ®ç±»å‹è¦å’Œ c çš„å…ƒç´ ç±»å‹ä¸€è‡´ã€‚</li>
</ul>
</li>
<li><strong><code>block bool</code></strong>ï¼šfalse.ä¸èƒ½ç«‹å³å®Œæˆæ—¶ä¸é˜»å¡ã€‚ true.ä¸èƒ½ç«‹å³å®Œæˆæ—¶é˜»å¡ã€‚
<ul>
<li>è¡¨ç¤ºå¦‚æœ send æ“ä½œä¸èƒ½ç«‹å³å®Œæˆï¼Œæ˜¯å¦æƒ³è¦é˜»å¡ç­‰å¾…ã€‚</li>
<li>block bool å‚æ•° false çŠ¶æ€ç”¨äº <strong>select{case: default:}</strong> å½¢å¼ä¸­ã€‚true çŠ¶æ€ç”¨äº c &lt;- ep æƒ…å†µä¸‹ã€‚</li>
</ul>
</li>
<li><strong><code>callerpc uintptr</code></strong>ï¼šæ˜¯ c &lt;- ep çš„ä¸‹ä¸€æ¡ä»£ç æŒ‡ä»¤åœ°å€ã€‚ç”¨äºè¿›è¡Œraceç›¸å…³æ£€æµ‹ã€‚</li>
</ul>
</li>
<li>è¿”å›å€¼ï¼š
<ul>
<li><strong><code>bool</code></strong>ï¼štrue.æ•°æ® send å®Œæˆã€‚false.è¡¨ç¤ºç›®å‰ä¸èƒ½å‘é€ï¼Œä½†å› ä¸ºä¸æƒ³é˜»å¡(blockä¸ºfalse)è€Œè¿”å›ã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * generic single channel send/recv
</span></span></span><span class="line"><span class="cl"><span class="cm"> * If block is not nil,
</span></span></span><span class="line"><span class="cl"><span class="cm"> * then the protocol will not
</span></span></span><span class="line"><span class="cl"><span class="cm"> * sleep but return if it could
</span></span></span><span class="line"><span class="cl"><span class="cm"> * not complete.
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * sleep can wake up with g.param == nil
</span></span></span><span class="line"><span class="cl"><span class="cm"> * when a channel involved in the sleep has
</span></span></span><span class="line"><span class="cl"><span class="cm"> * been closed.  it is easiest to loop and re-run
</span></span></span><span class="line"><span class="cl"><span class="cm"> * the operation; we&#39;ll see that it&#39;s now closed.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">chansend</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">,</span> <span class="nx">ep</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">block</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">callerpc</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) chanæ²¡æœ‰åˆå§‹åŒ–ï¼Œæ¯”å¦‚ var c chan intå½¢å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">c</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nx">block</span> <span class="p">{</span>      <span class="c1">// select{case: default:} å—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="kc">false</span> <span class="c1">// è¿”å›falseï¼Œè¡¨ç¤ºæœªå‘é€æ•°æ®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// nil &lt;- xï¼šå¦‚æœblockä¸ºtrueï¼Œå°±è®©å½“å‰åç¨‹æ°¸ä¹…åœ°é˜»å¡åœ¨è¿™ä¸ªnilé€šé“ä¸Šã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1">// å¤„ç†ç›¸å…³goroutineç„¶åå†æ¬¡è¿›è¡Œæ–°ä¸€è½®è°ƒåº¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ³¨æ„ï¼šè¿™é‡Œçš„goroutineå°†æ°¸ä¹…ä¸¢å¤±ï¼Œå› ä¸ºè¿™ä¸ªgoroutineæ²¡æœ‰è¢«æ”¾å…¥é˜Ÿåˆ—ä¸­ç­‰å¾…è¢«è°ƒåº¦ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿˜æœ‰å°±æ˜¯c &lt;- xè¿™è¡Œä»£ç åçš„æ‰€æœ‰ä»£ç éƒ½ä¸ä¼šåœ¨è¢«æ‰§è¡Œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">gopark</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">waitReasonChanSendNilChan</span><span class="p">,</span> <span class="nx">traceEvGoStop</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;unreachable&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">debugChan</span> <span class="p">{</span> <span class="c1">// debug
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;chansend: chan=&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">racereadpc</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nf">raceaddr</span><span class="p">(),</span> <span class="nx">callerpc</span><span class="p">,</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABIInternal</span><span class="p">(</span><span class="nx">chansend</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Fast path: check for failed non-blocking operation without acquiring the lock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// After observing that the channel is not closed, we observe that the channel is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// not ready for sending. Each of these observations is a single word-sized read
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// (first c.closed and second full()).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Because a closed channel cannot transition from &#39;ready for sending&#39; to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// &#39;not ready for sending&#39;, even if the channel is closed between the two observations,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// they imply a moment between the two when the channel was both not yet closed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// and not ready for sending. We behave as if we observed the channel at that moment,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// and report that the send cannot proceed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// It is okay if the reads are reordered here: if we observe that the channel is not
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ready for sending and then observe that it is not closed, that implies that the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// channel wasn&#39;t closed during the first observation. However, nothing here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// guarantees forward progress. We rely on the side effects of lock release in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// chanrecv() and closechan() to update this thread&#39;s view of c.closed and full().
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Fast path: åœ¨æœªè·å¾—é”çš„æƒ…å†µä¸‹æ£€æŸ¥å¤±è´¥çš„éé˜»å¡æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨è§‚å¯Ÿåˆ°é€šé“æ²¡æœ‰å…³é—­ä¹‹åï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°é€šé“è¿˜æ²¡æœ‰å‡†å¤‡å¥½å‘é€ã€‚æ¯ä¸ªè§‚å¯Ÿå€¼éƒ½æ˜¯å•ä¸ªword-sizedçš„è¯»å–(ç¬¬ä¸€ä¸ªæ˜¯c.closedï¼Œç¬¬äºŒä¸ªæ˜¯full())ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› ä¸ºä¸€ä¸ªå°é—­çš„é€šé“ä¸èƒ½ä»&#39;ready for sending&#39;è¿‡æ¸¡åˆ°&#39;not ready for sending&#39;ï¼Œå³ä½¿åœ¨ä¸¤æ¬¡è§‚æµ‹ä¹‹é—´é€šé“æ˜¯å…³é—­çš„ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å®ƒä»¬ä¹Ÿæ„å‘³ç€åœ¨ä¸¤æ¬¡è§‚æµ‹ä¹‹é—´é€šé“æ—¢æ²¡æœ‰å…³é—­ä¹Ÿæ²¡æœ‰å‡†å¤‡å¥½å‘é€çš„æ—¶åˆ»ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æˆ‘ä»¬çš„è¡Œä¸ºå°±åƒæˆ‘ä»¬å½“æ—¶è§‚å¯Ÿåˆ°é€šé“ä¸€æ ·ï¼Œå¹¶æŠ¥å‘Šå‘é€æ— æ³•ç»§ç»­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨è¿™é‡Œï¼Œå¦‚æœè¯»æ“ä½œè¢«é‡æ–°æ’åºæ˜¯å¯ä»¥çš„:å¦‚æœæˆ‘ä»¬è§‚å¯Ÿåˆ°é€šé“è¿˜æ²¡æœ‰å‡†å¤‡å¥½å‘é€ï¼Œç„¶ååˆè§‚å¯Ÿåˆ°å®ƒæ²¡æœ‰å…³é—­ï¼Œè¿™æ„å‘³ç€åœ¨ç¬¬ä¸€æ¬¡è§‚å¯ŸæœŸé—´é€šé“æ²¡æœ‰å…³é—­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç„¶è€Œï¼Œè¿™é‡Œæ²¡æœ‰ä»»ä½•ä¸œè¥¿èƒ½ä¿è¯å–å¾—è¿›å±•ã€‚æˆ‘ä»¬ä¾èµ–chanrecv()å’Œclosechan()ä¸­é”é‡Šæ”¾çš„å‰¯ä½œç”¨æ¥æ›´æ–°è¿™ä¸ªçº¿ç¨‹çš„c.closedå’Œfull()è§†å›¾ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nx">block</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">closed</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nf">full</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// selectå—ä¸­ &amp;&amp; chanæœªå…³é—­ &amp;&amp; cå·²æ»¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å¦‚æœblockä¸ºfalseä¸”closedä¸º0ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸æƒ³é˜»å¡ä¸”é€šé“æœªå…³é—­çš„å‰æä¸‹ï¼Œå¦‚æœé€šé“æ»¡äº†ï¼ˆæ— ç¼“å†²ä¸”recvqä¸ºç©ºï¼Œæˆ–è€…æœ‰ç¼“å­˜ä¸”ç¼“å†²å·²ç”¨å°½ï¼‰ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åˆ™ç›´æ¥è¿”å›falseã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æœ¬æ­¥åˆ¤æ–­æ˜¯åœ¨ä¸åŠ é”çš„æƒ…å†µä¸‹è¿›è¡Œçš„ï¼Œç›®çš„æ˜¯è®©éé˜»å¡sendåœ¨æ— æ³•ç«‹å³å®Œæˆæ—¶èƒ½çœŸæ­£ä¸é˜»å¡ï¼ˆåŠ é”æ“ä½œå¯èƒ½é˜»å¡ï¼‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">t0</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">blockprofilerate</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">t0</span> <span class="p">=</span> <span class="nf">cputicks</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2) å°è¯•è·å– runtime.mutex äº’æ–¥é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯¹hchanåŠ é”ï¼Œå¦‚æœclosedä¸ä¸º0ï¼Œå³é€šé“å·²ç»å…³é—­ï¼Œåˆ™å…ˆè§£é”ï¼Œç„¶åpanicã€‚å› ä¸ºä¸å…è®¸ç”¨å·²å…³é—­çš„é€šé“è¿›è¡Œsendã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3) å‘å·²å…³é—­çš„chan å‘é€æ•°æ®ç›´æ¥panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œå­˜åœ¨è·å–runtime.mutexæœŸé—´å…¶ä»–åç¨‹å·²ç»æŠŠcå…³é—­çš„æƒ…å†µï¼Œè¿™é‡Œä¼šç›´æ¥panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› æ­¤chançš„å…³é—­æ˜¯è¦ç¡®ä¿æ‰€æœ‰çš„sendæ“ä½œå·²å®Œæˆåå†è¿›è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">closed</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">panic</span><span class="p">(</span><span class="nf">plainError</span><span class="p">(</span><span class="s">&#34;send on closed channel&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 4) ä» recvq ä¸­å»æ‰¾å‡ºä¸€ä¸ªæ­£åœ¨ç­‰å¾…çš„ *sudog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœ recvq ä¸ä¸ºç©ºï¼Œéšå«äº†ç¼“å†²åŒºä¸ºç©ºï¼Œå°±ä»ä¸­å–å‡ºç¬¬1ä¸ªæ’é˜Ÿçš„åç¨‹ï¼Œå°†æ•°æ®ä¼ ç»™è¿™ä¸ªåç¨‹ï¼Œå¹¶å°†è¯¥åç¨‹ç½®ä¸ºreadyçŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//ï¼ˆæ”¾å…¥run queueï¼Œè¿›è€Œå¾—åˆ°è°ƒåº¦ï¼‰ï¼Œç„¶åè§£é”ï¼Œç„¶åè¿”å›trueã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sg</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvq</span><span class="p">.</span><span class="nf">dequeue</span><span class="p">();</span> <span class="nx">sg</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span> <span class="c1">// å­˜åœ¨ç­‰å¾…çš„ goroutine ç›´æ¥äº¤æ¢æ•°æ®å³å¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Found a waiting receiver. We pass the value we want to send
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// directly to the receiver, bypassing the channel buffer (if any).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ‰¾åˆ°äº†ä¸€ä¸ªç­‰å¾…çš„æ¥æ”¶å™¨ã€‚æˆ‘ä»¬å°†æƒ³è¦ç›´æ¥å‘é€çš„å€¼ä¼ é€’ç»™æ¥æ”¶å™¨ï¼Œç»•è¿‡é€šé“ç¼“å†²åŒº(å¦‚æœæœ‰çš„è¯)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">send</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">sg</span><span class="p">,</span> <span class="nx">ep</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span> <span class="p">},</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 5) ç¼“å†²åŒºè¿˜æœ‰ç©ºé—´ï¼Œç›´æ¥æŠŠæ•°æ®æ”¾å…¥å³å¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é€šè¿‡æ¯”è¾ƒ qcount å’Œ dataqsiz åˆ¤æ–­ç¼“å­˜åŒºæ˜¯å¦è¿˜æœ‰å‰©ä½™ç©ºé—´ï¼Œåœ¨è¿™é‡Œæ— ç¼“å†²çš„é€šé“è¢«è§†ä¸ºæ²¡æœ‰å‰©ä½™ç©ºé—´ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœæœ‰å‰©ä½™ç©ºé—´ï¼Œå°†æ•°æ®è¿½åŠ åˆ°ç¼“å†²åŒºä¸­ï¼Œç›¸åº”åœ°ç§»åŠ¨ sendxï¼Œå¢åŠ  qcountï¼Œç„¶åè§£é”ï¼Œè¿”å›å€¼ä¸º trueã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">qcount</span> <span class="p">&lt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">dataqsiz</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Space is available in the channel buffer. Enqueue the element to send.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// é€šé“ç¼“å†²åŒºä¸­æœ‰å¯ç”¨ç©ºé—´ã€‚å¯¹è¦å‘é€çš„å…ƒç´ è¿›è¡Œæ’é˜Ÿã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">qp</span> <span class="o">:=</span> <span class="nf">chanbuf</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">sendx</span><span class="p">)</span>           <span class="c1">// ä¸‹ä¸€ä¸ªç©ºé—²æ’æ§½åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">racenotify</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">sendx</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æŠŠc &lt;- epè¿™é‡Œçš„epå€¼å¤åˆ¶åˆ°qpè¿™ä¸ªåœ°å€ä¸­ï¼Œå®ç°æŠŠepæ”¾å…¥bufä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">typedmemmove</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nx">qp</span><span class="p">,</span> <span class="nx">ep</span><span class="p">)</span>    <span class="c1">// å¦‚æœå…ƒç´ å¤§å°ä¸º0ä¸ä¼šæœ‰ä»»ä½•æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">c</span><span class="p">.</span><span class="nx">sendx</span><span class="o">++</span>                           <span class="c1">// ä¸‹ä¸€æ¬¡ç©ºé—²ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">sendx</span> <span class="o">==</span> <span class="nx">c</span><span class="p">.</span><span class="nx">dataqsiz</span> <span class="p">{</span>          <span class="c1">// åˆ°è¾¾æœ€å¤§ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">c</span><span class="p">.</span><span class="nx">sendx</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nx">qcount</span><span class="o">++</span>                          <span class="c1">// å·²å­˜å‚¨çš„æ•°é‡åŠ ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 6) å¦‚æœä¸Šé¢4å’Œ5éƒ½ä¸æ»¡è¶³ï¼Œå¹¶ä¸”æ˜¯åœ¨selectä¸­ï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›falseï¼Œè¡¨ç¤ºå½“å‰åˆ†æ”¯ä¸ä¼šé€‰ä¸­ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿è¡Œåˆ°è¿™é‡Œè¡¨æ˜é€šé“å·²æ»¡ï¼Œå¦‚æœblockä¸ºfalseï¼Œå³ä¸æƒ³é˜»å¡ï¼Œåˆ™è§£é”ï¼Œè¿”å›å€¼ä¸ºfalseã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nx">block</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 7) ä¸‹é¢æ˜¯ c &lt;- x å†™æ“ä½œéœ€è¦é˜»å¡çš„æƒ…å†µ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Block on the channel. Some receiver will complete our operation for us.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨é€šé“ä¸Šé˜»å¡ã€‚æœ‰äººä¼šæ›¿æˆ‘ä»¬å®Œæˆæˆ‘ä»¬çš„æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è·å–ä¸€ä¸ªç©ºé—²çš„ *sudog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mysg</span> <span class="o">:=</span> <span class="nf">acquireSudog</span><span class="p">()</span>	
</span></span><span class="line"><span class="cl">    <span class="nx">mysg</span><span class="p">.</span><span class="nx">releasetime</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">t0</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mysg</span><span class="p">.</span><span class="nx">releasetime</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// No stack splits between assigning elem and enqueuing mysg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// on gp.waiting where copystack can find it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨åˆ†é…elemå’Œåœ¨gpä¸Šæ’é˜Ÿmysgä¹‹é—´æ²¡æœ‰å †æ ˆåˆ†è£‚ã€‚åœ¨æ‹·è´å †èƒ½æ‰¾åˆ°çš„åœ°æ–¹ç­‰å¾…ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mysg</span><span class="p">.</span><span class="nx">elem</span> <span class="p">=</span> <span class="nx">ep</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// waitlink åªåœ¨ semapher æˆ– select è¯­å¥ä¸­è¢«ä½¿ç”¨åˆ°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç”¨æ¥é“¾æ¥å¤šä¸ª sudog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mysg</span><span class="p">.</span><span class="nx">waitlink</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mysg</span><span class="p">.</span><span class="nx">g</span> <span class="p">=</span> <span class="nx">gp</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ ‡è®°å½“å‰ sudog ä¸æ˜¯æ¥è‡ªselectè¯­å¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mysg</span><span class="p">.</span><span class="nx">isSelect</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mysg</span><span class="p">.</span><span class="nx">c</span> <span class="p">=</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ ‡è®°goroutineæ­£åœ¨*sudogè¿™ä¸­ç­‰å¾…ï¼ˆä¸€ä¸ªæœ‰æ•ˆçš„elem ptrï¼‰; in lock order
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">waiting</span> <span class="p">=</span> <span class="nx">mysg</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">param</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ”¾å…¥ sendq queue ä¸­ç­‰å¾…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span><span class="p">.</span><span class="nx">sendq</span><span class="p">.</span><span class="nf">enqueue</span><span class="p">(</span><span class="nx">mysg</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">    <span class="c1">// Signal to anyone trying to shrink our stack that we&#39;re about
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// to park on a channel. The window between when this G&#39;s status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// changes and when we set gp.activeStackChans is not safe for
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// stack shrinking.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å‘ä»»ä½•è¯•å›¾ç¼©å°å †æ ˆçš„äººå‘å‡ºä¿¡å·ï¼Œæˆ‘ä»¬å³å°†åœåœ¨ä¸€ä¸ªchannelä¸Šã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“Gçš„çŠ¶æ€æ”¹å˜å’Œæˆ‘ä»¬è®¾ç½®gpä¹‹é—´çš„çª—å£ã€‚activeStackChans å¯¹å †æ ˆæ”¶ç¼©ä¸å®‰å…¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// goroutine.parkingOnChanè¡¨ç¤ºè¯¥goroutineå³å°†åœåœ¨ä¸€ä¸ªchansendæˆ–chanrecvä¸Šã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç”¨äºæŒ‡ç¤ºå †æ ˆæ”¶ç¼©çš„ä¸å®‰å…¨ç‚¹ã€‚å®ƒæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œä½†ä¼šè‡ªåŠ¨æ›´æ–°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store8</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">parkingOnChan</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// è¡¨ç¤ºè¿™æ®µæ—¶é—´chanæ­£åœ¨parkingä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// goparkâ€”&gt;mcall-&gt;park_m-&gt;schedule()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">gopark</span><span class="p">(</span><span class="nx">chanparkcommit</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">),</span> <span class="nx">waitReasonChanSend</span><span class="p">,</span> <span class="nx">traceEvGoBlockSend</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>	<span class="c1">// è°ƒç¦»å½“å‰gè¿›å…¥è°ƒåº¦å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰gè¢«å†æ¬¡è°ƒåº¦èµ·æ¥æ—¶ï¼Œç»§ç»­è¿™é‡Œæ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Ensure the value being sent is kept alive until the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// receiver copies it out. The sudog has a pointer to the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// stack object, but sudogs aren&#39;t considered as roots of the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// stack tracer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç¡®ä¿æ­£åœ¨å‘é€çš„å€¼åœ¨æ¥æ”¶æ–¹å¤åˆ¶å‡ºæ¥ä¹‹å‰éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sudogæœ‰ä¸€ä¸ªæŒ‡å‘æ ˆå¯¹è±¡çš„æŒ‡é’ˆï¼Œä½†sudogsä¸è¢«è®¤ä¸ºæ˜¯æ ˆè·Ÿè¸ªå™¨çš„rootsã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// https://zhuanlan.zhihu.com/p/213744309
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">KeepAlive</span><span class="p">(</span><span class="nx">ep</span><span class="p">)</span> <span class="c1">// ä¿æŒepæ˜¯æ´»è·ƒçš„ï¼Œå› ä¸ºepæ¥è‡ªç”¨æˆ·ç«¯å¯èƒ½epä¼šè¢«å›æ”¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// someone woke us up.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æœ‰äººæŠŠæˆ‘ä»¬å«é†’äº†ï¼Œå¯èƒ½æ˜¯æ­£å¸¸ &lt;-c æˆ–è€… close() å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">mysg</span> <span class="o">!=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">waiting</span> <span class="p">{</span>	<span class="c1">// å½“å‰ gp æ˜¯å¦ç­‰å¾…åœ¨ mysq ä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;G waiting list is corrupted&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">waiting</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// activeStackChansè¡¨ç¤ºæœ‰æœªé”å®šçš„é€šé“æŒ‡å‘è¿™ä¸ªgoroutineçš„å †æ ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœä¸ºtrueï¼Œå †æ ˆå¤åˆ¶éœ€è¦è·å¾—é€šé“é”æ¥ä¿æŠ¤å †æ ˆçš„è¿™äº›åŒºåŸŸã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// activeStackChans å­—æ®µåœ¨ gopark ä¸­ chanparkcommit å‡½æ•°ä¸­è¢«è®¾ç½®ä¸ºtrueï¼Œå› æ­¤æ˜¯goè¢«è°ƒç¦»CPUæ—¶å€™è®¾ç½®ä¸ºtrueï¼Œåœ¨å”¤é†’åè®¾ç½®ä¸ºfalseã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å…·ä½“å‚çœ‹æ ˆ runtime.copystack å‡½æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">activeStackChans</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ¥è‡ªclose()å‡½æ•°å”¤é†’æ—¶ï¼Œclosedä¸ºtrueã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">closed</span> <span class="o">:=</span> <span class="p">!</span><span class="nx">mysg</span><span class="p">.</span><span class="nx">success</span> <span class="c1">// å¦‚æœæ˜¯æœ‰closeå”¤é†’çš„è¿™é‡Œsuccessä¸ºfalseå¹¶closedä¸º1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">param</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">mysg</span><span class="p">.</span><span class="nx">releasetime</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">blockevent</span><span class="p">(</span><span class="nx">mysg</span><span class="p">.</span><span class="nx">releasetime</span><span class="o">-</span><span class="nx">t0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mysg</span><span class="p">.</span><span class="nx">c</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nf">releaseSudog</span><span class="p">(</span><span class="nx">mysg</span><span class="p">)</span>	<span class="c1">// å›æ”¶*sudog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œä¹Ÿè§£é‡Šäº†å…³é—­channeléœ€è¦è°¨æ…æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸€ä¸ªgoroutineæ­£åœ¨sendï¼Œè€Œå¦å¤–ä¸€ä¸ªgoroutineå´closeäº†ï¼Œè¿™é‡Œå°±ä¼španicã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">closed</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ¥è‡ªclose()å‡½æ•°å”¤é†’æ—¶closedå­—æ®µåº”è¯¥ä¸º1ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">closed</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;chansend: spurious wakeup&#34;</span><span class="p">)</span> <span class="c1">// chansend è™šå‡å”¤é†’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// c.closed == 1æ—¶ï¼Œè¿˜å­˜åœ¨sendçš„gå´å…³é—­äº†chanæŠ¥é”™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å› æ­¤ close() å‡½æ•°ä¸è¦åœ¨è¿˜æœ‰sendæœªå®Œæˆæ—¶è°ƒç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">panic</span><span class="p">(</span><span class="nf">plainError</span><span class="p">(</span><span class="s">&#34;send on closed channel&#34;</span><span class="p">))</span> <span class="c1">// send åœ¨å…³é—­çš„ channel ä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="full">full()<a hidden class="anchor" aria-hidden="true" href="#full">#</a></h3>
<ol>
<li>full() æŠ¥å‘Šåœ¨ c ä¸Šçš„å‘é€æ˜¯å¦ä¼šé˜»å¡(å³é€šé“å·²æ»¡)ã€‚</li>
<li>å®ƒä½¿ç”¨äº†ä¸€ä¸ªå¯å˜çŠ¶æ€çš„word-sizedçš„è¯»å–ï¼Œå› æ­¤å°½ç®¡ç­”æ¡ˆç«‹å³ä¸ºtrueï¼Œä½†åœ¨è°ƒç”¨å‡½æ•°æ”¶åˆ°è¿”å›å€¼æ—¶ï¼Œæ­£ç¡®çš„ç­”æ¡ˆå¯èƒ½å·²ç»æ”¹å˜äº†ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// full reports whether a send on c would block (that is, the channel is full).
</span></span></span><span class="line"><span class="cl"><span class="c1">// It uses a single word-sized read of mutable state, so although
</span></span></span><span class="line"><span class="cl"><span class="c1">// the answer is instantaneously true, the correct answer may have changed
</span></span></span><span class="line"><span class="cl"><span class="c1">// by the time the calling function receives the return value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">full</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// c.dataqsiz is immutable (never written after the channel is created)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// so it is safe to read at any time during channel operation.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// c.dataqsizæ˜¯ä¸å¯å˜çš„(åœ¨é€šé“åˆ›å»ºåæ°¸ä¸å†™å…¥)ï¼Œå› æ­¤åœ¨é€šé“æ“ä½œæœŸé—´çš„ä»»ä½•æ—¶å€™è¯»å–éƒ½æ˜¯å®‰å…¨çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">dataqsiz</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Assumes that a pointer read is relaxed-atomic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å‡å®šæŒ‡é’ˆè¯»å–æ˜¯relaxed-atomicçš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvq</span><span class="p">.</span><span class="nx">first</span> <span class="o">==</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Assumes that a uint read is relaxed-atomic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å‡è®¾uint readæ˜¯relax-atomicã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">qcount</span> <span class="o">==</span> <span class="nx">c</span><span class="p">.</span><span class="nx">dataqsiz</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="send">send()<a hidden class="anchor" aria-hidden="true" href="#send">#</a></h3>
<ol>
<li>äº¤æ¢æ•°æ®ï¼Œå¹¶è°ƒç”¨<code>goready</code>æŠŠç­‰å¾…çš„<code>G</code>æ”¾å…¥<code>p</code>ä¸­ç­‰å¾…è°ƒåº¦ã€‚</li>
<li>send å¤„ç†ç©ºé€šé“ c ä¸Šçš„å‘é€æ“ä½œã€‚</li>
<li>å‘é€ç«¯å‘é€çš„å€¼ ep è¢«å¤åˆ¶åˆ°æ¥æ”¶ç«¯sgã€‚ç„¶åï¼Œæ¥æ”¶è€…è¢«å”¤é†’ï¼Œç»§ç»­å®ƒçš„å¿«ä¹ä¹‹è·¯ã€‚</li>
<li>é€šé“cå¿…é¡»æ˜¯ç©ºçš„å¹¶è¢«é”å®šã€‚ç”¨unlockfå‘é€è§£é”cã€‚sgå¿…é¡»å·²ç»ä»cä¸­é€€å‡ºé˜Ÿåˆ—ã€‚</li>
<li>epå¿…é¡»æ˜¯éç©ºå€¼ï¼Œå¹¶ä¸”æŒ‡å‘å †æˆ–è°ƒç”¨è€…çš„å †æ ˆã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><strong><code>c *hchan</code></strong>ï¼šhchan ç»“æ„ä½“æŒ‡é’ˆã€‚</li>
<li><strong><code>sg *sudog</code></strong>ï¼šæ˜¯ç­‰å¾… ep &lt;- c çš„ gã€‚</li>
<li><strong><code>ep unsafe.Pointer</code></strong>ï¼šæ˜¯ c &lt;- ep çš„æ•°æ®åœ°å€ã€‚</li>
<li><strong><code>unlockf func()</code></strong>ï¼šé—­åŒ…å‡½æ•°è§£é” c.lockã€‚</li>
<li><strong><code>skip int</code></strong>ï¼šskip è·³è¿‡æ­¥éª¤ã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// send processes a send operation on an empty channel c.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The value ep sent by the sender is copied to the receiver sg.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The receiver is then woken up to go on its merry way.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Channel c must be empty and locked.  send unlocks c with unlockf.
</span></span></span><span class="line"><span class="cl"><span class="c1">// sg must already be dequeued from c.
</span></span></span><span class="line"><span class="cl"><span class="c1">// ep must be non-nil and point to the heap or the caller&#39;s stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">,</span> <span class="nx">sg</span> <span class="o">*</span><span class="nx">sudog</span><span class="p">,</span> <span class="nx">ep</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">unlockf</span> <span class="kd">func</span><span class="p">(),</span> <span class="nx">skip</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">dataqsiz</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">racesync</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">sg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Pretend we go through the buffer, even though
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// we copy directly. Note that we need to increment
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// the head/tail locations only when raceenabled.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">racenotify</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">racenotify</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span><span class="p">,</span> <span class="nx">sg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span> <span class="o">==</span> <span class="nx">c</span><span class="p">.</span><span class="nx">dataqsiz</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">c</span><span class="p">.</span><span class="nx">sendx</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span> <span class="c1">// c.sendx = (c.sendx+1) % c.dataqsiz
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// sg.elem æ˜¯ç­‰å¾…è¯»çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯ep &lt;- cè¿™é‡Œçš„epåœ°å€ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">elem</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æŠŠepå¤åˆ¶åˆ°sg.elemä¸­ï¼Œè¿™æ ·å°±å®Œæˆäº†chançš„æ•°æ®äº¤æ¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">sendDirect</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nx">sg</span><span class="p">,</span> <span class="nx">ep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sg</span><span class="p">.</span><span class="nx">elem</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">g</span>  <span class="c1">// å–å‡ºå‡†å¤‡æ¢å¤çš„g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æŠŠ hchan è§£é”ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">unlockf</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å”¤é†’æ—¶ä¼ é€’çš„å‚æ•°ã€‚ä¸»è¦ç”¨ä¸ select è¯­å¥å”¤é†’åä½¿ç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// select æ‹¿ç€è¿™ä¸ªå‚æ•°çš„å€¼åšæ¯”å¯¹ï¼Œæ˜¯å“ªä¸ª case å°±ç»ªäº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">param</span> <span class="p">=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">sg</span><span class="p">)</span> <span class="c1">// g.param = *sudog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æŠŠsg.successæ ‡è®°ä¸ºtrueè¡¨ç¤ºæ•°æ®å·²ç»äº¤æ¢æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sg</span><span class="p">.</span><span class="nx">success</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">releasetime</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sg</span><span class="p">.</span><span class="nx">releasetime</span> <span class="p">=</span> <span class="nf">cputicks</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">goready</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">skip</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="senddirect">sendDirect()<a hidden class="anchor" aria-hidden="true" href="#senddirect">#</a></h4>
<ol>
<li>ä» src -&gt; sg.elemã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">sendDirect</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">_type</span><span class="p">,</span> <span class="nx">sg</span> <span class="o">*</span><span class="nx">sudog</span><span class="p">,</span> <span class="nx">src</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// src is on our stack, dst is a slot on another stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// srcåœ¨æˆ‘ä»¬çš„å †æ ˆä¸Šï¼Œdstæ˜¯å¦ä¸€ä¸ªå †æ ˆä¸Šçš„æ’æ§½ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Once we read sg.elem out of sg, it will no longer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// be updated if the destination&#39;s stack gets copied (shrunk).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// So make sure that no preemption points can happen between read &amp; use.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸€æ—¦æˆ‘ä»¬ä»sgä¸­è¯»å…¥sg.elemï¼Œå¦‚æœç›®æ ‡å †æ ˆè¢«å¤åˆ¶(æ”¶ç¼©)ï¼Œå®ƒå°†ä¸å†è¢«æ›´æ–°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› æ­¤ï¼Œè¯·ç¡®ä¿åœ¨è¯»å–å’Œä½¿ç”¨ä¹‹é—´ä¸ä¼šå‘ç”ŸæŠ¢å ç‚¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">dst</span> <span class="o">:=</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">elem</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// typeBitsBulkBarrierå¯¹memmoveä½¿ç”¨ç±»å‹ä½å›¾å®šä½æŒ‡é’ˆæ§½å°†[src, src+size)å¤åˆ¶åˆ°[dst, dst+size)çš„æ¯ä¸ªæŒ‡é’ˆæ‰§è¡Œå†™å±éšœã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç±»å‹typå¿…é¡»ç²¾ç¡®å¯¹åº”äº[src, src+size)å’Œ[dst, dst+size)ã€‚dstã€srcå’Œsizeå¿…é¡»æ˜¯æŒ‡é’ˆå¯¹é½çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">typeBitsBulkBarrier</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">dst</span><span class="p">),</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">src</span><span class="p">),</span> <span class="nx">t</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// No need for cgo write barrier checks because dst is always
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Go memory.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸éœ€è¦cgoå†™å±éšœæ£€æŸ¥ï¼Œå› ä¸ºdstæ€»æ˜¯Goå†…å­˜ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memmove</span><span class="p">(</span><span class="nx">dst</span><span class="p">,</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>	<span class="c1">// src -&gt; dst
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="goready">goready()<a hidden class="anchor" aria-hidden="true" href="#goready">#</a></h4>
<ol>
<li>æ¢å¤<code>gp</code>ä¹Ÿå°±æ˜¯<code>goroutine</code>å‰è¿›è¡Œæ ˆåˆ‡æ¢åˆ°<code>g0</code>æ ˆã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">goready</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">traceskip</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>	<span class="c1">// åˆ‡æ¢åˆ°g0æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">ready</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">traceskip</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ready">ready()<a hidden class="anchor" aria-hidden="true" href="#ready">#</a></h4>
<ol>
<li>æ¢å¤<code>gp</code>ä¹Ÿå°±æ˜¯è¿™ä¸ª<code>goroutine</code>ç›¸å…³çš„çŠ¶æ€ï¼Œç„¶åæ”¾å…¥<code>P</code>ä¸­ç­‰å¾…è¢«è°ƒåº¦ã€‚</li>
<li>æ ‡è®° gp å‡†å¤‡è¿è¡Œã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><strong><code>gp *g</code></strong>ï¼šå½“å‰éœ€è¦æ¢å¤çš„goroutine</li>
<li><strong><code>traceskip int</code></strong>ï¼šæ£€æŸ¥è·³è¿‡æ­¥éª¤</li>
<li><strong><code>next bool</code></strong>ï¼š<code>next</code>ä¸º<code>true</code>æ—¶ï¼Œåˆ™å°†<code>gp</code>æ”¾å…¥åˆ°<code>_p_.runnext</code>ä¸­</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Mark gp ready to run.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">ready</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">traceskip</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">next</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceGoUnpark</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">traceskip</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å–å½“å‰gpè¿™ä¸ªgoroutineçš„çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">status</span> <span class="o">:=</span> <span class="nf">readgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Mark runnable.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>    <span class="c1">// å½“å‰æ­£åœ¨è¿è¡Œçš„gè¿™é‡Œæ˜¯g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç¦ç”¨æŠ¢å ï¼Œå› ä¸ºå®ƒå¯ä»¥åœ¨æœ¬åœ°å˜é‡ä¸­æŒæœ‰p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">acquirem</span><span class="p">()</span> <span class="c1">// disable preemption because it can be holding p in a local var
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">status</span><span class="o">&amp;^</span><span class="nx">_Gscan</span> <span class="o">!=</span> <span class="nx">_Gwaiting</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">dumpgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad g-&gt;status in ready&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// status is Gwaiting or Gscanwaiting, make Grunnable and put on runq
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Gwaiting</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span> <span class="c1">// åˆ‡æ¢gpçš„çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// gpæ”¾å…¥pçš„æœ¬åœ°é˜Ÿåˆ—ï¼Œè¿™é‡Œnextæ˜¯trueæ—¶ï¼Œä¼šæ”¾å…¥nextå­—æ®µä¼šä¼˜å…ˆè°ƒåº¦èµ·æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">runqput</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">(),</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// å› ä¸ºæœ‰goroutineæ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œå°è¯•å”¤é†’å…¶ä»–å·¥ä½œçº¿ç¨‹èµ·æ¥å·¥ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">wakep</span><span class="p">()</span> <span class="c1">// æœ‰goroutineè¢«æ”¾å›é˜Ÿåˆ—è¯¥å‡½æ•°å°±ä¼šç´§æ¥ç€è¢«è°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">releasem</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="chanbuf">chanbuf()<a hidden class="anchor" aria-hidden="true" href="#chanbuf">#</a></h3>
<ol>
<li>chanbuf(c, i) æ˜¯æŒ‡å‘ç¼“å†²åŒºç¬¬ i ä¸ªæ§½çš„æŒ‡é’ˆã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// chanbuf(c, i) is pointer to the i&#39;th slot in the buffer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">chanbuf</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">,</span> <span class="nx">i</span> <span class="kt">uint</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">add</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">buf</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemsize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ep---c">ep &lt;- c<a hidden class="anchor" aria-hidden="true" href="#ep---c">#</a></h2>
<ol>
<li>ä» c ä¸­è¯»å–æ•°æ®ã€‚</li>
<li>ç¼–è¯‘åä»£ç ä¸­ <strong>&lt;- c</strong> çš„å…¥å£ç‚¹ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// ep &lt;- c
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// as  
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// chanrecv1(c, &amp;ep)
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// entry points for &lt;- c from compiled code
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">chanrecv1</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">,</span> <span class="nx">elem</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">chanrecv</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">elem</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="chanrecv">chanrecv()<a hidden class="anchor" aria-hidden="true" href="#chanrecv">#</a></h3>
<ol>
<li>chanrecv åœ¨é€šé“ c æ¥æ”¶æ•°æ®ï¼Œå¹¶å°†æ¥æ”¶åˆ°çš„æ•°æ®å†™å…¥ epã€‚</li>
<li>epå¯ä»¥æ˜¯nilï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æ¥æ”¶åˆ°çš„æ•°æ®å°†è¢«å¿½ç•¥ã€‚</li>
<li>å¦‚æœblock == falseä¸”æ²¡æœ‰å…ƒç´ å¯ç”¨ï¼Œåˆ™è¿”å›(false, false)ã€‚å¦åˆ™ï¼Œå¦‚æœcæ˜¯å…³é—­çš„ï¼Œåˆ™<code>*ep</code>è®¾ç½®æˆé›¶å€¼å¹¶è¿”å›(true, false)ã€‚å¦åˆ™ï¼Œç”¨ä¸€ä¸ªå…ƒç´ å¡«å……<code>*ep</code>å¹¶è¿”å›(true, true)ã€‚</li>
<li>énilçš„epå¿…é¡»æŒ‡å‘å †æˆ–è°ƒç”¨è€…çš„å †æ ˆã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><strong><code>c *hchan</code></strong>ï¼šhchanç»“æ„ä½“æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯ <code>ep &lt;- c</code> ä¸­ c çš„ç»“æ„ä½“æŒ‡é’ˆã€‚æŒ‡å‘è¦ä»recvæ•°æ®çš„channelã€‚</li>
<li><strong><code>ep unsafe.Pointer</code></strong>ï¼šæ¥æ”¶å˜é‡åœ°å€ï¼Œä¹Ÿå°±æ˜¯ <code>ep &lt;- c</code> ä¸­epå˜é‡çš„åœ°å€ã€‚æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ç”¨æ¥æ¥æ”¶æ•°æ®çš„å†…å­˜ï¼Œæ•°æ®ç±»å‹è¦å’Œcçš„å…ƒç´ ç±»å‹ä¸€è‡´ã€‚</li>
<li><strong><code>block bool</code></strong>ï¼štrue.è¡¨ç¤ºå¦‚æœrecvæ“ä½œä¸èƒ½ç«‹å³å®Œæˆï¼Œæ˜¯å¦æƒ³è¦é˜»å¡ç­‰å¾…ã€‚true.ä¸èƒ½ç«‹å³å®Œæˆåˆ™é˜»å¡ï¼Œfalse.ä¸èƒ½ç«‹å³å®Œæˆä¸é˜»å¡ï¼Œç”¨äºselect{case: default:}å½¢å¼ã€‚</li>
</ul>
</li>
<li>è¿”å›å€¼ï¼šè¿™ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯ç”¨äº select{case: default:}å½¢å¼çš„ã€‚selectedè¡¨ç¤ºå½“å‰caseè¢«é€‰ä¸­ã€‚receivedè¡¨ç¤ºæ•°æ®æœ‰æ²¡äº¤æ¢æˆåŠŸã€‚
<ul>
<li><strong><code>selected bool</code></strong>ï¼štrue.è¡¨ç¤ºæ“ä½œå®Œæˆï¼ˆå¯èƒ½å› ä¸ºé€šé“å·²ç»å…³é—­ï¼‰ã€‚false.è¡¨ç¤ºç›®å‰ä¸èƒ½ç«‹å³å®Œæˆrecvï¼Œä½†å› ä¸ºä¸æƒ³é˜»å¡ï¼ˆblockä¸ºfalseï¼‰è€Œè¿”å›ã€‚</li>
<li><strong><code>received bool</code></strong>ï¼štrue.è¡¨ç¤ºæ•°æ®ç¡®å®æ˜¯ä»é€šé“ä¸­æ¥æ”¶çš„ï¼Œä¸æ˜¯å› ä¸ºé€šé“å…³é—­è€Œå¾—åˆ°çš„é›¶å€¼ã€‚false.å¯èƒ½æ˜¯å› ä¸ºé€šé“å…³é—­è€Œå¾—åˆ°çš„é›¶å€¼ï¼ˆselectedä¸ºtrueï¼‰ï¼Œæˆ–è€…å› ä¸ºä¸æƒ³é˜»å¡è€Œè¿”å›ï¼ˆselectedä¸ºfalseï¼‰ã€‚</li>
</ul>
</li>
<li>è¿”å›å€¼çš„ç»„æˆï¼š
<ol>
<li><strong>(true, true)</strong>ï¼šæ“ä½œå·²å®Œæˆï¼Œç¡®å®æ˜¯ä»channelä¸­æ¥æ”¶çš„ï¼ˆä¸æ˜¯å› ä¸ºchannelå…³é—­è€Œå¾—åˆ°çš„é›¶å€¼ï¼‰ã€‚ï¼ˆå½“å‰åˆ†æ”¯è¢«é€‰ä¸­ï¼Œæ•°æ®ä¹Ÿäº¤æ¢æˆåŠŸäº†ï¼‰</li>
<li><strong>(false, false)</strong>ï¼šç›®å‰ä¸èƒ½ç«‹å³å®Œæˆï¼Œå› ä¸ºä¸æƒ³é˜»å¡è€Œè¿”å›ã€‚ï¼ˆå½“å‰åˆ†æ”¯æ²¡è¢«é€‰ä¸­ï¼Œèµ°defaultå§ï¼‰</li>
<li><strong>(true, false)</strong>ï¼šæ“ä½œå·²å®Œæˆï¼Œå› ä¸ºé€šé“å…³é—­è€Œè¿”å›é›¶å€¼ã€‚ï¼ˆå½“å‰åˆ†æ”¯è¢«é€‰ä¸­ï¼Œå› closeè€Œè¿”å›é»˜è®¤é›¶å€¼ï¼‰</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// chanrecv receives on channel c and writes the received data to ep.
</span></span></span><span class="line"><span class="cl"><span class="c1">// ep may be nil, in which case received data is ignored.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If block == false and no elements are available, returns (false, false).
</span></span></span><span class="line"><span class="cl"><span class="c1">// Otherwise, if c is closed, zeros *ep and returns (true, false).
</span></span></span><span class="line"><span class="cl"><span class="c1">// Otherwise, fills in *ep with an element and returns (true, true).
</span></span></span><span class="line"><span class="cl"><span class="c1">// A non-nil ep must point to the heap or the caller&#39;s stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">chanrecv</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">,</span> <span class="nx">ep</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">block</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="nx">selected</span><span class="p">,</span> <span class="nx">received</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// raceenabled: don&#39;t need to check ep, as it is always on the stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// or is new memory allocated by reflect.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Raceenabled:ä¸éœ€è¦æ£€æŸ¥epï¼Œå› ä¸ºå®ƒæ€»æ˜¯åœ¨å †æ ˆä¸Šæˆ–ç”±reflectåˆ†é…æ–°çš„å†…å­˜ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">debugChan</span> <span class="p">{</span>  <span class="c1">// debug
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;chanrecv: chan=&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) chanæœªåˆå§‹åŒ–æ—¶ï¼Œæ¯”å¦‚ var c chan int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">c</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nx">block</span> <span class="p">{</span> <span class="c1">// æ¥è‡ªselect{case: default:}å—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span>  <span class="c1">// false, false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// &lt;- nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1">// è¿™é‡Œåœ¨nilçš„chanä¸­è¯»å–æ•°æ®ï¼Œç›´æ¥åˆ‡æ¢åˆ°è°ƒåº¦å¾ªç¯è¿›è¡Œæ–°ä¸€è½®è°ƒåº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿™ä¸ªGåé¢çš„ä»£ç å°†ä¸ä¼šå¾—åˆ°æ‰§è¡Œï¼Œåº”è¯¥å½“å‰Gæ—¢æ²¡æœ‰åŠ å…¥åˆ°Pä¸­ç­‰å¾…è°ƒåº¦ï¼Œä¹Ÿæ²¡æœ‰åœ¨chanä¸­ï¼Œæ°¸ä¹…ä¸¢å¤±äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">gopark</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">waitReasonChanReceiveNilChan</span><span class="p">,</span> <span class="nx">traceEvGoStop</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;unreachable&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2) Fast pathï¼šåœ¨æœªåŠ é”ä¸‹ï¼Œåˆ¤æ–­blockä¸ºfalseæ—¶ï¼Œsendä¸ºç©ºæ—¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Fast path: check for failed non-blocking operation without acquiring the lock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Fast path: æ£€æŸ¥æœªè·å¾—é”çš„å¤±è´¥çš„éé˜»å¡æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nx">block</span> <span class="o">&amp;&amp;</span> <span class="nf">empty</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// select{case: default:}å—ï¼Œcä¸ºç©º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// After observing that the channel is not ready for receiving, we observe whether the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// channel is closed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Reordering of these checks could lead to incorrect behavior when racing with a close.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// For example, if the channel was open and not empty, was closed, and then drained,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// reordered reads could incorrectly indicate &#34;open and empty&#34;. To prevent reordering,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// we use atomic loads for both checks, and rely on emptying and closing to happen in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// separate critical sections under the same lock.  This assumption fails when closing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// an unbuffered channel with a blocked send, but that is an error condition anyway.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åœ¨è§‚å¯Ÿåˆ°é€šé“è¿˜æ²¡æœ‰å‡†å¤‡å¥½æ¥æ”¶ä¹‹åï¼Œæˆ‘ä»¬è§‚å¯Ÿé€šé“æ˜¯å¦å…³é—­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åœ¨ä¸closeç«äº‰æ—¶ï¼Œè¿™äº›æ£€æŸ¥çš„é‡æ–°æ’åºå¯èƒ½ä¼šå¯¼è‡´é”™è¯¯çš„è¡Œä¸ºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä¾‹å¦‚ï¼Œå¦‚æœchannelæ˜¯æ‰“å¼€çš„ä¸”ä¸æ˜¯ç©ºçš„ï¼Œè¢«å…³é—­ï¼Œç„¶åå…¨éƒ¨å–å‡ºï¼Œé‡æ–°æ’åºçš„è¯»æ•°å¯èƒ½ä¼šé”™è¯¯åœ°æŒ‡ç¤º&#34;open and empty&#34;ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä¸ºäº†é˜²æ­¢é‡æ–°æ’åºï¼Œæˆ‘ä»¬å¯¹è¿™ä¸¤ç§æ£€æŸ¥éƒ½ä½¿ç”¨äº†åŸå­åŠ è½½ï¼Œå¹¶ä¾èµ–äºåœ¨åŒä¸€é”ä¸‹çš„ä¸åŒä¸´ç•ŒåŒºä¸­è¿›è¡Œæ¸…ç©ºå’Œå…³é—­æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å½“ä»¥é˜»å¡çš„å‘é€æ–¹å¼å…³é—­æ— ç¼“å†²çš„é€šé“æ—¶ï¼Œè¿™ä¸ªå‡è®¾å°±å¤±è´¥äº†ï¼Œä½†æ— è®ºå¦‚ä½•è¿™éƒ½æ˜¯ä¸€ä¸ªé”™è¯¯æ¡ä»¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">closed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// sendä¸ºç©º å¹¶ closed æœªå…³é—­ï¼Œè¿”å› (false, false)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Because a channel cannot be reopened, the later observation of the channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// being not closed implies that it was also not closed at the moment of the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// first observation. We behave as if we observed the channel at that moment
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// and report that the receive cannot proceed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å› ä¸ºchannelä¸èƒ½é‡æ–°æ‰“å¼€ï¼Œæ‰€ä»¥åæ¥è§‚å¯Ÿåˆ°çš„channelæ²¡æœ‰å…³é—­æ„å‘³ç€åœ¨ç¬¬ä¸€æ¬¡è§‚å¯Ÿçš„æ—¶å€™å®ƒä¹Ÿæ²¡æœ‰å…³é—­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æˆ‘ä»¬çš„è¡Œä¸ºå°±åƒæˆ‘ä»¬å½“æ—¶è§‚å¯Ÿåˆ°äº†channelï¼Œå¹¶æŠ¥å‘Šè¯´æ¥æ”¶æ— æ³•ç»§ç»­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// The channel is irreversibly closed. Re-check whether the channel has any pending data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// to receive, which could have arrived between the empty and closed checks above.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Sequential consistency is also required here, when racing with such a send.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// channelæ˜¯ä¸å¯é€†å…³é—­çš„ã€‚é‡æ–°æ£€æŸ¥ä¿¡é“æ˜¯å¦æœ‰å¾…å¤„ç†çš„æ•°æ®è¦æ¥æ”¶ï¼Œè¿™äº›æ•°æ®å¯èƒ½æ˜¯åœ¨ä¸Šé¢çš„ç©ºæ£€æŸ¥å’Œå…³é—­æ£€æŸ¥ä¹‹é—´åˆ°è¾¾çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å½“ä½¿ç”¨è¿™æ ·çš„å‘é€æ–¹å¼æ¯”èµ›æ—¶ï¼Œé¡ºåºçš„ä¸€è‡´æ€§ä¹Ÿæ˜¯å¿…éœ€çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nf">empty</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// sendä¸ºç©º å¹¶ä¸” closed å·²å…³é—­ï¼Œè¿”å› (true, false)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// The channel is irreversibly closed and empty.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">raceacquire</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nf">raceaddr</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">ep</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">typedmemclr</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nx">ep</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">t0</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">blockprofilerate</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">t0</span> <span class="p">=</span> <span class="nf">cputicks</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3) åŠ é”æƒ…å†µä¸‹å»åˆ¤æ–­ send å’Œ sendq æ˜¯å¦æœ‰ç­‰å¾… send çš„æ•°æ®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span> <span class="c1">// è·å–runtime.mutex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// channel å·²å…³é—­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">closed</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">        <span class="c1">// send bufç¼“å†²åŒºæ²¡æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">qcount</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">raceacquire</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nf">raceaddr</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æ‹·è´å¯¹åº”ç±»å‹çš„é›¶å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">ep</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Typedmemclræ¸…é™¤ç±»å‹ä¸ºtypçš„ptrçš„ç±»å‹åŒ–å†…å­˜ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">typedmemclr</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nx">ep</span><span class="p">)</span> <span class="c1">// ep èµ‹å€¼chanå…ƒç´ ç±»å‹çš„é»˜è®¤å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// The channel has been closed, but the channel&#39;s buffer have data.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// channel å·²ç»å…³é—­ï¼Œä½†é€šé“çš„ç¼“å†²åŒºæœ‰æ•°æ®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// channel æœªå…³é—­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Just found waiting sender with not closed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åˆšåˆšå‘ç°ç­‰å¾…sendæœªå…³é—­ã€‚å–å‡ºfirstä¸Šçš„ç¬¬ä¸€ä¸ª*sudogï¼Œè¿™ä¸ªéœ€è¦å¤„ç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿™é‡Œéšå«äº† buf ç¼“å­˜åŒºä¸ºç©ºçš„æƒ…å†µã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">sg</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">sendq</span><span class="p">.</span><span class="nf">dequeue</span><span class="p">();</span> <span class="nx">sg</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Found a waiting sender. If buffer is size 0, receive value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// directly from sender. Otherwise, receive from head of queue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// and add sender&#39;s value to the tail of the queue (both map to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// the same buffer slot because the queue is full).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å‘ç°ä¸€ä¸ªç­‰å¾…å‘é€è€…ã€‚å¦‚æœç¼“å†²åŒºå¤§å°æ˜¯0ï¼Œæ¥æ”¶å€¼ç›´æ¥ä»å‘é€æ–¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦åˆ™ï¼Œä»é˜Ÿåˆ—çš„å¤´éƒ¨æ¥æ”¶å¹¶å°†å‘é€æ–¹çš„å€¼æ·»åŠ åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨(ä¸¤è€…æ˜ å°„åˆ°ç›¸åŒçš„ç¼“å†²æ§½ï¼Œå› ä¸ºé˜Ÿåˆ—å·²æ»¡)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">recv</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">sg</span><span class="p">,</span> <span class="nx">ep</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span> <span class="p">},</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// buf ç¼“å†²åŒºæœ‰æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">qcount</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Receive directly from queue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ç›´æ¥ä»ç¼“å­˜åŒºé˜Ÿåˆ—ä¸­æ¥æ”¶æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">qp</span> <span class="o">:=</span> <span class="nf">chanbuf</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">racenotify</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// äº¤æ¢æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">ep</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">typedmemmove</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nx">ep</span><span class="p">,</span> <span class="nx">qp</span><span class="p">)</span> <span class="c1">// ep = qp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">typedmemclr</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nx">qp</span><span class="p">)</span>          <span class="c1">// æ¸…é™¤ qp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span> <span class="o">==</span> <span class="nx">c</span><span class="p">.</span><span class="nx">dataqsiz</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nx">qcount</span><span class="o">--</span>                           <span class="c1">// ç¼“å­˜åŒºå…ƒç´ ä¸ªæ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¸‹é¢ä»£ç æ˜¯éœ€è¦è¢«é˜»å¡çš„æƒ…å†µï¼Œå½“å‰goroutineè¢«åŠ¨æ‰§è¡Œè°ƒåº¦åˆ°c.sendqä¸­å»ç­‰å¾…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// block ä¸º falseï¼Œä¸æƒ³é˜»å¡è€Œè¿”å›ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nx">block</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 4) send bufå–æ²¡æœ‰æ•°æ®æˆ–sendqä¸­æ²¡æœ‰ç­‰å¾…çš„goroutineæ—¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// no sender available: block on this channel.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ²¡æœ‰å¯ç”¨çš„å‘é€è€…:åœ¨æ­¤é€šé“ä¸Šé˜»å¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>            <span class="c1">// g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mysg</span> <span class="o">:=</span> <span class="nf">acquireSudog</span><span class="p">()</span>  <span class="c1">// è·å–ä¸€ä¸ªç©ºé—²çš„ *sudog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mysg</span><span class="p">.</span><span class="nx">releasetime</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">t0</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mysg</span><span class="p">.</span><span class="nx">releasetime</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// No stack splits between assigning elem and enqueuing mysg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// on gp.waiting where copystack can find it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨åˆ†é…elemå’Œåœ¨gp.waitingä¸Šå¯¹mysgè¿›è¡Œæ’é˜Ÿä¹‹é—´æ²¡æœ‰æ ˆæ‹†åˆ†ï¼Œå› ä¸ºåœ¨gp.waitingä¸Šcopystackå¯ä»¥æ‰¾åˆ°å®ƒã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mysg</span><span class="p">.</span><span class="nx">elem</span> <span class="p">=</span> <span class="nx">ep</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mysg</span><span class="p">.</span><span class="nx">waitlink</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">waiting</span> <span class="p">=</span> <span class="nx">mysg</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mysg</span><span class="p">.</span><span class="nx">g</span> <span class="p">=</span> <span class="nx">gp</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mysg</span><span class="p">.</span><span class="nx">isSelect</span> <span class="p">=</span> <span class="kc">false</span>   <span class="c1">// æ ‡è®°ä¸æ˜¯åœ¨selectå—ä¸­æ¥çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mysg</span><span class="p">.</span><span class="nx">c</span> <span class="p">=</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">param</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">.</span><span class="nx">recvq</span><span class="p">.</span><span class="nf">enqueue</span><span class="p">(</span><span class="nx">mysg</span><span class="p">)</span>   <span class="c1">// åŠ å…¥ recvq é˜Ÿåˆ—ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Signal to anyone trying to shrink our stack that we&#39;re about
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// to park on a channel. The window between when this G&#39;s status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// changes and when we set gp.activeStackChans is not safe for
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// stack shrinking.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å‘ä»»ä½•è¯•å›¾ç¼©å°å †æ ˆçš„äººå‘å‡ºä¿¡å·ï¼Œæˆ‘ä»¬å³å°†åœåœ¨ä¸€ä¸ªchannelä¸Šã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“Gçš„çŠ¶æ€æ”¹å˜å’Œæˆ‘ä»¬è®¾ç½®gpä¹‹é—´çš„çª—å£ã€‚activeStackChans å¯¹å †æ ˆæ”¶ç¼©ä¸å®‰å…¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// goroutine.parkingOnChanè¡¨ç¤ºè¯¥goroutineå³å°†åœåœ¨ä¸€ä¸ªchansendæˆ–chanrecvä¸Šã€‚ç”¨äºæŒ‡ç¤ºå †æ ˆæ”¶ç¼©çš„ä¸å®‰å…¨ç‚¹ã€‚å®ƒæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œä½†ä¼šè‡ªåŠ¨æ›´æ–°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store8</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">parkingOnChan</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// gopark ä¿å­˜å½“å‰goroutineçº¿ç¨‹; è°ƒç”¨ releasem(mp) è§£é™¤å½“å‰må’ŒPçš„ç»‘å®š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è°ƒç”¨mcall(park_m) mcallåˆ‡æ¢æ ˆåˆ°g0 park_m è§£é™¤må’Œgçš„å…³è” è°ƒç”¨scheduleå†æ¬¡å¼€å¯è°ƒåº¦å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">gopark</span><span class="p">(</span><span class="nx">chanparkcommit</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">),</span> <span class="nx">waitReasonChanReceive</span><span class="p">,</span> <span class="nx">traceEvGoBlockRecv</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// someone woke us up
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">mysg</span> <span class="o">!=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">waiting</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;G waiting list is corrupted&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">waiting</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">activeStackChans</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">mysg</span><span class="p">.</span><span class="nx">releasetime</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">blockevent</span><span class="p">(</span><span class="nx">mysg</span><span class="p">.</span><span class="nx">releasetime</span><span class="o">-</span><span class="nx">t0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">success</span> <span class="o">:=</span> <span class="nx">mysg</span><span class="p">.</span><span class="nx">success</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">param</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mysg</span><span class="p">.</span><span class="nx">c</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nf">releaseSudog</span><span class="p">(</span><span class="nx">mysg</span><span class="p">)</span> <span class="c1">// å›æ”¶ sudog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">success</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="empty">empty()<a hidden class="anchor" aria-hidden="true" href="#empty">#</a></h3>
<ol>
<li>EmptyæŠ¥å‘Šä»cè¯»å–æ•°æ®æ˜¯å¦ä¼šé˜»å¡(å³channelæ˜¯ç©ºçš„)ã€‚å®ƒä½¿ç”¨å•ä¸ªåŸå­è¯»å–å¯å˜çŠ¶æ€ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// empty reports whether a read from c would block (that is, the channel is
</span></span></span><span class="line"><span class="cl"><span class="c1">// empty).  It uses a single atomic read of mutable state.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">empty</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// c.dataqsiz is immutable.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// c.dataqsiz æ˜¯ä¸å¯å˜çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">dataqsiz</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ˜¯å¦æœ‰ç­‰å¾… send çš„ goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Loadp</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">sendq</span><span class="p">.</span><span class="nx">first</span><span class="p">))</span> <span class="o">==</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç¼“å­˜åŒºæ˜¯å¦æœ‰æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Loaduint</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">qcount</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="recv">recv()<a hidden class="anchor" aria-hidden="true" href="#recv">#</a></h3>
<ol>
<li>recv åœ¨ä¸€ä¸ªæ»¡çš„ç¼“å­˜åŒºçš„channel cä¸Šå¤„ç†æ¥æ”¶æ“ä½œ</li>
<li>æœ‰ä»¥ä¸‹ä¸¤éƒ¨åˆ†ï¼š
<ol>
<li>å‘é€æ”¾sgå‘é€çš„å€¼è¢«æ”¾å…¥channelï¼Œå‘é€æ–¹è¢«å”¤é†’</li>
<li>æ¥æ”¶ç«¯æ¥æ”¶åˆ°çš„å€¼(å½“å‰G)è¢«å†™å…¥ep</li>
</ol>
</li>
<li>å¯¹äºåŒæ­¥channelï¼Œè¿™ä¸¤ä¸ªå€¼æ˜¯ç›¸åŒçš„</li>
<li>å¯¹äºå¼‚æ­¥channelï¼Œæ¥æ”¶æ–¹ä»é€šé“ç¼“å†²åŒºè·å–æ•°æ®ï¼Œå‘é€æ–¹çš„æ•°æ®æ”¾åœ¨é€šé“ç¼“å†²åŒºä¸­ã€‚</li>
<li>é€šé“cå¿…é¡»å·²æ»¡ä¸”å·²é”å®šã€‚recvç”¨unlockfè§£é”cã€‚sgå¿…é¡»å·²ç»ä»cä¸­é€€å‡ºé˜Ÿåˆ—ã€‚</li>
<li>énilçš„epå¿…é¡»æŒ‡å‘å †æˆ–è°ƒç”¨è€…çš„å †æ ˆã€‚</li>
<li>å‚æ•°ï¼š
<ol>
<li><strong><code>c *hchan</code></strong>ï¼šå½“å‰ chan</li>
<li><strong><code>sg *sudog</code></strong>ï¼šä» recvq ä¸­çš„firstå–å‡ºçš„ç¬¬ä¸€ä¸ª *sudog</li>
<li><strong><code>ep unsafe.Pointer</code></strong>ï¼šv &lt;- c ä¸­çš„våœ°å€</li>
<li><strong><code>unlockf func()</code></strong>ï¼šè§£é” runtime.mutex çš„é—­åŒ…å‡½æ•°</li>
<li><strong><code>skip int</code></strong>ï¼šè°ƒè¯•ç›¸å…³</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// recv processes a receive operation on a full channel c.
</span></span></span><span class="line"><span class="cl"><span class="c1">// There are 2 parts:
</span></span></span><span class="line"><span class="cl"><span class="c1">//  1. The value sent by the sender sg is put into the channel
</span></span></span><span class="line"><span class="cl"><span class="c1">//     and the sender is woken up to go on its merry way.
</span></span></span><span class="line"><span class="cl"><span class="c1">//  2. The value received by the receiver (the current G) is
</span></span></span><span class="line"><span class="cl"><span class="c1">//     written to ep.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// For synchronous channels, both values are the same.
</span></span></span><span class="line"><span class="cl"><span class="c1">// For asynchronous channels, the receiver gets its data from
</span></span></span><span class="line"><span class="cl"><span class="c1">// the channel buffer and the sender&#39;s data is put in the
</span></span></span><span class="line"><span class="cl"><span class="c1">// channel buffer.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Channel c must be full and locked. recv unlocks c with unlockf.
</span></span></span><span class="line"><span class="cl"><span class="c1">// sg must already be dequeued from c.
</span></span></span><span class="line"><span class="cl"><span class="c1">// A non-nil ep must point to the heap or the caller&#39;s stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">recv</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">,</span> <span class="nx">sg</span> <span class="o">*</span><span class="nx">sudog</span><span class="p">,</span> <span class="nx">ep</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">unlockf</span> <span class="kd">func</span><span class="p">(),</span> <span class="nx">skip</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">dataqsiz</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// æ— ç¼“å†² chan
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">racesync</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">sg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">ep</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// copy data from sender
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ä»å‘é€æ–¹å¤åˆ¶æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">recvDirect</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nx">sg</span><span class="p">,</span> <span class="nx">ep</span><span class="p">)</span> <span class="c1">// ep = sg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>            <span class="c1">// æœ‰ç¼“å†² chan
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Queue is full. Take the item at the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// head of the queue. Make the sender enqueue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// its item at the tail of the queue. Since the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// queue is full, those are both the same slot.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// é˜Ÿåˆ—å·²æ»¡ã€‚ä»¥é˜Ÿåˆ—æœ€å‰é¢çš„é¡¹ä¸ºä¾‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è®©å‘é€æ–¹åœ¨é˜Ÿåˆ—çš„å°¾éƒ¨å°†å…¶é¡¹ç›®å…¥é˜Ÿã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å› ä¸ºé˜Ÿåˆ—å·²ç»æ»¡äº†ï¼Œæ‰€ä»¥å®ƒä»¬æ˜¯åŒä¸€ä¸ªæ§½ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä»¥ä¸Šæ„æ€æ˜¯ä»sendq.firstå–å‡ºçš„*sudogéœ€è¦æ¢å¤è¿™ä¸ªgå¹¶æŠŠæ•°æ®æ”¾å…¥ç¼“å­˜åŒºï¼Œä»ç¼“å­˜åŒºå–å‡ºä¸‹ä¸€ä¸ªæ•°æ®äº¤æ¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">qp</span> <span class="o">:=</span> <span class="nf">chanbuf</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span><span class="p">)</span> <span class="c1">// æ•°æ®åŒºçš„ä¸‹ä¸€ä¸ªéœ€è¦äº¤æ¢çš„æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">racenotify</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">racenotify</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span><span class="p">,</span> <span class="nx">sg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// copy data from queue to receiver
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å°†æ•°æ®ä»é˜Ÿåˆ—å¤åˆ¶åˆ°æ¥æ”¶å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">ep</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">typedmemmove</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nx">ep</span><span class="p">,</span> <span class="nx">qp</span><span class="p">)</span>    <span class="c1">// ep = qp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// copy data from sender to queue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä»å‘é€ç«¯å¤åˆ¶æ•°æ®åˆ°é˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">typedmemmove</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nx">qp</span><span class="p">,</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">elem</span><span class="p">)</span>   <span class="c1">// qp = sg.elem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span><span class="o">++</span>	<span class="c1">// ä¸‹ä¸€æ¬¡recvæ•°æ®ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span> <span class="o">==</span> <span class="nx">c</span><span class="p">.</span><span class="nx">dataqsiz</span> <span class="p">{</span>	<span class="c1">// å¦‚æœè¶…è¿‡æœ€å¤§é‡ç½®ä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è®¾ç½®ç¼“å­˜åŒºæ˜¯æ»¡çš„ï¼Œå› ä¸ºè¿™ç§æƒ…å†µç¼“å­˜åŒºä¸€å®šæ˜¯full
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ­¤æ—¶éœ€è¦è°ƒæ•´ sendx çš„å€¼ï¼Œå› ä¸ºä¹‹å‰å°±æ˜¯æ»¡çš„ è¯´æ˜ä¹‹å‰ c.sendx == c.recvx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">c</span><span class="p">.</span><span class="nx">sendx</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span> <span class="c1">// c.sendx = (c.sendx+1) % c.dataqsiz
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// sg ä¸­çš„ *sudog çš„géœ€è¦è¢«æ¢å¤è®©å…¶ä»æ–°è¢«è°ƒåº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sg</span><span class="p">.</span><span class="nx">elem</span> <span class="p">=</span> <span class="kc">nil</span>   <span class="c1">// æ•°æ®å·²è¢«æ”¾å…¥ç¼“å­˜åŒºï¼Œæƒ…å†µå³å¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">g</span>      <span class="c1">// éœ€è¦æ¢å¤çš„g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">unlockf</span><span class="p">()</span>       <span class="c1">// runtime.mutex è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“ä¸€ä¸ªchannelæ“ä½œå”¤é†’ä¸€ä¸ªè¢«é˜»å¡çš„goroutineæ—¶ï¼Œå®ƒå°†paramè®¾ç½®ä¸ºæŒ‡å‘å·²å®Œæˆé˜»å¡æ“ä½œçš„sudogã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// select æ‹¿ç€è¿™ä¸ªå‚æ•°çš„å€¼åšæ¯”å¯¹ï¼Œæ˜¯å“ªä¸ª case å°±ç»ªäº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">param</span> <span class="p">=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">sg</span><span class="p">)</span> <span class="c1">// ä¸»è¦ç”¨ä¸ select è¯­å¥å”¤é†’åä½¿ç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sg</span><span class="p">.</span><span class="nx">success</span> <span class="p">=</span> <span class="kc">true</span> <span class="c1">// success æ ‡è®°äº† trueï¼Œäº¤æ¢æ•°æ®æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">releasetime</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sg</span><span class="p">.</span><span class="nx">releasetime</span> <span class="p">=</span> <span class="nf">cputicks</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">goready</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">skip</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>	<span class="c1">// æ”¾å…¥é˜Ÿåˆ—ä¸­ç­‰å¾…å”¤é†’g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="goready-1">goready()<a hidden class="anchor" aria-hidden="true" href="#goready-1">#</a></h4>
<ol>
<li>æ¢å¤<code>gp</code>ä¹Ÿå°±æ˜¯<code>goroutine</code>å‰è¿›è¡Œæ ˆåˆ‡æ¢åˆ°<code>g0æ ˆ</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">goready</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">traceskip</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// åˆ‡æ¢åˆ° g0 æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">ready</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">traceskip</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ready-1">ready()<a hidden class="anchor" aria-hidden="true" href="#ready-1">#</a></h4>
<ol>
<li>æ ‡è®°gpå‡†å¤‡è¿è¡Œã€‚</li>
<li>å‚æ•°ï¼š
<ol>
<li><strong>gp *g</strong>ï¼šå‡†å¤‡æ¢å¤çš„ goroutine</li>
<li><strong>traceskip int</strong>ï¼šæµ‹è¯•ç›¸å…³</li>
<li><strong>next bool</strong>ï¼štrue.ä¸‹æ¬¡è°ƒåº¦ä¼˜å…ˆè°ƒåº¦å½“å‰goroutine</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Mark gp ready to run.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">ready</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">traceskip</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">next</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceGoUnpark</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">traceskip</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// goroutine çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">status</span> <span class="o">:=</span> <span class="nf">readgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Mark runnable.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>    <span class="c1">// å½“å‰g0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç¦æ­¢å½“å‰mè¢«æŠ¢å ï¼Œå› ä¸ºå³å°†æŠŠgpæ”¾å…¥må…³è”çš„æœ¬åœ°Pä¸­å»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">acquirem</span><span class="p">()</span> <span class="c1">// disable preemption because it can be holding p in a local var
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœå½“å‰gpçŠ¶æ€å¤„ç†åä¸ç­‰äº_Gwaitingç­‰å¾…ä¸­ï¼Œé‚£è¯´æ˜è¿™ä¸ªgpæ˜¯æœ‰é—®é¢˜çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">status</span><span class="o">&amp;^</span><span class="nx">_Gscan</span> <span class="o">!=</span> <span class="nx">_Gwaiting</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">dumpgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad g-&gt;status in ready&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// status is Gwaiting or Gscanwaiting, make Grunnable and put on runq
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æŠŠå½“å‰gpè¿™ä¸ªgoroutineçŠ¶æ€ä»_Gwaitingç­‰å¾…ä¸­ä¿®æ”¹ä¸º_Grunnableå¯ä»¥è¿è¡Œçš„çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Gwaiting</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç„¶åæŠŠgpæ”¾å…¥mçš„æœ¬åœ°å…³è”Pä¸­ï¼Œnextä¸ºtrueè¡¨ç¤ºæ”¾å…¥å‰é¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">runqput</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">(),</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">wakep</span><span class="p">()</span>         <span class="c1">// å°è¯•å”¤é†’å…¶ä»–çº¿ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">releasem</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>    <span class="c1">// è§£é™¤å‰é¢çš„ acquirem() å‡½æ•°çš„æŠ¢å ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦æœ‰æŠ¢å å‘ç”Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="runqput">runqput()<a hidden class="anchor" aria-hidden="true" href="#runqput">#</a></h4>
<ol>
<li>runqput è¯•å›¾å°†gæ”¾åˆ°æœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ—ä¸Šã€‚</li>
<li>å¦‚æœ next ä¸º false, runqput å°† g æ·»åŠ åˆ°å¯è¿è¡Œé˜Ÿåˆ—çš„å°¾éƒ¨ã€‚</li>
<li>å¦‚æœ next ä¸º true, runqput å°† g æ”¾å…¥<code>_p_.runnext</code>ä½ç½®ã€‚</li>
<li>å¦‚æœå°±ç»ªé˜Ÿåˆ—å·²æ»¡ï¼Œrunnext å°† g æ”¾ç½®åˆ°å…¨å±€é˜Ÿåˆ—ä¸­ã€‚</li>
<li>ä»…ç”±æ‰€æœ‰è€…Pæ‰§è¡Œã€‚</li>
<li>å‚æ•°ï¼š
<ol>
<li><code>_p_ *p</code>ï¼šå½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„ P</li>
<li><code>gp *g</code>ï¼šéœ€è¦å¤„ç†çš„ goroutine</li>
<li><code>next bool</code>ï¼štrue.ä¸‹æ¬¡è°ƒåº¦ä¼˜å…ˆè°ƒåº¦å½“å‰goroutine</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// runqput tries to put g on the local runnable queue.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If next is false, runqput adds g to the tail of the runnable queue.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If next is true, runqput puts g in the _p_.runnext slot.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If the run queue is full, runnext puts g on the global queue.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Executed only by the owner P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">runqput</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">next</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿™é‡Œæ˜¯ä¸ºäº†æµ‹è¯•ç”¨ä¾‹å¢åŠ éšæœºæ€§çš„ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// randomizeScheduleråœ¨æµ‹è¯•ä»£ç ä¸­è¿™é‡Œä¼šè®¾ç½®ä¸ºtrueï¼Œæ­£å¸¸æ˜¯false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">randomizeScheduler</span> <span class="o">&amp;&amp;</span> <span class="nx">next</span> <span class="o">&amp;&amp;</span> <span class="nf">fastrandn</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">next</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// next=trueï¼Œå°†gpæ·»åŠ åˆ°_p_.runnextä¸­ã€‚_p_.runnext å¦‚æœæ˜¯énilï¼Œæ˜¯ä¸€ä¸ªå¯è¿è¡Œçš„G
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœåœ¨è¿è¡Œ G çš„æ—¶é—´ç‰‡ä¸­æœ‰å‰©ä½™æ—¶é—´ï¼Œé‚£ä¹ˆåº”è¯¥è¿è¡Œä¸‹ä¸€ä¸ªè€Œä¸æ˜¯ runq ä¸­çš„å†…å®¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">next</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">retryNext</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">oldnext</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runnext</span>  <span class="c1">// åŸå­äº¤æ¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runnext</span><span class="p">.</span><span class="nf">cas</span><span class="p">(</span><span class="nx">oldnext</span><span class="p">,</span> <span class="nf">guintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">gp</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="nx">retryNext</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">oldnext</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Kick the old runnext out to the regular run queue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æŠŠæ—§çš„runnextè¸¢åˆ°å¸¸è§„çš„runé˜Ÿåˆ—ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">gp</span> <span class="p">=</span> <span class="nx">oldnext</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">retry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _p_çš„runqæ˜¯ä¸€ä¸ª256å¤§å°çš„å¾ªç¯æ•°ç»„ï¼ŒrunqheadæŒ‡å‘å¼€å§‹ï¼ŒrunqtailæŒ‡å‘å°¾éƒ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">h</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadAcq</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqhead</span><span class="p">)</span> <span class="c1">// load-acquire, synchronize with consumers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">t</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runqtail</span>   <span class="c1">// è¿™é‡Œä¹‹æ‰€ä»¥æ²¡æœ‰ä½¿ç”¨é”ï¼Œæ˜¯ç”±äºè¿™ä¸ªrunqtailåœ¨å…¶ä»–åœ°æ–¹ä¸ä¼šè¢«ä¿®æ”¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœt-hå°äºæ€»runqçš„å¤§å°ï¼Œè¯´æ˜è¿˜æ²¡æœ‰å­˜æ»¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">t</span><span class="o">-</span><span class="nx">h</span> <span class="p">&lt;</span> <span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è¿™é‡Œä½¿ç”¨t%uint32(len(_p_.runq))æ˜¯ç”±äºå¯èƒ½å‡ºç°h &gt; tçš„æƒ…å†µï¼Œé‚£ä¹ˆéœ€è¦å§‹ç»ˆæ”¾åœ¨tçš„åé¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">[</span><span class="nx">t</span><span class="o">%</span><span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">))].</span><span class="nf">set</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">atomic</span><span class="p">.</span><span class="nf">StoreRel</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqtail</span><span class="p">,</span> <span class="nx">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1">// store-release, makes the item available for consumption
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœæœ¬åœ°På·²ç»å­˜æ»¡ï¼Œé‚£ä¹ˆéœ€è¦å»å…¨å±€é‡Œé¢å­˜æ•°æ® 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">runqputslow</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// the queue is not full, now the put above must succeed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœä¸Šé¢éƒ½æ²¡æœ‰å­˜å‚¨æˆåŠŸï¼Œé‚£ä¹ˆè·³è½¬åˆ°retryæ ‡ç­¾ç»§ç»­å­˜å‚¨æ•°æ®ï¼Œç›´åˆ°æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">goto</span> <span class="nx">retry</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="runqputslow">runqputslow()<a hidden class="anchor" aria-hidden="true" href="#runqputslow">#</a></h4>
<ol>
<li>æŠŠ<code>gp</code>åŠ<code>_p_</code>ä¸­çš„ä¸€åŠçš„<code>G</code>å°è¯•åŠ å…¥å…¨å±€<code>G</code>ä¸­å»</li>
<li>å°†gå’Œä¸€æ‰¹æ¥è‡ªæœ¬åœ°å¯è¿è¡Œé˜Ÿåˆ—çš„å·¥ä½œæ”¾åˆ°å…¨å±€é˜Ÿåˆ—ä¸Šã€‚</li>
<li>ä»…ç”±æ‰€æœ‰è€…Pæ‰§è¡Œã€‚</li>
<li>å‚æ•°ï¼š
<ol>
<li><code>_p_ *p</code>ï¼šå½“å‰å·¥ä½œçº¿ç¨‹ç»‘å®šçš„P</li>
<li><code>gp *g</code>ï¼šå½“å‰éœ€è¦å¤„ç†çš„ goroutine</li>
<li><code>h, t uint32</code>ï¼š<code>_p_</code>çš„runqæ˜¯ä¸€ä¸ª256å¤§å°çš„å¾ªç¯æ•°ç»„ï¼ŒrunqheadæŒ‡å‘å¼€å§‹ï¼ŒrunqtailæŒ‡å‘å°¾éƒ¨</li>
</ol>
</li>
<li>è¿”å›å€¼ï¼š
<ol>
<li><code>bool</code>ï¼štrue.æ”¾å…¥æˆåŠŸï¼Œfalse.æ”¾å…¥å¤±è´¥</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Put g and a batch of work from local runnable queue on global queue.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Executed only by the owner P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">runqputslow</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">t</span> <span class="kt">uint32</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// é¦–å…ˆå®šä¹‰batchæ•°ç»„ï¼Œè¿™æ˜¯éœ€è¦å–å‡ºçš„Gæ”¾å…¥çš„æ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œçš„len(_p_.runq)/2 + 1æ˜¯æŠŠgpæ”¾å…¥è¿™ä¸ª+1è¿™é‡Œç®—åœ¨ä¸€èµ·çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">batch</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nx">g</span>   <span class="c1">// ä¸´æ—¶å®¹å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// First, grab a batch from local queue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é¦–å…ˆï¼Œä»æœ¬åœ°é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªæ‰¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">n</span> <span class="o">:=</span> <span class="nx">t</span> <span class="o">-</span> <span class="nx">h</span>
</span></span><span class="line"><span class="cl">    <span class="nx">n</span> <span class="p">=</span> <span class="nx">n</span> <span class="o">/</span> <span class="mi">2</span>   <span class="c1">// å–ä¸€åŠ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">n</span> <span class="o">!=</span> <span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runqputslow: queue is not full&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å–å‡ºä¸€åŠæ”¾å…¥å®¹å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">batch</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">[(</span><span class="nx">h</span><span class="o">+</span><span class="nx">i</span><span class="p">)</span><span class="o">%</span><span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">))].</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åŸå­äº¤æ¢headç´¢å¼•å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">CasRel</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqhead</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">h</span><span class="o">+</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// cas-release, commits consume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">batch</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="p">=</span> <span class="nx">gp</span>   <span class="c1">// gp æ”¾å…¥æœ€åä¸€ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿™é‡Œå¦‚æœå¼€å§‹èµ·äº†éšæœºæ€§ï¼Œé‚£ä¹ˆä¼šæŠŠbatché¡ºåºæ‰“ä¹±
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">randomizeScheduler</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">j</span> <span class="o">:=</span> <span class="nf">fastrandn</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1">// fastrand() % (i+1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">batch</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">batch</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">batch</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">batch</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Link the goroutines.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æŠŠbatchä¸­çš„æ‰€æœ‰Gå½¢æˆä¸€ä¸ªé“¾è¡¨é“¾æ¥èµ·æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">batch</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">schedlink</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">batch</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œheadå’Œtailåˆ†åˆ«è¡¨ç¤ºæ­£åºå’Œå€’å™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">q</span> <span class="nx">gQueue</span>
</span></span><span class="line"><span class="cl">    <span class="nx">q</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">batch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>    <span class="c1">// æŠŠbatch[0]æŒ‡å‘q.head
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">q</span><span class="p">.</span><span class="nx">tail</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">batch</span><span class="p">[</span><span class="nx">n</span><span class="p">])</span>    <span class="c1">// æŠŠbatch[n]æŒ‡å‘q.tail
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Now put the batch on global queue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç°åœ¨å°†batchæ”¾åˆ°å…¨å±€é˜Ÿåˆ—ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>       <span class="c1">// è·å– sched ä¸Šçš„ runtime.mutex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æŠŠè®¾ç½®å¥½çš„Gé“¾è¡¨é“¾æ¥æ‹¿åˆ°shced.runqä¸Šå»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">globrunqputbatch</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">q</span><span class="p">,</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>     <span class="c1">// è§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="globrunqputbatch">globrunqputbatch()<a hidden class="anchor" aria-hidden="true" href="#globrunqputbatch">#</a></h4>
<ol>
<li>æŠŠè®¾ç½®å¥½çš„<code>G</code>é“¾è¡¨é“¾æ¥æ‹¿åˆ°<code>shced.runq</code>ä¸Šå»</li>
<li>å°†ä¸€æ‰¹å¯è¿è¡Œçš„ goroutines æ”¾åˆ°å…¨å±€å¯è¿è¡Œé˜Ÿåˆ—ä¸­ã€‚æ¸…é™¤ *batchã€‚</li>
<li>sched.lock å¿…é¡»è¢«æŒæœ‰ã€‚.</li>
<li>å¯èƒ½åœ¨STWæœŸé—´è¿è¡Œï¼Œå› æ­¤ä¸å…è®¸å†™å…¥éšœç¢ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Put a batch of runnable goroutines on the global runnable queue.
</span></span></span><span class="line"><span class="cl"><span class="c1">// This clears *batch.
</span></span></span><span class="line"><span class="cl"><span class="c1">// sched.lock must be held.
</span></span></span><span class="line"><span class="cl"><span class="c1">// May run during STW, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">globrunqputbatch</span><span class="p">(</span><span class="nx">batch</span> <span class="o">*</span><span class="nx">gQueue</span><span class="p">,</span> <span class="nx">n</span> <span class="kt">int32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ¤æ–­ sched.lock é”æ˜¯å¦æŒæœ‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">assertLockHeld</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æŠŠè®¾ç½®å¥½çš„Gé“¾è¡¨é“¾æ¥åˆ°sched.runqä¸Šå»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sched</span><span class="p">.</span><span class="nx">runq</span><span class="p">.</span><span class="nf">pushBackAll</span><span class="p">(</span><span class="o">*</span><span class="nx">batch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sched</span><span class="p">.</span><span class="nx">runqsize</span> <span class="o">+=</span> <span class="nx">n</span> <span class="c1">// æŠŠå…¨å±€é“¾è¡¨æ€»æ•°é‡åŠ ä¸Šn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="nx">batch</span> <span class="p">=</span> <span class="nx">gQueue</span><span class="p">{}</span>   <span class="c1">// æ¸…ç©ºè¿™ä¸ªbatchï¼Œå‡è½»GCå‹åŠ›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="v-ok---c">v, ok := &lt;-c<a hidden class="anchor" aria-hidden="true" href="#v-ok---c">#</a></h2>
<ol>
<li>ç¼–è¯‘åæ˜¯é€šè¿‡è°ƒç”¨ chanrecv2 å‡½æ•°ã€‚</li>
<li>okï¼štrue.ç¡®å®ä»channelä¸­æ¥æ”¶çš„å€¼ï¼ˆä¸æ˜¯å› ä¸ºchannelå…³é—­è€Œå¾—åˆ°çš„é›¶å€¼ï¼‰ã€‚false.å› ä¸ºchannelå…³é—­è€Œè¿”å›çš„é›¶å€¼ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// é€šè¿‡ç¼–è¯‘åï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// if v, ok := &lt;-c; ok {
</span></span></span><span class="line"><span class="cl"><span class="c1">//      ... foo
</span></span></span><span class="line"><span class="cl"><span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// as 
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// if _, ok = chanrecv2(c, &amp;v); ok {
</span></span></span><span class="line"><span class="cl"><span class="c1">//      ... foo
</span></span></span><span class="line"><span class="cl"><span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">chanrecv2</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">,</span> <span class="nx">elem</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">(</span><span class="nx">received</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. (_, true)ï¼šæ•°æ®äº¤æ¢æˆåŠŸï¼Œå¾—åˆ°å¯¹åº”äº¤æ¢çš„æ•°æ®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2. (_, false)ï¼šå› closeå¯¼è‡´è·å–åˆ°äº†é›¶å€¼æ•°æ®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_</span><span class="p">,</span> <span class="nx">received</span> <span class="p">=</span> <span class="nf">chanrecv</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">elem</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="gopark">gopark()<a hidden class="anchor" aria-hidden="true" href="#gopark">#</a></h2>
<ol>
<li>å°†å½“å‰ä¾‹ç¨‹ç½®äºç­‰å¾…çŠ¶æ€å¹¶è°ƒç”¨ç³»ç»Ÿå †æ ˆä¸Šçš„ unlockã€‚</li>
<li>å¦‚æœ unlock è¿”å› falseï¼Œåˆ™ç»§ç»­æ‰§è¡Œè¯¥ goroutineã€‚</li>
<li>unlockf ä¸èƒ½è®¿é—®è¿™ä¸ª G çš„å †æ ˆï¼Œå› ä¸ºå®ƒå¯èƒ½åœ¨è°ƒç”¨ gopark å’Œè°ƒç”¨ unlockf ä¹‹é—´ç§»åŠ¨ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Puts the current goroutine into a waiting state and calls unlockf on the
</span></span></span><span class="line"><span class="cl"><span class="c1">// system stack.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// If unlockf returns false, the goroutine is resumed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// unlockf must not access this G&#39;s stack, as it may be moved between
</span></span></span><span class="line"><span class="cl"><span class="c1">// the call to gopark and the call to unlockf.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Note that because unlockf is called after putting the G into a waiting
</span></span></span><span class="line"><span class="cl"><span class="c1">// state, the G may have already been readied by the time unlockf is called
</span></span></span><span class="line"><span class="cl"><span class="c1">// unless there is external synchronization preventing the G from being
</span></span></span><span class="line"><span class="cl"><span class="c1">// readied. If unlockf returns false, it must guarantee that the G cannot be
</span></span></span><span class="line"><span class="cl"><span class="c1">// externally readied.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Reason explains why the goroutine has been parked. It is displayed in stack
</span></span></span><span class="line"><span class="cl"><span class="c1">// traces and heap dumps. Reasons should be unique and descriptive. Do not
</span></span></span><span class="line"><span class="cl"><span class="c1">// re-use reasons, add new ones.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">gopark</span><span class="p">(</span><span class="nx">unlockf</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">lock</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">reason</span> <span class="nx">waitReason</span><span class="p">,</span> <span class="nx">traceEv</span> <span class="kt">byte</span><span class="p">,</span> <span class="nx">traceskip</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// const waitReasonSleep = 19
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç­‰å¾…åŸå› ä¸æ˜¯å› ä¸ºsleepæ—¶ï¼ŒæŒ‰éœ€è°ƒç”¨checkTimeouts()ï¼Œæ£€æŸ¥timerã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">reason</span> <span class="o">!=</span> <span class="nx">waitReasonSleep</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// timeouts å¯èƒ½ä¼šåœ¨ä¸¤ä¸ªgoroutineä½¿è°ƒåº¦ç¨‹åºç¹å¿™æ—¶è¿‡æœŸã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ£€æŸ¥ p.timers åœ¨è°ƒåº¦å¾ªç¯æ—¶æˆ– goroutine è¢«è°ƒç¦»CPU æˆ– sysmon ç›‘æ§çº¿ç¨‹ä¸­éƒ½ä¼šè½®è¯¢æŸ¥çœ‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">checkTimeouts</span><span class="p">()</span> <span class="c1">// timeouts may expire while two goroutines keep the scheduler busy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">acquirem</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">curg</span> <span class="c1">// å½“å‰gp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">status</span> <span class="o">:=</span> <span class="nf">readgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span> <span class="c1">// è·å–çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">status</span> <span class="o">!=</span> <span class="nx">_Grunning</span> <span class="o">&amp;&amp;</span> <span class="nx">status</span> <span class="o">!=</span> <span class="nx">_Gscanrunning</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;gopark: bad g status&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">waitlock</span> <span class="p">=</span> <span class="nx">lock</span>      <span class="c1">// ç­‰å¾…çš„é”ï¼Œunlockfçš„ç¬¬äºŒä¸ªå‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mp</span><span class="p">.</span><span class="nx">waitunlockf</span> <span class="p">=</span> <span class="nx">unlockf</span><span class="c1">// è°ƒç¦»å‰éœ€è¦æ‰§è¡Œçš„é—­åŒ…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">waitreason</span> <span class="p">=</span> <span class="nx">reason</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">waittraceev</span> <span class="p">=</span> <span class="nx">traceEv</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">waittraceskip</span> <span class="p">=</span> <span class="nx">traceskip</span>
</span></span><span class="line"><span class="cl">    <span class="nf">releasem</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// can&#39;t do anything that might move the G between Ms here.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">mcall</span><span class="p">(</span><span class="nx">park_m</span><span class="p">)</span> <span class="c1">// mcallä¿å­˜ç°åœºå¹¶åˆ‡æ¢g0è°ƒç”¨park_må‡½æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="park_m">park_m()<a hidden class="anchor" aria-hidden="true" href="#park_m">#</a></h3>
<ol>
<li>è¯¥å‡½æ•°åœ¨<code>g0</code>ä¸Šã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// park continuation on g0.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">park_m</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">().</span><span class="nx">m</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceGoPark</span><span class="p">(</span><span class="nx">mp</span><span class="p">.</span><span class="nx">waittraceev</span><span class="p">,</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">waittraceskip</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// N.B. Not using casGToWaiting here because the waitreason is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// set by park_m&#39;s caller.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">,</span> <span class="nx">_Gwaiting</span><span class="p">)</span> <span class="c1">// åˆ‡æ¢gpçš„çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">dropg</span><span class="p">()</span> <span class="c1">// è§£é™¤mä¸gpçš„ç»‘å®š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">fn</span> <span class="o">:=</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">waitunlockf</span><span class="p">;</span> <span class="nx">fn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ok</span> <span class="o">:=</span> <span class="nf">fn</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">waitlock</span><span class="p">)</span> <span class="c1">// è°ƒç”¨waitunlockf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">mp</span><span class="p">.</span><span class="nx">waitunlockf</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mp</span><span class="p">.</span><span class="nx">waitlock</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è¿”å›falseæ—¶ï¼Œå†æ¬¡è¿è¡Œgp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">traceGoUnpark</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Gwaiting</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">execute</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="c1">// Schedule it back, never returns.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">schedule</span><span class="p">()</span> <span class="c1">// è°ƒåº¦å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="close">close()<a hidden class="anchor" aria-hidden="true" href="#close">#</a></h2>
<ol>
<li>å…³é—­ hchanã€‚</li>
<li>å‡ ç§å…³é—­ channel çš„æƒ…å†µï¼š
<ol>
<li>close å…³é—­æ—¶ï¼Œsendq ä¸Šæœ‰ç­‰å¾…çš„ goroutineï¼Œä¼š panicã€‚ã€&ldquo;panic: send on closed channel&rdquo;ã€‘ã€‚</li>
<li>close å…³é—­æ—¶ï¼Œå†æœ‰ send æ“ä½œï¼Œä¼š panicã€‚ã€&ldquo;panic: send on closed channel&rdquo;ã€‘ã€‚</li>
<li>close å…³é—­æ—¶ï¼Œbuf ä¸­æœ‰æ•°æ®ï¼Œä¸ä¼š panicï¼Œrecv å¯ä»¥è¯»å–å®ƒä»¬ã€‚</li>
</ol>
</li>
<li>å‘ nil çš„ channelï¼Œsend æˆ– recv æ—¶å½“å‰ goroutine ä¼španicã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">closechan</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) nil çš„ chan æ˜¯ä¸å…è®¸è¢« close çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">c</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">        <span class="nb">panic</span><span class="p">(</span><span class="nf">plainError</span><span class="p">(</span><span class="s">&#34;close of nil channel&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span> <span class="c1">// å°è¯•è·å– runtime.mutex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2) å·²ç»å…³é—­çš„ chan ä¸èƒ½å†æ¬¡å…³é—­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">closed</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">panic</span><span class="p">(</span><span class="nf">plainError</span><span class="p">(</span><span class="s">&#34;close of closed channel&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">callerpc</span> <span class="o">:=</span> <span class="nf">getcallerpc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nf">racewritepc</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nf">raceaddr</span><span class="p">(),</span> <span class="nx">callerpc</span><span class="p">,</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABIInternal</span><span class="p">(</span><span class="nx">closechan</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nf">racerelease</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nf">raceaddr</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3) è·å–åˆ°äº’æ–¥é”åé¦–å…ˆæ ‡è®°closedå­—æ®µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span><span class="p">.</span><span class="nx">closed</span> <span class="p">=</span> <span class="mi">1</span> <span class="c1">// æ ‡è®°chançŠ¶æ€ä¸ºå…³é—­ 0.æœªå…³é—­ 1.å·²å…³é—­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// gListæ˜¯ä¸€ä¸ªgoroutineçš„é“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰è¦å…³é—­çš„cè¿˜æœªå¤„ç†çš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">glist</span> <span class="nx">gList</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 4) å¤„ç† recvq ä¸Šçš„ goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// release all readers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœåŒä¸€ä¸ªgoroutineåœ¨å¤šä¸ªchannelä¸Šæ—¶ï¼ˆè¿™ç§æƒ…å†µå‘ç”Ÿåœ¨goselectæ—¶ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// dequeue() å‡½æ•°æœ‰ç›¸å…³çš„æ’é‡ï¼ŒCASæ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sg</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvq</span><span class="p">.</span><span class="nf">dequeue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">sg</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">elem</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">typedmemclr</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">elem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sg</span><span class="p">.</span><span class="nx">elem</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">releasetime</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sg</span><span class="p">.</span><span class="nx">releasetime</span> <span class="p">=</span> <span class="nf">cputicks</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">g</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä¸»è¦ç”¨ä¸ select è¯­å¥å”¤é†’åä½¿ç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">gp</span><span class="p">.</span><span class="nx">param</span> <span class="p">=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">sg</span><span class="p">)</span> <span class="c1">// g.param = *sudog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sg</span><span class="p">.</span><span class="nx">success</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">raceacquireg</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nf">raceaddr</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">glist</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 5) å¤„ç† sendq ä¸Šçš„ goroutineï¼Œè¿™äº›goroutineå¾—åˆ°è¿è¡Œåä¼š panicã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› ä¸ºä¸èƒ½å‘closeçš„channelæœ‰sendæ“ä½œï¼Œå…¶ä¸­ä¸€ç§æƒ…å†µä½“ç°åœ¨è¿™é‡Œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// release all writers (they will panic)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sg</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">sendq</span><span class="p">.</span><span class="nf">dequeue</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">sg</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sg</span><span class="p">.</span><span class="nx">elem</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">releasetime</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sg</span><span class="p">.</span><span class="nx">releasetime</span> <span class="p">=</span> <span class="nf">cputicks</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">g</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä¸»è¦ç”¨ä¸ select è¯­å¥å”¤é†’åä½¿ç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">gp</span><span class="p">.</span><span class="nx">param</span> <span class="p">=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">sg</span><span class="p">)</span> <span class="c1">// g.param = *sudog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sg</span><span class="p">.</span><span class="nx">success</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">raceacquireg</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nf">raceaddr</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">glist</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 6) å°†è¿™äº› goroutine æ”¾å›ç­‰å¾…é˜Ÿåˆ—ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ready all Gs now that we&#39;ve dropped the channel lock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">!</span><span class="nx">glist</span><span class="p">.</span><span class="nf">empty</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">glist</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span><span class="p">.</span><span class="nx">schedlink</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å°†gpæ”¾å…¥æœ¬åœ°Pçš„é˜Ÿåˆ—ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">goready</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="type-guintptr-uintptr">type guintptr uintptr<a hidden class="anchor" aria-hidden="true" href="#type-guintptr-uintptr">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// A guintptr holds a goroutine pointer, but typed as a uintptr
</span></span></span><span class="line"><span class="cl"><span class="c1">// to bypass write barriers. It is used in the Gobuf goroutine state
</span></span></span><span class="line"><span class="cl"><span class="c1">// and in scheduling lists that are manipulated without a P.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// The Gobuf.g goroutine pointer is almost always updated by assembly code.
</span></span></span><span class="line"><span class="cl"><span class="c1">// In one of the few places it is updated by Go code - func save - it must be
</span></span></span><span class="line"><span class="cl"><span class="c1">// treated as a uintptr to avoid a write barrier being emitted at a bad time.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Instead of figuring out how to emit the write barriers missing in the
</span></span></span><span class="line"><span class="cl"><span class="c1">// assembly manipulation, we change the type of the field to uintptr,
</span></span></span><span class="line"><span class="cl"><span class="c1">// so that it does not require write barriers at all.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Goroutine structs are published in the allg list and never freed.
</span></span></span><span class="line"><span class="cl"><span class="c1">// That will keep the goroutine structs from being collected.
</span></span></span><span class="line"><span class="cl"><span class="c1">// There is never a time that Gobuf.g&#39;s contain the only references
</span></span></span><span class="line"><span class="cl"><span class="c1">// to a goroutine: the publishing of the goroutine in allg comes first.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Goroutine pointers are also kept in non-GC-visible places like TLS,
</span></span></span><span class="line"><span class="cl"><span class="c1">// so I can&#39;t see them ever moving. If we did want to start moving data
</span></span></span><span class="line"><span class="cl"><span class="c1">// in the GC, we&#39;d need to allocate the goroutine structs from an
</span></span></span><span class="line"><span class="cl"><span class="c1">// alternate arena. Using guintptr doesn&#39;t make that problem any worse.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Note that pollDesc.rg, pollDesc.wg also store g in uintptr form,
</span></span></span><span class="line"><span class="cl"><span class="c1">// so they would need to be updated too if g&#39;s start moving.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">guintptr</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">gp</span> <span class="nx">guintptr</span><span class="p">)</span> <span class="nf">ptr</span><span class="p">()</span> <span class="o">*</span><span class="nx">g</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="nx">g</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">gp</span><span class="p">))</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">guintptr</span><span class="p">)</span> <span class="nf">set</span><span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span> <span class="o">*</span><span class="nx">gp</span> <span class="p">=</span> <span class="nf">guintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">g</span><span class="p">))</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">guintptr</span><span class="p">)</span> <span class="nf">cas</span><span class="p">(</span><span class="nx">old</span><span class="p">,</span> <span class="nx">new</span> <span class="nx">guintptr</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Casuintptr</span><span class="p">((</span><span class="o">*</span><span class="kt">uintptr</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">gp</span><span class="p">)),</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">old</span><span class="p">),</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">new</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="type-glist-struct">type gList struct<a hidden class="anchor" aria-hidden="true" href="#type-glist-struct">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// A gList is a list of Gs linked through g.schedlink. A G can only be
</span></span></span><span class="line"><span class="cl"><span class="c1">// on one gQueue or gList at a time.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">gList</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">head</span> <span class="nx">guintptr</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// empty reports whether l is empty.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">gList</span><span class="p">)</span> <span class="nf">empty</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">l</span><span class="p">.</span><span class="nx">head</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// push adds gp to the head of l.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">gList</span><span class="p">)</span> <span class="nf">push</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">schedlink</span> <span class="p">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">head</span>
</span></span><span class="line"><span class="cl">    <span class="nx">l</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// pushAll prepends all Gs in q to l.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">gList</span><span class="p">)</span> <span class="nf">pushAll</span><span class="p">(</span><span class="nx">q</span> <span class="nx">gQueue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">q</span><span class="p">.</span><span class="nf">empty</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">q</span><span class="p">.</span><span class="nx">tail</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">schedlink</span> <span class="p">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">head</span>
</span></span><span class="line"><span class="cl">        <span class="nx">l</span><span class="p">.</span><span class="nx">head</span> <span class="p">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">head</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// pop removes and returns the head of l. If l is empty, it returns nil.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">l</span> <span class="o">*</span><span class="nx">gList</span><span class="p">)</span> <span class="nf">pop</span><span class="p">()</span> <span class="o">*</span><span class="nx">g</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">gp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">l</span><span class="p">.</span><span class="nx">head</span> <span class="p">=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">schedlink</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">gp</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="len">len()<a hidden class="anchor" aria-hidden="true" href="#len">#</a></h2>
<ol>
<li>è·å– chan çš„å…ƒç´ ä¸ªæ•°ã€‚ï¼ˆè·å–çš„æ˜¯ç¼“å­˜åŒºçš„ä¸ªæ•°ï¼Œæ²¡æœ‰æŒ‚åœ¨é“¾è¡¨ä¸­çš„æ•°é‡ï¼‰</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:linkname reflect_chanlen reflect.chanlen
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">reflect_chanlen</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">c</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">qcount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:linkname reflectlite_chanlen internal/reflectlite.chanlen
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">reflectlite_chanlen</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">c</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">qcount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="cap">cap()<a hidden class="anchor" aria-hidden="true" href="#cap">#</a></h2>
<ol>
<li>è¿”å›å€¼å’Œ<code>len()</code>å‡½æ•°ä¸€è‡´ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:linkname reflect_chancap reflect.chancap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">reflect_chancap</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">c</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">dataqsiz</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="select-default">select default<a hidden class="anchor" aria-hidden="true" href="#select-default">#</a></h2>
<ol>
<li>ä»¥ä¸‹æ˜¯å­˜åœ¨ default é»˜è®¤åˆ†æ”¯æƒ…å†µã€‚æ„æ€ç±»ä¼¼äº tryLock å‡½æ•°ï¼Œå°è¯•ä¸€æ¬¡ã€‚</li>
<li>ä»¥ä¸‹åªæ˜¯ç‰¹ä¾‹ï¼Œç¼–è¯‘å™¨ä¸é‡‡ç”¨ goselect() å‡½æ•°æ—¶ã€‚éƒ½æ˜¯ select {case: default:} è¿™ç§å½¢å¼ã€‚</li>
</ol>
<h3 id="select-ä¸­-c---v">select ä¸­ c &lt;- v<a hidden class="anchor" aria-hidden="true" href="#select-ä¸­-c---v">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// compiler implements
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//	select {
</span></span></span><span class="line"><span class="cl"><span class="c1">//	case c &lt;- v:
</span></span></span><span class="line"><span class="cl"><span class="c1">//		... foo
</span></span></span><span class="line"><span class="cl"><span class="c1">//	default:
</span></span></span><span class="line"><span class="cl"><span class="c1">//		... bar
</span></span></span><span class="line"><span class="cl"><span class="c1">//	}
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// as
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//	if selectnbsend(c, v) {
</span></span></span><span class="line"><span class="cl"><span class="c1">//		... foo
</span></span></span><span class="line"><span class="cl"><span class="c1">//	} else {
</span></span></span><span class="line"><span class="cl"><span class="c1">//		... bar
</span></span></span><span class="line"><span class="cl"><span class="c1">//	}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">selectnbsend</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">,</span> <span class="nx">elem</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">(</span><span class="nx">selected</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// true. æ•°æ®sendå®Œæˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// false. è¡¨ç¤ºç›®å‰ä¸èƒ½å‘é€ï¼Œå› ä¸ºä¸æƒ³é˜»å¡(blockä¸ºfalse)è€Œè¿”å›ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// falseåªåœ¨è¿™é‡Œè¢«ä¼ å…¥ä½¿ç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nf">chansend</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">elem</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nf">getcallerpc</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>éªŒè¯ä¸Šé¢ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">chanTs</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">a</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">a</span> <span class="p">=</span> <span class="nx">b</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">b</span> <span class="p">=</span> <span class="nx">a</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.chanTs</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="no">G</span><span class="p">:</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">hello</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">chanTs</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490ae0</span>              <span class="mi">493</span><span class="no">b6610</span>                <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490ae4</span>              <span class="mi">0</span><span class="no">f8685000000</span>            <span class="no">JBE</span> <span class="mi">0x490b6f</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490aea</span>              <span class="mi">4883</span><span class="no">ec40</span>                <span class="no">SUBQ</span> <span class="no">$0x40</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490aee</span>              <span class="mi">48896</span><span class="no">c2438</span>              <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490af3</span>              <span class="mi">488</span><span class="no">d6c2438</span>              <span class="no">LEAQ</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">        <span class="nf">ch</span> <span class="p">:</span><span class="err">=</span> <span class="no">make</span><span class="p">(</span><span class="no">chan</span> <span class="no">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490af8</span>              <span class="mi">488</span><span class="no">d05419b0000</span>          <span class="no">LEAQ</span> <span class="no">runtime.rodata</span><span class="err">+</span><span class="mi">30272</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490aff</span>              <span class="mi">31</span><span class="no">db</span>                    <span class="no">XORL</span> <span class="no">BX</span><span class="p">,</span> <span class="no">BX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b01</span>              <span class="no">e8da3cf7ff</span>              <span class="no">CALL</span> <span class="no">runtime.makechan</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b06</span>              <span class="mi">4889442428</span>              <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">a</span><span class="p">,</span> <span class="no">b</span> <span class="p">:</span><span class="err">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b0b</span>              <span class="mi">48</span><span class="no">c744241801000000</span>      <span class="no">MOVQ</span> <span class="no">$0x1</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b14</span>              <span class="mi">48</span><span class="no">c744241002000000</span>      <span class="no">MOVQ</span> <span class="no">$0x2</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">case</span> <span class="no">ch</span> <span class="err">&lt;</span><span class="p">-</span> <span class="no">a</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b1d</span>              <span class="mi">488</span><span class="no">b4c2428</span>              <span class="no">MOVQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b22</span>              <span class="mi">48894</span><span class="no">c2430</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b27</span>              <span class="mi">488</span><span class="no">b4c2418</span>              <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b2c</span>              <span class="mi">48894</span><span class="no">c2420</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b31</span>              <span class="mi">488</span><span class="no">b442430</span>              <span class="no">MOVQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>   <span class="c1"># å‚æ•° c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x490b36</span>              <span class="mi">488</span><span class="no">d5c2420</span>              <span class="no">LEAQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BX</span>   <span class="c1"># å‚æ•° elem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x490b3b</span>              <span class="mi">0</span><span class="no">f1f440000</span>              <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)(</span><span class="no">AX</span><span class="p">*</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b40</span>              <span class="no">e89b55f7ff</span>              <span class="no">CALL</span> <span class="no">runtime.selectnbsend</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="c1"># è°ƒç”¨selectnbsend
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x490b45</span>              <span class="mi">84</span><span class="no">c0</span>                    <span class="no">TESTL</span> <span class="no">AL</span><span class="p">,</span> <span class="no">AL</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b47</span>              <span class="mi">7502</span>                    <span class="no">JNE</span> <span class="mi">0x490b4b</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b49</span>              <span class="no">eb0c</span>                    <span class="no">JMP</span> <span class="mi">0x490b57</span>
</span></span><span class="line"><span class="cl">                <span class="nf">a</span> <span class="err">=</span> <span class="no">b</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b4b</span>              <span class="mi">488</span><span class="no">b442410</span>              <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b50</span>              <span class="mi">4889442418</span>              <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b55</span>              <span class="no">eb0c</span>                    <span class="no">JMP</span> <span class="mi">0x490b63</span>
</span></span><span class="line"><span class="cl">                <span class="nf">b</span> <span class="err">=</span> <span class="no">a</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b57</span>              <span class="mi">488</span><span class="no">b442418</span>              <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b5c</span>              <span class="mi">4889442410</span>              <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b61</span>              <span class="no">eb00</span>                    <span class="no">JMP</span> <span class="mi">0x490b63</span>
</span></span><span class="line"><span class="cl">        <span class="nf">case</span> <span class="no">ch</span> <span class="err">&lt;</span><span class="p">-</span> <span class="no">a</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b63</span>              <span class="no">eb00</span>                    <span class="no">JMP</span> <span class="mi">0x490b65</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b65</span>              <span class="mi">488</span><span class="no">b6c2438</span>              <span class="no">MOVQ</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b6a</span>              <span class="mi">4883</span><span class="no">c440</span>                <span class="no">ADDQ</span> <span class="no">$0x40</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b6e</span>              <span class="no">c3</span>                      <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">chanTs</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b6f</span>              <span class="no">e8ecb4fcff</span>              <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b74</span>              <span class="no">e967ffffff</span>              <span class="no">JMP</span> <span class="no">main.chanTs</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b79</span>              <span class="no">cc</span>                      <span class="no">INT</span> <span class="no">$0x3</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b7a</span>              <span class="no">cc</span>                      <span class="no">INT</span> <span class="no">$0x3</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b7b</span>              <span class="no">cc</span>                      <span class="no">INT</span> <span class="no">$0x3</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b7c</span>              <span class="no">cc</span>                      <span class="no">INT</span> <span class="no">$0x3</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b7d</span>              <span class="no">cc</span>                      <span class="no">INT</span> <span class="no">$0x3</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b7e</span>              <span class="no">cc</span>                      <span class="no">INT</span> <span class="no">$0x3</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b7f</span>              <span class="no">cc</span>                      <span class="no">INT</span> <span class="no">$0x3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="select-ä¸­-v---c">select ä¸­ v &lt;- c<a hidden class="anchor" aria-hidden="true" href="#select-ä¸­-v---c">#</a></h3>
<ol>
<li>åœ¨ <code>go1.18</code>ç‰ˆæœ¬å‰ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// compiler implements
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//  select {
</span></span></span><span class="line"><span class="cl"><span class="c1">//  case v = &lt;-c:
</span></span></span><span class="line"><span class="cl"><span class="c1">//      ... foo
</span></span></span><span class="line"><span class="cl"><span class="c1">//  default:
</span></span></span><span class="line"><span class="cl"><span class="c1">//      ... bar
</span></span></span><span class="line"><span class="cl"><span class="c1">//  }
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// as
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//  if selectnbrecv(&amp;v, c) {
</span></span></span><span class="line"><span class="cl"><span class="c1">//      ... foo
</span></span></span><span class="line"><span class="cl"><span class="c1">//  } else {
</span></span></span><span class="line"><span class="cl"><span class="c1">//      ... bar
</span></span></span><span class="line"><span class="cl"><span class="c1">//  }
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">selectnbrecv</span><span class="p">(</span><span class="nx">elem</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">)</span> <span class="p">(</span><span class="nx">selected</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// selectedï¼šè¡¨ç¤ºå½“å‰åˆ†æ”¯æ˜¯å¦é€‰ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">selected</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nf">chanrecv</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">elem</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="select-ä¸­-v-ok----c">select ä¸­ v, ok = &lt;- c<a hidden class="anchor" aria-hidden="true" href="#select-ä¸­-v-ok----c">#</a></h3>
<ol>
<li>åœ¨ <code>go1.18</code>ç‰ˆæœ¬å‰ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// compiler implements
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//  select {
</span></span></span><span class="line"><span class="cl"><span class="c1">//  case v, ok = &lt;-c:
</span></span></span><span class="line"><span class="cl"><span class="c1">//      ... foo
</span></span></span><span class="line"><span class="cl"><span class="c1">//  default:
</span></span></span><span class="line"><span class="cl"><span class="c1">//      ... bar
</span></span></span><span class="line"><span class="cl"><span class="c1">//  }
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// as
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//  if c != nil &amp;&amp; selectnbrecv2(&amp;v, &amp;ok, c) {
</span></span></span><span class="line"><span class="cl"><span class="c1">//      ... foo
</span></span></span><span class="line"><span class="cl"><span class="c1">//  } else {
</span></span></span><span class="line"><span class="cl"><span class="c1">//      ... bar
</span></span></span><span class="line"><span class="cl"><span class="c1">//  }
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">selectnbrecv2</span><span class="p">(</span><span class="nx">elem</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">received</span> <span class="o">*</span><span class="kt">bool</span><span class="p">,</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">)</span> <span class="p">(</span><span class="nx">selected</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO(khr): just return 2 values from this function, now that it is in Go.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// selectedï¼šè¡¨ç¤ºå½“å‰åˆ†æ”¯æ˜¯å¦é€‰ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// receivedï¼šè¡¨ç¤ºå½“å‰æ˜¯å¦å› ä¸º close è€Œå…³é—­çš„é›¶å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">selected</span><span class="p">,</span> <span class="o">*</span><span class="nx">received</span> <span class="p">=</span> <span class="nf">chanrecv</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">elem</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="å…¶ä»–ç‰ˆæœ¬">å…¶ä»–ç‰ˆæœ¬<a hidden class="anchor" aria-hidden="true" href="#å…¶ä»–ç‰ˆæœ¬">#</a></h4>
<ol>
<li>åœ¨go1.19.3ä¸­ï¼Œ&lt;-c æœ‰æ‰€æ”¹å˜ä½†æ˜¯åŸç†éƒ½ä¸€æ ·ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// compiler implements
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//  select {
</span></span></span><span class="line"><span class="cl"><span class="c1">//  case v, ok = &lt;-c:
</span></span></span><span class="line"><span class="cl"><span class="c1">//      ... foo
</span></span></span><span class="line"><span class="cl"><span class="c1">//  default:
</span></span></span><span class="line"><span class="cl"><span class="c1">//      ... bar
</span></span></span><span class="line"><span class="cl"><span class="c1">//  }
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// as
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//  if selected, ok = selectnbrecv(&amp;v, c); selected {
</span></span></span><span class="line"><span class="cl"><span class="c1">//      ... foo
</span></span></span><span class="line"><span class="cl"><span class="c1">//  } else {
</span></span></span><span class="line"><span class="cl"><span class="c1">//      ... bar
</span></span></span><span class="line"><span class="cl"><span class="c1">//  }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">selectnbrecv</span><span class="p">(</span><span class="nx">elem</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span><span class="p">)</span> <span class="p">(</span><span class="nx">selected</span><span class="p">,</span> <span class="nx">received</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// selectedï¼šè¡¨ç¤ºå½“å‰åˆ†æ”¯æ˜¯å¦é€‰ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// receivedï¼šè¡¨ç¤ºå½“å‰æ˜¯å¦å› ä¸º close è€Œå…³é—­çš„é›¶å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nf">chanrecv</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">elem</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//  select {
</span></span></span><span class="line"><span class="cl"><span class="c1">//  case v = &lt;-c:
</span></span></span><span class="line"><span class="cl"><span class="c1">//      ... foo
</span></span></span><span class="line"><span class="cl"><span class="c1">//  default:
</span></span></span><span class="line"><span class="cl"><span class="c1">//      ... bar
</span></span></span><span class="line"><span class="cl"><span class="c1">//  }
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// as 
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//  if selected, _ = selectnbrecv(&amp;v, c); selected {
</span></span></span><span class="line"><span class="cl"><span class="c1">//      ... foo
</span></span></span><span class="line"><span class="cl"><span class="c1">//  } else {
</span></span></span><span class="line"><span class="cl"><span class="c1">//      ... bar
</span></span></span><span class="line"><span class="cl"><span class="c1">//  }
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>éªŒè¯ä¸Šé¢ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">chanTs</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">ok</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">ok</span> <span class="p">=</span> <span class="o">&lt;-</span><span class="nx">ch</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">b</span> <span class="p">=</span> <span class="nx">a</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">b</span> <span class="p">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">a</span> <span class="p">=</span> <span class="nx">b</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.chanTs</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="no">G</span><span class="p">:</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">hello</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">chanTs</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490ae0</span>              <span class="mi">493</span><span class="no">b6610</span>                <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490ae4</span>              <span class="mi">0</span><span class="no">f86aa000000</span>            <span class="no">JBE</span> <span class="mi">0x490b94</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490aea</span>              <span class="mi">4883</span><span class="no">ec48</span>                <span class="no">SUBQ</span> <span class="no">$0x48</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490aee</span>              <span class="mi">48896</span><span class="no">c2440</span>              <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x40</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490af3</span>              <span class="mi">488</span><span class="no">d6c2440</span>              <span class="no">LEAQ</span> <span class="mi">0x40</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">        <span class="nf">ch</span> <span class="p">:</span><span class="err">=</span> <span class="no">make</span><span class="p">(</span><span class="no">chan</span> <span class="no">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490af8</span>              <span class="mi">488</span><span class="no">d05419b0000</span>          <span class="no">LEAQ</span> <span class="no">runtime.rodata</span><span class="err">+</span><span class="mi">30272</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490aff</span>              <span class="mi">31</span><span class="no">db</span>                    <span class="no">XORL</span> <span class="no">BX</span><span class="p">,</span> <span class="no">BX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b01</span>              <span class="no">e8da3cf7ff</span>              <span class="no">CALL</span> <span class="no">runtime.makechan</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b06</span>              <span class="mi">4889442430</span>              <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">a</span><span class="p">,</span> <span class="no">b</span> <span class="p">:</span><span class="err">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b0b</span>              <span class="mi">48</span><span class="no">c744242001000000</span>      <span class="no">MOVQ</span> <span class="no">$0x1</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b14</span>              <span class="mi">48</span><span class="no">c744241802000000</span>      <span class="no">MOVQ</span> <span class="no">$0x2</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">var</span> <span class="no">ok</span> <span class="no">bool</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b1d</span>              <span class="no">c644241500</span>              <span class="no">MOVB</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x15</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">case</span> <span class="no">a</span><span class="p">,</span> <span class="no">ok</span> <span class="err">=</span> <span class="err">&lt;</span><span class="p">-</span><span class="no">ch</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b22</span>              <span class="mi">488</span><span class="no">b5c2430</span>              <span class="no">MOVQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b27</span>              <span class="mi">48895</span><span class="no">c2438</span>              <span class="no">MOVQ</span> <span class="no">BX</span><span class="p">,</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b2c</span>              <span class="mi">488</span><span class="no">d442428</span>              <span class="no">LEAQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b31</span>              <span class="no">e8aa55f7ff</span>              <span class="no">CALL</span> <span class="no">runtime.selectnbrecv</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="c1"># selectnbrecv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x490b36</span>              <span class="mi">88442416</span>                <span class="no">MOVB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0x16</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b3a</span>              <span class="mi">885</span><span class="no">c2417</span>                <span class="no">MOVB</span> <span class="no">BL</span><span class="p">,</span> <span class="mi">0x17</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b3e</span>              <span class="mi">807</span><span class="no">c241600</span>              <span class="no">CMPB</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x16</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nf">if</span> <span class="no">ok</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b64</span>              <span class="mi">807</span><span class="no">c241500</span>              <span class="no">CMPB</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x15</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b69</span>              <span class="mi">7502</span>                    <span class="no">JNE</span> <span class="mi">0x490b6d</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b6b</span>              <span class="no">eb0b</span>                    <span class="no">JMP</span> <span class="mi">0x490b78</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">b</span> <span class="err">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b6d</span>              <span class="mi">48</span><span class="no">c744241864000000</span>      <span class="no">MOVQ</span> <span class="no">$0x64</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b76</span>              <span class="no">eb02</span>                    <span class="no">JMP</span> <span class="mi">0x490b7a</span>
</span></span><span class="line"><span class="cl">                <span class="nf">if</span> <span class="no">ok</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b78</span>              <span class="no">eb00</span>                    <span class="no">JMP</span> <span class="mi">0x490b7a</span>
</span></span><span class="line"><span class="cl">        <span class="nf">case</span> <span class="no">a</span><span class="p">,</span> <span class="no">ok</span> <span class="err">=</span> <span class="err">&lt;</span><span class="p">-</span><span class="no">ch</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b7a</span>              <span class="no">eb0c</span>                    <span class="no">JMP</span> <span class="mi">0x490b88</span>
</span></span><span class="line"><span class="cl">                <span class="nf">a</span> <span class="err">=</span> <span class="no">b</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b7c</span>              <span class="mi">488</span><span class="no">b442418</span>              <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b81</span>              <span class="mi">4889442420</span>              <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b86</span>              <span class="no">eb00</span>                    <span class="no">JMP</span> <span class="mi">0x490b88</span>
</span></span><span class="line"><span class="cl">        <span class="nf">case</span> <span class="no">a</span><span class="p">,</span> <span class="no">ok</span> <span class="err">=</span> <span class="err">&lt;</span><span class="p">-</span><span class="no">ch</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b88</span>              <span class="no">eb00</span>                    <span class="no">JMP</span> <span class="mi">0x490b8a</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b8a</span>              <span class="mi">488</span><span class="no">b6c2440</span>              <span class="no">MOVQ</span> <span class="mi">0x40</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b8f</span>              <span class="mi">4883</span><span class="no">c448</span>                <span class="no">ADDQ</span> <span class="no">$0x48</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b93</span>              <span class="no">c3</span>                      <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">chanTs</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b94</span>              <span class="no">e8c7b4fcff</span>              <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b99</span>              <span class="no">e942ffffff</span>              <span class="no">JMP</span> <span class="no">main.chanTs</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b9e</span>              <span class="no">cc</span>                      <span class="no">INT</span> <span class="no">$0x3</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x490b9f</span>              <span class="no">cc</span>                      <span class="no">INT</span> <span class="no">$0x3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="for-range">for range<a hidden class="anchor" aria-hidden="true" href="#for-range">#</a></h2>
<ol>
<li>å‚è€ƒ <a href="/posts/golang/process/range/#%e8%bf%ad%e4%bb%a3channel">æµç¨‹æ§åˆ¶(rangeè¿­ä»£)</a>ã€‚</li>
</ol>
<h2 id="æ€»ç»“">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“">#</a></h2>
<ol>
<li>å‘(æ²¡åœ¨selectå—ä¸­) nil çš„ channel ä¸­ sendã€recv ä¼š panicã€‚åœ¨selectå—ä¸­ nil çš„ channel ä¼šè¢«ä¸¢å¼ƒã€‚</li>
<li>send æ€»æ˜¯å…ˆåˆ¤æ–­çš„ closeï¼ˆpanicï¼‰ï¼Œå†åˆ¤æ–­çš„æ•°æ®èƒ½å¦äº¤æ¢(selectä¸­çš„ä¹Ÿä¸€æ ·)ã€‚recv ä¹Ÿæ˜¯å…ˆåˆ¤æ–­ close ä½†æ˜¯ä¸ä¼španicï¼Œå†åˆ¤æ–­ buf æœ‰æ²¡æ•°æ®ï¼Œæœ‰åˆ™å–å‡ºï¼Œä¸ä¼šå» sendq ä¸­æŸ¥çœ‹æŒ‚èµ·çš„ sudogã€‚</li>
<li>nil çš„ channel ä¸å…è®¸ close æ“ä½œï¼Œä¼š panicã€‚close å·²ç» close çš„ channel ä¼š panicã€‚</li>
</ol>
<h2 id="å‚è€ƒ">å‚è€ƒ<a hidden class="anchor" aria-hidden="true" href="#å‚è€ƒ">#</a></h2>
<ol>
<li><a href="https://mp.weixin.qq.com/s/6ZEGtXRGKm2qP5b-rGLyVg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/6ZEGtXRGKm2qP5b-rGLyVg</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=Mzg5NjIwNzIxNQ==&amp;mid=2247484471&amp;idx=2&amp;sn=49af599b9c3796857459a14d040586fd&amp;scene=19#wechat_redirect" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=Mzg5NjIwNzIxNQ==&mid=2247484471&idx=2&sn=49af599b9c3796857459a14d040586fd&scene=19#wechat_redirect</a></li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://helium-chain.github.io/tags/golang/">Golang</a></li>
      <li><a href="https://helium-chain.github.io/tags/channel/">Channel</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://helium-chain.github.io/posts/golang/channel/use/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Channel(ä½¿ç”¨)</span>
  </a>
  <a class="next" href="https://helium-chain.github.io/posts/golang/channel/select/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>select(åŸç†)</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
    </span>
    <span id="busuanzi_container_site_uv">
        æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
    </span>
    </div>
        <span>Copyright Â© 2024 èœ€ICPå¤‡2024091074å· <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
