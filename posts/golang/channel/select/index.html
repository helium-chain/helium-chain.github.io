<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>select(åŸç†) | Helium</title>
<meta name="keywords" content="golang, Channel">
<meta name="description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬">
<meta name="author" content="helium">
<link rel="canonical" href="https://helium.github.io/posts/golang/channel/select/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://helium.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://helium.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://helium.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://helium.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://helium.github.io/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://helium.github.io/posts/golang/channel/select/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="select(åŸç†)" />
<meta property="og:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://helium.github.io/posts/golang/channel/select/" />
<meta property="og:image" content="https://helium.github.io/favicon-32x32.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-08-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-08-01T00:00:00+00:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://helium.github.io/favicon-32x32.png" />
<meta name="twitter:title" content="select(åŸç†)"/>
<meta name="twitter:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://helium.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Golang",
      "item": "https://helium.github.io/posts/golang/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ç¬¬13ç«  Channel",
      "item": "https://helium.github.io/posts/golang/channel/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "select(åŸç†)",
      "item": "https://helium.github.io/posts/golang/channel/select/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "select(åŸç†)",
  "name": "select(åŸç†)",
  "description": "ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18+ç‰ˆæœ¬",
  "keywords": [
    "golang", "Channel"
  ],
  "articleBody": " æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/select.goã€‚ select çš„ä½¿ç”¨æ–‡æ¡£å‚è€ƒ select(ä½¿ç”¨)ã€‚ Constants const debugSelect = false // è°ƒè¯•æ¨¡å¼ Variables 1 2 3 4 5 var ( // å‡½æ•°chansendçš„PCå…¥å£ chansendpc = abi.FuncPCABIInternal(chansend) chanrecvpc = abi.FuncPCABIInternal(chanrecv) ) type scase struct Select case æè¿°ç¬¦ã€‚ç¼–è¯‘å™¨å·²çŸ¥ã€‚ è¿™é‡Œä¿®æ”¹å¿…é¡»å» src/cmd/compile/internal/walk/select.goâ€™s scasetypeã€‚ scase ç»“æ„æ˜¯ä¸€ä¸ª case çš„ channel ç»“æ„ã€‚ 1 2 3 4 5 6 7 // Select case descriptor. // Known to compiler. // Changes here must also be made in src/cmd/compile/internal/walk/select.go's scasetype. type scase struct { c *hchan // chan elem unsafe.Pointer // data element } selectå…³é”®å­— selectgo å®ç°äº† select è¯­å¥ã€‚ cas0 æŒ‡å‘ç±»å‹ä¸º [ncases]scase çš„æ•°ç»„ï¼Œorder0 æŒ‡å‘ç±»å‹ä¸º [2*ncases]uint16 çš„æ•°ç»„ï¼Œå…¶ä¸­ ncases å¿…é¡» \u003c= 65536ã€‚ ä¸¤è€…éƒ½å­˜åœ¨äº goroutine çš„æ ˆä¸­ï¼ˆä¸ç®¡ selectgo ä¸­çš„ä»»ä½•è½¬ä¹‰ï¼‰ã€‚ å¯¹äº race çš„æ„å»ºï¼Œpc0 æŒ‡å‘ä¸€ä¸ªç±»å‹ä¸º [ncases]uintptr çš„æ•°ç»„ï¼ˆä¹Ÿåœ¨è¿™ä¸ªæ ˆä¸Šï¼‰ï¼›å¯¹äºå…¶ä»–æ„å»ºï¼Œå®ƒè¢«è®¾ç½®ä¸ºnilã€‚ selectgo è¿”å›æ‰€é€‰åˆ†æ”¯çš„ç´¢å¼•ï¼Œå®ƒä¸å„è‡ªçš„ select{recv,send,default} è°ƒç”¨çš„é¡ºåºä½ç½®åŒ¹é…ã€‚ æ­¤å¤–ï¼Œå¦‚æœé€‰æ‹©çš„ scase æ˜¯ä¸€ä¸ª receive æ¥æ”¶ç±»å‹æ“ä½œï¼Œå®ƒä¼šæŠ¥å‘Šæ˜¯å¦æ”¶åˆ°äº†å€¼ã€‚ å‚æ•°ï¼š cas0 *scaseï¼šæŒ‡å‘ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„é‡Œè£…çš„æ˜¯selectä¸­æ‰€æœ‰çš„caseåˆ†æ”¯ï¼ŒæŒ‰ç…§sendåœ¨å‰recvåœ¨åçš„é¡ºåºã€‚ä¸åŒ…å«defaultåˆ†æ”¯ã€‚ order0 *uint16ï¼šæŒ‡å‘ä¸€ä¸ªå¤§å°ç­‰äºcaseåˆ†æ”¯æ•°é‡ä¸¤å€çš„uint16æ•°ç»„(2*(nsends+nrecvs))ï¼Œå®é™…ä¸Šæ˜¯ä½œä¸ºä¸¤ä¸ªå¤§å°ç›¸ç­‰çš„æ•°ç»„æ¥ç”¨çš„ã€‚å‰ä¸€ä¸ªç”¨æ¥å¯¹æ‰€æœ‰caseä¸­channelçš„è½®è¯¢è¿›è¡Œä¹±åºï¼Œåä¸€ä¸ªç”¨æ¥å¯¹æ‰€æœ‰caseä¸­channelçš„åŠ é”æ“ä½œè¿›è¡Œæ’åºã€‚ pc0 *uintptrï¼šrace ç›¸å…³ã€‚ nsends intï¼šsend æ“ä½œçš„åˆ†æ”¯æ•°é‡ã€‚ nrecvs intï¼šrecv æ“ä½œçš„åˆ†æ”¯æ•°é‡ã€‚ block boolï¼šè¡¨ç¤ºæ˜¯å¦æƒ³è¦é˜»å¡ç­‰å¾…ã€‚æœ‰defaultåˆ†æ”¯çš„ä¸é˜»å¡ï¼Œåä¹‹åˆ™ä¼šé˜»å¡ã€‚ è¿”å›å€¼ï¼š intï¼šè¡¨ç¤ºæœ€ç»ˆå“ªä¸ªcaseåˆ†æ”¯è¢«æ‰§è¡Œäº†ï¼Œå¯¹åº”case0æ•°ç»„çš„ä¸‹æ ‡ã€‚å¦‚æœå› ä¸ºä¸æƒ³é˜»å¡è€Œè¿”å›ï¼Œåˆ™è¿™ä¸ªå€¼ä¸º-1ã€‚ boolï¼šè¡¨ç¤ºåœ¨å¯¹åº”çš„caseåˆ†æ”¯æ‰§è¡Œçš„æ˜¯recvæ“ä½œæ—¶ï¼Œç”¨æ¥è¡¨ç¤ºå®é™…æ¥æ”¶åˆ°ä¸€ä¸ªå€¼ï¼Œè€Œä¸æ˜¯å› ä¸ºé€šé“å…³é—­å¾—åˆ°çš„é›¶å€¼ã€‚ selectgo() å‡½æ•°æµç¨‹ï¼š å…ˆéšæœºæ‰“ä¹±cas0é›†ç”¨äºè½®è¯¢éå†ã€‚åœ¨æŒ‰ç…§channelåœ°å€å‡åºæ’åºç”¨äºå…¨éƒ¨çš„channelåŠ é”å’Œè§£é”ã€‚ all channel lockåéå†æ‰“ä¹±çš„caseé›†æ£€æŸ¥æ˜¯å¦èƒ½ç«‹å³å®Œæˆï¼Œå¦‚æœå¯ä»¥åˆ™äº¤æ¢æ•°æ®åå…¨éƒ¨è§£é”ã€‚å¦åˆ™åˆ¤æ–­blockæ˜¯å¦éœ€è¦é˜»å¡ã€‚ å…¨éƒ¨éœ€è¦é˜»å¡æ—¶ï¼Œå°†å½“å‰goroutineå°è£…æˆsudogå½¢æˆä¸€ä¸ªé“¾è¡¨æŒ‚åœ¨æ‰€æœ‰çš„channelä¸Šå»ç­‰å¾…ã€‚ å½“å†æ¬¡è§¦å‘æ—¶ï¼Œå…ˆè·å–æ¸…all channel lockï¼Œé™¤æŒ‚åœ¨è¿™äº›ä¸Šé¢çš„sudogï¼Œè§£é”åè¿”å›ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 // selectgo implements the select statement. // // cas0 points to an array of type [ncases]scase, and order0 points to // an array of type [2*ncases]uint16 where ncases must be \u003c= 65536. // Both reside on the goroutine's stack (regardless of any escaping in // selectgo). // // For race detector builds, pc0 points to an array of type // [ncases]uintptr (also on the stack); for other builds, it's set to // nil. // // selectgo returns the index of the chosen scase, which matches the // ordinal position of its respective select{recv,send,default} call. // Also, if the chosen scase was a receive operation, it reports whether // a value was received. func selectgo(cas0 *scase, order0 *uint16, pc0 *uintptr, nsends, nrecvs int, block bool) (int, bool) { if debugSelect { print(\"select: cas0=\", cas0, \"\\n\") } // NOTE: In order to maintain a lean stack size, the number of scases // is capped at 65536. cas1 := (*[1 \u003c\u003c 16]scase)(unsafe.Pointer(cas0)) order1 := (*[1 \u003c\u003c 17]uint16)(unsafe.Pointer(order0)) // send + recv æ•°é‡å’Œ ncases := nsends + nrecvs // cases é›†ï¼ŒæŒ‰ç…§ send + recv é¡ºåºç»„æˆçš„ scases := cas1[:ncases:ncases] // select caseé›† // è½®è¯¢é›†,è®°å½•çš„æ˜¯scasesçš„ä¸‹æ ‡,ç°åœ¨æ˜¯ç©ºçš„ã€‚åé¢ä¹±åºå¡«å…¥ pollorder := order1[:ncases:ncases] // lockorder ç”¨äºæŒ‰channelåœ°å€å‡åºæ’åºï¼Œæ‰€ä»¥æ–¹ä¾¿Lock channelçš„ä½œç”¨ã€‚ lockorder := order1[ncases:][:ncases:ncases] // locké›†,ç°åœ¨æ˜¯ç©ºçš„ // NOTE: pollorder/lockorder's underlying array was not zero-initialized by compiler. // Even when raceenabled is true, there might be select // statements in packages compiled without -race (e.g., // ensureSigM in runtime/signal_unix.go). var pcs []uintptr if raceenabled \u0026\u0026 pc0 != nil { pc1 := (*[1 \u003c\u003c 16]uintptr)(unsafe.Pointer(pc0)) pcs = pc1[:ncases:ncases] } casePC := func(casi int) uintptr { if pcs == nil { return 0 } return pcs[casi] } var t0 int64 if blockprofilerate \u003e 0 { t0 = cputicks() } // The compiler rewrites selects that statically have // only 0 or 1 cases plus default into simpler constructs. // The only way we can end up with such small sel.ncase // values here is for a larger select in which most channels // have been nilled out. The general code handles those // cases correctly, and they are rare enough not to bother // optimizing (and needing to test). // 1) ä¹±åº pollorderï¼Œä¸ºåé¢selectçš„éšæœºæ€§å·¦å‡†å¤‡ // generate permuted order // // ç”Ÿæˆæ’åˆ—çš„ orderã€‚ norder := 0 // æœ‰æ•ˆçš„æ•°é‡ // éšæœºæ‰“ä¹± scases å¹¶æŠŠæ‰“ä¹±ç»“æœä¸‹æ ‡å­˜å…¥ pollorder ä¸­ã€‚ // å‚çœ‹ä¸‹é¢çš„ã€å›¾ä¸€ã€‘ for i := range scases { cas := \u0026scases[i] // Omit cases without channels from the poll and lock orders. // // ä» poll å’Œ lock orders ä¸­çœç•¥æ²¡æœ‰ channels çš„æƒ…å†µã€‚ // nil çš„ channel ä¼šè¢«ä¸¢å¼ƒã€‚ if cas.c == nil { cas.elem = nil // allow GC continue } // ç”Ÿæˆéšæœºæ•° [0, norder + 1] j := fastrandn(uint32(norder + 1)) pollorder[norder] = pollorder[j] pollorder[j] = uint16(i) norder++ } pollorder = pollorder[:norder] // æ­¤æ—¶pollorderæ˜¯æ‰“ä¹±çš„è½®è¯¢é›† lockorder = lockorder[:norder] // 2) lockorder æŒ‰ channel åœ°å€æ’åºï¼Œä¸ºäº†åé¢ all lock å‡†å¤‡ // æŒ‰ç…§åœ°å€å‡åºæ’åºæœ‰åŠ©äºåˆ¤æ–­åŒä¸€ä¸ªchannelåœ¨å¤šä¸ª case ä¸­çš„æƒ…å†µ // sort the cases by Hchan address to get the locking order. // simple heap sort, to guarantee n log n time and constant stack footprint. // // å°†casesæŒ‰ç…§Hchanåœ°å€æ’åºå¾—åˆ° locking orderã€‚ // ç®€å•çš„å †æ’åºï¼Œä¿è¯ n log n æ—¶é—´å’Œæ’å®šçš„æ ˆå ç”¨ã€‚ // å‚çœ‹ä¸‹é¢çš„ã€å›¾ä¸€ã€‘ for i := range lockorder { // æŒ‰ç…§channelåœ°å€æ’åºå¹¶è®°å½•åœ¨lockorderä¸­å‡åºã€‚ j := i // Start with the pollorder to permute cases on the same channel. c := scases[pollorder[i]].c // æŒ‰ç…§ channel çš„åœ°å€æ’åº for j \u003e 0 \u0026\u0026 scases[lockorder[(j-1)/2]].c.sortkey() \u003c c.sortkey() { k := (j - 1) / 2 lockorder[j] = lockorder[k] j = k } lockorder[j] = pollorder[i] } for i := len(lockorder) - 1; i \u003e= 0; i-- { o := lockorder[i] c := scases[o].c lockorder[i] = lockorder[0] j := 0 for { k := j*2 + 1 if k \u003e= i { break } if k+1 \u003c i \u0026\u0026 scases[lockorder[k]].c.sortkey() \u003c scases[lockorder[k+1]].c.sortkey() { k++ } if c.sortkey() \u003c scases[lockorder[k]].c.sortkey() { lockorder[j] = lockorder[k] j = k continue } break } lockorder[j] = o } if debugSelect { for i := 0; i+1 \u003c len(lockorder); i++ { if scases[lockorder[i]].c.sortkey() \u003e scases[lockorder[i+1]].c.sortkey() { print(\"i=\", i, \" x=\", lockorder[i], \" y=\", lockorder[i+1], \"\\n\") throw(\"select: broken sort\") } } } // 3) æ‰€æœ‰çš„ sendã€recv è·å– lock // lock all the channels involved in the select // // é”å®šselectä¸­æ¶‰åŠçš„æ‰€æœ‰channelsã€‚ sellock(scases, lockorder) // lock channel var ( gp *g // æ‰¾åˆ°çš„goroutine sg *sudog c *hchan // channel k *scase sglist *sudog sgnext *sudog qp unsafe.Pointer nextp **sudog ) // pass 1 - look for something already waiting // pass 1 - å¯»æ‰¾å·²ç»åœ¨ç­‰å¾…çš„ var casi int var cas *scase\tvar caseSuccess bool var caseReleaseTime int64 = -1 var recvOK bool // è½®åº order for _, casei := range pollorder { casi = int(casei) // é€‰ä¸­ä¸‹æ ‡ cas = \u0026scases[casi] c = cas.c // channel // recv æ“ä½œ if casi \u003e= nsends { // æ³¨æ„ recv å…ˆåˆ¤æ–­çš„èƒ½å¦æˆåŠŸï¼Œå†åˆ¤æ–­çš„ close sg = c.sendq.dequeue() // sendqä¸­å¯»æ‰¾ if sg != nil { goto recv // æ‰¾åˆ°ï¼Œå»recv } // send buf ä¸­æœ‰æ•°æ®ï¼Œå»bufrecv if c.qcount \u003e 0 { goto bufrecv } // å½“å‰recvæ“ä½œæ²¡å®Œæˆï¼Œcloseå…³é—­äº†ï¼Œå»rclose if c.closed != 0 { goto rclose } } else { // send æ“ä½œã€‚æ³¨æ„ send å…ˆåˆ¤æ–­çš„ closeï¼Œå†åˆ¤æ–­èƒ½å¦æˆåŠŸ if raceenabled { racereadpc(c.raceaddr(), casePC(casi), chansendpc) } // channel å·²ç»å…³é—­ if c.closed != 0 { goto sclose } sg = c.recvq.dequeue() // recvqä¸­å¯»æ‰¾ if sg != nil { goto send } // buf ä¸­è¿˜æœ‰å®¹é‡ if c.qcount \u003c c.dataqsiz { goto bufsend } } } // 4) ä»¥ä¸Šéƒ½æ²¡æœ‰èƒ½ç«‹å³å®Œæˆæ—¶ã€‚å¯ä»¥èµ°defaultåˆ†æ”¯ä¸ï¼Ÿ // block ä¸ºfalseæ—¶å­˜åœ¨defaultåˆ†æ”¯ï¼Œä¸æƒ³é˜»å¡ã€‚ // block ä¸ºtrueæ—¶ä¸å­˜åœ¨defaultåˆ†æ”¯ï¼Œé˜»å¡ã€‚ if !block { selunlock(scases, lockorder) // all channel unlock casi = -1 // -1 æ²¡æ‰¾åˆ° goto retc } // 5) æŠŠå½“å‰ goroutine æŒ‚åœ¨æ‰€æœ‰ channel ç­‰å¾…ã€‚ // pass 2 - enqueue on all chans // pass 2 - å¯¹æ‰€æœ‰chanè¿›è¡Œæ’é˜Ÿ gp = getg() // g if gp.waiting != nil { throw(\"gp.waiting != nil\") } nextp = \u0026gp.waiting // éå† lockorderï¼Œè¿™é‡Œå½“å‰goroutineè¢«åŠ å…¥åˆ°å¤šä¸ªchannelä¸­ for _, casei := range lockorder { casi = int(casei) cas = \u0026scases[casi] c = cas.c // channel sg := acquireSudog() // å¯»æ‰¾ä¸€ä¸ª*sudog sg.g = gp // è®°å½•å½“å‰goroutine sg.isSelect = true // æ ‡è®°æ˜¯åœ¨select // No stack splits between assigning elem and enqueuing // sg on gp.waiting where copystack can find it. sg.elem = cas.elem sg.releasetime = 0 if t0 != 0 { sg.releasetime = -1 } sg.c = c // Construct waiting list in lock order. // æ‰€æœ‰çš„ sudog ç»„æˆä¸ªé“¾è¡¨ï¼Œæœ‰ä¸¤ä¸ªä½œç”¨ï¼šã€å‚çœ‹ä¸‹é¢å›¾ç‰‡ã€‘ // 1. åç»­selparkcommitå‡½æ•°é€šè¿‡sudog.cè§£é”æ‰€æœ‰çš„ channelã€‚ // 2. å°±ç»ªåç”¨äºåˆ¤æ–­æ˜¯é‚£ä¸ª case å°±ç»ªäº†ã€‚ *nextp = sg // é€šè¿‡ waitlink é“¾æ¥ nextp = \u0026sg.waitlink // åŠ å…¥é˜Ÿåˆ—ä¸­ if casi \u003c nsends { c.sendq.enqueue(sg) } else { c.recvq.enqueue(sg) } } // wait for someone to wake us up // ç­‰ç€æœ‰äººå«é†’æˆ‘ä»¬ gp.param = nil // åœ¨è¢«å”¤é†’æ—¶ä¼šç»™paramå‚æ•°ä¸Šèµ‹å€¼ // Signal to anyone trying to shrink our stack that we're about // to park on a channel. The window between when this G's status // changes and when we set gp.activeStackChans is not safe for // stack shrinking. // å‚çœ‹ channel æ–‡æ¡£ atomic.Store8(\u0026gp.parkingOnChan, 1) // parkingOnChan = 1 // æŒ‚èµ·ï¼Œè¿›å…¥è°ƒåº¦å¾ªç¯ã€‚ gopark(selparkcommit, nil, waitReasonSelect, traceEvGoBlockSelect, 1) // 6) å†æ¬¡è¢«å”¤é†’æ—¶ï¼Œ... ... gp.activeStackChans = false // å…¨éƒ¨channelsé”ä½ sellock(scases, lockorder) // all channel lock // æ ‡è®°ä¸º0ï¼Œè¡¨ç¤ºselectå·²å®Œæˆã€‚æ­¤æ—¶æ‰€æœ‰çš„channelséƒ½é”ä½äº†ã€‚ gp.selectDone = 0 // è¢«å”¤é†’çš„goroutineçš„*sudogæ”¾åœ¨paramä¸Š // ç›´æ¥è·å–ä½¿ç”¨ï¼Œå…³äº gp.param çš„éƒ¨åˆ†èµ‹å€¼ä»£ç åœ¨ chan sendå’Œrecvä¸Š sg = (*sudog)(gp.param) gp.param = nil // pass 3 - dequeue from unsuccessful chans // otherwise they stack up on quiet channels // record the successful case, if any. // We singly-linked up the SudoGs in lock order. casi = -1 cas = nil caseSuccess = false // åœ¨ waiting ä¸Šç­‰å¾…ç€å¾ˆå¤šgoroutine sglist = gp.waiting // Clear all elem before unlinking from gp.waiting. // åœ¨ä»gp.waitingæ–­å¼€è¿æ¥å‰æ¸…é™¤æ‰€æœ‰elemã€‚ for sg1 := gp.waiting; sg1 != nil; sg1 = sg1.waitlink { sg1.isSelect = false sg1.elem = nil sg1.c = nil } gp.waiting = nil // 7) éå† lockorderï¼Œå¯»æ‰¾æ˜¯å“ªä¸ªcaseå°±ç»ªäº† for _, casei := range lockorder { k = \u0026scases[casei] if sg == sglist { // æ‰¾åˆ°å°±ç»ªçš„ case // sg has already been dequeued by the G that woke us up. casi = int(casei) // æ‰¾åˆ°å°±ç»ªçš„ case cas = k caseSuccess = sglist.success if sglist.releasetime \u003e 0 { caseReleaseTime = sglist.releasetime } } else { // ç§»é™¤æ²¡å°±ç»ªçš„ c = k.c // ä» channel ä¸­ç§»é™¤ sglist // å› ä¸ºå…¶ä»– channel ä¸­è¿˜æŒ‚èµ·çš„å‘¢ï¼Œè¦ç§»é™¤ if int(casei) \u003c nsends { c.sendq.dequeueSudoG(sglist) } else { c.recvq.dequeueSudoG(sglist) } } sgnext = sglist.waitlink // æ¢ä¸‹ä¸€ä¸ª sglist.waitlink = nil releaseSudog(sglist) // å›æ”¶*sudog sglist = sgnext } if cas == nil { throw(\"selectgo: bad wakeup\") } c = cas.c // channel if debugSelect { print(\"wait-return: cas0=\", cas0, \" c=\", c, \" cas=\", cas, \" send=\", casi \u003c nsends, \"\\n\") } // send æ“ä½œ if casi \u003c nsends { // caseSuccess = trueæˆåŠŸï¼Œfalseç”±äºclosedå‡½æ•°å…³é—­è§¦å‘ã€‚ if !caseSuccess { goto sclose } } else { // recv æ“ä½œ recvOK = caseSuccess } if raceenabled { if casi \u003c nsends { raceReadObjectPC(c.elemtype, cas.elem, casePC(casi), chansendpc) } else if cas.elem != nil { raceWriteObjectPC(c.elemtype, cas.elem, casePC(casi), chanrecvpc) } } if msanenabled { if casi \u003c nsends { msanread(cas.elem, c.elemtype.size) } else if cas.elem != nil { msanwrite(cas.elem, c.elemtype.size) } } if asanenabled { if casi \u003c nsends { asanread(cas.elem, c.elemtype.size) } else if cas.elem != nil { asanwrite(cas.elem, c.elemtype.size) } } selunlock(scases, lockorder) // all channel unlock goto retc bufrecv: // buf ä¸­æœ‰æ•°æ®, recvæ“ä½œã€ep \u003c- cã€‘ // can receive from buffer if raceenabled { if cas.elem != nil { raceWriteObjectPC(c.elemtype, cas.elem, casePC(casi), chanrecvpc) } racenotify(c, c.recvx, nil) } if msanenabled \u0026\u0026 cas.elem != nil { msanwrite(cas.elem, c.elemtype.size) } if asanenabled \u0026\u0026 cas.elem != nil { asanwrite(cas.elem, c.elemtype.size) } recvOK = true // æ•°æ®äº¤æ¢æˆåŠŸæ ‡è¯† qp = chanbuf(c, c.recvx) if cas.elem != nil { // æ•°æ®ç»™åˆ°ç­‰å¾…çš„å˜é‡ typedmemmove(c.elemtype, cas.elem, qp) } typedmemclr(c.elemtype, qp) // å¤„ç† buf çš„ä¸‹æ ‡ c.recvx++ if c.recvx == c.dataqsiz { c.recvx = 0 } c.qcount-- selunlock(scases, lockorder) // all channel unlock goto retc bufsend: // buf ä¸­è¿˜æœ‰å®¹é‡ï¼Œsendæ“ä½œã€c \u003c- epã€‘ // can send to buffer if raceenabled { racenotify(c, c.sendx, nil) raceReadObjectPC(c.elemtype, cas.elem, casePC(casi), chansendpc) } if msanenabled { msanread(cas.elem, c.elemtype.size) } if asanenabled { asanread(cas.elem, c.elemtype.size) } // æ•°æ®è¿ç§» typedmemmove(c.elemtype, chanbuf(c, c.sendx), cas.elem) // å¤„ç†ä¸‹æ ‡ c.sendx++ if c.sendx == c.dataqsiz { c.sendx = 0 } c.qcount++ selunlock(scases, lockorder) goto retc recv: // sendq ä¸­è·å–åˆ° sg goroutine // can receive from sleeping sender (sg) // æ•°æ®åœ¨æŒ‚èµ·çš„ send çš„ goroutine é‡Œé¢ï¼Œè°ƒç”¨recvå–äº¤æ¢æ•°æ®ã€‚ recv(c, sg, cas.elem, func() { selunlock(scases, lockorder) }, 2) // æ¢å¤å¹¶è§£é”all channel if debugSelect { print(\"syncrecv: cas0=\", cas0, \" c=\", c, \"\\n\") } recvOK = true // recvæ“ä½œæˆåŠŸ goto retc rclose: // channel å·²ç»å…³é—­, recv æ“ä½œæ—¶ // read at end of closed channel selunlock(scases, lockorder) // all channel unlock recvOK = false // channel å…³é—­çš„ recv if cas.elem != nil { // æ¥å—å€¼è®¾ç½®æˆé»˜è®¤é›¶å€¼ï¼Œå› ä¸ºcloseäº† typedmemclr(c.elemtype, cas.elem) } if raceenabled { raceacquire(c.raceaddr()) } goto retc send: // recvq ä¸­æœ‰ç­‰å¾… sg goroutineã€‚ // can send to a sleeping receiver (sg) if raceenabled { raceReadObjectPC(c.elemtype, cas.elem, casePC(casi), chansendpc) } if msanenabled { msanread(cas.elem, c.elemtype.size) } if asanenabled { asanread(cas.elem, c.elemtype.size) } // æ•°æ®åœ¨æŒ‚èµ·çš„ recv çš„ goroutine é‡Œé¢ï¼Œè°ƒç”¨ send å»äº¤æ¢æ•°æ®ã€‚ send(c, sg, cas.elem, func() { selunlock(scases, lockorder) }, 2) if debugSelect { print(\"syncsend: cas0=\", cas0, \" c=\", c, \"\\n\") } goto retc retc: if caseReleaseTime \u003e 0 { blockevent(caseReleaseTime-t0, 1) } return casi, recvOK sclose: // channel å·²ç»å…³é—­ï¼Œsend æ“ä½œæ—¶ // send on closed channel selunlock(scases, lockorder) panic(plainError(\"send on closed channel\")) } sellock() æ‰€æœ‰ case çš„ sendã€recv æ“ä½œçš„è·å– hmap.lock äº’æ–¥é”ã€‚ 1 2 3 4 5 6 7 8 9 10 11 func sellock(scases []scase, lockorder []uint16) { var c *hchan // æŒ‰ç…§lockorderéå†ï¼Œå› ä¸ºæ˜¯å‡åºï¼Œæ‰€ä»¥ç›¸åŒçš„channelåœ¨ä¸€èµ· for _, o := range lockorder { c0 := scases[o].c if c0 != c { // å¦‚æœæ˜¯åŒä¸€ä¸ª channel è·³è¿‡å®ƒ c = c0 lock(\u0026c.lock) // mutex lock } } } selunlock() æ‰€æœ‰ case çš„ sendã€recv æ“ä½œçš„é‡Šæ”¾ hmap.lock äº’æ–¥é”ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func selunlock(scases []scase, lockorder []uint16) { // We must be very careful here to not touch sel after we have unlocked // the last lock, because sel can be freed right after the last unlock. // Consider the following situation. // First M calls runtimeÂ·park() in runtimeÂ·selectgo() passing the sel. // Once runtimeÂ·park() has unlocked the last lock, another M makes // the G that calls select runnable again and schedules it for execution. // When the G runs on another M, it locks all the locks and frees sel. // Now if the first M touches sel, it will access freed memory. for i := len(lockorder) - 1; i \u003e= 0; i-- { c := scases[lockorder[i]].c // å¦‚æœæ˜¯åŒä¸€ä¸ª channel è·³è¿‡å®ƒ if i \u003e 0 \u0026\u0026 c == scases[lockorder[i-1]].c { continue // will unlock it on the next iteration } unlock(\u0026c.lock) } } selparkcommit() å½“å‰ select æ²¡æœ‰å°±ç»ª case å¯¼è‡´å½“å‰ goroutine è¢«æŒ‚èµ·å‰æ‰§è¡Œçš„å‡½æ•°ã€‚ func selparkcommit(gp *g, _ unsafe.Pointer) bool { // There are unlocked sudogs that point into gp's stack. Stack // copying must lock the channels of those sudogs. // Set activeStackChans here instead of before we try parking // because we could self-deadlock in stack growth on a // channel lock. gp.activeStackChans = true // å‚çœ‹channelæ–‡æ¡£ // Mark that it's safe for stack shrinking to occur now, // because any thread acquiring this G's stack for shrinking // is guaranteed to observe activeStackChans after this store. atomic.Store8(\u0026gp.parkingOnChan, 0) // å‚çœ‹channelæ–‡æ¡£ // Make sure we unlock after setting activeStackChans and // unsetting parkingOnChan. The moment we unlock any of the // channel locks we risk gp getting readied by a channel operation // and so gp could continue running before everything before the // unlock is visible (even to gp itself). // This must not access gp's stack (see gopark). In // particular, it must not access the *hselect. That's okay, // because by the time this is called, gp.waiting has all // channels in lock order. var lastc *hchan // ä¾æ¬¡channelè§£é” for sg := gp.waiting; sg != nil; sg = sg.waitlink { if sg.c != lastc \u0026\u0026 lastc != nil { // As soon as we unlock the channel, fields in // any sudog with that channel may change, // including c and waitlink. Since multiple // sudogs may have the same channel, we unlock // only after we've passed the last instance // of a channel. unlock(\u0026lastc.lock) } lastc = sg.c } if lastc != nil { unlock(\u0026lastc.lock) } return true } selectgo å‚æ•°ç»„æˆ ä»¥ä¸‹éƒ½æ˜¯ä»‹ç»selectgo()å‚æ•°çš„ç»„æˆï¼Œå¯¹äºç†è§£goselectå¢åŠ å¸®åŠ©ã€‚\ntype runtimeSelect struct runtimeSelect æ˜¯ä¼ é€’ç»™ rselect çš„ä¸€ä¸ª caseã€‚ å¿…é¡»åŒ¹é… ../reflect/value.go:/runtimeSelectã€‚ è¯¥ç»“æ„ç†è§£ä¸ºselect caseä¸­çš„æ‰€æœ‰caseç»„æˆçš„é›†åˆã€‚ 1 2 3 4 5 6 7 8 9 10 11 // A runtimeSelect is a single case passed to rselect. // This must match ../reflect/value.go:/runtimeSelect type runtimeSelect struct { // channel ç±»å‹ï¼ŒåŒ…å«ï¼šsendã€recvã€default ä¸‰ç§ dir selectDir typ unsafe.Pointer // channel type (not used here) // å½“å‰ case æ“ä½œæ‰€å±çš„ channel ch *hchan // channel // send æˆ– recv æ“ä½œæ—¶æ•°æ®çš„åœ°å€ val unsafe.Pointer // ptr to data (SendDir) or ptr to receive buffer (RecvDir) } type selectDir int 1 2 3 4 5 6 7 8 9 // These values must match ../reflect/value.go:/SelectDir. type selectDir int const ( _ selectDir = iota selectSend // case Chan \u003c- Send selectRecv // case \u003c-Chan: selectDefault // default ) reflect_rselect() reflect_rselectæ˜¯selectå…³é”®å­—ç›¸å…³ä»£ç ã€‚ å¯¹äºä»£ç select {}ï¼Œå½“å‰goroutineä¼šä¸¢å¤±å†ä¹Ÿä¸ä¼šè¢«è°ƒåº¦ã€‚ å‚æ•°cases []runtimeSelectï¼šselectçš„æ‰€æœ‰åˆ†æ”¯æ•°æ®ä¿¡æ¯ã€‚ è¿”å›å€¼intï¼šè¿”å›é€‰ä¸­çš„åˆ†æ”¯ä¸‹æ ‡ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 //go:linkname reflect_rselect reflect.rselect func reflect_rselect(cases []runtimeSelect) (int, bool) { // æ²¡æœ‰ case åˆ†æ”¯ // å¯¹äº `select {}` å½“å‰goroutineä¼šç›´æ¥ä¸¢å¤± if len(cases) == 0 { block() // gopark } // len(cases) = send + recv + default sel := make([]scase, len(cases)) // scase é›† orig := make([]int, len(cases)) // selä¸‹æ ‡å’Œcasesçš„å¯¹åº”å…³ç³» // ä¸´æ—¶å˜é‡ç”¨äºä¿å­˜ send å’Œ recv nsends, nrecvs := 0, 0 // send And recv // æ ‡è®°selectä¸­é»˜è®¤defaultåˆ†æ”¯ä¸‹æ ‡ dflt := -1 // é»˜è®¤å€¼-1è¡¨ç¤ºæ²¡æœ‰é»˜è®¤defaultåˆ†æ”¯ // éå†selectçš„æ‰€æœ‰caseï¼ŒåŒ…æ‹¬defaultåˆ†æ”¯ // ä½¿ç”¨ dflt æ ‡è®° default åˆ†æ”¯çš„ä¸‹æ ‡ // sel æ•´ç†å­˜å‚¨ä¸º send + recv // orig å­˜å‚¨selå’Œcasesçš„æ˜ å°„å…³ç³»ã€å‚çœ‹ä¸Šé¢\"å›¾ä¸€\"ã€‘ for i, rc := range cases { // ä¸´æ—¶å˜é‡ï¼Œç”¨äºè®¡ç®—å½“å‰caseåº”è¯¥æ”¾å…¥çš„ä½ç½® var j int switch rc.dir { // defaultåˆ†æ”¯ case selectDefault: dflt = i continue // send åˆ†æ”¯ï¼šc \u003c- ep case selectSend: // ä»å‰å‘åï¼Œä¾æ¬¡æ”¾å…¥ j = nsends nsends++ // recv åˆ†æ”¯ï¼š\u003c- c case selectRecv: // ä»åå‘å‰ï¼Œä¾æ¬¡æ”¾å…¥ nrecvs++ j = len(cases) - nrecvs } // ä¿å­˜å¯¹åº”å…³ç³» sel[j] = scase{c: rc.ch, elem: rc.val} orig[j] = i } // for range å®Œåï¼Œsel ä¿å­˜ send + recv // orig ä¿å­˜ sel å’Œ cases å¯¹åº”å…³ç³» // Only a default case. // // ä»…ä»…åªæœ‰ä¸€ä¸ª default caseã€‚ // å› ä¸ºå¦‚æœä¸€ä¸ªåˆ†æ”¯éƒ½æ²¡æœ‰ï¼Œæœ€å‰é¢å°±è¿”å›äº† // select {default:} if nsends+nrecvs == 0 { return dflt, false } // Compact sel and orig if necessary. // // å¦‚æœæœ‰å¿…è¦ä½¿sel å’Œ origç´§å‡‘ã€‚ã€å‚çœ‹ä¸Šé¢\"å›¾äºŒ\"ã€‘ if nsends+nrecvs \u003c len(cases) { // å­˜åœ¨defultæ—¶ copy(sel[nsends:], sel[len(cases)-nrecvs:]) copy(orig[nsends:], orig[len(cases)-nrecvs:]) } // order é•¿åº¦æ˜¯ 2*(nsends+nrecvs) order := make([]uint16, 2*(nsends+nrecvs)) var pc0 *uintptr if raceenabled { pcs := make([]uintptr, nsends+nrecvs) for i := range pcs { selectsetpc(\u0026pcs[i]) } pc0 = \u0026pcs[0] } // \u0026sel[0]ï¼šæ˜¯send+recv // \u0026order[0]ï¼šæ˜¯ç©ºçš„ï¼Œdflt true.ä¸å­˜åœ¨defalutåˆ†æ”¯ false.å­˜åœ¨defaultåˆ†æ”¯ // chosenï¼šè¡¨ç¤ºé€‰æ‹©çš„caseä¸‹æ ‡ï¼Œå¦‚æœä¸º-1æ—¶ä¸ºé»˜è®¤defaultåˆ†æ”¯ // recvOKï¼šè¡¨ç¤ºæ•°æ®æ˜¯å¦äº¤æ¢æˆåŠŸï¼Œtrue.æˆåŠŸ false.å¤±è´¥ // ä»caseåˆ†æ”¯ä¸­é€‰æ‹©ä¸€ä¸ªå°±ç»ªçš„channel chosen, recvOK := selectgo(\u0026sel[0], \u0026order[0], pc0, nsends, nrecvs, dflt == -1) // Translate chosen back to caller's ordering. // // chosen \u003c 0 é€‰ä¸­é»˜è®¤åˆ†æ”¯ if chosen \u003c 0 { chosen = dflt // é»˜è®¤default } else { chosen = orig[chosen] // case } return chosen, recvOK } block() 1 2 3 4 func block() { // æ³¨æ„ï¼šè¿™é‡Œç¬¬ä¸€å’Œç¬¬äºŒä¸ªå‚æ•°éƒ½ä¸ºnilï¼Œè¡¨æ˜å½“å‰goroutineè¢«ä¸¢å¼ƒäº†ã€‚ gopark(nil, nil, waitReasonSelectNoCases, traceEvGoStop, 1) // forever } æ±‡ç¼–éªŒè¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 package main func main() { ch1 := make(chan int) ch2 := make(chan int) select { case v := \u003c-ch1: println(v) case ch2 \u003c- 10: default: } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 TEXT main.main(SB) /mnt/GoProject/small/tt1.go func main() { 0x459580 4c8d6424c8 LEAQ -0x38(SP), R12 0x459585 4d3b6610 CMPQ 0x10(R14), R12 0x459589 0f8632010000 JBE 0x4596c1 0x45958f 4881ecb8000000 SUBQ $0xb8, SP 0x459596 4889ac24b0000000 MOVQ BP, 0xb0(SP) 0x45959e 488dac24b0000000 LEAQ 0xb0(SP), BP ch1 := make(chan int) 0x4595a6 488d0513490000 LEAQ 0x4913(IP), AX 0x4595ad 31db XORL BX, BX 0x4595af e8eca6faff CALL runtime.makechan(SB) 0x4595b4 4889442468 MOVQ AX, 0x68(SP) ch2 := make(chan int) 0x4595b9 488d0500490000 LEAQ 0x4900(IP), AX 0x4595c0 31db XORL BX, BX 0x4595c2 e8d9a6faff CALL runtime.makechan(SB) 0x4595c7 4889442460 MOVQ AX, 0x60(SP) case v := \u003c-ch1: 0x4595cc 488b4c2468 MOVQ 0x68(SP), CX #CX=\u0026ch1 0x4595d1 48894c2478 MOVQ CX, 0x78(SP) case ch2 \u003c- 10: 0x4595d6 488b4c2460 MOVQ 0x60(SP), CX 0x4595db 48894c2470 MOVQ CX, 0x70(SP) 0x4595e0 48c74424500a000000 MOVQ $0xa, 0x50(SP) select { 0x4595e9 440f11bc2490000000 MOVUPS X15, 0x90(SP) 0x4595f2 440f11bc24a0000000 MOVUPS X15, 0xa0(SP) case v := \u003c-ch1: 0x4595fb 488b4c2478 MOVQ 0x78(SP), CX 0x459600 48898c24a0000000 MOVQ CX, 0xa0(SP) 0x459608 488d4c2458 LEAQ 0x58(SP), CX 0x45960d 48898c24a8000000 MOVQ CX, 0xa8(SP) case ch2 \u003c- 10: 0x459615 488b4c2470 MOVQ 0x70(SP), CX 0x45961a 48898c2490000000 MOVQ CX, 0x90(SP) 0x459622 488d4c2450 LEAQ 0x50(SP), CX 0x459627 48898c2498000000 MOVQ CX, 0x98(SP) select { 0x45962f 488d8c2490000000 LEAQ 0x90(SP), CX 0x459637 48898c2488000000 MOVQ CX, 0x88(SP) 0x45963f 488d5c2448 LEAQ 0x48(SP), BX 0x459644 48899c2480000000 MOVQ BX, 0x80(SP) 0x45964c 488b842488000000 MOVQ 0x88(SP), AX 0x459654 31c9 XORL CX, CX 0x459656 bf01000000 MOVL $0x1, DI 0x45965b 4889fe MOVQ DI, SI 0x45965e 4531c0 XORL R8, R8 0x459661 e89a57feff CALL runtime.selectgo(SB) 0x459666 4889442440 MOVQ AX, 0x40(SP) 0x45966b 885c2437 MOVB BL, 0x37(SP) default: 0x45966f 48837c244000 CMPQ $0x0, 0x40(SP) 0x459675 7c02 JL 0x459679 0x459677 eb02 JMP 0x45967b 0x459679 eb36 JMP 0x4596b1 case ch2 \u003c- 10: 0x45967b 48837c244000 CMPQ $0x0, 0x40(SP) 0x459681 7402 JE 0x459685 0x459683 eb02 JMP 0x459687 0x459685 eb2a JMP 0x4596b1 case v := \u003c-ch1: 0x459687 488b442458 MOVQ 0x58(SP), AX 0x45968c 4889442438 MOVQ AX, 0x38(SP) println(v) 0x459691 e86a5cfdff CALL runtime.printlock(SB) 0x459696 488b442438 MOVQ 0x38(SP), AX 0x45969b 0f1f440000 NOPL 0(AX)(AX*1) 0x4596a0 e85b63fdff CALL runtime.printint(SB) 0x4596a5 e8b65efdff CALL runtime.printnl(SB) 0x4596aa e8d15cfdff CALL runtime.printunlock(SB) case v := \u003c-ch1: 0x4596af eb00 JMP 0x4596b1 } 0x4596b1 488bac24b0000000 MOVQ 0xb0(SP), BP 0x4596b9 4881c4b8000000 ADDQ $0xb8, SP 0x4596c0 c3 RET func main() { 0x4596c1 e8dacbffff CALL runtime.morestack_noctxt.abi0(SB) 0x4596c6 e9b5feffff JMP main.main(SB) æ€»ç»“ select {} ä¼šå¯¼è‡´å½“å‰ goroutine ç›´æ¥ä¸¢å¼ƒï¼Œå†ä¹Ÿä¸ä¼šè¢«è°ƒç”¨ã€‚ select {default:} ç›´æ¥è·³è¿‡ä»€ä¹ˆéƒ½ä¸ä¼šåšã€‚ select case ä¸­å­˜åœ¨ channel ä¸º nilï¼Œè¯¥ case ä¼šè¢«ä¸¢å¼ƒã€‚ select ä¸­ä¹Ÿä¸€æ ·ï¼Œå‘å…³é—­çš„channelï¼Œsendä¼španicï¼Œrecvä¼šå¾—åˆ°é»˜è®¤çš„é›¶å€¼ã€‚ select ä¸­ï¼Œå‘ nil çš„ channelï¼Œsend æˆ– recv ä¸ä¼š panicï¼ˆchannelä¼šè¢«ä¸¢å¼ƒï¼‰ã€‚è€Œæ²¡åœ¨ select ä¸­å…¨éƒ¨éƒ½ä¼š panicã€‚ æ³¨æ„ï¼šåœ¨ select ä¸­ close çš„ channel æƒ…å†µï¼š recv å…ˆåˆ¤æ–­çš„èƒ½å¦æˆåŠŸï¼Œå†åˆ¤æ–­çš„ closeã€‚ send å…ˆåˆ¤æ–­çš„ closeï¼Œå†åˆ¤æ–­èƒ½å¦æˆåŠŸã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 package main import ( \"fmt\" ) func main() { c := make(chan int, 2) c \u003c- 1 close(c) select { case v, ok := \u003c-c: fmt.Printf(\"received %d, ok = %v\\n\", v, ok) default: fmt.Printf(\"default\") } // Output: // received 1, ok = true } ",
  "wordCount" : "4050",
  "inLanguage": "zh",
  "image": "https://helium.github.io/favicon-32x32.png","datePublished": "2024-08-01T00:00:00Z",
  "dateModified": "2024-08-01T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://helium.github.io/posts/golang/channel/select/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://helium.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://helium.github.io/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://helium.github.io/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://helium.github.io/" title="ä¸»é¡µ">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/posts" title="æ–‡ç« ">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/archives" title="æ—¶é—´è½´">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/tags/" title="æ ‡ç­¾">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/search/" title="æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/support" title="æ‰“èµ">
                    <span>ğŸ«¶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://helium.github.io/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://helium.github.io/posts/">Article</a>&nbsp;Â»&nbsp;<a href="https://helium.github.io/posts/golang/">Golang</a>&nbsp;Â»&nbsp;<a href="https://helium.github.io/posts/golang/channel/">ç¬¬13ç«  Channel</a></div>
    <h1 class="post-title entry-hint-parent">
      select(åŸç†)
    </h1>
    <div class="post-description">
      ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬
    </div>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2024-08-01</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2024-08-01</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>4050å­—</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>20åˆ†é’Ÿ</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &nbsp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://helium.github.io/tags/golang/" target="_blank" rel="noopener">Golang</a>
            <a href="https://helium.github.io/tags/channel/" target="_blank" rel="noopener">Channel</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &nbsp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#constants" aria-label="Constants">Constants</a></li>
                    <li>
                        <a href="#variables" aria-label="Variables">Variables</a></li>
                    <li>
                        <a href="#type-scase-struct" aria-label="type scase struct">type scase struct</a></li>
                    <li>
                        <a href="#select%e5%85%b3%e9%94%ae%e5%ad%97" aria-label="selectå…³é”®å­—">selectå…³é”®å­—</a><ul>
                            
                    <li>
                        <a href="#sellock" aria-label="sellock()">sellock()</a></li>
                    <li>
                        <a href="#selunlock" aria-label="selunlock()">selunlock()</a></li>
                    <li>
                        <a href="#selparkcommit" aria-label="selparkcommit()">selparkcommit()</a></li></ul>
                    </li>
                    <li>
                        <a href="#selectgo-%e5%8f%82%e6%95%b0%e7%bb%84%e6%88%90" aria-label="selectgo å‚æ•°ç»„æˆ">selectgo å‚æ•°ç»„æˆ</a><ul>
                            
                    <li>
                        <a href="#type-runtimeselect-struct" aria-label="type runtimeSelect struct">type runtimeSelect struct</a></li>
                    <li>
                        <a href="#type-selectdir-int" aria-label="type selectDir int">type selectDir int</a></li>
                    <li>
                        <a href="#reflect_rselect" aria-label="reflect_rselect()">reflect_rselect()</a></li>
                    <li>
                        <a href="#block" aria-label="block()">block()</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%b1%87%e7%bc%96%e9%aa%8c%e8%af%81" aria-label="æ±‡ç¼–éªŒè¯">æ±‡ç¼–éªŒè¯</a></li>
                    <li>
                        <a href="#%e6%80%bb%e7%bb%93" aria-label="æ€»ç»“">æ€»ç»“</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><ul>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/select.goã€‚</li>
<li>select çš„ä½¿ç”¨æ–‡æ¡£å‚è€ƒ <a href="/posts/golang/process/select">select(ä½¿ç”¨)</a>ã€‚</li>
</ul>
<h2 id="constants">Constants<a hidden class="anchor" aria-hidden="true" href="#constants">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">const</span> <span class="nx">debugSelect</span> <span class="p">=</span> <span class="kc">false</span> <span class="c1">// è°ƒè¯•æ¨¡å¼
</span></span></span></code></pre></div><h2 id="variables">Variables<a hidden class="anchor" aria-hidden="true" href="#variables">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å‡½æ•°chansendçš„PCå…¥å£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">chansendpc</span> <span class="p">=</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABIInternal</span><span class="p">(</span><span class="nx">chansend</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">chanrecvpc</span> <span class="p">=</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABIInternal</span><span class="p">(</span><span class="nx">chanrecv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="type-scase-struct">type scase struct<a hidden class="anchor" aria-hidden="true" href="#type-scase-struct">#</a></h2>
<ol>
<li>Select case æè¿°ç¬¦ã€‚ç¼–è¯‘å™¨å·²çŸ¥ã€‚</li>
<li>è¿™é‡Œä¿®æ”¹å¿…é¡»å» src/cmd/compile/internal/walk/select.go&rsquo;s scasetypeã€‚</li>
<li>scase ç»“æ„æ˜¯ä¸€ä¸ª case çš„ channel ç»“æ„ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Select case descriptor.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Known to compiler.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Changes here must also be made in src/cmd/compile/internal/walk/select.go&#39;s scasetype.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">scase</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span>    <span class="o">*</span><span class="nx">hchan</span>         <span class="c1">// chan
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">elem</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// data element
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="selectå…³é”®å­—">selectå…³é”®å­—<a hidden class="anchor" aria-hidden="true" href="#selectå…³é”®å­—">#</a></h2>
<ol>
<li>selectgo å®ç°äº† select è¯­å¥ã€‚</li>
<li>cas0 æŒ‡å‘ç±»å‹ä¸º <strong>[ncases]scase</strong> çš„æ•°ç»„ï¼Œorder0 æŒ‡å‘ç±»å‹ä¸º <strong>[2*ncases]uint16</strong> çš„æ•°ç»„ï¼Œå…¶ä¸­ ncases å¿…é¡» &lt;= 65536ã€‚</li>
<li>ä¸¤è€…éƒ½å­˜åœ¨äº goroutine çš„æ ˆä¸­ï¼ˆä¸ç®¡ selectgo ä¸­çš„ä»»ä½•è½¬ä¹‰ï¼‰ã€‚</li>
<li>å¯¹äº race çš„æ„å»ºï¼Œpc0 æŒ‡å‘ä¸€ä¸ªç±»å‹ä¸º [ncases]uintptr çš„æ•°ç»„ï¼ˆä¹Ÿåœ¨è¿™ä¸ªæ ˆä¸Šï¼‰ï¼›å¯¹äºå…¶ä»–æ„å»ºï¼Œå®ƒè¢«è®¾ç½®ä¸ºnilã€‚</li>
<li>selectgo è¿”å›æ‰€é€‰åˆ†æ”¯çš„ç´¢å¼•ï¼Œå®ƒä¸å„è‡ªçš„ select{recv,send,default} è°ƒç”¨çš„é¡ºåºä½ç½®åŒ¹é…ã€‚</li>
<li>æ­¤å¤–ï¼Œå¦‚æœé€‰æ‹©çš„ scase æ˜¯ä¸€ä¸ª receive æ¥æ”¶ç±»å‹æ“ä½œï¼Œå®ƒä¼šæŠ¥å‘Šæ˜¯å¦æ”¶åˆ°äº†å€¼ã€‚</li>
<li>å‚æ•°ï¼š
<ol>
<li><strong><code>cas0 *scase</code></strong>ï¼šæŒ‡å‘ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„é‡Œè£…çš„æ˜¯<code>select</code>ä¸­æ‰€æœ‰çš„<code>case</code>åˆ†æ”¯ï¼ŒæŒ‰ç…§<code>send</code>åœ¨å‰<code>recv</code>åœ¨åçš„é¡ºåºã€‚ä¸åŒ…å«<code>default</code>åˆ†æ”¯ã€‚</li>
<li><strong><code>order0 *uint16</code></strong>ï¼šæŒ‡å‘ä¸€ä¸ªå¤§å°ç­‰äº<code>case</code>åˆ†æ”¯æ•°é‡ä¸¤å€çš„<code>uint16</code>æ•°ç»„(<code>2*(nsends+nrecvs)</code>)ï¼Œå®é™…ä¸Šæ˜¯ä½œä¸ºä¸¤ä¸ªå¤§å°ç›¸ç­‰çš„æ•°ç»„æ¥ç”¨çš„ã€‚å‰ä¸€ä¸ªç”¨æ¥å¯¹æ‰€æœ‰caseä¸­channelçš„è½®è¯¢è¿›è¡Œä¹±åºï¼Œåä¸€ä¸ªç”¨æ¥å¯¹æ‰€æœ‰caseä¸­channelçš„åŠ é”æ“ä½œè¿›è¡Œæ’åºã€‚</li>
<li><strong><code>pc0 *uintptr</code></strong>ï¼šrace ç›¸å…³ã€‚</li>
<li><strong><code>nsends int</code></strong>ï¼šsend æ“ä½œçš„åˆ†æ”¯æ•°é‡ã€‚</li>
<li><strong><code>nrecvs int</code></strong>ï¼šrecv æ“ä½œçš„åˆ†æ”¯æ•°é‡ã€‚</li>
<li><strong><code>block bool</code></strong>ï¼šè¡¨ç¤ºæ˜¯å¦æƒ³è¦é˜»å¡ç­‰å¾…ã€‚æœ‰defaultåˆ†æ”¯çš„ä¸é˜»å¡ï¼Œåä¹‹åˆ™ä¼šé˜»å¡ã€‚</li>
</ol>
</li>
<li>è¿”å›å€¼ï¼š
<ol>
<li><strong><code>int</code></strong>ï¼šè¡¨ç¤ºæœ€ç»ˆå“ªä¸ªcaseåˆ†æ”¯è¢«æ‰§è¡Œäº†ï¼Œå¯¹åº”case0æ•°ç»„çš„ä¸‹æ ‡ã€‚å¦‚æœå› ä¸ºä¸æƒ³é˜»å¡è€Œè¿”å›ï¼Œåˆ™è¿™ä¸ªå€¼ä¸º-1ã€‚</li>
<li><strong><code>bool</code></strong>ï¼šè¡¨ç¤ºåœ¨å¯¹åº”çš„caseåˆ†æ”¯æ‰§è¡Œçš„æ˜¯recvæ“ä½œæ—¶ï¼Œç”¨æ¥è¡¨ç¤ºå®é™…æ¥æ”¶åˆ°ä¸€ä¸ªå€¼ï¼Œè€Œä¸æ˜¯å› ä¸ºé€šé“å…³é—­å¾—åˆ°çš„é›¶å€¼ã€‚</li>
</ol>
</li>
<li>selectgo() å‡½æ•°æµç¨‹ï¼š
<ol>
<li>å…ˆéšæœºæ‰“ä¹±cas0é›†ç”¨äºè½®è¯¢éå†ã€‚åœ¨æŒ‰ç…§channelåœ°å€å‡åºæ’åºç”¨äºå…¨éƒ¨çš„channelåŠ é”å’Œè§£é”ã€‚</li>
<li>all channel lockåéå†æ‰“ä¹±çš„caseé›†æ£€æŸ¥æ˜¯å¦èƒ½ç«‹å³å®Œæˆï¼Œå¦‚æœå¯ä»¥åˆ™äº¤æ¢æ•°æ®åå…¨éƒ¨è§£é”ã€‚å¦åˆ™åˆ¤æ–­blockæ˜¯å¦éœ€è¦é˜»å¡ã€‚</li>
<li>å…¨éƒ¨éœ€è¦é˜»å¡æ—¶ï¼Œå°†å½“å‰goroutineå°è£…æˆsudogå½¢æˆä¸€ä¸ªé“¾è¡¨æŒ‚åœ¨æ‰€æœ‰çš„channelä¸Šå»ç­‰å¾…ã€‚</li>
<li>å½“å†æ¬¡è§¦å‘æ—¶ï¼Œå…ˆè·å–æ¸…all channel lockï¼Œé™¤æŒ‚åœ¨è¿™äº›ä¸Šé¢çš„sudogï¼Œè§£é”åè¿”å›ã€‚</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// selectgo implements the select statement.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// cas0 points to an array of type [ncases]scase, and order0 points to
</span></span></span><span class="line"><span class="cl"><span class="c1">// an array of type [2*ncases]uint16 where ncases must be &lt;= 65536.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Both reside on the goroutine&#39;s stack (regardless of any escaping in
</span></span></span><span class="line"><span class="cl"><span class="c1">// selectgo).
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// For race detector builds, pc0 points to an array of type
</span></span></span><span class="line"><span class="cl"><span class="c1">// [ncases]uintptr (also on the stack); for other builds, it&#39;s set to
</span></span></span><span class="line"><span class="cl"><span class="c1">// nil.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// selectgo returns the index of the chosen scase, which matches the
</span></span></span><span class="line"><span class="cl"><span class="c1">// ordinal position of its respective select{recv,send,default} call.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Also, if the chosen scase was a receive operation, it reports whether
</span></span></span><span class="line"><span class="cl"><span class="c1">// a value was received.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">selectgo</span><span class="p">(</span><span class="nx">cas0</span> <span class="o">*</span><span class="nx">scase</span><span class="p">,</span> <span class="nx">order0</span> <span class="o">*</span><span class="kt">uint16</span><span class="p">,</span> <span class="nx">pc0</span> <span class="o">*</span><span class="kt">uintptr</span><span class="p">,</span> <span class="nx">nsends</span><span class="p">,</span> <span class="nx">nrecvs</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">block</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">debugSelect</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;select: cas0=&#34;</span><span class="p">,</span> <span class="nx">cas0</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// NOTE: In order to maintain a lean stack size, the number of scases
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// is capped at 65536.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">cas1</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">]</span><span class="nx">scase</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">cas0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">order1</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">]</span><span class="kt">uint16</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">order0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// send + recv æ•°é‡å’Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ncases</span> <span class="o">:=</span> <span class="nx">nsends</span> <span class="o">+</span> <span class="nx">nrecvs</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// cases é›†ï¼ŒæŒ‰ç…§ send + recv é¡ºåºç»„æˆçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">scases</span> <span class="o">:=</span> <span class="nx">cas1</span><span class="p">[:</span><span class="nx">ncases</span><span class="p">:</span><span class="nx">ncases</span><span class="p">]</span> <span class="c1">// select caseé›†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è½®è¯¢é›†,è®°å½•çš„æ˜¯scasesçš„ä¸‹æ ‡,ç°åœ¨æ˜¯ç©ºçš„ã€‚åé¢ä¹±åºå¡«å…¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">pollorder</span> <span class="o">:=</span> <span class="nx">order1</span><span class="p">[:</span><span class="nx">ncases</span><span class="p">:</span><span class="nx">ncases</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl">    <span class="c1">// lockorder ç”¨äºæŒ‰channelåœ°å€å‡åºæ’åºï¼Œæ‰€ä»¥æ–¹ä¾¿Lock channelçš„ä½œç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">lockorder</span> <span class="o">:=</span> <span class="nx">order1</span><span class="p">[</span><span class="nx">ncases</span><span class="p">:][:</span><span class="nx">ncases</span><span class="p">:</span><span class="nx">ncases</span><span class="p">]</span> <span class="c1">// locké›†,ç°åœ¨æ˜¯ç©ºçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// NOTE: pollorder/lockorder&#39;s underlying array was not zero-initialized by compiler.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Even when raceenabled is true, there might be select
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// statements in packages compiled without -race (e.g.,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ensureSigM in runtime/signal_unix.go).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">pcs</span> <span class="p">[]</span><span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="o">&amp;&amp;</span> <span class="nx">pc0</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pc1</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">]</span><span class="kt">uintptr</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">pc0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pcs</span> <span class="p">=</span> <span class="nx">pc1</span><span class="p">[:</span><span class="nx">ncases</span><span class="p">:</span><span class="nx">ncases</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">casePC</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">casi</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">uintptr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">pcs</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">pcs</span><span class="p">[</span><span class="nx">casi</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">t0</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">blockprofilerate</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">t0</span> <span class="p">=</span> <span class="nf">cputicks</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// The compiler rewrites selects that statically have
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// only 0 or 1 cases plus default into simpler constructs.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// The only way we can end up with such small sel.ncase
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// values here is for a larger select in which most channels
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// have been nilled out. The general code handles those
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// cases correctly, and they are rare enough not to bother
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// optimizing (and needing to test).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) ä¹±åº pollorderï¼Œä¸ºåé¢selectçš„éšæœºæ€§å·¦å‡†å¤‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// generate permuted order
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç”Ÿæˆæ’åˆ—çš„ orderã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">norder</span> <span class="o">:=</span> <span class="mi">0</span> <span class="c1">// æœ‰æ•ˆçš„æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// éšæœºæ‰“ä¹± scases å¹¶æŠŠæ‰“ä¹±ç»“æœä¸‹æ ‡å­˜å…¥ pollorder ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å‚çœ‹ä¸‹é¢çš„ã€å›¾ä¸€ã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">scases</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">cas</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">scases</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Omit cases without channels from the poll and lock orders.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä» poll å’Œ lock orders ä¸­çœç•¥æ²¡æœ‰ channels çš„æƒ…å†µã€‚ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// nil çš„ channel ä¼šè¢«ä¸¢å¼ƒã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">c</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span> <span class="p">=</span> <span class="kc">nil</span> <span class="c1">// allow GC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ç”Ÿæˆéšæœºæ•° [0, norder + 1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">j</span> <span class="o">:=</span> <span class="nf">fastrandn</span><span class="p">(</span><span class="nb">uint32</span><span class="p">(</span><span class="nx">norder</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pollorder</span><span class="p">[</span><span class="nx">norder</span><span class="p">]</span> <span class="p">=</span> <span class="nx">pollorder</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pollorder</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nb">uint16</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">norder</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pollorder</span> <span class="p">=</span> <span class="nx">pollorder</span><span class="p">[:</span><span class="nx">norder</span><span class="p">]</span> <span class="c1">// æ­¤æ—¶pollorderæ˜¯æ‰“ä¹±çš„è½®è¯¢é›†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">lockorder</span> <span class="p">=</span> <span class="nx">lockorder</span><span class="p">[:</span><span class="nx">norder</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2) lockorder æŒ‰ channel åœ°å€æ’åºï¼Œä¸ºäº†åé¢ all lock å‡†å¤‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æŒ‰ç…§åœ°å€å‡åºæ’åºæœ‰åŠ©äºåˆ¤æ–­åŒä¸€ä¸ªchannelåœ¨å¤šä¸ª case ä¸­çš„æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// sort the cases by Hchan address to get the locking order.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// simple heap sort, to guarantee n log n time and constant stack footprint.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å°†casesæŒ‰ç…§Hchanåœ°å€æ’åºå¾—åˆ° locking orderã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç®€å•çš„å †æ’åºï¼Œä¿è¯ n log n æ—¶é—´å’Œæ’å®šçš„æ ˆå ç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å‚çœ‹ä¸‹é¢çš„ã€å›¾ä¸€ã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">lockorder</span> <span class="p">{</span> <span class="c1">// æŒ‰ç…§channelåœ°å€æ’åºå¹¶è®°å½•åœ¨lockorderä¸­å‡åºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">j</span> <span class="o">:=</span> <span class="nx">i</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Start with the pollorder to permute cases on the same channel.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">c</span> <span class="o">:=</span> <span class="nx">scases</span><span class="p">[</span><span class="nx">pollorder</span><span class="p">[</span><span class="nx">i</span><span class="p">]].</span><span class="nx">c</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æŒ‰ç…§ channel çš„åœ°å€æ’åº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="nx">j</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">scases</span><span class="p">[</span><span class="nx">lockorder</span><span class="p">[(</span><span class="nx">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]].</span><span class="nx">c</span><span class="p">.</span><span class="nf">sortkey</span><span class="p">()</span> <span class="p">&lt;</span> <span class="nx">c</span><span class="p">.</span><span class="nf">sortkey</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">k</span> <span class="o">:=</span> <span class="p">(</span><span class="nx">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">            <span class="nx">lockorder</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">lockorder</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="nx">j</span> <span class="p">=</span> <span class="nx">k</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">lockorder</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">pollorder</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">lockorder</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">o</span> <span class="o">:=</span> <span class="nx">lockorder</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span> <span class="o">:=</span> <span class="nx">scases</span><span class="p">[</span><span class="nx">o</span><span class="p">].</span><span class="nx">c</span>
</span></span><span class="line"><span class="cl">        <span class="nx">lockorder</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">lockorder</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nx">j</span> <span class="o">:=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">k</span> <span class="o">:=</span> <span class="nx">j</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">k</span> <span class="o">&gt;=</span> <span class="nx">i</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">k</span><span class="o">+</span><span class="mi">1</span> <span class="p">&lt;</span> <span class="nx">i</span> <span class="o">&amp;&amp;</span> <span class="nx">scases</span><span class="p">[</span><span class="nx">lockorder</span><span class="p">[</span><span class="nx">k</span><span class="p">]].</span><span class="nx">c</span><span class="p">.</span><span class="nf">sortkey</span><span class="p">()</span> <span class="p">&lt;</span> <span class="nx">scases</span><span class="p">[</span><span class="nx">lockorder</span><span class="p">[</span><span class="nx">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]].</span><span class="nx">c</span><span class="p">.</span><span class="nf">sortkey</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">k</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nf">sortkey</span><span class="p">()</span> <span class="p">&lt;</span> <span class="nx">scases</span><span class="p">[</span><span class="nx">lockorder</span><span class="p">[</span><span class="nx">k</span><span class="p">]].</span><span class="nx">c</span><span class="p">.</span><span class="nf">sortkey</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">lockorder</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">lockorder</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="nx">j</span> <span class="p">=</span> <span class="nx">k</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">lockorder</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">o</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">debugSelect</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">lockorder</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">scases</span><span class="p">[</span><span class="nx">lockorder</span><span class="p">[</span><span class="nx">i</span><span class="p">]].</span><span class="nx">c</span><span class="p">.</span><span class="nf">sortkey</span><span class="p">()</span> <span class="p">&gt;</span> <span class="nx">scases</span><span class="p">[</span><span class="nx">lockorder</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]].</span><span class="nx">c</span><span class="p">.</span><span class="nf">sortkey</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s">&#34;i=&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="s">&#34; x=&#34;</span><span class="p">,</span> <span class="nx">lockorder</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="s">&#34; y=&#34;</span><span class="p">,</span> <span class="nx">lockorder</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;select: broken sort&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3) æ‰€æœ‰çš„ sendã€recv è·å– lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// lock all the channels involved in the select
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é”å®šselectä¸­æ¶‰åŠçš„æ‰€æœ‰channelsã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">sellock</span><span class="p">(</span><span class="nx">scases</span><span class="p">,</span> <span class="nx">lockorder</span><span class="p">)</span>  <span class="c1">// lock channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span>     <span class="o">*</span><span class="nx">g</span>               <span class="c1">// æ‰¾åˆ°çš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sg</span>     <span class="o">*</span><span class="nx">sudog</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span>      <span class="o">*</span><span class="nx">hchan</span>           <span class="c1">// channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">k</span>      <span class="o">*</span><span class="nx">scase</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sglist</span> <span class="o">*</span><span class="nx">sudog</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sgnext</span> <span class="o">*</span><span class="nx">sudog</span>
</span></span><span class="line"><span class="cl">        <span class="nx">qp</span>     <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl">        <span class="nx">nextp</span>  <span class="o">**</span><span class="nx">sudog</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// pass 1 - look for something already waiting
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// pass 1 - å¯»æ‰¾å·²ç»åœ¨ç­‰å¾…çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">casi</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">cas</span> <span class="o">*</span><span class="nx">scase</span>	
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">caseSuccess</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">caseReleaseTime</span> <span class="kt">int64</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">recvOK</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è½®åº order
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">casei</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pollorder</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">casi</span> <span class="p">=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">casei</span><span class="p">)</span>   <span class="c1">// é€‰ä¸­ä¸‹æ ‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">cas</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">scases</span><span class="p">[</span><span class="nx">casi</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span> <span class="p">=</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">c</span>           <span class="c1">// channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">// recv æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">casi</span> <span class="o">&gt;=</span> <span class="nx">nsends</span> <span class="p">{</span> <span class="c1">// æ³¨æ„ recv å…ˆåˆ¤æ–­çš„èƒ½å¦æˆåŠŸï¼Œå†åˆ¤æ–­çš„ close
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">sg</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">sendq</span><span class="p">.</span><span class="nf">dequeue</span><span class="p">()</span> <span class="c1">// sendqä¸­å¯»æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">sg</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="nx">recv</span>          <span class="c1">// æ‰¾åˆ°ï¼Œå»recv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// send buf ä¸­æœ‰æ•°æ®ï¼Œå»bufrecv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">qcount</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="nx">bufrecv</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å½“å‰recvæ“ä½œæ²¡å®Œæˆï¼Œcloseå…³é—­äº†ï¼Œå»rclose
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">closed</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="nx">rclose</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// send æ“ä½œã€‚æ³¨æ„ send å…ˆåˆ¤æ–­çš„ closeï¼Œå†åˆ¤æ–­èƒ½å¦æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">racereadpc</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nf">raceaddr</span><span class="p">(),</span> <span class="nf">casePC</span><span class="p">(</span><span class="nx">casi</span><span class="p">),</span> <span class="nx">chansendpc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// channel å·²ç»å…³é—­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">closed</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="nx">sclose</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sg</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvq</span><span class="p">.</span><span class="nf">dequeue</span><span class="p">()</span> <span class="c1">// recvqä¸­å¯»æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">sg</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="nx">send</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// buf ä¸­è¿˜æœ‰å®¹é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">qcount</span> <span class="p">&lt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">dataqsiz</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="nx">bufsend</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 4) ä»¥ä¸Šéƒ½æ²¡æœ‰èƒ½ç«‹å³å®Œæˆæ—¶ã€‚å¯ä»¥èµ°defaultåˆ†æ”¯ä¸ï¼Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// block ä¸ºfalseæ—¶å­˜åœ¨defaultåˆ†æ”¯ï¼Œä¸æƒ³é˜»å¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// block ä¸ºtrueæ—¶ä¸å­˜åœ¨defaultåˆ†æ”¯ï¼Œé˜»å¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nx">block</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">selunlock</span><span class="p">(</span><span class="nx">scases</span><span class="p">,</span> <span class="nx">lockorder</span><span class="p">)</span> <span class="c1">// all channel unlock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">casi</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">// -1 æ²¡æ‰¾åˆ°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">goto</span> <span class="nx">retc</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 5) æŠŠå½“å‰ goroutine æŒ‚åœ¨æ‰€æœ‰ channel ç­‰å¾…ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// pass 2 - enqueue on all chans
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// pass 2 - å¯¹æ‰€æœ‰chanè¿›è¡Œæ’é˜Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span> <span class="p">=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">waiting</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;gp.waiting != nil&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nextp</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">waiting</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// éå† lockorderï¼Œè¿™é‡Œå½“å‰goroutineè¢«åŠ å…¥åˆ°å¤šä¸ªchannelä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">casei</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">lockorder</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">casi</span> <span class="p">=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">casei</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">cas</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">scases</span><span class="p">[</span><span class="nx">casi</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span> <span class="p">=</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">c</span> <span class="c1">// channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sg</span> <span class="o">:=</span> <span class="nf">acquireSudog</span><span class="p">()</span> <span class="c1">// å¯»æ‰¾ä¸€ä¸ª*sudog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sg</span><span class="p">.</span><span class="nx">g</span> <span class="p">=</span> <span class="nx">gp</span> <span class="c1">// è®°å½•å½“å‰goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sg</span><span class="p">.</span><span class="nx">isSelect</span> <span class="p">=</span> <span class="kc">true</span> <span class="c1">// æ ‡è®°æ˜¯åœ¨select
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// No stack splits between assigning elem and enqueuing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// sg on gp.waiting where copystack can find it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sg</span><span class="p">.</span><span class="nx">elem</span> <span class="p">=</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sg</span><span class="p">.</span><span class="nx">releasetime</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">t0</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sg</span><span class="p">.</span><span class="nx">releasetime</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sg</span><span class="p">.</span><span class="nx">c</span> <span class="p">=</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Construct waiting list in lock order.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ‰€æœ‰çš„ sudog ç»„æˆä¸ªé“¾è¡¨ï¼Œæœ‰ä¸¤ä¸ªä½œç”¨ï¼šã€å‚çœ‹ä¸‹é¢å›¾ç‰‡ã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//   1. åç»­selparkcommitå‡½æ•°é€šè¿‡sudog.cè§£é”æ‰€æœ‰çš„ channelã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//   2. å°±ç»ªåç”¨äºåˆ¤æ–­æ˜¯é‚£ä¸ª case å°±ç»ªäº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">*</span><span class="nx">nextp</span> <span class="p">=</span> <span class="nx">sg</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// é€šè¿‡ waitlink é“¾æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">nextp</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">sg</span><span class="p">.</span><span class="nx">waitlink</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// åŠ å…¥é˜Ÿåˆ—ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">casi</span> <span class="p">&lt;</span> <span class="nx">nsends</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">c</span><span class="p">.</span><span class="nx">sendq</span><span class="p">.</span><span class="nf">enqueue</span><span class="p">(</span><span class="nx">sg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">c</span><span class="p">.</span><span class="nx">recvq</span><span class="p">.</span><span class="nf">enqueue</span><span class="p">(</span><span class="nx">sg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// wait for someone to wake us up
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç­‰ç€æœ‰äººå«é†’æˆ‘ä»¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">param</span> <span class="p">=</span> <span class="kc">nil</span> <span class="c1">// åœ¨è¢«å”¤é†’æ—¶ä¼šç»™paramå‚æ•°ä¸Šèµ‹å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Signal to anyone trying to shrink our stack that we&#39;re about
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// to park on a channel. The window between when this G&#39;s status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// changes and when we set gp.activeStackChans is not safe for
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// stack shrinking.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å‚çœ‹ channel æ–‡æ¡£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store8</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">parkingOnChan</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// parkingOnChan = 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æŒ‚èµ·ï¼Œè¿›å…¥è°ƒåº¦å¾ªç¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">gopark</span><span class="p">(</span><span class="nx">selparkcommit</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">waitReasonSelect</span><span class="p">,</span> <span class="nx">traceEvGoBlockSelect</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 6) å†æ¬¡è¢«å”¤é†’æ—¶ï¼Œ... ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">activeStackChans</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å…¨éƒ¨channelsé”ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">sellock</span><span class="p">(</span><span class="nx">scases</span><span class="p">,</span> <span class="nx">lockorder</span><span class="p">)</span> <span class="c1">// all channel lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ ‡è®°ä¸º0ï¼Œè¡¨ç¤ºselectå·²å®Œæˆã€‚æ­¤æ—¶æ‰€æœ‰çš„channelséƒ½é”ä½äº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">selectDone</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¢«å”¤é†’çš„goroutineçš„*sudogæ”¾åœ¨paramä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç›´æ¥è·å–ä½¿ç”¨ï¼Œå…³äº gp.param çš„éƒ¨åˆ†èµ‹å€¼ä»£ç åœ¨ chan sendå’Œrecvä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sg</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">sudog</span><span class="p">)(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">param</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">param</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// pass 3 - dequeue from unsuccessful chans
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// otherwise they stack up on quiet channels
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// record the successful case, if any.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// We singly-linked up the SudoGs in lock order.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">casi</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cas</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nx">caseSuccess</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åœ¨ waiting ä¸Šç­‰å¾…ç€å¾ˆå¤šgoroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sglist</span> <span class="p">=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">waiting</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Clear all elem before unlinking from gp.waiting.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨ä»gp.waitingæ–­å¼€è¿æ¥å‰æ¸…é™¤æ‰€æœ‰elemã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">sg1</span> <span class="o">:=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">waiting</span><span class="p">;</span> <span class="nx">sg1</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">sg1</span> <span class="p">=</span> <span class="nx">sg1</span><span class="p">.</span><span class="nx">waitlink</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sg1</span><span class="p">.</span><span class="nx">isSelect</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sg1</span><span class="p">.</span><span class="nx">elem</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sg1</span><span class="p">.</span><span class="nx">c</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">waiting</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 7) éå† lockorderï¼Œå¯»æ‰¾æ˜¯å“ªä¸ªcaseå°±ç»ªäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">casei</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">lockorder</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">k</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">scases</span><span class="p">[</span><span class="nx">casei</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">sg</span> <span class="o">==</span> <span class="nx">sglist</span> <span class="p">{</span> <span class="c1">// æ‰¾åˆ°å°±ç»ªçš„ case
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// sg has already been dequeued by the G that woke us up.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">casi</span> <span class="p">=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">casei</span><span class="p">)</span> <span class="c1">// æ‰¾åˆ°å°±ç»ªçš„ case
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">cas</span> <span class="p">=</span> <span class="nx">k</span>
</span></span><span class="line"><span class="cl">            <span class="nx">caseSuccess</span> <span class="p">=</span> <span class="nx">sglist</span><span class="p">.</span><span class="nx">success</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">sglist</span><span class="p">.</span><span class="nx">releasetime</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">caseReleaseTime</span> <span class="p">=</span> <span class="nx">sglist</span><span class="p">.</span><span class="nx">releasetime</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// ç§»é™¤æ²¡å°±ç»ªçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">c</span> <span class="p">=</span> <span class="nx">k</span><span class="p">.</span><span class="nx">c</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ä» channel ä¸­ç§»é™¤ sglist
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å› ä¸ºå…¶ä»– channel ä¸­è¿˜æŒ‚èµ·çš„å‘¢ï¼Œè¦ç§»é™¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nx">casei</span><span class="p">)</span> <span class="p">&lt;</span> <span class="nx">nsends</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">c</span><span class="p">.</span><span class="nx">sendq</span><span class="p">.</span><span class="nf">dequeueSudoG</span><span class="p">(</span><span class="nx">sglist</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">c</span><span class="p">.</span><span class="nx">recvq</span><span class="p">.</span><span class="nf">dequeueSudoG</span><span class="p">(</span><span class="nx">sglist</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sgnext</span> <span class="p">=</span> <span class="nx">sglist</span><span class="p">.</span><span class="nx">waitlink</span> <span class="c1">// æ¢ä¸‹ä¸€ä¸ª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sglist</span><span class="p">.</span><span class="nx">waitlink</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="nf">releaseSudog</span><span class="p">(</span><span class="nx">sglist</span><span class="p">)</span> <span class="c1">// å›æ”¶*sudog
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sglist</span> <span class="p">=</span> <span class="nx">sgnext</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">cas</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;selectgo: bad wakeup&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">c</span> <span class="p">=</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">c</span> <span class="c1">// channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">debugSelect</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;wait-return: cas0=&#34;</span><span class="p">,</span> <span class="nx">cas0</span><span class="p">,</span> <span class="s">&#34; c=&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="s">&#34; cas=&#34;</span><span class="p">,</span> <span class="nx">cas</span><span class="p">,</span> <span class="s">&#34; send=&#34;</span><span class="p">,</span> <span class="nx">casi</span> <span class="p">&lt;</span> <span class="nx">nsends</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// send æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">casi</span> <span class="p">&lt;</span> <span class="nx">nsends</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// caseSuccess = trueæˆåŠŸï¼Œfalseç”±äºclosedå‡½æ•°å…³é—­è§¦å‘ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nx">caseSuccess</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="nx">sclose</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// recv æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">recvOK</span> <span class="p">=</span> <span class="nx">caseSuccess</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">casi</span> <span class="p">&lt;</span> <span class="nx">nsends</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">raceReadObjectPC</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nf">casePC</span><span class="p">(</span><span class="nx">casi</span><span class="p">),</span> <span class="nx">chansendpc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">raceWriteObjectPC</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nf">casePC</span><span class="p">(</span><span class="nx">casi</span><span class="p">),</span> <span class="nx">chanrecvpc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">msanenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">casi</span> <span class="p">&lt;</span> <span class="nx">nsends</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">msanread</span><span class="p">(</span><span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">msanwrite</span><span class="p">(</span><span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">asanenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">casi</span> <span class="p">&lt;</span> <span class="nx">nsends</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">asanread</span><span class="p">(</span><span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">asanwrite</span><span class="p">(</span><span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">selunlock</span><span class="p">(</span><span class="nx">scases</span><span class="p">,</span> <span class="nx">lockorder</span><span class="p">)</span> <span class="c1">// all channel unlock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">goto</span> <span class="nx">retc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">bufrecv</span><span class="p">:</span> <span class="c1">// buf ä¸­æœ‰æ•°æ®, recvæ“ä½œã€ep &lt;- cã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// can receive from buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">raceWriteObjectPC</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nf">casePC</span><span class="p">(</span><span class="nx">casi</span><span class="p">),</span> <span class="nx">chanrecvpc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">racenotify</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">msanenabled</span> <span class="o">&amp;&amp;</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">msanwrite</span><span class="p">(</span><span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">asanenabled</span> <span class="o">&amp;&amp;</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">asanwrite</span><span class="p">(</span><span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">recvOK</span> <span class="p">=</span> <span class="kc">true</span> <span class="c1">// æ•°æ®äº¤æ¢æˆåŠŸæ ‡è¯†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">qp</span> <span class="p">=</span> <span class="nf">chanbuf</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ•°æ®ç»™åˆ°ç­‰å¾…çš„å˜é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">typedmemmove</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">qp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">typedmemclr</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nx">qp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¤„ç† buf çš„ä¸‹æ ‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span> <span class="o">==</span> <span class="nx">c</span><span class="p">.</span><span class="nx">dataqsiz</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nx">recvx</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">.</span><span class="nx">qcount</span><span class="o">--</span>
</span></span><span class="line"><span class="cl">    <span class="nf">selunlock</span><span class="p">(</span><span class="nx">scases</span><span class="p">,</span> <span class="nx">lockorder</span><span class="p">)</span> <span class="c1">// all channel unlock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">goto</span> <span class="nx">retc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">bufsend</span><span class="p">:</span> <span class="c1">// buf ä¸­è¿˜æœ‰å®¹é‡ï¼Œsendæ“ä½œã€c &lt;- epã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// can send to buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">racenotify</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">sendx</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">raceReadObjectPC</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nf">casePC</span><span class="p">(</span><span class="nx">casi</span><span class="p">),</span> <span class="nx">chansendpc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">msanenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">msanread</span><span class="p">(</span><span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">asanenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">asanread</span><span class="p">(</span><span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ•°æ®è¿ç§»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">typedmemmove</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nf">chanbuf</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">sendx</span><span class="p">),</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¤„ç†ä¸‹æ ‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span><span class="p">.</span><span class="nx">sendx</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">sendx</span> <span class="o">==</span> <span class="nx">c</span><span class="p">.</span><span class="nx">dataqsiz</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nx">sendx</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">.</span><span class="nx">qcount</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="nf">selunlock</span><span class="p">(</span><span class="nx">scases</span><span class="p">,</span> <span class="nx">lockorder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="nx">retc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">recv</span><span class="p">:</span> <span class="c1">// sendq ä¸­è·å–åˆ° sg goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// can receive from sleeping sender (sg)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ•°æ®åœ¨æŒ‚èµ·çš„ send çš„ goroutine é‡Œé¢ï¼Œè°ƒç”¨recvå–äº¤æ¢æ•°æ®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">recv</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">sg</span><span class="p">,</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nf">selunlock</span><span class="p">(</span><span class="nx">scases</span><span class="p">,</span> <span class="nx">lockorder</span><span class="p">)</span> <span class="p">},</span> <span class="mi">2</span><span class="p">)</span> <span class="c1">// æ¢å¤å¹¶è§£é”all channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">debugSelect</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;syncrecv: cas0=&#34;</span><span class="p">,</span> <span class="nx">cas0</span><span class="p">,</span> <span class="s">&#34; c=&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">recvOK</span> <span class="p">=</span> <span class="kc">true</span> <span class="c1">// recvæ“ä½œæˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">goto</span> <span class="nx">retc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">rclose</span><span class="p">:</span> <span class="c1">// channel å·²ç»å…³é—­, recv æ“ä½œæ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// read at end of closed channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">selunlock</span><span class="p">(</span><span class="nx">scases</span><span class="p">,</span> <span class="nx">lockorder</span><span class="p">)</span> <span class="c1">// all channel unlock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">recvOK</span> <span class="p">=</span> <span class="kc">false</span> <span class="c1">// channel å…³é—­çš„ recv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ¥å—å€¼è®¾ç½®æˆé»˜è®¤é›¶å€¼ï¼Œå› ä¸ºcloseäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">typedmemclr</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">raceacquire</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nf">raceaddr</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="nx">retc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">send</span><span class="p">:</span> <span class="c1">// recvq ä¸­æœ‰ç­‰å¾… sg goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// can send to a sleeping receiver (sg)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">raceReadObjectPC</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">,</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nf">casePC</span><span class="p">(</span><span class="nx">casi</span><span class="p">),</span> <span class="nx">chansendpc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">msanenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">msanread</span><span class="p">(</span><span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">asanenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">asanread</span><span class="p">(</span><span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">elemtype</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ•°æ®åœ¨æŒ‚èµ·çš„ recv çš„ goroutine é‡Œé¢ï¼Œè°ƒç”¨ send å»äº¤æ¢æ•°æ®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">send</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">sg</span><span class="p">,</span> <span class="nx">cas</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nf">selunlock</span><span class="p">(</span><span class="nx">scases</span><span class="p">,</span> <span class="nx">lockorder</span><span class="p">)</span> <span class="p">},</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">debugSelect</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;syncsend: cas0=&#34;</span><span class="p">,</span> <span class="nx">cas0</span><span class="p">,</span> <span class="s">&#34; c=&#34;</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="nx">retc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">retc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">caseReleaseTime</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">blockevent</span><span class="p">(</span><span class="nx">caseReleaseTime</span><span class="o">-</span><span class="nx">t0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">casi</span><span class="p">,</span> <span class="nx">recvOK</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">sclose</span><span class="p">:</span> <span class="c1">// channel å·²ç»å…³é—­ï¼Œsend æ“ä½œæ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// send on closed channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">selunlock</span><span class="p">(</span><span class="nx">scases</span><span class="p">,</span> <span class="nx">lockorder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">panic</span><span class="p">(</span><span class="nf">plainError</span><span class="p">(</span><span class="s">&#34;send on closed channel&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/channel-006.png" alt=""  />

<img loading="lazy" src="../images/channel-007.png" alt=""  />
</p>
<h3 id="sellock">sellock()<a hidden class="anchor" aria-hidden="true" href="#sellock">#</a></h3>
<ol>
<li>æ‰€æœ‰ case çš„ sendã€recv æ“ä½œçš„è·å– hmap.lock äº’æ–¥é”ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">sellock</span><span class="p">(</span><span class="nx">scases</span> <span class="p">[]</span><span class="nx">scase</span><span class="p">,</span> <span class="nx">lockorder</span> <span class="p">[]</span><span class="kt">uint16</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">hchan</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æŒ‰ç…§lockorderéå†ï¼Œå› ä¸ºæ˜¯å‡åºï¼Œæ‰€ä»¥ç›¸åŒçš„channelåœ¨ä¸€èµ·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">o</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">lockorder</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c0</span> <span class="o">:=</span> <span class="nx">scases</span><span class="p">[</span><span class="nx">o</span><span class="p">].</span><span class="nx">c</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">c0</span> <span class="o">!=</span> <span class="nx">c</span> <span class="p">{</span> <span class="c1">// å¦‚æœæ˜¯åŒä¸€ä¸ª channel è·³è¿‡å®ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">c</span> <span class="p">=</span> <span class="nx">c0</span>
</span></span><span class="line"><span class="cl">            <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span> <span class="c1">// mutex lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="selunlock">selunlock()<a hidden class="anchor" aria-hidden="true" href="#selunlock">#</a></h3>
<ol>
<li>æ‰€æœ‰ case çš„ sendã€recv æ“ä½œçš„é‡Šæ”¾ hmap.lock äº’æ–¥é”ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">selunlock</span><span class="p">(</span><span class="nx">scases</span> <span class="p">[]</span><span class="nx">scase</span><span class="p">,</span> <span class="nx">lockorder</span> <span class="p">[]</span><span class="kt">uint16</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// We must be very careful here to not touch sel after we have unlocked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the last lock, because sel can be freed right after the last unlock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Consider the following situation.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// First M calls runtimeÂ·park() in runtimeÂ·selectgo() passing the sel.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Once runtimeÂ·park() has unlocked the last lock, another M makes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the G that calls select runnable again and schedules it for execution.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// When the G runs on another M, it locks all the locks and frees sel.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Now if the first M touches sel, it will access freed memory.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">lockorder</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span> <span class="o">:=</span> <span class="nx">scases</span><span class="p">[</span><span class="nx">lockorder</span><span class="p">[</span><span class="nx">i</span><span class="p">]].</span><span class="nx">c</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœæ˜¯åŒä¸€ä¸ª channel è·³è¿‡å®ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">i</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span> <span class="o">==</span> <span class="nx">scases</span><span class="p">[</span><span class="nx">lockorder</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]].</span><span class="nx">c</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span> <span class="c1">// will unlock it on the next iteration
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="selparkcommit">selparkcommit()<a hidden class="anchor" aria-hidden="true" href="#selparkcommit">#</a></h3>
<ol>
<li>å½“å‰ select æ²¡æœ‰å°±ç»ª case å¯¼è‡´å½“å‰ goroutine è¢«æŒ‚èµ·å‰æ‰§è¡Œçš„å‡½æ•°ã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">selparkcommit</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">_</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// There are unlocked sudogs that point into gp&#39;s stack. Stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// copying must lock the channels of those sudogs.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Set activeStackChans here instead of before we try parking
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// because we could self-deadlock in stack growth on a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// channel lock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">activeStackChans</span> <span class="p">=</span> <span class="kc">true</span> <span class="c1">// å‚çœ‹channelæ–‡æ¡£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Mark that it&#39;s safe for stack shrinking to occur now,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// because any thread acquiring this G&#39;s stack for shrinking
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// is guaranteed to observe activeStackChans after this store.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store8</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">parkingOnChan</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// å‚çœ‹channelæ–‡æ¡£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Make sure we unlock after setting activeStackChans and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// unsetting parkingOnChan. The moment we unlock any of the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// channel locks we risk gp getting readied by a channel operation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// and so gp could continue running before everything before the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// unlock is visible (even to gp itself).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// This must not access gp&#39;s stack (see gopark). In
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// particular, it must not access the *hselect. That&#39;s okay,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// because by the time this is called, gp.waiting has all
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// channels in lock order.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">lastc</span> <span class="o">*</span><span class="nx">hchan</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¾æ¬¡channelè§£é”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">sg</span> <span class="o">:=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">waiting</span><span class="p">;</span> <span class="nx">sg</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">sg</span> <span class="p">=</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">waitlink</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">c</span> <span class="o">!=</span> <span class="nx">lastc</span> <span class="o">&amp;&amp;</span> <span class="nx">lastc</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// As soon as we unlock the channel, fields in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// any sudog with that channel may change,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// including c and waitlink. Since multiple
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// sudogs may have the same channel, we unlock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// only after we&#39;ve passed the last instance
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// of a channel.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lastc</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">lastc</span> <span class="p">=</span> <span class="nx">sg</span><span class="p">.</span><span class="nx">c</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">lastc</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lastc</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="selectgo-å‚æ•°ç»„æˆ">selectgo å‚æ•°ç»„æˆ<a hidden class="anchor" aria-hidden="true" href="#selectgo-å‚æ•°ç»„æˆ">#</a></h2>
<p>ä»¥ä¸‹éƒ½æ˜¯ä»‹ç»selectgo()å‚æ•°çš„ç»„æˆï¼Œå¯¹äºç†è§£goselectå¢åŠ å¸®åŠ©ã€‚</p>
<h3 id="type-runtimeselect-struct">type runtimeSelect struct<a hidden class="anchor" aria-hidden="true" href="#type-runtimeselect-struct">#</a></h3>
<ol>
<li>runtimeSelect æ˜¯ä¼ é€’ç»™ rselect çš„ä¸€ä¸ª caseã€‚</li>
<li>å¿…é¡»åŒ¹é… ../reflect/value.go:/runtimeSelectã€‚</li>
<li>è¯¥ç»“æ„ç†è§£ä¸ºselect caseä¸­çš„æ‰€æœ‰caseç»„æˆçš„é›†åˆã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// A runtimeSelect is a single case passed to rselect.
</span></span></span><span class="line"><span class="cl"><span class="c1">// This must match ../reflect/value.go:/runtimeSelect
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">runtimeSelect</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// channel ç±»å‹ï¼ŒåŒ…å«ï¼šsendã€recvã€default ä¸‰ç§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">dir</span> <span class="nx">selectDir</span>
</span></span><span class="line"><span class="cl">    <span class="nx">typ</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// channel type (not used here)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰ case æ“ä½œæ‰€å±çš„ channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ch</span>  <span class="o">*</span><span class="nx">hchan</span>         <span class="c1">// channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// send æˆ– recv æ“ä½œæ—¶æ•°æ®çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">val</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// ptr to data (SendDir) or ptr to receive buffer (RecvDir)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/channel-004.png" alt=""  />
</p>
<h3 id="type-selectdir-int">type selectDir int<a hidden class="anchor" aria-hidden="true" href="#type-selectdir-int">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// These values must match ../reflect/value.go:/SelectDir.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">selectDir</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span>             <span class="nx">selectDir</span> <span class="p">=</span> <span class="kc">iota</span>
</span></span><span class="line"><span class="cl">    <span class="nx">selectSend</span>      <span class="c1">// case Chan &lt;- Send
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">selectRecv</span>      <span class="c1">// case &lt;-Chan:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">selectDefault</span>   <span class="c1">// default
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="reflect_rselect">reflect_rselect()<a hidden class="anchor" aria-hidden="true" href="#reflect_rselect">#</a></h3>
<ol>
<li><code>reflect_rselect</code>æ˜¯<code>select</code>å…³é”®å­—ç›¸å…³ä»£ç ã€‚</li>
<li>å¯¹äºä»£ç <code>select {}</code>ï¼Œå½“å‰<code>goroutine</code>ä¼šä¸¢å¤±å†ä¹Ÿä¸ä¼šè¢«è°ƒåº¦ã€‚</li>
<li>å‚æ•°<code>cases []runtimeSelect</code>ï¼š<code>select</code>çš„æ‰€æœ‰åˆ†æ”¯æ•°æ®ä¿¡æ¯ã€‚</li>
<li>è¿”å›å€¼<code>int</code>ï¼šè¿”å›é€‰ä¸­çš„åˆ†æ”¯ä¸‹æ ‡ã€‚</li>
</ol>
<p><img loading="lazy" src="../images/channel-005.png" alt=""  />
</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:linkname reflect_rselect reflect.rselect
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">reflect_rselect</span><span class="p">(</span><span class="nx">cases</span> <span class="p">[]</span><span class="nx">runtimeSelect</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ²¡æœ‰ case åˆ†æ”¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯¹äº `select {}` å½“å‰goroutineä¼šç›´æ¥ä¸¢å¤±
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">cases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">block</span><span class="p">()</span> <span class="c1">// gopark
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// len(cases) = send + recv + default
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sel</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">scase</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">cases</span><span class="p">))</span> <span class="c1">// scase é›†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">orig</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">cases</span><span class="p">))</span>  <span class="c1">// selä¸‹æ ‡å’Œcasesçš„å¯¹åº”å…³ç³»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸´æ—¶å˜é‡ç”¨äºä¿å­˜ send å’Œ recv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nsends</span><span class="p">,</span> <span class="nx">nrecvs</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="c1">// send And recv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ ‡è®°selectä¸­é»˜è®¤defaultåˆ†æ”¯ä¸‹æ ‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">dflt</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">// é»˜è®¤å€¼-1è¡¨ç¤ºæ²¡æœ‰é»˜è®¤defaultåˆ†æ”¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// éå†selectçš„æ‰€æœ‰caseï¼ŒåŒ…æ‹¬defaultåˆ†æ”¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä½¿ç”¨ dflt æ ‡è®° default åˆ†æ”¯çš„ä¸‹æ ‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sel æ•´ç†å­˜å‚¨ä¸º send + recv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// orig å­˜å‚¨selå’Œcasesçš„æ˜ å°„å…³ç³»ã€å‚çœ‹ä¸Šé¢&#34;å›¾ä¸€&#34;ã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">rc</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cases</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä¸´æ—¶å˜é‡ï¼Œç”¨äºè®¡ç®—å½“å‰caseåº”è¯¥æ”¾å…¥çš„ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">var</span> <span class="nx">j</span> <span class="kt">int</span> 
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">dir</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// defaultåˆ†æ”¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nx">selectDefault</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">dflt</span> <span class="p">=</span> <span class="nx">i</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// send åˆ†æ”¯ï¼šc &lt;- ep
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nx">selectSend</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ä»å‰å‘åï¼Œä¾æ¬¡æ”¾å…¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">j</span> <span class="p">=</span> <span class="nx">nsends</span> 
</span></span><span class="line"><span class="cl">            <span class="nx">nsends</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// recv åˆ†æ”¯ï¼š&lt;- c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nx">selectRecv</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ä»åå‘å‰ï¼Œä¾æ¬¡æ”¾å…¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">nrecvs</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">            <span class="nx">j</span> <span class="p">=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">cases</span><span class="p">)</span> <span class="o">-</span> <span class="nx">nrecvs</span> 
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// ä¿å­˜å¯¹åº”å…³ç³»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sel</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">scase</span><span class="p">{</span><span class="nx">c</span><span class="p">:</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">elem</span><span class="p">:</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">val</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">orig</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">i</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// for range å®Œåï¼Œsel ä¿å­˜ send + recv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// orig ä¿å­˜ sel å’Œ cases å¯¹åº”å…³ç³»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Only a default case.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä»…ä»…åªæœ‰ä¸€ä¸ª default caseã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› ä¸ºå¦‚æœä¸€ä¸ªåˆ†æ”¯éƒ½æ²¡æœ‰ï¼Œæœ€å‰é¢å°±è¿”å›äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// select {default:}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">nsends</span><span class="o">+</span><span class="nx">nrecvs</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">dflt</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Compact sel and orig if necessary.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœæœ‰å¿…è¦ä½¿sel å’Œ origç´§å‡‘ã€‚ã€å‚çœ‹ä¸Šé¢&#34;å›¾äºŒ&#34;ã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">nsends</span><span class="o">+</span><span class="nx">nrecvs</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">cases</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// å­˜åœ¨defultæ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">copy</span><span class="p">(</span><span class="nx">sel</span><span class="p">[</span><span class="nx">nsends</span><span class="p">:],</span> <span class="nx">sel</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">cases</span><span class="p">)</span><span class="o">-</span><span class="nx">nrecvs</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">        <span class="nb">copy</span><span class="p">(</span><span class="nx">orig</span><span class="p">[</span><span class="nx">nsends</span><span class="p">:],</span> <span class="nx">orig</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">cases</span><span class="p">)</span><span class="o">-</span><span class="nx">nrecvs</span><span class="p">:])</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// order é•¿åº¦æ˜¯ 2*(nsends+nrecvs)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">order</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">uint16</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="nx">nsends</span><span class="o">+</span><span class="nx">nrecvs</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">pc0</span> <span class="o">*</span><span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pcs</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">uintptr</span><span class="p">,</span> <span class="nx">nsends</span><span class="o">+</span><span class="nx">nrecvs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pcs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">selectsetpc</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pcs</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pc0</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">pcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// &amp;sel[0]ï¼šæ˜¯send+recv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// &amp;order[0]ï¼šæ˜¯ç©ºçš„ï¼Œdflt true.ä¸å­˜åœ¨defalutåˆ†æ”¯ false.å­˜åœ¨defaultåˆ†æ”¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// chosenï¼šè¡¨ç¤ºé€‰æ‹©çš„caseä¸‹æ ‡ï¼Œå¦‚æœä¸º-1æ—¶ä¸ºé»˜è®¤defaultåˆ†æ”¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// recvOKï¼šè¡¨ç¤ºæ•°æ®æ˜¯å¦äº¤æ¢æˆåŠŸï¼Œtrue.æˆåŠŸ false.å¤±è´¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä»caseåˆ†æ”¯ä¸­é€‰æ‹©ä¸€ä¸ªå°±ç»ªçš„channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">chosen</span><span class="p">,</span> <span class="nx">recvOK</span> <span class="o">:=</span> <span class="nf">selectgo</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="nx">order</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">pc0</span><span class="p">,</span> <span class="nx">nsends</span><span class="p">,</span> <span class="nx">nrecvs</span><span class="p">,</span> <span class="nx">dflt</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Translate chosen back to caller&#39;s ordering.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// chosen &lt; 0 é€‰ä¸­é»˜è®¤åˆ†æ”¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">chosen</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">chosen</span> <span class="p">=</span> <span class="nx">dflt</span> <span class="c1">// é»˜è®¤default
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">chosen</span> <span class="p">=</span> <span class="nx">orig</span><span class="p">[</span><span class="nx">chosen</span><span class="p">]</span> <span class="c1">// case
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">chosen</span><span class="p">,</span> <span class="nx">recvOK</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="block">block()<a hidden class="anchor" aria-hidden="true" href="#block">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">block</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ³¨æ„ï¼šè¿™é‡Œç¬¬ä¸€å’Œç¬¬äºŒä¸ªå‚æ•°éƒ½ä¸ºnilï¼Œè¡¨æ˜å½“å‰goroutineè¢«ä¸¢å¼ƒäº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">gopark</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">waitReasonSelectNoCases</span><span class="p">,</span> <span class="nx">traceEvGoStop</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// forever
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æ±‡ç¼–éªŒè¯">æ±‡ç¼–éªŒè¯<a hidden class="anchor" aria-hidden="true" href="#æ±‡ç¼–éªŒè¯">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ch1</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ch2</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">v</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">ch1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">println</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">ch2</span> <span class="o">&lt;-</span> <span class="mi">10</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">GoProject</span><span class="err">/</span><span class="no">small</span><span class="err">/</span><span class="no">tt1.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459580</span>      <span class="mi">4</span><span class="no">c8d6424c8</span>          <span class="no">LEAQ</span> <span class="p">-</span><span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">R12</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459585</span>      <span class="mi">4</span><span class="no">d3b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">R12</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459589</span>      <span class="mi">0</span><span class="no">f8632010000</span>        <span class="no">JBE</span> <span class="mi">0x4596c1</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45958f</span>      <span class="mi">4881</span><span class="no">ecb8000000</span>      <span class="no">SUBQ</span> <span class="no">$0xb8</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459596</span>      <span class="mi">4889</span><span class="no">ac24b0000000</span>    <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0xb0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45959e</span>      <span class="mi">488</span><span class="no">dac24b0000000</span>    <span class="no">LEAQ</span> <span class="mi">0xb0</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ch1</span> <span class="p">:</span><span class="err">=</span> <span class="no">make</span><span class="p">(</span><span class="no">chan</span> <span class="no">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4595a6</span>      <span class="mi">488</span><span class="no">d0513490000</span>      <span class="no">LEAQ</span> <span class="mi">0x4913</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4595ad</span>      <span class="mi">31</span><span class="no">db</span>                <span class="no">XORL</span> <span class="no">BX</span><span class="p">,</span> <span class="no">BX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4595af</span>      <span class="no">e8eca6faff</span>          <span class="no">CALL</span> <span class="no">runtime.makechan</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4595b4</span>      <span class="mi">4889442468</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x68</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ch2</span> <span class="p">:</span><span class="err">=</span> <span class="no">make</span><span class="p">(</span><span class="no">chan</span> <span class="no">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4595b9</span>      <span class="mi">488</span><span class="no">d0500490000</span>      <span class="no">LEAQ</span> <span class="mi">0x4900</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4595c0</span>      <span class="mi">31</span><span class="no">db</span>                <span class="no">XORL</span> <span class="no">BX</span><span class="p">,</span> <span class="no">BX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4595c2</span>      <span class="no">e8d9a6faff</span>          <span class="no">CALL</span> <span class="no">runtime.makechan</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4595c7</span>      <span class="mi">4889442460</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x60</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">case</span> <span class="no">v</span> <span class="p">:</span><span class="err">=</span> <span class="err">&lt;</span><span class="p">-</span><span class="no">ch1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4595cc</span>      <span class="mi">488</span><span class="no">b4c2468</span>          <span class="no">MOVQ</span> <span class="mi">0x68</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>   <span class="c1">#CX=&amp;ch1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4595d1</span>      <span class="mi">48894</span><span class="no">c2478</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x78</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">case</span> <span class="no">ch2</span> <span class="err">&lt;</span><span class="p">-</span> <span class="mi">10</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4595d6</span>      <span class="mi">488</span><span class="no">b4c2460</span>          <span class="no">MOVQ</span> <span class="mi">0x60</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4595db</span>      <span class="mi">48894</span><span class="no">c2470</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x70</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4595e0</span>      <span class="mi">48</span><span class="no">c74424500a000000</span>  <span class="no">MOVQ</span> <span class="no">$0xa</span><span class="p">,</span> <span class="mi">0x50</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">select</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4595e9</span>      <span class="mi">440</span><span class="no">f11bc2490000000</span>  <span class="no">MOVUPS</span> <span class="no">X15</span><span class="p">,</span> <span class="mi">0x90</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4595f2</span>      <span class="mi">440</span><span class="no">f11bc24a0000000</span>  <span class="no">MOVUPS</span> <span class="no">X15</span><span class="p">,</span> <span class="mi">0xa0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">case</span> <span class="no">v</span> <span class="p">:</span><span class="err">=</span> <span class="err">&lt;</span><span class="p">-</span><span class="no">ch1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4595fb</span>      <span class="mi">488</span><span class="no">b4c2478</span>          <span class="no">MOVQ</span> <span class="mi">0x78</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459600</span>      <span class="mi">48898</span><span class="no">c24a0000000</span>    <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0xa0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459608</span>      <span class="mi">488</span><span class="no">d4c2458</span>          <span class="no">LEAQ</span> <span class="mi">0x58</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45960d</span>      <span class="mi">48898</span><span class="no">c24a8000000</span>    <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0xa8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">case</span> <span class="no">ch2</span> <span class="err">&lt;</span><span class="p">-</span> <span class="mi">10</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459615</span>      <span class="mi">488</span><span class="no">b4c2470</span>          <span class="no">MOVQ</span> <span class="mi">0x70</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45961a</span>      <span class="mi">48898</span><span class="no">c2490000000</span>    <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x90</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459622</span>      <span class="mi">488</span><span class="no">d4c2450</span>          <span class="no">LEAQ</span> <span class="mi">0x50</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459627</span>      <span class="mi">48898</span><span class="no">c2498000000</span>    <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x98</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">select</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45962f</span>      <span class="mi">488</span><span class="no">d8c2490000000</span>    <span class="no">LEAQ</span> <span class="mi">0x90</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459637</span>      <span class="mi">48898</span><span class="no">c2488000000</span>    <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x88</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45963f</span>      <span class="mi">488</span><span class="no">d5c2448</span>          <span class="no">LEAQ</span> <span class="mi">0x48</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459644</span>      <span class="mi">48899</span><span class="no">c2480000000</span>    <span class="no">MOVQ</span> <span class="no">BX</span><span class="p">,</span> <span class="mi">0x80</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45964c</span>      <span class="mi">488</span><span class="no">b842488000000</span>    <span class="no">MOVQ</span> <span class="mi">0x88</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459654</span>      <span class="mi">31</span><span class="no">c9</span>                <span class="no">XORL</span> <span class="no">CX</span><span class="p">,</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459656</span>      <span class="no">bf01000000</span>          <span class="no">MOVL</span> <span class="no">$0x1</span><span class="p">,</span> <span class="no">DI</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45965b</span>      <span class="mi">4889</span><span class="no">fe</span>              <span class="no">MOVQ</span> <span class="no">DI</span><span class="p">,</span> <span class="no">SI</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45965e</span>      <span class="mi">4531</span><span class="no">c0</span>              <span class="no">XORL</span> <span class="no">R8</span><span class="p">,</span> <span class="no">R8</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459661</span>      <span class="no">e89a57feff</span>          <span class="no">CALL</span> <span class="no">runtime.selectgo</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459666</span>      <span class="mi">4889442440</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x40</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45966b</span>      <span class="mi">885</span><span class="no">c2437</span>            <span class="no">MOVB</span> <span class="no">BL</span><span class="p">,</span> <span class="mi">0x37</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nl">default:</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45966f</span>      <span class="mi">48837</span><span class="no">c244000</span>        <span class="no">CMPQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x40</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459675</span>      <span class="mi">7</span><span class="no">c02</span>                <span class="no">JL</span> <span class="mi">0x459679</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459677</span>      <span class="no">eb02</span>                <span class="no">JMP</span> <span class="mi">0x45967b</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459679</span>      <span class="no">eb36</span>                <span class="no">JMP</span> <span class="mi">0x4596b1</span>
</span></span><span class="line"><span class="cl">    <span class="nf">case</span> <span class="no">ch2</span> <span class="err">&lt;</span><span class="p">-</span> <span class="mi">10</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45967b</span>      <span class="mi">48837</span><span class="no">c244000</span>        <span class="no">CMPQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x40</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459681</span>      <span class="mi">7402</span>                <span class="no">JE</span> <span class="mi">0x459685</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459683</span>      <span class="no">eb02</span>                <span class="no">JMP</span> <span class="mi">0x459687</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459685</span>      <span class="no">eb2a</span>                <span class="no">JMP</span> <span class="mi">0x4596b1</span>
</span></span><span class="line"><span class="cl">    <span class="nf">case</span> <span class="no">v</span> <span class="p">:</span><span class="err">=</span> <span class="err">&lt;</span><span class="p">-</span><span class="no">ch1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459687</span>      <span class="mi">488</span><span class="no">b442458</span>          <span class="no">MOVQ</span> <span class="mi">0x58</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45968c</span>      <span class="mi">4889442438</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">println</span><span class="p">(</span><span class="no">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459691</span>      <span class="no">e86a5cfdff</span>          <span class="no">CALL</span> <span class="no">runtime.printlock</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x459696</span>      <span class="mi">488</span><span class="no">b442438</span>          <span class="no">MOVQ</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45969b</span>      <span class="mi">0</span><span class="no">f1f440000</span>          <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)(</span><span class="no">AX</span><span class="p">*</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4596a0</span>      <span class="no">e85b63fdff</span>          <span class="no">CALL</span> <span class="no">runtime.printint</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4596a5</span>      <span class="no">e8b65efdff</span>          <span class="no">CALL</span> <span class="no">runtime.printnl</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4596aa</span>      <span class="no">e8d15cfdff</span>          <span class="no">CALL</span> <span class="no">runtime.printunlock</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">case</span> <span class="no">v</span> <span class="p">:</span><span class="err">=</span> <span class="err">&lt;</span><span class="p">-</span><span class="no">ch1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4596af</span>      <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x4596b1</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4596b1</span>      <span class="mi">488</span><span class="no">bac24b0000000</span>    <span class="no">MOVQ</span> <span class="mi">0xb0</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4596b9</span>      <span class="mi">4881</span><span class="no">c4b8000000</span>      <span class="no">ADDQ</span> <span class="no">$0xb8</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4596c0</span>      <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4596c1</span>      <span class="no">e8dacbffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4596c6</span>      <span class="no">e9b5feffff</span>          <span class="no">JMP</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æ€»ç»“">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“">#</a></h2>
<ol>
<li><strong><code>select {}</code></strong> ä¼šå¯¼è‡´å½“å‰ goroutine ç›´æ¥ä¸¢å¼ƒï¼Œå†ä¹Ÿä¸ä¼šè¢«è°ƒç”¨ã€‚</li>
<li><strong><code>select {default:}</code></strong> ç›´æ¥è·³è¿‡ä»€ä¹ˆéƒ½ä¸ä¼šåšã€‚</li>
<li><strong><code>select case</code></strong> ä¸­å­˜åœ¨ channel ä¸º nilï¼Œè¯¥ case ä¼šè¢«ä¸¢å¼ƒã€‚</li>
<li>select ä¸­ä¹Ÿä¸€æ ·ï¼Œå‘å…³é—­çš„channelï¼Œsendä¼španicï¼Œrecvä¼šå¾—åˆ°é»˜è®¤çš„é›¶å€¼ã€‚</li>
<li>select ä¸­ï¼Œå‘ nil çš„ channelï¼Œsend æˆ– recv ä¸ä¼š panicï¼ˆchannelä¼šè¢«ä¸¢å¼ƒï¼‰ã€‚è€Œæ²¡åœ¨ select ä¸­å…¨éƒ¨éƒ½ä¼š panicã€‚</li>
<li>æ³¨æ„ï¼šåœ¨ select ä¸­ close çš„ channel æƒ…å†µï¼š
<ol>
<li>recv å…ˆåˆ¤æ–­çš„èƒ½å¦æˆåŠŸï¼Œå†åˆ¤æ–­çš„ closeã€‚</li>
<li>send å…ˆåˆ¤æ–­çš„ closeï¼Œå†åˆ¤æ–­èƒ½å¦æˆåŠŸã€‚</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span> <span class="o">&lt;-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="nb">close</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">c</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;received %d, ok = %v\n&#34;</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">ok</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;default&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Output:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// received 1, ok = true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://helium.github.io/tags/golang/">Golang</a></li>
      <li><a href="https://helium.github.io/tags/channel/">Channel</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://helium.github.io/posts/golang/channel/theory/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Channel(åŸç†)</span>
  </a>
  <a class="next" href="https://helium.github.io/posts/golang/netpoll/linux/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>Linux epoll</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
    </span>
    <span id="busuanzi_container_site_uv">
        æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
    </span>
    </div>
        <span>Copyright Â© 2024 èœ€ICPå¤‡2024091074å· <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
