<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Function Value | Helium</title>
<meta name="keywords" content="golang, 函数">
<meta name="description" content="💥本文章所有相关go代码参考自go 1.18&#43;版本">
<meta name="author" content="helium">
<link rel="canonical" href="https://heliu.site/posts/golang/func/value/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://heliu.site/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://heliu.site/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://heliu.site/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://heliu.site/apple-touch-icon.png">
<link rel="mask-icon" href="https://heliu.site/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://heliu.site/posts/golang/func/value/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="Function Value" />
<meta property="og:description" content="💥本文章所有相关go代码参考自go 1.18&#43;版本" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://heliu.site/posts/golang/func/value/" />
<meta property="og:image" content="https://heliu.site/favicon-32x32.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-08-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-08-03T00:00:00+00:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://heliu.site/favicon-32x32.png" />
<meta name="twitter:title" content="Function Value"/>
<meta name="twitter:description" content="💥本文章所有相关go代码参考自go 1.18&#43;版本"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://heliu.site/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Golang 合集",
      "item": "https://heliu.site/posts/golang/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "第9章 Function",
      "item": "https://heliu.site/posts/golang/func/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Function Value",
      "item": "https://heliu.site/posts/golang/func/value/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Function Value",
  "name": "Function Value",
  "description": "💥本文章所有相关go代码参考自go 1.18+版本",
  "keywords": [
    "golang", "函数"
  ],
  "articleBody": " 函数在 Go 语言中属于第一类值(First Class Value)，该类型的值可以作为函数的参数和返回值，也可以赋给变量。 当把一个函数赋值给某个变量后，这个变量就被称为 Function Value。 声明一个 Function Value 变量的示例代码如下： var fn func(a, b int) int 其中 fn 就是个 Function Value 变量，它的类型是 func(int, int) int。 Function Value 可以像一般函数那样被调用，在使用体验上非常类似于 C 语言中的函数指针。 Function Value 本质上是不是函数指针呢？ 本节会分析 Function Value 和函数指针的实现原理，还有闭包的实现原理，以及 Function Value 是如何支持闭包的。 函数指针 熟悉 C 语言的读者应该有过使用函数指针的经验，函数指针存储的都是地址，只不过不是指向某种类型的数据。 而是指向代码段中某个函数的第一条指令，如图所示。 Function Value 分析 准备一个 go 文件并写入，示例代码如下： 1 2 3 4 5 6 7 8 9 10 package main func main() { println(helper(nil, 0, 0)) } //go:noinline func helper(fn func(int, int) int, a, b int) int { return fn(a, b) } 依然把 Function Value 的调用隔离在一个函数中，以便于分析。main.helper反编译代码如下： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 $ go build -gcflags=\"-N -l\" -o ./h1 myzx.cn/helium $ go tool objdump -S -s '^main.helper$' ./h1 TEXT main.helper(SB) /mnt/hgfs/workspace/helium/main.go func helper(fn func(int, int) int, a, b int) int { 0x455240 493b6610 CMPQ 0x10(R14), SP # 栈增长判断 0x455244 7650 JBE 0x455296 0x455246 4883ec28 SUBQ $0x28, SP 0x45524a 48896c2420 MOVQ BP, 0x20(SP) 0x45524f 488d6c2420 LEAQ 0x20(SP), BP 0x455254 4889442430 MOVQ AX, 0x30(SP) # fn 0x455259 48895c2438 MOVQ BX, 0x38(SP) # a 0x45525e 48894c2440 MOVQ CX, 0x40(SP) # b 0x455263 48c744241000000000 MOVQ $0x0, 0x10(SP) # return int return fn(a, b) 0x45526c 488b442438 MOVQ 0x38(SP), AX # AX=a 0x455271 488b5c2440 MOVQ 0x40(SP), BX # BX=b 0x455276 488b542430 MOVQ 0x30(SP), DX # DX=fn # 这里看出 Function Value 是一个二级指针 0x45527b 488b0a MOVQ 0(DX), CX # CX=fn.fn 0x45527e 6690 NOPW # DX 寄存器存储的是 fn，也就是上下文 # CALL CX; 指令说明，CX寄存器最终存储的是实际函数的地址 0x455280 ffd1 CALL CX # CALL fn.fn 0x455282 4889442418 MOVQ AX, 0x18(SP) 0x455287 4889442410 MOVQ AX, 0x10(SP) 0x45528c 488b6c2420 MOVQ 0x20(SP), BP 0x455291 4883c428 ADDQ $0x28, SP 0x455295 c3 RET func helper(fn func(int, int) int, a, b int) int { 0x455296 4889442408 MOVQ AX, 0x8(SP) 0x45529b 48895c2410 MOVQ BX, 0x10(SP) 0x4552a0 48894c2418 MOVQ CX, 0x18(SP) 0x4552a5 e8b6ccffff CALL runtime.morestack_noctxt.abi0(SB) 0x4552aa 488b442408 MOVQ 0x8(SP), AX 0x4552af 488b5c2410 MOVQ 0x10(SP), BX 0x4552b4 488b4c2418 MOVQ 0x18(SP), CX 0x4552b9 eb85 JMP main.helper(SB) 通过上述逻辑，可以确定Function Value确实是个指针，而且是个两级指针。 如图所示，Function Value 不直接指向目标函数，而是一个目标函数的指针。 闭包 说到Go语言的闭包，比较直观的感受就是个有状态的 Function Value。 在Go语言中比较典型的闭包场景就是在某个函数内定义了另一个函数，内层函数使用了外层函数的局部变量，并且内层函数最终被外层函数作为返回值返回。 代码如下： 1 2 3 4 5 func mc(n int) func() int { return func() int { return n } } 每次调用 mc() 函数都会返回一个新的闭包，闭包记住了参数的值，所以是有状态的。 基于目前对函数栈帧的了解，函数栈帧随着函数返回而销毁，不能用来保存状态。 研究函数指针和 Function Value 的时候也没有发现哪里用来保存状态，所以这里就有个问题，闭包的状态保存在哪里呢？ 闭包对象 为了摘清楚这个问题，先来尝试一下反编译，从汇编代码中找答案，main.mc反编译代码如下： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 $ go build -gcflags=\"-N -l\" -o ./h1 myzx.cn/helium $ go tool objdump -S -s '^main.mc$' ./h1 TEXT main.mc(SB) /mnt/hgfs/workspace/helium/main.go func mc(n int) func() int { 0x455220 493b6610 CMPQ 0x10(R14), SP # 栈增长判断 0x455224 765b JBE 0x455281 0x455226 4883ec28 SUBQ $0x28, SP 0x45522a 48896c2420 MOVQ BP, 0x20(SP) 0x45522f 488d6c2420 LEAQ 0x20(SP), BP # 参数栈空间分配 0x455234 4889442430 MOVQ AX, 0x30(SP) # n # 返回值栈空间分配 0x455239 48c744241000000000 MOVQ $0x0, 0x10(SP) # return func() int return func() int { # 0x7497(IP) 是 Function Value 的结构元类型 # type funcval struct {fn unsafe.Pointer, n int} 0x455242 488d0597740000 LEAQ 0x7497(IP), AX # Function Value 结构的元类型 # 创建 funcval 结构需要的内存空间，是堆分配 0x455249 e8f25cfbff CALL runtime.newobject(SB) # AX=\u0026funcval 0x45524e 4889442418 MOVQ AX, 0x18(SP) # 这里main.mc.func1(SB)是mc返回的闭包在代码段的地址 0x455253 488d0d46000000 LEAQ main.mc.func1(SB), CX # CX=main.mc.func1(SB) 0x45525a 488908 MOVQ CX, 0(AX) # funcval.fn=main.mc.func1(SB) 0x45525d 488b4c2418 MOVQ 0x18(SP), CX 0x455262 8401 TESTB AL, 0(CX) 0x455264 488b542430 MOVQ 0x30(SP), DX # DX=n # 可以看出这里捕获了变量n，并且是拷贝捕获 0x455269 48895108 MOVQ DX, 0x8(CX) # funcval.n = n 0x45526d 488b442418 MOVQ 0x18(SP), AX # AX=\u0026funcval 0x455272 4889442410 MOVQ AX, 0x10(SP) 0x455277 488b6c2420 MOVQ 0x20(SP), BP 0x45527c 4883c428 ADDQ $0x28, SP 0x455280 c3 RET func mc(n int) func() int { 0x455281 4889442408 MOVQ AX, 0x8(SP) 0x455286 e8d5ccffff CALL runtime.morestack_noctxt.abi0(SB) 0x45528b 488b442408 MOVQ 0x8(SP), AX 0x455290 eb8e JMP main.mc(SB) 根据上面代码可以推断出Function Value动态分配的对象的类型。 应该是一个 struct 类型，第1个字段是函数地址，第2个字段是 int 类型，代码如下： 1 2 3 4 struct { F uintptr n int } 说明编译器识别出了闭包这种代码模式，并且自动定义了这个 struct 类型进行支持，出于面向对象编程中把数据称为对象的习惯，后文中就把这种 struct 称为闭包对象。 闭包对象的成员可以进一步划分，第1个字段F用来存储目标函数的地址，这在所有的闭包对象中都是一致的，后文中将这个目标函数称为闭包函数。 从第2个字段开始，后续的字段称为闭包的捕获列表，也就是内层函数中用到的所有定义在外层函数中的变量。 编译器认为这些变量被闭包捕获了，会把它们追加到闭包对象的 struct 定义中。 上例中只捕获了一个变量 n，如果捕获的变量增多，struct 的捕获列表也会加长。 一个捕获两个变量的闭包示例代码如下： 1 2 3 4 5 func mc(n, m int) func() (int, int) { return func() (int, int) { return n, m } } 上述代码对应的闭包对象定义代码如下： 1 2 3 4 5 struct { F uintptr n int m int } 看到闭包 通过反编译来逆向推断闭包对象的结构还是比较烦琐的，如果能有一种方法，能够直观看到闭包对象的结构定义，那真是再好不过了。 根据之前的探索，已经知道 Go 序在运行阶段会通过 runtime.newobject() 函数动态匹配闭包对象。 Go 源码中 newobject() 函数的原型如下： func newobject(typ *_type) unsafe.Pointer 函数的返回值是个指针，也就是新分配的对象的地址，参数是个 _type 类型的指针。 通过源码可以得知这个 _type 是个 struct，在 Go 语言的 runtime 包中被用来描述一个数据类型，通过它可以找到目标数据类型的大小，对齐边界，类型名称等。 假如能够获得传递给 runtime.newobjet() 函数的类型元数据指针 typ，再通过反射进行解析，就能打印出闭包对象的结构定义了。那如何才能获得这个 typ 参数呢？ 在C语言中有种常用的函数 Hook 技术，就是在运行阶段将目标函数头部的代码替换为一条跳转指令，跳转到一个新的函数。 在 x86 平台上就是在进程地址空间中找到要 Hook 的函数，将其头部替换为一条 JMP 指令，同时指定 JMP 指令要跳转到的新函数的地址。 这项技术在 Go 程序中依然适用，可以用一个自己实现的函数换掉 runtime.newobject() 函数，在这个函数中就能获得 typ 参数并进行解析了。 还有一个问题是 runtime.newobiect() 函数属于未导出的函数，在runtime包外无法访问。 这一点可以通过 linkname 机制来绕过，在当前包中声明一个类似的函数，让链接器将其链接到runtime.newobject()函数即可。 本书使用开源模块 github.com/fengyoulin/hookingo 实现运行阶段函数替换，打印闭包对象结构的完整代码如下： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 package main import ( \"github.com/fengyoulin/hookingo\" \"reflect\" \"unsafe\" ) var hno hookingo.Hook //go:linkname newobject runtime.newobject func newobject(typ unsafe.Pointer) unsafe.Pointer //go:linkname newobject2 runtime.mallocgc func newobject2(size uintptr, typ unsafe.Pointer, b bool) unsafe.Pointer func fno(typ unsafe.Pointer) unsafe.Pointer { t := reflect.TypeOf(0) // type Type interface{} // 这里为什么赋值的是下标1？接下来我们分析为什么是1而不是0下标。 // 根据后面分析确实是修改下标1，因为t.String()需要用到1这个下标的数据。 (*(*[2]unsafe.Pointer)(unsafe.Pointer(\u0026t)))[1] = typ // 相当于反射了闭包类型 println(t.String()) //fn, ok := hno.Origin().(func(typ unsafe.Pointer) unsafe.Pointer) //if ok { // return fn(typ) // 调用原runtime.newobject //} //println(\"ok\", ok) //os.Exit(1) println(*(*uintptr)(unsafe.Pointer(typ))) return newobject2(*(*uintptr)(typ), typ, true) } // 创建一个闭包，make closure func mc(start int, text string) func() string { // 这里 start 需要堆分配 // func() string 也需要堆分配 return func() string { l := len(text) s := start % l r := text[s:] start++ return r } } func main() { var err error hno, err = hookingo.Apply(newobject, fno) // 应用钩子，替换函数 if err != nil { panic(err) } f := mc(10, \"hello, closure!\") println(f()) } $ C:\\Users\\Helium\\go\\bin\\go1.17.exe run -gcflags -l . # go1.17 版本 int # 打印的是mc的start堆分配 8 # int 占用内存大小 struct { F uintptr; text string; start *int } 32 sure! $ go run -gcflags -l . # go1.20.3版本 int 8 struct { F uintptr; text string; start *int } 32 sure! 因为start会被修改，所以捕获地址造成堆分配，因此结果第一行打印了一个int。 第二行的struct就是闭包结构的类型，这是通过类型元数据直接获取到的，是由编译器构造的结构类型。 我们抄部分fno()函数的相关代码：typ unsafe.Pointer：来自类型的*_type类型数据。 1 2 3 4 5 6 7 func fno(typ unsafe.Pointer) unsafe.Pointer { t := reflect.TypeOf(0) // type Type interface{} // 这里为什么赋值的是下标1？接下来我们分析为什么是1而不是0下标。 (*(*[2]unsafe.Pointer)(unsafe.Pointer(\u0026t)))[1] = typ // 相当于反射了闭包类型 println(t.String()) // ... ... } 分析reflect.TypeOf()函数如下： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // TypeOf returns the reflection Type that represents the dynamic type of i. // If i is a nil interface value, TypeOf returns nil. func TypeOf(i any) Type { // emptyInterface 是空接口的内存结构 eface := *(*emptyInterface)(unsafe.Pointer(\u0026i)) // eface.typ 这里直接取了 typ 字段，没有要word字段 // 通过分析toType()函数可知，把eface.typ放入了非空接口Type中。 // 因此必须要分析非空接口中存储的是什么？非空接口内存布局 // type iface struct { // tab *itab // 类型元数据 // data *unsafe.Pointer // 装箱的数据 // } // 因此 tab *itab 装载的是 *rtype 类型结构，也就是结构体指针 // 按照传入参数0这里可以看出应该是int的元类型 // 重要的是 data，这存储的是 *rtype 这个指针数据，类型反射就是依靠这个data。 // 因为我们调用Type非空接口的所有方法接收器的参数都是 *rtype，这也就是为什么修改下标1的原因。 // 我们在调用t.String()方法时，需要的时data这个是我们想要的类型即可。 return toType(eface.typ) } // emptyInterface is the header for an interface{} value. type emptyInterface struct { typ *rtype // 存储着类型结构 word unsafe.Pointer } 分析toType()函数如下： 1 2 3 4 5 6 7 8 9 10 11 // toType converts from a *rtype to a Type that can be returned // to the client of package reflect. In gc, the only concern is that // a nil *rtype must be replaced by a nil Type, but in gccgo this // function takes care of ensuring that multiple *rtype for the same // type are coalesced into a single Type. func toType(t *rtype) Type { if t == nil { return nil } return t } 调用闭包 闭包函数在被调用的时候，必须得到当前闭包对象的地址才能访问其中的捕获列表，这个地址是如何传递的呢？ 调用者在调用 Function Value 的时候只是像调用一个普通函数那样传递了声明的参数，如果 Function Value 背后是个闭包函数，则无法通过栈上的参数得到闭包对象地址。 除非编译器传递了一个隐含的参数，这个参数如果通过栈传递，那就改变了函数的原型，这样就会造成不一致，是行不通的。 还是通过反汇编来看一下闭包函数是从哪里得到的这个地址，先来构造闭包，代码如下： 1 2 3 4 5 func mc(n int) func int { return func() int { return n } } 根据前面的探索，可以确定闭包对象的结构定义代码如下： 1 2 3 4 struct { F uintptr n int } 反编译闭包函数得到的汇编代码如下： 第7行，将 DX 寄存器用作基址,再加上位移 8，把该地址处的值复制到 CX 寄存器中。 第8行，把 CX 寄存器值复制给闭包函数的返回值。 第11行，把返回值放入AX寄存器中。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 $ go tool objdump -S -s '^main.mc.func1$' ./h1 TEXT main.mc.func1(SB) /mnt/hgfs/workspace/helium/main.go return func() int { 0x4552a0 4883ec18 SUBQ $0x18, SP 0x4552a4 48896c2410 MOVQ BP, 0x10(SP) 0x4552a9 488d6c2410 LEAQ 0x10(SP), BP 0x4552ae 488b4a08 MOVQ 0x8(DX), CX # CX=0x8(DX) 0x4552b2 48894c2408 MOVQ CX, 0x8(SP) 0x4552b7 48c7042400000000 MOVQ $0x0, 0(SP) return n 0x4552bf 488b442408 MOVQ 0x8(SP), AX # AX=0x8(DX) 0x4552c4 48890424 MOVQ AX, 0(SP) 0x4552c8 488b6c2410 MOVQ 0x10(SP), BP 0x4552cd 4883c418 ADDQ $0x18, SP 0x4552d1 c3 RET 显然，DX寄存器存储的就是闭包对象的地址，调用者负责在调用之前把闭包对象的地址存储到 DX 寄存器中，跟 C++ 中的 thiscall非常类似。 之前有很多读者在反编译 Function Value 调用代码时，总会看到为 DX 寄存器赋值，并为此感到疑惑，这就是原因。 调用者不必区分是不是闭包、有没有捕获列表，实际上也区分不了，只能统一作为闭包来处理，所以总要通过 DX 传递地址。 如果 Function Value 背后不是闭包，这个地址就不会被用到，也不会造成什么影响。 闭包与变量逃逸 变量逃逸跟闭包之间的关系很密切，因为 Function Value 本身就是个指针，编译器也可以按照同样的方式来分析 Function Value 有没有逃逸。 如果 Function Value 没有逃逸那就可以不用在堆上分配闭包对象了，分配在栈上即可。 使用一个示例进行验证，代码如下： 1 2 3 4 5 6 func sc(n int) int { f := func() int { return n } return f() } 代码逻辑过于简单，为了避免闭包函数被编译器优化掉，编译时需要禁用内联优化，命令如下：$ go build -gcflags='-l'。 再来反编译 sc() 函数，main.sc反编译命令及输出结果如下： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 $ go build -gcflags=\"-l -N\" -o ./h1 myzx.cn/helium $ go tool objdump -S -s '^main.sc$' ./h1 TEXT main.sc(SB) /mnt/hgfs/workspace/helium/main.go func sc(n int) int { 0x455220 493b6610 CMPQ 0x10(R14), SP 0x455224 7664 JBE 0x45528a 0x455226 4883ec38 SUBQ $0x38, SP 0x45522a 48896c2430 MOVQ BP, 0x30(SP) 0x45522f 488d6c2430 LEAQ 0x30(SP), BP 0x455234 4889442440 MOVQ AX, 0x40(SP) # 分配参数空间 0x455239 48c7042400000000 MOVQ $0x0, 0(SP) # 分配返回值空间 f := func() int { 0x455241 440f117c2410 MOVUPS X15, 0x10(SP) 0x455247 488d542410 LEAQ 0x10(SP), DX # \u0026funcval 0x45524c 4889542428 MOVQ DX, 0x28(SP) 0x455251 8402 TESTB AL, 0(DX) 0x455253 488d0546000000 LEAQ main.sc.func1(SB), AX 0x45525a 4889442410 MOVQ AX, 0x10(SP) # funcval.fn 0x10(SP) 0x45525f 8402 TESTB AL, 0(DX) 0x455261 488b442440 MOVQ 0x40(SP), AX # 参数n的值 0 0x455266 4889442418 MOVQ AX, 0x18(SP) # funcval.data 0x18(SP) 0 0x45526b 4889542420 MOVQ DX, 0x20(SP) return f() 0x455270 488b442410 MOVQ 0x10(SP), AX 0x455275 ffd0 CALL AX 0x455277 4889442408 MOVQ AX, 0x8(SP) 0x45527c 48890424 MOVQ AX, 0(SP) 0x455280 488b6c2430 MOVQ 0x30(SP), BP 0x455285 4883c438 ADDQ $0x38, SP 0x455289 c3 RET func sc(n int) int { 0x45528a 4889442408 MOVQ AX, 0x8(SP) 0x45528f e8ccccffff CALL runtime.morestack_noctxt.abi0(SB) 0x455294 488b442408 MOVQ 0x8(SP), AX 0x455299 eb85 JMP main.sc(SB) 函数 在Go语言中函数属于头等对象，可以被当作参数传递、也可以作为函数返回值、绑定到变量。 Go语言称这样的参数、返回值和变量为Function Value。 Function Value本质上是一个指针，却不直接指向函数指令入口，而是指向runtime.funcval结构体，函数变量存储的是*funcval类型，也就是funcval结构体的地址。 1 2 3 4 5 6 7 8 9 10 11 // 闭包是函数类型funcType // 闭包捕获的变量，系统维护着一个关系列表，根据这个列表能正确的找到捕获的变量类型大小等信息 type funcval struct { fn uintptr // 指向程序的代码段 // variable-size, fn-specific data here } // 紧接着funcval结构体后面内存地址是捕获的的变量列表 // 注意捕获的是变量的地址，使用的却是变量的值 // 闭包中捕获的如果是指针类型那么是引用，是普通类型那么是拷贝 // f -\u003e *funcval 这个结构体从定义上看只有一个地址，这个地址才是函数的指令入口。一个Function Value是以下图所示形式存在的。 闭包 Closure：维基百科 闭包在实现上是一个结构体，它存储了一个函数（通常是其入口地址）和一个关联的环境（相当于一个符号查找表）。 环境里是若干对符号和值的对应关系，它既要包括约束变量（该函数内部绑定的符号），也要包括自由变量（在函数外部定义但在函数内被引用），有些函数也可能没有自由变量。 闭包跟函数最大的不同在于，当捕捉闭包的时候，它的自由变量会在捕捉时被确定，这样即便脱离了捕捉时的上下文，它也能照常运行。 所以像下面这个例子： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 func create() func(){ c := 2 // c会被分配在栈上，以拷贝形式被捕获 return func(){ // 【由于c变量后面没有变化，所以这里捕获变成拷贝c的值2就行，不需要捕获c的地址】 fmt.Println(c) } } func main(){ // f1 { // fn ---\u003e 闭包函数地址 // 2 ---\u003e 拷贝c的值即可（不需要捕获c的地址），这里2 // } f1 := create() f2 := create() f1() f2() // 闭包函数的内存结构布局 s := **(**struct{ fn uintptr // 指向函数代码地址 data1 int // 捕获变量 })(unsafe.Pointer(\u0026f1)) fmt.Printf(\"%#v\\n\", s) // struct {fn uintptr;data1 int}{fn:0x47f520, data1:2} } create函数的返回值是一个函数，并且引用了其外层函数定义的局部变量c。 而且，即便create函数结束，依然可以通过f1和f2正常执行这个函数并使用定义在create内部的变量c。 所以这个返回值符合闭包的定义，而这个自由变量c，通常被称为捕获变量。 虽然create函数的返回值函数形成闭包，但是Go语言里并没有把闭包从Function Value中特别区分出来。 在Go语言中闭包只是拥有一个或多个捕获变量的Function Value而已。 这些捕获变量就是它的捕获列表，就放在对应的funcval结构体的后面。 所以上例中，f1和f2的内存布局如下图所示： 每个闭包对象都是一个Function Value，但是各自持有自己的捕获列表，这也是称闭包为有状态的函数的原因。 闭包捕获变量值 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 package main func main() { f := create() _ = f() } //go:noinline func create() func() int { c := 2 // 堆分配 struct { F uintptr; c int } return func() int { // 注意这里的c变量不需要被捕获 // c没有更改，只需要拷贝变量c的值即可 return c } } main 函数汇编代码。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func main() { 0x4551e0 493b6610 CMPQ 0x10(R14), SP # 栈增长判断 0x4551e4 7629 JBE 0x45520f 0x4551e6 4883ec10 SUBQ $0x10, SP # main.main栈分配 0x4551ea 48896c2408 MOVQ BP, 0x8(SP) 0x4551ef 488d6c2408 LEAQ 0x8(SP), BP f := create() 0x4551f4 e827000000 CALL main.create(SB) # AX返回\u0026funcval 0x4551f9 48890424 MOVQ AX, 0(SP) _ = f() 0x4551fd 488b08 MOVQ 0(AX), CX # CX=funcval.fn 0x455200 4889c2 MOVQ AX, DX # DX=\u0026funcval 0x455203 ffd1 CALL CX } 0x455205 488b6c2408 MOVQ 0x8(SP), BP 0x45520a 4883c410 ADDQ $0x10, SP 0x45520e c3 RET func main() { 0x45520f e84ccdffff CALL runtime.morestack_noctxt.abi0(SB) 0x455214 ebca JMP main.main(SB) create 函数汇编代码。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 func create() func() int { 0x455220 493b6610 CMPQ 0x10(R14), SP # 栈增长判断 0x455224 765f JBE 0x455285 0x455226 4883ec30 SUBQ $0x30, SP # 分配create栈空间 0x45522a 48896c2428 MOVQ BP, 0x28(SP) 0x45522f 488d6c2428 LEAQ 0x28(SP), BP 0x455234 48c744241800000000 MOVQ $0x0, 0x18(SP) # 临时返回空间8字节，*funcval c := 2 0x45523d 48c744241002000000 MOVQ $0x2, 0x10(SP) # 参数 c return func() int { # AX=0x7493(IP)，funcval结构体类型的_type类型指针位置，内存大小16B 0x455246 488d0593740000 LEAQ 0x7493(IP), AX # 根据*_type进行堆分配，AX=\u0026funcval 0x45524d e8ee5cfbff CALL runtime.newobject(SB) 0x455252 4889442420 MOVQ AX, 0x20(SP) # CX=main.create.func1 代码地址 0x455257 488d0d42000000 LEAQ main.create.func1(SB), CX 0x45525e 488908 MOVQ CX, 0(AX) # funcval.fn=main.create.func1 0x455261 488b4c2420 MOVQ 0x20(SP), CX # CX=\u0026funcval 0x455266 8401 TESTB AL, 0(CX) 0x455268 488b542410 MOVQ 0x10(SP), DX # DX=0x2 0x45526d 48895108 MOVQ DX, 0x8(CX) # funcval.data=0x2 0x455271 488b442420 MOVQ 0x20(SP), AX # AX=\u0026funcval 0x455276 4889442418 MOVQ AX, 0x18(SP) 0x45527b 488b6c2428 MOVQ 0x28(SP), BP 0x455280 4883c430 ADDQ $0x30, SP 0x455284 c3 RET func create() func() int { 0x455285 e8d6ccffff CALL runtime.morestack_noctxt.abi0(SB) 0x45528a eb94 JMP main.create(SB) main.create.func1 函数汇编代码。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 TEXT main.create.func1(SB) /mnt/hgfs/g/hello1/func1.go return func() int { 0x4552a0 4883ec18 SUBQ $0x18, SP 0x4552a4 48896c2410 MOVQ BP, 0x10(SP) 0x4552a9 488d6c2410 LEAQ 0x10(SP), BP 0x4552ae 488b4a08 MOVQ 0x8(DX), CX # CX=0x2 0x4552b2 48894c2408 MOVQ CX, 0x8(SP) 0x4552b7 48c7042400000000 MOVQ $0x0, 0(SP) // 注意这里的c变量不需要被捕获 0x4552bf 488b442408 MOVQ 0x8(SP), AX # AX=0x2 0x4552c4 48890424 MOVQ AX, 0(SP) 0x4552c8 488b6c2410 MOVQ 0x10(SP), BP 0x4552cd 4883c418 ADDQ $0x18, SP 0x4552d1 c3 RET main和create的栈分布。 | runtime.main callback -------------------------- +40 +08 | runtime.main BP -------------------------- BP --------------- +38 +00 | create.r *funcval main.main栈 -------------------------- SP --------------- +30 | main.main callback -------------------------- +28 | main.main BP -------------------------- BP --------------- +20 | \u0026funcval create.o -\u003e 临时funcval堆分配 -------------------------- +18 | \u0026funcval create.r -\u003e create的返回值 -------------------------- +10 | 0x2 create.c main.create栈 -------------------------- +08 | -------------------------- +00 | -------------------------- SP --------------- 闭包捕获变量地址 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 package main func main() { f := create() _ = f() } //go:noinline func create() func() int { c := 2 // 堆分配 struct { F uintptr; c *int } return func() int { c++ // 捕获c变量地址，在堆上分配 return c } } main 函数汇编代码。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func main() { 0x4551e0 493b6610 CMPQ 0x10(R14), SP 0x4551e4 7629 JBE 0x45520f 0x4551e6 4883ec10 SUBQ $0x10, SP 0x4551ea 48896c2408 MOVQ BP, 0x8(SP) 0x4551ef 488d6c2408 LEAQ 0x8(SP), BP f := create() 0x4551f4 e827000000 CALL main.create(SB) # 调用函数 AX返回\u0026funcval 0x4551f9 48890424 MOVQ AX, 0(SP) _ = f() 0x4551fd 488b08 MOVQ 0(AX), CX # CX=funcval.fn 0x455200 4889c2 MOVQ AX, DX # DX=\u0026funcval 0x455203 ffd1 CALL CX } 0x455205 488b6c2408 MOVQ 0x8(SP), BP 0x45520a 4883c410 ADDQ $0x10, SP 0x45520e c3 RET func main() { 0x45520f e84ccdffff CALL runtime.morestack_noctxt.abi0(SB) 0x455214 ebca JMP main.main(SB) create 函数汇编代码。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 func create() func() int { 0x455220 493b6610 CMPQ 0x10(R14), SP 0x455224 0f8686000000 JBE 0x4552b0 0x45522a 4883ec30 SUBQ $0x30, SP 0x45522e 48896c2428 MOVQ BP, 0x28(SP) 0x455233 488d6c2428 LEAQ 0x28(SP), BP 0x455238 48c744241000000000 MOVQ $0x0, 0x10(SP) c := 2 0x455241 488d05f84a0000 LEAQ 0x4af8(IP), AX # AX=0x4af8(IP)，int的元类型 0x455248 e8f35cfbff CALL runtime.newobject(SB) # 申请内存，AX=*int 0x45524d 4889442420 MOVQ AX, 0x20(SP) # 变量c 0x455252 48c70002000000 MOVQ $0x2, 0(AX) # 给c赋值2 return func() int { 0x455259 488d0580740000 LEAQ 0x7480(IP), AX # funcval的元类型，申请16B 0x455260 e8db5cfbff CALL runtime.newobject(SB) # AX=\u0026funcval 0x455265 4889442418 MOVQ AX, 0x18(SP) 0x45526a 488d0d4f000000 LEAQ main.create.func1(SB), CX # CX=main.create.func1 0x455271 488908 MOVQ CX, 0(AX) # funcval.fn=main.create.func1 0x455274 488b4c2418 MOVQ 0x18(SP), CX # CX=\u0026funcval 0x455279 8401 TESTB AL, 0(CX) 0x45527b 488b542420 MOVQ 0x20(SP), DX # DX=*int -\u003e 2 0x455280 488d7908 LEAQ 0x8(CX), DI # DI=funcval.data 0x455284 833dd51f090000 CMPL $0x0, runtime.writeBarrier(SB) 0x45528b 7402 JE 0x45528f 0x45528d eb06 JMP 0x455295 0x45528f 48895108 MOVQ DX, 0x8(CX) # funcval.data=*int -\u003e 2 0x455293 eb07 JMP 0x45529c 0x455295 e8a6d0ffff CALL runtime.gcWriteBarrierDX(SB) 0x45529a eb00 JMP 0x45529c 0x45529c 488b442418 MOVQ 0x18(SP), AX # AX=\u0026funcval 0x4552a1 4889442410 MOVQ AX, 0x10(SP) 0x4552a6 488b6c2428 MOVQ 0x28(SP), BP 0x4552ab 4883c430 ADDQ $0x30, SP 0x4552af c3 RET func create() func() int { 0x4552b0 e8abccffff CALL runtime.morestack_noctxt.abi0(SB) 0x4552b5 e966ffffff JMP main.create(SB) main.create.func1 函数汇编代码。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 TEXT main.create.func1(SB) /mnt/hgfs/g/hello1/func1.go return func() int { 0x4552c0 4883ec18 SUBQ $0x18, SP 0x4552c4 48896c2410 MOVQ BP, 0x10(SP) 0x4552c9 488d6c2410 LEAQ 0x10(SP), BP 0x4552ce 488b4a08 MOVQ 0x8(DX), CX 0x4552d2 48894c2408 MOVQ CX, 0x8(SP) 0x4552d7 48c7042400000000 MOVQ $0x0, 0(SP) c++ // 捕获c变量地址，在堆上分配 0x4552df 488b4c2408 MOVQ 0x8(SP), CX 0x4552e4 488b09 MOVQ 0(CX), CX 0x4552e7 488b542408 MOVQ 0x8(SP), DX 0x4552ec 48ffc1 INCQ CX 0x4552ef 48890a MOVQ CX, 0(DX) return c 0x4552f2 488b4c2408 MOVQ 0x8(SP), CX 0x4552f7 488b01 MOVQ 0(CX), AX 0x4552fa 48890424 MOVQ AX, 0(SP) 0x4552fe 488b6c2410 MOVQ 0x10(SP), BP 0x455303 4883c418 ADDQ $0x18, SP 0x455307 c3 RET main和create的栈分布。 | runtime.main callback ------------------------- +40 +08 | runtime.main BP ------------------------- BP ------------ +38 +00 | \u0026funcval c.r main.main栈 ------------------------- SP ------------ +30 | main.main callback ------------------------- +28 | main.main BP ------------------------- BP ------------ +20 | *int -\u003e 2 c ------------------------- +18 | \u0026funcval c.o ------------------------- +10 | \u0026funcval c.r ------------------------- +08 | ------------------------- +00 | ------------------------- SP ------------ 调用 通过Function Value调用函数时，会把对应的funcval结构体地址存入特定寄存器，如amd64平台使用的是DX寄存器，参看上面的汇编确实使用DX寄存器存储的。 继续使用闭包的示例，通过f1调用闭包函数时，会把f1存储的funcval结构体地址存入寄存器DX，这样在闭包函数的指令中就可以通过这个寄存器存储的地址加上8字节的偏移，就找到f1的捕获变量了。 同样的，通过f2调用闭包函数时，会把f2存储的funcval结构体地址存入寄存器，闭包函数执行时找到的就是f2的捕获变量了。 如果是没有捕获列表的Function Value，直接忽略这个寄存器即可。 通过这样的方式，Go语言实现了对Function Value的统一调用。 静态分配 对于没有捕获列表的Function Value，如果多个变量关联到同一个函数，编译器会做出优化，让它们共用一个funcval结构体。 注意 funcval 后面存储的是捕获的参数，实际传参不在这里，在调用该函数时在调用栈上。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 func A(i int) { i++ fmt.Println(i) } func B(){ f1 := A f1(1) } func C(){ f2 := A f2(1) } 像上面这种情况，编译阶段会创建一个funcval结构体放到只读数据段，而执行阶段，f1和f2都会使用它。 静态分配验证 1 2 3 4 5 6 7 8 9 10 11 package main func main() { f1 := A f1(1) } //go:noinline func A(i int) { i++ } main 函数汇编代码。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func main() { 0x4551e0 493b6610 CMPQ 0x10(R14), SP 0x4551e4 7632 JBE 0x455218 0x4551e6 4883ec18 SUBQ $0x18, SP 0x4551ea 48896c2410 MOVQ BP, 0x10(SP) 0x4551ef 488d6c2410 LEAQ 0x10(SP), BP f1 := A 0x4551f4 488d15251d0100 LEAQ 0x11d25(IP), DX # DX=\u0026funcval 0x4551fb 4889542408 MOVQ DX, 0x8(SP) f1(1) 0x455200 488b0d191d0100 MOVQ 0x11d19(IP), CX # CX=funcval.fn，函数A的地址 0x455207 b801000000 MOVL $0x1, AX # AX=0x1，参数 0x45520c ffd1 CALL CX } 0x45520e 488b6c2410 MOVQ 0x10(SP), BP 0x455213 4883c418 ADDQ $0x18, SP 0x455217 c3 RET func main() { 0x455218 e843cdffff CALL runtime.morestack_noctxt.abi0(SB) 0x45521d ebc1 JMP main.main(SB) A 函数汇编代码。 1 2 3 4 5 6 7 8 TEXT main.A(SB) /mnt/hgfs/g/hello1/func1.go func A(i int) { 0x455220 4889442408 MOVQ AX, 0x8(SP) i++ 0x455225 48ffc0 INCQ AX 0x455228 4889442408 MOVQ AX, 0x8(SP) } 0x45522d c3 RET main和A的栈分布。 | runtime.main callback ------------------------------- +10 | runtime.main BP ------------------------------- BP +08 | 0x11d25(IP) A ------------------------------- +00 | ------------------------------- SP 捕获列表 因为捕获列表需要由闭包对象各自持有，所以有捕获列表的Function Value要到执行阶段才会在堆上分配对应的funcval结构体以及捕获列表空间。 但是，捕获列表里存什么？直接拷贝捕获变量值吗？才没有那么简单。 闭包捕获的变量要在闭包函数和外层函数中表现一致，如果单纯值拷贝，就无法保证这一点，所以编译器针对捕获变量的不同情况分别做出了不同的处理。 捕获变量【除了初始化赋值外在任何地方都没有被修改过，那就可以直接拷贝值】，因为它不会再变化。 捕获变量除了初始化赋值外，还被修改过，就要再细分了。 捕获局部变量 这个例子中，被捕获的是局部变量i，除了初始化赋值外还被修改过，所以局部变量i改为堆分配，栈上只存一个地址。 在这个示例中，为了让被捕获的局部变量在闭包函数和外层函数中保持一致，本该在栈上分配的局部变量被分配到堆上，这其实也是变量逃逸的一种场景。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func create() (fs [2]func()){ for i := 0; i \u003c 2; i++ { // struct { F uintptr; i *int } fs[i] = func(){ fmt.Println(\u0026i, i) } } return } func main() { fs := create() for i := 0; i \u003c len(fs); i++ { fs[i]() } // Output: // 0xc0000ac058 2 // 0xc0000ac058 2 } 捕获局部变量 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package main func main() { fs := create() for i := 0; i \u003c len(fs); i++ { fs[i]() } } //go:noinline func create() (fs [2]func()) { for i := 0; i \u003c 2; i++ { // 堆分配 struct { F uintptr; i *int } fs[i] = func() { i++ } } return } main 汇编代码。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 func main() { 0x4551e0 493b6610 CMPQ 0x10(R14), SP 0x4551e4 7675 JBE 0x45525b 0x4551e6 4883ec30 SUBQ $0x30, SP 0x4551ea 48896c2428 MOVQ BP, 0x28(SP) 0x4551ef 488d6c2428 LEAQ 0x28(SP), BP fs := create() 0x4551f4 e887000000 CALL main.create(SB) # 调用main.create 0x4551f9 0f100424 MOVUPS 0(SP), X0 # 将0(SP)后16B内容放入X0，这里的两行代码相当于fs赋值 0x4551fd 0f11442418 MOVUPS X0, 0x18(SP) # 将X0迁移到0x18(SP)后16B for i := 0; i \u003c len(fs); i++ { 0x455202 48c744241000000000 MOVQ $0x0, 0x10(SP) # i初始化 0 0x45520b eb00 JMP 0x45520d 0x45520d 48837c241002 CMPQ $0x2, 0x10(SP) # i和0x2比较 \u003c--- 循环判断条件 0x455213 7c02 JL 0x455217 0x455215 eb2f JMP 0x455246 fs[i]() 0x455217 488b442410 MOVQ 0x10(SP), AX # AX=0 0x45521c 0f1f4000 NOPL 0(AX) 0x455220 4883f802 CMPQ $0x2, AX 0x455224 7202 JB 0x455228 0x455226 eb28 JMP 0x455250 0x455228 488d44c418 LEAQ 0x18(SP)(AX*8), AX # AX=\u0026funcval 0x45522d 488b10 MOVQ 0(AX), DX # DX=\u0026funcval.fn 0x455230 488b02 MOVQ 0(DX), AX # AX=funcval.fn 0x455233 ffd0 CALL AX # 调用函数 0x455235 eb00 JMP 0x455237 for i := 0; i \u003c len(fs); i++ { 0x455237 488b5c2410 MOVQ 0x10(SP), BX # BX=0 0x45523c 48ffc3 INCQ BX # BX=1 0x45523f 48895c2410 MOVQ BX, 0x10(SP) # i=1 0x455244 ebc7 JMP 0x45520d # \u003c--- 一轮循环结束跳转循环开头 } 0x455246 488b6c2428 MOVQ 0x28(SP), BP 0x45524b 4883c430 ADDQ $0x30, SP 0x45524f c3 RET fs[i]() 0x455250 b902000000 MOVL $0x2, CX 0x455255 e866d4ffff CALL runtime.panicIndex(SB) 0x45525a 90 NOPL func main() { 0x45525b 0f1f440000 NOPL 0(AX)(AX*1) 0x455260 e8fbccffff CALL runtime.morestack_noctxt.abi0(SB) 0x455265 e976ffffff JMP main.main(SB) create 汇编代码。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 func create() (fs [2]func()) { 0x455280 493b6610 CMPQ 0x10(R14), SP 0x455284 0f86d0000000 JBE 0x45535a 0x45528a 4883ec28 SUBQ $0x28, SP 0x45528e 48896c2420 MOVQ BP, 0x20(SP) 0x455293 488d6c2420 LEAQ 0x20(SP), BP 0x455298 440f117c2430 MOVUPS X15, 0x30(SP) # 0x30(SP)开始的16B地址清零 for i := 0; i \u003c 2; i++ { 0x45529e 488d059b4a0000 LEAQ 0x4a9b(IP), AX # AX=0x4a9b(IP)，int的元类型 \u003c--- 变量i初始化 0x4552a5 e8965cfbff CALL runtime.newobject(SB) # 变量i申请内存，AX返回 *int 0x4552aa 4889442418 MOVQ AX, 0x18(SP) 0x4552af 48c70000000000 MOVQ $0x0, 0(AX) # i变量赋值0 0x4552b6 eb00 JMP 0x4552b8 0x4552b8 488b4c2418 MOVQ 0x18(SP), CX # CX=\u0026i \u003c--- 循环从这里开始，后面满足条件会跳转回来 0x4552bd 48833902 CMPQ $0x2, 0(CX) # i与2比较 0x4552c1 7c05 JL 0x4552c8 0x4552c3 e97d000000 JMP 0x455345 fs[i] = func() { # struct { F uintptr; i *int } 0x4552c8 488d0511740000 LEAQ 0x7411(IP), AX # AX=0x7411(IP)，funcval元类型 内存16B 0x4552cf e86c5cfbff CALL runtime.newobject(SB) # 申请内存16B，AX=\u0026funcval 0x4552d4 4889442410 MOVQ AX, 0x10(SP) 0x4552d9 488d0da0000000 LEAQ main.create.func1(SB), CX # CX=main.create.func1 0x4552e0 488908 MOVQ CX, 0(AX) # funcval.fn=main.create.func1 0x4552e3 488b4c2410 MOVQ 0x10(SP), CX # CX=\u0026funcval 0x4552e8 8401 TESTB AL, 0(CX) 0x4552ea 488b542418 MOVQ 0x18(SP), DX # DX=\u0026int 0x4552ef 488d7908 LEAQ 0x8(CX), DI # DI=funcval.data 0x4552f3 833d661f090000 CMPL $0x0, runtime.writeBarrier(SB) # 检查写屏障 0x4552fa 7402 JE 0x4552fe 0x4552fc eb06 JMP 0x455304 0x4552fe 48895108 MOVQ DX, 0x8(CX) # funcval.data=\u0026int 0x455302 eb07 JMP 0x45530b 0x455304 e837d0ffff CALL runtime.gcWriteBarrierDX(SB) # 调用写屏障函数 0x455309 eb00 JMP 0x45530b 0x45530b 488b542418 MOVQ 0x18(SP), DX # DX=\u0026int 0x455310 488b02 MOVQ 0(DX), AX # AX=0 0x455313 488b542410 MOVQ 0x10(SP), DX # DX=\u0026funcval 0x455318 4883f802 CMPQ $0x2, AX # AX和2比较 0x45531c 7204 JB 0x455322 0x45531e 6690 NOPW 0x455320 eb2d JMP 0x45534f 0x455322 488d4cc430 LEAQ 0x30(SP)(AX*8), CX # CX=0x30(SP)(AX*8)，AX=0 -\u003e 0x30(SP)，AX=1 -\u003e 0x38(SP) 0x455327 488911 MOVQ DX, 0(CX) # 返回数组遍历赋值 0x45532a eb00 JMP 0x45532c for i := 0; i \u003c 2; i++ { 0x45532c 488b4c2418 MOVQ 0x18(SP), CX # CX=\u0026int 0x455331 488b09 MOVQ 0(CX), CX # CX=0 0x455334 488b542418 MOVQ 0x18(SP), DX # DX=\u0026int 0x455339 48ffc1 INCQ CX # CX=1 0x45533c 48890a MOVQ CX, 0(DX) # i赋值1 0x45533f 90 NOPL 0x455340 e973ffffff JMP 0x4552b8 # 跳转到前面开始下一轮循环 return 0x455345 488b6c2420 MOVQ 0x20(SP), BP 0x45534a 4883c428 ADDQ $0x28, SP 0x45534e c3 RET fs[i] = func() { 0x45534f b902000000 MOVL $0x2, CX 0x455354 e867d3ffff CALL runtime.panicIndex(SB) 0x455359 90 NOPL func create() (fs [2]func()) { 0x45535a e801ccffff CALL runtime.morestack_noctxt.abi0(SB) 0x45535f 90 NOPL 0x455360 e91bffffff JMP main.create(SB) main和create的栈布局。 | runtime.main callback --------------------------- +58 +28 | runtime.main BP --------------------------- BP --------------- +50 +20 | \u0026funcval c.r --------------------------- +48 +18 | \u0026funcval c.r --------------------------- +40 +10 | 0x0 i main.main栈 --------------------------- +38 +08 | \u0026funcval fs[1] --------------------------- +30 +00 | \u0026funcval fs[0] --------------------------- SP --------------- +28 | main.main callback --------------------------- +20 | main.main BP --------------------------- BP --------------- +18 | *int -\u003e 0 1 i --------------------------- +10 | \u0026funcval --------------------------- main.create栈 +08 | --------------------------- +00 | --------------------------- SP --------------- 捕获参数 如果是参数被捕获，那么调用者依然从栈上传递参数，但是被调用函数会把它拷贝到堆上一份，然后和闭包函数都使用堆上分配的那一个。\n值传递参数时。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func Te1(a int) func() int { // 此时的a参数在堆上分配 // 返回闭包捕获了函数参数，参数a会被复制到堆上供整个Te1函数及返回闭包使用 // 堆分配 struct { F uintptr; a *int } return func() int { a++ return a } } func main() { var a1 int f := Te1(a1) fmt.Println(f()) // 1 fmt.Println(a1) // 0 // 可以看出 参数被闭包捕获关系的只是捕获函数内相关参数，参看下面汇编 } 值传递参数 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package main func main() { a1 := 1 b := Te1(a1) b() } //go:noinline func Te1(a int) func() int { // 返回闭包捕获了函数参数 // 参数a会被复制到堆上供整个Te1函数及返回闭包使用 // struct { F uintptr; a *int } // 根据汇编可见，Te1堆分配了a，并把传入的参数1拷贝给了a。 return func() int { a++ return a } } main 函数汇编代码。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 func main() { 0x4551e0 493b6610 CMPQ 0x10(R14), SP 0x4551e4 7638 JBE 0x45521e 0x4551e6 4883ec20 SUBQ $0x20, SP 0x4551ea 48896c2418 MOVQ BP, 0x18(SP) 0x4551ef 488d6c2418 LEAQ 0x18(SP), BP a1 := 1 0x4551f4 48c744240801000000 MOVQ $0x1, 0x8(SP) # a1=1 b := Te1(a1) 0x4551fd b801000000 MOVL $0x1, AX # AX=0x1 0x455202 e839000000 CALL main.Te1(SB) # 调用函数 0x455207 4889442410 MOVQ AX, 0x10(SP) b() 0x45520c 488b08 MOVQ 0(AX), CX # CX=funcval.fn 0x45520f 4889c2 MOVQ AX, DX # DX=\u0026funcval 0x455212 ffd1 CALL CX } 0x455214 488b6c2418 MOVQ 0x18(SP), BP 0x455219 4883c420 ADDQ $0x20, SP 0x45521d c3 RET func main() { 0x45521e 6690 NOPW 0x455220 e83bcdffff CALL runtime.morestack_noctxt.abi0(SB) 0x455225 ebb9 JMP main.main(SB) main.Te1 函数汇编代码。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 func Te1(a int) func() int { 0x455240 493b6610 CMPQ 0x10(R14), SP 0x455244 0f8691000000 JBE 0x4552db 0x45524a 4883ec30 SUBQ $0x30, SP 0x45524e 48896c2428 MOVQ BP, 0x28(SP) 0x455253 488d6c2428 LEAQ 0x28(SP), BP 0x455258 4889442438 MOVQ AX, 0x38(SP) # 参数a 0x45525d 48c744241000000000 MOVQ $0x0, 0x10(SP) 0x455266 488d05d34a0000 LEAQ 0x4ad3(IP), AX # AX=0x4ad3(IP)，int元类型，参数a堆分配 0x45526d e8ce5cfbff CALL runtime.newobject(SB) # 申请内存 AX=\u0026int *int 0x455272 4889442420 MOVQ AX, 0x20(SP) # 堆分配的变量a *int 0x455277 488b4c2438 MOVQ 0x38(SP), CX # CX=1 0x45527c 488908 MOVQ CX, 0(AX) # AX=\u0026int -\u003e 1 return func() int { # struct { F uintptr; a *int } 0x45527f 488d055a740000 LEAQ 0x745a(IP), AX # AX=0x745a(IP)，funcval结构体元类型，占16B 0x455286 e8b55cfbff CALL runtime.newobject(SB) # 申请内存，AX=\u0026funcval 0x45528b 4889442418 MOVQ AX, 0x18(SP) 0x455290 488d0d69000000 LEAQ main.Te1.func1(SB), CX # CX=main.Te1.func1 0x455297 488908 MOVQ CX, 0(AX) # funcval.fn=main.Te1.func1 0x45529a 488b4c2418 MOVQ 0x18(SP), CX # CX=\u0026funcval 0x45529f 8401 TESTB AL, 0(CX) 0x4552a1 488b542420 MOVQ 0x20(SP), DX # DX=\u0026int 0x4552a6 488d7908 LEAQ 0x8(CX), DI # DI=funcval.data 0x4552aa 833daf1f090000 CMPL $0x0, runtime.writeBarrier(SB) 0x4552b1 7402 JE 0x4552b5 0x4552b3 eb0b JMP 0x4552c0 0x4552b5 48895108 MOVQ DX, 0x8(CX) # funcval.data=\u0026int 0x4552b9 eb0c JMP 0x4552c7 0x4552bb 0f1f440000 NOPL 0(AX)(AX*1) 0x4552c0 e87bd0ffff CALL runtime.gcWriteBarrierDX(SB) 0x4552c5 eb00 JMP 0x4552c7 0x4552c7 488b442418 MOVQ 0x18(SP), AX # AX=\u0026funcval 0x4552cc 4889442410 MOVQ AX, 0x10(SP) 0x4552d1 488b6c2428 MOVQ 0x28(SP), BP 0x4552d6 4883c430 ADDQ $0x30, SP 0x4552da c3 RET func Te1(a int) func() int { 0x4552db 4889442408 MOVQ AX, 0x8(SP) 0x4552e0 e87bccffff CALL runtime.morestack_noctxt.abi0(SB) 0x4552e5 488b442408 MOVQ 0x8(SP), AX 0x4552ea e951ffffff JMP main.Te1(SB) main.Te1.func1 函数汇编代码。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 TEXT main.Te1.func1(SB) /mnt/hgfs/workspace/helium/main.go return func() int { 0x455300 4883ec18 SUBQ $0x18, SP 0x455304 48896c2410 MOVQ BP, 0x10(SP) 0x455309 488d6c2410 LEAQ 0x10(SP), BP 0x45530e 488b4a08 MOVQ 0x8(DX), CX 0x455312 48894c2408 MOVQ CX, 0x8(SP) 0x455317 48c7042400000000 MOVQ $0x0, 0(SP) a++ 0x45531f 488b4c2408 MOVQ 0x8(SP), CX 0x455324 488b09 MOVQ 0(CX), CX 0x455327 488b542408 MOVQ 0x8(SP), DX 0x45532c 48ffc1 INCQ CX 0x45532f 48890a MOVQ CX, 0(DX) return a 0x455332 488b4c2408 MOVQ 0x8(SP), CX 0x455337 488b01 MOVQ 0(CX), AX 0x45533a 48890424 MOVQ AX, 0(SP) 0x45533e 488b6c2410 MOVQ 0x10(SP), BP 0x455343 4883c418 ADDQ $0x18, SP 0x455347 c3 RET 栈布局信息。 +58 +20 | runtime.main callback ---------------------------------- +50 +18 | runtime.main BP ---------------------------------- BP -------------- +48 +10 | \u0026funcval 变量b ---------------------------------- +40 +08 | 0x1 变量a1 main.main栈 ---------------------------------- +38 +00 | 0x1 参数a ---------------------------------- SP -------------- +30 | main.main callback ---------------------------------- +28 | main.main BP ---------------------------------- BP -------------- +20 | \u0026int -\u003e 1 a ---------------------------------- +18 | \u0026funcval r.o ---------------------------------- +10 | \u0026funcval r main.Te1栈 ---------------------------------- +08 | ---------------------------------- +00 | ---------------------------------- SP -------------- 引用传递参数时。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // 如果捕获的是指针情况呢，根据下面代码可以看出跟上面情况一样的规则 // 这种情况跟捕获全局变量基本表现一致 func Te1(a *int) func() int { // 返回闭包捕获了函数参数，参数a会被复制到栈上供整个Te1函数及返回闭包使用 // 堆分配 struct { F uintptr; a *int } return func() int { *a++ return *a } } func main() { var a1 int f := Te1(\u0026a1) fmt.Println(a1) // 0 fmt.Println(f()) // 1 fmt.Println(a1) // 1 a1++ fmt.Println(f()) // 3 fmt.Println(a1) // 3 // 注意这里下面的一行代码，会先执行f() f() 在打印所以出现了奇怪的输出 // 因为参数会先被实时计算，因此先执行了f()和f()，然后再打印数据的。 // fmt.Println(a1, f(), a1, f(), a1) // 2 1 2 2 2 } 引用传递参数 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 package main func main() { a1 := 1 b := Te1(\u0026a1) b() } //go:noinline func Te1(a *int) func() int { // 返回闭包捕获了函数参数 // 参数a会被复制到堆上供整个Te1函数及返回闭包使用 // struct { F uintptr; a *int } return func() int { *a++ return *a } } main 函数汇编代码。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func main() { 0x4551e0 493b6610 CMPQ 0x10(R14), SP 0x4551e4 764c JBE 0x455232 0x4551e6 4883ec28 SUBQ $0x28, SP 0x4551ea 48896c2420 MOVQ BP, 0x20(SP) 0x4551ef 488d6c2420 LEAQ 0x20(SP), BP a1 := 1 # 这里可以看出，直接就给a堆分配了 0x4551f4 488d05454b0000 LEAQ 0x4b45(IP), AX # AX=0x4b45(IP)，int元类型 0x4551fb 0f1f440000 NOPL 0(AX)(AX*1) 0x455200 e83b5dfbff CALL runtime.newobject(SB) # AX=\u0026int 0x455205 4889442418 MOVQ AX, 0x18(SP) 0x45520a 48c70001000000 MOVQ $0x1, 0(AX) # a=1 b := Te1(\u0026a1) 0x455211 488b442418 MOVQ 0x18(SP), AX # AX=\u0026int 0x455216 e825000000 CALL main.Te1(SB) # 调用函数，AX=\u0026funcval 0x45521b 4889442410 MOVQ AX, 0x10(SP) b() 0x455220 488b08 MOVQ 0(AX), CX # CX=funcval.fn 0x455223 4889c2 MOVQ AX, DX # DX=\u0026funcval 0x455226 ffd1 CALL CX # 调用函数 } 0x455228 488b6c2420 MOVQ 0x20(SP), BP 0x45522d 4883c428 ADDQ $0x28, SP 0x455231 c3 RET func main() { 0x455232 e829cdffff CALL runtime.morestack_noctxt.abi0(SB) 0x455237 eba7 JMP main.main(SB) main.Te1 函数汇编代码。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 func Te1(a *int) func() int { 0x455240 493b6610 CMPQ 0x10(R14), SP 0x455244 7675 JBE 0x4552bb 0x455246 4883ec28 SUBQ $0x28, SP 0x45524a 48896c2420 MOVQ BP, 0x20(SP) 0x45524f 488d6c2420 LEAQ 0x20(SP), BP 0x455254 4889442430 MOVQ AX, 0x30(SP) # 参数a *int 0x455259 48c744241000000000 MOVQ $0x0, 0x10(SP) # 返回值 func() int return func() int { # struct { F uintptr; i *int } 0x455262 488d0577740000 LEAQ 0x7477(IP), AX # AX=0x7477(IP)，funcval结构体 16B 0x455269 e8d25cfbff CALL runtime.newobject(SB # AX=\u0026funcval 0x45526e 4889442418 MOVQ AX, 0x18(SP) 0x455273 488d0d66000000 LEAQ main.Te1.func1(SB), CX # CX=main.Te1.func1 0x45527a 488908 MOVQ CX, 0(AX) # funcval.fn=main.Te1.func1 0x45527d 488b4c2418 MOVQ 0x18(SP), CX # CX=\u0026funcval 0x455282 8401 TESTB AL, 0(CX) 0x455284 488b542430 MOVQ 0x30(SP), DX # DX=\u0026int 0x455289 488d7908 LEAQ 0x8(CX), DI # DI=funcval.data 0x45528d 833dcc1f090000 CMPL $0x0, runtime.writeBarrier(SB) 0x455294 7402 JE 0x455298 0x455296 eb08 JMP 0x4552a0 0x455298 48895108 MOVQ DX, 0x8(CX) # funcval.data=\u0026int 0x45529c eb09 JMP 0x4552a7 0x45529e 6690 NOPW 0x4552a0 e89bd0ffff CALL runtime.gcWriteBarrierDX(SB) 0x4552a5 eb00 JMP 0x4552a7 0x4552a7 488b442418 MOVQ 0x18(SP), AX # AX=\u0026funcval 0x4552ac 4889442410 MOVQ AX, 0x10(SP) 0x4552b1 488b6c2420 MOVQ 0x20(SP), BP 0x4552b6 4883c428 ADDQ $0x28, SP 0x4552ba c3 RET main.Te1.func1 函数汇编代码。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func Te1(a *int) func() int { 0x4552bb 4889442408 MOVQ AX, 0x8(SP) 0x4552c0 e89bccffff CALL runtime.morestack_noctxt.abi0(SB) 0x4552c5 488b442408 MOVQ 0x8(SP), AX 0x4552ca e971ffffff JMP main.Te1(SB) return func() int { 0x4552e0 4883ec18 SUBQ $0x18, SP 0x4552e4 48896c2410 MOVQ BP, 0x10(SP) 0x4552e9 488d6c2410 LEAQ 0x10(SP), BP 0x4552ee 488b4a08 MOVQ 0x8(DX), CX # CX=\u0026int 0x4552f2 48894c2408 MOVQ CX, 0x8(SP) 0x4552f7 48c7042400000000 MOVQ $0x0, 0(SP) *a++ 0x4552ff 488b4c2408 MOVQ 0x8(SP), CX # CX=\u0026int 0x455304 8401 TESTB AL, 0(CX) 0x455306 488b542408 MOVQ 0x8(SP), DX # DX=\u0026int 0x45530b 8402 TESTB AL, 0(DX) 0x45530d 488b09 MOVQ 0(CX), CX # CX=1 0x455310 48ffc1 INCQ CX # CX=2 0x455313 48890a MOVQ CX, 0(DX) # \u0026int -\u003e 2 return *a 0x455316 488b4c2408 MOVQ 0x8(SP), CX # CX=\u0026int 0x45531b 8401 TESTB AL, 0(CX) 0x45531d 488b01 MOVQ 0(CX), AX # AX=2 0x455320 48890424 MOVQ AX, 0(SP) 0x455324 488b6c2410 MOVQ 0x10(SP), BP 0x455329 4883c418 ADDQ $0x18, SP 0x45532d c3 RET 栈分布情况。 +58 +28 | address of runtime.main ------------------------------ +50 +20 | BP of runtime.main ------------------------------ BP +48 +18 | \u0026int -\u003e 1 a1 ------------------------------ +40 +10 | \u0026funcval b ------------------------------ +38 +08 | ------------------------------ +30 +00 | \u0026int T.a ------------------------------ SP +28 | address of main.main ------------------------------ +20 | BP of main.main ------------------------------ BP +18 | \u0026funcval T.o ------------------------------ +10 | \u0026funcval T.r ------------------------------ +08 | ------------------------------ +00 | ------------------------------ SP 捕获返回值 如果是返回值被捕获，那么处理方式就又有些不同了。 返回值空间依然由调用者在栈上分配，但是被调用函数（闭包的外层函数）会在堆上也分配一个，并且与闭包函数都使用堆上这一个，但是，在外层函数返回前要把堆上的返回值拷贝到栈上那一个。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 package main func main() { b, _ := Te1() b() } //go:noinline func Te1() (y func() int, y1 int) { y1++ // 1 // 堆分配 struct { F uintptr; y1 *int } return func() int { y1++ return 1 }, y1 } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 func main() { 0x4551e0 493b6610 CMPQ 0x10(R14), SP 0x4551e4 763b JBE 0x455221 0x4551e6 4883ec18 SUBQ $0x18, SP 0x4551ea 48896c2410 MOVQ BP, 0x10(SP) 0x4551ef 488d6c2410 LEAQ 0x10(SP), BP b, _ := Te1() 0x4551f4 48c744240800000000 MOVQ $0x0, 0x8(SP) 0x4551fd 0f1f00 NOPL 0(AX) 0x455200 e83b000000 CALL main.Te1(SB) 0x455205 4889442408 MOVQ AX, 0x8(SP) 0x45520a 48890424 MOVQ AX, 0(SP) b() 0x45520e 488b1424 MOVQ 0(SP), DX 0x455212 488b02 MOVQ 0(DX), AX 0x455215 ffd0 CALL AX } 0x455217 488b6c2410 MOVQ 0x10(SP), BP 0x45521c 4883c418 ADDQ $0x18, SP 0x455220 c3 RET func main() { 0x455221 e83acdffff CALL runtime.morestack_noctxt.abi0(SB) 0x455226 ebb8 JMP main.main(SB) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 func Te1() (y func() int, y1 int) { 0x455240 493b6610 CMPQ 0x10(R14), SP 0x455244 0f868e000000 JBE 0x4552d8 0x45524a 4883ec30 SUBQ $0x30, SP 0x45524e 48896c2428 MOVQ BP, 0x28(SP) 0x455253 488d6c2428 LEAQ 0x28(SP), BP 0x455258 48c744241000000000 MOVQ $0x0, 0x10(SP) 0x455261 488d05d84a0000 LEAQ 0x4ad8(IP), AX # AX=0x4ad8(IP)，int元类型 0x455268 e8d35cfbff CALL runtime.newobject(SB) # AX=\u0026int 0x45526d 4889442420 MOVQ AX, 0x20(SP) y1++ 0x455272 48ff00 INCQ 0(AX) # y1=1 return func() int { # struct { F uintptr; y1 *int } 0x455275 488d0564740000 LEAQ 0x7464(IP), AX # AX=0x7464(IP)，funcval元类型 16B 0x45527c 0f1f4000 NOPL 0(AX) 0x455280 e8bb5cfbff CALL runtime.newobject(SB) # AX=\u0026funcval 0x455285 4889442418 MOVQ AX, 0x18(SP) 0x45528a 488d0d6f000000 LEAQ main.Te1.func1(SB), CX # CX=main.Te1.func1 0x455291 488908 MOVQ CX, 0(AX) # funcval.fn=main.Te1.func1 0x455294 488b4c2418 MOVQ 0x18(SP), CX # CX=\u0026funcval 0x455299 8401 TESTB AL, 0(CX) 0x45529b 488b542420 MOVQ 0x20(SP), DX # DX=\u0026int 0x4552a0 488d7908 LEAQ 0x8(CX), DI # DI=funcval.data 0x4552a4 833db51f090000 CMPL $0x0, runtime.writeBarrier(SB) 0x4552ab 7402 JE 0x4552af 0x4552ad eb06 JMP 0x4552b5 0x4552af 48895108 MOVQ DX, 0x8(CX) # funcval.data=\u0026int 0x4552b3 eb07 JMP 0x4552bc 0x4552b5 e886d0ffff CALL runtime.gcWriteBarrierDX(SB) 0x4552ba eb00 JMP 0x4552bc 0x4552bc 488b442418 MOVQ 0x18(SP), AX # AX=\u0026funcval 返回参数1 0x4552c1 4889442410 MOVQ AX, 0x10(SP) 0x4552c6 488b4c2420 MOVQ 0x20(SP), CX # CX=\u0026int 0x4552cb 488b19 MOVQ 0(CX), BX # BX=1 返回参数2 0x4552ce 488b6c2428 MOVQ 0x28(SP), BP 0x4552d3 4883c430 ADDQ $0x30, SP 0x4552d7 c3 RET func Te1() (y func() int, y1 int) { 0x4552d8 e883ccffff CALL runtime.morestack_noctxt.abi0(SB) 0x4552dd 0f1f00 NOPL 0(AX) 0x4552e0 e95bffffff JMP main.Te1(SB) +50 +18 | address of runtime.main ----------------------------- +48 +10 | BP of runtime.main ----------------------------- BP +40 +08 | 0 ----------------------------- +38 +00 | ----------------------------- SP +30 | address of main.main ----------------------------- +28 | BP of main.main ----------------------------- BP +20 | \u0026int 1 y1 ----------------------------- +18 | \u0026funcval y ----------------------------- +10 | \u0026funcval ----------------------------- +08 | ----------------------------- +00 | ----------------------------- SP 自己捕获自己 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 package main func main() { x()() } //go:noinline func x() (y func()) { // struct { F uintptr } y = func() { //println(\"y\") } // defer在return赋值完成之后执行 //defer func() { //\ty = func() { // fmt.Println(\"我能改变了Y的值？\") //\t} //}() // struct { F uintptr; y *func() } return func() { //println(\"z\") y() } } main 汇编代码。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func main() { 0x4551e0 493b6610 CMPQ 0x10(R14), SP 0x4551e4 7629 JBE 0x45520f 0x4551e6 4883ec10 SUBQ $0x10, SP 0x4551ea 48896c2408 MOVQ BP, 0x8(SP) 0x4551ef 488d6c2408 LEAQ 0x8(SP), BP x()() 0x4551f4 e847000000 CALL main.x(SB) # AX=\u0026funcval 0x4551f9 48890424 MOVQ AX, 0(SP) 0x4551fd 488b08 MOVQ 0(AX), CX # CX=funcval.fn 0x455200 4889c2 MOVQ AX, DX # DX=\u0026funcval 0x455203 ffd1 CALL CX } 0x455205 488b6c2408 MOVQ 0x8(SP), BP 0x45520a 4883c410 ADDQ $0x10, SP 0x45520e c3 RET func main() { 0x45520f e84ccdffff CALL runtime.morestack_noctxt.abi0(SB) 0x455214 ebca JMP main.main(SB) x 汇编代码。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 func x() (y func()) { 0x455240 493b6610 CMPQ 0x10(R14), SP 0x455244 0f86bf000000 JBE 0x455309 0x45524a 4883ec28 SUBQ $0x28, SP 0x45524e 48896c2420 MOVQ BP, 0x20(SP) 0x455253 488d6c2420 LEAQ 0x20(SP), BP # func() 变量y 0x455258 488d05e1480000 LEAQ 0x48e1(IP), AX # AX=0x48e1(IP)，funcval元类型 0x45525f 90 NOPL 0x455260 e8db5cfbff CALL runtime.newobject(SB) # AX=\u0026funcval 0x455265 4889442418 MOVQ AX, 0x18(SP) y = func() { 0x45526a 833def1f090000 CMPL $0x0, runtime.writeBarrier(SB) 0x455271 7402 JE 0x455275 0x455273 eb0d JMP 0x455282 # funcval.fn -\u003e println(\"y\") 替换 y 0x455275 488d0d841d0100 LEAQ 0x11d84(IP), CX # CX=0x11d84(IP)，函数代码处 0x45527c 488908 MOVQ CX, 0(AX) # funcval.fn=0x11d84(IP) 0x45527f 90 NOPL 0x455280 eb11 JMP 0x455293 0x455282 4889c7 MOVQ AX, DI 0x455285 488d0d741d0100 LEAQ 0x11d74(IP), CX 0x45528c e88fd0ffff CALL runtime.gcWriteBarrierCX(SB) 0x455291 eb00 JMP 0x455293 return func() { # struct { F uintptr; y *func() } 0x455293 488d0586740000 LEAQ 0x7486(IP), AX # AX=0x7486(IP)，funcval元类型 16B 0x45529a e8a15cfbff CALL runtime.newobject(SB) # AX=\u0026funcval.1 0x45529f 4889442410 MOVQ AX, 0x10(SP) 0x4552a4 488d0d75000000 LEAQ main.x.func2(SB), CX # CX=main.x.func2 0x4552ab 488908 MOVQ CX, 0(AX) # funcval.1.fn=main.x.func2 0x4552ae 488b4c2410 MOVQ 0x10(SP), CX # CX=\u0026funcval.1 0x4552b3 8401 TESTB AL, 0(CX) 0x4552b5 488b542418 MOVQ 0x18(SP), DX # DX=\u0026funcval 0x4552ba 488d7908 LEAQ 0x8(CX), DI # DI=funcval.1.data 0x4552be 833d9b1f090000 CMPL $0x0, runtime.writeBarrier(SB) 0x4552c5 7402 JE 0x4552c9 0x4552c7 eb06 JMP 0x4552cf 0x4552c9 48895108 MOVQ DX, 0x8(CX) # funcval.1.data=\u0026funcval 0x4552cd eb07 JMP 0x4552d6 0x4552cf e86cd0ffff CALL runtime.gcWriteBarrierDX(SB) 0x4552d4 eb00 JMP 0x4552d6 0x4552d6 488b7c2418 MOVQ 0x18(SP), DI # DI=\u0026funcval 0x4552db 488b4c2410 MOVQ 0x10(SP), CX # CX=\u0026funcval.1 0x4552e0 833d791f090000 CMPL $0x0, runtime.writeBarrier(SB) 0x4552e7 7402 JE 0x4552eb 0x4552e9 eb05 JMP 0x4552f0 0x4552eb 48890f MOVQ CX, 0(DI) # funcval.fn=\u0026funcval.1 0x4552ee eb07 JMP 0x4552f7 0x4552f0 e82bd0ffff CALL runtime.gcWriteBarrierCX(SB) 0x4552f5 eb00 JMP 0x4552f7 0x4552f7 488b4c2418 MOVQ 0x18(SP), CX # CX=\u0026funcval 0x4552fc 488b01 MOVQ 0(CX), AX # AX=funcval.fn 0x4552ff 488b6c2420 MOVQ 0x20(SP), BP 0x455304 4883c428 ADDQ $0x28, SP 0x455308 c3 RET func x() (y func()) { 0x455309 e852ccffff CALL runtime.morestack_noctxt.abi0(SB) 0x45530e e92dffffff JMP main.x(SB) unsafe Go语言里Function Value本质上是指向funcval结构体的指针 Go语言里闭包只是拥有捕获列表的Function Value 捕获变量在外层函数与闭包函数中要保持一致 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 package main import ( \"fmt\" \"unsafe\" ) type fv struct { fn unsafe.Pointer i *int // 捕获的变量i } func main() { g := callback() fn := **(**fv)(unsafe.Pointer(\u0026g)) fmt.Printf(\"%#v\\n\", fn) fmt.Println(*(fn.i)) // 13 // Output: // main.fv{fn:(unsafe.Pointer)(0xeccdc0), i:(*int)(0xc00000a098)} // 13 // 可以看出捕获的是i的地址 } func callback() func() { i := 13 // struct { F uintptr; i *int } return func() { i++ } } 参考 本篇文章参考了《深度探索Go语言》书内容。 参考 https://mp.weixin.qq.com/s/hO0S4WcG0hUzCmMNMKtS-g。 ",
  "wordCount" : "6764",
  "inLanguage": "zh",
  "image": "https://heliu.site/favicon-32x32.png","datePublished": "2024-08-03T00:00:00Z",
  "dateModified": "2024-08-03T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://heliu.site/posts/golang/func/value/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://heliu.site/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://heliu.site/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://heliu.site/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://heliu.site/" title="主页">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/posts" title="文章">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/archives" title="时间轴">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/tags/" title="标签">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/search/" title="搜索 (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/support" title="打赏">
                    <span>🫶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://heliu.site/">主页</a>&nbsp;»&nbsp;<a href="https://heliu.site/posts/">Article</a>&nbsp;»&nbsp;<a href="https://heliu.site/posts/golang/">Golang 合集</a>&nbsp;»&nbsp;<a href="https://heliu.site/posts/golang/func/">第9章 Function</a></div>
    <h1 class="post-title entry-hint-parent">
      Function Value
    </h1>
    <div class="post-description">
      💥本文章所有相关go代码参考自go 1.18&#43;版本
    </div>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2024-08-03</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2024-08-03</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>6764字</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>32分钟</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &nbsp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://heliu.site/tags/golang/" target="_blank" rel="noopener">Golang</a>
            <a href="https://heliu.site/tags/%E5%87%BD%E6%95%B0/" target="_blank" rel="noopener">函数</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &nbsp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%87%bd%e6%95%b0%e6%8c%87%e9%92%88" aria-label="函数指针">函数指针</a></li>
                    <li>
                        <a href="#function-value-%e5%88%86%e6%9e%90" aria-label="Function Value 分析">Function Value 分析</a></li>
                    <li>
                        <a href="#%e9%97%ad%e5%8c%85" aria-label="闭包">闭包</a><ul>
                            
                    <li>
                        <a href="#%e9%97%ad%e5%8c%85%e5%af%b9%e8%b1%a1" aria-label="闭包对象">闭包对象</a></li>
                    <li>
                        <a href="#%e7%9c%8b%e5%88%b0%e9%97%ad%e5%8c%85" aria-label="看到闭包">看到闭包</a></li>
                    <li>
                        <a href="#%e8%b0%83%e7%94%a8%e9%97%ad%e5%8c%85" aria-label="调用闭包">调用闭包</a></li>
                    <li>
                        <a href="#%e9%97%ad%e5%8c%85%e4%b8%8e%e5%8f%98%e9%87%8f%e9%80%83%e9%80%b8" aria-label="闭包与变量逃逸">闭包与变量逃逸</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%87%bd%e6%95%b0" aria-label="函数">函数</a></li>
                    <li>
                        <a href="#%e9%97%ad%e5%8c%85-1" aria-label="闭包">闭包</a></li>
                    <li>
                        <a href="#%e8%b0%83%e7%94%a8" aria-label="调用">调用</a></li>
                    <li>
                        <a href="#%e9%9d%99%e6%80%81%e5%88%86%e9%85%8d" aria-label="静态分配">静态分配</a></li>
                    <li>
                        <a href="#%e6%8d%95%e8%8e%b7%e5%88%97%e8%a1%a8" aria-label="捕获列表">捕获列表</a><ul>
                            
                    <li>
                        <a href="#%e6%8d%95%e8%8e%b7%e5%b1%80%e9%83%a8%e5%8f%98%e9%87%8f" aria-label="捕获局部变量">捕获局部变量</a></li>
                    <li>
                        <a href="#%e6%8d%95%e8%8e%b7%e5%8f%82%e6%95%b0" aria-label="捕获参数">捕获参数</a></li>
                    <li>
                        <a href="#%e6%8d%95%e8%8e%b7%e8%bf%94%e5%9b%9e%e5%80%bc" aria-label="捕获返回值">捕获返回值</a></li></ul>
                    </li>
                    <li>
                        <a href="#unsafe" aria-label="unsafe">unsafe</a></li>
                    <li>
                        <a href="#%e5%8f%82%e8%80%83" aria-label="参考">参考</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><ol>
<li>函数在 Go 语言中属于第一类值(First Class Value)，该类型的值可以作为函数的<strong>参数</strong>和<strong>返回值</strong>，也可以赋给<strong>变量</strong>。</li>
<li>当把一个函数赋值给某个变量后，这个变量就被称为 Function Value。</li>
<li>声明一个 Function Value 变量的示例代码如下：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">fn</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span>
</span></span></code></pre></div><ol start="4">
<li>其中 <code>fn</code> 就是个 Function Value 变量，它的类型是 func(int, int) int。</li>
<li>Function Value 可以像一般函数那样被调用，在使用体验上非常类似于 C 语言中的函数指针。</li>
<li>Function Value 本质上是不是函数指针呢？</li>
<li>本节会分析 Function Value 和函数指针的实现原理，还有闭包的实现原理，以及 Function Value 是如何支持闭包的。</li>
</ol>
<h2 id="函数指针">函数指针<a hidden class="anchor" aria-hidden="true" href="#函数指针">#</a></h2>
<ol>
<li>熟悉 C 语言的读者应该有过使用函数指针的经验，函数指针存储的都是地址，只不过不是指向某种类型的数据。</li>
<li>而是指向代码段中某个函数的第一条指令，如图所示。</li>
</ol>
<p><img loading="lazy" src="../images/func-001.png" alt=""  />
</p>
<h2 id="function-value-分析">Function Value 分析<a hidden class="anchor" aria-hidden="true" href="#function-value-分析">#</a></h2>
<ol>
<li>准备一个 <code>go</code> 文件并写入，示例代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">println</span><span class="p">(</span><span class="nf">helper</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">helper</span><span class="p">(</span><span class="nx">fn</span> <span class="kd">func</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">fn</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>依然把 Function Value 的调用隔离在一个函数中，以便于分析。<code>main.helper</code>反编译代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">go</span> <span class="no">build</span> <span class="p">-</span><span class="no">gcflags</span><span class="err">=&#34;</span><span class="p">-</span><span class="no">N</span> <span class="p">-</span><span class="no">l</span><span class="err">&#34;</span> <span class="p">-</span><span class="no">o</span> <span class="p">.</span><span class="err">/</span><span class="no">h1</span> <span class="no">myzx.cn</span><span class="err">/</span><span class="no">helium</span>
</span></span><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">go</span> <span class="no">tool</span> <span class="no">objdump</span> <span class="p">-</span><span class="no">S</span> <span class="p">-</span><span class="no">s</span> <span class="err">&#39;^</span><span class="no">main.helper$</span><span class="err">&#39;</span> <span class="p">.</span><span class="err">/</span><span class="no">h1</span> 
</span></span><span class="line"><span class="cl"><span class="no">TEXT</span> <span class="no">main.helper</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">helper</span><span class="p">(</span><span class="no">fn</span> <span class="no">func</span><span class="p">(</span><span class="no">int</span><span class="p">,</span> <span class="no">int</span><span class="p">)</span> <span class="no">int</span><span class="p">,</span> <span class="no">a</span><span class="p">,</span> <span class="no">b</span> <span class="no">int</span><span class="p">)</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455240</span>      <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>  <span class="c1"># 栈增长判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455244</span>      <span class="mi">7650</span>                <span class="no">JBE</span> <span class="mi">0x455296</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455246</span>      <span class="mi">4883</span><span class="no">ec28</span>            <span class="no">SUBQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45524a</span>      <span class="mi">48896</span><span class="no">c2420</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45524f</span>      <span class="mi">488</span><span class="no">d6c2420</span>          <span class="no">LEAQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455254</span>      <span class="mi">4889442430</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455259</span>      <span class="mi">48895</span><span class="no">c2438</span>          <span class="no">MOVQ</span> <span class="no">BX</span><span class="p">,</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45525e</span>      <span class="mi">48894</span><span class="no">c2440</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x40</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455263</span>      <span class="mi">48</span><span class="no">c744241000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span> <span class="c1"># return int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">return</span> <span class="no">fn</span><span class="p">(</span><span class="no">a</span><span class="p">,</span> <span class="no">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45526c</span>      <span class="mi">488</span><span class="no">b442438</span>          <span class="no">MOVQ</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>   <span class="c1"># AX=a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455271</span>      <span class="mi">488</span><span class="no">b5c2440</span>          <span class="no">MOVQ</span> <span class="mi">0x40</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BX</span>   <span class="c1"># BX=b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455276</span>      <span class="mi">488</span><span class="no">b542430</span>          <span class="no">MOVQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>   <span class="c1"># DX=fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># 这里看出 Function Value 是一个二级指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45527b</span>      <span class="mi">488</span><span class="no">b0a</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">CX</span>      <span class="c1"># CX=fn.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45527e</span>      <span class="mi">6690</span>                <span class="no">NOPW</span>            
</span></span><span class="line"><span class="cl">  <span class="c1"># DX 寄存器存储的是 fn，也就是上下文
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># CALL CX; 指令说明，CX寄存器最终存储的是实际函数的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455280</span>      <span class="no">ffd1</span>                <span class="no">CALL</span> <span class="no">CX</span>             <span class="c1"># CALL fn.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455282</span>      <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455287</span>      <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45528c</span>      <span class="mi">488</span><span class="no">b6c2420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455291</span>      <span class="mi">4883</span><span class="no">c428</span>            <span class="no">ADDQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455295</span>      <span class="no">c3</span>                  <span class="no">RET</span>            
</span></span><span class="line"><span class="cl"><span class="no">func</span> <span class="no">helper</span><span class="p">(</span><span class="no">fn</span> <span class="no">func</span><span class="p">(</span><span class="no">int</span><span class="p">,</span> <span class="no">int</span><span class="p">)</span> <span class="no">int</span><span class="p">,</span> <span class="no">a</span><span class="p">,</span> <span class="no">b</span> <span class="no">int</span><span class="p">)</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455296</span>      <span class="mi">4889442408</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x45529b</span>      <span class="mi">48895</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">BX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552a0</span>      <span class="mi">48894</span><span class="no">c2418</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552a5</span>      <span class="no">e8b6ccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552aa</span>      <span class="mi">488</span><span class="no">b442408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552af</span>      <span class="mi">488</span><span class="no">b5c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BX</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552b4</span>      <span class="mi">488</span><span class="no">b4c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552b9</span>      <span class="no">eb85</span>                <span class="no">JMP</span> <span class="no">main.helper</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>通过上述逻辑，可以确定Function Value确实是个指针，而且是个<strong>两级指针</strong>。</li>
<li>如图所示，Function Value 不直接指向目标函数，而是一个目标函数的指针。</li>
</ol>
<p><img loading="lazy" src="../images/func-002.png" alt=""  />
</p>
<h2 id="闭包">闭包<a hidden class="anchor" aria-hidden="true" href="#闭包">#</a></h2>
<ol>
<li>说到<code>Go</code>语言的闭包，比较直观的感受就是个有状态的 Function Value。</li>
<li>在<code>Go</code>语言中比较典型的闭包场景就是在某个函数内定义了另一个函数，内层函数使用了外层函数的局部变量，并且内层函数最终被外层函数作为返回值返回。</li>
<li>代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mc</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>每次调用 <code>mc()</code> 函数都会返回一个新的闭包，闭包记住了参数的值，所以是有状态的。</li>
<li>基于目前对函数栈帧的了解，函数栈帧随着函数返回而销毁，不能用来保存状态。</li>
<li>研究函数指针和 Function Value 的时候也没有发现哪里用来保存状态，所以这里就有个问题，闭包的状态保存在哪里呢？</li>
</ol>
<h3 id="闭包对象">闭包对象<a hidden class="anchor" aria-hidden="true" href="#闭包对象">#</a></h3>
<ol>
<li>为了摘清楚这个问题，先来尝试一下反编译，从汇编代码中找答案，<code>main.mc</code>反编译代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">go</span> <span class="no">build</span> <span class="p">-</span><span class="no">gcflags</span><span class="err">=&#34;</span><span class="p">-</span><span class="no">N</span> <span class="p">-</span><span class="no">l</span><span class="err">&#34;</span> <span class="p">-</span><span class="no">o</span> <span class="p">.</span><span class="err">/</span><span class="no">h1</span> <span class="no">myzx.cn</span><span class="err">/</span><span class="no">helium</span>
</span></span><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">go</span> <span class="no">tool</span> <span class="no">objdump</span> <span class="p">-</span><span class="no">S</span> <span class="p">-</span><span class="no">s</span> <span class="err">&#39;^</span><span class="no">main.mc$</span><span class="err">&#39;</span> <span class="p">.</span><span class="err">/</span><span class="no">h1</span> 
</span></span><span class="line"><span class="cl"><span class="no">TEXT</span> <span class="no">main.mc</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">mc</span><span class="p">(</span><span class="no">n</span> <span class="no">int</span><span class="p">)</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>      <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>  <span class="c1"># 栈增长判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455224</span>      <span class="mi">765</span><span class="no">b</span>                <span class="no">JBE</span> <span class="mi">0x455281</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455226</span>      <span class="mi">4883</span><span class="no">ec28</span>            <span class="no">SUBQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45522a</span>      <span class="mi">48896</span><span class="no">c2420</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45522f</span>      <span class="mi">488</span><span class="no">d6c2420</span>          <span class="no">LEAQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="c1"># 参数栈空间分配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455234</span>      <span class="mi">4889442430</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># 返回值栈空间分配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455239</span>      <span class="mi">48</span><span class="no">c744241000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span> <span class="c1"># return func() int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 0x7497(IP) 是 Function Value 的结构元类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># type funcval struct {fn unsafe.Pointer, n int}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455242</span>      <span class="mi">488</span><span class="no">d0597740000</span>      <span class="no">LEAQ</span> <span class="mi">0x7497</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span> <span class="c1"># Function Value 结构的元类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># 创建 funcval 结构需要的内存空间，是堆分配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455249</span>      <span class="no">e8f25cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45524e</span>      <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">  <span class="c1"># 这里main.mc.func1(SB)是mc返回的闭包在代码段的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455253</span>      <span class="mi">488</span><span class="no">d0d46000000</span>      <span class="no">LEAQ</span> <span class="no">main.mc.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">CX</span>  <span class="c1"># CX=main.mc.func1(SB)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45525a</span>      <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>              <span class="c1"># funcval.fn=main.mc.func1(SB)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45525d</span>      <span class="mi">488</span><span class="no">b4c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455262</span>      <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x455264</span>      <span class="mi">488</span><span class="no">b542430</span>          <span class="no">MOVQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>           <span class="c1"># DX=n    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># 可以看出这里捕获了变量n，并且是拷贝捕获
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455269</span>      <span class="mi">48895108</span>            <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>            <span class="c1"># funcval.n = n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45526d</span>      <span class="mi">488</span><span class="no">b442418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>           <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455272</span>      <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455277</span>      <span class="mi">488</span><span class="no">b6c2420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45527c</span>      <span class="mi">4883</span><span class="no">c428</span>            <span class="no">ADDQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x455280</span>      <span class="no">c3</span>                  <span class="no">RET</span>                
</span></span><span class="line"><span class="cl"><span class="no">func</span> <span class="no">mc</span><span class="p">(</span><span class="no">n</span> <span class="no">int</span><span class="p">)</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455281</span>      <span class="mi">4889442408</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x455286</span>      <span class="no">e8d5ccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45528b</span>      <span class="mi">488</span><span class="no">b442408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x455290</span>      <span class="no">eb8e</span>                <span class="no">JMP</span> <span class="no">main.mc</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>根据上面代码可以推断出Function Value动态分配的对象的类型。</li>
<li>应该是一个 struct 类型，<strong>第1个字段是函数地址</strong>，<strong>第2个字段是 int 类型</strong>，代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">F</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">n</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>说明编译器识别出了闭包这种代码模式，并且自动定义了这个 struct 类型进行支持，出于面向对象编程中把数据称为对象的习惯，后文中就把这种 struct 称为闭包对象。</li>
<li>闭包对象的成员可以进一步划分，<strong>第1个字段F用来存储目标函数的地址</strong>，这在所有的闭包对象中都是一致的，后文中将这个目标函数称为闭包函数。</li>
<li>从第2个字段开始，后续的字段称为闭包的<strong>捕获列表</strong>，也就是内层函数中用到的所有定义在外层函数中的变量。</li>
<li>编译器认为这些变量被闭包捕获了，会把它们<strong>追加</strong>到闭包对象的 struct 定义中。</li>
<li>上例中只捕获了一个变量 <code>n</code>，如果捕获的变量增多，struct 的捕获列表也会加长。</li>
<li>一个捕获两个变量的闭包示例代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mc</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">m</span> <span class="kt">int</span><span class="p">)</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">m</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="10">
<li>上述代码对应的闭包对象定义代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">F</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">n</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">m</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="看到闭包">看到闭包<a hidden class="anchor" aria-hidden="true" href="#看到闭包">#</a></h3>
<ol>
<li>通过反编译来逆向推断闭包对象的结构还是比较烦琐的，如果能有一种方法，能够直观看到闭包对象的结构定义，那真是再好不过了。</li>
<li>根据之前的探索，已经知道 <code>Go</code> 序在运行阶段会通过 <code>runtime.newobject()</code> 函数动态匹配闭包对象。</li>
<li><code>Go</code> 源码中 <code>newobject()</code> 函数的原型如下：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newobject</span><span class="p">(</span><span class="nx">typ</span> <span class="o">*</span><span class="nx">_type</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span></code></pre></div><ol start="4">
<li>函数的返回值是个指针，也就是新分配的对象的地址，参数是个 <code>_type</code> 类型的指针。</li>
<li>通过源码可以得知这个 <code>_type</code> 是个 <code>struct</code>，在 <code>Go</code> 语言的 <code>runtime</code> 包中被用来描述一个数据类型，通过它可以找到目标数据类型的大小，对齐边界，类型名称等。</li>
<li>假如能够获得传递给 <code>runtime.newobjet()</code> 函数的类型元数据指针 <code>typ</code>，再通过反射进行解析，就能打印出闭包对象的结构定义了。那如何才能获得这个 <code>typ</code> 参数呢？</li>
<li>在<code>C</code>语言中有种常用的函数 Hook 技术，就是在运行阶段将目标函数头部的代码替换为一条跳转指令，跳转到一个新的函数。</li>
<li>在 x86 平台上就是在进程地址空间中找到要 Hook 的函数，将其头部替换为一条 JMP 指令，同时指定 JMP 指令要跳转到的新函数的地址。</li>
<li>这项技术在 Go 程序中依然适用，可以用一个自己实现的函数换掉 <code>runtime.newobject()</code> 函数，在这个函数中就能获得 typ 参数并进行解析了。</li>
<li>还有一个问题是 <code>runtime.newobiect()</code> 函数属于未导出的函数，在<code>runtime</code>包外无法访问。</li>
<li>这一点可以通过 <code>linkname</code> 机制来绕过，在当前包中声明一个类似的函数，让链接器将其链接到<code>runtime.newobject()</code>函数即可。</li>
<li>本书使用开源模块 <code>github.com/fengyoulin/hookingo</code> 实现运行阶段函数替换，打印闭包对象结构的完整代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/fengyoulin/hookingo&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;reflect&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;unsafe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">hno</span> <span class="nx">hookingo</span><span class="p">.</span><span class="nx">Hook</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:linkname newobject runtime.newobject
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newobject</span><span class="p">(</span><span class="nx">typ</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:linkname newobject2 runtime.mallocgc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newobject2</span><span class="p">(</span><span class="nx">size</span> <span class="kt">uintptr</span><span class="p">,</span> <span class="nx">typ</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">bool</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">fno</span><span class="p">(</span><span class="nx">typ</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">t</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">// type Type interface{}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 这里为什么赋值的是下标1？接下来我们分析为什么是1而不是0下标。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 根据后面分析确实是修改下标1，因为t.String()需要用到1这个下标的数据。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">t</span><span class="p">)))[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="nx">typ</span> <span class="c1">// 相当于反射了闭包类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nb">println</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//fn, ok := hno.Origin().(func(typ unsafe.Pointer) unsafe.Pointer)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//if ok {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    return fn(typ) // 调用原runtime.newobject
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//println(&#34;ok&#34;, ok)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//os.Exit(1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nb">println</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">uintptr</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">typ</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">newobject2</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">uintptr</span><span class="p">)(</span><span class="nx">typ</span><span class="p">),</span> <span class="nx">typ</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 创建一个闭包，make closure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mc</span><span class="p">(</span><span class="nx">start</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">text</span> <span class="kt">string</span><span class="p">)</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 这里 start 需要堆分配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// func() string 也需要堆分配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">l</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">s</span> <span class="o">:=</span> <span class="nx">start</span> <span class="o">%</span> <span class="nx">l</span>
</span></span><span class="line"><span class="cl">        <span class="nx">r</span> <span class="o">:=</span> <span class="nx">text</span><span class="p">[</span><span class="nx">s</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">        <span class="nx">start</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">r</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">    <span class="nx">hno</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">hookingo</span><span class="p">.</span><span class="nf">Apply</span><span class="p">(</span><span class="nx">newobject</span><span class="p">,</span> <span class="nx">fno</span><span class="p">)</span> <span class="c1">// 应用钩子，替换函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span> <span class="o">:=</span> <span class="nf">mc</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s">&#34;hello, closure!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">println</span><span class="p">(</span><span class="nf">f</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ C:<span class="se">\U</span>sers<span class="se">\H</span>elium<span class="se">\g</span>o<span class="se">\b</span>in<span class="se">\g</span>o1.17.exe run -gcflags -l .   <span class="c1"># go1.17 版本</span>
</span></span><span class="line"><span class="cl">int         <span class="c1"># 打印的是mc的start堆分配</span>
</span></span><span class="line"><span class="cl"><span class="m">8</span>           <span class="c1"># int 占用内存大小</span>
</span></span><span class="line"><span class="cl">struct <span class="o">{</span> F uintptr<span class="p">;</span> text string<span class="p">;</span> start *int <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="m">32</span>
</span></span><span class="line"><span class="cl">sure!
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ go run -gcflags -l .                                  <span class="c1"># go1.20.3版本</span>
</span></span><span class="line"><span class="cl">int
</span></span><span class="line"><span class="cl"><span class="m">8</span>
</span></span><span class="line"><span class="cl">struct <span class="o">{</span> F uintptr<span class="p">;</span> text string<span class="p">;</span> start *int <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="m">32</span>
</span></span><span class="line"><span class="cl">sure!
</span></span></code></pre></div><ol start="13">
<li>因为<code>start</code>会被修改，所以捕获地址造成堆分配，因此结果第一行打印了一个<code>int</code>。</li>
<li>第二行的<code>struct</code>就是闭包结构的类型，这是通过类型元数据直接获取到的，是由编译器构造的结构类型。</li>
<li>我们抄部分<code>fno()</code>函数的相关代码：<code>typ unsafe.Pointer</code>：来自类型的<code>*_type</code>类型数据。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">fno</span><span class="p">(</span><span class="nx">typ</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">t</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">// type Type interface{}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 这里为什么赋值的是下标1？接下来我们分析为什么是1而不是0下标。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">t</span><span class="p">)))[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="nx">typ</span> <span class="c1">// 相当于反射了闭包类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nb">println</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ... ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="16">
<li>分析<code>reflect.TypeOf()</code>函数如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// TypeOf returns the reflection Type that represents the dynamic type of i.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If i is a nil interface value, TypeOf returns nil.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">TypeOf</span><span class="p">(</span><span class="nx">i</span> <span class="nx">any</span><span class="p">)</span> <span class="nx">Type</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// emptyInterface 是空接口的内存结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">eface</span> <span class="o">:=</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">emptyInterface</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// eface.typ 这里直接取了 typ 字段，没有要word字段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 通过分析toType()函数可知，把eface.typ放入了非空接口Type中。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 因此必须要分析非空接口中存储的是什么？非空接口内存布局
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// type iface struct {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      tab *itab               // 类型元数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      data *unsafe.Pointer    // 装箱的数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 因此 tab *itab 装载的是 *rtype 类型结构，也就是结构体指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 按照传入参数0这里可以看出应该是int的元类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 重要的是 data，这存储的是 *rtype 这个指针数据，类型反射就是依靠这个data。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 因为我们调用Type非空接口的所有方法接收器的参数都是 *rtype，这也就是为什么修改下标1的原因。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 我们在调用t.String()方法时，需要的时data这个是我们想要的类型即可。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nf">toType</span><span class="p">(</span><span class="nx">eface</span><span class="p">.</span><span class="nx">typ</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// emptyInterface is the header for an interface{} value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">emptyInterface</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">typ</span>  <span class="o">*</span><span class="nx">rtype</span>        <span class="c1">// 存储着类型结构
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">word</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/func-003.png" alt=""  />
</p>
<ol start="17">
<li>分析<code>toType()</code>函数如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// toType converts from a *rtype to a Type that can be returned
</span></span></span><span class="line"><span class="cl"><span class="c1">// to the client of package reflect. In gc, the only concern is that
</span></span></span><span class="line"><span class="cl"><span class="c1">// a nil *rtype must be replaced by a nil Type, but in gccgo this
</span></span></span><span class="line"><span class="cl"><span class="c1">// function takes care of ensuring that multiple *rtype for the same
</span></span></span><span class="line"><span class="cl"><span class="c1">// type are coalesced into a single Type.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">toType</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">rtype</span><span class="p">)</span> <span class="nx">Type</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">t</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">t</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="调用闭包">调用闭包<a hidden class="anchor" aria-hidden="true" href="#调用闭包">#</a></h3>
<ol>
<li>闭包函数在被调用的时候，<strong>必须</strong>得到当前闭包对象的地址才能访问其中的捕获列表，这个地址是如何传递的呢？</li>
<li>调用者在调用 Function Value 的时候只是像调用一个普通函数那样传递了声明的参数，如果 Function Value 背后是个闭包函数，则无法通过栈上的参数得到闭包对象地址。</li>
<li>除非编译器传递了一个隐含的参数，这个参数如果通过栈传递，那就改变了函数的原型，这样就会造成不一致，是行不通的。</li>
<li>还是通过反汇编来看一下闭包函数是从哪里得到的这个地址，先来构造闭包，代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mc</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="kd">func</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>根据前面的探索，可以确定闭包对象的结构定义代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">F</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">n</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>反编译闭包函数得到的汇编代码如下：
<ol>
<li>第7行，将 <code>DX</code> 寄存器用作基址,再加上位移 8，把该地址处的值复制到 <code>CX</code> 寄存器中。</li>
<li>第8行，把 <code>CX</code> 寄存器值复制给闭包函数的返回值。</li>
<li>第11行，把返回值放入<code>AX</code>寄存器中。</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">go</span> <span class="no">tool</span> <span class="no">objdump</span> <span class="p">-</span><span class="no">S</span> <span class="p">-</span><span class="no">s</span> <span class="err">&#39;^</span><span class="no">main.mc.func1$</span><span class="err">&#39;</span> <span class="p">.</span><span class="err">/</span><span class="no">h1</span>
</span></span><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.mc.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl">    <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552a0</span>      <span class="mi">4883</span><span class="no">ec18</span>            <span class="no">SUBQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552a4</span>      <span class="mi">48896</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552a9</span>      <span class="mi">488</span><span class="no">d6c2410</span>          <span class="no">LEAQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552ae</span>      <span class="mi">488</span><span class="no">b4a08</span>            <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">CX</span>    <span class="c1"># CX=0x8(DX)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552b2</span>      <span class="mi">48894</span><span class="no">c2408</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552b7</span>      <span class="mi">48</span><span class="no">c7042400000000</span>    <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">        <span class="no">return</span> <span class="no">n</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552bf</span>      <span class="mi">488</span><span class="no">b442408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>    <span class="c1"># AX=0x8(DX)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552c4</span>      <span class="mi">48890424</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552c8</span>      <span class="mi">488</span><span class="no">b6c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552cd</span>      <span class="mi">4883</span><span class="no">c418</span>            <span class="no">ADDQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552d1</span>      <span class="no">c3</span>                  <span class="no">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="7">
<li>显然，<strong><code>DX</code>寄存器</strong>存储的就是闭包对象的地址，调用者负责在调用之前把闭包对象的地址存储到 <code>DX</code> 寄存器中，跟 <code>C++</code> 中的 <code>thiscall</code>非常类似。</li>
<li>之前有很多读者在反编译 Function Value 调用代码时，总会看到为 <code>DX</code> 寄存器赋值，并为此感到疑惑，这就是原因。</li>
<li>调用者不必区分是不是闭包、有没有捕获列表，实际上也区分不了，只能统一作为闭包来处理，所以总要通过 <code>DX</code> 传递地址。</li>
<li>如果 Function Value 背后不是闭包，这个地址就不会被用到，也不会造成什么影响。</li>
</ol>
<p><img loading="lazy" src="../images/func-008.png" alt=""  />
</p>
<h3 id="闭包与变量逃逸">闭包与变量逃逸<a hidden class="anchor" aria-hidden="true" href="#闭包与变量逃逸">#</a></h3>
<ol>
<li>变量逃逸跟闭包之间的关系很密切，因为 Function Value 本身就是个指针，编译器也可以按照同样的方式来分析 Function Value 有没有逃逸。</li>
<li>如果 Function Value 没有逃逸那就可以不用在堆上分配闭包对象了，分配在栈上即可。</li>
<li>使用一个示例进行验证，代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">sc</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">f</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>代码逻辑过于简单，为了避免闭包函数被编译器优化掉，编译时需要禁用内联优化，命令如下：<code>$ go build -gcflags='-l'</code>。</li>
<li>再来反编译 <code>sc()</code> 函数，<code>main.sc</code>反编译命令及输出结果如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">go</span> <span class="no">build</span> <span class="p">-</span><span class="no">gcflags</span><span class="err">=&#34;</span><span class="p">-</span><span class="no">l</span> <span class="p">-</span><span class="no">N</span><span class="err">&#34;</span> <span class="p">-</span><span class="no">o</span> <span class="p">.</span><span class="err">/</span><span class="no">h1</span> <span class="no">myzx.cn</span><span class="err">/</span><span class="no">helium</span>
</span></span><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">go</span> <span class="no">tool</span> <span class="no">objdump</span> <span class="p">-</span><span class="no">S</span> <span class="p">-</span><span class="no">s</span> <span class="err">&#39;^</span><span class="no">main.sc$</span><span class="err">&#39;</span> <span class="p">.</span><span class="err">/</span><span class="no">h1</span>
</span></span><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.sc</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">sc</span><span class="p">(</span><span class="no">n</span> <span class="no">int</span><span class="p">)</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>      <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455224</span>      <span class="mi">7664</span>                <span class="no">JBE</span> <span class="mi">0x45528a</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455226</span>      <span class="mi">4883</span><span class="no">ec38</span>            <span class="no">SUBQ</span> <span class="no">$0x38</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45522a</span>      <span class="mi">48896</span><span class="no">c2430</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45522f</span>      <span class="mi">488</span><span class="no">d6c2430</span>          <span class="no">LEAQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455234</span>      <span class="mi">4889442440</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x40</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># 分配参数空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455239</span>      <span class="mi">48</span><span class="no">c7042400000000</span>    <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># 分配返回值空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">f</span> <span class="p">:</span><span class="err">=</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455241</span>      <span class="mi">440</span><span class="no">f117c2410</span>        <span class="no">MOVUPS</span> <span class="no">X15</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455247</span>      <span class="mi">488</span><span class="no">d542410</span>          <span class="no">LEAQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>   <span class="c1"># &amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45524c</span>      <span class="mi">4889542428</span>          <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455251</span>      <span class="mi">8402</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455253</span>      <span class="mi">488</span><span class="no">d0546000000</span>      <span class="no">LEAQ</span> <span class="no">main.sc.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45525a</span>      <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># funcval.fn 0x10(SP)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45525f</span>      <span class="mi">8402</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455261</span>      <span class="mi">488</span><span class="no">b442440</span>          <span class="no">MOVQ</span> <span class="mi">0x40</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>   <span class="c1"># 参数n的值 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455266</span>      <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># funcval.data 0x18(SP) 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45526b</span>      <span class="mi">4889542420</span>          <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">return</span> <span class="no">f</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455270</span>      <span class="mi">488</span><span class="no">b442410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455275</span>      <span class="no">ffd0</span>                <span class="no">CALL</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455277</span>      <span class="mi">4889442408</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45527c</span>      <span class="mi">48890424</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455280</span>      <span class="mi">488</span><span class="no">b6c2430</span>          <span class="no">MOVQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455285</span>      <span class="mi">4883</span><span class="no">c438</span>            <span class="no">ADDQ</span> <span class="no">$0x38</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455289</span>      <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">sc</span><span class="p">(</span><span class="no">n</span> <span class="no">int</span><span class="p">)</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528a</span>      <span class="mi">4889442408</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528f</span>      <span class="no">e8ccccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455294</span>      <span class="mi">488</span><span class="no">b442408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455299</span>      <span class="no">eb85</span>                <span class="no">JMP</span> <span class="no">main.sc</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/func-009.png" alt=""  />
</p>
<h2 id="函数">函数<a hidden class="anchor" aria-hidden="true" href="#函数">#</a></h2>
<ol>
<li>在Go语言中函数属于<strong>头等对象</strong>，可以被当作<strong>参数传递</strong>、也可以作为<strong>函数返回值</strong>、<strong>绑定到变量</strong>。</li>
<li>Go语言称这样的参数、返回值和变量为<strong>Function Value</strong>。</li>
<li>Function Value本质上是一个<strong>指针</strong>，却不直接指向函数指令入口，而是指向runtime.funcval结构体，函数变量存储的是*funcval类型，也就是funcval结构体的地址。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 闭包是函数类型funcType
</span></span></span><span class="line"><span class="cl"><span class="c1">// 闭包捕获的变量，系统维护着一个关系列表，根据这个列表能正确的找到捕获的变量类型大小等信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">funcval</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fn</span> <span class="kt">uintptr</span>  <span class="c1">// 指向程序的代码段
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// variable-size, fn-specific data here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 紧接着funcval结构体后面内存地址是捕获的的变量列表
</span></span></span><span class="line"><span class="cl"><span class="c1">// 注意捕获的是变量的地址，使用的却是变量的值
</span></span></span><span class="line"><span class="cl"><span class="c1">// 闭包中捕获的如果是指针类型那么是引用，是普通类型那么是拷贝
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// f -&gt; *funcval
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>这个结构体从定义上看只有一个地址，这个地址才是函数的指令入口。一个Function Value是以下图所示形式存在的。</li>
</ol>
<p><img loading="lazy" src="../images/func-004.png" alt=""  />
</p>
<h2 id="闭包-1">闭包<a hidden class="anchor" aria-hidden="true" href="#闭包-1">#</a></h2>
<ol>
<li><code>Closure</code>：维基百科
<ul>
<li>闭包在实现上是一个结构体，它存储了一个函数（通常是其入口地址）和一个关联的环境（相当于一个符号查找表）。</li>
<li>环境里是若干对符号和值的对应关系，它既要包括约束变量（该函数内部绑定的符号），也要包括自由变量（在函数外部定义但在函数内被引用），有些函数也可能没有自由变量。</li>
<li>闭包跟函数最大的不同在于，当捕捉闭包的时候，它的自由变量会在捕捉时被确定，这样即便脱离了捕捉时的上下文，它也能照常运行。</li>
</ul>
</li>
<li>所以像下面这个例子：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">create</span><span class="p">()</span> <span class="kd">func</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span> <span class="o">:=</span> <span class="mi">2</span>  <span class="c1">// c会被分配在栈上，以拷贝形式被捕获
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 【由于c变量后面没有变化，所以这里捕获变成拷贝c的值2就行，不需要捕获c的地址】
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// f1 {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      fn ---&gt; 闭包函数地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      2  ---&gt; 拷贝c的值即可（不需要捕获c的地址），这里2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">f1</span> <span class="o">:=</span> <span class="nf">create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f2</span> <span class="o">:=</span> <span class="nf">create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f2</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 闭包函数的内存结构布局
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">s</span> <span class="o">:=</span> <span class="o">**</span><span class="p">(</span><span class="o">**</span><span class="kd">struct</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fn</span> <span class="kt">uintptr</span>  <span class="c1">// 指向函数代码地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">data1</span> <span class="kt">int</span>   <span class="c1">// 捕获变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">})(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">f1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%#v\n&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>    <span class="c1">// struct {fn uintptr;data1 int}{fn:0x47f520, data1:2}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li><code>create</code>函数的返回值是一个函数，并且引用了其外层函数定义的局部变量<code>c</code>。</li>
<li>而且，即便<code>create</code>函数结束，依然可以通过<code>f1</code>和<code>f2</code>正常执行这个函数并使用定义在<code>create</code>内部的变量<code>c</code>。</li>
<li>所以这个返回值符合闭包的定义，而这个自由变量<code>c</code>，通常被称为<strong>捕获变量</strong>。</li>
<li>虽然<code>create</code>函数的返回值函数形成闭包，但是<code>Go</code>语言里并没有把闭包从Function Value中特别区分出来。</li>
<li><strong>在Go语言中闭包只是拥有一个或多个捕获变量的Function Value而已</strong>。</li>
<li>这些捕获变量就是它的捕获列表，就放在对应的<code>funcval</code>结构体的后面。</li>
<li>所以上例中，<code>f1</code>和<code>f2</code>的内存布局如下图所示：</li>
</ol>
<p><img loading="lazy" src="../images/func-005.png" alt=""  />
</p>
<ol start="10">
<li>每个闭包对象都是一个Function Value，但是各自持有自己的捕获列表，这也是称闭包为<strong>有状态的函数</strong>的原因。</li>
</ol>


<p><details >
  <summary markdown="span">闭包捕获变量值</summary>
  <blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span> <span class="o">:=</span> <span class="nf">create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nf">f</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">create</span><span class="p">()</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span> <span class="o">:=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 堆分配 struct { F uintptr; c int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 注意这里的c变量不需要被捕获
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// c没有更改，只需要拷贝变量c的值即可
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>main 函数汇编代码。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e0</span>      <span class="mi">493</span><span class="no">b6610</span>        <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>      <span class="c1"># 栈增长判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551e4</span>      <span class="mi">7629</span>            <span class="no">JBE</span> <span class="mi">0x45520f</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e6</span>      <span class="mi">4883</span><span class="no">ec10</span>        <span class="no">SUBQ</span> <span class="no">$0x10</span><span class="p">,</span> <span class="no">SP</span>          <span class="c1"># main.main栈分配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551ea</span>      <span class="mi">48896</span><span class="no">c2408</span>      <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ef</span>      <span class="mi">488</span><span class="no">d6c2408</span>      <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f</span> <span class="p">:</span><span class="err">=</span> <span class="no">create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551f4</span>      <span class="no">e827000000</span>      <span class="no">CALL</span> <span class="no">main.create</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    <span class="c1"># AX返回&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551f9</span>      <span class="mi">48890424</span>        <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_</span> <span class="err">=</span> <span class="no">f</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551fd</span>      <span class="mi">488</span><span class="no">b08</span>          <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">),</span> <span class="no">CX</span>          <span class="c1"># CX=funcval.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455200</span>      <span class="mi">4889</span><span class="no">c2</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="no">DX</span>             <span class="c1"># DX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455203</span>      <span class="no">ffd1</span>            <span class="no">CALL</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455205</span>      <span class="mi">488</span><span class="no">b6c2408</span>      <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520a</span>      <span class="mi">4883</span><span class="no">c410</span>        <span class="no">ADDQ</span> <span class="no">$0x10</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520e</span>      <span class="no">c3</span>              <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520f</span>      <span class="no">e84ccdffff</span>      <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455214</span>      <span class="no">ebca</span>            <span class="no">JMP</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>create 函数汇编代码。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">create</span><span class="p">()</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>  <span class="c1"># 栈增长判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455224</span>        <span class="mi">765</span><span class="no">f</span>                <span class="no">JBE</span> <span class="mi">0x455285</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455226</span>        <span class="mi">4883</span><span class="no">ec30</span>            <span class="no">SUBQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>      <span class="c1"># 分配create栈空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45522a</span>        <span class="mi">48896</span><span class="no">c2428</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45522f</span>        <span class="mi">488</span><span class="no">d6c2428</span>          <span class="no">LEAQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455234</span>        <span class="mi">48</span><span class="no">c744241800000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span> <span class="c1"># 临时返回空间8字节，*funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">c</span> <span class="p">:</span><span class="err">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45523d</span>        <span class="mi">48</span><span class="no">c744241002000000</span>  <span class="no">MOVQ</span> <span class="no">$0x2</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span> <span class="c1"># 参数 c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># AX=0x7493(IP)，funcval结构体类型的_type类型指针位置，内存大小16B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455246</span>        <span class="mi">488</span><span class="no">d0593740000</span>      <span class="no">LEAQ</span> <span class="mi">0x7493</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span> 
</span></span><span class="line"><span class="cl">  <span class="c1"># 根据*_type进行堆分配，AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45524d</span>        <span class="no">e8ee5cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  <span class="mi">0x455252</span>        <span class="mi">4889442420</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># CX=main.create.func1 代码地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455257</span>        <span class="mi">488</span><span class="no">d0d42000000</span>      <span class="no">LEAQ</span> <span class="no">main.create.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">CX</span>  
</span></span><span class="line"><span class="cl">  <span class="mi">0x45525e</span>        <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>    <span class="c1"># funcval.fn=main.create.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455261</span>        <span class="mi">488</span><span class="no">b4c2420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span> <span class="c1"># CX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455266</span>        <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455268</span>        <span class="mi">488</span><span class="no">b542410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span> <span class="c1"># DX=0x2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45526d</span>        <span class="mi">48895108</span>            <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>  <span class="c1"># funcval.data=0x2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455271</span>        <span class="mi">488</span><span class="no">b442420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span> <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455276</span>        <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45527b</span>        <span class="mi">488</span><span class="no">b6c2428</span>          <span class="no">MOVQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455280</span>        <span class="mi">4883</span><span class="no">c430</span>            <span class="no">ADDQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455284</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">create</span><span class="p">()</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455285</span>        <span class="no">e8d6ccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528a</span>        <span class="no">eb94</span>                <span class="no">JMP</span> <span class="no">main.create</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>main.create.func1 函数汇编代码。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.create.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">g</span><span class="err">/</span><span class="no">hello1</span><span class="err">/</span><span class="no">func1.go</span>
</span></span><span class="line"><span class="cl">  <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x4552a0</span>      <span class="mi">4883</span><span class="no">ec18</span>            <span class="no">SUBQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x4552a4</span>      <span class="mi">48896</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x4552a9</span>      <span class="mi">488</span><span class="no">d6c2410</span>          <span class="no">LEAQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x4552ae</span>      <span class="mi">488</span><span class="no">b4a08</span>            <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">CX</span>    <span class="c1"># CX=0x2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0</span><span class="nf">x4552b2</span>      <span class="mi">48894</span><span class="no">c2408</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x4552b7</span>      <span class="mi">48</span><span class="no">c7042400000000</span>    <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 注意这里的c变量不需要被捕获
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0</span><span class="nf">x4552bf</span>      <span class="mi">488</span><span class="no">b442408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>    <span class="c1"># AX=0x2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0</span><span class="nf">x4552c4</span>      <span class="mi">48890424</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x4552c8</span>      <span class="mi">488</span><span class="no">b6c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x4552cd</span>      <span class="mi">4883</span><span class="no">c418</span>            <span class="no">ADDQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x4552d1</span>      <span class="no">c3</span>                  <span class="no">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>main和create的栈分布。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">          |   runtime.main callback
</span></span><span class="line"><span class="cl">          --------------------------
</span></span><span class="line"><span class="cl">  +40 +08 |   runtime.main BP
</span></span><span class="line"><span class="cl">          --------------------------  BP      ---------------
</span></span><span class="line"><span class="cl">  +38 +00 |   create.r *funcval               main.main栈
</span></span><span class="line"><span class="cl">          --------------------------  SP      ---------------
</span></span><span class="line"><span class="cl">  +30     |   main.main callback
</span></span><span class="line"><span class="cl">          --------------------------
</span></span><span class="line"><span class="cl">  +28     |   main.main BP
</span></span><span class="line"><span class="cl">          --------------------------  BP      ---------------
</span></span><span class="line"><span class="cl">  +20     |   &amp;funcval    create.o            -&gt; 临时funcval堆分配
</span></span><span class="line"><span class="cl">          --------------------------
</span></span><span class="line"><span class="cl">  +18     |   &amp;funcval    create.r            -&gt; create的返回值
</span></span><span class="line"><span class="cl">          --------------------------
</span></span><span class="line"><span class="cl">  +10     |   0x2         create.c            main.create栈
</span></span><span class="line"><span class="cl">          --------------------------
</span></span><span class="line"><span class="cl">  +08     |
</span></span><span class="line"><span class="cl">          --------------------------
</span></span><span class="line"><span class="cl">  +00     |
</span></span><span class="line"><span class="cl">          --------------------------  SP      ---------------
</span></span></code></pre></div></blockquote>

</details></p>



<p><details >
  <summary markdown="span">闭包捕获变量地址</summary>
  <blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span> <span class="o">:=</span> <span class="nf">create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nf">f</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">create</span><span class="p">()</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span> <span class="o">:=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 堆分配 struct { F uintptr; c *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="o">++</span>   <span class="c1">// 捕获c变量地址，在堆上分配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>main 函数汇编代码。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e0</span>        <span class="mi">493</span><span class="no">b6610</span>        <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e4</span>        <span class="mi">7629</span>            <span class="no">JBE</span> <span class="mi">0x45520f</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e6</span>        <span class="mi">4883</span><span class="no">ec10</span>        <span class="no">SUBQ</span> <span class="no">$0x10</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ea</span>        <span class="mi">48896</span><span class="no">c2408</span>      <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ef</span>        <span class="mi">488</span><span class="no">d6c2408</span>      <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f</span> <span class="p">:</span><span class="err">=</span> <span class="no">create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551f4</span>        <span class="no">e827000000</span>      <span class="no">CALL</span> <span class="no">main.create</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    <span class="c1"># 调用函数 AX返回&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551f9</span>        <span class="mi">48890424</span>        <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_</span> <span class="err">=</span> <span class="no">f</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551fd</span>        <span class="mi">488</span><span class="no">b08</span>          <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">),</span> <span class="no">CX</span>          <span class="c1"># CX=funcval.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455200</span>        <span class="mi">4889</span><span class="no">c2</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="no">DX</span>             <span class="c1"># DX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455203</span>        <span class="no">ffd1</span>            <span class="no">CALL</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455205</span>        <span class="mi">488</span><span class="no">b6c2408</span>      <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520a</span>        <span class="mi">4883</span><span class="no">c410</span>        <span class="no">ADDQ</span> <span class="no">$0x10</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520e</span>        <span class="no">c3</span>              <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520f</span>        <span class="no">e84ccdffff</span>      <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455214</span>        <span class="no">ebca</span>            <span class="no">JMP</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>create 函数汇编代码。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">create</span><span class="p">()</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455224</span>        <span class="mi">0</span><span class="no">f8686000000</span>        <span class="no">JBE</span> <span class="mi">0x4552b0</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45522a</span>        <span class="mi">4883</span><span class="no">ec30</span>            <span class="no">SUBQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45522e</span>        <span class="mi">48896</span><span class="no">c2428</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455233</span>        <span class="mi">488</span><span class="no">d6c2428</span>          <span class="no">LEAQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455238</span>        <span class="mi">48</span><span class="no">c744241000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">c</span> <span class="p">:</span><span class="err">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455241</span>        <span class="mi">488</span><span class="no">d05f84a0000</span>      <span class="no">LEAQ</span> <span class="mi">0x4af8</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>             <span class="c1"># AX=0x4af8(IP)，int的元类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455248</span>        <span class="no">e8f35cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>      <span class="c1"># 申请内存，AX=*int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45524d</span>        <span class="mi">4889442420</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>               <span class="c1"># 变量c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455252</span>        <span class="mi">48</span><span class="no">c70002000000</span>      <span class="no">MOVQ</span> <span class="no">$0x2</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>                <span class="c1"># 给c赋值2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455259</span>        <span class="mi">488</span><span class="no">d0580740000</span>      <span class="no">LEAQ</span> <span class="mi">0x7480</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>             <span class="c1"># funcval的元类型，申请16B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455260</span>        <span class="no">e8db5cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>      <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455265</span>        <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45526a</span>        <span class="mi">488</span><span class="no">d0d4f000000</span>      <span class="no">LEAQ</span> <span class="no">main.create.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">CX</span>  <span class="c1"># CX=main.create.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455271</span>        <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>                  <span class="c1"># funcval.fn=main.create.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455274</span>        <span class="mi">488</span><span class="no">b4c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>               <span class="c1"># CX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455279</span>        <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45527b</span>        <span class="mi">488</span><span class="no">b542420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>               <span class="c1"># DX=*int -&gt; 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455280</span>        <span class="mi">488</span><span class="no">d7908</span>            <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">DI</span>                <span class="c1"># DI=funcval.data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455284</span>        <span class="mi">833</span><span class="no">dd51f090000</span>      <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528b</span>        <span class="mi">7402</span>                <span class="no">JE</span> <span class="mi">0x45528f</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528d</span>        <span class="no">eb06</span>                <span class="no">JMP</span> <span class="mi">0x455295</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528f</span>        <span class="mi">48895108</span>            <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>                <span class="c1"># funcval.data=*int -&gt; 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455293</span>        <span class="no">eb07</span>                <span class="no">JMP</span> <span class="mi">0x45529c</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455295</span>        <span class="no">e8a6d0ffff</span>          <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrierDX</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45529a</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x45529c</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45529c</span>        <span class="mi">488</span><span class="no">b442418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>               <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552a1</span>        <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552a6</span>        <span class="mi">488</span><span class="no">b6c2428</span>          <span class="no">MOVQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552ab</span>        <span class="mi">4883</span><span class="no">c430</span>            <span class="no">ADDQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552af</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">create</span><span class="p">()</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552b0</span>        <span class="no">e8abccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552b5</span>        <span class="no">e966ffffff</span>          <span class="no">JMP</span> <span class="no">main.create</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>main.create.func1 函数汇编代码。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.create.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">g</span><span class="err">/</span><span class="no">hello1</span><span class="err">/</span><span class="no">func1.go</span>
</span></span><span class="line"><span class="cl">  <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552c0</span>     <span class="mi">4883</span><span class="no">ec18</span>            <span class="no">SUBQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552c4</span>     <span class="mi">48896</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552c9</span>     <span class="mi">488</span><span class="no">d6c2410</span>          <span class="no">LEAQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552ce</span>     <span class="mi">488</span><span class="no">b4a08</span>            <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552d2</span>     <span class="mi">48894</span><span class="no">c2408</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552d7</span>     <span class="mi">48</span><span class="no">c7042400000000</span>    <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nf">c</span><span class="err">++</span>     <span class="c1">// 捕获c变量地址，在堆上分配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x4552df</span>     <span class="mi">488</span><span class="no">b4c2408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552e4</span>     <span class="mi">488</span><span class="no">b09</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552e7</span>     <span class="mi">488</span><span class="no">b542408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552ec</span>     <span class="mi">48</span><span class="no">ffc1</span>              <span class="no">INCQ</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552ef</span>     <span class="mi">48890</span><span class="no">a</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nf">return</span> <span class="no">c</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552f2</span>     <span class="mi">488</span><span class="no">b4c2408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552f7</span>     <span class="mi">488</span><span class="no">b01</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552fa</span>     <span class="mi">48890424</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552fe</span>     <span class="mi">488</span><span class="no">b6c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455303</span>     <span class="mi">4883</span><span class="no">c418</span>            <span class="no">ADDQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455307</span>     <span class="no">c3</span>                  <span class="no">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>main和create的栈分布。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">          |   runtime.main callback
</span></span><span class="line"><span class="cl">          -------------------------
</span></span><span class="line"><span class="cl">  +40 +08 |   runtime.main BP
</span></span><span class="line"><span class="cl">          -------------------------   BP      ------------
</span></span><span class="line"><span class="cl">  +38 +00 |   &amp;funcval        c.r             main.main栈
</span></span><span class="line"><span class="cl">          -------------------------   SP      ------------
</span></span><span class="line"><span class="cl">  +30     |   main.main callback
</span></span><span class="line"><span class="cl">          -------------------------
</span></span><span class="line"><span class="cl">  +28     |   main.main BP
</span></span><span class="line"><span class="cl">          -------------------------   BP      ------------
</span></span><span class="line"><span class="cl">  +20     |   *int    -&gt; 2    c
</span></span><span class="line"><span class="cl">          -------------------------
</span></span><span class="line"><span class="cl">  +18     |   &amp;funcval        c.o
</span></span><span class="line"><span class="cl">          -------------------------
</span></span><span class="line"><span class="cl">  +10     |   &amp;funcval        c.r
</span></span><span class="line"><span class="cl">          -------------------------
</span></span><span class="line"><span class="cl">  +08     |
</span></span><span class="line"><span class="cl">          -------------------------
</span></span><span class="line"><span class="cl">  +00     |
</span></span><span class="line"><span class="cl">          -------------------------   SP      ------------
</span></span></code></pre></div></blockquote>

</details></p>

<h2 id="调用">调用<a hidden class="anchor" aria-hidden="true" href="#调用">#</a></h2>
<ol>
<li>通过Function Value调用函数时，会把对应的<code>funcval</code>结构体地址存入特定寄存器，如<code>amd64</code>平台使用的是<code>DX</code>寄存器，参看上面的汇编确实使用DX寄存器存储的。</li>
<li>继续使用闭包的示例，通过<code>f1</code>调用闭包函数时，会把<code>f1</code>存储的<code>funcval</code>结构体地址存入寄存器<code>DX</code>，这样在闭包函数的指令中就可以通过这个寄存器存储的地址加上<code>8</code>字节的偏移，就找到<code>f1</code>的捕获变量了。</li>
<li>同样的，通过<code>f2</code>调用闭包函数时，会把<code>f2</code>存储的<code>funcval</code>结构体地址存入寄存器，闭包函数执行时找到的就是<code>f2</code>的捕获变量了。
<ul>
<li>如果是没有捕获列表的Function Value，直接忽略这个寄存器即可。</li>
<li>通过这样的方式，<code>Go</code>语言实现了对Function Value的统一调用。</li>
</ul>
</li>
</ol>
<p><img loading="lazy" src="../images/func-006.png" alt=""  />
</p>
<h2 id="静态分配">静态分配<a hidden class="anchor" aria-hidden="true" href="#静态分配">#</a></h2>
<ol>
<li>对于没有捕获列表的Function Value，如果多个变量关联到同一个函数，编译器会做出优化，让它们共用一个<code>funcval</code>结构体。</li>
<li>注意 funcval 后面存储的是捕获的参数，实际传参不在这里，在调用该函数时在调用栈上。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">A</span><span class="p">(</span><span class="nx">i</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">i</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">B</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f1</span> <span class="o">:=</span> <span class="nx">A</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">C</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f2</span> <span class="o">:=</span> <span class="nx">A</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>像上面这种情况，编译阶段会创建一个<code>funcval</code>结构体放到只读数据段，而执行阶段，<code>f1</code>和<code>f2</code>都会使用它。</li>
</ol>
<p><img loading="lazy" src="../images/func-007.png" alt=""  />
</p>


<p><details >
  <summary markdown="span">静态分配验证</summary>
  <blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f1</span> <span class="o">:=</span> <span class="nx">A</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">A</span><span class="p">(</span><span class="nx">i</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">i</span><span class="o">++</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>main 函数汇编代码。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e0</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e4</span>        <span class="mi">7632</span>                <span class="no">JBE</span> <span class="mi">0x455218</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e6</span>        <span class="mi">4883</span><span class="no">ec18</span>            <span class="no">SUBQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ea</span>        <span class="mi">48896</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ef</span>        <span class="mi">488</span><span class="no">d6c2410</span>          <span class="no">LEAQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f1</span> <span class="p">:</span><span class="err">=</span> <span class="no">A</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551f4</span>        <span class="mi">488</span><span class="no">d15251d0100</span>      <span class="no">LEAQ</span> <span class="mi">0x11d25</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">DX</span>    <span class="c1"># DX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551fb</span>        <span class="mi">4889542408</span>          <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455200</span>        <span class="mi">488</span><span class="no">b0d191d0100</span>      <span class="no">MOVQ</span> <span class="mi">0x11d19</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">CX</span>    <span class="c1"># CX=funcval.fn，函数A的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455207</span>        <span class="no">b801000000</span>          <span class="no">MOVL</span> <span class="no">$0x1</span><span class="p">,</span> <span class="no">AX</span>           <span class="c1"># AX=0x1，参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45520c</span>        <span class="no">ffd1</span>                <span class="no">CALL</span> <span class="no">CX</span>                  
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520e</span>        <span class="mi">488</span><span class="no">b6c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455213</span>        <span class="mi">4883</span><span class="no">c418</span>            <span class="no">ADDQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455217</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455218</span>        <span class="no">e843cdffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45521d</span>        <span class="no">ebc1</span>                <span class="no">JMP</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>A 函数汇编代码。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.A</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">g</span><span class="err">/</span><span class="no">hello1</span><span class="err">/</span><span class="no">func1.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">A</span><span class="p">(</span><span class="no">i</span> <span class="no">int</span><span class="p">)</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>        <span class="mi">4889442408</span>      <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">i</span><span class="err">++</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455225</span>        <span class="mi">48</span><span class="no">ffc0</span>          <span class="no">INCQ</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455228</span>        <span class="mi">4889442408</span>      <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45522d</span>        <span class="no">c3</span>              <span class="no">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>main和A的栈分布。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">          |   runtime.main callback
</span></span><span class="line"><span class="cl">          -------------------------------
</span></span><span class="line"><span class="cl">  +10     |   runtime.main BP
</span></span><span class="line"><span class="cl">          ------------------------------- BP
</span></span><span class="line"><span class="cl">  +08     |   0x11d25(IP)         A
</span></span><span class="line"><span class="cl">          -------------------------------
</span></span><span class="line"><span class="cl">  +00     |
</span></span><span class="line"><span class="cl">          ------------------------------- SP
</span></span></code></pre></div></blockquote>

</details></p>

<h2 id="捕获列表">捕获列表<a hidden class="anchor" aria-hidden="true" href="#捕获列表">#</a></h2>
<ol>
<li>因为捕获列表需要由闭包对象各自持有，所以有捕获列表的Function Value要到执行阶段才会在堆上分配对应的<code>funcval</code>结构体以及捕获列表空间。</li>
<li>但是，捕获列表里存什么？直接拷贝捕获变量值吗？才没有那么简单。</li>
<li>闭包捕获的变量要在闭包函数和外层函数中表现一致，如果单纯值拷贝，就无法保证这一点，所以编译器针对捕获变量的不同情况分别做出了不同的处理。
<ol>
<li>捕获变量【<strong>除了初始化赋值外在任何地方都没有被修改过，那就可以直接拷贝值</strong>】，因为它不会再变化。</li>
<li>捕获变量除了初始化赋值外，还被修改过，就要再细分了。</li>
</ol>
</li>
</ol>
<h3 id="捕获局部变量">捕获局部变量<a hidden class="anchor" aria-hidden="true" href="#捕获局部变量">#</a></h3>
<ol>
<li>这个例子中，被捕获的是局部变量<code>i</code>，除了初始化赋值外还被修改过，所以局部变量<code>i</code>改为堆分配，栈上只存一个地址。</li>
<li>在这个示例中，为了让被捕获的局部变量在闭包函数和外层函数中保持一致，本该在栈上分配的局部变量被分配到堆上，这其实也是<strong>变量逃逸</strong>的一种场景。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">create</span><span class="p">()</span> <span class="p">(</span><span class="nx">fs</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="kd">func</span><span class="p">()){</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// struct { F uintptr; i *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">fs</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>    
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fs</span> <span class="o">:=</span> <span class="nf">create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">fs</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fs</span><span class="p">[</span><span class="nx">i</span><span class="p">]()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Output:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0xc0000ac058 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0xc0000ac058 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

<p><details >
  <summary markdown="span">捕获局部变量</summary>
  <blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fs</span> <span class="o">:=</span> <span class="nf">create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">fs</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fs</span><span class="p">[</span><span class="nx">i</span><span class="p">]()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">create</span><span class="p">()</span> <span class="p">(</span><span class="nx">fs</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="kd">func</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 堆分配 struct { F uintptr; i *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">fs</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">i</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>main 汇编代码。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e0</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e4</span>        <span class="mi">7675</span>                <span class="no">JBE</span> <span class="mi">0x45525b</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e6</span>        <span class="mi">4883</span><span class="no">ec30</span>            <span class="no">SUBQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ea</span>        <span class="mi">48896</span><span class="no">c2428</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ef</span>        <span class="mi">488</span><span class="no">d6c2428</span>          <span class="no">LEAQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fs</span> <span class="p">:</span><span class="err">=</span> <span class="no">create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551f4</span>        <span class="no">e887000000</span>          <span class="no">CALL</span> <span class="no">main.create</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    <span class="c1"># 调用main.create
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551f9</span>        <span class="mi">0</span><span class="no">f100424</span>            <span class="no">MOVUPS</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">X0</span>        <span class="c1"># 将0(SP)后16B内容放入X0，这里的两行代码相当于fs赋值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551fd</span>        <span class="mi">0</span><span class="no">f11442418</span>          <span class="no">MOVUPS</span> <span class="no">X0</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>     <span class="c1"># 将X0迁移到0x18(SP)后16B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">for</span> <span class="no">i</span> <span class="p">:</span><span class="err">=</span> <span class="mi">0</span><span class="c1">; i &lt; len(fs); i++ {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455202</span>        <span class="mi">48</span><span class="no">c744241000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>     <span class="c1"># i初始化 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45520b</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x45520d</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520d</span>        <span class="mi">48837</span><span class="no">c241002</span>        <span class="no">CMPQ</span> <span class="no">$0x2</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>     <span class="c1"># i和0x2比较    &lt;--- 循环判断条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455213</span>        <span class="mi">7</span><span class="no">c02</span>                <span class="no">JL</span> <span class="mi">0x455217</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455215</span>        <span class="no">eb2f</span>                <span class="no">JMP</span> <span class="mi">0x455246</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fs</span><span class="p">[</span><span class="no">i</span><span class="p">]()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455217</span>        <span class="mi">488</span><span class="no">b442410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>       <span class="c1"># AX=0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45521c</span>        <span class="mi">0</span><span class="no">f1f4000</span>            <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>        <span class="mi">4883</span><span class="no">f802</span>            <span class="no">CMPQ</span> <span class="no">$0x2</span><span class="p">,</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455224</span>        <span class="mi">7202</span>                <span class="no">JB</span> <span class="mi">0x455228</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455226</span>        <span class="no">eb28</span>                <span class="no">JMP</span> <span class="mi">0x455250</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455228</span>        <span class="mi">488</span><span class="no">d44c418</span>          <span class="no">LEAQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)(</span><span class="no">AX</span><span class="p">*</span><span class="mi">8</span><span class="p">),</span> <span class="no">AX</span> <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45522d</span>        <span class="mi">488</span><span class="no">b10</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">),</span> <span class="no">DX</span>          <span class="c1"># DX=&amp;funcval.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455230</span>        <span class="mi">488</span><span class="no">b02</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">AX</span>          <span class="c1"># AX=funcval.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455233</span>        <span class="no">ffd0</span>                <span class="no">CALL</span> <span class="no">AX</span>                 <span class="c1"># 调用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455235</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x455237</span>
</span></span><span class="line"><span class="cl">    <span class="nf">for</span> <span class="no">i</span> <span class="p">:</span><span class="err">=</span> <span class="mi">0</span><span class="c1">; i &lt; len(fs); i++ {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455237</span>        <span class="mi">488</span><span class="no">b5c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BX</span>       <span class="c1"># BX=0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45523c</span>        <span class="mi">48</span><span class="no">ffc3</span>              <span class="no">INCQ</span> <span class="no">BX</span>                 <span class="c1"># BX=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45523f</span>        <span class="mi">48895</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">BX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>       <span class="c1"># i=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455244</span>        <span class="no">ebc7</span>                <span class="no">JMP</span> <span class="mi">0x45520d</span>            <span class="c1"># &lt;--- 一轮循环结束跳转循环开头
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455246</span>        <span class="mi">488</span><span class="no">b6c2428</span>          <span class="no">MOVQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45524b</span>        <span class="mi">4883</span><span class="no">c430</span>            <span class="no">ADDQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45524f</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fs</span><span class="p">[</span><span class="no">i</span><span class="p">]()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455250</span>        <span class="no">b902000000</span>          <span class="no">MOVL</span> <span class="no">$0x2</span><span class="p">,</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455255</span>        <span class="no">e866d4ffff</span>          <span class="no">CALL</span> <span class="no">runtime.panicIndex</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45525a</span>        <span class="mi">90</span>                  <span class="no">NOPL</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45525b</span>        <span class="mi">0</span><span class="no">f1f440000</span>          <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)(</span><span class="no">AX</span><span class="p">*</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455260</span>        <span class="no">e8fbccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455265</span>        <span class="no">e976ffffff</span>          <span class="no">JMP</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>create 汇编代码。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">create</span><span class="p">()</span> <span class="p">(</span><span class="no">fs</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="no">func</span><span class="p">())</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455280</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455284</span>        <span class="mi">0</span><span class="no">f86d0000000</span>        <span class="no">JBE</span> <span class="mi">0x45535a</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528a</span>        <span class="mi">4883</span><span class="no">ec28</span>            <span class="no">SUBQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528e</span>        <span class="mi">48896</span><span class="no">c2420</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455293</span>        <span class="mi">488</span><span class="no">d6c2420</span>          <span class="no">LEAQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455298</span>        <span class="mi">440</span><span class="no">f117c2430</span>        <span class="no">MOVUPS</span> <span class="no">X15</span><span class="p">,</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>        <span class="c1"># 0x30(SP)开始的16B地址清零
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">for</span> <span class="no">i</span> <span class="p">:</span><span class="err">=</span> <span class="mi">0</span><span class="c1">; i &lt; 2; i++ {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45529e</span>        <span class="mi">488</span><span class="no">d059b4a0000</span>      <span class="no">LEAQ</span> <span class="mi">0x4a9b</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>         <span class="c1"># AX=0x4a9b(IP)，int的元类型    &lt;--- 变量i初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552a5</span>        <span class="no">e8965cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># 变量i申请内存，AX返回 *int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552aa</span>        <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552af</span>        <span class="mi">48</span><span class="no">c70000000000</span>      <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>            <span class="c1"># i变量赋值0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552b6</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x4552b8</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552b8</span>        <span class="mi">488</span><span class="no">b4c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>           <span class="c1"># CX=&amp;i &lt;--- 循环从这里开始，后面满足条件会跳转回来
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552bd</span>        <span class="mi">48833902</span>            <span class="no">CMPQ</span> <span class="no">$0x2</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>            <span class="c1"># i与2比较
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552c1</span>        <span class="mi">7</span><span class="no">c05</span>                <span class="no">JL</span> <span class="mi">0x4552c8</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552c3</span>        <span class="no">e97d000000</span>          <span class="no">JMP</span> <span class="mi">0x455345</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fs</span><span class="p">[</span><span class="no">i</span><span class="p">]</span> <span class="err">=</span> <span class="no">func</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># struct { F uintptr; i *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552c8</span>        <span class="mi">488</span><span class="no">d0511740000</span>      <span class="no">LEAQ</span> <span class="mi">0x7411</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>         <span class="c1"># AX=0x7411(IP)，funcval元类型 内存16B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552cf</span>        <span class="no">e86c5cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># 申请内存16B，AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552d4</span>        <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552d9</span>        <span class="mi">488</span><span class="no">d0da0000000</span>      <span class="no">LEAQ</span> <span class="no">main.create.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">CX</span>  <span class="c1"># CX=main.create.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552e0</span>        <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>              <span class="c1"># funcval.fn=main.create.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552e3</span>        <span class="mi">488</span><span class="no">b4c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>           <span class="c1"># CX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552e8</span>        <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552ea</span>        <span class="mi">488</span><span class="no">b542418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>           <span class="c1"># DX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552ef</span>        <span class="mi">488</span><span class="no">d7908</span>            <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">DI</span>            <span class="c1"># DI=funcval.data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552f3</span>        <span class="mi">833</span><span class="no">d661f090000</span>      <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="c1"># 检查写屏障
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552fa</span>        <span class="mi">7402</span>                <span class="no">JE</span> <span class="mi">0x4552fe</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552fc</span>        <span class="no">eb06</span>                <span class="no">JMP</span> <span class="mi">0x455304</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552fe</span>        <span class="mi">48895108</span>            <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>            <span class="c1"># funcval.data=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455302</span>        <span class="no">eb07</span>                <span class="no">JMP</span> <span class="mi">0x45530b</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455304</span>        <span class="no">e837d0ffff</span>          <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrierDX</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="c1"># 调用写屏障函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455309</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x45530b</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45530b</span>        <span class="mi">488</span><span class="no">b542418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>           <span class="c1"># DX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455310</span>        <span class="mi">488</span><span class="no">b02</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">AX</span>              <span class="c1"># AX=0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455313</span>        <span class="mi">488</span><span class="no">b542410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>           <span class="c1"># DX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455318</span>        <span class="mi">4883</span><span class="no">f802</span>            <span class="no">CMPQ</span> <span class="no">$0x2</span><span class="p">,</span> <span class="no">AX</span>               <span class="c1"># AX和2比较
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45531c</span>        <span class="mi">7204</span>                <span class="no">JB</span> <span class="mi">0x455322</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45531e</span>        <span class="mi">6690</span>                <span class="no">NOPW</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455320</span>        <span class="no">eb2d</span>                <span class="no">JMP</span> <span class="mi">0x45534f</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455322</span>        <span class="mi">488</span><span class="no">d4cc430</span>          <span class="no">LEAQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">)(</span><span class="no">AX</span><span class="p">*</span><span class="mi">8</span><span class="p">),</span> <span class="no">CX</span>     <span class="c1"># CX=0x30(SP)(AX*8)，AX=0 -&gt; 0x30(SP)，AX=1 -&gt; 0x38(SP)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455327</span>        <span class="mi">488911</span>              <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>              <span class="c1"># 返回数组遍历赋值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45532a</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x45532c</span>
</span></span><span class="line"><span class="cl">    <span class="nf">for</span> <span class="no">i</span> <span class="p">:</span><span class="err">=</span> <span class="mi">0</span><span class="c1">; i &lt; 2; i++ {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45532c</span>        <span class="mi">488</span><span class="no">b4c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>           <span class="c1"># CX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455331</span>        <span class="mi">488</span><span class="no">b09</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">CX</span>              <span class="c1"># CX=0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455334</span>        <span class="mi">488</span><span class="no">b542418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>           <span class="c1"># DX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455339</span>        <span class="mi">48</span><span class="no">ffc1</span>              <span class="no">INCQ</span> <span class="no">CX</span>                     <span class="c1"># CX=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45533c</span>        <span class="mi">48890</span><span class="no">a</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">)</span>              <span class="c1"># i赋值1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45533f</span>        <span class="mi">90</span>                  <span class="no">NOPL</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455340</span>        <span class="no">e973ffffff</span>          <span class="no">JMP</span> <span class="mi">0x4552b8</span>                <span class="c1"># 跳转到前面开始下一轮循环
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">return</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455345</span>        <span class="mi">488</span><span class="no">b6c2420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45534a</span>        <span class="mi">4883</span><span class="no">c428</span>            <span class="no">ADDQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45534e</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fs</span><span class="p">[</span><span class="no">i</span><span class="p">]</span> <span class="err">=</span> <span class="no">func</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45534f</span>        <span class="no">b902000000</span>          <span class="no">MOVL</span> <span class="no">$0x2</span><span class="p">,</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455354</span>        <span class="no">e867d3ffff</span>          <span class="no">CALL</span> <span class="no">runtime.panicIndex</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455359</span>        <span class="mi">90</span>                  <span class="no">NOPL</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">create</span><span class="p">()</span> <span class="p">(</span><span class="no">fs</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="no">func</span><span class="p">())</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45535a</span>        <span class="no">e801ccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45535f</span>        <span class="mi">90</span>                  <span class="no">NOPL</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455360</span>        <span class="no">e91bffffff</span>          <span class="no">JMP</span> <span class="no">main.create</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>main和create的栈布局。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">          |   runtime.main callback
</span></span><span class="line"><span class="cl">          ---------------------------
</span></span><span class="line"><span class="cl">  +58 +28 |   runtime.main BP
</span></span><span class="line"><span class="cl">          --------------------------- BP      ---------------
</span></span><span class="line"><span class="cl">  +50 +20 |   &amp;funcval            c.r
</span></span><span class="line"><span class="cl">          ---------------------------
</span></span><span class="line"><span class="cl">  +48 +18 |   &amp;funcval            c.r
</span></span><span class="line"><span class="cl">          ---------------------------
</span></span><span class="line"><span class="cl">  +40 +10 |   0x0                 i           main.main栈
</span></span><span class="line"><span class="cl">          ---------------------------
</span></span><span class="line"><span class="cl">  +38 +08 |   &amp;funcval            fs[1]
</span></span><span class="line"><span class="cl">          ---------------------------
</span></span><span class="line"><span class="cl">  +30 +00 |   &amp;funcval            fs[0]
</span></span><span class="line"><span class="cl">          --------------------------- SP      ---------------
</span></span><span class="line"><span class="cl">  +28     |   main.main callback
</span></span><span class="line"><span class="cl">          ---------------------------
</span></span><span class="line"><span class="cl">  +20     |   main.main BP
</span></span><span class="line"><span class="cl">          --------------------------- BP      ---------------
</span></span><span class="line"><span class="cl">  +18     |   *int    -&gt; 0 1      i
</span></span><span class="line"><span class="cl">          ---------------------------
</span></span><span class="line"><span class="cl">  +10     |   &amp;funcval
</span></span><span class="line"><span class="cl">          ---------------------------         main.create栈
</span></span><span class="line"><span class="cl">  +08     |
</span></span><span class="line"><span class="cl">          ---------------------------
</span></span><span class="line"><span class="cl">  +00     |
</span></span><span class="line"><span class="cl">          --------------------------- SP      ---------------
</span></span></code></pre></div><p><img loading="lazy" src="../images/func-010.png" alt=""  />
</p>
</blockquote>
</details></p>

<h3 id="捕获参数">捕获参数<a hidden class="anchor" aria-hidden="true" href="#捕获参数">#</a></h3>
<ol>
<li>
<p>如果是参数被捕获，那么调用者依然从栈上传递参数，但是被调用函数会把它拷贝到堆上一份，然后和闭包函数都使用堆上分配的那一个。</p>
</li>
<li>
<p>值传递参数时。</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Te1</span><span class="p">(</span><span class="nx">a</span> <span class="kt">int</span><span class="p">)</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span> <span class="c1">// 此时的a参数在堆上分配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 返回闭包捕获了函数参数，参数a会被复制到堆上供整个Te1函数及返回闭包使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 堆分配 struct { F uintptr; a *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">a</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">a</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">a1</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span> <span class="o">:=</span> <span class="nf">Te1</span><span class="p">(</span><span class="nx">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nf">f</span><span class="p">())</span> <span class="c1">// 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">a1</span><span class="p">)</span>  <span class="c1">// 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// 可以看出 参数被闭包捕获关系的只是捕获函数内相关参数，参看下面汇编
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/func-011.png" alt=""  />
</p>


<p><details >
  <summary markdown="span">值传递参数</summary>
  <blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a1</span> <span class="o">:=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span> <span class="o">:=</span> <span class="nf">Te1</span><span class="p">(</span><span class="nx">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">b</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Te1</span><span class="p">(</span><span class="nx">a</span> <span class="kt">int</span><span class="p">)</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 返回闭包捕获了函数参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 参数a会被复制到堆上供整个Te1函数及返回闭包使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// struct { F uintptr; a *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 根据汇编可见，Te1堆分配了a，并把传入的参数1拷贝给了a。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">a</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">a</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>main 函数汇编代码。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e0</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e4</span>        <span class="mi">7638</span>                <span class="no">JBE</span> <span class="mi">0x45521e</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e6</span>        <span class="mi">4883</span><span class="no">ec20</span>            <span class="no">SUBQ</span> <span class="no">$0x20</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ea</span>        <span class="mi">48896</span><span class="no">c2418</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ef</span>        <span class="mi">488</span><span class="no">d6c2418</span>          <span class="no">LEAQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">a1</span> <span class="p">:</span><span class="err">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551f4</span>        <span class="mi">48</span><span class="no">c744240801000000</span>  <span class="no">MOVQ</span> <span class="no">$0x1</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>      <span class="c1"># a1=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">b</span> <span class="p">:</span><span class="err">=</span> <span class="no">Te1</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551fd</span>        <span class="no">b801000000</span>          <span class="no">MOVL</span> <span class="no">$0x1</span><span class="p">,</span> <span class="no">AX</span>           <span class="c1"># AX=0x1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455202</span>        <span class="no">e839000000</span>          <span class="no">CALL</span> <span class="no">main.Te1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>       <span class="c1"># 调用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455207</span>        <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">b</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520c</span>        <span class="mi">488</span><span class="no">b08</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">),</span> <span class="no">CX</span>          <span class="c1"># CX=funcval.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45520f</span>        <span class="mi">4889</span><span class="no">c2</span>              <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="no">DX</span>             <span class="c1"># DX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455212</span>        <span class="no">ffd1</span>                <span class="no">CALL</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455214</span>        <span class="mi">488</span><span class="no">b6c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455219</span>        <span class="mi">4883</span><span class="no">c420</span>            <span class="no">ADDQ</span> <span class="no">$0x20</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45521d</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45521e</span>        <span class="mi">6690</span>                <span class="no">NOPW</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>        <span class="no">e83bcdffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455225</span>        <span class="no">ebb9</span>                <span class="no">JMP</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>main.Te1 函数汇编代码。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">Te1</span><span class="p">(</span><span class="no">a</span> <span class="no">int</span><span class="p">)</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455240</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455244</span>        <span class="mi">0</span><span class="no">f8691000000</span>        <span class="no">JBE</span> <span class="mi">0x4552db</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45524a</span>        <span class="mi">4883</span><span class="no">ec30</span>            <span class="no">SUBQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45524e</span>        <span class="mi">48896</span><span class="no">c2428</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455253</span>        <span class="mi">488</span><span class="no">d6c2428</span>          <span class="no">LEAQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455258</span>        <span class="mi">4889442438</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>           <span class="c1"># 参数a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45525d</span>        <span class="mi">48</span><span class="no">c744241000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455266</span>        <span class="mi">488</span><span class="no">d05d34a0000</span>      <span class="no">LEAQ</span> <span class="mi">0x4ad3</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>         <span class="c1"># AX=0x4ad3(IP)，int元类型，参数a堆分配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45526d</span>        <span class="no">e8ce5cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># 申请内存 AX=&amp;int     *int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455272</span>        <span class="mi">4889442420</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>           <span class="c1"># 堆分配的变量a *int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455277</span>        <span class="mi">488</span><span class="no">b4c2438</span>          <span class="no">MOVQ</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>           <span class="c1"># CX=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45527c</span>        <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>              <span class="c1"># AX=&amp;int -&gt; 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># struct { F uintptr; a *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45527f</span>        <span class="mi">488</span><span class="no">d055a740000</span>      <span class="no">LEAQ</span> <span class="mi">0x745a</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>         <span class="c1"># AX=0x745a(IP)，funcval结构体元类型，占16B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455286</span>        <span class="no">e8b55cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># 申请内存，AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45528b</span>        <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455290</span>        <span class="mi">488</span><span class="no">d0d69000000</span>      <span class="no">LEAQ</span> <span class="no">main.Te1.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">CX</span> <span class="c1"># CX=main.Te1.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455297</span>        <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>              <span class="c1"># funcval.fn=main.Te1.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45529a</span>        <span class="mi">488</span><span class="no">b4c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>           <span class="c1"># CX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45529f</span>        <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552a1</span>        <span class="mi">488</span><span class="no">b542420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>           <span class="c1"># DX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552a6</span>        <span class="mi">488</span><span class="no">d7908</span>            <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">DI</span>            <span class="c1"># DI=funcval.data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552aa</span>        <span class="mi">833</span><span class="no">daf1f090000</span>      <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552b1</span>        <span class="mi">7402</span>                <span class="no">JE</span> <span class="mi">0x4552b5</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552b3</span>        <span class="no">eb0b</span>                <span class="no">JMP</span> <span class="mi">0x4552c0</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552b5</span>        <span class="mi">48895108</span>            <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>            <span class="c1"># funcval.data=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552b9</span>        <span class="no">eb0c</span>                <span class="no">JMP</span> <span class="mi">0x4552c7</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552bb</span>        <span class="mi">0</span><span class="no">f1f440000</span>          <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)(</span><span class="no">AX</span><span class="p">*</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552c0</span>        <span class="no">e87bd0ffff</span>          <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrierDX</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552c5</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x4552c7</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552c7</span>        <span class="mi">488</span><span class="no">b442418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>           <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552cc</span>        <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552d1</span>        <span class="mi">488</span><span class="no">b6c2428</span>          <span class="no">MOVQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552d6</span>        <span class="mi">4883</span><span class="no">c430</span>            <span class="no">ADDQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552da</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">Te1</span><span class="p">(</span><span class="no">a</span> <span class="no">int</span><span class="p">)</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552db</span>        <span class="mi">4889442408</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552e0</span>        <span class="no">e87bccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552e5</span>        <span class="mi">488</span><span class="no">b442408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552ea</span>        <span class="no">e951ffffff</span>          <span class="no">JMP</span> <span class="no">main.Te1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>main.Te1.func1 函数汇编代码。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.Te1.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl">  <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x455300</span>      <span class="mi">4883</span><span class="no">ec18</span>            <span class="no">SUBQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl"><span class="mi">0x455304</span>      <span class="mi">48896</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl"><span class="mi">0x455309</span>      <span class="mi">488</span><span class="no">d6c2410</span>          <span class="no">LEAQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl"><span class="mi">0x45530e</span>      <span class="mi">488</span><span class="no">b4a08</span>            <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">CX</span>    
</span></span><span class="line"><span class="cl"><span class="mi">0x455312</span>      <span class="mi">48894</span><span class="no">c2408</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl"><span class="mi">0x455317</span>      <span class="mi">48</span><span class="no">c7042400000000</span>    <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">      <span class="no">a</span><span class="err">++</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x45531f</span>      <span class="mi">488</span><span class="no">b4c2408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>    
</span></span><span class="line"><span class="cl"><span class="mi">0x455324</span>      <span class="mi">488</span><span class="no">b09</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">CX</span>        
</span></span><span class="line"><span class="cl"><span class="mi">0x455327</span>      <span class="mi">488</span><span class="no">b542408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>    
</span></span><span class="line"><span class="cl"><span class="mi">0x45532c</span>      <span class="mi">48</span><span class="no">ffc1</span>              <span class="no">INCQ</span> <span class="no">CX</span>            
</span></span><span class="line"><span class="cl"><span class="mi">0x45532f</span>      <span class="mi">48890</span><span class="no">a</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">      <span class="no">return</span> <span class="no">a</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x455332</span>      <span class="mi">488</span><span class="no">b4c2408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>    
</span></span><span class="line"><span class="cl"><span class="mi">0x455337</span>      <span class="mi">488</span><span class="no">b01</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">AX</span>        
</span></span><span class="line"><span class="cl"><span class="mi">0x45533a</span>      <span class="mi">48890424</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl"><span class="mi">0x45533e</span>      <span class="mi">488</span><span class="no">b6c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl"><span class="mi">0x455343</span>      <span class="mi">4883</span><span class="no">c418</span>            <span class="no">ADDQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl"><span class="mi">0x455347</span>      <span class="no">c3</span>                  <span class="no">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>栈布局信息。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">  +58 +20 |   runtime.main callback
</span></span><span class="line"><span class="cl">          ----------------------------------
</span></span><span class="line"><span class="cl">  +50 +18 |   runtime.main BP
</span></span><span class="line"><span class="cl">          ----------------------------------  BP      --------------
</span></span><span class="line"><span class="cl">  +48 +10 |   &amp;funcval                变量b
</span></span><span class="line"><span class="cl">          ----------------------------------
</span></span><span class="line"><span class="cl">  +40 +08 |   0x1                     变量a1           main.main栈
</span></span><span class="line"><span class="cl">          ----------------------------------
</span></span><span class="line"><span class="cl">  +38 +00 |   0x1                     参数a
</span></span><span class="line"><span class="cl">          ----------------------------------  SP      --------------
</span></span><span class="line"><span class="cl">  +30     |   main.main callback
</span></span><span class="line"><span class="cl">          ----------------------------------
</span></span><span class="line"><span class="cl">  +28     |   main.main BP
</span></span><span class="line"><span class="cl">          ----------------------------------  BP      --------------
</span></span><span class="line"><span class="cl">  +20     |   &amp;int    -&gt; 1            a
</span></span><span class="line"><span class="cl">          ----------------------------------
</span></span><span class="line"><span class="cl">  +18     |   &amp;funcval                r.o
</span></span><span class="line"><span class="cl">          ----------------------------------
</span></span><span class="line"><span class="cl">  +10        |   &amp;funcval                r                main.Te1栈
</span></span><span class="line"><span class="cl">          ----------------------------------
</span></span><span class="line"><span class="cl">  +08     |
</span></span><span class="line"><span class="cl">          ----------------------------------
</span></span><span class="line"><span class="cl">  +00     |
</span></span><span class="line"><span class="cl">          ----------------------------------  SP      --------------
</span></span></code></pre></div></blockquote>

</details></p>

<ol start="3">
<li>引用传递参数时。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 如果捕获的是指针情况呢，根据下面代码可以看出跟上面情况一样的规则
</span></span></span><span class="line"><span class="cl"><span class="c1">// 这种情况跟捕获全局变量基本表现一致
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Te1</span><span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="kt">int</span><span class="p">)</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 返回闭包捕获了函数参数，参数a会被复制到栈上供整个Te1函数及返回闭包使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 堆分配 struct { F uintptr; a *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="nx">a</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">*</span><span class="nx">a</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">a1</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span> <span class="o">:=</span> <span class="nf">Te1</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">a1</span><span class="p">)</span>  <span class="c1">// 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nf">f</span><span class="p">())</span> <span class="c1">// 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">a1</span><span class="p">)</span>  <span class="c1">// 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">a1</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nf">f</span><span class="p">())</span> <span class="c1">// 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">a1</span><span class="p">)</span>  <span class="c1">// 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 注意这里下面的一行代码，会先执行f() f() 在打印所以出现了奇怪的输出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 因为参数会先被实时计算，因此先执行了f()和f()，然后再打印数据的。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// fmt.Println(a1, f(), a1, f(), a1) // 2 1 2 2 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/func-012.png" alt=""  />
</p>


<p><details >
  <summary markdown="span">引用传递参数</summary>
  <blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a1</span> <span class="o">:=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span> <span class="o">:=</span> <span class="nf">Te1</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">b</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Te1</span><span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="kt">int</span><span class="p">)</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 返回闭包捕获了函数参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 参数a会被复制到堆上供整个Te1函数及返回闭包使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// struct { F uintptr; a *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="nx">a</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">*</span><span class="nx">a</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>main 函数汇编代码。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e0</span>      <span class="mi">493</span><span class="no">b6610</span>              <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e4</span>      <span class="mi">764</span><span class="no">c</span>                  <span class="no">JBE</span> <span class="mi">0x455232</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e6</span>      <span class="mi">4883</span><span class="no">ec28</span>              <span class="no">SUBQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ea</span>      <span class="mi">48896</span><span class="no">c2420</span>            <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ef</span>      <span class="mi">488</span><span class="no">d6c2420</span>            <span class="no">LEAQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">a1</span> <span class="p">:</span><span class="err">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 这里可以看出，直接就给a堆分配了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551f4</span>        <span class="mi">488</span><span class="no">d05454b0000</span>      <span class="no">LEAQ</span> <span class="mi">0x4b45</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>         <span class="c1"># AX=0x4b45(IP)，int元类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551fb</span>        <span class="mi">0</span><span class="no">f1f440000</span>          <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)(</span><span class="no">AX</span><span class="p">*</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455200</span>        <span class="no">e83b5dfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># AX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455205</span>        <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520a</span>        <span class="mi">48</span><span class="no">c70001000000</span>      <span class="no">MOVQ</span> <span class="no">$0x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>            <span class="c1"># a=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">b</span> <span class="p">:</span><span class="err">=</span> <span class="no">Te1</span><span class="p">(</span><span class="err">&amp;</span><span class="no">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455211</span>        <span class="mi">488</span><span class="no">b442418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>           <span class="c1"># AX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455216</span>        <span class="no">e825000000</span>          <span class="no">CALL</span> <span class="no">main.Te1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>           <span class="c1"># 调用函数，AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45521b</span>        <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">b</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>        <span class="mi">488</span><span class="no">b08</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">),</span> <span class="no">CX</span>              <span class="c1"># CX=funcval.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455223</span>        <span class="mi">4889</span><span class="no">c2</span>              <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="no">DX</span>                 <span class="c1"># DX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455226</span>        <span class="no">ffd1</span>                <span class="no">CALL</span> <span class="no">CX</span>                     <span class="c1"># 调用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455228</span>        <span class="mi">488</span><span class="no">b6c2420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45522d</span>        <span class="mi">4883</span><span class="no">c428</span>            <span class="no">ADDQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455231</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455232</span>        <span class="no">e829cdffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455237</span>        <span class="no">eba7</span>                <span class="no">JMP</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>main.Te1 函数汇编代码。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">Te1</span><span class="p">(</span><span class="no">a</span> <span class="p">*</span><span class="no">int</span><span class="p">)</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455240</span>     <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455244</span>     <span class="mi">7675</span>                <span class="no">JBE</span> <span class="mi">0x4552bb</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455246</span>     <span class="mi">4883</span><span class="no">ec28</span>            <span class="no">SUBQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x45524a</span>     <span class="mi">48896</span><span class="no">c2420</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x45524f</span>     <span class="mi">488</span><span class="no">d6c2420</span>          <span class="no">LEAQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455254</span>     <span class="mi">4889442430</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>       <span class="c1"># 参数a *int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x455259</span>     <span class="mi">48</span><span class="no">c744241000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>     <span class="c1"># 返回值 func() int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1"># struct { F uintptr; i *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x455262</span>     <span class="mi">488</span><span class="no">d0577740000</span>      <span class="no">LEAQ</span> <span class="mi">0x7477</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>     <span class="c1"># AX=0x7477(IP)，funcval结构体 16B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x455269</span>     <span class="no">e8d25cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span>   <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x45526e</span>     <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455273</span>     <span class="mi">488</span><span class="no">d0d66000000</span>      <span class="no">LEAQ</span> <span class="no">main.Te1.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">CX</span> <span class="c1"># CX=main.Te1.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x45527a</span>     <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>              <span class="c1"># funcval.fn=main.Te1.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x45527d</span>     <span class="mi">488</span><span class="no">b4c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>           <span class="c1"># CX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x455282</span>     <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455284</span>     <span class="mi">488</span><span class="no">b542430</span>          <span class="no">MOVQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>           <span class="c1"># DX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x455289</span>     <span class="mi">488</span><span class="no">d7908</span>            <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">DI</span>            <span class="c1"># DI=funcval.data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x45528d</span>     <span class="mi">833</span><span class="no">dcc1f090000</span>      <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455294</span>     <span class="mi">7402</span>                <span class="no">JE</span> <span class="mi">0x455298</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455296</span>     <span class="no">eb08</span>                <span class="no">JMP</span> <span class="mi">0x4552a0</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455298</span>     <span class="mi">48895108</span>            <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>            <span class="c1"># funcval.data=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x45529c</span>     <span class="no">eb09</span>                <span class="no">JMP</span> <span class="mi">0x4552a7</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x45529e</span>     <span class="mi">6690</span>                <span class="no">NOPW</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552a0</span>     <span class="no">e89bd0ffff</span>          <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrierDX</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552a5</span>     <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x4552a7</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552a7</span>     <span class="mi">488</span><span class="no">b442418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>           <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x4552ac</span>     <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552b1</span>     <span class="mi">488</span><span class="no">b6c2420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552b6</span>     <span class="mi">4883</span><span class="no">c428</span>            <span class="no">ADDQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552ba</span>     <span class="no">c3</span>                  <span class="no">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>main.Te1.func1 函数汇编代码。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">Te1</span><span class="p">(</span><span class="no">a</span> <span class="p">*</span><span class="no">int</span><span class="p">)</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552bb</span>     <span class="mi">4889442408</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552c0</span>     <span class="no">e89bccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552c5</span>     <span class="mi">488</span><span class="no">b442408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552ca</span>     <span class="no">e971ffffff</span>          <span class="no">JMP</span> <span class="no">main.Te1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552e0</span>     <span class="mi">4883</span><span class="no">ec18</span>            <span class="no">SUBQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552e4</span>     <span class="mi">48896</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552e9</span>     <span class="mi">488</span><span class="no">d6c2410</span>          <span class="no">LEAQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552ee</span>     <span class="mi">488</span><span class="no">b4a08</span>            <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">CX</span>    <span class="c1"># CX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x4552f2</span>     <span class="mi">48894</span><span class="no">c2408</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552f7</span>     <span class="mi">48</span><span class="no">c7042400000000</span>    <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="err">*</span><span class="nf">a</span><span class="err">++</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552ff</span>     <span class="mi">488</span><span class="no">b4c2408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>    <span class="c1"># CX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x455304</span>     <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455306</span>     <span class="mi">488</span><span class="no">b542408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>    <span class="c1"># DX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x45530b</span>     <span class="mi">8402</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x45530d</span>     <span class="mi">488</span><span class="no">b09</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">CX</span>      <span class="c1"># CX=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x455310</span>     <span class="mi">48</span><span class="no">ffc1</span>              <span class="no">INCQ</span> <span class="no">CX</span>             <span class="c1"># CX=2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x455313</span>     <span class="mi">48890</span><span class="no">a</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">)</span>      <span class="c1"># &amp;int -&gt; 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="nf">return</span> <span class="p">*</span><span class="no">a</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455316</span>     <span class="mi">488</span><span class="no">b4c2408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>    <span class="c1"># CX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x45531b</span>     <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x45531d</span>     <span class="mi">488</span><span class="no">b01</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">AX</span>      <span class="c1"># AX=2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x455320</span>     <span class="mi">48890424</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455324</span>     <span class="mi">488</span><span class="no">b6c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455329</span>     <span class="mi">4883</span><span class="no">c418</span>            <span class="no">ADDQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x45532d</span>     <span class="no">c3</span>                  <span class="no">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>栈分布情况。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">  +58 +28 |   address of runtime.main
</span></span><span class="line"><span class="cl">          ------------------------------
</span></span><span class="line"><span class="cl">  +50 +20 |   BP of runtime.main
</span></span><span class="line"><span class="cl">          ------------------------------  BP
</span></span><span class="line"><span class="cl">  +48 +18 |   &amp;int    -&gt; 1            a1
</span></span><span class="line"><span class="cl">          ------------------------------
</span></span><span class="line"><span class="cl">  +40 +10 |   &amp;funcval                b
</span></span><span class="line"><span class="cl">          ------------------------------
</span></span><span class="line"><span class="cl">  +38 +08 |
</span></span><span class="line"><span class="cl">          ------------------------------
</span></span><span class="line"><span class="cl">  +30 +00 |   &amp;int                    T.a
</span></span><span class="line"><span class="cl">          ------------------------------  SP
</span></span><span class="line"><span class="cl">  +28     |   address of main.main
</span></span><span class="line"><span class="cl">          ------------------------------
</span></span><span class="line"><span class="cl">  +20     |   BP of main.main
</span></span><span class="line"><span class="cl">          ------------------------------  BP
</span></span><span class="line"><span class="cl">  +18     |   &amp;funcval                T.o
</span></span><span class="line"><span class="cl">          ------------------------------
</span></span><span class="line"><span class="cl">  +10     |   &amp;funcval                T.r
</span></span><span class="line"><span class="cl">          ------------------------------
</span></span><span class="line"><span class="cl">  +08     |
</span></span><span class="line"><span class="cl">          ------------------------------
</span></span><span class="line"><span class="cl">  +00     |
</span></span><span class="line"><span class="cl">          ------------------------------  SP
</span></span></code></pre></div></blockquote>

</details></p>

<h3 id="捕获返回值">捕获返回值<a hidden class="anchor" aria-hidden="true" href="#捕获返回值">#</a></h3>
<ol>
<li>如果是返回值被捕获，那么处理方式就又有些不同了。</li>
<li>返回值空间依然由调用者在栈上分配，但是被调用函数（闭包的外层函数）会在堆上也分配一个，并且与闭包函数都使用堆上这一个，但是，在外层函数返回前要把堆上的返回值拷贝到栈上那一个。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nf">Te1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">b</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Te1</span><span class="p">()</span> <span class="p">(</span><span class="nx">y</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">y1</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">y1</span><span class="o">++</span> <span class="c1">// 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 堆分配 struct { F uintptr; y1 *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">y1</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="nx">y1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e0</span>      <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e4</span>      <span class="mi">763</span><span class="no">b</span>                <span class="no">JBE</span> <span class="mi">0x455221</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e6</span>      <span class="mi">4883</span><span class="no">ec18</span>            <span class="no">SUBQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ea</span>      <span class="mi">48896</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ef</span>      <span class="mi">488</span><span class="no">d6c2410</span>          <span class="no">LEAQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">b</span><span class="p">,</span> <span class="no">_</span> <span class="p">:</span><span class="err">=</span> <span class="no">Te1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551f4</span>      <span class="mi">48</span><span class="no">c744240800000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551fd</span>      <span class="mi">0</span><span class="no">f1f00</span>              <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455200</span>      <span class="no">e83b000000</span>          <span class="no">CALL</span> <span class="no">main.Te1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455205</span>      <span class="mi">4889442408</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520a</span>      <span class="mi">48890424</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">b</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520e</span>      <span class="mi">488</span><span class="no">b1424</span>            <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455212</span>      <span class="mi">488</span><span class="no">b02</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455215</span>      <span class="no">ffd0</span>                <span class="no">CALL</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455217</span>      <span class="mi">488</span><span class="no">b6c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45521c</span>      <span class="mi">4883</span><span class="no">c418</span>            <span class="no">ADDQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>      <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455221</span>      <span class="no">e83acdffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455226</span>      <span class="no">ebb8</span>                <span class="no">JMP</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">Te1</span><span class="p">()</span> <span class="p">(</span><span class="no">y</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span><span class="p">,</span> <span class="no">y1</span> <span class="no">int</span><span class="p">)</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455240</span>      <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455244</span>      <span class="mi">0</span><span class="no">f868e000000</span>        <span class="no">JBE</span> <span class="mi">0x4552d8</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45524a</span>      <span class="mi">4883</span><span class="no">ec30</span>            <span class="no">SUBQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45524e</span>      <span class="mi">48896</span><span class="no">c2428</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455253</span>      <span class="mi">488</span><span class="no">d6c2428</span>          <span class="no">LEAQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455258</span>      <span class="mi">48</span><span class="no">c744241000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455261</span>      <span class="mi">488</span><span class="no">d05d84a0000</span>      <span class="no">LEAQ</span> <span class="mi">0x4ad8</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>         <span class="c1"># AX=0x4ad8(IP)，int元类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455268</span>      <span class="no">e8d35cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># AX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45526d</span>      <span class="mi">4889442420</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">y1</span><span class="err">++</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455272</span>      <span class="mi">48</span><span class="no">ff00</span>              <span class="no">INCQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>                  <span class="c1"># y1=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># struct { F uintptr; y1 *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455275</span>      <span class="mi">488</span><span class="no">d0564740000</span>      <span class="no">LEAQ</span> <span class="mi">0x7464</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>         <span class="c1"># AX=0x7464(IP)，funcval元类型 16B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45527c</span>      <span class="mi">0</span><span class="no">f1f4000</span>            <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455280</span>      <span class="no">e8bb5cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455285</span>      <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528a</span>      <span class="mi">488</span><span class="no">d0d6f000000</span>      <span class="no">LEAQ</span> <span class="no">main.Te1.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">CX</span> <span class="c1"># CX=main.Te1.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455291</span>      <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>              <span class="c1"># funcval.fn=main.Te1.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455294</span>      <span class="mi">488</span><span class="no">b4c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>           <span class="c1"># CX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455299</span>      <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45529b</span>      <span class="mi">488</span><span class="no">b542420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>           <span class="c1"># DX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552a0</span>      <span class="mi">488</span><span class="no">d7908</span>            <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">DI</span>            <span class="c1"># DI=funcval.data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552a4</span>      <span class="mi">833</span><span class="no">db51f090000</span>      <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552ab</span>      <span class="mi">7402</span>                <span class="no">JE</span> <span class="mi">0x4552af</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552ad</span>      <span class="no">eb06</span>                <span class="no">JMP</span> <span class="mi">0x4552b5</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552af</span>      <span class="mi">48895108</span>            <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>            <span class="c1"># funcval.data=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552b3</span>      <span class="no">eb07</span>                <span class="no">JMP</span> <span class="mi">0x4552bc</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552b5</span>      <span class="no">e886d0ffff</span>          <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrierDX</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552ba</span>      <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x4552bc</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552bc</span>      <span class="mi">488</span><span class="no">b442418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>           <span class="c1"># AX=&amp;funcval  返回参数1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552c1</span>      <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552c6</span>      <span class="mi">488</span><span class="no">b4c2420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>           <span class="c1"># CX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552cb</span>      <span class="mi">488</span><span class="no">b19</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">BX</span>              <span class="c1"># BX=1         返回参数2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552ce</span>      <span class="mi">488</span><span class="no">b6c2428</span>          <span class="no">MOVQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552d3</span>      <span class="mi">4883</span><span class="no">c430</span>            <span class="no">ADDQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552d7</span>      <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">Te1</span><span class="p">()</span> <span class="p">(</span><span class="no">y</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span><span class="p">,</span> <span class="no">y1</span> <span class="no">int</span><span class="p">)</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552d8</span>      <span class="no">e883ccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552dd</span>      <span class="mi">0</span><span class="no">f1f00</span>              <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552e0</span>      <span class="no">e95bffffff</span>          <span class="no">JMP</span> <span class="no">main.Te1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">    +50 +18 |   address of runtime.main
</span></span><span class="line"><span class="cl">            -----------------------------
</span></span><span class="line"><span class="cl">    +48 +10 |   BP of runtime.main
</span></span><span class="line"><span class="cl">            -----------------------------   BP
</span></span><span class="line"><span class="cl">    +40 +08 |   0
</span></span><span class="line"><span class="cl">            -----------------------------
</span></span><span class="line"><span class="cl">    +38 +00 |
</span></span><span class="line"><span class="cl">            -----------------------------   SP
</span></span><span class="line"><span class="cl">    +30     |   address of main.main
</span></span><span class="line"><span class="cl">            -----------------------------
</span></span><span class="line"><span class="cl">    +28     |   BP of main.main
</span></span><span class="line"><span class="cl">            -----------------------------   BP
</span></span><span class="line"><span class="cl">    +20     |   &amp;int    1           y1
</span></span><span class="line"><span class="cl">            -----------------------------
</span></span><span class="line"><span class="cl">    +18     |   &amp;funcval            y
</span></span><span class="line"><span class="cl">            -----------------------------
</span></span><span class="line"><span class="cl">    +10     |   &amp;funcval
</span></span><span class="line"><span class="cl">            -----------------------------
</span></span><span class="line"><span class="cl">    +08     |
</span></span><span class="line"><span class="cl">            -----------------------------
</span></span><span class="line"><span class="cl">    +00     |
</span></span><span class="line"><span class="cl">            -----------------------------   SP
</span></span></code></pre></div><p><img loading="lazy" src="../images/func-013.png" alt=""  />
</p>


<p><details >
  <summary markdown="span">自己捕获自己</summary>
  <blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">x</span><span class="p">()()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">x</span><span class="p">()</span> <span class="p">(</span><span class="nx">y</span> <span class="kd">func</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// struct { F uintptr }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">y</span> <span class="p">=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//println(&#34;y&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// defer在return赋值完成之后执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//defer func() {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//	y = func() {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//        fmt.Println(&#34;我能改变了Y的值？&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//	}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//}()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// struct { F uintptr; y *func() }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//println(&#34;z&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">y</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>main 汇编代码。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e0</span>        <span class="mi">493</span><span class="no">b6610</span>        <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e4</span>        <span class="mi">7629</span>            <span class="no">JBE</span> <span class="mi">0x45520f</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e6</span>        <span class="mi">4883</span><span class="no">ec10</span>        <span class="no">SUBQ</span> <span class="no">$0x10</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ea</span>        <span class="mi">48896</span><span class="no">c2408</span>      <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ef</span>        <span class="mi">488</span><span class="no">d6c2408</span>      <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">x</span><span class="p">()()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551f4</span>        <span class="no">e847000000</span>      <span class="no">CALL</span> <span class="no">main.x</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>     <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551f9</span>        <span class="mi">48890424</span>        <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551fd</span>        <span class="mi">488</span><span class="no">b08</span>          <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">),</span> <span class="no">CX</span>      <span class="c1"># CX=funcval.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455200</span>        <span class="mi">4889</span><span class="no">c2</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="no">DX</span>        	<span class="c1"># DX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455203</span>        <span class="no">ffd1</span>            <span class="no">CALL</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455205</span>        <span class="mi">488</span><span class="no">b6c2408</span>      <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520a</span>        <span class="mi">4883</span><span class="no">c410</span>        <span class="no">ADDQ</span> <span class="no">$0x10</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520e</span>        <span class="no">c3</span>              <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520f</span>        <span class="no">e84ccdffff</span>      <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455214</span>        <span class="no">ebca</span>        	<span class="no">JMP</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>x 汇编代码。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">x</span><span class="p">()</span> <span class="p">(</span><span class="no">y</span> <span class="no">func</span><span class="p">())</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455240</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455244</span>        <span class="mi">0</span><span class="no">f86bf000000</span>        <span class="no">JBE</span> <span class="mi">0x455309</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45524a</span>        <span class="mi">4883</span><span class="no">ec28</span>            <span class="no">SUBQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45524e</span>        <span class="mi">48896</span><span class="no">c2420</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455253</span>        <span class="mi">488</span><span class="no">d6c2420</span>          <span class="no">LEAQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># func()    变量y
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455258</span>        <span class="mi">488</span><span class="no">d05e1480000</span>      <span class="no">LEAQ</span> <span class="mi">0x48e1</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>               <span class="c1"># AX=0x48e1(IP)，funcval元类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45525f</span>        <span class="mi">90</span>                  <span class="no">NOPL</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455260</span>        <span class="no">e8db5cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>        <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455265</span>        <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">y</span> <span class="err">=</span> <span class="no">func</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45526a</span>        <span class="mi">833</span><span class="no">def1f090000</span>      <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455271</span>        <span class="mi">7402</span>                <span class="no">JE</span> <span class="mi">0x455275</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455273</span>        <span class="no">eb0d</span>                <span class="no">JMP</span> <span class="mi">0x455282</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># funcval.fn -&gt; println(&#34;y&#34;) 替换 y
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455275</span>        <span class="mi">488</span><span class="no">d0d841d0100</span>      <span class="no">LEAQ</span> <span class="mi">0x11d84</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">CX</span>   <span class="c1"># CX=0x11d84(IP)，函数代码处
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45527c</span>        <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>         <span class="c1"># funcval.fn=0x11d84(IP)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45527f</span>        <span class="mi">90</span>                  <span class="no">NOPL</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455280</span>        <span class="no">eb11</span>                <span class="no">JMP</span> <span class="mi">0x455293</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455282</span>        <span class="mi">4889</span><span class="no">c7</span>              <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="no">DI</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455285</span>        <span class="mi">488</span><span class="no">d0d741d0100</span>      <span class="no">LEAQ</span> <span class="mi">0x11d74</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528c</span>        <span class="no">e88fd0ffff</span>          <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrierCX</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455291</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x455293</span>
</span></span><span class="line"><span class="cl">    <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># struct { F uintptr; y *func() }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455293</span>        <span class="mi">488</span><span class="no">d0586740000</span>      <span class="no">LEAQ</span> <span class="mi">0x7486</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>          <span class="c1"># AX=0x7486(IP)，funcval元类型 16B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45529a</span>        <span class="no">e8a15cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>   <span class="c1"># AX=&amp;funcval.1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45529f</span>        <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552a4</span>        <span class="mi">488</span><span class="no">d0d75000000</span>      <span class="no">LEAQ</span> <span class="no">main.x.func2</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">CX</span>    <span class="c1"># CX=main.x.func2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552ab</span>        <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>               <span class="c1"># funcval.1.fn=main.x.func2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552ae</span>        <span class="mi">488</span><span class="no">b4c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>            <span class="c1"># CX=&amp;funcval.1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552b3</span>        <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552b5</span>        <span class="mi">488</span><span class="no">b542418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>            <span class="c1"># DX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552ba</span>        <span class="mi">488</span><span class="no">d7908</span>            <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">DI</span>             <span class="c1"># DI=funcval.1.data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552be</span>        <span class="mi">833</span><span class="no">d9b1f090000</span>      <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552c5</span>        <span class="mi">7402</span>                <span class="no">JE</span> <span class="mi">0x4552c9</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552c7</span>        <span class="no">eb06</span>                <span class="no">JMP</span> <span class="mi">0x4552cf</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552c9</span>        <span class="mi">48895108</span>            <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>             <span class="c1"># funcval.1.data=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552cd</span>        <span class="no">eb07</span>                <span class="no">JMP</span> <span class="mi">0x4552d6</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552cf</span>        <span class="no">e86cd0ffff</span>          <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrierDX</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552d4</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x4552d6</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552d6</span>        <span class="mi">488</span><span class="no">b7c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DI</span>            <span class="c1"># DI=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552db</span>        <span class="mi">488</span><span class="no">b4c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>            <span class="c1"># CX=&amp;funcval.1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552e0</span>        <span class="mi">833</span><span class="no">d791f090000</span>      <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552e7</span>        <span class="mi">7402</span>                <span class="no">JE</span> <span class="mi">0x4552eb</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552e9</span>        <span class="no">eb05</span>                <span class="no">JMP</span> <span class="mi">0x4552f0</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552eb</span>        <span class="mi">48890</span><span class="no">f</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">DI</span><span class="p">)</span>               <span class="c1"># funcval.fn=&amp;funcval.1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552ee</span>        <span class="no">eb07</span>                <span class="no">JMP</span> <span class="mi">0x4552f7</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552f0</span>        <span class="no">e82bd0ffff</span>          <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrierCX</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552f5</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x4552f7</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552f7</span>        <span class="mi">488</span><span class="no">b4c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>            <span class="c1"># CX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552fc</span>        <span class="mi">488</span><span class="no">b01</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">AX</span>               <span class="c1"># AX=funcval.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552ff</span>        <span class="mi">488</span><span class="no">b6c2420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455304</span>        <span class="mi">4883</span><span class="no">c428</span>            <span class="no">ADDQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455308</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">x</span><span class="p">()</span> <span class="p">(</span><span class="no">y</span> <span class="no">func</span><span class="p">())</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455309</span>        <span class="no">e852ccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45530e</span>        <span class="no">e92dffffff</span>          <span class="no">JMP</span> <span class="no">main.x</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/func-014.png" alt=""  />
</p>
</blockquote>
</details></p>

<h2 id="unsafe">unsafe<a hidden class="anchor" aria-hidden="true" href="#unsafe">#</a></h2>
<ol>
<li><code>Go</code>语言里<code>Function Value</code>本质上是指向<code>funcval</code>结构体的指针</li>
<li><code>Go</code>语言里闭包只是拥有捕获列表的<code>Function Value</code></li>
<li>捕获变量在外层函数与闭包函数中要保持一致</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;unsafe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">fv</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fn</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl">    <span class="nx">i</span> <span class="o">*</span><span class="kt">int</span>  <span class="c1">// 捕获的变量i
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">g</span> <span class="o">:=</span> <span class="nf">callback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">fn</span> <span class="o">:=</span> <span class="o">**</span><span class="p">(</span><span class="o">**</span><span class="nx">fv</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">g</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%#v\n&#34;</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nx">fn</span><span class="p">.</span><span class="nx">i</span><span class="p">))</span> <span class="c1">// 13
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Output:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// main.fv{fn:(unsafe.Pointer)(0xeccdc0), i:(*int)(0xc00000a098)}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 13
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// 可以看出捕获的是i的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">callback</span><span class="p">()</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">i</span> <span class="o">:=</span> <span class="mi">13</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// struct { F uintptr; i *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">i</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="参考">参考<a hidden class="anchor" aria-hidden="true" href="#参考">#</a></h2>
<ol>
<li>本篇文章参考了《深度探索Go语言》书内容。</li>
<li>参考 <a href="https://mp.weixin.qq.com/s/hO0S4WcG0hUzCmMNMKtS-g" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/hO0S4WcG0hUzCmMNMKtS-g</a>。</li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://heliu.site/tags/golang/">Golang</a></li>
      <li><a href="https://heliu.site/tags/%E5%87%BD%E6%95%B0/">函数</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://heliu.site/posts/golang/func/align/">
    <span class="title">« 上一页</span>
    <br>
    <span>内存对齐和逃逸分析</span>
  </a>
  <a class="next" href="https://heliu.site/posts/golang/func/defer-use/">
    <span class="title">下一页 »</span>
    <br>
    <span>defer(使用)</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        本站总访问量<span id="busuanzi_value_site_pv"></span>次
    </span>
    <span id="busuanzi_container_site_uv">
        本站访客数<span id="busuanzi_value_site_uv"></span>人次
    </span>
    </div>
        <span>Copyright © 2024 蜀ICP备2024091074号 <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
