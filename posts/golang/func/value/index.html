<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Function Value | Helium</title>
<meta name="keywords" content="golang, å‡½æ•°">
<meta name="description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬">
<meta name="author" content="helium">
<link rel="canonical" href="https://heliu.site/posts/golang/func/value/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://heliu.site/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://heliu.site/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://heliu.site/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://heliu.site/apple-touch-icon.png">
<link rel="mask-icon" href="https://heliu.site/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://heliu.site/posts/golang/func/value/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="Function Value" />
<meta property="og:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://heliu.site/posts/golang/func/value/" />
<meta property="og:image" content="https://heliu.site/favicon-32x32.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-08-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-08-03T00:00:00+00:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://heliu.site/favicon-32x32.png" />
<meta name="twitter:title" content="Function Value"/>
<meta name="twitter:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://heliu.site/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Golang åˆé›†",
      "item": "https://heliu.site/posts/golang/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ç¬¬9ç«  Function",
      "item": "https://heliu.site/posts/golang/func/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Function Value",
      "item": "https://heliu.site/posts/golang/func/value/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Function Value",
  "name": "Function Value",
  "description": "ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18+ç‰ˆæœ¬",
  "keywords": [
    "golang", "å‡½æ•°"
  ],
  "articleBody": " å‡½æ•°åœ¨ Go è¯­è¨€ä¸­å±äºç¬¬ä¸€ç±»å€¼(First Class Value)ï¼Œè¯¥ç±»å‹çš„å€¼å¯ä»¥ä½œä¸ºå‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼ï¼Œä¹Ÿå¯ä»¥èµ‹ç»™å˜é‡ã€‚ å½“æŠŠä¸€ä¸ªå‡½æ•°èµ‹å€¼ç»™æŸä¸ªå˜é‡åï¼Œè¿™ä¸ªå˜é‡å°±è¢«ç§°ä¸º Function Valueã€‚ å£°æ˜ä¸€ä¸ª Function Value å˜é‡çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š var fn func(a, b int) int å…¶ä¸­ fn å°±æ˜¯ä¸ª Function Value å˜é‡ï¼Œå®ƒçš„ç±»å‹æ˜¯ func(int, int) intã€‚ Function Value å¯ä»¥åƒä¸€èˆ¬å‡½æ•°é‚£æ ·è¢«è°ƒç”¨ï¼Œåœ¨ä½¿ç”¨ä½“éªŒä¸Šéå¸¸ç±»ä¼¼äº C è¯­è¨€ä¸­çš„å‡½æ•°æŒ‡é’ˆã€‚ Function Value æœ¬è´¨ä¸Šæ˜¯ä¸æ˜¯å‡½æ•°æŒ‡é’ˆå‘¢ï¼Ÿ æœ¬èŠ‚ä¼šåˆ†æ Function Value å’Œå‡½æ•°æŒ‡é’ˆçš„å®ç°åŸç†ï¼Œè¿˜æœ‰é—­åŒ…çš„å®ç°åŸç†ï¼Œä»¥åŠ Function Value æ˜¯å¦‚ä½•æ”¯æŒé—­åŒ…çš„ã€‚ å‡½æ•°æŒ‡é’ˆ ç†Ÿæ‚‰ C è¯­è¨€çš„è¯»è€…åº”è¯¥æœ‰è¿‡ä½¿ç”¨å‡½æ•°æŒ‡é’ˆçš„ç»éªŒï¼Œå‡½æ•°æŒ‡é’ˆå­˜å‚¨çš„éƒ½æ˜¯åœ°å€ï¼Œåªä¸è¿‡ä¸æ˜¯æŒ‡å‘æŸç§ç±»å‹çš„æ•°æ®ã€‚ è€Œæ˜¯æŒ‡å‘ä»£ç æ®µä¸­æŸä¸ªå‡½æ•°çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚ Function Value åˆ†æ å‡†å¤‡ä¸€ä¸ª go æ–‡ä»¶å¹¶å†™å…¥ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š 1 2 3 4 5 6 7 8 9 10 package main func main() { println(helper(nil, 0, 0)) } //go:noinline func helper(fn func(int, int) int, a, b int) int { return fn(a, b) } ä¾ç„¶æŠŠ Function Value çš„è°ƒç”¨éš”ç¦»åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œä»¥ä¾¿äºåˆ†æã€‚main.helperåç¼–è¯‘ä»£ç å¦‚ä¸‹ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 $ go build -gcflags=\"-N -l\" -o ./h1 myzx.cn/helium $ go tool objdump -S -s '^main.helper$' ./h1 TEXT main.helper(SB) /mnt/hgfs/workspace/helium/main.go func helper(fn func(int, int) int, a, b int) int { 0x455240 493b6610 CMPQ 0x10(R14), SP # æ ˆå¢é•¿åˆ¤æ–­ 0x455244 7650 JBE 0x455296 0x455246 4883ec28 SUBQ $0x28, SP 0x45524a 48896c2420 MOVQ BP, 0x20(SP) 0x45524f 488d6c2420 LEAQ 0x20(SP), BP 0x455254 4889442430 MOVQ AX, 0x30(SP) # fn 0x455259 48895c2438 MOVQ BX, 0x38(SP) # a 0x45525e 48894c2440 MOVQ CX, 0x40(SP) # b 0x455263 48c744241000000000 MOVQ $0x0, 0x10(SP) # return int return fn(a, b) 0x45526c 488b442438 MOVQ 0x38(SP), AX # AX=a 0x455271 488b5c2440 MOVQ 0x40(SP), BX # BX=b 0x455276 488b542430 MOVQ 0x30(SP), DX # DX=fn # è¿™é‡Œçœ‹å‡º Function Value æ˜¯ä¸€ä¸ªäºŒçº§æŒ‡é’ˆ 0x45527b 488b0a MOVQ 0(DX), CX # CX=fn.fn 0x45527e 6690 NOPW # DX å¯„å­˜å™¨å­˜å‚¨çš„æ˜¯ fnï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸‹æ–‡ # CALL CX; æŒ‡ä»¤è¯´æ˜ï¼ŒCXå¯„å­˜å™¨æœ€ç»ˆå­˜å‚¨çš„æ˜¯å®é™…å‡½æ•°çš„åœ°å€ 0x455280 ffd1 CALL CX # CALL fn.fn 0x455282 4889442418 MOVQ AX, 0x18(SP) 0x455287 4889442410 MOVQ AX, 0x10(SP) 0x45528c 488b6c2420 MOVQ 0x20(SP), BP 0x455291 4883c428 ADDQ $0x28, SP 0x455295 c3 RET func helper(fn func(int, int) int, a, b int) int { 0x455296 4889442408 MOVQ AX, 0x8(SP) 0x45529b 48895c2410 MOVQ BX, 0x10(SP) 0x4552a0 48894c2418 MOVQ CX, 0x18(SP) 0x4552a5 e8b6ccffff CALL runtime.morestack_noctxt.abi0(SB) 0x4552aa 488b442408 MOVQ 0x8(SP), AX 0x4552af 488b5c2410 MOVQ 0x10(SP), BX 0x4552b4 488b4c2418 MOVQ 0x18(SP), CX 0x4552b9 eb85 JMP main.helper(SB) é€šè¿‡ä¸Šè¿°é€»è¾‘ï¼Œå¯ä»¥ç¡®å®šFunction Valueç¡®å®æ˜¯ä¸ªæŒ‡é’ˆï¼Œè€Œä¸”æ˜¯ä¸ªä¸¤çº§æŒ‡é’ˆã€‚ å¦‚å›¾æ‰€ç¤ºï¼ŒFunction Value ä¸ç›´æ¥æŒ‡å‘ç›®æ ‡å‡½æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ªç›®æ ‡å‡½æ•°çš„æŒ‡é’ˆã€‚ é—­åŒ… è¯´åˆ°Goè¯­è¨€çš„é—­åŒ…ï¼Œæ¯”è¾ƒç›´è§‚çš„æ„Ÿå—å°±æ˜¯ä¸ªæœ‰çŠ¶æ€çš„ Function Valueã€‚ åœ¨Goè¯­è¨€ä¸­æ¯”è¾ƒå…¸å‹çš„é—­åŒ…åœºæ™¯å°±æ˜¯åœ¨æŸä¸ªå‡½æ•°å†…å®šä¹‰äº†å¦ä¸€ä¸ªå‡½æ•°ï¼Œå†…å±‚å‡½æ•°ä½¿ç”¨äº†å¤–å±‚å‡½æ•°çš„å±€éƒ¨å˜é‡ï¼Œå¹¶ä¸”å†…å±‚å‡½æ•°æœ€ç»ˆè¢«å¤–å±‚å‡½æ•°ä½œä¸ºè¿”å›å€¼è¿”å›ã€‚ ä»£ç å¦‚ä¸‹ï¼š 1 2 3 4 5 func mc(n int) func() int { return func() int { return n } } æ¯æ¬¡è°ƒç”¨ mc() å‡½æ•°éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„é—­åŒ…ï¼Œé—­åŒ…è®°ä½äº†å‚æ•°çš„å€¼ï¼Œæ‰€ä»¥æ˜¯æœ‰çŠ¶æ€çš„ã€‚ åŸºäºç›®å‰å¯¹å‡½æ•°æ ˆå¸§çš„äº†è§£ï¼Œå‡½æ•°æ ˆå¸§éšç€å‡½æ•°è¿”å›è€Œé”€æ¯ï¼Œä¸èƒ½ç”¨æ¥ä¿å­˜çŠ¶æ€ã€‚ ç ”ç©¶å‡½æ•°æŒ‡é’ˆå’Œ Function Value çš„æ—¶å€™ä¹Ÿæ²¡æœ‰å‘ç°å“ªé‡Œç”¨æ¥ä¿å­˜çŠ¶æ€ï¼Œæ‰€ä»¥è¿™é‡Œå°±æœ‰ä¸ªé—®é¢˜ï¼Œé—­åŒ…çš„çŠ¶æ€ä¿å­˜åœ¨å“ªé‡Œå‘¢ï¼Ÿ é—­åŒ…å¯¹è±¡ ä¸ºäº†æ‘˜æ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œå…ˆæ¥å°è¯•ä¸€ä¸‹åç¼–è¯‘ï¼Œä»æ±‡ç¼–ä»£ç ä¸­æ‰¾ç­”æ¡ˆï¼Œmain.mcåç¼–è¯‘ä»£ç å¦‚ä¸‹ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 $ go build -gcflags=\"-N -l\" -o ./h1 myzx.cn/helium $ go tool objdump -S -s '^main.mc$' ./h1 TEXT main.mc(SB) /mnt/hgfs/workspace/helium/main.go func mc(n int) func() int { 0x455220 493b6610 CMPQ 0x10(R14), SP # æ ˆå¢é•¿åˆ¤æ–­ 0x455224 765b JBE 0x455281 0x455226 4883ec28 SUBQ $0x28, SP 0x45522a 48896c2420 MOVQ BP, 0x20(SP) 0x45522f 488d6c2420 LEAQ 0x20(SP), BP # å‚æ•°æ ˆç©ºé—´åˆ†é… 0x455234 4889442430 MOVQ AX, 0x30(SP) # n # è¿”å›å€¼æ ˆç©ºé—´åˆ†é… 0x455239 48c744241000000000 MOVQ $0x0, 0x10(SP) # return func() int return func() int { # 0x7497(IP) æ˜¯ Function Value çš„ç»“æ„å…ƒç±»å‹ # type funcval struct {fn unsafe.Pointer, n int} 0x455242 488d0597740000 LEAQ 0x7497(IP), AX # Function Value ç»“æ„çš„å…ƒç±»å‹ # åˆ›å»º funcval ç»“æ„éœ€è¦çš„å†…å­˜ç©ºé—´ï¼Œæ˜¯å †åˆ†é… 0x455249 e8f25cfbff CALL runtime.newobject(SB) # AX=\u0026funcval 0x45524e 4889442418 MOVQ AX, 0x18(SP) # è¿™é‡Œmain.mc.func1(SB)æ˜¯mcè¿”å›çš„é—­åŒ…åœ¨ä»£ç æ®µçš„åœ°å€ 0x455253 488d0d46000000 LEAQ main.mc.func1(SB), CX # CX=main.mc.func1(SB) 0x45525a 488908 MOVQ CX, 0(AX) # funcval.fn=main.mc.func1(SB) 0x45525d 488b4c2418 MOVQ 0x18(SP), CX 0x455262 8401 TESTB AL, 0(CX) 0x455264 488b542430 MOVQ 0x30(SP), DX # DX=n # å¯ä»¥çœ‹å‡ºè¿™é‡Œæ•è·äº†å˜é‡nï¼Œå¹¶ä¸”æ˜¯æ‹·è´æ•è· 0x455269 48895108 MOVQ DX, 0x8(CX) # funcval.n = n 0x45526d 488b442418 MOVQ 0x18(SP), AX # AX=\u0026funcval 0x455272 4889442410 MOVQ AX, 0x10(SP) 0x455277 488b6c2420 MOVQ 0x20(SP), BP 0x45527c 4883c428 ADDQ $0x28, SP 0x455280 c3 RET func mc(n int) func() int { 0x455281 4889442408 MOVQ AX, 0x8(SP) 0x455286 e8d5ccffff CALL runtime.morestack_noctxt.abi0(SB) 0x45528b 488b442408 MOVQ 0x8(SP), AX 0x455290 eb8e JMP main.mc(SB) æ ¹æ®ä¸Šé¢ä»£ç å¯ä»¥æ¨æ–­å‡ºFunction ValueåŠ¨æ€åˆ†é…çš„å¯¹è±¡çš„ç±»å‹ã€‚ åº”è¯¥æ˜¯ä¸€ä¸ª struct ç±»å‹ï¼Œç¬¬1ä¸ªå­—æ®µæ˜¯å‡½æ•°åœ°å€ï¼Œç¬¬2ä¸ªå­—æ®µæ˜¯ int ç±»å‹ï¼Œä»£ç å¦‚ä¸‹ï¼š 1 2 3 4 struct { F uintptr n int } è¯´æ˜ç¼–è¯‘å™¨è¯†åˆ«å‡ºäº†é—­åŒ…è¿™ç§ä»£ç æ¨¡å¼ï¼Œå¹¶ä¸”è‡ªåŠ¨å®šä¹‰äº†è¿™ä¸ª struct ç±»å‹è¿›è¡Œæ”¯æŒï¼Œå‡ºäºé¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­æŠŠæ•°æ®ç§°ä¸ºå¯¹è±¡çš„ä¹ æƒ¯ï¼Œåæ–‡ä¸­å°±æŠŠè¿™ç§ struct ç§°ä¸ºé—­åŒ…å¯¹è±¡ã€‚ é—­åŒ…å¯¹è±¡çš„æˆå‘˜å¯ä»¥è¿›ä¸€æ­¥åˆ’åˆ†ï¼Œç¬¬1ä¸ªå­—æ®µFç”¨æ¥å­˜å‚¨ç›®æ ‡å‡½æ•°çš„åœ°å€ï¼Œè¿™åœ¨æ‰€æœ‰çš„é—­åŒ…å¯¹è±¡ä¸­éƒ½æ˜¯ä¸€è‡´çš„ï¼Œåæ–‡ä¸­å°†è¿™ä¸ªç›®æ ‡å‡½æ•°ç§°ä¸ºé—­åŒ…å‡½æ•°ã€‚ ä»ç¬¬2ä¸ªå­—æ®µå¼€å§‹ï¼Œåç»­çš„å­—æ®µç§°ä¸ºé—­åŒ…çš„æ•è·åˆ—è¡¨ï¼Œä¹Ÿå°±æ˜¯å†…å±‚å‡½æ•°ä¸­ç”¨åˆ°çš„æ‰€æœ‰å®šä¹‰åœ¨å¤–å±‚å‡½æ•°ä¸­çš„å˜é‡ã€‚ ç¼–è¯‘å™¨è®¤ä¸ºè¿™äº›å˜é‡è¢«é—­åŒ…æ•è·äº†ï¼Œä¼šæŠŠå®ƒä»¬è¿½åŠ åˆ°é—­åŒ…å¯¹è±¡çš„ struct å®šä¹‰ä¸­ã€‚ ä¸Šä¾‹ä¸­åªæ•è·äº†ä¸€ä¸ªå˜é‡ nï¼Œå¦‚æœæ•è·çš„å˜é‡å¢å¤šï¼Œstruct çš„æ•è·åˆ—è¡¨ä¹Ÿä¼šåŠ é•¿ã€‚ ä¸€ä¸ªæ•è·ä¸¤ä¸ªå˜é‡çš„é—­åŒ…ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š 1 2 3 4 5 func mc(n, m int) func() (int, int) { return func() (int, int) { return n, m } } ä¸Šè¿°ä»£ç å¯¹åº”çš„é—­åŒ…å¯¹è±¡å®šä¹‰ä»£ç å¦‚ä¸‹ï¼š 1 2 3 4 5 struct { F uintptr n int m int } çœ‹åˆ°é—­åŒ… é€šè¿‡åç¼–è¯‘æ¥é€†å‘æ¨æ–­é—­åŒ…å¯¹è±¡çš„ç»“æ„è¿˜æ˜¯æ¯”è¾ƒçƒ¦ççš„ï¼Œå¦‚æœèƒ½æœ‰ä¸€ç§æ–¹æ³•ï¼Œèƒ½å¤Ÿç›´è§‚çœ‹åˆ°é—­åŒ…å¯¹è±¡çš„ç»“æ„å®šä¹‰ï¼Œé‚£çœŸæ˜¯å†å¥½ä¸è¿‡äº†ã€‚ æ ¹æ®ä¹‹å‰çš„æ¢ç´¢ï¼Œå·²ç»çŸ¥é“ Go åºåœ¨è¿è¡Œé˜¶æ®µä¼šé€šè¿‡ runtime.newobject() å‡½æ•°åŠ¨æ€åŒ¹é…é—­åŒ…å¯¹è±¡ã€‚ Go æºç ä¸­ newobject() å‡½æ•°çš„åŸå‹å¦‚ä¸‹ï¼š func newobject(typ *_type) unsafe.Pointer å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸ªæŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯æ–°åˆ†é…çš„å¯¹è±¡çš„åœ°å€ï¼Œå‚æ•°æ˜¯ä¸ª _type ç±»å‹çš„æŒ‡é’ˆã€‚ é€šè¿‡æºç å¯ä»¥å¾—çŸ¥è¿™ä¸ª _type æ˜¯ä¸ª structï¼Œåœ¨ Go è¯­è¨€çš„ runtime åŒ…ä¸­è¢«ç”¨æ¥æè¿°ä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œé€šè¿‡å®ƒå¯ä»¥æ‰¾åˆ°ç›®æ ‡æ•°æ®ç±»å‹çš„å¤§å°ï¼Œå¯¹é½è¾¹ç•Œï¼Œç±»å‹åç§°ç­‰ã€‚ å‡å¦‚èƒ½å¤Ÿè·å¾—ä¼ é€’ç»™ runtime.newobjet() å‡½æ•°çš„ç±»å‹å…ƒæ•°æ®æŒ‡é’ˆ typï¼Œå†é€šè¿‡åå°„è¿›è¡Œè§£æï¼Œå°±èƒ½æ‰“å°å‡ºé—­åŒ…å¯¹è±¡çš„ç»“æ„å®šä¹‰äº†ã€‚é‚£å¦‚ä½•æ‰èƒ½è·å¾—è¿™ä¸ª typ å‚æ•°å‘¢ï¼Ÿ åœ¨Cè¯­è¨€ä¸­æœ‰ç§å¸¸ç”¨çš„å‡½æ•° Hook æŠ€æœ¯ï¼Œå°±æ˜¯åœ¨è¿è¡Œé˜¶æ®µå°†ç›®æ ‡å‡½æ•°å¤´éƒ¨çš„ä»£ç æ›¿æ¢ä¸ºä¸€æ¡è·³è½¬æŒ‡ä»¤ï¼Œè·³è½¬åˆ°ä¸€ä¸ªæ–°çš„å‡½æ•°ã€‚ åœ¨ x86 å¹³å°ä¸Šå°±æ˜¯åœ¨è¿›ç¨‹åœ°å€ç©ºé—´ä¸­æ‰¾åˆ°è¦ Hook çš„å‡½æ•°ï¼Œå°†å…¶å¤´éƒ¨æ›¿æ¢ä¸ºä¸€æ¡ JMP æŒ‡ä»¤ï¼ŒåŒæ—¶æŒ‡å®š JMP æŒ‡ä»¤è¦è·³è½¬åˆ°çš„æ–°å‡½æ•°çš„åœ°å€ã€‚ è¿™é¡¹æŠ€æœ¯åœ¨ Go ç¨‹åºä¸­ä¾ç„¶é€‚ç”¨ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªè‡ªå·±å®ç°çš„å‡½æ•°æ¢æ‰ runtime.newobject() å‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­å°±èƒ½è·å¾— typ å‚æ•°å¹¶è¿›è¡Œè§£æäº†ã€‚ è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ runtime.newobiect() å‡½æ•°å±äºæœªå¯¼å‡ºçš„å‡½æ•°ï¼Œåœ¨runtimeåŒ…å¤–æ— æ³•è®¿é—®ã€‚ è¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡ linkname æœºåˆ¶æ¥ç»•è¿‡ï¼Œåœ¨å½“å‰åŒ…ä¸­å£°æ˜ä¸€ä¸ªç±»ä¼¼çš„å‡½æ•°ï¼Œè®©é“¾æ¥å™¨å°†å…¶é“¾æ¥åˆ°runtime.newobject()å‡½æ•°å³å¯ã€‚ æœ¬ä¹¦ä½¿ç”¨å¼€æºæ¨¡å— github.com/fengyoulin/hookingo å®ç°è¿è¡Œé˜¶æ®µå‡½æ•°æ›¿æ¢ï¼Œæ‰“å°é—­åŒ…å¯¹è±¡ç»“æ„çš„å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 package main import ( \"github.com/fengyoulin/hookingo\" \"reflect\" \"unsafe\" ) var hno hookingo.Hook //go:linkname newobject runtime.newobject func newobject(typ unsafe.Pointer) unsafe.Pointer //go:linkname newobject2 runtime.mallocgc func newobject2(size uintptr, typ unsafe.Pointer, b bool) unsafe.Pointer func fno(typ unsafe.Pointer) unsafe.Pointer { t := reflect.TypeOf(0) // type Type interface{} // è¿™é‡Œä¸ºä»€ä¹ˆèµ‹å€¼çš„æ˜¯ä¸‹æ ‡1ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸ºä»€ä¹ˆæ˜¯1è€Œä¸æ˜¯0ä¸‹æ ‡ã€‚ // æ ¹æ®åé¢åˆ†æç¡®å®æ˜¯ä¿®æ”¹ä¸‹æ ‡1ï¼Œå› ä¸ºt.String()éœ€è¦ç”¨åˆ°1è¿™ä¸ªä¸‹æ ‡çš„æ•°æ®ã€‚ (*(*[2]unsafe.Pointer)(unsafe.Pointer(\u0026t)))[1] = typ // ç›¸å½“äºåå°„äº†é—­åŒ…ç±»å‹ println(t.String()) //fn, ok := hno.Origin().(func(typ unsafe.Pointer) unsafe.Pointer) //if ok { // return fn(typ) // è°ƒç”¨åŸruntime.newobject //} //println(\"ok\", ok) //os.Exit(1) println(*(*uintptr)(unsafe.Pointer(typ))) return newobject2(*(*uintptr)(typ), typ, true) } // åˆ›å»ºä¸€ä¸ªé—­åŒ…ï¼Œmake closure func mc(start int, text string) func() string { // è¿™é‡Œ start éœ€è¦å †åˆ†é… // func() string ä¹Ÿéœ€è¦å †åˆ†é… return func() string { l := len(text) s := start % l r := text[s:] start++ return r } } func main() { var err error hno, err = hookingo.Apply(newobject, fno) // åº”ç”¨é’©å­ï¼Œæ›¿æ¢å‡½æ•° if err != nil { panic(err) } f := mc(10, \"hello, closure!\") println(f()) } $ C:\\Users\\Helium\\go\\bin\\go1.17.exe run -gcflags -l . # go1.17 ç‰ˆæœ¬ int # æ‰“å°çš„æ˜¯mcçš„startå †åˆ†é… 8 # int å ç”¨å†…å­˜å¤§å° struct { F uintptr; text string; start *int } 32 sure! $ go run -gcflags -l . # go1.20.3ç‰ˆæœ¬ int 8 struct { F uintptr; text string; start *int } 32 sure! å› ä¸ºstartä¼šè¢«ä¿®æ”¹ï¼Œæ‰€ä»¥æ•è·åœ°å€é€ æˆå †åˆ†é…ï¼Œå› æ­¤ç»“æœç¬¬ä¸€è¡Œæ‰“å°äº†ä¸€ä¸ªintã€‚ ç¬¬äºŒè¡Œçš„structå°±æ˜¯é—­åŒ…ç»“æ„çš„ç±»å‹ï¼Œè¿™æ˜¯é€šè¿‡ç±»å‹å…ƒæ•°æ®ç›´æ¥è·å–åˆ°çš„ï¼Œæ˜¯ç”±ç¼–è¯‘å™¨æ„é€ çš„ç»“æ„ç±»å‹ã€‚ æˆ‘ä»¬æŠ„éƒ¨åˆ†fno()å‡½æ•°çš„ç›¸å…³ä»£ç ï¼štyp unsafe.Pointerï¼šæ¥è‡ªç±»å‹çš„*_typeç±»å‹æ•°æ®ã€‚ 1 2 3 4 5 6 7 func fno(typ unsafe.Pointer) unsafe.Pointer { t := reflect.TypeOf(0) // type Type interface{} // è¿™é‡Œä¸ºä»€ä¹ˆèµ‹å€¼çš„æ˜¯ä¸‹æ ‡1ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸ºä»€ä¹ˆæ˜¯1è€Œä¸æ˜¯0ä¸‹æ ‡ã€‚ (*(*[2]unsafe.Pointer)(unsafe.Pointer(\u0026t)))[1] = typ // ç›¸å½“äºåå°„äº†é—­åŒ…ç±»å‹ println(t.String()) // ... ... } åˆ†æreflect.TypeOf()å‡½æ•°å¦‚ä¸‹ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // TypeOf returns the reflection Type that represents the dynamic type of i. // If i is a nil interface value, TypeOf returns nil. func TypeOf(i any) Type { // emptyInterface æ˜¯ç©ºæ¥å£çš„å†…å­˜ç»“æ„ eface := *(*emptyInterface)(unsafe.Pointer(\u0026i)) // eface.typ è¿™é‡Œç›´æ¥å–äº† typ å­—æ®µï¼Œæ²¡æœ‰è¦wordå­—æ®µ // é€šè¿‡åˆ†ætoType()å‡½æ•°å¯çŸ¥ï¼ŒæŠŠeface.typæ”¾å…¥äº†éç©ºæ¥å£Typeä¸­ã€‚ // å› æ­¤å¿…é¡»è¦åˆ†æéç©ºæ¥å£ä¸­å­˜å‚¨çš„æ˜¯ä»€ä¹ˆï¼Ÿéç©ºæ¥å£å†…å­˜å¸ƒå±€ // type iface struct { // tab *itab // ç±»å‹å…ƒæ•°æ® // data *unsafe.Pointer // è£…ç®±çš„æ•°æ® // } // å› æ­¤ tab *itab è£…è½½çš„æ˜¯ *rtype ç±»å‹ç»“æ„ï¼Œä¹Ÿå°±æ˜¯ç»“æ„ä½“æŒ‡é’ˆ // æŒ‰ç…§ä¼ å…¥å‚æ•°0è¿™é‡Œå¯ä»¥çœ‹å‡ºåº”è¯¥æ˜¯intçš„å…ƒç±»å‹ // é‡è¦çš„æ˜¯ dataï¼Œè¿™å­˜å‚¨çš„æ˜¯ *rtype è¿™ä¸ªæŒ‡é’ˆæ•°æ®ï¼Œç±»å‹åå°„å°±æ˜¯ä¾é è¿™ä¸ªdataã€‚ // å› ä¸ºæˆ‘ä»¬è°ƒç”¨Typeéç©ºæ¥å£çš„æ‰€æœ‰æ–¹æ³•æ¥æ”¶å™¨çš„å‚æ•°éƒ½æ˜¯ *rtypeï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä¿®æ”¹ä¸‹æ ‡1çš„åŸå› ã€‚ // æˆ‘ä»¬åœ¨è°ƒç”¨t.String()æ–¹æ³•æ—¶ï¼Œéœ€è¦çš„æ—¶dataè¿™ä¸ªæ˜¯æˆ‘ä»¬æƒ³è¦çš„ç±»å‹å³å¯ã€‚ return toType(eface.typ) } // emptyInterface is the header for an interface{} value. type emptyInterface struct { typ *rtype // å­˜å‚¨ç€ç±»å‹ç»“æ„ word unsafe.Pointer } åˆ†ætoType()å‡½æ•°å¦‚ä¸‹ï¼š 1 2 3 4 5 6 7 8 9 10 11 // toType converts from a *rtype to a Type that can be returned // to the client of package reflect. In gc, the only concern is that // a nil *rtype must be replaced by a nil Type, but in gccgo this // function takes care of ensuring that multiple *rtype for the same // type are coalesced into a single Type. func toType(t *rtype) Type { if t == nil { return nil } return t } è°ƒç”¨é—­åŒ… é—­åŒ…å‡½æ•°åœ¨è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå¿…é¡»å¾—åˆ°å½“å‰é—­åŒ…å¯¹è±¡çš„åœ°å€æ‰èƒ½è®¿é—®å…¶ä¸­çš„æ•è·åˆ—è¡¨ï¼Œè¿™ä¸ªåœ°å€æ˜¯å¦‚ä½•ä¼ é€’çš„å‘¢ï¼Ÿ è°ƒç”¨è€…åœ¨è°ƒç”¨ Function Value çš„æ—¶å€™åªæ˜¯åƒè°ƒç”¨ä¸€ä¸ªæ™®é€šå‡½æ•°é‚£æ ·ä¼ é€’äº†å£°æ˜çš„å‚æ•°ï¼Œå¦‚æœ Function Value èƒŒåæ˜¯ä¸ªé—­åŒ…å‡½æ•°ï¼Œåˆ™æ— æ³•é€šè¿‡æ ˆä¸Šçš„å‚æ•°å¾—åˆ°é—­åŒ…å¯¹è±¡åœ°å€ã€‚ é™¤éç¼–è¯‘å™¨ä¼ é€’äº†ä¸€ä¸ªéšå«çš„å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°å¦‚æœé€šè¿‡æ ˆä¼ é€’ï¼Œé‚£å°±æ”¹å˜äº†å‡½æ•°çš„åŸå‹ï¼Œè¿™æ ·å°±ä¼šé€ æˆä¸ä¸€è‡´ï¼Œæ˜¯è¡Œä¸é€šçš„ã€‚ è¿˜æ˜¯é€šè¿‡åæ±‡ç¼–æ¥çœ‹ä¸€ä¸‹é—­åŒ…å‡½æ•°æ˜¯ä»å“ªé‡Œå¾—åˆ°çš„è¿™ä¸ªåœ°å€ï¼Œå…ˆæ¥æ„é€ é—­åŒ…ï¼Œä»£ç å¦‚ä¸‹ï¼š 1 2 3 4 5 func mc(n int) func int { return func() int { return n } } æ ¹æ®å‰é¢çš„æ¢ç´¢ï¼Œå¯ä»¥ç¡®å®šé—­åŒ…å¯¹è±¡çš„ç»“æ„å®šä¹‰ä»£ç å¦‚ä¸‹ï¼š 1 2 3 4 struct { F uintptr n int } åç¼–è¯‘é—­åŒ…å‡½æ•°å¾—åˆ°çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š ç¬¬7è¡Œï¼Œå°† DX å¯„å­˜å™¨ç”¨ä½œåŸºå€,å†åŠ ä¸Šä½ç§» 8ï¼ŒæŠŠè¯¥åœ°å€å¤„çš„å€¼å¤åˆ¶åˆ° CX å¯„å­˜å™¨ä¸­ã€‚ ç¬¬8è¡Œï¼ŒæŠŠ CX å¯„å­˜å™¨å€¼å¤åˆ¶ç»™é—­åŒ…å‡½æ•°çš„è¿”å›å€¼ã€‚ ç¬¬11è¡Œï¼ŒæŠŠè¿”å›å€¼æ”¾å…¥AXå¯„å­˜å™¨ä¸­ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 $ go tool objdump -S -s '^main.mc.func1$' ./h1 TEXT main.mc.func1(SB) /mnt/hgfs/workspace/helium/main.go return func() int { 0x4552a0 4883ec18 SUBQ $0x18, SP 0x4552a4 48896c2410 MOVQ BP, 0x10(SP) 0x4552a9 488d6c2410 LEAQ 0x10(SP), BP 0x4552ae 488b4a08 MOVQ 0x8(DX), CX # CX=0x8(DX) 0x4552b2 48894c2408 MOVQ CX, 0x8(SP) 0x4552b7 48c7042400000000 MOVQ $0x0, 0(SP) return n 0x4552bf 488b442408 MOVQ 0x8(SP), AX # AX=0x8(DX) 0x4552c4 48890424 MOVQ AX, 0(SP) 0x4552c8 488b6c2410 MOVQ 0x10(SP), BP 0x4552cd 4883c418 ADDQ $0x18, SP 0x4552d1 c3 RET æ˜¾ç„¶ï¼ŒDXå¯„å­˜å™¨å­˜å‚¨çš„å°±æ˜¯é—­åŒ…å¯¹è±¡çš„åœ°å€ï¼Œè°ƒç”¨è€…è´Ÿè´£åœ¨è°ƒç”¨ä¹‹å‰æŠŠé—­åŒ…å¯¹è±¡çš„åœ°å€å­˜å‚¨åˆ° DX å¯„å­˜å™¨ä¸­ï¼Œè·Ÿ C++ ä¸­çš„ thiscalléå¸¸ç±»ä¼¼ã€‚ ä¹‹å‰æœ‰å¾ˆå¤šè¯»è€…åœ¨åç¼–è¯‘ Function Value è°ƒç”¨ä»£ç æ—¶ï¼Œæ€»ä¼šçœ‹åˆ°ä¸º DX å¯„å­˜å™¨èµ‹å€¼ï¼Œå¹¶ä¸ºæ­¤æ„Ÿåˆ°ç–‘æƒ‘ï¼Œè¿™å°±æ˜¯åŸå› ã€‚ è°ƒç”¨è€…ä¸å¿…åŒºåˆ†æ˜¯ä¸æ˜¯é—­åŒ…ã€æœ‰æ²¡æœ‰æ•è·åˆ—è¡¨ï¼Œå®é™…ä¸Šä¹ŸåŒºåˆ†ä¸äº†ï¼Œåªèƒ½ç»Ÿä¸€ä½œä¸ºé—­åŒ…æ¥å¤„ç†ï¼Œæ‰€ä»¥æ€»è¦é€šè¿‡ DX ä¼ é€’åœ°å€ã€‚ å¦‚æœ Function Value èƒŒåä¸æ˜¯é—­åŒ…ï¼Œè¿™ä¸ªåœ°å€å°±ä¸ä¼šè¢«ç”¨åˆ°ï¼Œä¹Ÿä¸ä¼šé€ æˆä»€ä¹ˆå½±å“ã€‚ é—­åŒ…ä¸å˜é‡é€ƒé€¸ å˜é‡é€ƒé€¸è·Ÿé—­åŒ…ä¹‹é—´çš„å…³ç³»å¾ˆå¯†åˆ‡ï¼Œå› ä¸º Function Value æœ¬èº«å°±æ˜¯ä¸ªæŒ‡é’ˆï¼Œç¼–è¯‘å™¨ä¹Ÿå¯ä»¥æŒ‰ç…§åŒæ ·çš„æ–¹å¼æ¥åˆ†æ Function Value æœ‰æ²¡æœ‰é€ƒé€¸ã€‚ å¦‚æœ Function Value æ²¡æœ‰é€ƒé€¸é‚£å°±å¯ä»¥ä¸ç”¨åœ¨å †ä¸Šåˆ†é…é—­åŒ…å¯¹è±¡äº†ï¼Œåˆ†é…åœ¨æ ˆä¸Šå³å¯ã€‚ ä½¿ç”¨ä¸€ä¸ªç¤ºä¾‹è¿›è¡ŒéªŒè¯ï¼Œä»£ç å¦‚ä¸‹ï¼š 1 2 3 4 5 6 func sc(n int) int { f := func() int { return n } return f() } ä»£ç é€»è¾‘è¿‡äºç®€å•ï¼Œä¸ºäº†é¿å…é—­åŒ…å‡½æ•°è¢«ç¼–è¯‘å™¨ä¼˜åŒ–æ‰ï¼Œç¼–è¯‘æ—¶éœ€è¦ç¦ç”¨å†…è”ä¼˜åŒ–ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š$ go build -gcflags='-l'ã€‚ å†æ¥åç¼–è¯‘ sc() å‡½æ•°ï¼Œmain.scåç¼–è¯‘å‘½ä»¤åŠè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 $ go build -gcflags=\"-l -N\" -o ./h1 myzx.cn/helium $ go tool objdump -S -s '^main.sc$' ./h1 TEXT main.sc(SB) /mnt/hgfs/workspace/helium/main.go func sc(n int) int { 0x455220 493b6610 CMPQ 0x10(R14), SP 0x455224 7664 JBE 0x45528a 0x455226 4883ec38 SUBQ $0x38, SP 0x45522a 48896c2430 MOVQ BP, 0x30(SP) 0x45522f 488d6c2430 LEAQ 0x30(SP), BP 0x455234 4889442440 MOVQ AX, 0x40(SP) # åˆ†é…å‚æ•°ç©ºé—´ 0x455239 48c7042400000000 MOVQ $0x0, 0(SP) # åˆ†é…è¿”å›å€¼ç©ºé—´ f := func() int { 0x455241 440f117c2410 MOVUPS X15, 0x10(SP) 0x455247 488d542410 LEAQ 0x10(SP), DX # \u0026funcval 0x45524c 4889542428 MOVQ DX, 0x28(SP) 0x455251 8402 TESTB AL, 0(DX) 0x455253 488d0546000000 LEAQ main.sc.func1(SB), AX 0x45525a 4889442410 MOVQ AX, 0x10(SP) # funcval.fn 0x10(SP) 0x45525f 8402 TESTB AL, 0(DX) 0x455261 488b442440 MOVQ 0x40(SP), AX # å‚æ•°nçš„å€¼ 0 0x455266 4889442418 MOVQ AX, 0x18(SP) # funcval.data 0x18(SP) 0 0x45526b 4889542420 MOVQ DX, 0x20(SP) return f() 0x455270 488b442410 MOVQ 0x10(SP), AX 0x455275 ffd0 CALL AX 0x455277 4889442408 MOVQ AX, 0x8(SP) 0x45527c 48890424 MOVQ AX, 0(SP) 0x455280 488b6c2430 MOVQ 0x30(SP), BP 0x455285 4883c438 ADDQ $0x38, SP 0x455289 c3 RET func sc(n int) int { 0x45528a 4889442408 MOVQ AX, 0x8(SP) 0x45528f e8ccccffff CALL runtime.morestack_noctxt.abi0(SB) 0x455294 488b442408 MOVQ 0x8(SP), AX 0x455299 eb85 JMP main.sc(SB) å‡½æ•° åœ¨Goè¯­è¨€ä¸­å‡½æ•°å±äºå¤´ç­‰å¯¹è±¡ï¼Œå¯ä»¥è¢«å½“ä½œå‚æ•°ä¼ é€’ã€ä¹Ÿå¯ä»¥ä½œä¸ºå‡½æ•°è¿”å›å€¼ã€ç»‘å®šåˆ°å˜é‡ã€‚ Goè¯­è¨€ç§°è¿™æ ·çš„å‚æ•°ã€è¿”å›å€¼å’Œå˜é‡ä¸ºFunction Valueã€‚ Function Valueæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå´ä¸ç›´æ¥æŒ‡å‘å‡½æ•°æŒ‡ä»¤å…¥å£ï¼Œè€Œæ˜¯æŒ‡å‘runtime.funcvalç»“æ„ä½“ï¼Œå‡½æ•°å˜é‡å­˜å‚¨çš„æ˜¯*funcvalç±»å‹ï¼Œä¹Ÿå°±æ˜¯funcvalç»“æ„ä½“çš„åœ°å€ã€‚ 1 2 3 4 5 6 7 8 9 10 11 // é—­åŒ…æ˜¯å‡½æ•°ç±»å‹funcType // é—­åŒ…æ•è·çš„å˜é‡ï¼Œç³»ç»Ÿç»´æŠ¤ç€ä¸€ä¸ªå…³ç³»åˆ—è¡¨ï¼Œæ ¹æ®è¿™ä¸ªåˆ—è¡¨èƒ½æ­£ç¡®çš„æ‰¾åˆ°æ•è·çš„å˜é‡ç±»å‹å¤§å°ç­‰ä¿¡æ¯ type funcval struct { fn uintptr // æŒ‡å‘ç¨‹åºçš„ä»£ç æ®µ // variable-size, fn-specific data here } // ç´§æ¥ç€funcvalç»“æ„ä½“åé¢å†…å­˜åœ°å€æ˜¯æ•è·çš„çš„å˜é‡åˆ—è¡¨ // æ³¨æ„æ•è·çš„æ˜¯å˜é‡çš„åœ°å€ï¼Œä½¿ç”¨çš„å´æ˜¯å˜é‡çš„å€¼ // é—­åŒ…ä¸­æ•è·çš„å¦‚æœæ˜¯æŒ‡é’ˆç±»å‹é‚£ä¹ˆæ˜¯å¼•ç”¨ï¼Œæ˜¯æ™®é€šç±»å‹é‚£ä¹ˆæ˜¯æ‹·è´ // f -\u003e *funcval è¿™ä¸ªç»“æ„ä½“ä»å®šä¹‰ä¸Šçœ‹åªæœ‰ä¸€ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€æ‰æ˜¯å‡½æ•°çš„æŒ‡ä»¤å…¥å£ã€‚ä¸€ä¸ªFunction Valueæ˜¯ä»¥ä¸‹å›¾æ‰€ç¤ºå½¢å¼å­˜åœ¨çš„ã€‚ é—­åŒ… Closureï¼šç»´åŸºç™¾ç§‘ é—­åŒ…åœ¨å®ç°ä¸Šæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå®ƒå­˜å‚¨äº†ä¸€ä¸ªå‡½æ•°ï¼ˆé€šå¸¸æ˜¯å…¶å…¥å£åœ°å€ï¼‰å’Œä¸€ä¸ªå…³è”çš„ç¯å¢ƒï¼ˆç›¸å½“äºä¸€ä¸ªç¬¦å·æŸ¥æ‰¾è¡¨ï¼‰ã€‚ ç¯å¢ƒé‡Œæ˜¯è‹¥å¹²å¯¹ç¬¦å·å’Œå€¼çš„å¯¹åº”å…³ç³»ï¼Œå®ƒæ—¢è¦åŒ…æ‹¬çº¦æŸå˜é‡ï¼ˆè¯¥å‡½æ•°å†…éƒ¨ç»‘å®šçš„ç¬¦å·ï¼‰ï¼Œä¹Ÿè¦åŒ…æ‹¬è‡ªç”±å˜é‡ï¼ˆåœ¨å‡½æ•°å¤–éƒ¨å®šä¹‰ä½†åœ¨å‡½æ•°å†…è¢«å¼•ç”¨ï¼‰ï¼Œæœ‰äº›å‡½æ•°ä¹Ÿå¯èƒ½æ²¡æœ‰è‡ªç”±å˜é‡ã€‚ é—­åŒ…è·Ÿå‡½æ•°æœ€å¤§çš„ä¸åŒåœ¨äºï¼Œå½“æ•æ‰é—­åŒ…çš„æ—¶å€™ï¼Œå®ƒçš„è‡ªç”±å˜é‡ä¼šåœ¨æ•æ‰æ—¶è¢«ç¡®å®šï¼Œè¿™æ ·å³ä¾¿è„±ç¦»äº†æ•æ‰æ—¶çš„ä¸Šä¸‹æ–‡ï¼Œå®ƒä¹Ÿèƒ½ç…§å¸¸è¿è¡Œã€‚ æ‰€ä»¥åƒä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 func create() func(){ c := 2 // cä¼šè¢«åˆ†é…åœ¨æ ˆä¸Šï¼Œä»¥æ‹·è´å½¢å¼è¢«æ•è· return func(){ // ã€ç”±äºcå˜é‡åé¢æ²¡æœ‰å˜åŒ–ï¼Œæ‰€ä»¥è¿™é‡Œæ•è·å˜æˆæ‹·è´cçš„å€¼2å°±è¡Œï¼Œä¸éœ€è¦æ•è·cçš„åœ°å€ã€‘ fmt.Println(c) } } func main(){ // f1 { // fn ---\u003e é—­åŒ…å‡½æ•°åœ°å€ // 2 ---\u003e æ‹·è´cçš„å€¼å³å¯ï¼ˆä¸éœ€è¦æ•è·cçš„åœ°å€ï¼‰ï¼Œè¿™é‡Œ2 // } f1 := create() f2 := create() f1() f2() // é—­åŒ…å‡½æ•°çš„å†…å­˜ç»“æ„å¸ƒå±€ s := **(**struct{ fn uintptr // æŒ‡å‘å‡½æ•°ä»£ç åœ°å€ data1 int // æ•è·å˜é‡ })(unsafe.Pointer(\u0026f1)) fmt.Printf(\"%#v\\n\", s) // struct {fn uintptr;data1 int}{fn:0x47f520, data1:2} } createå‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”å¼•ç”¨äº†å…¶å¤–å±‚å‡½æ•°å®šä¹‰çš„å±€éƒ¨å˜é‡cã€‚ è€Œä¸”ï¼Œå³ä¾¿createå‡½æ•°ç»“æŸï¼Œä¾ç„¶å¯ä»¥é€šè¿‡f1å’Œf2æ­£å¸¸æ‰§è¡Œè¿™ä¸ªå‡½æ•°å¹¶ä½¿ç”¨å®šä¹‰åœ¨createå†…éƒ¨çš„å˜é‡cã€‚ æ‰€ä»¥è¿™ä¸ªè¿”å›å€¼ç¬¦åˆé—­åŒ…çš„å®šä¹‰ï¼Œè€Œè¿™ä¸ªè‡ªç”±å˜é‡cï¼Œé€šå¸¸è¢«ç§°ä¸ºæ•è·å˜é‡ã€‚ è™½ç„¶createå‡½æ•°çš„è¿”å›å€¼å‡½æ•°å½¢æˆé—­åŒ…ï¼Œä½†æ˜¯Goè¯­è¨€é‡Œå¹¶æ²¡æœ‰æŠŠé—­åŒ…ä»Function Valueä¸­ç‰¹åˆ«åŒºåˆ†å‡ºæ¥ã€‚ åœ¨Goè¯­è¨€ä¸­é—­åŒ…åªæ˜¯æ‹¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ•è·å˜é‡çš„Function Valueè€Œå·²ã€‚ è¿™äº›æ•è·å˜é‡å°±æ˜¯å®ƒçš„æ•è·åˆ—è¡¨ï¼Œå°±æ”¾åœ¨å¯¹åº”çš„funcvalç»“æ„ä½“çš„åé¢ã€‚ æ‰€ä»¥ä¸Šä¾‹ä¸­ï¼Œf1å’Œf2çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ¯ä¸ªé—­åŒ…å¯¹è±¡éƒ½æ˜¯ä¸€ä¸ªFunction Valueï¼Œä½†æ˜¯å„è‡ªæŒæœ‰è‡ªå·±çš„æ•è·åˆ—è¡¨ï¼Œè¿™ä¹Ÿæ˜¯ç§°é—­åŒ…ä¸ºæœ‰çŠ¶æ€çš„å‡½æ•°çš„åŸå› ã€‚ é—­åŒ…æ•è·å˜é‡å€¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 package main func main() { f := create() _ = f() } //go:noinline func create() func() int { c := 2 // å †åˆ†é… struct { F uintptr; c int } return func() int { // æ³¨æ„è¿™é‡Œçš„cå˜é‡ä¸éœ€è¦è¢«æ•è· // cæ²¡æœ‰æ›´æ”¹ï¼Œåªéœ€è¦æ‹·è´å˜é‡cçš„å€¼å³å¯ return c } } main å‡½æ•°æ±‡ç¼–ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func main() { 0x4551e0 493b6610 CMPQ 0x10(R14), SP # æ ˆå¢é•¿åˆ¤æ–­ 0x4551e4 7629 JBE 0x45520f 0x4551e6 4883ec10 SUBQ $0x10, SP # main.mainæ ˆåˆ†é… 0x4551ea 48896c2408 MOVQ BP, 0x8(SP) 0x4551ef 488d6c2408 LEAQ 0x8(SP), BP f := create() 0x4551f4 e827000000 CALL main.create(SB) # AXè¿”å›\u0026funcval 0x4551f9 48890424 MOVQ AX, 0(SP) _ = f() 0x4551fd 488b08 MOVQ 0(AX), CX # CX=funcval.fn 0x455200 4889c2 MOVQ AX, DX # DX=\u0026funcval 0x455203 ffd1 CALL CX } 0x455205 488b6c2408 MOVQ 0x8(SP), BP 0x45520a 4883c410 ADDQ $0x10, SP 0x45520e c3 RET func main() { 0x45520f e84ccdffff CALL runtime.morestack_noctxt.abi0(SB) 0x455214 ebca JMP main.main(SB) create å‡½æ•°æ±‡ç¼–ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 func create() func() int { 0x455220 493b6610 CMPQ 0x10(R14), SP # æ ˆå¢é•¿åˆ¤æ–­ 0x455224 765f JBE 0x455285 0x455226 4883ec30 SUBQ $0x30, SP # åˆ†é…createæ ˆç©ºé—´ 0x45522a 48896c2428 MOVQ BP, 0x28(SP) 0x45522f 488d6c2428 LEAQ 0x28(SP), BP 0x455234 48c744241800000000 MOVQ $0x0, 0x18(SP) # ä¸´æ—¶è¿”å›ç©ºé—´8å­—èŠ‚ï¼Œ*funcval c := 2 0x45523d 48c744241002000000 MOVQ $0x2, 0x10(SP) # å‚æ•° c return func() int { # AX=0x7493(IP)ï¼Œfuncvalç»“æ„ä½“ç±»å‹çš„_typeç±»å‹æŒ‡é’ˆä½ç½®ï¼Œå†…å­˜å¤§å°16B 0x455246 488d0593740000 LEAQ 0x7493(IP), AX # æ ¹æ®*_typeè¿›è¡Œå †åˆ†é…ï¼ŒAX=\u0026funcval 0x45524d e8ee5cfbff CALL runtime.newobject(SB) 0x455252 4889442420 MOVQ AX, 0x20(SP) # CX=main.create.func1 ä»£ç åœ°å€ 0x455257 488d0d42000000 LEAQ main.create.func1(SB), CX 0x45525e 488908 MOVQ CX, 0(AX) # funcval.fn=main.create.func1 0x455261 488b4c2420 MOVQ 0x20(SP), CX # CX=\u0026funcval 0x455266 8401 TESTB AL, 0(CX) 0x455268 488b542410 MOVQ 0x10(SP), DX # DX=0x2 0x45526d 48895108 MOVQ DX, 0x8(CX) # funcval.data=0x2 0x455271 488b442420 MOVQ 0x20(SP), AX # AX=\u0026funcval 0x455276 4889442418 MOVQ AX, 0x18(SP) 0x45527b 488b6c2428 MOVQ 0x28(SP), BP 0x455280 4883c430 ADDQ $0x30, SP 0x455284 c3 RET func create() func() int { 0x455285 e8d6ccffff CALL runtime.morestack_noctxt.abi0(SB) 0x45528a eb94 JMP main.create(SB) main.create.func1 å‡½æ•°æ±‡ç¼–ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 TEXT main.create.func1(SB) /mnt/hgfs/g/hello1/func1.go return func() int { 0x4552a0 4883ec18 SUBQ $0x18, SP 0x4552a4 48896c2410 MOVQ BP, 0x10(SP) 0x4552a9 488d6c2410 LEAQ 0x10(SP), BP 0x4552ae 488b4a08 MOVQ 0x8(DX), CX # CX=0x2 0x4552b2 48894c2408 MOVQ CX, 0x8(SP) 0x4552b7 48c7042400000000 MOVQ $0x0, 0(SP) // æ³¨æ„è¿™é‡Œçš„cå˜é‡ä¸éœ€è¦è¢«æ•è· 0x4552bf 488b442408 MOVQ 0x8(SP), AX # AX=0x2 0x4552c4 48890424 MOVQ AX, 0(SP) 0x4552c8 488b6c2410 MOVQ 0x10(SP), BP 0x4552cd 4883c418 ADDQ $0x18, SP 0x4552d1 c3 RET mainå’Œcreateçš„æ ˆåˆ†å¸ƒã€‚ | runtime.main callback -------------------------- +40 +08 | runtime.main BP -------------------------- BP --------------- +38 +00 | create.r *funcval main.mainæ ˆ -------------------------- SP --------------- +30 | main.main callback -------------------------- +28 | main.main BP -------------------------- BP --------------- +20 | \u0026funcval create.o -\u003e ä¸´æ—¶funcvalå †åˆ†é… -------------------------- +18 | \u0026funcval create.r -\u003e createçš„è¿”å›å€¼ -------------------------- +10 | 0x2 create.c main.createæ ˆ -------------------------- +08 | -------------------------- +00 | -------------------------- SP --------------- é—­åŒ…æ•è·å˜é‡åœ°å€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 package main func main() { f := create() _ = f() } //go:noinline func create() func() int { c := 2 // å †åˆ†é… struct { F uintptr; c *int } return func() int { c++ // æ•è·cå˜é‡åœ°å€ï¼Œåœ¨å †ä¸Šåˆ†é… return c } } main å‡½æ•°æ±‡ç¼–ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func main() { 0x4551e0 493b6610 CMPQ 0x10(R14), SP 0x4551e4 7629 JBE 0x45520f 0x4551e6 4883ec10 SUBQ $0x10, SP 0x4551ea 48896c2408 MOVQ BP, 0x8(SP) 0x4551ef 488d6c2408 LEAQ 0x8(SP), BP f := create() 0x4551f4 e827000000 CALL main.create(SB) # è°ƒç”¨å‡½æ•° AXè¿”å›\u0026funcval 0x4551f9 48890424 MOVQ AX, 0(SP) _ = f() 0x4551fd 488b08 MOVQ 0(AX), CX # CX=funcval.fn 0x455200 4889c2 MOVQ AX, DX # DX=\u0026funcval 0x455203 ffd1 CALL CX } 0x455205 488b6c2408 MOVQ 0x8(SP), BP 0x45520a 4883c410 ADDQ $0x10, SP 0x45520e c3 RET func main() { 0x45520f e84ccdffff CALL runtime.morestack_noctxt.abi0(SB) 0x455214 ebca JMP main.main(SB) create å‡½æ•°æ±‡ç¼–ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 func create() func() int { 0x455220 493b6610 CMPQ 0x10(R14), SP 0x455224 0f8686000000 JBE 0x4552b0 0x45522a 4883ec30 SUBQ $0x30, SP 0x45522e 48896c2428 MOVQ BP, 0x28(SP) 0x455233 488d6c2428 LEAQ 0x28(SP), BP 0x455238 48c744241000000000 MOVQ $0x0, 0x10(SP) c := 2 0x455241 488d05f84a0000 LEAQ 0x4af8(IP), AX # AX=0x4af8(IP)ï¼Œintçš„å…ƒç±»å‹ 0x455248 e8f35cfbff CALL runtime.newobject(SB) # ç”³è¯·å†…å­˜ï¼ŒAX=*int 0x45524d 4889442420 MOVQ AX, 0x20(SP) # å˜é‡c 0x455252 48c70002000000 MOVQ $0x2, 0(AX) # ç»™cèµ‹å€¼2 return func() int { 0x455259 488d0580740000 LEAQ 0x7480(IP), AX # funcvalçš„å…ƒç±»å‹ï¼Œç”³è¯·16B 0x455260 e8db5cfbff CALL runtime.newobject(SB) # AX=\u0026funcval 0x455265 4889442418 MOVQ AX, 0x18(SP) 0x45526a 488d0d4f000000 LEAQ main.create.func1(SB), CX # CX=main.create.func1 0x455271 488908 MOVQ CX, 0(AX) # funcval.fn=main.create.func1 0x455274 488b4c2418 MOVQ 0x18(SP), CX # CX=\u0026funcval 0x455279 8401 TESTB AL, 0(CX) 0x45527b 488b542420 MOVQ 0x20(SP), DX # DX=*int -\u003e 2 0x455280 488d7908 LEAQ 0x8(CX), DI # DI=funcval.data 0x455284 833dd51f090000 CMPL $0x0, runtime.writeBarrier(SB) 0x45528b 7402 JE 0x45528f 0x45528d eb06 JMP 0x455295 0x45528f 48895108 MOVQ DX, 0x8(CX) # funcval.data=*int -\u003e 2 0x455293 eb07 JMP 0x45529c 0x455295 e8a6d0ffff CALL runtime.gcWriteBarrierDX(SB) 0x45529a eb00 JMP 0x45529c 0x45529c 488b442418 MOVQ 0x18(SP), AX # AX=\u0026funcval 0x4552a1 4889442410 MOVQ AX, 0x10(SP) 0x4552a6 488b6c2428 MOVQ 0x28(SP), BP 0x4552ab 4883c430 ADDQ $0x30, SP 0x4552af c3 RET func create() func() int { 0x4552b0 e8abccffff CALL runtime.morestack_noctxt.abi0(SB) 0x4552b5 e966ffffff JMP main.create(SB) main.create.func1 å‡½æ•°æ±‡ç¼–ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 TEXT main.create.func1(SB) /mnt/hgfs/g/hello1/func1.go return func() int { 0x4552c0 4883ec18 SUBQ $0x18, SP 0x4552c4 48896c2410 MOVQ BP, 0x10(SP) 0x4552c9 488d6c2410 LEAQ 0x10(SP), BP 0x4552ce 488b4a08 MOVQ 0x8(DX), CX 0x4552d2 48894c2408 MOVQ CX, 0x8(SP) 0x4552d7 48c7042400000000 MOVQ $0x0, 0(SP) c++ // æ•è·cå˜é‡åœ°å€ï¼Œåœ¨å †ä¸Šåˆ†é… 0x4552df 488b4c2408 MOVQ 0x8(SP), CX 0x4552e4 488b09 MOVQ 0(CX), CX 0x4552e7 488b542408 MOVQ 0x8(SP), DX 0x4552ec 48ffc1 INCQ CX 0x4552ef 48890a MOVQ CX, 0(DX) return c 0x4552f2 488b4c2408 MOVQ 0x8(SP), CX 0x4552f7 488b01 MOVQ 0(CX), AX 0x4552fa 48890424 MOVQ AX, 0(SP) 0x4552fe 488b6c2410 MOVQ 0x10(SP), BP 0x455303 4883c418 ADDQ $0x18, SP 0x455307 c3 RET mainå’Œcreateçš„æ ˆåˆ†å¸ƒã€‚ | runtime.main callback ------------------------- +40 +08 | runtime.main BP ------------------------- BP ------------ +38 +00 | \u0026funcval c.r main.mainæ ˆ ------------------------- SP ------------ +30 | main.main callback ------------------------- +28 | main.main BP ------------------------- BP ------------ +20 | *int -\u003e 2 c ------------------------- +18 | \u0026funcval c.o ------------------------- +10 | \u0026funcval c.r ------------------------- +08 | ------------------------- +00 | ------------------------- SP ------------ è°ƒç”¨ é€šè¿‡Function Valueè°ƒç”¨å‡½æ•°æ—¶ï¼Œä¼šæŠŠå¯¹åº”çš„funcvalç»“æ„ä½“åœ°å€å­˜å…¥ç‰¹å®šå¯„å­˜å™¨ï¼Œå¦‚amd64å¹³å°ä½¿ç”¨çš„æ˜¯DXå¯„å­˜å™¨ï¼Œå‚çœ‹ä¸Šé¢çš„æ±‡ç¼–ç¡®å®ä½¿ç”¨DXå¯„å­˜å™¨å­˜å‚¨çš„ã€‚ ç»§ç»­ä½¿ç”¨é—­åŒ…çš„ç¤ºä¾‹ï¼Œé€šè¿‡f1è°ƒç”¨é—­åŒ…å‡½æ•°æ—¶ï¼Œä¼šæŠŠf1å­˜å‚¨çš„funcvalç»“æ„ä½“åœ°å€å­˜å…¥å¯„å­˜å™¨DXï¼Œè¿™æ ·åœ¨é—­åŒ…å‡½æ•°çš„æŒ‡ä»¤ä¸­å°±å¯ä»¥é€šè¿‡è¿™ä¸ªå¯„å­˜å™¨å­˜å‚¨çš„åœ°å€åŠ ä¸Š8å­—èŠ‚çš„åç§»ï¼Œå°±æ‰¾åˆ°f1çš„æ•è·å˜é‡äº†ã€‚ åŒæ ·çš„ï¼Œé€šè¿‡f2è°ƒç”¨é—­åŒ…å‡½æ•°æ—¶ï¼Œä¼šæŠŠf2å­˜å‚¨çš„funcvalç»“æ„ä½“åœ°å€å­˜å…¥å¯„å­˜å™¨ï¼Œé—­åŒ…å‡½æ•°æ‰§è¡Œæ—¶æ‰¾åˆ°çš„å°±æ˜¯f2çš„æ•è·å˜é‡äº†ã€‚ å¦‚æœæ˜¯æ²¡æœ‰æ•è·åˆ—è¡¨çš„Function Valueï¼Œç›´æ¥å¿½ç•¥è¿™ä¸ªå¯„å­˜å™¨å³å¯ã€‚ é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼ŒGoè¯­è¨€å®ç°äº†å¯¹Function Valueçš„ç»Ÿä¸€è°ƒç”¨ã€‚ é™æ€åˆ†é… å¯¹äºæ²¡æœ‰æ•è·åˆ—è¡¨çš„Function Valueï¼Œå¦‚æœå¤šä¸ªå˜é‡å…³è”åˆ°åŒä¸€ä¸ªå‡½æ•°ï¼Œç¼–è¯‘å™¨ä¼šåšå‡ºä¼˜åŒ–ï¼Œè®©å®ƒä»¬å…±ç”¨ä¸€ä¸ªfuncvalç»“æ„ä½“ã€‚ æ³¨æ„ funcval åé¢å­˜å‚¨çš„æ˜¯æ•è·çš„å‚æ•°ï¼Œå®é™…ä¼ å‚ä¸åœ¨è¿™é‡Œï¼Œåœ¨è°ƒç”¨è¯¥å‡½æ•°æ—¶åœ¨è°ƒç”¨æ ˆä¸Šã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 func A(i int) { i++ fmt.Println(i) } func B(){ f1 := A f1(1) } func C(){ f2 := A f2(1) } åƒä¸Šé¢è¿™ç§æƒ…å†µï¼Œç¼–è¯‘é˜¶æ®µä¼šåˆ›å»ºä¸€ä¸ªfuncvalç»“æ„ä½“æ”¾åˆ°åªè¯»æ•°æ®æ®µï¼Œè€Œæ‰§è¡Œé˜¶æ®µï¼Œf1å’Œf2éƒ½ä¼šä½¿ç”¨å®ƒã€‚ é™æ€åˆ†é…éªŒè¯ 1 2 3 4 5 6 7 8 9 10 11 package main func main() { f1 := A f1(1) } //go:noinline func A(i int) { i++ } main å‡½æ•°æ±‡ç¼–ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func main() { 0x4551e0 493b6610 CMPQ 0x10(R14), SP 0x4551e4 7632 JBE 0x455218 0x4551e6 4883ec18 SUBQ $0x18, SP 0x4551ea 48896c2410 MOVQ BP, 0x10(SP) 0x4551ef 488d6c2410 LEAQ 0x10(SP), BP f1 := A 0x4551f4 488d15251d0100 LEAQ 0x11d25(IP), DX # DX=\u0026funcval 0x4551fb 4889542408 MOVQ DX, 0x8(SP) f1(1) 0x455200 488b0d191d0100 MOVQ 0x11d19(IP), CX # CX=funcval.fnï¼Œå‡½æ•°Açš„åœ°å€ 0x455207 b801000000 MOVL $0x1, AX # AX=0x1ï¼Œå‚æ•° 0x45520c ffd1 CALL CX } 0x45520e 488b6c2410 MOVQ 0x10(SP), BP 0x455213 4883c418 ADDQ $0x18, SP 0x455217 c3 RET func main() { 0x455218 e843cdffff CALL runtime.morestack_noctxt.abi0(SB) 0x45521d ebc1 JMP main.main(SB) A å‡½æ•°æ±‡ç¼–ä»£ç ã€‚ 1 2 3 4 5 6 7 8 TEXT main.A(SB) /mnt/hgfs/g/hello1/func1.go func A(i int) { 0x455220 4889442408 MOVQ AX, 0x8(SP) i++ 0x455225 48ffc0 INCQ AX 0x455228 4889442408 MOVQ AX, 0x8(SP) } 0x45522d c3 RET mainå’ŒAçš„æ ˆåˆ†å¸ƒã€‚ | runtime.main callback ------------------------------- +10 | runtime.main BP ------------------------------- BP +08 | 0x11d25(IP) A ------------------------------- +00 | ------------------------------- SP æ•è·åˆ—è¡¨ å› ä¸ºæ•è·åˆ—è¡¨éœ€è¦ç”±é—­åŒ…å¯¹è±¡å„è‡ªæŒæœ‰ï¼Œæ‰€ä»¥æœ‰æ•è·åˆ—è¡¨çš„Function Valueè¦åˆ°æ‰§è¡Œé˜¶æ®µæ‰ä¼šåœ¨å †ä¸Šåˆ†é…å¯¹åº”çš„funcvalç»“æ„ä½“ä»¥åŠæ•è·åˆ—è¡¨ç©ºé—´ã€‚ ä½†æ˜¯ï¼Œæ•è·åˆ—è¡¨é‡Œå­˜ä»€ä¹ˆï¼Ÿç›´æ¥æ‹·è´æ•è·å˜é‡å€¼å—ï¼Ÿæ‰æ²¡æœ‰é‚£ä¹ˆç®€å•ã€‚ é—­åŒ…æ•è·çš„å˜é‡è¦åœ¨é—­åŒ…å‡½æ•°å’Œå¤–å±‚å‡½æ•°ä¸­è¡¨ç°ä¸€è‡´ï¼Œå¦‚æœå•çº¯å€¼æ‹·è´ï¼Œå°±æ— æ³•ä¿è¯è¿™ä¸€ç‚¹ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨é’ˆå¯¹æ•è·å˜é‡çš„ä¸åŒæƒ…å†µåˆ†åˆ«åšå‡ºäº†ä¸åŒçš„å¤„ç†ã€‚ æ•è·å˜é‡ã€é™¤äº†åˆå§‹åŒ–èµ‹å€¼å¤–åœ¨ä»»ä½•åœ°æ–¹éƒ½æ²¡æœ‰è¢«ä¿®æ”¹è¿‡ï¼Œé‚£å°±å¯ä»¥ç›´æ¥æ‹·è´å€¼ã€‘ï¼Œå› ä¸ºå®ƒä¸ä¼šå†å˜åŒ–ã€‚ æ•è·å˜é‡é™¤äº†åˆå§‹åŒ–èµ‹å€¼å¤–ï¼Œè¿˜è¢«ä¿®æ”¹è¿‡ï¼Œå°±è¦å†ç»†åˆ†äº†ã€‚ æ•è·å±€éƒ¨å˜é‡ è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¢«æ•è·çš„æ˜¯å±€éƒ¨å˜é‡iï¼Œé™¤äº†åˆå§‹åŒ–èµ‹å€¼å¤–è¿˜è¢«ä¿®æ”¹è¿‡ï¼Œæ‰€ä»¥å±€éƒ¨å˜é‡iæ”¹ä¸ºå †åˆ†é…ï¼Œæ ˆä¸Šåªå­˜ä¸€ä¸ªåœ°å€ã€‚ åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œä¸ºäº†è®©è¢«æ•è·çš„å±€éƒ¨å˜é‡åœ¨é—­åŒ…å‡½æ•°å’Œå¤–å±‚å‡½æ•°ä¸­ä¿æŒä¸€è‡´ï¼Œæœ¬è¯¥åœ¨æ ˆä¸Šåˆ†é…çš„å±€éƒ¨å˜é‡è¢«åˆ†é…åˆ°å †ä¸Šï¼Œè¿™å…¶å®ä¹Ÿæ˜¯å˜é‡é€ƒé€¸çš„ä¸€ç§åœºæ™¯ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func create() (fs [2]func()){ for i := 0; i \u003c 2; i++ { // struct { F uintptr; i *int } fs[i] = func(){ fmt.Println(\u0026i, i) } } return } func main() { fs := create() for i := 0; i \u003c len(fs); i++ { fs[i]() } // Output: // 0xc0000ac058 2 // 0xc0000ac058 2 } æ•è·å±€éƒ¨å˜é‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package main func main() { fs := create() for i := 0; i \u003c len(fs); i++ { fs[i]() } } //go:noinline func create() (fs [2]func()) { for i := 0; i \u003c 2; i++ { // å †åˆ†é… struct { F uintptr; i *int } fs[i] = func() { i++ } } return } main æ±‡ç¼–ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 func main() { 0x4551e0 493b6610 CMPQ 0x10(R14), SP 0x4551e4 7675 JBE 0x45525b 0x4551e6 4883ec30 SUBQ $0x30, SP 0x4551ea 48896c2428 MOVQ BP, 0x28(SP) 0x4551ef 488d6c2428 LEAQ 0x28(SP), BP fs := create() 0x4551f4 e887000000 CALL main.create(SB) # è°ƒç”¨main.create 0x4551f9 0f100424 MOVUPS 0(SP), X0 # å°†0(SP)å16Bå†…å®¹æ”¾å…¥X0ï¼Œè¿™é‡Œçš„ä¸¤è¡Œä»£ç ç›¸å½“äºfsèµ‹å€¼ 0x4551fd 0f11442418 MOVUPS X0, 0x18(SP) # å°†X0è¿ç§»åˆ°0x18(SP)å16B for i := 0; i \u003c len(fs); i++ { 0x455202 48c744241000000000 MOVQ $0x0, 0x10(SP) # iåˆå§‹åŒ– 0 0x45520b eb00 JMP 0x45520d 0x45520d 48837c241002 CMPQ $0x2, 0x10(SP) # iå’Œ0x2æ¯”è¾ƒ \u003c--- å¾ªç¯åˆ¤æ–­æ¡ä»¶ 0x455213 7c02 JL 0x455217 0x455215 eb2f JMP 0x455246 fs[i]() 0x455217 488b442410 MOVQ 0x10(SP), AX # AX=0 0x45521c 0f1f4000 NOPL 0(AX) 0x455220 4883f802 CMPQ $0x2, AX 0x455224 7202 JB 0x455228 0x455226 eb28 JMP 0x455250 0x455228 488d44c418 LEAQ 0x18(SP)(AX*8), AX # AX=\u0026funcval 0x45522d 488b10 MOVQ 0(AX), DX # DX=\u0026funcval.fn 0x455230 488b02 MOVQ 0(DX), AX # AX=funcval.fn 0x455233 ffd0 CALL AX # è°ƒç”¨å‡½æ•° 0x455235 eb00 JMP 0x455237 for i := 0; i \u003c len(fs); i++ { 0x455237 488b5c2410 MOVQ 0x10(SP), BX # BX=0 0x45523c 48ffc3 INCQ BX # BX=1 0x45523f 48895c2410 MOVQ BX, 0x10(SP) # i=1 0x455244 ebc7 JMP 0x45520d # \u003c--- ä¸€è½®å¾ªç¯ç»“æŸè·³è½¬å¾ªç¯å¼€å¤´ } 0x455246 488b6c2428 MOVQ 0x28(SP), BP 0x45524b 4883c430 ADDQ $0x30, SP 0x45524f c3 RET fs[i]() 0x455250 b902000000 MOVL $0x2, CX 0x455255 e866d4ffff CALL runtime.panicIndex(SB) 0x45525a 90 NOPL func main() { 0x45525b 0f1f440000 NOPL 0(AX)(AX*1) 0x455260 e8fbccffff CALL runtime.morestack_noctxt.abi0(SB) 0x455265 e976ffffff JMP main.main(SB) create æ±‡ç¼–ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 func create() (fs [2]func()) { 0x455280 493b6610 CMPQ 0x10(R14), SP 0x455284 0f86d0000000 JBE 0x45535a 0x45528a 4883ec28 SUBQ $0x28, SP 0x45528e 48896c2420 MOVQ BP, 0x20(SP) 0x455293 488d6c2420 LEAQ 0x20(SP), BP 0x455298 440f117c2430 MOVUPS X15, 0x30(SP) # 0x30(SP)å¼€å§‹çš„16Båœ°å€æ¸…é›¶ for i := 0; i \u003c 2; i++ { 0x45529e 488d059b4a0000 LEAQ 0x4a9b(IP), AX # AX=0x4a9b(IP)ï¼Œintçš„å…ƒç±»å‹ \u003c--- å˜é‡iåˆå§‹åŒ– 0x4552a5 e8965cfbff CALL runtime.newobject(SB) # å˜é‡iç”³è¯·å†…å­˜ï¼ŒAXè¿”å› *int 0x4552aa 4889442418 MOVQ AX, 0x18(SP) 0x4552af 48c70000000000 MOVQ $0x0, 0(AX) # iå˜é‡èµ‹å€¼0 0x4552b6 eb00 JMP 0x4552b8 0x4552b8 488b4c2418 MOVQ 0x18(SP), CX # CX=\u0026i \u003c--- å¾ªç¯ä»è¿™é‡Œå¼€å§‹ï¼Œåé¢æ»¡è¶³æ¡ä»¶ä¼šè·³è½¬å›æ¥ 0x4552bd 48833902 CMPQ $0x2, 0(CX) # iä¸2æ¯”è¾ƒ 0x4552c1 7c05 JL 0x4552c8 0x4552c3 e97d000000 JMP 0x455345 fs[i] = func() { # struct { F uintptr; i *int } 0x4552c8 488d0511740000 LEAQ 0x7411(IP), AX # AX=0x7411(IP)ï¼Œfuncvalå…ƒç±»å‹ å†…å­˜16B 0x4552cf e86c5cfbff CALL runtime.newobject(SB) # ç”³è¯·å†…å­˜16Bï¼ŒAX=\u0026funcval 0x4552d4 4889442410 MOVQ AX, 0x10(SP) 0x4552d9 488d0da0000000 LEAQ main.create.func1(SB), CX # CX=main.create.func1 0x4552e0 488908 MOVQ CX, 0(AX) # funcval.fn=main.create.func1 0x4552e3 488b4c2410 MOVQ 0x10(SP), CX # CX=\u0026funcval 0x4552e8 8401 TESTB AL, 0(CX) 0x4552ea 488b542418 MOVQ 0x18(SP), DX # DX=\u0026int 0x4552ef 488d7908 LEAQ 0x8(CX), DI # DI=funcval.data 0x4552f3 833d661f090000 CMPL $0x0, runtime.writeBarrier(SB) # æ£€æŸ¥å†™å±éšœ 0x4552fa 7402 JE 0x4552fe 0x4552fc eb06 JMP 0x455304 0x4552fe 48895108 MOVQ DX, 0x8(CX) # funcval.data=\u0026int 0x455302 eb07 JMP 0x45530b 0x455304 e837d0ffff CALL runtime.gcWriteBarrierDX(SB) # è°ƒç”¨å†™å±éšœå‡½æ•° 0x455309 eb00 JMP 0x45530b 0x45530b 488b542418 MOVQ 0x18(SP), DX # DX=\u0026int 0x455310 488b02 MOVQ 0(DX), AX # AX=0 0x455313 488b542410 MOVQ 0x10(SP), DX # DX=\u0026funcval 0x455318 4883f802 CMPQ $0x2, AX # AXå’Œ2æ¯”è¾ƒ 0x45531c 7204 JB 0x455322 0x45531e 6690 NOPW 0x455320 eb2d JMP 0x45534f 0x455322 488d4cc430 LEAQ 0x30(SP)(AX*8), CX # CX=0x30(SP)(AX*8)ï¼ŒAX=0 -\u003e 0x30(SP)ï¼ŒAX=1 -\u003e 0x38(SP) 0x455327 488911 MOVQ DX, 0(CX) # è¿”å›æ•°ç»„éå†èµ‹å€¼ 0x45532a eb00 JMP 0x45532c for i := 0; i \u003c 2; i++ { 0x45532c 488b4c2418 MOVQ 0x18(SP), CX # CX=\u0026int 0x455331 488b09 MOVQ 0(CX), CX # CX=0 0x455334 488b542418 MOVQ 0x18(SP), DX # DX=\u0026int 0x455339 48ffc1 INCQ CX # CX=1 0x45533c 48890a MOVQ CX, 0(DX) # ièµ‹å€¼1 0x45533f 90 NOPL 0x455340 e973ffffff JMP 0x4552b8 # è·³è½¬åˆ°å‰é¢å¼€å§‹ä¸‹ä¸€è½®å¾ªç¯ return 0x455345 488b6c2420 MOVQ 0x20(SP), BP 0x45534a 4883c428 ADDQ $0x28, SP 0x45534e c3 RET fs[i] = func() { 0x45534f b902000000 MOVL $0x2, CX 0x455354 e867d3ffff CALL runtime.panicIndex(SB) 0x455359 90 NOPL func create() (fs [2]func()) { 0x45535a e801ccffff CALL runtime.morestack_noctxt.abi0(SB) 0x45535f 90 NOPL 0x455360 e91bffffff JMP main.create(SB) mainå’Œcreateçš„æ ˆå¸ƒå±€ã€‚ | runtime.main callback --------------------------- +58 +28 | runtime.main BP --------------------------- BP --------------- +50 +20 | \u0026funcval c.r --------------------------- +48 +18 | \u0026funcval c.r --------------------------- +40 +10 | 0x0 i main.mainæ ˆ --------------------------- +38 +08 | \u0026funcval fs[1] --------------------------- +30 +00 | \u0026funcval fs[0] --------------------------- SP --------------- +28 | main.main callback --------------------------- +20 | main.main BP --------------------------- BP --------------- +18 | *int -\u003e 0 1 i --------------------------- +10 | \u0026funcval --------------------------- main.createæ ˆ +08 | --------------------------- +00 | --------------------------- SP --------------- æ•è·å‚æ•° å¦‚æœæ˜¯å‚æ•°è¢«æ•è·ï¼Œé‚£ä¹ˆè°ƒç”¨è€…ä¾ç„¶ä»æ ˆä¸Šä¼ é€’å‚æ•°ï¼Œä½†æ˜¯è¢«è°ƒç”¨å‡½æ•°ä¼šæŠŠå®ƒæ‹·è´åˆ°å †ä¸Šä¸€ä»½ï¼Œç„¶åå’Œé—­åŒ…å‡½æ•°éƒ½ä½¿ç”¨å †ä¸Šåˆ†é…çš„é‚£ä¸€ä¸ªã€‚\nå€¼ä¼ é€’å‚æ•°æ—¶ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func Te1(a int) func() int { // æ­¤æ—¶çš„aå‚æ•°åœ¨å †ä¸Šåˆ†é… // è¿”å›é—­åŒ…æ•è·äº†å‡½æ•°å‚æ•°ï¼Œå‚æ•°aä¼šè¢«å¤åˆ¶åˆ°å †ä¸Šä¾›æ•´ä¸ªTe1å‡½æ•°åŠè¿”å›é—­åŒ…ä½¿ç”¨ // å †åˆ†é… struct { F uintptr; a *int } return func() int { a++ return a } } func main() { var a1 int f := Te1(a1) fmt.Println(f()) // 1 fmt.Println(a1) // 0 // å¯ä»¥çœ‹å‡º å‚æ•°è¢«é—­åŒ…æ•è·å…³ç³»çš„åªæ˜¯æ•è·å‡½æ•°å†…ç›¸å…³å‚æ•°ï¼Œå‚çœ‹ä¸‹é¢æ±‡ç¼– } å€¼ä¼ é€’å‚æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package main func main() { a1 := 1 b := Te1(a1) b() } //go:noinline func Te1(a int) func() int { // è¿”å›é—­åŒ…æ•è·äº†å‡½æ•°å‚æ•° // å‚æ•°aä¼šè¢«å¤åˆ¶åˆ°å †ä¸Šä¾›æ•´ä¸ªTe1å‡½æ•°åŠè¿”å›é—­åŒ…ä½¿ç”¨ // struct { F uintptr; a *int } // æ ¹æ®æ±‡ç¼–å¯è§ï¼ŒTe1å †åˆ†é…äº†aï¼Œå¹¶æŠŠä¼ å…¥çš„å‚æ•°1æ‹·è´ç»™äº†aã€‚ return func() int { a++ return a } } main å‡½æ•°æ±‡ç¼–ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 func main() { 0x4551e0 493b6610 CMPQ 0x10(R14), SP 0x4551e4 7638 JBE 0x45521e 0x4551e6 4883ec20 SUBQ $0x20, SP 0x4551ea 48896c2418 MOVQ BP, 0x18(SP) 0x4551ef 488d6c2418 LEAQ 0x18(SP), BP a1 := 1 0x4551f4 48c744240801000000 MOVQ $0x1, 0x8(SP) # a1=1 b := Te1(a1) 0x4551fd b801000000 MOVL $0x1, AX # AX=0x1 0x455202 e839000000 CALL main.Te1(SB) # è°ƒç”¨å‡½æ•° 0x455207 4889442410 MOVQ AX, 0x10(SP) b() 0x45520c 488b08 MOVQ 0(AX), CX # CX=funcval.fn 0x45520f 4889c2 MOVQ AX, DX # DX=\u0026funcval 0x455212 ffd1 CALL CX } 0x455214 488b6c2418 MOVQ 0x18(SP), BP 0x455219 4883c420 ADDQ $0x20, SP 0x45521d c3 RET func main() { 0x45521e 6690 NOPW 0x455220 e83bcdffff CALL runtime.morestack_noctxt.abi0(SB) 0x455225 ebb9 JMP main.main(SB) main.Te1 å‡½æ•°æ±‡ç¼–ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 func Te1(a int) func() int { 0x455240 493b6610 CMPQ 0x10(R14), SP 0x455244 0f8691000000 JBE 0x4552db 0x45524a 4883ec30 SUBQ $0x30, SP 0x45524e 48896c2428 MOVQ BP, 0x28(SP) 0x455253 488d6c2428 LEAQ 0x28(SP), BP 0x455258 4889442438 MOVQ AX, 0x38(SP) # å‚æ•°a 0x45525d 48c744241000000000 MOVQ $0x0, 0x10(SP) 0x455266 488d05d34a0000 LEAQ 0x4ad3(IP), AX # AX=0x4ad3(IP)ï¼Œintå…ƒç±»å‹ï¼Œå‚æ•°aå †åˆ†é… 0x45526d e8ce5cfbff CALL runtime.newobject(SB) # ç”³è¯·å†…å­˜ AX=\u0026int *int 0x455272 4889442420 MOVQ AX, 0x20(SP) # å †åˆ†é…çš„å˜é‡a *int 0x455277 488b4c2438 MOVQ 0x38(SP), CX # CX=1 0x45527c 488908 MOVQ CX, 0(AX) # AX=\u0026int -\u003e 1 return func() int { # struct { F uintptr; a *int } 0x45527f 488d055a740000 LEAQ 0x745a(IP), AX # AX=0x745a(IP)ï¼Œfuncvalç»“æ„ä½“å…ƒç±»å‹ï¼Œå 16B 0x455286 e8b55cfbff CALL runtime.newobject(SB) # ç”³è¯·å†…å­˜ï¼ŒAX=\u0026funcval 0x45528b 4889442418 MOVQ AX, 0x18(SP) 0x455290 488d0d69000000 LEAQ main.Te1.func1(SB), CX # CX=main.Te1.func1 0x455297 488908 MOVQ CX, 0(AX) # funcval.fn=main.Te1.func1 0x45529a 488b4c2418 MOVQ 0x18(SP), CX # CX=\u0026funcval 0x45529f 8401 TESTB AL, 0(CX) 0x4552a1 488b542420 MOVQ 0x20(SP), DX # DX=\u0026int 0x4552a6 488d7908 LEAQ 0x8(CX), DI # DI=funcval.data 0x4552aa 833daf1f090000 CMPL $0x0, runtime.writeBarrier(SB) 0x4552b1 7402 JE 0x4552b5 0x4552b3 eb0b JMP 0x4552c0 0x4552b5 48895108 MOVQ DX, 0x8(CX) # funcval.data=\u0026int 0x4552b9 eb0c JMP 0x4552c7 0x4552bb 0f1f440000 NOPL 0(AX)(AX*1) 0x4552c0 e87bd0ffff CALL runtime.gcWriteBarrierDX(SB) 0x4552c5 eb00 JMP 0x4552c7 0x4552c7 488b442418 MOVQ 0x18(SP), AX # AX=\u0026funcval 0x4552cc 4889442410 MOVQ AX, 0x10(SP) 0x4552d1 488b6c2428 MOVQ 0x28(SP), BP 0x4552d6 4883c430 ADDQ $0x30, SP 0x4552da c3 RET func Te1(a int) func() int { 0x4552db 4889442408 MOVQ AX, 0x8(SP) 0x4552e0 e87bccffff CALL runtime.morestack_noctxt.abi0(SB) 0x4552e5 488b442408 MOVQ 0x8(SP), AX 0x4552ea e951ffffff JMP main.Te1(SB) main.Te1.func1 å‡½æ•°æ±‡ç¼–ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 TEXT main.Te1.func1(SB) /mnt/hgfs/workspace/helium/main.go return func() int { 0x455300 4883ec18 SUBQ $0x18, SP 0x455304 48896c2410 MOVQ BP, 0x10(SP) 0x455309 488d6c2410 LEAQ 0x10(SP), BP 0x45530e 488b4a08 MOVQ 0x8(DX), CX 0x455312 48894c2408 MOVQ CX, 0x8(SP) 0x455317 48c7042400000000 MOVQ $0x0, 0(SP) a++ 0x45531f 488b4c2408 MOVQ 0x8(SP), CX 0x455324 488b09 MOVQ 0(CX), CX 0x455327 488b542408 MOVQ 0x8(SP), DX 0x45532c 48ffc1 INCQ CX 0x45532f 48890a MOVQ CX, 0(DX) return a 0x455332 488b4c2408 MOVQ 0x8(SP), CX 0x455337 488b01 MOVQ 0(CX), AX 0x45533a 48890424 MOVQ AX, 0(SP) 0x45533e 488b6c2410 MOVQ 0x10(SP), BP 0x455343 4883c418 ADDQ $0x18, SP 0x455347 c3 RET æ ˆå¸ƒå±€ä¿¡æ¯ã€‚ +58 +20 | runtime.main callback ---------------------------------- +50 +18 | runtime.main BP ---------------------------------- BP -------------- +48 +10 | \u0026funcval å˜é‡b ---------------------------------- +40 +08 | 0x1 å˜é‡a1 main.mainæ ˆ ---------------------------------- +38 +00 | 0x1 å‚æ•°a ---------------------------------- SP -------------- +30 | main.main callback ---------------------------------- +28 | main.main BP ---------------------------------- BP -------------- +20 | \u0026int -\u003e 1 a ---------------------------------- +18 | \u0026funcval r.o ---------------------------------- +10 | \u0026funcval r main.Te1æ ˆ ---------------------------------- +08 | ---------------------------------- +00 | ---------------------------------- SP -------------- å¼•ç”¨ä¼ é€’å‚æ•°æ—¶ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // å¦‚æœæ•è·çš„æ˜¯æŒ‡é’ˆæƒ…å†µå‘¢ï¼Œæ ¹æ®ä¸‹é¢ä»£ç å¯ä»¥çœ‹å‡ºè·Ÿä¸Šé¢æƒ…å†µä¸€æ ·çš„è§„åˆ™ // è¿™ç§æƒ…å†µè·Ÿæ•è·å…¨å±€å˜é‡åŸºæœ¬è¡¨ç°ä¸€è‡´ func Te1(a *int) func() int { // è¿”å›é—­åŒ…æ•è·äº†å‡½æ•°å‚æ•°ï¼Œå‚æ•°aä¼šè¢«å¤åˆ¶åˆ°æ ˆä¸Šä¾›æ•´ä¸ªTe1å‡½æ•°åŠè¿”å›é—­åŒ…ä½¿ç”¨ // å †åˆ†é… struct { F uintptr; a *int } return func() int { *a++ return *a } } func main() { var a1 int f := Te1(\u0026a1) fmt.Println(a1) // 0 fmt.Println(f()) // 1 fmt.Println(a1) // 1 a1++ fmt.Println(f()) // 3 fmt.Println(a1) // 3 // æ³¨æ„è¿™é‡Œä¸‹é¢çš„ä¸€è¡Œä»£ç ï¼Œä¼šå…ˆæ‰§è¡Œf() f() åœ¨æ‰“å°æ‰€ä»¥å‡ºç°äº†å¥‡æ€ªçš„è¾“å‡º // å› ä¸ºå‚æ•°ä¼šå…ˆè¢«å®æ—¶è®¡ç®—ï¼Œå› æ­¤å…ˆæ‰§è¡Œäº†f()å’Œf()ï¼Œç„¶åå†æ‰“å°æ•°æ®çš„ã€‚ // fmt.Println(a1, f(), a1, f(), a1) // 2 1 2 2 2 } å¼•ç”¨ä¼ é€’å‚æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 package main func main() { a1 := 1 b := Te1(\u0026a1) b() } //go:noinline func Te1(a *int) func() int { // è¿”å›é—­åŒ…æ•è·äº†å‡½æ•°å‚æ•° // å‚æ•°aä¼šè¢«å¤åˆ¶åˆ°å †ä¸Šä¾›æ•´ä¸ªTe1å‡½æ•°åŠè¿”å›é—­åŒ…ä½¿ç”¨ // struct { F uintptr; a *int } return func() int { *a++ return *a } } main å‡½æ•°æ±‡ç¼–ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func main() { 0x4551e0 493b6610 CMPQ 0x10(R14), SP 0x4551e4 764c JBE 0x455232 0x4551e6 4883ec28 SUBQ $0x28, SP 0x4551ea 48896c2420 MOVQ BP, 0x20(SP) 0x4551ef 488d6c2420 LEAQ 0x20(SP), BP a1 := 1 # è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œç›´æ¥å°±ç»™aå †åˆ†é…äº† 0x4551f4 488d05454b0000 LEAQ 0x4b45(IP), AX # AX=0x4b45(IP)ï¼Œintå…ƒç±»å‹ 0x4551fb 0f1f440000 NOPL 0(AX)(AX*1) 0x455200 e83b5dfbff CALL runtime.newobject(SB) # AX=\u0026int 0x455205 4889442418 MOVQ AX, 0x18(SP) 0x45520a 48c70001000000 MOVQ $0x1, 0(AX) # a=1 b := Te1(\u0026a1) 0x455211 488b442418 MOVQ 0x18(SP), AX # AX=\u0026int 0x455216 e825000000 CALL main.Te1(SB) # è°ƒç”¨å‡½æ•°ï¼ŒAX=\u0026funcval 0x45521b 4889442410 MOVQ AX, 0x10(SP) b() 0x455220 488b08 MOVQ 0(AX), CX # CX=funcval.fn 0x455223 4889c2 MOVQ AX, DX # DX=\u0026funcval 0x455226 ffd1 CALL CX # è°ƒç”¨å‡½æ•° } 0x455228 488b6c2420 MOVQ 0x20(SP), BP 0x45522d 4883c428 ADDQ $0x28, SP 0x455231 c3 RET func main() { 0x455232 e829cdffff CALL runtime.morestack_noctxt.abi0(SB) 0x455237 eba7 JMP main.main(SB) main.Te1 å‡½æ•°æ±‡ç¼–ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 func Te1(a *int) func() int { 0x455240 493b6610 CMPQ 0x10(R14), SP 0x455244 7675 JBE 0x4552bb 0x455246 4883ec28 SUBQ $0x28, SP 0x45524a 48896c2420 MOVQ BP, 0x20(SP) 0x45524f 488d6c2420 LEAQ 0x20(SP), BP 0x455254 4889442430 MOVQ AX, 0x30(SP) # å‚æ•°a *int 0x455259 48c744241000000000 MOVQ $0x0, 0x10(SP) # è¿”å›å€¼ func() int return func() int { # struct { F uintptr; i *int } 0x455262 488d0577740000 LEAQ 0x7477(IP), AX # AX=0x7477(IP)ï¼Œfuncvalç»“æ„ä½“ 16B 0x455269 e8d25cfbff CALL runtime.newobject(SB # AX=\u0026funcval 0x45526e 4889442418 MOVQ AX, 0x18(SP) 0x455273 488d0d66000000 LEAQ main.Te1.func1(SB), CX # CX=main.Te1.func1 0x45527a 488908 MOVQ CX, 0(AX) # funcval.fn=main.Te1.func1 0x45527d 488b4c2418 MOVQ 0x18(SP), CX # CX=\u0026funcval 0x455282 8401 TESTB AL, 0(CX) 0x455284 488b542430 MOVQ 0x30(SP), DX # DX=\u0026int 0x455289 488d7908 LEAQ 0x8(CX), DI # DI=funcval.data 0x45528d 833dcc1f090000 CMPL $0x0, runtime.writeBarrier(SB) 0x455294 7402 JE 0x455298 0x455296 eb08 JMP 0x4552a0 0x455298 48895108 MOVQ DX, 0x8(CX) # funcval.data=\u0026int 0x45529c eb09 JMP 0x4552a7 0x45529e 6690 NOPW 0x4552a0 e89bd0ffff CALL runtime.gcWriteBarrierDX(SB) 0x4552a5 eb00 JMP 0x4552a7 0x4552a7 488b442418 MOVQ 0x18(SP), AX # AX=\u0026funcval 0x4552ac 4889442410 MOVQ AX, 0x10(SP) 0x4552b1 488b6c2420 MOVQ 0x20(SP), BP 0x4552b6 4883c428 ADDQ $0x28, SP 0x4552ba c3 RET main.Te1.func1 å‡½æ•°æ±‡ç¼–ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func Te1(a *int) func() int { 0x4552bb 4889442408 MOVQ AX, 0x8(SP) 0x4552c0 e89bccffff CALL runtime.morestack_noctxt.abi0(SB) 0x4552c5 488b442408 MOVQ 0x8(SP), AX 0x4552ca e971ffffff JMP main.Te1(SB) return func() int { 0x4552e0 4883ec18 SUBQ $0x18, SP 0x4552e4 48896c2410 MOVQ BP, 0x10(SP) 0x4552e9 488d6c2410 LEAQ 0x10(SP), BP 0x4552ee 488b4a08 MOVQ 0x8(DX), CX # CX=\u0026int 0x4552f2 48894c2408 MOVQ CX, 0x8(SP) 0x4552f7 48c7042400000000 MOVQ $0x0, 0(SP) *a++ 0x4552ff 488b4c2408 MOVQ 0x8(SP), CX # CX=\u0026int 0x455304 8401 TESTB AL, 0(CX) 0x455306 488b542408 MOVQ 0x8(SP), DX # DX=\u0026int 0x45530b 8402 TESTB AL, 0(DX) 0x45530d 488b09 MOVQ 0(CX), CX # CX=1 0x455310 48ffc1 INCQ CX # CX=2 0x455313 48890a MOVQ CX, 0(DX) # \u0026int -\u003e 2 return *a 0x455316 488b4c2408 MOVQ 0x8(SP), CX # CX=\u0026int 0x45531b 8401 TESTB AL, 0(CX) 0x45531d 488b01 MOVQ 0(CX), AX # AX=2 0x455320 48890424 MOVQ AX, 0(SP) 0x455324 488b6c2410 MOVQ 0x10(SP), BP 0x455329 4883c418 ADDQ $0x18, SP 0x45532d c3 RET æ ˆåˆ†å¸ƒæƒ…å†µã€‚ +58 +28 | address of runtime.main ------------------------------ +50 +20 | BP of runtime.main ------------------------------ BP +48 +18 | \u0026int -\u003e 1 a1 ------------------------------ +40 +10 | \u0026funcval b ------------------------------ +38 +08 | ------------------------------ +30 +00 | \u0026int T.a ------------------------------ SP +28 | address of main.main ------------------------------ +20 | BP of main.main ------------------------------ BP +18 | \u0026funcval T.o ------------------------------ +10 | \u0026funcval T.r ------------------------------ +08 | ------------------------------ +00 | ------------------------------ SP æ•è·è¿”å›å€¼ å¦‚æœæ˜¯è¿”å›å€¼è¢«æ•è·ï¼Œé‚£ä¹ˆå¤„ç†æ–¹å¼å°±åˆæœ‰äº›ä¸åŒäº†ã€‚ è¿”å›å€¼ç©ºé—´ä¾ç„¶ç”±è°ƒç”¨è€…åœ¨æ ˆä¸Šåˆ†é…ï¼Œä½†æ˜¯è¢«è°ƒç”¨å‡½æ•°ï¼ˆé—­åŒ…çš„å¤–å±‚å‡½æ•°ï¼‰ä¼šåœ¨å †ä¸Šä¹Ÿåˆ†é…ä¸€ä¸ªï¼Œå¹¶ä¸”ä¸é—­åŒ…å‡½æ•°éƒ½ä½¿ç”¨å †ä¸Šè¿™ä¸€ä¸ªï¼Œä½†æ˜¯ï¼Œåœ¨å¤–å±‚å‡½æ•°è¿”å›å‰è¦æŠŠå †ä¸Šçš„è¿”å›å€¼æ‹·è´åˆ°æ ˆä¸Šé‚£ä¸€ä¸ªã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 package main func main() { b, _ := Te1() b() } //go:noinline func Te1() (y func() int, y1 int) { y1++ // 1 // å †åˆ†é… struct { F uintptr; y1 *int } return func() int { y1++ return 1 }, y1 } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 func main() { 0x4551e0 493b6610 CMPQ 0x10(R14), SP 0x4551e4 763b JBE 0x455221 0x4551e6 4883ec18 SUBQ $0x18, SP 0x4551ea 48896c2410 MOVQ BP, 0x10(SP) 0x4551ef 488d6c2410 LEAQ 0x10(SP), BP b, _ := Te1() 0x4551f4 48c744240800000000 MOVQ $0x0, 0x8(SP) 0x4551fd 0f1f00 NOPL 0(AX) 0x455200 e83b000000 CALL main.Te1(SB) 0x455205 4889442408 MOVQ AX, 0x8(SP) 0x45520a 48890424 MOVQ AX, 0(SP) b() 0x45520e 488b1424 MOVQ 0(SP), DX 0x455212 488b02 MOVQ 0(DX), AX 0x455215 ffd0 CALL AX } 0x455217 488b6c2410 MOVQ 0x10(SP), BP 0x45521c 4883c418 ADDQ $0x18, SP 0x455220 c3 RET func main() { 0x455221 e83acdffff CALL runtime.morestack_noctxt.abi0(SB) 0x455226 ebb8 JMP main.main(SB) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 func Te1() (y func() int, y1 int) { 0x455240 493b6610 CMPQ 0x10(R14), SP 0x455244 0f868e000000 JBE 0x4552d8 0x45524a 4883ec30 SUBQ $0x30, SP 0x45524e 48896c2428 MOVQ BP, 0x28(SP) 0x455253 488d6c2428 LEAQ 0x28(SP), BP 0x455258 48c744241000000000 MOVQ $0x0, 0x10(SP) 0x455261 488d05d84a0000 LEAQ 0x4ad8(IP), AX # AX=0x4ad8(IP)ï¼Œintå…ƒç±»å‹ 0x455268 e8d35cfbff CALL runtime.newobject(SB) # AX=\u0026int 0x45526d 4889442420 MOVQ AX, 0x20(SP) y1++ 0x455272 48ff00 INCQ 0(AX) # y1=1 return func() int { # struct { F uintptr; y1 *int } 0x455275 488d0564740000 LEAQ 0x7464(IP), AX # AX=0x7464(IP)ï¼Œfuncvalå…ƒç±»å‹ 16B 0x45527c 0f1f4000 NOPL 0(AX) 0x455280 e8bb5cfbff CALL runtime.newobject(SB) # AX=\u0026funcval 0x455285 4889442418 MOVQ AX, 0x18(SP) 0x45528a 488d0d6f000000 LEAQ main.Te1.func1(SB), CX # CX=main.Te1.func1 0x455291 488908 MOVQ CX, 0(AX) # funcval.fn=main.Te1.func1 0x455294 488b4c2418 MOVQ 0x18(SP), CX # CX=\u0026funcval 0x455299 8401 TESTB AL, 0(CX) 0x45529b 488b542420 MOVQ 0x20(SP), DX # DX=\u0026int 0x4552a0 488d7908 LEAQ 0x8(CX), DI # DI=funcval.data 0x4552a4 833db51f090000 CMPL $0x0, runtime.writeBarrier(SB) 0x4552ab 7402 JE 0x4552af 0x4552ad eb06 JMP 0x4552b5 0x4552af 48895108 MOVQ DX, 0x8(CX) # funcval.data=\u0026int 0x4552b3 eb07 JMP 0x4552bc 0x4552b5 e886d0ffff CALL runtime.gcWriteBarrierDX(SB) 0x4552ba eb00 JMP 0x4552bc 0x4552bc 488b442418 MOVQ 0x18(SP), AX # AX=\u0026funcval è¿”å›å‚æ•°1 0x4552c1 4889442410 MOVQ AX, 0x10(SP) 0x4552c6 488b4c2420 MOVQ 0x20(SP), CX # CX=\u0026int 0x4552cb 488b19 MOVQ 0(CX), BX # BX=1 è¿”å›å‚æ•°2 0x4552ce 488b6c2428 MOVQ 0x28(SP), BP 0x4552d3 4883c430 ADDQ $0x30, SP 0x4552d7 c3 RET func Te1() (y func() int, y1 int) { 0x4552d8 e883ccffff CALL runtime.morestack_noctxt.abi0(SB) 0x4552dd 0f1f00 NOPL 0(AX) 0x4552e0 e95bffffff JMP main.Te1(SB) +50 +18 | address of runtime.main ----------------------------- +48 +10 | BP of runtime.main ----------------------------- BP +40 +08 | 0 ----------------------------- +38 +00 | ----------------------------- SP +30 | address of main.main ----------------------------- +28 | BP of main.main ----------------------------- BP +20 | \u0026int 1 y1 ----------------------------- +18 | \u0026funcval y ----------------------------- +10 | \u0026funcval ----------------------------- +08 | ----------------------------- +00 | ----------------------------- SP è‡ªå·±æ•è·è‡ªå·± 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 package main func main() { x()() } //go:noinline func x() (y func()) { // struct { F uintptr } y = func() { //println(\"y\") } // deferåœ¨returnèµ‹å€¼å®Œæˆä¹‹åæ‰§è¡Œ //defer func() { //\ty = func() { // fmt.Println(\"æˆ‘èƒ½æ”¹å˜äº†Yçš„å€¼ï¼Ÿ\") //\t} //}() // struct { F uintptr; y *func() } return func() { //println(\"z\") y() } } main æ±‡ç¼–ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func main() { 0x4551e0 493b6610 CMPQ 0x10(R14), SP 0x4551e4 7629 JBE 0x45520f 0x4551e6 4883ec10 SUBQ $0x10, SP 0x4551ea 48896c2408 MOVQ BP, 0x8(SP) 0x4551ef 488d6c2408 LEAQ 0x8(SP), BP x()() 0x4551f4 e847000000 CALL main.x(SB) # AX=\u0026funcval 0x4551f9 48890424 MOVQ AX, 0(SP) 0x4551fd 488b08 MOVQ 0(AX), CX # CX=funcval.fn 0x455200 4889c2 MOVQ AX, DX # DX=\u0026funcval 0x455203 ffd1 CALL CX } 0x455205 488b6c2408 MOVQ 0x8(SP), BP 0x45520a 4883c410 ADDQ $0x10, SP 0x45520e c3 RET func main() { 0x45520f e84ccdffff CALL runtime.morestack_noctxt.abi0(SB) 0x455214 ebca JMP main.main(SB) x æ±‡ç¼–ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 func x() (y func()) { 0x455240 493b6610 CMPQ 0x10(R14), SP 0x455244 0f86bf000000 JBE 0x455309 0x45524a 4883ec28 SUBQ $0x28, SP 0x45524e 48896c2420 MOVQ BP, 0x20(SP) 0x455253 488d6c2420 LEAQ 0x20(SP), BP # func() å˜é‡y 0x455258 488d05e1480000 LEAQ 0x48e1(IP), AX # AX=0x48e1(IP)ï¼Œfuncvalå…ƒç±»å‹ 0x45525f 90 NOPL 0x455260 e8db5cfbff CALL runtime.newobject(SB) # AX=\u0026funcval 0x455265 4889442418 MOVQ AX, 0x18(SP) y = func() { 0x45526a 833def1f090000 CMPL $0x0, runtime.writeBarrier(SB) 0x455271 7402 JE 0x455275 0x455273 eb0d JMP 0x455282 # funcval.fn -\u003e println(\"y\") æ›¿æ¢ y 0x455275 488d0d841d0100 LEAQ 0x11d84(IP), CX # CX=0x11d84(IP)ï¼Œå‡½æ•°ä»£ç å¤„ 0x45527c 488908 MOVQ CX, 0(AX) # funcval.fn=0x11d84(IP) 0x45527f 90 NOPL 0x455280 eb11 JMP 0x455293 0x455282 4889c7 MOVQ AX, DI 0x455285 488d0d741d0100 LEAQ 0x11d74(IP), CX 0x45528c e88fd0ffff CALL runtime.gcWriteBarrierCX(SB) 0x455291 eb00 JMP 0x455293 return func() { # struct { F uintptr; y *func() } 0x455293 488d0586740000 LEAQ 0x7486(IP), AX # AX=0x7486(IP)ï¼Œfuncvalå…ƒç±»å‹ 16B 0x45529a e8a15cfbff CALL runtime.newobject(SB) # AX=\u0026funcval.1 0x45529f 4889442410 MOVQ AX, 0x10(SP) 0x4552a4 488d0d75000000 LEAQ main.x.func2(SB), CX # CX=main.x.func2 0x4552ab 488908 MOVQ CX, 0(AX) # funcval.1.fn=main.x.func2 0x4552ae 488b4c2410 MOVQ 0x10(SP), CX # CX=\u0026funcval.1 0x4552b3 8401 TESTB AL, 0(CX) 0x4552b5 488b542418 MOVQ 0x18(SP), DX # DX=\u0026funcval 0x4552ba 488d7908 LEAQ 0x8(CX), DI # DI=funcval.1.data 0x4552be 833d9b1f090000 CMPL $0x0, runtime.writeBarrier(SB) 0x4552c5 7402 JE 0x4552c9 0x4552c7 eb06 JMP 0x4552cf 0x4552c9 48895108 MOVQ DX, 0x8(CX) # funcval.1.data=\u0026funcval 0x4552cd eb07 JMP 0x4552d6 0x4552cf e86cd0ffff CALL runtime.gcWriteBarrierDX(SB) 0x4552d4 eb00 JMP 0x4552d6 0x4552d6 488b7c2418 MOVQ 0x18(SP), DI # DI=\u0026funcval 0x4552db 488b4c2410 MOVQ 0x10(SP), CX # CX=\u0026funcval.1 0x4552e0 833d791f090000 CMPL $0x0, runtime.writeBarrier(SB) 0x4552e7 7402 JE 0x4552eb 0x4552e9 eb05 JMP 0x4552f0 0x4552eb 48890f MOVQ CX, 0(DI) # funcval.fn=\u0026funcval.1 0x4552ee eb07 JMP 0x4552f7 0x4552f0 e82bd0ffff CALL runtime.gcWriteBarrierCX(SB) 0x4552f5 eb00 JMP 0x4552f7 0x4552f7 488b4c2418 MOVQ 0x18(SP), CX # CX=\u0026funcval 0x4552fc 488b01 MOVQ 0(CX), AX # AX=funcval.fn 0x4552ff 488b6c2420 MOVQ 0x20(SP), BP 0x455304 4883c428 ADDQ $0x28, SP 0x455308 c3 RET func x() (y func()) { 0x455309 e852ccffff CALL runtime.morestack_noctxt.abi0(SB) 0x45530e e92dffffff JMP main.x(SB) unsafe Goè¯­è¨€é‡ŒFunction Valueæœ¬è´¨ä¸Šæ˜¯æŒ‡å‘funcvalç»“æ„ä½“çš„æŒ‡é’ˆ Goè¯­è¨€é‡Œé—­åŒ…åªæ˜¯æ‹¥æœ‰æ•è·åˆ—è¡¨çš„Function Value æ•è·å˜é‡åœ¨å¤–å±‚å‡½æ•°ä¸é—­åŒ…å‡½æ•°ä¸­è¦ä¿æŒä¸€è‡´ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 package main import ( \"fmt\" \"unsafe\" ) type fv struct { fn unsafe.Pointer i *int // æ•è·çš„å˜é‡i } func main() { g := callback() fn := **(**fv)(unsafe.Pointer(\u0026g)) fmt.Printf(\"%#v\\n\", fn) fmt.Println(*(fn.i)) // 13 // Output: // main.fv{fn:(unsafe.Pointer)(0xeccdc0), i:(*int)(0xc00000a098)} // 13 // å¯ä»¥çœ‹å‡ºæ•è·çš„æ˜¯içš„åœ°å€ } func callback() func() { i := 13 // struct { F uintptr; i *int } return func() { i++ } } å‚è€ƒ æœ¬ç¯‡æ–‡ç« å‚è€ƒäº†ã€Šæ·±åº¦æ¢ç´¢Goè¯­è¨€ã€‹ä¹¦å†…å®¹ã€‚ å‚è€ƒ https://mp.weixin.qq.com/s/hO0S4WcG0hUzCmMNMKtS-gã€‚ ",
  "wordCount" : "6764",
  "inLanguage": "zh",
  "image": "https://heliu.site/favicon-32x32.png","datePublished": "2024-08-03T00:00:00Z",
  "dateModified": "2024-08-03T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://heliu.site/posts/golang/func/value/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://heliu.site/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://heliu.site/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://heliu.site/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://heliu.site/" title="ä¸»é¡µ">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/posts" title="æ–‡ç« ">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/archives" title="æ—¶é—´è½´">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/tags/" title="æ ‡ç­¾">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/search/" title="æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/support" title="æ‰“èµ">
                    <span>ğŸ«¶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://heliu.site/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/">Article</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/golang/">Golang åˆé›†</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/golang/func/">ç¬¬9ç«  Function</a></div>
    <h1 class="post-title entry-hint-parent">
      Function Value
    </h1>
    <div class="post-description">
      ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬
    </div>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2024-08-03</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2024-08-03</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>6764å­—</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>32åˆ†é’Ÿ</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &nbsp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://heliu.site/tags/golang/" target="_blank" rel="noopener">Golang</a>
            <a href="https://heliu.site/tags/%E5%87%BD%E6%95%B0/" target="_blank" rel="noopener">å‡½æ•°</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &nbsp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%87%bd%e6%95%b0%e6%8c%87%e9%92%88" aria-label="å‡½æ•°æŒ‡é’ˆ">å‡½æ•°æŒ‡é’ˆ</a></li>
                    <li>
                        <a href="#function-value-%e5%88%86%e6%9e%90" aria-label="Function Value åˆ†æ">Function Value åˆ†æ</a></li>
                    <li>
                        <a href="#%e9%97%ad%e5%8c%85" aria-label="é—­åŒ…">é—­åŒ…</a><ul>
                            
                    <li>
                        <a href="#%e9%97%ad%e5%8c%85%e5%af%b9%e8%b1%a1" aria-label="é—­åŒ…å¯¹è±¡">é—­åŒ…å¯¹è±¡</a></li>
                    <li>
                        <a href="#%e7%9c%8b%e5%88%b0%e9%97%ad%e5%8c%85" aria-label="çœ‹åˆ°é—­åŒ…">çœ‹åˆ°é—­åŒ…</a></li>
                    <li>
                        <a href="#%e8%b0%83%e7%94%a8%e9%97%ad%e5%8c%85" aria-label="è°ƒç”¨é—­åŒ…">è°ƒç”¨é—­åŒ…</a></li>
                    <li>
                        <a href="#%e9%97%ad%e5%8c%85%e4%b8%8e%e5%8f%98%e9%87%8f%e9%80%83%e9%80%b8" aria-label="é—­åŒ…ä¸å˜é‡é€ƒé€¸">é—­åŒ…ä¸å˜é‡é€ƒé€¸</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%87%bd%e6%95%b0" aria-label="å‡½æ•°">å‡½æ•°</a></li>
                    <li>
                        <a href="#%e9%97%ad%e5%8c%85-1" aria-label="é—­åŒ…">é—­åŒ…</a></li>
                    <li>
                        <a href="#%e8%b0%83%e7%94%a8" aria-label="è°ƒç”¨">è°ƒç”¨</a></li>
                    <li>
                        <a href="#%e9%9d%99%e6%80%81%e5%88%86%e9%85%8d" aria-label="é™æ€åˆ†é…">é™æ€åˆ†é…</a></li>
                    <li>
                        <a href="#%e6%8d%95%e8%8e%b7%e5%88%97%e8%a1%a8" aria-label="æ•è·åˆ—è¡¨">æ•è·åˆ—è¡¨</a><ul>
                            
                    <li>
                        <a href="#%e6%8d%95%e8%8e%b7%e5%b1%80%e9%83%a8%e5%8f%98%e9%87%8f" aria-label="æ•è·å±€éƒ¨å˜é‡">æ•è·å±€éƒ¨å˜é‡</a></li>
                    <li>
                        <a href="#%e6%8d%95%e8%8e%b7%e5%8f%82%e6%95%b0" aria-label="æ•è·å‚æ•°">æ•è·å‚æ•°</a></li>
                    <li>
                        <a href="#%e6%8d%95%e8%8e%b7%e8%bf%94%e5%9b%9e%e5%80%bc" aria-label="æ•è·è¿”å›å€¼">æ•è·è¿”å›å€¼</a></li></ul>
                    </li>
                    <li>
                        <a href="#unsafe" aria-label="unsafe">unsafe</a></li>
                    <li>
                        <a href="#%e5%8f%82%e8%80%83" aria-label="å‚è€ƒ">å‚è€ƒ</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><ol>
<li>å‡½æ•°åœ¨ Go è¯­è¨€ä¸­å±äºç¬¬ä¸€ç±»å€¼(First Class Value)ï¼Œè¯¥ç±»å‹çš„å€¼å¯ä»¥ä½œä¸ºå‡½æ•°çš„<strong>å‚æ•°</strong>å’Œ<strong>è¿”å›å€¼</strong>ï¼Œä¹Ÿå¯ä»¥èµ‹ç»™<strong>å˜é‡</strong>ã€‚</li>
<li>å½“æŠŠä¸€ä¸ªå‡½æ•°èµ‹å€¼ç»™æŸä¸ªå˜é‡åï¼Œè¿™ä¸ªå˜é‡å°±è¢«ç§°ä¸º Function Valueã€‚</li>
<li>å£°æ˜ä¸€ä¸ª Function Value å˜é‡çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">fn</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span>
</span></span></code></pre></div><ol start="4">
<li>å…¶ä¸­ <code>fn</code> å°±æ˜¯ä¸ª Function Value å˜é‡ï¼Œå®ƒçš„ç±»å‹æ˜¯ func(int, int) intã€‚</li>
<li>Function Value å¯ä»¥åƒä¸€èˆ¬å‡½æ•°é‚£æ ·è¢«è°ƒç”¨ï¼Œåœ¨ä½¿ç”¨ä½“éªŒä¸Šéå¸¸ç±»ä¼¼äº C è¯­è¨€ä¸­çš„å‡½æ•°æŒ‡é’ˆã€‚</li>
<li>Function Value æœ¬è´¨ä¸Šæ˜¯ä¸æ˜¯å‡½æ•°æŒ‡é’ˆå‘¢ï¼Ÿ</li>
<li>æœ¬èŠ‚ä¼šåˆ†æ Function Value å’Œå‡½æ•°æŒ‡é’ˆçš„å®ç°åŸç†ï¼Œè¿˜æœ‰é—­åŒ…çš„å®ç°åŸç†ï¼Œä»¥åŠ Function Value æ˜¯å¦‚ä½•æ”¯æŒé—­åŒ…çš„ã€‚</li>
</ol>
<h2 id="å‡½æ•°æŒ‡é’ˆ">å‡½æ•°æŒ‡é’ˆ<a hidden class="anchor" aria-hidden="true" href="#å‡½æ•°æŒ‡é’ˆ">#</a></h2>
<ol>
<li>ç†Ÿæ‚‰ C è¯­è¨€çš„è¯»è€…åº”è¯¥æœ‰è¿‡ä½¿ç”¨å‡½æ•°æŒ‡é’ˆçš„ç»éªŒï¼Œå‡½æ•°æŒ‡é’ˆå­˜å‚¨çš„éƒ½æ˜¯åœ°å€ï¼Œåªä¸è¿‡ä¸æ˜¯æŒ‡å‘æŸç§ç±»å‹çš„æ•°æ®ã€‚</li>
<li>è€Œæ˜¯æŒ‡å‘ä»£ç æ®µä¸­æŸä¸ªå‡½æ•°çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</li>
</ol>
<p><img loading="lazy" src="../images/func-001.png" alt=""  />
</p>
<h2 id="function-value-åˆ†æ">Function Value åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#function-value-åˆ†æ">#</a></h2>
<ol>
<li>å‡†å¤‡ä¸€ä¸ª <code>go</code> æ–‡ä»¶å¹¶å†™å…¥ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">println</span><span class="p">(</span><span class="nf">helper</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">helper</span><span class="p">(</span><span class="nx">fn</span> <span class="kd">func</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">fn</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>ä¾ç„¶æŠŠ Function Value çš„è°ƒç”¨éš”ç¦»åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œä»¥ä¾¿äºåˆ†æã€‚<code>main.helper</code>åç¼–è¯‘ä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">go</span> <span class="no">build</span> <span class="p">-</span><span class="no">gcflags</span><span class="err">=&#34;</span><span class="p">-</span><span class="no">N</span> <span class="p">-</span><span class="no">l</span><span class="err">&#34;</span> <span class="p">-</span><span class="no">o</span> <span class="p">.</span><span class="err">/</span><span class="no">h1</span> <span class="no">myzx.cn</span><span class="err">/</span><span class="no">helium</span>
</span></span><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">go</span> <span class="no">tool</span> <span class="no">objdump</span> <span class="p">-</span><span class="no">S</span> <span class="p">-</span><span class="no">s</span> <span class="err">&#39;^</span><span class="no">main.helper$</span><span class="err">&#39;</span> <span class="p">.</span><span class="err">/</span><span class="no">h1</span> 
</span></span><span class="line"><span class="cl"><span class="no">TEXT</span> <span class="no">main.helper</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">helper</span><span class="p">(</span><span class="no">fn</span> <span class="no">func</span><span class="p">(</span><span class="no">int</span><span class="p">,</span> <span class="no">int</span><span class="p">)</span> <span class="no">int</span><span class="p">,</span> <span class="no">a</span><span class="p">,</span> <span class="no">b</span> <span class="no">int</span><span class="p">)</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455240</span>      <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>  <span class="c1"># æ ˆå¢é•¿åˆ¤æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455244</span>      <span class="mi">7650</span>                <span class="no">JBE</span> <span class="mi">0x455296</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455246</span>      <span class="mi">4883</span><span class="no">ec28</span>            <span class="no">SUBQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45524a</span>      <span class="mi">48896</span><span class="no">c2420</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45524f</span>      <span class="mi">488</span><span class="no">d6c2420</span>          <span class="no">LEAQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455254</span>      <span class="mi">4889442430</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455259</span>      <span class="mi">48895</span><span class="no">c2438</span>          <span class="no">MOVQ</span> <span class="no">BX</span><span class="p">,</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45525e</span>      <span class="mi">48894</span><span class="no">c2440</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x40</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455263</span>      <span class="mi">48</span><span class="no">c744241000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span> <span class="c1"># return int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">return</span> <span class="no">fn</span><span class="p">(</span><span class="no">a</span><span class="p">,</span> <span class="no">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45526c</span>      <span class="mi">488</span><span class="no">b442438</span>          <span class="no">MOVQ</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>   <span class="c1"># AX=a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455271</span>      <span class="mi">488</span><span class="no">b5c2440</span>          <span class="no">MOVQ</span> <span class="mi">0x40</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BX</span>   <span class="c1"># BX=b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455276</span>      <span class="mi">488</span><span class="no">b542430</span>          <span class="no">MOVQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>   <span class="c1"># DX=fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># è¿™é‡Œçœ‹å‡º Function Value æ˜¯ä¸€ä¸ªäºŒçº§æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45527b</span>      <span class="mi">488</span><span class="no">b0a</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">CX</span>      <span class="c1"># CX=fn.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45527e</span>      <span class="mi">6690</span>                <span class="no">NOPW</span>            
</span></span><span class="line"><span class="cl">  <span class="c1"># DX å¯„å­˜å™¨å­˜å‚¨çš„æ˜¯ fnï¼Œä¹Ÿå°±æ˜¯ä¸Šä¸‹æ–‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># CALL CX; æŒ‡ä»¤è¯´æ˜ï¼ŒCXå¯„å­˜å™¨æœ€ç»ˆå­˜å‚¨çš„æ˜¯å®é™…å‡½æ•°çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455280</span>      <span class="no">ffd1</span>                <span class="no">CALL</span> <span class="no">CX</span>             <span class="c1"># CALL fn.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455282</span>      <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455287</span>      <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45528c</span>      <span class="mi">488</span><span class="no">b6c2420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455291</span>      <span class="mi">4883</span><span class="no">c428</span>            <span class="no">ADDQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455295</span>      <span class="no">c3</span>                  <span class="no">RET</span>            
</span></span><span class="line"><span class="cl"><span class="no">func</span> <span class="no">helper</span><span class="p">(</span><span class="no">fn</span> <span class="no">func</span><span class="p">(</span><span class="no">int</span><span class="p">,</span> <span class="no">int</span><span class="p">)</span> <span class="no">int</span><span class="p">,</span> <span class="no">a</span><span class="p">,</span> <span class="no">b</span> <span class="no">int</span><span class="p">)</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455296</span>      <span class="mi">4889442408</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x45529b</span>      <span class="mi">48895</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">BX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552a0</span>      <span class="mi">48894</span><span class="no">c2418</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552a5</span>      <span class="no">e8b6ccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552aa</span>      <span class="mi">488</span><span class="no">b442408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552af</span>      <span class="mi">488</span><span class="no">b5c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BX</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552b4</span>      <span class="mi">488</span><span class="no">b4c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552b9</span>      <span class="no">eb85</span>                <span class="no">JMP</span> <span class="no">main.helper</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>é€šè¿‡ä¸Šè¿°é€»è¾‘ï¼Œå¯ä»¥ç¡®å®šFunction Valueç¡®å®æ˜¯ä¸ªæŒ‡é’ˆï¼Œè€Œä¸”æ˜¯ä¸ª<strong>ä¸¤çº§æŒ‡é’ˆ</strong>ã€‚</li>
<li>å¦‚å›¾æ‰€ç¤ºï¼ŒFunction Value ä¸ç›´æ¥æŒ‡å‘ç›®æ ‡å‡½æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ªç›®æ ‡å‡½æ•°çš„æŒ‡é’ˆã€‚</li>
</ol>
<p><img loading="lazy" src="../images/func-002.png" alt=""  />
</p>
<h2 id="é—­åŒ…">é—­åŒ…<a hidden class="anchor" aria-hidden="true" href="#é—­åŒ…">#</a></h2>
<ol>
<li>è¯´åˆ°<code>Go</code>è¯­è¨€çš„é—­åŒ…ï¼Œæ¯”è¾ƒç›´è§‚çš„æ„Ÿå—å°±æ˜¯ä¸ªæœ‰çŠ¶æ€çš„ Function Valueã€‚</li>
<li>åœ¨<code>Go</code>è¯­è¨€ä¸­æ¯”è¾ƒå…¸å‹çš„é—­åŒ…åœºæ™¯å°±æ˜¯åœ¨æŸä¸ªå‡½æ•°å†…å®šä¹‰äº†å¦ä¸€ä¸ªå‡½æ•°ï¼Œå†…å±‚å‡½æ•°ä½¿ç”¨äº†å¤–å±‚å‡½æ•°çš„å±€éƒ¨å˜é‡ï¼Œå¹¶ä¸”å†…å±‚å‡½æ•°æœ€ç»ˆè¢«å¤–å±‚å‡½æ•°ä½œä¸ºè¿”å›å€¼è¿”å›ã€‚</li>
<li>ä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mc</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>æ¯æ¬¡è°ƒç”¨ <code>mc()</code> å‡½æ•°éƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„é—­åŒ…ï¼Œé—­åŒ…è®°ä½äº†å‚æ•°çš„å€¼ï¼Œæ‰€ä»¥æ˜¯æœ‰çŠ¶æ€çš„ã€‚</li>
<li>åŸºäºç›®å‰å¯¹å‡½æ•°æ ˆå¸§çš„äº†è§£ï¼Œå‡½æ•°æ ˆå¸§éšç€å‡½æ•°è¿”å›è€Œé”€æ¯ï¼Œä¸èƒ½ç”¨æ¥ä¿å­˜çŠ¶æ€ã€‚</li>
<li>ç ”ç©¶å‡½æ•°æŒ‡é’ˆå’Œ Function Value çš„æ—¶å€™ä¹Ÿæ²¡æœ‰å‘ç°å“ªé‡Œç”¨æ¥ä¿å­˜çŠ¶æ€ï¼Œæ‰€ä»¥è¿™é‡Œå°±æœ‰ä¸ªé—®é¢˜ï¼Œé—­åŒ…çš„çŠ¶æ€ä¿å­˜åœ¨å“ªé‡Œå‘¢ï¼Ÿ</li>
</ol>
<h3 id="é—­åŒ…å¯¹è±¡">é—­åŒ…å¯¹è±¡<a hidden class="anchor" aria-hidden="true" href="#é—­åŒ…å¯¹è±¡">#</a></h3>
<ol>
<li>ä¸ºäº†æ‘˜æ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œå…ˆæ¥å°è¯•ä¸€ä¸‹åç¼–è¯‘ï¼Œä»æ±‡ç¼–ä»£ç ä¸­æ‰¾ç­”æ¡ˆï¼Œ<code>main.mc</code>åç¼–è¯‘ä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">go</span> <span class="no">build</span> <span class="p">-</span><span class="no">gcflags</span><span class="err">=&#34;</span><span class="p">-</span><span class="no">N</span> <span class="p">-</span><span class="no">l</span><span class="err">&#34;</span> <span class="p">-</span><span class="no">o</span> <span class="p">.</span><span class="err">/</span><span class="no">h1</span> <span class="no">myzx.cn</span><span class="err">/</span><span class="no">helium</span>
</span></span><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">go</span> <span class="no">tool</span> <span class="no">objdump</span> <span class="p">-</span><span class="no">S</span> <span class="p">-</span><span class="no">s</span> <span class="err">&#39;^</span><span class="no">main.mc$</span><span class="err">&#39;</span> <span class="p">.</span><span class="err">/</span><span class="no">h1</span> 
</span></span><span class="line"><span class="cl"><span class="no">TEXT</span> <span class="no">main.mc</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">mc</span><span class="p">(</span><span class="no">n</span> <span class="no">int</span><span class="p">)</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>      <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>  <span class="c1"># æ ˆå¢é•¿åˆ¤æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455224</span>      <span class="mi">765</span><span class="no">b</span>                <span class="no">JBE</span> <span class="mi">0x455281</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455226</span>      <span class="mi">4883</span><span class="no">ec28</span>            <span class="no">SUBQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45522a</span>      <span class="mi">48896</span><span class="no">c2420</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45522f</span>      <span class="mi">488</span><span class="no">d6c2420</span>          <span class="no">LEAQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="c1"># å‚æ•°æ ˆç©ºé—´åˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455234</span>      <span class="mi">4889442430</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># è¿”å›å€¼æ ˆç©ºé—´åˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455239</span>      <span class="mi">48</span><span class="no">c744241000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span> <span class="c1"># return func() int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 0x7497(IP) æ˜¯ Function Value çš„ç»“æ„å…ƒç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># type funcval struct {fn unsafe.Pointer, n int}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455242</span>      <span class="mi">488</span><span class="no">d0597740000</span>      <span class="no">LEAQ</span> <span class="mi">0x7497</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span> <span class="c1"># Function Value ç»“æ„çš„å…ƒç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># åˆ›å»º funcval ç»“æ„éœ€è¦çš„å†…å­˜ç©ºé—´ï¼Œæ˜¯å †åˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455249</span>      <span class="no">e8f25cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45524e</span>      <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">  <span class="c1"># è¿™é‡Œmain.mc.func1(SB)æ˜¯mcè¿”å›çš„é—­åŒ…åœ¨ä»£ç æ®µçš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455253</span>      <span class="mi">488</span><span class="no">d0d46000000</span>      <span class="no">LEAQ</span> <span class="no">main.mc.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">CX</span>  <span class="c1"># CX=main.mc.func1(SB)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45525a</span>      <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>              <span class="c1"># funcval.fn=main.mc.func1(SB)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45525d</span>      <span class="mi">488</span><span class="no">b4c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455262</span>      <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x455264</span>      <span class="mi">488</span><span class="no">b542430</span>          <span class="no">MOVQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>           <span class="c1"># DX=n    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># å¯ä»¥çœ‹å‡ºè¿™é‡Œæ•è·äº†å˜é‡nï¼Œå¹¶ä¸”æ˜¯æ‹·è´æ•è·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455269</span>      <span class="mi">48895108</span>            <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>            <span class="c1"># funcval.n = n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45526d</span>      <span class="mi">488</span><span class="no">b442418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>           <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455272</span>      <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455277</span>      <span class="mi">488</span><span class="no">b6c2420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45527c</span>      <span class="mi">4883</span><span class="no">c428</span>            <span class="no">ADDQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x455280</span>      <span class="no">c3</span>                  <span class="no">RET</span>                
</span></span><span class="line"><span class="cl"><span class="no">func</span> <span class="no">mc</span><span class="p">(</span><span class="no">n</span> <span class="no">int</span><span class="p">)</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455281</span>      <span class="mi">4889442408</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x455286</span>      <span class="no">e8d5ccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45528b</span>      <span class="mi">488</span><span class="no">b442408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x455290</span>      <span class="no">eb8e</span>                <span class="no">JMP</span> <span class="no">main.mc</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>æ ¹æ®ä¸Šé¢ä»£ç å¯ä»¥æ¨æ–­å‡ºFunction ValueåŠ¨æ€åˆ†é…çš„å¯¹è±¡çš„ç±»å‹ã€‚</li>
<li>åº”è¯¥æ˜¯ä¸€ä¸ª struct ç±»å‹ï¼Œ<strong>ç¬¬1ä¸ªå­—æ®µæ˜¯å‡½æ•°åœ°å€</strong>ï¼Œ<strong>ç¬¬2ä¸ªå­—æ®µæ˜¯ int ç±»å‹</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">F</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">n</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>è¯´æ˜ç¼–è¯‘å™¨è¯†åˆ«å‡ºäº†é—­åŒ…è¿™ç§ä»£ç æ¨¡å¼ï¼Œå¹¶ä¸”è‡ªåŠ¨å®šä¹‰äº†è¿™ä¸ª struct ç±»å‹è¿›è¡Œæ”¯æŒï¼Œå‡ºäºé¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­æŠŠæ•°æ®ç§°ä¸ºå¯¹è±¡çš„ä¹ æƒ¯ï¼Œåæ–‡ä¸­å°±æŠŠè¿™ç§ struct ç§°ä¸ºé—­åŒ…å¯¹è±¡ã€‚</li>
<li>é—­åŒ…å¯¹è±¡çš„æˆå‘˜å¯ä»¥è¿›ä¸€æ­¥åˆ’åˆ†ï¼Œ<strong>ç¬¬1ä¸ªå­—æ®µFç”¨æ¥å­˜å‚¨ç›®æ ‡å‡½æ•°çš„åœ°å€</strong>ï¼Œè¿™åœ¨æ‰€æœ‰çš„é—­åŒ…å¯¹è±¡ä¸­éƒ½æ˜¯ä¸€è‡´çš„ï¼Œåæ–‡ä¸­å°†è¿™ä¸ªç›®æ ‡å‡½æ•°ç§°ä¸ºé—­åŒ…å‡½æ•°ã€‚</li>
<li>ä»ç¬¬2ä¸ªå­—æ®µå¼€å§‹ï¼Œåç»­çš„å­—æ®µç§°ä¸ºé—­åŒ…çš„<strong>æ•è·åˆ—è¡¨</strong>ï¼Œä¹Ÿå°±æ˜¯å†…å±‚å‡½æ•°ä¸­ç”¨åˆ°çš„æ‰€æœ‰å®šä¹‰åœ¨å¤–å±‚å‡½æ•°ä¸­çš„å˜é‡ã€‚</li>
<li>ç¼–è¯‘å™¨è®¤ä¸ºè¿™äº›å˜é‡è¢«é—­åŒ…æ•è·äº†ï¼Œä¼šæŠŠå®ƒä»¬<strong>è¿½åŠ </strong>åˆ°é—­åŒ…å¯¹è±¡çš„ struct å®šä¹‰ä¸­ã€‚</li>
<li>ä¸Šä¾‹ä¸­åªæ•è·äº†ä¸€ä¸ªå˜é‡ <code>n</code>ï¼Œå¦‚æœæ•è·çš„å˜é‡å¢å¤šï¼Œstruct çš„æ•è·åˆ—è¡¨ä¹Ÿä¼šåŠ é•¿ã€‚</li>
<li>ä¸€ä¸ªæ•è·ä¸¤ä¸ªå˜é‡çš„é—­åŒ…ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mc</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">m</span> <span class="kt">int</span><span class="p">)</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">m</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="10">
<li>ä¸Šè¿°ä»£ç å¯¹åº”çš„é—­åŒ…å¯¹è±¡å®šä¹‰ä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">F</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">n</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">m</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="çœ‹åˆ°é—­åŒ…">çœ‹åˆ°é—­åŒ…<a hidden class="anchor" aria-hidden="true" href="#çœ‹åˆ°é—­åŒ…">#</a></h3>
<ol>
<li>é€šè¿‡åç¼–è¯‘æ¥é€†å‘æ¨æ–­é—­åŒ…å¯¹è±¡çš„ç»“æ„è¿˜æ˜¯æ¯”è¾ƒçƒ¦ççš„ï¼Œå¦‚æœèƒ½æœ‰ä¸€ç§æ–¹æ³•ï¼Œèƒ½å¤Ÿç›´è§‚çœ‹åˆ°é—­åŒ…å¯¹è±¡çš„ç»“æ„å®šä¹‰ï¼Œé‚£çœŸæ˜¯å†å¥½ä¸è¿‡äº†ã€‚</li>
<li>æ ¹æ®ä¹‹å‰çš„æ¢ç´¢ï¼Œå·²ç»çŸ¥é“ <code>Go</code> åºåœ¨è¿è¡Œé˜¶æ®µä¼šé€šè¿‡ <code>runtime.newobject()</code> å‡½æ•°åŠ¨æ€åŒ¹é…é—­åŒ…å¯¹è±¡ã€‚</li>
<li><code>Go</code> æºç ä¸­ <code>newobject()</code> å‡½æ•°çš„åŸå‹å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newobject</span><span class="p">(</span><span class="nx">typ</span> <span class="o">*</span><span class="nx">_type</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span></code></pre></div><ol start="4">
<li>å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸ªæŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯æ–°åˆ†é…çš„å¯¹è±¡çš„åœ°å€ï¼Œå‚æ•°æ˜¯ä¸ª <code>_type</code> ç±»å‹çš„æŒ‡é’ˆã€‚</li>
<li>é€šè¿‡æºç å¯ä»¥å¾—çŸ¥è¿™ä¸ª <code>_type</code> æ˜¯ä¸ª <code>struct</code>ï¼Œåœ¨ <code>Go</code> è¯­è¨€çš„ <code>runtime</code> åŒ…ä¸­è¢«ç”¨æ¥æè¿°ä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œé€šè¿‡å®ƒå¯ä»¥æ‰¾åˆ°ç›®æ ‡æ•°æ®ç±»å‹çš„å¤§å°ï¼Œå¯¹é½è¾¹ç•Œï¼Œç±»å‹åç§°ç­‰ã€‚</li>
<li>å‡å¦‚èƒ½å¤Ÿè·å¾—ä¼ é€’ç»™ <code>runtime.newobjet()</code> å‡½æ•°çš„ç±»å‹å…ƒæ•°æ®æŒ‡é’ˆ <code>typ</code>ï¼Œå†é€šè¿‡åå°„è¿›è¡Œè§£æï¼Œå°±èƒ½æ‰“å°å‡ºé—­åŒ…å¯¹è±¡çš„ç»“æ„å®šä¹‰äº†ã€‚é‚£å¦‚ä½•æ‰èƒ½è·å¾—è¿™ä¸ª <code>typ</code> å‚æ•°å‘¢ï¼Ÿ</li>
<li>åœ¨<code>C</code>è¯­è¨€ä¸­æœ‰ç§å¸¸ç”¨çš„å‡½æ•° Hook æŠ€æœ¯ï¼Œå°±æ˜¯åœ¨è¿è¡Œé˜¶æ®µå°†ç›®æ ‡å‡½æ•°å¤´éƒ¨çš„ä»£ç æ›¿æ¢ä¸ºä¸€æ¡è·³è½¬æŒ‡ä»¤ï¼Œè·³è½¬åˆ°ä¸€ä¸ªæ–°çš„å‡½æ•°ã€‚</li>
<li>åœ¨ x86 å¹³å°ä¸Šå°±æ˜¯åœ¨è¿›ç¨‹åœ°å€ç©ºé—´ä¸­æ‰¾åˆ°è¦ Hook çš„å‡½æ•°ï¼Œå°†å…¶å¤´éƒ¨æ›¿æ¢ä¸ºä¸€æ¡ JMP æŒ‡ä»¤ï¼ŒåŒæ—¶æŒ‡å®š JMP æŒ‡ä»¤è¦è·³è½¬åˆ°çš„æ–°å‡½æ•°çš„åœ°å€ã€‚</li>
<li>è¿™é¡¹æŠ€æœ¯åœ¨ Go ç¨‹åºä¸­ä¾ç„¶é€‚ç”¨ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªè‡ªå·±å®ç°çš„å‡½æ•°æ¢æ‰ <code>runtime.newobject()</code> å‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­å°±èƒ½è·å¾— typ å‚æ•°å¹¶è¿›è¡Œè§£æäº†ã€‚</li>
<li>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ <code>runtime.newobiect()</code> å‡½æ•°å±äºæœªå¯¼å‡ºçš„å‡½æ•°ï¼Œåœ¨<code>runtime</code>åŒ…å¤–æ— æ³•è®¿é—®ã€‚</li>
<li>è¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡ <code>linkname</code> æœºåˆ¶æ¥ç»•è¿‡ï¼Œåœ¨å½“å‰åŒ…ä¸­å£°æ˜ä¸€ä¸ªç±»ä¼¼çš„å‡½æ•°ï¼Œè®©é“¾æ¥å™¨å°†å…¶é“¾æ¥åˆ°<code>runtime.newobject()</code>å‡½æ•°å³å¯ã€‚</li>
<li>æœ¬ä¹¦ä½¿ç”¨å¼€æºæ¨¡å— <code>github.com/fengyoulin/hookingo</code> å®ç°è¿è¡Œé˜¶æ®µå‡½æ•°æ›¿æ¢ï¼Œæ‰“å°é—­åŒ…å¯¹è±¡ç»“æ„çš„å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/fengyoulin/hookingo&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;reflect&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;unsafe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">hno</span> <span class="nx">hookingo</span><span class="p">.</span><span class="nx">Hook</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:linkname newobject runtime.newobject
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newobject</span><span class="p">(</span><span class="nx">typ</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:linkname newobject2 runtime.mallocgc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newobject2</span><span class="p">(</span><span class="nx">size</span> <span class="kt">uintptr</span><span class="p">,</span> <span class="nx">typ</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">bool</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">fno</span><span class="p">(</span><span class="nx">typ</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">t</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">// type Type interface{}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œä¸ºä»€ä¹ˆèµ‹å€¼çš„æ˜¯ä¸‹æ ‡1ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸ºä»€ä¹ˆæ˜¯1è€Œä¸æ˜¯0ä¸‹æ ‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ ¹æ®åé¢åˆ†æç¡®å®æ˜¯ä¿®æ”¹ä¸‹æ ‡1ï¼Œå› ä¸ºt.String()éœ€è¦ç”¨åˆ°1è¿™ä¸ªä¸‹æ ‡çš„æ•°æ®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">t</span><span class="p">)))[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="nx">typ</span> <span class="c1">// ç›¸å½“äºåå°„äº†é—­åŒ…ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nb">println</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//fn, ok := hno.Origin().(func(typ unsafe.Pointer) unsafe.Pointer)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//if ok {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    return fn(typ) // è°ƒç”¨åŸruntime.newobject
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//println(&#34;ok&#34;, ok)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//os.Exit(1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nb">println</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">uintptr</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">typ</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">newobject2</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">uintptr</span><span class="p">)(</span><span class="nx">typ</span><span class="p">),</span> <span class="nx">typ</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// åˆ›å»ºä¸€ä¸ªé—­åŒ…ï¼Œmake closure
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mc</span><span class="p">(</span><span class="nx">start</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">text</span> <span class="kt">string</span><span class="p">)</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿™é‡Œ start éœ€è¦å †åˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// func() string ä¹Ÿéœ€è¦å †åˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">l</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">s</span> <span class="o">:=</span> <span class="nx">start</span> <span class="o">%</span> <span class="nx">l</span>
</span></span><span class="line"><span class="cl">        <span class="nx">r</span> <span class="o">:=</span> <span class="nx">text</span><span class="p">[</span><span class="nx">s</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">        <span class="nx">start</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">r</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">    <span class="nx">hno</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">hookingo</span><span class="p">.</span><span class="nf">Apply</span><span class="p">(</span><span class="nx">newobject</span><span class="p">,</span> <span class="nx">fno</span><span class="p">)</span> <span class="c1">// åº”ç”¨é’©å­ï¼Œæ›¿æ¢å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span> <span class="o">:=</span> <span class="nf">mc</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s">&#34;hello, closure!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">println</span><span class="p">(</span><span class="nf">f</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ C:<span class="se">\U</span>sers<span class="se">\H</span>elium<span class="se">\g</span>o<span class="se">\b</span>in<span class="se">\g</span>o1.17.exe run -gcflags -l .   <span class="c1"># go1.17 ç‰ˆæœ¬</span>
</span></span><span class="line"><span class="cl">int         <span class="c1"># æ‰“å°çš„æ˜¯mcçš„startå †åˆ†é…</span>
</span></span><span class="line"><span class="cl"><span class="m">8</span>           <span class="c1"># int å ç”¨å†…å­˜å¤§å°</span>
</span></span><span class="line"><span class="cl">struct <span class="o">{</span> F uintptr<span class="p">;</span> text string<span class="p">;</span> start *int <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="m">32</span>
</span></span><span class="line"><span class="cl">sure!
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ go run -gcflags -l .                                  <span class="c1"># go1.20.3ç‰ˆæœ¬</span>
</span></span><span class="line"><span class="cl">int
</span></span><span class="line"><span class="cl"><span class="m">8</span>
</span></span><span class="line"><span class="cl">struct <span class="o">{</span> F uintptr<span class="p">;</span> text string<span class="p">;</span> start *int <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="m">32</span>
</span></span><span class="line"><span class="cl">sure!
</span></span></code></pre></div><ol start="13">
<li>å› ä¸º<code>start</code>ä¼šè¢«ä¿®æ”¹ï¼Œæ‰€ä»¥æ•è·åœ°å€é€ æˆå †åˆ†é…ï¼Œå› æ­¤ç»“æœç¬¬ä¸€è¡Œæ‰“å°äº†ä¸€ä¸ª<code>int</code>ã€‚</li>
<li>ç¬¬äºŒè¡Œçš„<code>struct</code>å°±æ˜¯é—­åŒ…ç»“æ„çš„ç±»å‹ï¼Œè¿™æ˜¯é€šè¿‡ç±»å‹å…ƒæ•°æ®ç›´æ¥è·å–åˆ°çš„ï¼Œæ˜¯ç”±ç¼–è¯‘å™¨æ„é€ çš„ç»“æ„ç±»å‹ã€‚</li>
<li>æˆ‘ä»¬æŠ„éƒ¨åˆ†<code>fno()</code>å‡½æ•°çš„ç›¸å…³ä»£ç ï¼š<code>typ unsafe.Pointer</code>ï¼šæ¥è‡ªç±»å‹çš„<code>*_type</code>ç±»å‹æ•°æ®ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">fno</span><span class="p">(</span><span class="nx">typ</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">t</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">// type Type interface{}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œä¸ºä»€ä¹ˆèµ‹å€¼çš„æ˜¯ä¸‹æ ‡1ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸ºä»€ä¹ˆæ˜¯1è€Œä¸æ˜¯0ä¸‹æ ‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">t</span><span class="p">)))[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="nx">typ</span> <span class="c1">// ç›¸å½“äºåå°„äº†é—­åŒ…ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nb">println</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ... ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="16">
<li>åˆ†æ<code>reflect.TypeOf()</code>å‡½æ•°å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// TypeOf returns the reflection Type that represents the dynamic type of i.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If i is a nil interface value, TypeOf returns nil.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">TypeOf</span><span class="p">(</span><span class="nx">i</span> <span class="nx">any</span><span class="p">)</span> <span class="nx">Type</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// emptyInterface æ˜¯ç©ºæ¥å£çš„å†…å­˜ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">eface</span> <span class="o">:=</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">emptyInterface</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// eface.typ è¿™é‡Œç›´æ¥å–äº† typ å­—æ®µï¼Œæ²¡æœ‰è¦wordå­—æ®µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é€šè¿‡åˆ†ætoType()å‡½æ•°å¯çŸ¥ï¼ŒæŠŠeface.typæ”¾å…¥äº†éç©ºæ¥å£Typeä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› æ­¤å¿…é¡»è¦åˆ†æéç©ºæ¥å£ä¸­å­˜å‚¨çš„æ˜¯ä»€ä¹ˆï¼Ÿéç©ºæ¥å£å†…å­˜å¸ƒå±€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// type iface struct {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      tab *itab               // ç±»å‹å…ƒæ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      data *unsafe.Pointer    // è£…ç®±çš„æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› æ­¤ tab *itab è£…è½½çš„æ˜¯ *rtype ç±»å‹ç»“æ„ï¼Œä¹Ÿå°±æ˜¯ç»“æ„ä½“æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æŒ‰ç…§ä¼ å…¥å‚æ•°0è¿™é‡Œå¯ä»¥çœ‹å‡ºåº”è¯¥æ˜¯intçš„å…ƒç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é‡è¦çš„æ˜¯ dataï¼Œè¿™å­˜å‚¨çš„æ˜¯ *rtype è¿™ä¸ªæŒ‡é’ˆæ•°æ®ï¼Œç±»å‹åå°„å°±æ˜¯ä¾é è¿™ä¸ªdataã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› ä¸ºæˆ‘ä»¬è°ƒç”¨Typeéç©ºæ¥å£çš„æ‰€æœ‰æ–¹æ³•æ¥æ”¶å™¨çš„å‚æ•°éƒ½æ˜¯ *rtypeï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä¿®æ”¹ä¸‹æ ‡1çš„åŸå› ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æˆ‘ä»¬åœ¨è°ƒç”¨t.String()æ–¹æ³•æ—¶ï¼Œéœ€è¦çš„æ—¶dataè¿™ä¸ªæ˜¯æˆ‘ä»¬æƒ³è¦çš„ç±»å‹å³å¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nf">toType</span><span class="p">(</span><span class="nx">eface</span><span class="p">.</span><span class="nx">typ</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// emptyInterface is the header for an interface{} value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">emptyInterface</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">typ</span>  <span class="o">*</span><span class="nx">rtype</span>        <span class="c1">// å­˜å‚¨ç€ç±»å‹ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">word</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/func-003.png" alt=""  />
</p>
<ol start="17">
<li>åˆ†æ<code>toType()</code>å‡½æ•°å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// toType converts from a *rtype to a Type that can be returned
</span></span></span><span class="line"><span class="cl"><span class="c1">// to the client of package reflect. In gc, the only concern is that
</span></span></span><span class="line"><span class="cl"><span class="c1">// a nil *rtype must be replaced by a nil Type, but in gccgo this
</span></span></span><span class="line"><span class="cl"><span class="c1">// function takes care of ensuring that multiple *rtype for the same
</span></span></span><span class="line"><span class="cl"><span class="c1">// type are coalesced into a single Type.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">toType</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">rtype</span><span class="p">)</span> <span class="nx">Type</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">t</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">t</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="è°ƒç”¨é—­åŒ…">è°ƒç”¨é—­åŒ…<a hidden class="anchor" aria-hidden="true" href="#è°ƒç”¨é—­åŒ…">#</a></h3>
<ol>
<li>é—­åŒ…å‡½æ•°åœ¨è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œ<strong>å¿…é¡»</strong>å¾—åˆ°å½“å‰é—­åŒ…å¯¹è±¡çš„åœ°å€æ‰èƒ½è®¿é—®å…¶ä¸­çš„æ•è·åˆ—è¡¨ï¼Œè¿™ä¸ªåœ°å€æ˜¯å¦‚ä½•ä¼ é€’çš„å‘¢ï¼Ÿ</li>
<li>è°ƒç”¨è€…åœ¨è°ƒç”¨ Function Value çš„æ—¶å€™åªæ˜¯åƒè°ƒç”¨ä¸€ä¸ªæ™®é€šå‡½æ•°é‚£æ ·ä¼ é€’äº†å£°æ˜çš„å‚æ•°ï¼Œå¦‚æœ Function Value èƒŒåæ˜¯ä¸ªé—­åŒ…å‡½æ•°ï¼Œåˆ™æ— æ³•é€šè¿‡æ ˆä¸Šçš„å‚æ•°å¾—åˆ°é—­åŒ…å¯¹è±¡åœ°å€ã€‚</li>
<li>é™¤éç¼–è¯‘å™¨ä¼ é€’äº†ä¸€ä¸ªéšå«çš„å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°å¦‚æœé€šè¿‡æ ˆä¼ é€’ï¼Œé‚£å°±æ”¹å˜äº†å‡½æ•°çš„åŸå‹ï¼Œè¿™æ ·å°±ä¼šé€ æˆä¸ä¸€è‡´ï¼Œæ˜¯è¡Œä¸é€šçš„ã€‚</li>
<li>è¿˜æ˜¯é€šè¿‡åæ±‡ç¼–æ¥çœ‹ä¸€ä¸‹é—­åŒ…å‡½æ•°æ˜¯ä»å“ªé‡Œå¾—åˆ°çš„è¿™ä¸ªåœ°å€ï¼Œå…ˆæ¥æ„é€ é—­åŒ…ï¼Œä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mc</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="kd">func</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>æ ¹æ®å‰é¢çš„æ¢ç´¢ï¼Œå¯ä»¥ç¡®å®šé—­åŒ…å¯¹è±¡çš„ç»“æ„å®šä¹‰ä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">F</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">n</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>åç¼–è¯‘é—­åŒ…å‡½æ•°å¾—åˆ°çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š
<ol>
<li>ç¬¬7è¡Œï¼Œå°† <code>DX</code> å¯„å­˜å™¨ç”¨ä½œåŸºå€,å†åŠ ä¸Šä½ç§» 8ï¼ŒæŠŠè¯¥åœ°å€å¤„çš„å€¼å¤åˆ¶åˆ° <code>CX</code> å¯„å­˜å™¨ä¸­ã€‚</li>
<li>ç¬¬8è¡Œï¼ŒæŠŠ <code>CX</code> å¯„å­˜å™¨å€¼å¤åˆ¶ç»™é—­åŒ…å‡½æ•°çš„è¿”å›å€¼ã€‚</li>
<li>ç¬¬11è¡Œï¼ŒæŠŠè¿”å›å€¼æ”¾å…¥<code>AX</code>å¯„å­˜å™¨ä¸­ã€‚</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">go</span> <span class="no">tool</span> <span class="no">objdump</span> <span class="p">-</span><span class="no">S</span> <span class="p">-</span><span class="no">s</span> <span class="err">&#39;^</span><span class="no">main.mc.func1$</span><span class="err">&#39;</span> <span class="p">.</span><span class="err">/</span><span class="no">h1</span>
</span></span><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.mc.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl">    <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552a0</span>      <span class="mi">4883</span><span class="no">ec18</span>            <span class="no">SUBQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552a4</span>      <span class="mi">48896</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552a9</span>      <span class="mi">488</span><span class="no">d6c2410</span>          <span class="no">LEAQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552ae</span>      <span class="mi">488</span><span class="no">b4a08</span>            <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">CX</span>    <span class="c1"># CX=0x8(DX)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552b2</span>      <span class="mi">48894</span><span class="no">c2408</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552b7</span>      <span class="mi">48</span><span class="no">c7042400000000</span>    <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">        <span class="no">return</span> <span class="no">n</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552bf</span>      <span class="mi">488</span><span class="no">b442408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>    <span class="c1"># AX=0x8(DX)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552c4</span>      <span class="mi">48890424</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552c8</span>      <span class="mi">488</span><span class="no">b6c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552cd</span>      <span class="mi">4883</span><span class="no">c418</span>            <span class="no">ADDQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552d1</span>      <span class="no">c3</span>                  <span class="no">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="7">
<li>æ˜¾ç„¶ï¼Œ<strong><code>DX</code>å¯„å­˜å™¨</strong>å­˜å‚¨çš„å°±æ˜¯é—­åŒ…å¯¹è±¡çš„åœ°å€ï¼Œè°ƒç”¨è€…è´Ÿè´£åœ¨è°ƒç”¨ä¹‹å‰æŠŠé—­åŒ…å¯¹è±¡çš„åœ°å€å­˜å‚¨åˆ° <code>DX</code> å¯„å­˜å™¨ä¸­ï¼Œè·Ÿ <code>C++</code> ä¸­çš„ <code>thiscall</code>éå¸¸ç±»ä¼¼ã€‚</li>
<li>ä¹‹å‰æœ‰å¾ˆå¤šè¯»è€…åœ¨åç¼–è¯‘ Function Value è°ƒç”¨ä»£ç æ—¶ï¼Œæ€»ä¼šçœ‹åˆ°ä¸º <code>DX</code> å¯„å­˜å™¨èµ‹å€¼ï¼Œå¹¶ä¸ºæ­¤æ„Ÿåˆ°ç–‘æƒ‘ï¼Œè¿™å°±æ˜¯åŸå› ã€‚</li>
<li>è°ƒç”¨è€…ä¸å¿…åŒºåˆ†æ˜¯ä¸æ˜¯é—­åŒ…ã€æœ‰æ²¡æœ‰æ•è·åˆ—è¡¨ï¼Œå®é™…ä¸Šä¹ŸåŒºåˆ†ä¸äº†ï¼Œåªèƒ½ç»Ÿä¸€ä½œä¸ºé—­åŒ…æ¥å¤„ç†ï¼Œæ‰€ä»¥æ€»è¦é€šè¿‡ <code>DX</code> ä¼ é€’åœ°å€ã€‚</li>
<li>å¦‚æœ Function Value èƒŒåä¸æ˜¯é—­åŒ…ï¼Œè¿™ä¸ªåœ°å€å°±ä¸ä¼šè¢«ç”¨åˆ°ï¼Œä¹Ÿä¸ä¼šé€ æˆä»€ä¹ˆå½±å“ã€‚</li>
</ol>
<p><img loading="lazy" src="../images/func-008.png" alt=""  />
</p>
<h3 id="é—­åŒ…ä¸å˜é‡é€ƒé€¸">é—­åŒ…ä¸å˜é‡é€ƒé€¸<a hidden class="anchor" aria-hidden="true" href="#é—­åŒ…ä¸å˜é‡é€ƒé€¸">#</a></h3>
<ol>
<li>å˜é‡é€ƒé€¸è·Ÿé—­åŒ…ä¹‹é—´çš„å…³ç³»å¾ˆå¯†åˆ‡ï¼Œå› ä¸º Function Value æœ¬èº«å°±æ˜¯ä¸ªæŒ‡é’ˆï¼Œç¼–è¯‘å™¨ä¹Ÿå¯ä»¥æŒ‰ç…§åŒæ ·çš„æ–¹å¼æ¥åˆ†æ Function Value æœ‰æ²¡æœ‰é€ƒé€¸ã€‚</li>
<li>å¦‚æœ Function Value æ²¡æœ‰é€ƒé€¸é‚£å°±å¯ä»¥ä¸ç”¨åœ¨å †ä¸Šåˆ†é…é—­åŒ…å¯¹è±¡äº†ï¼Œåˆ†é…åœ¨æ ˆä¸Šå³å¯ã€‚</li>
<li>ä½¿ç”¨ä¸€ä¸ªç¤ºä¾‹è¿›è¡ŒéªŒè¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">sc</span><span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">f</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>ä»£ç é€»è¾‘è¿‡äºç®€å•ï¼Œä¸ºäº†é¿å…é—­åŒ…å‡½æ•°è¢«ç¼–è¯‘å™¨ä¼˜åŒ–æ‰ï¼Œç¼–è¯‘æ—¶éœ€è¦ç¦ç”¨å†…è”ä¼˜åŒ–ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š<code>$ go build -gcflags='-l'</code>ã€‚</li>
<li>å†æ¥åç¼–è¯‘ <code>sc()</code> å‡½æ•°ï¼Œ<code>main.sc</code>åç¼–è¯‘å‘½ä»¤åŠè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">go</span> <span class="no">build</span> <span class="p">-</span><span class="no">gcflags</span><span class="err">=&#34;</span><span class="p">-</span><span class="no">l</span> <span class="p">-</span><span class="no">N</span><span class="err">&#34;</span> <span class="p">-</span><span class="no">o</span> <span class="p">.</span><span class="err">/</span><span class="no">h1</span> <span class="no">myzx.cn</span><span class="err">/</span><span class="no">helium</span>
</span></span><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">go</span> <span class="no">tool</span> <span class="no">objdump</span> <span class="p">-</span><span class="no">S</span> <span class="p">-</span><span class="no">s</span> <span class="err">&#39;^</span><span class="no">main.sc$</span><span class="err">&#39;</span> <span class="p">.</span><span class="err">/</span><span class="no">h1</span>
</span></span><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.sc</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">sc</span><span class="p">(</span><span class="no">n</span> <span class="no">int</span><span class="p">)</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>      <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455224</span>      <span class="mi">7664</span>                <span class="no">JBE</span> <span class="mi">0x45528a</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455226</span>      <span class="mi">4883</span><span class="no">ec38</span>            <span class="no">SUBQ</span> <span class="no">$0x38</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45522a</span>      <span class="mi">48896</span><span class="no">c2430</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45522f</span>      <span class="mi">488</span><span class="no">d6c2430</span>          <span class="no">LEAQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455234</span>      <span class="mi">4889442440</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x40</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># åˆ†é…å‚æ•°ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455239</span>      <span class="mi">48</span><span class="no">c7042400000000</span>    <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># åˆ†é…è¿”å›å€¼ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">f</span> <span class="p">:</span><span class="err">=</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455241</span>      <span class="mi">440</span><span class="no">f117c2410</span>        <span class="no">MOVUPS</span> <span class="no">X15</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455247</span>      <span class="mi">488</span><span class="no">d542410</span>          <span class="no">LEAQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>   <span class="c1"># &amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45524c</span>      <span class="mi">4889542428</span>          <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455251</span>      <span class="mi">8402</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455253</span>      <span class="mi">488</span><span class="no">d0546000000</span>      <span class="no">LEAQ</span> <span class="no">main.sc.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45525a</span>      <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># funcval.fn 0x10(SP)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45525f</span>      <span class="mi">8402</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455261</span>      <span class="mi">488</span><span class="no">b442440</span>          <span class="no">MOVQ</span> <span class="mi">0x40</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>   <span class="c1"># å‚æ•°nçš„å€¼ 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455266</span>      <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># funcval.data 0x18(SP) 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45526b</span>      <span class="mi">4889542420</span>          <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">return</span> <span class="no">f</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455270</span>      <span class="mi">488</span><span class="no">b442410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455275</span>      <span class="no">ffd0</span>                <span class="no">CALL</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455277</span>      <span class="mi">4889442408</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45527c</span>      <span class="mi">48890424</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455280</span>      <span class="mi">488</span><span class="no">b6c2430</span>          <span class="no">MOVQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455285</span>      <span class="mi">4883</span><span class="no">c438</span>            <span class="no">ADDQ</span> <span class="no">$0x38</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455289</span>      <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">sc</span><span class="p">(</span><span class="no">n</span> <span class="no">int</span><span class="p">)</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528a</span>      <span class="mi">4889442408</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528f</span>      <span class="no">e8ccccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455294</span>      <span class="mi">488</span><span class="no">b442408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455299</span>      <span class="no">eb85</span>                <span class="no">JMP</span> <span class="no">main.sc</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/func-009.png" alt=""  />
</p>
<h2 id="å‡½æ•°">å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#å‡½æ•°">#</a></h2>
<ol>
<li>åœ¨Goè¯­è¨€ä¸­å‡½æ•°å±äº<strong>å¤´ç­‰å¯¹è±¡</strong>ï¼Œå¯ä»¥è¢«å½“ä½œ<strong>å‚æ•°ä¼ é€’</strong>ã€ä¹Ÿå¯ä»¥ä½œä¸º<strong>å‡½æ•°è¿”å›å€¼</strong>ã€<strong>ç»‘å®šåˆ°å˜é‡</strong>ã€‚</li>
<li>Goè¯­è¨€ç§°è¿™æ ·çš„å‚æ•°ã€è¿”å›å€¼å’Œå˜é‡ä¸º<strong>Function Value</strong>ã€‚</li>
<li>Function Valueæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª<strong>æŒ‡é’ˆ</strong>ï¼Œå´ä¸ç›´æ¥æŒ‡å‘å‡½æ•°æŒ‡ä»¤å…¥å£ï¼Œè€Œæ˜¯æŒ‡å‘runtime.funcvalç»“æ„ä½“ï¼Œå‡½æ•°å˜é‡å­˜å‚¨çš„æ˜¯*funcvalç±»å‹ï¼Œä¹Ÿå°±æ˜¯funcvalç»“æ„ä½“çš„åœ°å€ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// é—­åŒ…æ˜¯å‡½æ•°ç±»å‹funcType
</span></span></span><span class="line"><span class="cl"><span class="c1">// é—­åŒ…æ•è·çš„å˜é‡ï¼Œç³»ç»Ÿç»´æŠ¤ç€ä¸€ä¸ªå…³ç³»åˆ—è¡¨ï¼Œæ ¹æ®è¿™ä¸ªåˆ—è¡¨èƒ½æ­£ç¡®çš„æ‰¾åˆ°æ•è·çš„å˜é‡ç±»å‹å¤§å°ç­‰ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">funcval</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fn</span> <span class="kt">uintptr</span>  <span class="c1">// æŒ‡å‘ç¨‹åºçš„ä»£ç æ®µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// variable-size, fn-specific data here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ç´§æ¥ç€funcvalç»“æ„ä½“åé¢å†…å­˜åœ°å€æ˜¯æ•è·çš„çš„å˜é‡åˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1">// æ³¨æ„æ•è·çš„æ˜¯å˜é‡çš„åœ°å€ï¼Œä½¿ç”¨çš„å´æ˜¯å˜é‡çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1">// é—­åŒ…ä¸­æ•è·çš„å¦‚æœæ˜¯æŒ‡é’ˆç±»å‹é‚£ä¹ˆæ˜¯å¼•ç”¨ï¼Œæ˜¯æ™®é€šç±»å‹é‚£ä¹ˆæ˜¯æ‹·è´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// f -&gt; *funcval
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>è¿™ä¸ªç»“æ„ä½“ä»å®šä¹‰ä¸Šçœ‹åªæœ‰ä¸€ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€æ‰æ˜¯å‡½æ•°çš„æŒ‡ä»¤å…¥å£ã€‚ä¸€ä¸ªFunction Valueæ˜¯ä»¥ä¸‹å›¾æ‰€ç¤ºå½¢å¼å­˜åœ¨çš„ã€‚</li>
</ol>
<p><img loading="lazy" src="../images/func-004.png" alt=""  />
</p>
<h2 id="é—­åŒ…-1">é—­åŒ…<a hidden class="anchor" aria-hidden="true" href="#é—­åŒ…-1">#</a></h2>
<ol>
<li><code>Closure</code>ï¼šç»´åŸºç™¾ç§‘
<ul>
<li>é—­åŒ…åœ¨å®ç°ä¸Šæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå®ƒå­˜å‚¨äº†ä¸€ä¸ªå‡½æ•°ï¼ˆé€šå¸¸æ˜¯å…¶å…¥å£åœ°å€ï¼‰å’Œä¸€ä¸ªå…³è”çš„ç¯å¢ƒï¼ˆç›¸å½“äºä¸€ä¸ªç¬¦å·æŸ¥æ‰¾è¡¨ï¼‰ã€‚</li>
<li>ç¯å¢ƒé‡Œæ˜¯è‹¥å¹²å¯¹ç¬¦å·å’Œå€¼çš„å¯¹åº”å…³ç³»ï¼Œå®ƒæ—¢è¦åŒ…æ‹¬çº¦æŸå˜é‡ï¼ˆè¯¥å‡½æ•°å†…éƒ¨ç»‘å®šçš„ç¬¦å·ï¼‰ï¼Œä¹Ÿè¦åŒ…æ‹¬è‡ªç”±å˜é‡ï¼ˆåœ¨å‡½æ•°å¤–éƒ¨å®šä¹‰ä½†åœ¨å‡½æ•°å†…è¢«å¼•ç”¨ï¼‰ï¼Œæœ‰äº›å‡½æ•°ä¹Ÿå¯èƒ½æ²¡æœ‰è‡ªç”±å˜é‡ã€‚</li>
<li>é—­åŒ…è·Ÿå‡½æ•°æœ€å¤§çš„ä¸åŒåœ¨äºï¼Œå½“æ•æ‰é—­åŒ…çš„æ—¶å€™ï¼Œå®ƒçš„è‡ªç”±å˜é‡ä¼šåœ¨æ•æ‰æ—¶è¢«ç¡®å®šï¼Œè¿™æ ·å³ä¾¿è„±ç¦»äº†æ•æ‰æ—¶çš„ä¸Šä¸‹æ–‡ï¼Œå®ƒä¹Ÿèƒ½ç…§å¸¸è¿è¡Œã€‚</li>
</ul>
</li>
<li>æ‰€ä»¥åƒä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">create</span><span class="p">()</span> <span class="kd">func</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span> <span class="o">:=</span> <span class="mi">2</span>  <span class="c1">// cä¼šè¢«åˆ†é…åœ¨æ ˆä¸Šï¼Œä»¥æ‹·è´å½¢å¼è¢«æ•è·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ã€ç”±äºcå˜é‡åé¢æ²¡æœ‰å˜åŒ–ï¼Œæ‰€ä»¥è¿™é‡Œæ•è·å˜æˆæ‹·è´cçš„å€¼2å°±è¡Œï¼Œä¸éœ€è¦æ•è·cçš„åœ°å€ã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// f1 {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      fn ---&gt; é—­åŒ…å‡½æ•°åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      2  ---&gt; æ‹·è´cçš„å€¼å³å¯ï¼ˆä¸éœ€è¦æ•è·cçš„åœ°å€ï¼‰ï¼Œè¿™é‡Œ2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">f1</span> <span class="o">:=</span> <span class="nf">create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f2</span> <span class="o">:=</span> <span class="nf">create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f2</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// é—­åŒ…å‡½æ•°çš„å†…å­˜ç»“æ„å¸ƒå±€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">s</span> <span class="o">:=</span> <span class="o">**</span><span class="p">(</span><span class="o">**</span><span class="kd">struct</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fn</span> <span class="kt">uintptr</span>  <span class="c1">// æŒ‡å‘å‡½æ•°ä»£ç åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">data1</span> <span class="kt">int</span>   <span class="c1">// æ•è·å˜é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">})(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">f1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%#v\n&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>    <span class="c1">// struct {fn uintptr;data1 int}{fn:0x47f520, data1:2}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li><code>create</code>å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”å¼•ç”¨äº†å…¶å¤–å±‚å‡½æ•°å®šä¹‰çš„å±€éƒ¨å˜é‡<code>c</code>ã€‚</li>
<li>è€Œä¸”ï¼Œå³ä¾¿<code>create</code>å‡½æ•°ç»“æŸï¼Œä¾ç„¶å¯ä»¥é€šè¿‡<code>f1</code>å’Œ<code>f2</code>æ­£å¸¸æ‰§è¡Œè¿™ä¸ªå‡½æ•°å¹¶ä½¿ç”¨å®šä¹‰åœ¨<code>create</code>å†…éƒ¨çš„å˜é‡<code>c</code>ã€‚</li>
<li>æ‰€ä»¥è¿™ä¸ªè¿”å›å€¼ç¬¦åˆé—­åŒ…çš„å®šä¹‰ï¼Œè€Œè¿™ä¸ªè‡ªç”±å˜é‡<code>c</code>ï¼Œé€šå¸¸è¢«ç§°ä¸º<strong>æ•è·å˜é‡</strong>ã€‚</li>
<li>è™½ç„¶<code>create</code>å‡½æ•°çš„è¿”å›å€¼å‡½æ•°å½¢æˆé—­åŒ…ï¼Œä½†æ˜¯<code>Go</code>è¯­è¨€é‡Œå¹¶æ²¡æœ‰æŠŠé—­åŒ…ä»Function Valueä¸­ç‰¹åˆ«åŒºåˆ†å‡ºæ¥ã€‚</li>
<li><strong>åœ¨Goè¯­è¨€ä¸­é—­åŒ…åªæ˜¯æ‹¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ•è·å˜é‡çš„Function Valueè€Œå·²</strong>ã€‚</li>
<li>è¿™äº›æ•è·å˜é‡å°±æ˜¯å®ƒçš„æ•è·åˆ—è¡¨ï¼Œå°±æ”¾åœ¨å¯¹åº”çš„<code>funcval</code>ç»“æ„ä½“çš„åé¢ã€‚</li>
<li>æ‰€ä»¥ä¸Šä¾‹ä¸­ï¼Œ<code>f1</code>å’Œ<code>f2</code>çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li>
</ol>
<p><img loading="lazy" src="../images/func-005.png" alt=""  />
</p>
<ol start="10">
<li>æ¯ä¸ªé—­åŒ…å¯¹è±¡éƒ½æ˜¯ä¸€ä¸ªFunction Valueï¼Œä½†æ˜¯å„è‡ªæŒæœ‰è‡ªå·±çš„æ•è·åˆ—è¡¨ï¼Œè¿™ä¹Ÿæ˜¯ç§°é—­åŒ…ä¸º<strong>æœ‰çŠ¶æ€çš„å‡½æ•°</strong>çš„åŸå› ã€‚</li>
</ol>


<p><details >
  <summary markdown="span">é—­åŒ…æ•è·å˜é‡å€¼</summary>
  <blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span> <span class="o">:=</span> <span class="nf">create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nf">f</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">create</span><span class="p">()</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span> <span class="o">:=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å †åˆ†é… struct { F uintptr; c int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ³¨æ„è¿™é‡Œçš„cå˜é‡ä¸éœ€è¦è¢«æ•è·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// cæ²¡æœ‰æ›´æ”¹ï¼Œåªéœ€è¦æ‹·è´å˜é‡cçš„å€¼å³å¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>main å‡½æ•°æ±‡ç¼–ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e0</span>      <span class="mi">493</span><span class="no">b6610</span>        <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>      <span class="c1"># æ ˆå¢é•¿åˆ¤æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551e4</span>      <span class="mi">7629</span>            <span class="no">JBE</span> <span class="mi">0x45520f</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e6</span>      <span class="mi">4883</span><span class="no">ec10</span>        <span class="no">SUBQ</span> <span class="no">$0x10</span><span class="p">,</span> <span class="no">SP</span>          <span class="c1"># main.mainæ ˆåˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551ea</span>      <span class="mi">48896</span><span class="no">c2408</span>      <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ef</span>      <span class="mi">488</span><span class="no">d6c2408</span>      <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f</span> <span class="p">:</span><span class="err">=</span> <span class="no">create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551f4</span>      <span class="no">e827000000</span>      <span class="no">CALL</span> <span class="no">main.create</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    <span class="c1"># AXè¿”å›&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551f9</span>      <span class="mi">48890424</span>        <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_</span> <span class="err">=</span> <span class="no">f</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551fd</span>      <span class="mi">488</span><span class="no">b08</span>          <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">),</span> <span class="no">CX</span>          <span class="c1"># CX=funcval.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455200</span>      <span class="mi">4889</span><span class="no">c2</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="no">DX</span>             <span class="c1"># DX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455203</span>      <span class="no">ffd1</span>            <span class="no">CALL</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455205</span>      <span class="mi">488</span><span class="no">b6c2408</span>      <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520a</span>      <span class="mi">4883</span><span class="no">c410</span>        <span class="no">ADDQ</span> <span class="no">$0x10</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520e</span>      <span class="no">c3</span>              <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520f</span>      <span class="no">e84ccdffff</span>      <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455214</span>      <span class="no">ebca</span>            <span class="no">JMP</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>create å‡½æ•°æ±‡ç¼–ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">create</span><span class="p">()</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>  <span class="c1"># æ ˆå¢é•¿åˆ¤æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455224</span>        <span class="mi">765</span><span class="no">f</span>                <span class="no">JBE</span> <span class="mi">0x455285</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455226</span>        <span class="mi">4883</span><span class="no">ec30</span>            <span class="no">SUBQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>      <span class="c1"># åˆ†é…createæ ˆç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45522a</span>        <span class="mi">48896</span><span class="no">c2428</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45522f</span>        <span class="mi">488</span><span class="no">d6c2428</span>          <span class="no">LEAQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455234</span>        <span class="mi">48</span><span class="no">c744241800000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span> <span class="c1"># ä¸´æ—¶è¿”å›ç©ºé—´8å­—èŠ‚ï¼Œ*funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">c</span> <span class="p">:</span><span class="err">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45523d</span>        <span class="mi">48</span><span class="no">c744241002000000</span>  <span class="no">MOVQ</span> <span class="no">$0x2</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span> <span class="c1"># å‚æ•° c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># AX=0x7493(IP)ï¼Œfuncvalç»“æ„ä½“ç±»å‹çš„_typeç±»å‹æŒ‡é’ˆä½ç½®ï¼Œå†…å­˜å¤§å°16B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455246</span>        <span class="mi">488</span><span class="no">d0593740000</span>      <span class="no">LEAQ</span> <span class="mi">0x7493</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span> 
</span></span><span class="line"><span class="cl">  <span class="c1"># æ ¹æ®*_typeè¿›è¡Œå †åˆ†é…ï¼ŒAX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45524d</span>        <span class="no">e8ee5cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl">  <span class="mi">0x455252</span>        <span class="mi">4889442420</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># CX=main.create.func1 ä»£ç åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455257</span>        <span class="mi">488</span><span class="no">d0d42000000</span>      <span class="no">LEAQ</span> <span class="no">main.create.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">CX</span>  
</span></span><span class="line"><span class="cl">  <span class="mi">0x45525e</span>        <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>    <span class="c1"># funcval.fn=main.create.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455261</span>        <span class="mi">488</span><span class="no">b4c2420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span> <span class="c1"># CX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455266</span>        <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455268</span>        <span class="mi">488</span><span class="no">b542410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span> <span class="c1"># DX=0x2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45526d</span>        <span class="mi">48895108</span>            <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>  <span class="c1"># funcval.data=0x2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455271</span>        <span class="mi">488</span><span class="no">b442420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span> <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455276</span>        <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45527b</span>        <span class="mi">488</span><span class="no">b6c2428</span>          <span class="no">MOVQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455280</span>        <span class="mi">4883</span><span class="no">c430</span>            <span class="no">ADDQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455284</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">create</span><span class="p">()</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455285</span>        <span class="no">e8d6ccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528a</span>        <span class="no">eb94</span>                <span class="no">JMP</span> <span class="no">main.create</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>main.create.func1 å‡½æ•°æ±‡ç¼–ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.create.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">g</span><span class="err">/</span><span class="no">hello1</span><span class="err">/</span><span class="no">func1.go</span>
</span></span><span class="line"><span class="cl">  <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x4552a0</span>      <span class="mi">4883</span><span class="no">ec18</span>            <span class="no">SUBQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x4552a4</span>      <span class="mi">48896</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x4552a9</span>      <span class="mi">488</span><span class="no">d6c2410</span>          <span class="no">LEAQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x4552ae</span>      <span class="mi">488</span><span class="no">b4a08</span>            <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">CX</span>    <span class="c1"># CX=0x2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0</span><span class="nf">x4552b2</span>      <span class="mi">48894</span><span class="no">c2408</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x4552b7</span>      <span class="mi">48</span><span class="no">c7042400000000</span>    <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// æ³¨æ„è¿™é‡Œçš„cå˜é‡ä¸éœ€è¦è¢«æ•è·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0</span><span class="nf">x4552bf</span>      <span class="mi">488</span><span class="no">b442408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>    <span class="c1"># AX=0x2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">0</span><span class="nf">x4552c4</span>      <span class="mi">48890424</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x4552c8</span>      <span class="mi">488</span><span class="no">b6c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x4552cd</span>      <span class="mi">4883</span><span class="no">c418</span>            <span class="no">ADDQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x4552d1</span>      <span class="no">c3</span>                  <span class="no">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>mainå’Œcreateçš„æ ˆåˆ†å¸ƒã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">          |   runtime.main callback
</span></span><span class="line"><span class="cl">          --------------------------
</span></span><span class="line"><span class="cl">  +40 +08 |   runtime.main BP
</span></span><span class="line"><span class="cl">          --------------------------  BP      ---------------
</span></span><span class="line"><span class="cl">  +38 +00 |   create.r *funcval               main.mainæ ˆ
</span></span><span class="line"><span class="cl">          --------------------------  SP      ---------------
</span></span><span class="line"><span class="cl">  +30     |   main.main callback
</span></span><span class="line"><span class="cl">          --------------------------
</span></span><span class="line"><span class="cl">  +28     |   main.main BP
</span></span><span class="line"><span class="cl">          --------------------------  BP      ---------------
</span></span><span class="line"><span class="cl">  +20     |   &amp;funcval    create.o            -&gt; ä¸´æ—¶funcvalå †åˆ†é…
</span></span><span class="line"><span class="cl">          --------------------------
</span></span><span class="line"><span class="cl">  +18     |   &amp;funcval    create.r            -&gt; createçš„è¿”å›å€¼
</span></span><span class="line"><span class="cl">          --------------------------
</span></span><span class="line"><span class="cl">  +10     |   0x2         create.c            main.createæ ˆ
</span></span><span class="line"><span class="cl">          --------------------------
</span></span><span class="line"><span class="cl">  +08     |
</span></span><span class="line"><span class="cl">          --------------------------
</span></span><span class="line"><span class="cl">  +00     |
</span></span><span class="line"><span class="cl">          --------------------------  SP      ---------------
</span></span></code></pre></div></blockquote>

</details></p>



<p><details >
  <summary markdown="span">é—­åŒ…æ•è·å˜é‡åœ°å€</summary>
  <blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span> <span class="o">:=</span> <span class="nf">create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nf">f</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">create</span><span class="p">()</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span> <span class="o">:=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å †åˆ†é… struct { F uintptr; c *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="o">++</span>   <span class="c1">// æ•è·cå˜é‡åœ°å€ï¼Œåœ¨å †ä¸Šåˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>main å‡½æ•°æ±‡ç¼–ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e0</span>        <span class="mi">493</span><span class="no">b6610</span>        <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e4</span>        <span class="mi">7629</span>            <span class="no">JBE</span> <span class="mi">0x45520f</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e6</span>        <span class="mi">4883</span><span class="no">ec10</span>        <span class="no">SUBQ</span> <span class="no">$0x10</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ea</span>        <span class="mi">48896</span><span class="no">c2408</span>      <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ef</span>        <span class="mi">488</span><span class="no">d6c2408</span>      <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f</span> <span class="p">:</span><span class="err">=</span> <span class="no">create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551f4</span>        <span class="no">e827000000</span>      <span class="no">CALL</span> <span class="no">main.create</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    <span class="c1"># è°ƒç”¨å‡½æ•° AXè¿”å›&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551f9</span>        <span class="mi">48890424</span>        <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">_</span> <span class="err">=</span> <span class="no">f</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551fd</span>        <span class="mi">488</span><span class="no">b08</span>          <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">),</span> <span class="no">CX</span>          <span class="c1"># CX=funcval.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455200</span>        <span class="mi">4889</span><span class="no">c2</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="no">DX</span>             <span class="c1"># DX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455203</span>        <span class="no">ffd1</span>            <span class="no">CALL</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455205</span>        <span class="mi">488</span><span class="no">b6c2408</span>      <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520a</span>        <span class="mi">4883</span><span class="no">c410</span>        <span class="no">ADDQ</span> <span class="no">$0x10</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520e</span>        <span class="no">c3</span>              <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520f</span>        <span class="no">e84ccdffff</span>      <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455214</span>        <span class="no">ebca</span>            <span class="no">JMP</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>create å‡½æ•°æ±‡ç¼–ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">create</span><span class="p">()</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455224</span>        <span class="mi">0</span><span class="no">f8686000000</span>        <span class="no">JBE</span> <span class="mi">0x4552b0</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45522a</span>        <span class="mi">4883</span><span class="no">ec30</span>            <span class="no">SUBQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45522e</span>        <span class="mi">48896</span><span class="no">c2428</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455233</span>        <span class="mi">488</span><span class="no">d6c2428</span>          <span class="no">LEAQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455238</span>        <span class="mi">48</span><span class="no">c744241000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">c</span> <span class="p">:</span><span class="err">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455241</span>        <span class="mi">488</span><span class="no">d05f84a0000</span>      <span class="no">LEAQ</span> <span class="mi">0x4af8</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>             <span class="c1"># AX=0x4af8(IP)ï¼Œintçš„å…ƒç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455248</span>        <span class="no">e8f35cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>      <span class="c1"># ç”³è¯·å†…å­˜ï¼ŒAX=*int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45524d</span>        <span class="mi">4889442420</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>               <span class="c1"># å˜é‡c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455252</span>        <span class="mi">48</span><span class="no">c70002000000</span>      <span class="no">MOVQ</span> <span class="no">$0x2</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>                <span class="c1"># ç»™cèµ‹å€¼2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455259</span>        <span class="mi">488</span><span class="no">d0580740000</span>      <span class="no">LEAQ</span> <span class="mi">0x7480</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>             <span class="c1"># funcvalçš„å…ƒç±»å‹ï¼Œç”³è¯·16B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455260</span>        <span class="no">e8db5cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>      <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455265</span>        <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45526a</span>        <span class="mi">488</span><span class="no">d0d4f000000</span>      <span class="no">LEAQ</span> <span class="no">main.create.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">CX</span>  <span class="c1"># CX=main.create.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455271</span>        <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>                  <span class="c1"># funcval.fn=main.create.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455274</span>        <span class="mi">488</span><span class="no">b4c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>               <span class="c1"># CX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455279</span>        <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45527b</span>        <span class="mi">488</span><span class="no">b542420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>               <span class="c1"># DX=*int -&gt; 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455280</span>        <span class="mi">488</span><span class="no">d7908</span>            <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">DI</span>                <span class="c1"># DI=funcval.data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455284</span>        <span class="mi">833</span><span class="no">dd51f090000</span>      <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528b</span>        <span class="mi">7402</span>                <span class="no">JE</span> <span class="mi">0x45528f</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528d</span>        <span class="no">eb06</span>                <span class="no">JMP</span> <span class="mi">0x455295</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528f</span>        <span class="mi">48895108</span>            <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>                <span class="c1"># funcval.data=*int -&gt; 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455293</span>        <span class="no">eb07</span>                <span class="no">JMP</span> <span class="mi">0x45529c</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455295</span>        <span class="no">e8a6d0ffff</span>          <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrierDX</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45529a</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x45529c</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45529c</span>        <span class="mi">488</span><span class="no">b442418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>               <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552a1</span>        <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552a6</span>        <span class="mi">488</span><span class="no">b6c2428</span>          <span class="no">MOVQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552ab</span>        <span class="mi">4883</span><span class="no">c430</span>            <span class="no">ADDQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552af</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">create</span><span class="p">()</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552b0</span>        <span class="no">e8abccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552b5</span>        <span class="no">e966ffffff</span>          <span class="no">JMP</span> <span class="no">main.create</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>main.create.func1 å‡½æ•°æ±‡ç¼–ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.create.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">g</span><span class="err">/</span><span class="no">hello1</span><span class="err">/</span><span class="no">func1.go</span>
</span></span><span class="line"><span class="cl">  <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552c0</span>     <span class="mi">4883</span><span class="no">ec18</span>            <span class="no">SUBQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552c4</span>     <span class="mi">48896</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552c9</span>     <span class="mi">488</span><span class="no">d6c2410</span>          <span class="no">LEAQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552ce</span>     <span class="mi">488</span><span class="no">b4a08</span>            <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552d2</span>     <span class="mi">48894</span><span class="no">c2408</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552d7</span>     <span class="mi">48</span><span class="no">c7042400000000</span>    <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nf">c</span><span class="err">++</span>     <span class="c1">// æ•è·cå˜é‡åœ°å€ï¼Œåœ¨å †ä¸Šåˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x4552df</span>     <span class="mi">488</span><span class="no">b4c2408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552e4</span>     <span class="mi">488</span><span class="no">b09</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552e7</span>     <span class="mi">488</span><span class="no">b542408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552ec</span>     <span class="mi">48</span><span class="no">ffc1</span>              <span class="no">INCQ</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552ef</span>     <span class="mi">48890</span><span class="no">a</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nf">return</span> <span class="no">c</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552f2</span>     <span class="mi">488</span><span class="no">b4c2408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552f7</span>     <span class="mi">488</span><span class="no">b01</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552fa</span>     <span class="mi">48890424</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552fe</span>     <span class="mi">488</span><span class="no">b6c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455303</span>     <span class="mi">4883</span><span class="no">c418</span>            <span class="no">ADDQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455307</span>     <span class="no">c3</span>                  <span class="no">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>mainå’Œcreateçš„æ ˆåˆ†å¸ƒã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">          |   runtime.main callback
</span></span><span class="line"><span class="cl">          -------------------------
</span></span><span class="line"><span class="cl">  +40 +08 |   runtime.main BP
</span></span><span class="line"><span class="cl">          -------------------------   BP      ------------
</span></span><span class="line"><span class="cl">  +38 +00 |   &amp;funcval        c.r             main.mainæ ˆ
</span></span><span class="line"><span class="cl">          -------------------------   SP      ------------
</span></span><span class="line"><span class="cl">  +30     |   main.main callback
</span></span><span class="line"><span class="cl">          -------------------------
</span></span><span class="line"><span class="cl">  +28     |   main.main BP
</span></span><span class="line"><span class="cl">          -------------------------   BP      ------------
</span></span><span class="line"><span class="cl">  +20     |   *int    -&gt; 2    c
</span></span><span class="line"><span class="cl">          -------------------------
</span></span><span class="line"><span class="cl">  +18     |   &amp;funcval        c.o
</span></span><span class="line"><span class="cl">          -------------------------
</span></span><span class="line"><span class="cl">  +10     |   &amp;funcval        c.r
</span></span><span class="line"><span class="cl">          -------------------------
</span></span><span class="line"><span class="cl">  +08     |
</span></span><span class="line"><span class="cl">          -------------------------
</span></span><span class="line"><span class="cl">  +00     |
</span></span><span class="line"><span class="cl">          -------------------------   SP      ------------
</span></span></code></pre></div></blockquote>

</details></p>

<h2 id="è°ƒç”¨">è°ƒç”¨<a hidden class="anchor" aria-hidden="true" href="#è°ƒç”¨">#</a></h2>
<ol>
<li>é€šè¿‡Function Valueè°ƒç”¨å‡½æ•°æ—¶ï¼Œä¼šæŠŠå¯¹åº”çš„<code>funcval</code>ç»“æ„ä½“åœ°å€å­˜å…¥ç‰¹å®šå¯„å­˜å™¨ï¼Œå¦‚<code>amd64</code>å¹³å°ä½¿ç”¨çš„æ˜¯<code>DX</code>å¯„å­˜å™¨ï¼Œå‚çœ‹ä¸Šé¢çš„æ±‡ç¼–ç¡®å®ä½¿ç”¨DXå¯„å­˜å™¨å­˜å‚¨çš„ã€‚</li>
<li>ç»§ç»­ä½¿ç”¨é—­åŒ…çš„ç¤ºä¾‹ï¼Œé€šè¿‡<code>f1</code>è°ƒç”¨é—­åŒ…å‡½æ•°æ—¶ï¼Œä¼šæŠŠ<code>f1</code>å­˜å‚¨çš„<code>funcval</code>ç»“æ„ä½“åœ°å€å­˜å…¥å¯„å­˜å™¨<code>DX</code>ï¼Œè¿™æ ·åœ¨é—­åŒ…å‡½æ•°çš„æŒ‡ä»¤ä¸­å°±å¯ä»¥é€šè¿‡è¿™ä¸ªå¯„å­˜å™¨å­˜å‚¨çš„åœ°å€åŠ ä¸Š<code>8</code>å­—èŠ‚çš„åç§»ï¼Œå°±æ‰¾åˆ°<code>f1</code>çš„æ•è·å˜é‡äº†ã€‚</li>
<li>åŒæ ·çš„ï¼Œé€šè¿‡<code>f2</code>è°ƒç”¨é—­åŒ…å‡½æ•°æ—¶ï¼Œä¼šæŠŠ<code>f2</code>å­˜å‚¨çš„<code>funcval</code>ç»“æ„ä½“åœ°å€å­˜å…¥å¯„å­˜å™¨ï¼Œé—­åŒ…å‡½æ•°æ‰§è¡Œæ—¶æ‰¾åˆ°çš„å°±æ˜¯<code>f2</code>çš„æ•è·å˜é‡äº†ã€‚
<ul>
<li>å¦‚æœæ˜¯æ²¡æœ‰æ•è·åˆ—è¡¨çš„Function Valueï¼Œç›´æ¥å¿½ç•¥è¿™ä¸ªå¯„å­˜å™¨å³å¯ã€‚</li>
<li>é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œ<code>Go</code>è¯­è¨€å®ç°äº†å¯¹Function Valueçš„ç»Ÿä¸€è°ƒç”¨ã€‚</li>
</ul>
</li>
</ol>
<p><img loading="lazy" src="../images/func-006.png" alt=""  />
</p>
<h2 id="é™æ€åˆ†é…">é™æ€åˆ†é…<a hidden class="anchor" aria-hidden="true" href="#é™æ€åˆ†é…">#</a></h2>
<ol>
<li>å¯¹äºæ²¡æœ‰æ•è·åˆ—è¡¨çš„Function Valueï¼Œå¦‚æœå¤šä¸ªå˜é‡å…³è”åˆ°åŒä¸€ä¸ªå‡½æ•°ï¼Œç¼–è¯‘å™¨ä¼šåšå‡ºä¼˜åŒ–ï¼Œè®©å®ƒä»¬å…±ç”¨ä¸€ä¸ª<code>funcval</code>ç»“æ„ä½“ã€‚</li>
<li>æ³¨æ„ funcval åé¢å­˜å‚¨çš„æ˜¯æ•è·çš„å‚æ•°ï¼Œå®é™…ä¼ å‚ä¸åœ¨è¿™é‡Œï¼Œåœ¨è°ƒç”¨è¯¥å‡½æ•°æ—¶åœ¨è°ƒç”¨æ ˆä¸Šã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">A</span><span class="p">(</span><span class="nx">i</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">i</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">B</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f1</span> <span class="o">:=</span> <span class="nx">A</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">C</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f2</span> <span class="o">:=</span> <span class="nx">A</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>åƒä¸Šé¢è¿™ç§æƒ…å†µï¼Œç¼–è¯‘é˜¶æ®µä¼šåˆ›å»ºä¸€ä¸ª<code>funcval</code>ç»“æ„ä½“æ”¾åˆ°åªè¯»æ•°æ®æ®µï¼Œè€Œæ‰§è¡Œé˜¶æ®µï¼Œ<code>f1</code>å’Œ<code>f2</code>éƒ½ä¼šä½¿ç”¨å®ƒã€‚</li>
</ol>
<p><img loading="lazy" src="../images/func-007.png" alt=""  />
</p>


<p><details >
  <summary markdown="span">é™æ€åˆ†é…éªŒè¯</summary>
  <blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f1</span> <span class="o">:=</span> <span class="nx">A</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">A</span><span class="p">(</span><span class="nx">i</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">i</span><span class="o">++</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>main å‡½æ•°æ±‡ç¼–ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e0</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e4</span>        <span class="mi">7632</span>                <span class="no">JBE</span> <span class="mi">0x455218</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e6</span>        <span class="mi">4883</span><span class="no">ec18</span>            <span class="no">SUBQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ea</span>        <span class="mi">48896</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ef</span>        <span class="mi">488</span><span class="no">d6c2410</span>          <span class="no">LEAQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f1</span> <span class="p">:</span><span class="err">=</span> <span class="no">A</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551f4</span>        <span class="mi">488</span><span class="no">d15251d0100</span>      <span class="no">LEAQ</span> <span class="mi">0x11d25</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">DX</span>    <span class="c1"># DX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551fb</span>        <span class="mi">4889542408</span>          <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f1</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455200</span>        <span class="mi">488</span><span class="no">b0d191d0100</span>      <span class="no">MOVQ</span> <span class="mi">0x11d19</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">CX</span>    <span class="c1"># CX=funcval.fnï¼Œå‡½æ•°Açš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455207</span>        <span class="no">b801000000</span>          <span class="no">MOVL</span> <span class="no">$0x1</span><span class="p">,</span> <span class="no">AX</span>           <span class="c1"># AX=0x1ï¼Œå‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45520c</span>        <span class="no">ffd1</span>                <span class="no">CALL</span> <span class="no">CX</span>                  
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520e</span>        <span class="mi">488</span><span class="no">b6c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455213</span>        <span class="mi">4883</span><span class="no">c418</span>            <span class="no">ADDQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455217</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455218</span>        <span class="no">e843cdffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45521d</span>        <span class="no">ebc1</span>                <span class="no">JMP</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>A å‡½æ•°æ±‡ç¼–ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.A</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">g</span><span class="err">/</span><span class="no">hello1</span><span class="err">/</span><span class="no">func1.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">A</span><span class="p">(</span><span class="no">i</span> <span class="no">int</span><span class="p">)</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>        <span class="mi">4889442408</span>      <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">i</span><span class="err">++</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455225</span>        <span class="mi">48</span><span class="no">ffc0</span>          <span class="no">INCQ</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455228</span>        <span class="mi">4889442408</span>      <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45522d</span>        <span class="no">c3</span>              <span class="no">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>mainå’ŒAçš„æ ˆåˆ†å¸ƒã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">          |   runtime.main callback
</span></span><span class="line"><span class="cl">          -------------------------------
</span></span><span class="line"><span class="cl">  +10     |   runtime.main BP
</span></span><span class="line"><span class="cl">          ------------------------------- BP
</span></span><span class="line"><span class="cl">  +08     |   0x11d25(IP)         A
</span></span><span class="line"><span class="cl">          -------------------------------
</span></span><span class="line"><span class="cl">  +00     |
</span></span><span class="line"><span class="cl">          ------------------------------- SP
</span></span></code></pre></div></blockquote>

</details></p>

<h2 id="æ•è·åˆ—è¡¨">æ•è·åˆ—è¡¨<a hidden class="anchor" aria-hidden="true" href="#æ•è·åˆ—è¡¨">#</a></h2>
<ol>
<li>å› ä¸ºæ•è·åˆ—è¡¨éœ€è¦ç”±é—­åŒ…å¯¹è±¡å„è‡ªæŒæœ‰ï¼Œæ‰€ä»¥æœ‰æ•è·åˆ—è¡¨çš„Function Valueè¦åˆ°æ‰§è¡Œé˜¶æ®µæ‰ä¼šåœ¨å †ä¸Šåˆ†é…å¯¹åº”çš„<code>funcval</code>ç»“æ„ä½“ä»¥åŠæ•è·åˆ—è¡¨ç©ºé—´ã€‚</li>
<li>ä½†æ˜¯ï¼Œæ•è·åˆ—è¡¨é‡Œå­˜ä»€ä¹ˆï¼Ÿç›´æ¥æ‹·è´æ•è·å˜é‡å€¼å—ï¼Ÿæ‰æ²¡æœ‰é‚£ä¹ˆç®€å•ã€‚</li>
<li>é—­åŒ…æ•è·çš„å˜é‡è¦åœ¨é—­åŒ…å‡½æ•°å’Œå¤–å±‚å‡½æ•°ä¸­è¡¨ç°ä¸€è‡´ï¼Œå¦‚æœå•çº¯å€¼æ‹·è´ï¼Œå°±æ— æ³•ä¿è¯è¿™ä¸€ç‚¹ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨é’ˆå¯¹æ•è·å˜é‡çš„ä¸åŒæƒ…å†µåˆ†åˆ«åšå‡ºäº†ä¸åŒçš„å¤„ç†ã€‚
<ol>
<li>æ•è·å˜é‡ã€<strong>é™¤äº†åˆå§‹åŒ–èµ‹å€¼å¤–åœ¨ä»»ä½•åœ°æ–¹éƒ½æ²¡æœ‰è¢«ä¿®æ”¹è¿‡ï¼Œé‚£å°±å¯ä»¥ç›´æ¥æ‹·è´å€¼</strong>ã€‘ï¼Œå› ä¸ºå®ƒä¸ä¼šå†å˜åŒ–ã€‚</li>
<li>æ•è·å˜é‡é™¤äº†åˆå§‹åŒ–èµ‹å€¼å¤–ï¼Œè¿˜è¢«ä¿®æ”¹è¿‡ï¼Œå°±è¦å†ç»†åˆ†äº†ã€‚</li>
</ol>
</li>
</ol>
<h3 id="æ•è·å±€éƒ¨å˜é‡">æ•è·å±€éƒ¨å˜é‡<a hidden class="anchor" aria-hidden="true" href="#æ•è·å±€éƒ¨å˜é‡">#</a></h3>
<ol>
<li>è¿™ä¸ªä¾‹å­ä¸­ï¼Œè¢«æ•è·çš„æ˜¯å±€éƒ¨å˜é‡<code>i</code>ï¼Œé™¤äº†åˆå§‹åŒ–èµ‹å€¼å¤–è¿˜è¢«ä¿®æ”¹è¿‡ï¼Œæ‰€ä»¥å±€éƒ¨å˜é‡<code>i</code>æ”¹ä¸ºå †åˆ†é…ï¼Œæ ˆä¸Šåªå­˜ä¸€ä¸ªåœ°å€ã€‚</li>
<li>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œä¸ºäº†è®©è¢«æ•è·çš„å±€éƒ¨å˜é‡åœ¨é—­åŒ…å‡½æ•°å’Œå¤–å±‚å‡½æ•°ä¸­ä¿æŒä¸€è‡´ï¼Œæœ¬è¯¥åœ¨æ ˆä¸Šåˆ†é…çš„å±€éƒ¨å˜é‡è¢«åˆ†é…åˆ°å †ä¸Šï¼Œè¿™å…¶å®ä¹Ÿæ˜¯<strong>å˜é‡é€ƒé€¸</strong>çš„ä¸€ç§åœºæ™¯ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">create</span><span class="p">()</span> <span class="p">(</span><span class="nx">fs</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="kd">func</span><span class="p">()){</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// struct { F uintptr; i *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">fs</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(){</span>
</span></span><span class="line"><span class="cl">            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>    
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fs</span> <span class="o">:=</span> <span class="nf">create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">fs</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fs</span><span class="p">[</span><span class="nx">i</span><span class="p">]()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Output:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0xc0000ac058 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0xc0000ac058 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

<p><details >
  <summary markdown="span">æ•è·å±€éƒ¨å˜é‡</summary>
  <blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fs</span> <span class="o">:=</span> <span class="nf">create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">fs</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fs</span><span class="p">[</span><span class="nx">i</span><span class="p">]()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">create</span><span class="p">()</span> <span class="p">(</span><span class="nx">fs</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="kd">func</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å †åˆ†é… struct { F uintptr; i *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">fs</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">i</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>main æ±‡ç¼–ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e0</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e4</span>        <span class="mi">7675</span>                <span class="no">JBE</span> <span class="mi">0x45525b</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e6</span>        <span class="mi">4883</span><span class="no">ec30</span>            <span class="no">SUBQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ea</span>        <span class="mi">48896</span><span class="no">c2428</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ef</span>        <span class="mi">488</span><span class="no">d6c2428</span>          <span class="no">LEAQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fs</span> <span class="p">:</span><span class="err">=</span> <span class="no">create</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551f4</span>        <span class="no">e887000000</span>          <span class="no">CALL</span> <span class="no">main.create</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    <span class="c1"># è°ƒç”¨main.create
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551f9</span>        <span class="mi">0</span><span class="no">f100424</span>            <span class="no">MOVUPS</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">X0</span>        <span class="c1"># å°†0(SP)å16Bå†…å®¹æ”¾å…¥X0ï¼Œè¿™é‡Œçš„ä¸¤è¡Œä»£ç ç›¸å½“äºfsèµ‹å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551fd</span>        <span class="mi">0</span><span class="no">f11442418</span>          <span class="no">MOVUPS</span> <span class="no">X0</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>     <span class="c1"># å°†X0è¿ç§»åˆ°0x18(SP)å16B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">for</span> <span class="no">i</span> <span class="p">:</span><span class="err">=</span> <span class="mi">0</span><span class="c1">; i &lt; len(fs); i++ {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455202</span>        <span class="mi">48</span><span class="no">c744241000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>     <span class="c1"># iåˆå§‹åŒ– 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45520b</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x45520d</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520d</span>        <span class="mi">48837</span><span class="no">c241002</span>        <span class="no">CMPQ</span> <span class="no">$0x2</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>     <span class="c1"># iå’Œ0x2æ¯”è¾ƒ    &lt;--- å¾ªç¯åˆ¤æ–­æ¡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455213</span>        <span class="mi">7</span><span class="no">c02</span>                <span class="no">JL</span> <span class="mi">0x455217</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455215</span>        <span class="no">eb2f</span>                <span class="no">JMP</span> <span class="mi">0x455246</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fs</span><span class="p">[</span><span class="no">i</span><span class="p">]()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455217</span>        <span class="mi">488</span><span class="no">b442410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>       <span class="c1"># AX=0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45521c</span>        <span class="mi">0</span><span class="no">f1f4000</span>            <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>        <span class="mi">4883</span><span class="no">f802</span>            <span class="no">CMPQ</span> <span class="no">$0x2</span><span class="p">,</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455224</span>        <span class="mi">7202</span>                <span class="no">JB</span> <span class="mi">0x455228</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455226</span>        <span class="no">eb28</span>                <span class="no">JMP</span> <span class="mi">0x455250</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455228</span>        <span class="mi">488</span><span class="no">d44c418</span>          <span class="no">LEAQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)(</span><span class="no">AX</span><span class="p">*</span><span class="mi">8</span><span class="p">),</span> <span class="no">AX</span> <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45522d</span>        <span class="mi">488</span><span class="no">b10</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">),</span> <span class="no">DX</span>          <span class="c1"># DX=&amp;funcval.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455230</span>        <span class="mi">488</span><span class="no">b02</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">AX</span>          <span class="c1"># AX=funcval.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455233</span>        <span class="no">ffd0</span>                <span class="no">CALL</span> <span class="no">AX</span>                 <span class="c1"># è°ƒç”¨å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455235</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x455237</span>
</span></span><span class="line"><span class="cl">    <span class="nf">for</span> <span class="no">i</span> <span class="p">:</span><span class="err">=</span> <span class="mi">0</span><span class="c1">; i &lt; len(fs); i++ {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455237</span>        <span class="mi">488</span><span class="no">b5c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BX</span>       <span class="c1"># BX=0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45523c</span>        <span class="mi">48</span><span class="no">ffc3</span>              <span class="no">INCQ</span> <span class="no">BX</span>                 <span class="c1"># BX=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45523f</span>        <span class="mi">48895</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">BX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>       <span class="c1"># i=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455244</span>        <span class="no">ebc7</span>                <span class="no">JMP</span> <span class="mi">0x45520d</span>            <span class="c1"># &lt;--- ä¸€è½®å¾ªç¯ç»“æŸè·³è½¬å¾ªç¯å¼€å¤´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455246</span>        <span class="mi">488</span><span class="no">b6c2428</span>          <span class="no">MOVQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45524b</span>        <span class="mi">4883</span><span class="no">c430</span>            <span class="no">ADDQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45524f</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fs</span><span class="p">[</span><span class="no">i</span><span class="p">]()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455250</span>        <span class="no">b902000000</span>          <span class="no">MOVL</span> <span class="no">$0x2</span><span class="p">,</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455255</span>        <span class="no">e866d4ffff</span>          <span class="no">CALL</span> <span class="no">runtime.panicIndex</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45525a</span>        <span class="mi">90</span>                  <span class="no">NOPL</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45525b</span>        <span class="mi">0</span><span class="no">f1f440000</span>          <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)(</span><span class="no">AX</span><span class="p">*</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455260</span>        <span class="no">e8fbccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455265</span>        <span class="no">e976ffffff</span>          <span class="no">JMP</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>create æ±‡ç¼–ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">create</span><span class="p">()</span> <span class="p">(</span><span class="no">fs</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="no">func</span><span class="p">())</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455280</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455284</span>        <span class="mi">0</span><span class="no">f86d0000000</span>        <span class="no">JBE</span> <span class="mi">0x45535a</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528a</span>        <span class="mi">4883</span><span class="no">ec28</span>            <span class="no">SUBQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528e</span>        <span class="mi">48896</span><span class="no">c2420</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455293</span>        <span class="mi">488</span><span class="no">d6c2420</span>          <span class="no">LEAQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455298</span>        <span class="mi">440</span><span class="no">f117c2430</span>        <span class="no">MOVUPS</span> <span class="no">X15</span><span class="p">,</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>        <span class="c1"># 0x30(SP)å¼€å§‹çš„16Båœ°å€æ¸…é›¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">for</span> <span class="no">i</span> <span class="p">:</span><span class="err">=</span> <span class="mi">0</span><span class="c1">; i &lt; 2; i++ {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45529e</span>        <span class="mi">488</span><span class="no">d059b4a0000</span>      <span class="no">LEAQ</span> <span class="mi">0x4a9b</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>         <span class="c1"># AX=0x4a9b(IP)ï¼Œintçš„å…ƒç±»å‹    &lt;--- å˜é‡iåˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552a5</span>        <span class="no">e8965cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># å˜é‡iç”³è¯·å†…å­˜ï¼ŒAXè¿”å› *int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552aa</span>        <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552af</span>        <span class="mi">48</span><span class="no">c70000000000</span>      <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>            <span class="c1"># iå˜é‡èµ‹å€¼0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552b6</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x4552b8</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552b8</span>        <span class="mi">488</span><span class="no">b4c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>           <span class="c1"># CX=&amp;i &lt;--- å¾ªç¯ä»è¿™é‡Œå¼€å§‹ï¼Œåé¢æ»¡è¶³æ¡ä»¶ä¼šè·³è½¬å›æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552bd</span>        <span class="mi">48833902</span>            <span class="no">CMPQ</span> <span class="no">$0x2</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>            <span class="c1"># iä¸2æ¯”è¾ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552c1</span>        <span class="mi">7</span><span class="no">c05</span>                <span class="no">JL</span> <span class="mi">0x4552c8</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552c3</span>        <span class="no">e97d000000</span>          <span class="no">JMP</span> <span class="mi">0x455345</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fs</span><span class="p">[</span><span class="no">i</span><span class="p">]</span> <span class="err">=</span> <span class="no">func</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># struct { F uintptr; i *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552c8</span>        <span class="mi">488</span><span class="no">d0511740000</span>      <span class="no">LEAQ</span> <span class="mi">0x7411</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>         <span class="c1"># AX=0x7411(IP)ï¼Œfuncvalå…ƒç±»å‹ å†…å­˜16B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552cf</span>        <span class="no">e86c5cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># ç”³è¯·å†…å­˜16Bï¼ŒAX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552d4</span>        <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552d9</span>        <span class="mi">488</span><span class="no">d0da0000000</span>      <span class="no">LEAQ</span> <span class="no">main.create.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">CX</span>  <span class="c1"># CX=main.create.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552e0</span>        <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>              <span class="c1"># funcval.fn=main.create.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552e3</span>        <span class="mi">488</span><span class="no">b4c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>           <span class="c1"># CX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552e8</span>        <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552ea</span>        <span class="mi">488</span><span class="no">b542418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>           <span class="c1"># DX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552ef</span>        <span class="mi">488</span><span class="no">d7908</span>            <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">DI</span>            <span class="c1"># DI=funcval.data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552f3</span>        <span class="mi">833</span><span class="no">d661f090000</span>      <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="c1"># æ£€æŸ¥å†™å±éšœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552fa</span>        <span class="mi">7402</span>                <span class="no">JE</span> <span class="mi">0x4552fe</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552fc</span>        <span class="no">eb06</span>                <span class="no">JMP</span> <span class="mi">0x455304</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552fe</span>        <span class="mi">48895108</span>            <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>            <span class="c1"># funcval.data=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455302</span>        <span class="no">eb07</span>                <span class="no">JMP</span> <span class="mi">0x45530b</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455304</span>        <span class="no">e837d0ffff</span>          <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrierDX</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="c1"># è°ƒç”¨å†™å±éšœå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455309</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x45530b</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45530b</span>        <span class="mi">488</span><span class="no">b542418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>           <span class="c1"># DX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455310</span>        <span class="mi">488</span><span class="no">b02</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">AX</span>              <span class="c1"># AX=0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455313</span>        <span class="mi">488</span><span class="no">b542410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>           <span class="c1"># DX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455318</span>        <span class="mi">4883</span><span class="no">f802</span>            <span class="no">CMPQ</span> <span class="no">$0x2</span><span class="p">,</span> <span class="no">AX</span>               <span class="c1"># AXå’Œ2æ¯”è¾ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45531c</span>        <span class="mi">7204</span>                <span class="no">JB</span> <span class="mi">0x455322</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45531e</span>        <span class="mi">6690</span>                <span class="no">NOPW</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455320</span>        <span class="no">eb2d</span>                <span class="no">JMP</span> <span class="mi">0x45534f</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455322</span>        <span class="mi">488</span><span class="no">d4cc430</span>          <span class="no">LEAQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">)(</span><span class="no">AX</span><span class="p">*</span><span class="mi">8</span><span class="p">),</span> <span class="no">CX</span>     <span class="c1"># CX=0x30(SP)(AX*8)ï¼ŒAX=0 -&gt; 0x30(SP)ï¼ŒAX=1 -&gt; 0x38(SP)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455327</span>        <span class="mi">488911</span>              <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>              <span class="c1"># è¿”å›æ•°ç»„éå†èµ‹å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45532a</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x45532c</span>
</span></span><span class="line"><span class="cl">    <span class="nf">for</span> <span class="no">i</span> <span class="p">:</span><span class="err">=</span> <span class="mi">0</span><span class="c1">; i &lt; 2; i++ {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45532c</span>        <span class="mi">488</span><span class="no">b4c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>           <span class="c1"># CX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455331</span>        <span class="mi">488</span><span class="no">b09</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">CX</span>              <span class="c1"># CX=0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455334</span>        <span class="mi">488</span><span class="no">b542418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>           <span class="c1"># DX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455339</span>        <span class="mi">48</span><span class="no">ffc1</span>              <span class="no">INCQ</span> <span class="no">CX</span>                     <span class="c1"># CX=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45533c</span>        <span class="mi">48890</span><span class="no">a</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">)</span>              <span class="c1"># ièµ‹å€¼1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45533f</span>        <span class="mi">90</span>                  <span class="no">NOPL</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455340</span>        <span class="no">e973ffffff</span>          <span class="no">JMP</span> <span class="mi">0x4552b8</span>                <span class="c1"># è·³è½¬åˆ°å‰é¢å¼€å§‹ä¸‹ä¸€è½®å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">return</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455345</span>        <span class="mi">488</span><span class="no">b6c2420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45534a</span>        <span class="mi">4883</span><span class="no">c428</span>            <span class="no">ADDQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45534e</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fs</span><span class="p">[</span><span class="no">i</span><span class="p">]</span> <span class="err">=</span> <span class="no">func</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45534f</span>        <span class="no">b902000000</span>          <span class="no">MOVL</span> <span class="no">$0x2</span><span class="p">,</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455354</span>        <span class="no">e867d3ffff</span>          <span class="no">CALL</span> <span class="no">runtime.panicIndex</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455359</span>        <span class="mi">90</span>                  <span class="no">NOPL</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">create</span><span class="p">()</span> <span class="p">(</span><span class="no">fs</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="no">func</span><span class="p">())</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45535a</span>        <span class="no">e801ccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45535f</span>        <span class="mi">90</span>                  <span class="no">NOPL</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455360</span>        <span class="no">e91bffffff</span>          <span class="no">JMP</span> <span class="no">main.create</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>mainå’Œcreateçš„æ ˆå¸ƒå±€ã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">          |   runtime.main callback
</span></span><span class="line"><span class="cl">          ---------------------------
</span></span><span class="line"><span class="cl">  +58 +28 |   runtime.main BP
</span></span><span class="line"><span class="cl">          --------------------------- BP      ---------------
</span></span><span class="line"><span class="cl">  +50 +20 |   &amp;funcval            c.r
</span></span><span class="line"><span class="cl">          ---------------------------
</span></span><span class="line"><span class="cl">  +48 +18 |   &amp;funcval            c.r
</span></span><span class="line"><span class="cl">          ---------------------------
</span></span><span class="line"><span class="cl">  +40 +10 |   0x0                 i           main.mainæ ˆ
</span></span><span class="line"><span class="cl">          ---------------------------
</span></span><span class="line"><span class="cl">  +38 +08 |   &amp;funcval            fs[1]
</span></span><span class="line"><span class="cl">          ---------------------------
</span></span><span class="line"><span class="cl">  +30 +00 |   &amp;funcval            fs[0]
</span></span><span class="line"><span class="cl">          --------------------------- SP      ---------------
</span></span><span class="line"><span class="cl">  +28     |   main.main callback
</span></span><span class="line"><span class="cl">          ---------------------------
</span></span><span class="line"><span class="cl">  +20     |   main.main BP
</span></span><span class="line"><span class="cl">          --------------------------- BP      ---------------
</span></span><span class="line"><span class="cl">  +18     |   *int    -&gt; 0 1      i
</span></span><span class="line"><span class="cl">          ---------------------------
</span></span><span class="line"><span class="cl">  +10     |   &amp;funcval
</span></span><span class="line"><span class="cl">          ---------------------------         main.createæ ˆ
</span></span><span class="line"><span class="cl">  +08     |
</span></span><span class="line"><span class="cl">          ---------------------------
</span></span><span class="line"><span class="cl">  +00     |
</span></span><span class="line"><span class="cl">          --------------------------- SP      ---------------
</span></span></code></pre></div><p><img loading="lazy" src="../images/func-010.png" alt=""  />
</p>
</blockquote>
</details></p>

<h3 id="æ•è·å‚æ•°">æ•è·å‚æ•°<a hidden class="anchor" aria-hidden="true" href="#æ•è·å‚æ•°">#</a></h3>
<ol>
<li>
<p>å¦‚æœæ˜¯å‚æ•°è¢«æ•è·ï¼Œé‚£ä¹ˆè°ƒç”¨è€…ä¾ç„¶ä»æ ˆä¸Šä¼ é€’å‚æ•°ï¼Œä½†æ˜¯è¢«è°ƒç”¨å‡½æ•°ä¼šæŠŠå®ƒæ‹·è´åˆ°å †ä¸Šä¸€ä»½ï¼Œç„¶åå’Œé—­åŒ…å‡½æ•°éƒ½ä½¿ç”¨å †ä¸Šåˆ†é…çš„é‚£ä¸€ä¸ªã€‚</p>
</li>
<li>
<p>å€¼ä¼ é€’å‚æ•°æ—¶ã€‚</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Te1</span><span class="p">(</span><span class="nx">a</span> <span class="kt">int</span><span class="p">)</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span> <span class="c1">// æ­¤æ—¶çš„aå‚æ•°åœ¨å †ä¸Šåˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿”å›é—­åŒ…æ•è·äº†å‡½æ•°å‚æ•°ï¼Œå‚æ•°aä¼šè¢«å¤åˆ¶åˆ°å †ä¸Šä¾›æ•´ä¸ªTe1å‡½æ•°åŠè¿”å›é—­åŒ…ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å †åˆ†é… struct { F uintptr; a *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">a</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">a</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">a1</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span> <span class="o">:=</span> <span class="nf">Te1</span><span class="p">(</span><span class="nx">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nf">f</span><span class="p">())</span> <span class="c1">// 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">a1</span><span class="p">)</span>  <span class="c1">// 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// å¯ä»¥çœ‹å‡º å‚æ•°è¢«é—­åŒ…æ•è·å…³ç³»çš„åªæ˜¯æ•è·å‡½æ•°å†…ç›¸å…³å‚æ•°ï¼Œå‚çœ‹ä¸‹é¢æ±‡ç¼–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/func-011.png" alt=""  />
</p>


<p><details >
  <summary markdown="span">å€¼ä¼ é€’å‚æ•°</summary>
  <blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a1</span> <span class="o">:=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span> <span class="o">:=</span> <span class="nf">Te1</span><span class="p">(</span><span class="nx">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">b</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Te1</span><span class="p">(</span><span class="nx">a</span> <span class="kt">int</span><span class="p">)</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿”å›é—­åŒ…æ•è·äº†å‡½æ•°å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å‚æ•°aä¼šè¢«å¤åˆ¶åˆ°å †ä¸Šä¾›æ•´ä¸ªTe1å‡½æ•°åŠè¿”å›é—­åŒ…ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// struct { F uintptr; a *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ ¹æ®æ±‡ç¼–å¯è§ï¼ŒTe1å †åˆ†é…äº†aï¼Œå¹¶æŠŠä¼ å…¥çš„å‚æ•°1æ‹·è´ç»™äº†aã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">a</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">a</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>main å‡½æ•°æ±‡ç¼–ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e0</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e4</span>        <span class="mi">7638</span>                <span class="no">JBE</span> <span class="mi">0x45521e</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e6</span>        <span class="mi">4883</span><span class="no">ec20</span>            <span class="no">SUBQ</span> <span class="no">$0x20</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ea</span>        <span class="mi">48896</span><span class="no">c2418</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ef</span>        <span class="mi">488</span><span class="no">d6c2418</span>          <span class="no">LEAQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">a1</span> <span class="p">:</span><span class="err">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551f4</span>        <span class="mi">48</span><span class="no">c744240801000000</span>  <span class="no">MOVQ</span> <span class="no">$0x1</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>      <span class="c1"># a1=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">b</span> <span class="p">:</span><span class="err">=</span> <span class="no">Te1</span><span class="p">(</span><span class="no">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551fd</span>        <span class="no">b801000000</span>          <span class="no">MOVL</span> <span class="no">$0x1</span><span class="p">,</span> <span class="no">AX</span>           <span class="c1"># AX=0x1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455202</span>        <span class="no">e839000000</span>          <span class="no">CALL</span> <span class="no">main.Te1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>       <span class="c1"># è°ƒç”¨å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455207</span>        <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">b</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520c</span>        <span class="mi">488</span><span class="no">b08</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">),</span> <span class="no">CX</span>          <span class="c1"># CX=funcval.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45520f</span>        <span class="mi">4889</span><span class="no">c2</span>              <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="no">DX</span>             <span class="c1"># DX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455212</span>        <span class="no">ffd1</span>                <span class="no">CALL</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455214</span>        <span class="mi">488</span><span class="no">b6c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455219</span>        <span class="mi">4883</span><span class="no">c420</span>            <span class="no">ADDQ</span> <span class="no">$0x20</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45521d</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45521e</span>        <span class="mi">6690</span>                <span class="no">NOPW</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>        <span class="no">e83bcdffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455225</span>        <span class="no">ebb9</span>                <span class="no">JMP</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>main.Te1 å‡½æ•°æ±‡ç¼–ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">Te1</span><span class="p">(</span><span class="no">a</span> <span class="no">int</span><span class="p">)</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455240</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455244</span>        <span class="mi">0</span><span class="no">f8691000000</span>        <span class="no">JBE</span> <span class="mi">0x4552db</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45524a</span>        <span class="mi">4883</span><span class="no">ec30</span>            <span class="no">SUBQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45524e</span>        <span class="mi">48896</span><span class="no">c2428</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455253</span>        <span class="mi">488</span><span class="no">d6c2428</span>          <span class="no">LEAQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455258</span>        <span class="mi">4889442438</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>           <span class="c1"># å‚æ•°a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45525d</span>        <span class="mi">48</span><span class="no">c744241000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455266</span>        <span class="mi">488</span><span class="no">d05d34a0000</span>      <span class="no">LEAQ</span> <span class="mi">0x4ad3</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>         <span class="c1"># AX=0x4ad3(IP)ï¼Œintå…ƒç±»å‹ï¼Œå‚æ•°aå †åˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45526d</span>        <span class="no">e8ce5cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># ç”³è¯·å†…å­˜ AX=&amp;int     *int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455272</span>        <span class="mi">4889442420</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>           <span class="c1"># å †åˆ†é…çš„å˜é‡a *int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455277</span>        <span class="mi">488</span><span class="no">b4c2438</span>          <span class="no">MOVQ</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>           <span class="c1"># CX=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45527c</span>        <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>              <span class="c1"># AX=&amp;int -&gt; 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># struct { F uintptr; a *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45527f</span>        <span class="mi">488</span><span class="no">d055a740000</span>      <span class="no">LEAQ</span> <span class="mi">0x745a</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>         <span class="c1"># AX=0x745a(IP)ï¼Œfuncvalç»“æ„ä½“å…ƒç±»å‹ï¼Œå 16B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455286</span>        <span class="no">e8b55cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># ç”³è¯·å†…å­˜ï¼ŒAX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45528b</span>        <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455290</span>        <span class="mi">488</span><span class="no">d0d69000000</span>      <span class="no">LEAQ</span> <span class="no">main.Te1.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">CX</span> <span class="c1"># CX=main.Te1.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455297</span>        <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>              <span class="c1"># funcval.fn=main.Te1.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45529a</span>        <span class="mi">488</span><span class="no">b4c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>           <span class="c1"># CX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45529f</span>        <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552a1</span>        <span class="mi">488</span><span class="no">b542420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>           <span class="c1"># DX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552a6</span>        <span class="mi">488</span><span class="no">d7908</span>            <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">DI</span>            <span class="c1"># DI=funcval.data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552aa</span>        <span class="mi">833</span><span class="no">daf1f090000</span>      <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552b1</span>        <span class="mi">7402</span>                <span class="no">JE</span> <span class="mi">0x4552b5</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552b3</span>        <span class="no">eb0b</span>                <span class="no">JMP</span> <span class="mi">0x4552c0</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552b5</span>        <span class="mi">48895108</span>            <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>            <span class="c1"># funcval.data=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552b9</span>        <span class="no">eb0c</span>                <span class="no">JMP</span> <span class="mi">0x4552c7</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552bb</span>        <span class="mi">0</span><span class="no">f1f440000</span>          <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)(</span><span class="no">AX</span><span class="p">*</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552c0</span>        <span class="no">e87bd0ffff</span>          <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrierDX</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552c5</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x4552c7</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552c7</span>        <span class="mi">488</span><span class="no">b442418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>           <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552cc</span>        <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552d1</span>        <span class="mi">488</span><span class="no">b6c2428</span>          <span class="no">MOVQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552d6</span>        <span class="mi">4883</span><span class="no">c430</span>            <span class="no">ADDQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552da</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">Te1</span><span class="p">(</span><span class="no">a</span> <span class="no">int</span><span class="p">)</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552db</span>        <span class="mi">4889442408</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552e0</span>        <span class="no">e87bccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552e5</span>        <span class="mi">488</span><span class="no">b442408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552ea</span>        <span class="no">e951ffffff</span>          <span class="no">JMP</span> <span class="no">main.Te1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>main.Te1.func1 å‡½æ•°æ±‡ç¼–ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.Te1.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl">  <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x455300</span>      <span class="mi">4883</span><span class="no">ec18</span>            <span class="no">SUBQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl"><span class="mi">0x455304</span>      <span class="mi">48896</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl"><span class="mi">0x455309</span>      <span class="mi">488</span><span class="no">d6c2410</span>          <span class="no">LEAQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl"><span class="mi">0x45530e</span>      <span class="mi">488</span><span class="no">b4a08</span>            <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">CX</span>    
</span></span><span class="line"><span class="cl"><span class="mi">0x455312</span>      <span class="mi">48894</span><span class="no">c2408</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl"><span class="mi">0x455317</span>      <span class="mi">48</span><span class="no">c7042400000000</span>    <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">      <span class="no">a</span><span class="err">++</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x45531f</span>      <span class="mi">488</span><span class="no">b4c2408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>    
</span></span><span class="line"><span class="cl"><span class="mi">0x455324</span>      <span class="mi">488</span><span class="no">b09</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">CX</span>        
</span></span><span class="line"><span class="cl"><span class="mi">0x455327</span>      <span class="mi">488</span><span class="no">b542408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>    
</span></span><span class="line"><span class="cl"><span class="mi">0x45532c</span>      <span class="mi">48</span><span class="no">ffc1</span>              <span class="no">INCQ</span> <span class="no">CX</span>            
</span></span><span class="line"><span class="cl"><span class="mi">0x45532f</span>      <span class="mi">48890</span><span class="no">a</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">      <span class="no">return</span> <span class="no">a</span>
</span></span><span class="line"><span class="cl"><span class="err">0</span><span class="nf">x455332</span>      <span class="mi">488</span><span class="no">b4c2408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>    
</span></span><span class="line"><span class="cl"><span class="mi">0x455337</span>      <span class="mi">488</span><span class="no">b01</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">AX</span>        
</span></span><span class="line"><span class="cl"><span class="mi">0x45533a</span>      <span class="mi">48890424</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl"><span class="mi">0x45533e</span>      <span class="mi">488</span><span class="no">b6c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl"><span class="mi">0x455343</span>      <span class="mi">4883</span><span class="no">c418</span>            <span class="no">ADDQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl"><span class="mi">0x455347</span>      <span class="no">c3</span>                  <span class="no">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>æ ˆå¸ƒå±€ä¿¡æ¯ã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">  +58 +20 |   runtime.main callback
</span></span><span class="line"><span class="cl">          ----------------------------------
</span></span><span class="line"><span class="cl">  +50 +18 |   runtime.main BP
</span></span><span class="line"><span class="cl">          ----------------------------------  BP      --------------
</span></span><span class="line"><span class="cl">  +48 +10 |   &amp;funcval                å˜é‡b
</span></span><span class="line"><span class="cl">          ----------------------------------
</span></span><span class="line"><span class="cl">  +40 +08 |   0x1                     å˜é‡a1           main.mainæ ˆ
</span></span><span class="line"><span class="cl">          ----------------------------------
</span></span><span class="line"><span class="cl">  +38 +00 |   0x1                     å‚æ•°a
</span></span><span class="line"><span class="cl">          ----------------------------------  SP      --------------
</span></span><span class="line"><span class="cl">  +30     |   main.main callback
</span></span><span class="line"><span class="cl">          ----------------------------------
</span></span><span class="line"><span class="cl">  +28     |   main.main BP
</span></span><span class="line"><span class="cl">          ----------------------------------  BP      --------------
</span></span><span class="line"><span class="cl">  +20     |   &amp;int    -&gt; 1            a
</span></span><span class="line"><span class="cl">          ----------------------------------
</span></span><span class="line"><span class="cl">  +18     |   &amp;funcval                r.o
</span></span><span class="line"><span class="cl">          ----------------------------------
</span></span><span class="line"><span class="cl">  +10        |   &amp;funcval                r                main.Te1æ ˆ
</span></span><span class="line"><span class="cl">          ----------------------------------
</span></span><span class="line"><span class="cl">  +08     |
</span></span><span class="line"><span class="cl">          ----------------------------------
</span></span><span class="line"><span class="cl">  +00     |
</span></span><span class="line"><span class="cl">          ----------------------------------  SP      --------------
</span></span></code></pre></div></blockquote>

</details></p>

<ol start="3">
<li>å¼•ç”¨ä¼ é€’å‚æ•°æ—¶ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// å¦‚æœæ•è·çš„æ˜¯æŒ‡é’ˆæƒ…å†µå‘¢ï¼Œæ ¹æ®ä¸‹é¢ä»£ç å¯ä»¥çœ‹å‡ºè·Ÿä¸Šé¢æƒ…å†µä¸€æ ·çš„è§„åˆ™
</span></span></span><span class="line"><span class="cl"><span class="c1">// è¿™ç§æƒ…å†µè·Ÿæ•è·å…¨å±€å˜é‡åŸºæœ¬è¡¨ç°ä¸€è‡´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Te1</span><span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="kt">int</span><span class="p">)</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿”å›é—­åŒ…æ•è·äº†å‡½æ•°å‚æ•°ï¼Œå‚æ•°aä¼šè¢«å¤åˆ¶åˆ°æ ˆä¸Šä¾›æ•´ä¸ªTe1å‡½æ•°åŠè¿”å›é—­åŒ…ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å †åˆ†é… struct { F uintptr; a *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="nx">a</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">*</span><span class="nx">a</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">a1</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span> <span class="o">:=</span> <span class="nf">Te1</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">a1</span><span class="p">)</span>  <span class="c1">// 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nf">f</span><span class="p">())</span> <span class="c1">// 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">a1</span><span class="p">)</span>  <span class="c1">// 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">a1</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nf">f</span><span class="p">())</span> <span class="c1">// 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">a1</span><span class="p">)</span>  <span class="c1">// 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ³¨æ„è¿™é‡Œä¸‹é¢çš„ä¸€è¡Œä»£ç ï¼Œä¼šå…ˆæ‰§è¡Œf() f() åœ¨æ‰“å°æ‰€ä»¥å‡ºç°äº†å¥‡æ€ªçš„è¾“å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› ä¸ºå‚æ•°ä¼šå…ˆè¢«å®æ—¶è®¡ç®—ï¼Œå› æ­¤å…ˆæ‰§è¡Œäº†f()å’Œf()ï¼Œç„¶åå†æ‰“å°æ•°æ®çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// fmt.Println(a1, f(), a1, f(), a1) // 2 1 2 2 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/func-012.png" alt=""  />
</p>


<p><details >
  <summary markdown="span">å¼•ç”¨ä¼ é€’å‚æ•°</summary>
  <blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a1</span> <span class="o">:=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span> <span class="o">:=</span> <span class="nf">Te1</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">b</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Te1</span><span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="kt">int</span><span class="p">)</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿”å›é—­åŒ…æ•è·äº†å‡½æ•°å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å‚æ•°aä¼šè¢«å¤åˆ¶åˆ°å †ä¸Šä¾›æ•´ä¸ªTe1å‡½æ•°åŠè¿”å›é—­åŒ…ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// struct { F uintptr; a *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="nx">a</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">*</span><span class="nx">a</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>main å‡½æ•°æ±‡ç¼–ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e0</span>      <span class="mi">493</span><span class="no">b6610</span>              <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e4</span>      <span class="mi">764</span><span class="no">c</span>                  <span class="no">JBE</span> <span class="mi">0x455232</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e6</span>      <span class="mi">4883</span><span class="no">ec28</span>              <span class="no">SUBQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ea</span>      <span class="mi">48896</span><span class="no">c2420</span>            <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ef</span>      <span class="mi">488</span><span class="no">d6c2420</span>            <span class="no">LEAQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">a1</span> <span class="p">:</span><span class="err">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œç›´æ¥å°±ç»™aå †åˆ†é…äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551f4</span>        <span class="mi">488</span><span class="no">d05454b0000</span>      <span class="no">LEAQ</span> <span class="mi">0x4b45</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>         <span class="c1"># AX=0x4b45(IP)ï¼Œintå…ƒç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551fb</span>        <span class="mi">0</span><span class="no">f1f440000</span>          <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)(</span><span class="no">AX</span><span class="p">*</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455200</span>        <span class="no">e83b5dfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># AX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455205</span>        <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520a</span>        <span class="mi">48</span><span class="no">c70001000000</span>      <span class="no">MOVQ</span> <span class="no">$0x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>            <span class="c1"># a=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">b</span> <span class="p">:</span><span class="err">=</span> <span class="no">Te1</span><span class="p">(</span><span class="err">&amp;</span><span class="no">a1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455211</span>        <span class="mi">488</span><span class="no">b442418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>           <span class="c1"># AX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455216</span>        <span class="no">e825000000</span>          <span class="no">CALL</span> <span class="no">main.Te1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>           <span class="c1"># è°ƒç”¨å‡½æ•°ï¼ŒAX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45521b</span>        <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">b</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>        <span class="mi">488</span><span class="no">b08</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">),</span> <span class="no">CX</span>              <span class="c1"># CX=funcval.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455223</span>        <span class="mi">4889</span><span class="no">c2</span>              <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="no">DX</span>                 <span class="c1"># DX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455226</span>        <span class="no">ffd1</span>                <span class="no">CALL</span> <span class="no">CX</span>                     <span class="c1"># è°ƒç”¨å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455228</span>        <span class="mi">488</span><span class="no">b6c2420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45522d</span>        <span class="mi">4883</span><span class="no">c428</span>            <span class="no">ADDQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455231</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455232</span>        <span class="no">e829cdffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455237</span>        <span class="no">eba7</span>                <span class="no">JMP</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>main.Te1 å‡½æ•°æ±‡ç¼–ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">Te1</span><span class="p">(</span><span class="no">a</span> <span class="p">*</span><span class="no">int</span><span class="p">)</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455240</span>     <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455244</span>     <span class="mi">7675</span>                <span class="no">JBE</span> <span class="mi">0x4552bb</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455246</span>     <span class="mi">4883</span><span class="no">ec28</span>            <span class="no">SUBQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x45524a</span>     <span class="mi">48896</span><span class="no">c2420</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x45524f</span>     <span class="mi">488</span><span class="no">d6c2420</span>          <span class="no">LEAQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455254</span>     <span class="mi">4889442430</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>       <span class="c1"># å‚æ•°a *int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x455259</span>     <span class="mi">48</span><span class="no">c744241000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>     <span class="c1"># è¿”å›å€¼ func() int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1"># struct { F uintptr; i *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x455262</span>     <span class="mi">488</span><span class="no">d0577740000</span>      <span class="no">LEAQ</span> <span class="mi">0x7477</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>     <span class="c1"># AX=0x7477(IP)ï¼Œfuncvalç»“æ„ä½“ 16B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x455269</span>     <span class="no">e8d25cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span>   <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x45526e</span>     <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455273</span>     <span class="mi">488</span><span class="no">d0d66000000</span>      <span class="no">LEAQ</span> <span class="no">main.Te1.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">CX</span> <span class="c1"># CX=main.Te1.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x45527a</span>     <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>              <span class="c1"># funcval.fn=main.Te1.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x45527d</span>     <span class="mi">488</span><span class="no">b4c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>           <span class="c1"># CX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x455282</span>     <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455284</span>     <span class="mi">488</span><span class="no">b542430</span>          <span class="no">MOVQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>           <span class="c1"># DX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x455289</span>     <span class="mi">488</span><span class="no">d7908</span>            <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">DI</span>            <span class="c1"># DI=funcval.data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x45528d</span>     <span class="mi">833</span><span class="no">dcc1f090000</span>      <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455294</span>     <span class="mi">7402</span>                <span class="no">JE</span> <span class="mi">0x455298</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455296</span>     <span class="no">eb08</span>                <span class="no">JMP</span> <span class="mi">0x4552a0</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455298</span>     <span class="mi">48895108</span>            <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>            <span class="c1"># funcval.data=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x45529c</span>     <span class="no">eb09</span>                <span class="no">JMP</span> <span class="mi">0x4552a7</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x45529e</span>     <span class="mi">6690</span>                <span class="no">NOPW</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552a0</span>     <span class="no">e89bd0ffff</span>          <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrierDX</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552a5</span>     <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x4552a7</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552a7</span>     <span class="mi">488</span><span class="no">b442418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>           <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x4552ac</span>     <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552b1</span>     <span class="mi">488</span><span class="no">b6c2420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552b6</span>     <span class="mi">4883</span><span class="no">c428</span>            <span class="no">ADDQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552ba</span>     <span class="no">c3</span>                  <span class="no">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>main.Te1.func1 å‡½æ•°æ±‡ç¼–ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">Te1</span><span class="p">(</span><span class="no">a</span> <span class="p">*</span><span class="no">int</span><span class="p">)</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552bb</span>     <span class="mi">4889442408</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552c0</span>     <span class="no">e89bccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552c5</span>     <span class="mi">488</span><span class="no">b442408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552ca</span>     <span class="no">e971ffffff</span>          <span class="no">JMP</span> <span class="no">main.Te1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552e0</span>     <span class="mi">4883</span><span class="no">ec18</span>            <span class="no">SUBQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552e4</span>     <span class="mi">48896</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552e9</span>     <span class="mi">488</span><span class="no">d6c2410</span>          <span class="no">LEAQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552ee</span>     <span class="mi">488</span><span class="no">b4a08</span>            <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">CX</span>    <span class="c1"># CX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x4552f2</span>     <span class="mi">48894</span><span class="no">c2408</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552f7</span>     <span class="mi">48</span><span class="no">c7042400000000</span>    <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="err">*</span><span class="nf">a</span><span class="err">++</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x4552ff</span>     <span class="mi">488</span><span class="no">b4c2408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>    <span class="c1"># CX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x455304</span>     <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455306</span>     <span class="mi">488</span><span class="no">b542408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>    <span class="c1"># DX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x45530b</span>     <span class="mi">8402</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x45530d</span>     <span class="mi">488</span><span class="no">b09</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">CX</span>      <span class="c1"># CX=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x455310</span>     <span class="mi">48</span><span class="no">ffc1</span>              <span class="no">INCQ</span> <span class="no">CX</span>             <span class="c1"># CX=2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x455313</span>     <span class="mi">48890</span><span class="no">a</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">)</span>      <span class="c1"># &amp;int -&gt; 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="nf">return</span> <span class="p">*</span><span class="no">a</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455316</span>     <span class="mi">488</span><span class="no">b4c2408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>    <span class="c1"># CX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x45531b</span>     <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x45531d</span>     <span class="mi">488</span><span class="no">b01</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">AX</span>      <span class="c1"># AX=2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="err">0</span><span class="nf">x455320</span>     <span class="mi">48890424</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455324</span>     <span class="mi">488</span><span class="no">b6c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x455329</span>     <span class="mi">4883</span><span class="no">c418</span>            <span class="no">ADDQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl"> <span class="err">0</span><span class="nf">x45532d</span>     <span class="no">c3</span>                  <span class="no">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>æ ˆåˆ†å¸ƒæƒ…å†µã€‚</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">  +58 +28 |   address of runtime.main
</span></span><span class="line"><span class="cl">          ------------------------------
</span></span><span class="line"><span class="cl">  +50 +20 |   BP of runtime.main
</span></span><span class="line"><span class="cl">          ------------------------------  BP
</span></span><span class="line"><span class="cl">  +48 +18 |   &amp;int    -&gt; 1            a1
</span></span><span class="line"><span class="cl">          ------------------------------
</span></span><span class="line"><span class="cl">  +40 +10 |   &amp;funcval                b
</span></span><span class="line"><span class="cl">          ------------------------------
</span></span><span class="line"><span class="cl">  +38 +08 |
</span></span><span class="line"><span class="cl">          ------------------------------
</span></span><span class="line"><span class="cl">  +30 +00 |   &amp;int                    T.a
</span></span><span class="line"><span class="cl">          ------------------------------  SP
</span></span><span class="line"><span class="cl">  +28     |   address of main.main
</span></span><span class="line"><span class="cl">          ------------------------------
</span></span><span class="line"><span class="cl">  +20     |   BP of main.main
</span></span><span class="line"><span class="cl">          ------------------------------  BP
</span></span><span class="line"><span class="cl">  +18     |   &amp;funcval                T.o
</span></span><span class="line"><span class="cl">          ------------------------------
</span></span><span class="line"><span class="cl">  +10     |   &amp;funcval                T.r
</span></span><span class="line"><span class="cl">          ------------------------------
</span></span><span class="line"><span class="cl">  +08     |
</span></span><span class="line"><span class="cl">          ------------------------------
</span></span><span class="line"><span class="cl">  +00     |
</span></span><span class="line"><span class="cl">          ------------------------------  SP
</span></span></code></pre></div></blockquote>

</details></p>

<h3 id="æ•è·è¿”å›å€¼">æ•è·è¿”å›å€¼<a hidden class="anchor" aria-hidden="true" href="#æ•è·è¿”å›å€¼">#</a></h3>
<ol>
<li>å¦‚æœæ˜¯è¿”å›å€¼è¢«æ•è·ï¼Œé‚£ä¹ˆå¤„ç†æ–¹å¼å°±åˆæœ‰äº›ä¸åŒäº†ã€‚</li>
<li>è¿”å›å€¼ç©ºé—´ä¾ç„¶ç”±è°ƒç”¨è€…åœ¨æ ˆä¸Šåˆ†é…ï¼Œä½†æ˜¯è¢«è°ƒç”¨å‡½æ•°ï¼ˆé—­åŒ…çš„å¤–å±‚å‡½æ•°ï¼‰ä¼šåœ¨å †ä¸Šä¹Ÿåˆ†é…ä¸€ä¸ªï¼Œå¹¶ä¸”ä¸é—­åŒ…å‡½æ•°éƒ½ä½¿ç”¨å †ä¸Šè¿™ä¸€ä¸ªï¼Œä½†æ˜¯ï¼Œåœ¨å¤–å±‚å‡½æ•°è¿”å›å‰è¦æŠŠå †ä¸Šçš„è¿”å›å€¼æ‹·è´åˆ°æ ˆä¸Šé‚£ä¸€ä¸ªã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nf">Te1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">b</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Te1</span><span class="p">()</span> <span class="p">(</span><span class="nx">y</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">y1</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">y1</span><span class="o">++</span> <span class="c1">// 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å †åˆ†é… struct { F uintptr; y1 *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">y1</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="nx">y1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e0</span>      <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e4</span>      <span class="mi">763</span><span class="no">b</span>                <span class="no">JBE</span> <span class="mi">0x455221</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e6</span>      <span class="mi">4883</span><span class="no">ec18</span>            <span class="no">SUBQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ea</span>      <span class="mi">48896</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ef</span>      <span class="mi">488</span><span class="no">d6c2410</span>          <span class="no">LEAQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">b</span><span class="p">,</span> <span class="no">_</span> <span class="p">:</span><span class="err">=</span> <span class="no">Te1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551f4</span>      <span class="mi">48</span><span class="no">c744240800000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551fd</span>      <span class="mi">0</span><span class="no">f1f00</span>              <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455200</span>      <span class="no">e83b000000</span>          <span class="no">CALL</span> <span class="no">main.Te1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455205</span>      <span class="mi">4889442408</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520a</span>      <span class="mi">48890424</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">b</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520e</span>      <span class="mi">488</span><span class="no">b1424</span>            <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455212</span>      <span class="mi">488</span><span class="no">b02</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455215</span>      <span class="no">ffd0</span>                <span class="no">CALL</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455217</span>      <span class="mi">488</span><span class="no">b6c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45521c</span>      <span class="mi">4883</span><span class="no">c418</span>            <span class="no">ADDQ</span> <span class="no">$0x18</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>      <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455221</span>      <span class="no">e83acdffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455226</span>      <span class="no">ebb8</span>                <span class="no">JMP</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">Te1</span><span class="p">()</span> <span class="p">(</span><span class="no">y</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span><span class="p">,</span> <span class="no">y1</span> <span class="no">int</span><span class="p">)</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455240</span>      <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455244</span>      <span class="mi">0</span><span class="no">f868e000000</span>        <span class="no">JBE</span> <span class="mi">0x4552d8</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45524a</span>      <span class="mi">4883</span><span class="no">ec30</span>            <span class="no">SUBQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45524e</span>      <span class="mi">48896</span><span class="no">c2428</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455253</span>      <span class="mi">488</span><span class="no">d6c2428</span>          <span class="no">LEAQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455258</span>      <span class="mi">48</span><span class="no">c744241000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455261</span>      <span class="mi">488</span><span class="no">d05d84a0000</span>      <span class="no">LEAQ</span> <span class="mi">0x4ad8</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>         <span class="c1"># AX=0x4ad8(IP)ï¼Œintå…ƒç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455268</span>      <span class="no">e8d35cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># AX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45526d</span>      <span class="mi">4889442420</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">y1</span><span class="err">++</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455272</span>      <span class="mi">48</span><span class="no">ff00</span>              <span class="no">INCQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>                  <span class="c1"># y1=1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># struct { F uintptr; y1 *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455275</span>      <span class="mi">488</span><span class="no">d0564740000</span>      <span class="no">LEAQ</span> <span class="mi">0x7464</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>         <span class="c1"># AX=0x7464(IP)ï¼Œfuncvalå…ƒç±»å‹ 16B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45527c</span>      <span class="mi">0</span><span class="no">f1f4000</span>            <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455280</span>      <span class="no">e8bb5cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455285</span>      <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528a</span>      <span class="mi">488</span><span class="no">d0d6f000000</span>      <span class="no">LEAQ</span> <span class="no">main.Te1.func1</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">CX</span> <span class="c1"># CX=main.Te1.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455291</span>      <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>              <span class="c1"># funcval.fn=main.Te1.func1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455294</span>      <span class="mi">488</span><span class="no">b4c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>           <span class="c1"># CX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455299</span>      <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45529b</span>      <span class="mi">488</span><span class="no">b542420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>           <span class="c1"># DX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552a0</span>      <span class="mi">488</span><span class="no">d7908</span>            <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">DI</span>            <span class="c1"># DI=funcval.data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552a4</span>      <span class="mi">833</span><span class="no">db51f090000</span>      <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552ab</span>      <span class="mi">7402</span>                <span class="no">JE</span> <span class="mi">0x4552af</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552ad</span>      <span class="no">eb06</span>                <span class="no">JMP</span> <span class="mi">0x4552b5</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552af</span>      <span class="mi">48895108</span>            <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>            <span class="c1"># funcval.data=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552b3</span>      <span class="no">eb07</span>                <span class="no">JMP</span> <span class="mi">0x4552bc</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552b5</span>      <span class="no">e886d0ffff</span>          <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrierDX</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552ba</span>      <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x4552bc</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552bc</span>      <span class="mi">488</span><span class="no">b442418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>           <span class="c1"># AX=&amp;funcval  è¿”å›å‚æ•°1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552c1</span>      <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552c6</span>      <span class="mi">488</span><span class="no">b4c2420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>           <span class="c1"># CX=&amp;int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552cb</span>      <span class="mi">488</span><span class="no">b19</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">BX</span>              <span class="c1"># BX=1         è¿”å›å‚æ•°2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552ce</span>      <span class="mi">488</span><span class="no">b6c2428</span>          <span class="no">MOVQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552d3</span>      <span class="mi">4883</span><span class="no">c430</span>            <span class="no">ADDQ</span> <span class="no">$0x30</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552d7</span>      <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">Te1</span><span class="p">()</span> <span class="p">(</span><span class="no">y</span> <span class="no">func</span><span class="p">()</span> <span class="no">int</span><span class="p">,</span> <span class="no">y1</span> <span class="no">int</span><span class="p">)</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552d8</span>      <span class="no">e883ccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552dd</span>      <span class="mi">0</span><span class="no">f1f00</span>              <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552e0</span>      <span class="no">e95bffffff</span>          <span class="no">JMP</span> <span class="no">main.Te1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">    +50 +18 |   address of runtime.main
</span></span><span class="line"><span class="cl">            -----------------------------
</span></span><span class="line"><span class="cl">    +48 +10 |   BP of runtime.main
</span></span><span class="line"><span class="cl">            -----------------------------   BP
</span></span><span class="line"><span class="cl">    +40 +08 |   0
</span></span><span class="line"><span class="cl">            -----------------------------
</span></span><span class="line"><span class="cl">    +38 +00 |
</span></span><span class="line"><span class="cl">            -----------------------------   SP
</span></span><span class="line"><span class="cl">    +30     |   address of main.main
</span></span><span class="line"><span class="cl">            -----------------------------
</span></span><span class="line"><span class="cl">    +28     |   BP of main.main
</span></span><span class="line"><span class="cl">            -----------------------------   BP
</span></span><span class="line"><span class="cl">    +20     |   &amp;int    1           y1
</span></span><span class="line"><span class="cl">            -----------------------------
</span></span><span class="line"><span class="cl">    +18     |   &amp;funcval            y
</span></span><span class="line"><span class="cl">            -----------------------------
</span></span><span class="line"><span class="cl">    +10     |   &amp;funcval
</span></span><span class="line"><span class="cl">            -----------------------------
</span></span><span class="line"><span class="cl">    +08     |
</span></span><span class="line"><span class="cl">            -----------------------------
</span></span><span class="line"><span class="cl">    +00     |
</span></span><span class="line"><span class="cl">            -----------------------------   SP
</span></span></code></pre></div><p><img loading="lazy" src="../images/func-013.png" alt=""  />
</p>


<p><details >
  <summary markdown="span">è‡ªå·±æ•è·è‡ªå·±</summary>
  <blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">x</span><span class="p">()()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">x</span><span class="p">()</span> <span class="p">(</span><span class="nx">y</span> <span class="kd">func</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// struct { F uintptr }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">y</span> <span class="p">=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//println(&#34;y&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// deferåœ¨returnèµ‹å€¼å®Œæˆä¹‹åæ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//defer func() {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//	y = func() {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//        fmt.Println(&#34;æˆ‘èƒ½æ”¹å˜äº†Yçš„å€¼ï¼Ÿ&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//	}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//}()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// struct { F uintptr; y *func() }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//println(&#34;z&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">y</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>main æ±‡ç¼–ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e0</span>        <span class="mi">493</span><span class="no">b6610</span>        <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e4</span>        <span class="mi">7629</span>            <span class="no">JBE</span> <span class="mi">0x45520f</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e6</span>        <span class="mi">4883</span><span class="no">ec10</span>        <span class="no">SUBQ</span> <span class="no">$0x10</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ea</span>        <span class="mi">48896</span><span class="no">c2408</span>      <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551ef</span>        <span class="mi">488</span><span class="no">d6c2408</span>      <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">    <span class="nf">x</span><span class="p">()()</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551f4</span>        <span class="no">e847000000</span>      <span class="no">CALL</span> <span class="no">main.x</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>     <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551f9</span>        <span class="mi">48890424</span>        <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551fd</span>        <span class="mi">488</span><span class="no">b08</span>          <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">),</span> <span class="no">CX</span>      <span class="c1"># CX=funcval.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455200</span>        <span class="mi">4889</span><span class="no">c2</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="no">DX</span>        	<span class="c1"># DX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455203</span>        <span class="no">ffd1</span>            <span class="no">CALL</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455205</span>        <span class="mi">488</span><span class="no">b6c2408</span>      <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520a</span>        <span class="mi">4883</span><span class="no">c410</span>        <span class="no">ADDQ</span> <span class="no">$0x10</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520e</span>        <span class="no">c3</span>              <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45520f</span>        <span class="no">e84ccdffff</span>      <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455214</span>        <span class="no">ebca</span>        	<span class="no">JMP</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>x æ±‡ç¼–ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">x</span><span class="p">()</span> <span class="p">(</span><span class="no">y</span> <span class="no">func</span><span class="p">())</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455240</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455244</span>        <span class="mi">0</span><span class="no">f86bf000000</span>        <span class="no">JBE</span> <span class="mi">0x455309</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45524a</span>        <span class="mi">4883</span><span class="no">ec28</span>            <span class="no">SUBQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45524e</span>        <span class="mi">48896</span><span class="no">c2420</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455253</span>        <span class="mi">488</span><span class="no">d6c2420</span>          <span class="no">LEAQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># func()    å˜é‡y
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455258</span>        <span class="mi">488</span><span class="no">d05e1480000</span>      <span class="no">LEAQ</span> <span class="mi">0x48e1</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>               <span class="c1"># AX=0x48e1(IP)ï¼Œfuncvalå…ƒç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45525f</span>        <span class="mi">90</span>                  <span class="no">NOPL</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455260</span>        <span class="no">e8db5cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>        <span class="c1"># AX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455265</span>        <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">y</span> <span class="err">=</span> <span class="no">func</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45526a</span>        <span class="mi">833</span><span class="no">def1f090000</span>      <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455271</span>        <span class="mi">7402</span>                <span class="no">JE</span> <span class="mi">0x455275</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455273</span>        <span class="no">eb0d</span>                <span class="no">JMP</span> <span class="mi">0x455282</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># funcval.fn -&gt; println(&#34;y&#34;) æ›¿æ¢ y
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455275</span>        <span class="mi">488</span><span class="no">d0d841d0100</span>      <span class="no">LEAQ</span> <span class="mi">0x11d84</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">CX</span>   <span class="c1"># CX=0x11d84(IP)ï¼Œå‡½æ•°ä»£ç å¤„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45527c</span>        <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>         <span class="c1"># funcval.fn=0x11d84(IP)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45527f</span>        <span class="mi">90</span>                  <span class="no">NOPL</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455280</span>        <span class="no">eb11</span>                <span class="no">JMP</span> <span class="mi">0x455293</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455282</span>        <span class="mi">4889</span><span class="no">c7</span>              <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="no">DI</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455285</span>        <span class="mi">488</span><span class="no">d0d741d0100</span>      <span class="no">LEAQ</span> <span class="mi">0x11d74</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45528c</span>        <span class="no">e88fd0ffff</span>          <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrierCX</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455291</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x455293</span>
</span></span><span class="line"><span class="cl">    <span class="nf">return</span> <span class="no">func</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># struct { F uintptr; y *func() }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455293</span>        <span class="mi">488</span><span class="no">d0586740000</span>      <span class="no">LEAQ</span> <span class="mi">0x7486</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>          <span class="c1"># AX=0x7486(IP)ï¼Œfuncvalå…ƒç±»å‹ 16B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45529a</span>        <span class="no">e8a15cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>   <span class="c1"># AX=&amp;funcval.1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45529f</span>        <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552a4</span>        <span class="mi">488</span><span class="no">d0d75000000</span>      <span class="no">LEAQ</span> <span class="no">main.x.func2</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">CX</span>    <span class="c1"># CX=main.x.func2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552ab</span>        <span class="mi">488908</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>               <span class="c1"># funcval.1.fn=main.x.func2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552ae</span>        <span class="mi">488</span><span class="no">b4c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>            <span class="c1"># CX=&amp;funcval.1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552b3</span>        <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552b5</span>        <span class="mi">488</span><span class="no">b542418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>            <span class="c1"># DX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552ba</span>        <span class="mi">488</span><span class="no">d7908</span>            <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">DI</span>             <span class="c1"># DI=funcval.1.data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552be</span>        <span class="mi">833</span><span class="no">d9b1f090000</span>      <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552c5</span>        <span class="mi">7402</span>                <span class="no">JE</span> <span class="mi">0x4552c9</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552c7</span>        <span class="no">eb06</span>                <span class="no">JMP</span> <span class="mi">0x4552cf</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552c9</span>        <span class="mi">48895108</span>            <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>             <span class="c1"># funcval.1.data=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552cd</span>        <span class="no">eb07</span>                <span class="no">JMP</span> <span class="mi">0x4552d6</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552cf</span>        <span class="no">e86cd0ffff</span>          <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrierDX</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552d4</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x4552d6</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552d6</span>        <span class="mi">488</span><span class="no">b7c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DI</span>            <span class="c1"># DI=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552db</span>        <span class="mi">488</span><span class="no">b4c2410</span>          <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>            <span class="c1"># CX=&amp;funcval.1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552e0</span>        <span class="mi">833</span><span class="no">d791f090000</span>      <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552e7</span>        <span class="mi">7402</span>                <span class="no">JE</span> <span class="mi">0x4552eb</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552e9</span>        <span class="no">eb05</span>                <span class="no">JMP</span> <span class="mi">0x4552f0</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552eb</span>        <span class="mi">48890</span><span class="no">f</span>              <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">DI</span><span class="p">)</span>               <span class="c1"># funcval.fn=&amp;funcval.1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552ee</span>        <span class="no">eb07</span>                <span class="no">JMP</span> <span class="mi">0x4552f7</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552f0</span>        <span class="no">e82bd0ffff</span>          <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrierCX</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552f5</span>        <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x4552f7</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552f7</span>        <span class="mi">488</span><span class="no">b4c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>            <span class="c1"># CX=&amp;funcval
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552fc</span>        <span class="mi">488</span><span class="no">b01</span>              <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">AX</span>               <span class="c1"># AX=funcval.fn
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552ff</span>        <span class="mi">488</span><span class="no">b6c2420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455304</span>        <span class="mi">4883</span><span class="no">c428</span>            <span class="no">ADDQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455308</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">x</span><span class="p">()</span> <span class="p">(</span><span class="no">y</span> <span class="no">func</span><span class="p">())</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455309</span>        <span class="no">e852ccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45530e</span>        <span class="no">e92dffffff</span>          <span class="no">JMP</span> <span class="no">main.x</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/func-014.png" alt=""  />
</p>
</blockquote>
</details></p>

<h2 id="unsafe">unsafe<a hidden class="anchor" aria-hidden="true" href="#unsafe">#</a></h2>
<ol>
<li><code>Go</code>è¯­è¨€é‡Œ<code>Function Value</code>æœ¬è´¨ä¸Šæ˜¯æŒ‡å‘<code>funcval</code>ç»“æ„ä½“çš„æŒ‡é’ˆ</li>
<li><code>Go</code>è¯­è¨€é‡Œé—­åŒ…åªæ˜¯æ‹¥æœ‰æ•è·åˆ—è¡¨çš„<code>Function Value</code></li>
<li>æ•è·å˜é‡åœ¨å¤–å±‚å‡½æ•°ä¸é—­åŒ…å‡½æ•°ä¸­è¦ä¿æŒä¸€è‡´</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;unsafe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">fv</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fn</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl">    <span class="nx">i</span> <span class="o">*</span><span class="kt">int</span>  <span class="c1">// æ•è·çš„å˜é‡i
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">g</span> <span class="o">:=</span> <span class="nf">callback</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">fn</span> <span class="o">:=</span> <span class="o">**</span><span class="p">(</span><span class="o">**</span><span class="nx">fv</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">g</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%#v\n&#34;</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="nx">fn</span><span class="p">.</span><span class="nx">i</span><span class="p">))</span> <span class="c1">// 13
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Output:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// main.fv{fn:(unsafe.Pointer)(0xeccdc0), i:(*int)(0xc00000a098)}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 13
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// å¯ä»¥çœ‹å‡ºæ•è·çš„æ˜¯içš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">callback</span><span class="p">()</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">i</span> <span class="o">:=</span> <span class="mi">13</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// struct { F uintptr; i *int }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">i</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å‚è€ƒ">å‚è€ƒ<a hidden class="anchor" aria-hidden="true" href="#å‚è€ƒ">#</a></h2>
<ol>
<li>æœ¬ç¯‡æ–‡ç« å‚è€ƒäº†ã€Šæ·±åº¦æ¢ç´¢Goè¯­è¨€ã€‹ä¹¦å†…å®¹ã€‚</li>
<li>å‚è€ƒ <a href="https://mp.weixin.qq.com/s/hO0S4WcG0hUzCmMNMKtS-g" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/hO0S4WcG0hUzCmMNMKtS-g</a>ã€‚</li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://heliu.site/tags/golang/">Golang</a></li>
      <li><a href="https://heliu.site/tags/%E5%87%BD%E6%95%B0/">å‡½æ•°</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://heliu.site/posts/golang/func/align/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>å†…å­˜å¯¹é½å’Œé€ƒé€¸åˆ†æ</span>
  </a>
  <a class="next" href="https://heliu.site/posts/golang/func/defer-use/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>defer(ä½¿ç”¨)</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
    </span>
    <span id="busuanzi_container_site_uv">
        æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
    </span>
    </div>
        <span>Copyright Â© 2024 èœ€ICPå¤‡2024091074å· <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
