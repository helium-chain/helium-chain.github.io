<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>内存对齐和逃逸分析 | Helium</title>
<meta name="keywords" content="golang, 函数">
<meta name="description" content="💥本文章所有相关go代码参考自go 1.18&#43;版本">
<meta name="author" content="helium">
<link rel="canonical" href="https://heliu.site/posts/golang/func/align/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://heliu.site/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://heliu.site/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://heliu.site/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://heliu.site/apple-touch-icon.png">
<link rel="mask-icon" href="https://heliu.site/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://heliu.site/posts/golang/func/align/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="内存对齐和逃逸分析" />
<meta property="og:description" content="💥本文章所有相关go代码参考自go 1.18&#43;版本" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://heliu.site/posts/golang/func/align/" />
<meta property="og:image" content="https://heliu.site/favicon-32x32.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-08-05T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-08-05T00:00:00+00:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://heliu.site/favicon-32x32.png" />
<meta name="twitter:title" content="内存对齐和逃逸分析"/>
<meta name="twitter:description" content="💥本文章所有相关go代码参考自go 1.18&#43;版本"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://heliu.site/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Golang 合集",
      "item": "https://heliu.site/posts/golang/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "第9章 Function",
      "item": "https://heliu.site/posts/golang/func/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "内存对齐和逃逸分析",
      "item": "https://heliu.site/posts/golang/func/align/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "内存对齐和逃逸分析",
  "name": "内存对齐和逃逸分析",
  "description": "💥本文章所有相关go代码参考自go 1.18+版本",
  "keywords": [
    "golang", "函数"
  ],
  "articleBody": "内存对齐 在C语言函数调用中，通过栈传递的参数需要对齐到平台的位宽。 假如通过栈传递4个char类型的参数，GCC生成的 32 位程序需要 16 字节空间，64 位程序需要 32 字节栈空间。 如果传递大量参数，则这种对齐方式会存在很大的栈空间浪费。 Go语言函数栈帧中返回值和参数的对齐方式与 struct 类似，对于有返回值和参数的函数，可以把所有返回值和所有参数等价成两个 struct： 一个【返回值 struct】 和一个【参数 struct】。 因为内存对齐方式更加紧凑，所以在支持大量参数和返回值时能够做到较高的栈空间利用率。 通过如下示例可以验证函数参数和返回值的对齐方式与 struct 成员的对齐方式是一致的，代码如下： 以上的描述都是在函数通过栈传递参数和返回值的基础上的。在go1.18后版本中采用了寄存器传参。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 package main type args struct { a int8 // 1 b int64 // 8 c int32 // 4 d int16 // 2 } //go:noinline func f1(a args) (r args) { println(\u0026r.d, \u0026r.c, \u0026r.b, \u0026r.a, \u0026a.d, \u0026a.c, \u0026a.b, \u0026a.a) return } //go:noinline func f2(aa int8, ab int64, ac int32, ad int16) (ra int8, rb int64, rc int32, rd int16) { println(\u0026rd, \u0026rc, \u0026rb, \u0026ra, \u0026ad, \u0026ac, \u0026ab, \u0026aa) return } func main() { f1(args{}) // 0xc000034744 r.d // 0xc000034740 r.c // 0xc000034738 r.b // 0xc000034730 r.a // 0xc00003476c a.d // 0xc000034768 a.c // 0xc000034760 a.b // 0xc000034758 a.a f2(0, 0, 0, 0) // 0xc00003473a rd // 0xc00003473c rc // 0xc000034740 rb // 0xc000034739 ra // 0xc00003476c ad // 0xc000034768 ac // 0xc000034760 ab // 0xc000034758 aa } 汇编代码 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 TEXT main.main(SB) /mnt/hgfs/workspace/helium/main.go func main() { 0x4551e0 493b6610 CMPQ 0x10(R14), SP 0x4551e4 7657 JBE 0x45523d 0x4551e6 4883ec38 SUBQ $0x38, SP 0x4551ea 48896c2430 MOVQ BP, 0x30(SP) 0x4551ef 488d6c2430 LEAQ 0x30(SP), BP f1(args{}) 0x4551f4 c644241800 MOVB $0x0, 0x18(SP) # a.a 0x4551f9 48c744242000000000 MOVQ $0x0, 0x20(SP) # a.b 0x455202 c744242800000000 MOVL $0x0, 0x28(SP) # a.c 0x45520a 66c744242c0000 MOVW $0x0, 0x2c(SP) # a.d 0x455211 0fb6442418 MOVZX 0x18(SP), AX # a.a AX 0x455216 488b5c2420 MOVQ 0x20(SP), BX # a.b BX 0x45521b 8b4c2428 MOVL 0x28(SP), CX # a.c CX 0x45521f 31ff XORL DI, DI # a.d DI 0x455221 e83a000000 CALL main.f1(SB) f2(0, 0, 0, 0) 0x455226 31c0 XORL AX, AX # aa AX 0x455228 31db XORL BX, BX # ab BX 0x45522a 31c9 XORL CX, CX # ac CX 0x45522c 31ff XORL DI, DI # ad DI 0x45522e e8ad010000 CALL main.f2(SB) } 0x455233 488b6c2430 MOVQ 0x30(SP), BP 0x455238 4883c438 ADDQ $0x38, SP 0x45523c c3 RET func main() { 0x45523d 0f1f00 NOPL 0(AX) 0x455240 e81bcdffff CALL runtime.morestack_noctxt.abi0(SB) 0x455245 eb99 JMP main.main(SB) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 TEXT main.f1(SB) /mnt/hgfs/workspace/helium/main.go func f1(a args) (r args) { 0x4551e0 493b6610 CMPQ 0x10(R14), SP 0x4551e4 0f8642010000 JBE 0x45532c 0x4551ea 4883ec68 SUBQ $0x68, SP 0x4551ee 48896c2460 MOVQ BP, 0x60(SP) 0x4551f3 488d6c2460 LEAQ 0x60(SP), BP # 参数分配栈大小空间 0x4551f8 88442470 MOVB AL, 0x70(SP) # a.a 0x4551fc 48895c2478 MOVQ BX, 0x78(SP) # a.b 0x455201 898c2480000000 MOVL CX, 0x80(SP) # a.c 0x455208 6689bc2484000000 MOVW DI, 0x84(SP) # a.d # 返回值分配栈大小空间 0x455210 c644240800 MOVB $0x0, 0x8(SP) # r.a 0x455215 48c744241000000000 MOVQ $0x0, 0x10(SP) # r.b 0x45521e c744241800000000 MOVL $0x0, 0x18(SP) # r.c 0x455226 66c744241c0000 MOVW $0x0, 0x1c(SP) # r.d println(\u0026r.d, \u0026r.c, \u0026r.b, \u0026r.a, \u0026a.d, \u0026a.c, \u0026a.b, \u0026a.a) ... ... 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 TEXT main.f2(SB) /mnt/hgfs/workspace/helium/main.go func f2(aa int8, ab int64, ac int32, ad int16) (ra int8, rb int64, rc int32, rd int16) { 0x455360 493b6610 CMPQ 0x10(R14), SP 0x455364 0f8631010000 JBE 0x45549b 0x45536a 4883ec60 SUBQ $0x60, SP 0x45536e 48896c2458 MOVQ BP, 0x58(SP) 0x455373 488d6c2458 LEAQ 0x58(SP), BP # 参数传参，使用寄存器，但是参数空间还是没有优化 0x455378 88442468 MOVB AL, 0x68(SP) # aa 0x45537c 48895c2470 MOVQ BX, 0x70(SP) # ab 0x455381 894c2478 MOVL CX, 0x78(SP) # ac 0x455385 66897c247c MOVW DI, 0x7c(SP) # ad # 返回值分配栈大小空间 0x45538a c644240900 MOVB $0x0, 0x9(SP) # ra 0x45538f 48c744241000000000 MOVQ $0x0, 0x10(SP) # rb 0x455398 c744240c00000000 MOVL $0x0, 0xc(SP) # rc 0x4553a0 66c744240a0000 MOVW $0x0, 0xa(SP) # rd println(\u0026rd, \u0026rc, \u0026rb, \u0026ra, \u0026ad, \u0026ac, \u0026ab, \u0026aa) ... ... 逃逸分析 什么是逃逸分析 局部变量地址作为返回值(1) 在解释逃逸分析之前，先来思考一个场景，如果一个函数把自已栈帧上某个局部变量的地址作为返回值返回。 会有什么问题？示例代码如下： 1 2 3 4 5 6 7 8 9 10 11 package main func main() { println(*newInt()) } //go:noinline func newInt() *int { var a int return \u0026a } 前面对函数栈布局的讲解 newInt() 函数的局部变量a应该分配在函数栈的 locals 区间。 在newInt()函数返回后，它的栈随即销毁，返回的变量a的地址就会变成一个悬挂指针，caller 中对该地址进行的所有读写都是不合法的，会造成程序逻辑错误甚至崩溃。 事实是这样的吗？上述分析有个前提条件，即变量 a 被分配在栈上。假如编译器能够检测到这种模式，而自动把变量 a 改为堆分配，就不存在上述问题了。 反编译 newInt() 函数，看一下结果，代码如下： 重点关注上述汇编代码中 runtime.newobject() 函数调用，该函数是 Go 语言内置函数 new() 的具体实现，用来在运行阶段分配单个对象。 CALL 指令 AX 寄存器就是 *int 类型，也是返回的值。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 TEXT main.newInt(SB) /mnt/hgfs/workspace/helium/main.go func newInt() *int { 0x455240 493b6610 CMPQ 0x10(R14), SP # 栈增长判断 0x455244 7643 JBE 0x455289 0x455246 4883ec28 SUBQ $0x28, SP 0x45524a 48896c2420 MOVQ BP, 0x20(SP) 0x45524f 488d6c2420 LEAQ 0x20(SP), BP 0x455254 48c744241000000000 MOVQ $0x0, 0x10(SP) # *int 临时返回值空间 var a int 0x45525d 488d05bc4a0000 LEAQ 0x4abc(IP), AX # type.int 元类型 # func newobject(typ *_type) unsafe.Pointer # 这里调用 newobject 函数进行了堆分配 0x455264 e8d75cfbff CALL runtime.newobject(SB) # AX=*int 类型 0x455269 4889442418 MOVQ AX, 0x18(SP) 0x45526e 48c70000000000 MOVQ $0x0, 0(AX) # *a=0 return \u0026a 0x455275 488b442418 MOVQ 0x18(SP), AX 0x45527a 4889442410 MOVQ AX, 0x10(SP) # 返回值 AX 0x45527f 488b6c2420 MOVQ 0x20(SP), BP 0x455284 4883c428 ADDQ $0x28, SP 0x455288 c3 RET func newInt() *int { 0x455289 e8d2ccffff CALL runtime.morestack_noctxt.abi0(SB) 0x45528e ebb0 JMP main.newInt(SB) 局部变量地址作为返回值(2) 如果把 newInt() 函数中的取地址运算改成使用内置函数 new()，效果也是一样的，代码如下： 1 2 3 4 //go:noinline func newInt() *int { return new(int) } 相关汇编： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 $ go build -gcflags=\"-N -l\" -o ./h1 myzx.cn/helium $ go tool objdump -S -s '^main.newInt$' ./h1 TEXT main.newInt(SB) /mnt/hgfs/workspace/helium/main.go func newInt() *int { 0x455240 493b6610 CMPQ 0x10(R14), SP 0x455244 7637 JBE 0x45527d 0x455246 4883ec28 SUBQ $0x28, SP 0x45524a 48896c2420 MOVQ BP, 0x20(SP) 0x45524f 488d6c2420 LEAQ 0x20(SP), BP 0x455254 48c744241000000000 MOVQ $0x0, 0x10(SP) # *int 返回值空间 return new(int) # func newobject(typ *_type) unsafe.Pointer 0x45525d 488d05bc4a0000 LEAQ 0x4abc(IP), AX # type.int 元类型 0x455264 e8d75cfbff CALL runtime.newobject(SB) # AX=*int 0x455269 4889442418 MOVQ AX, 0x18(SP) 0x45526e 4889442410 MOVQ AX, 0x10(SP) 0x455273 488b6c2420 MOVQ 0x20(SP), BP 0x455278 4883c428 ADDQ $0x28, SP 0x45527c c3 RET func newInt() *int { 0x45527d 0f1f00 NOPL 0(AX) 0x455280 e8dbccffff CALL runtime.morestack_noctxt.abi0(SB) 0x455285 ebb9 JMP main.newInt(SB) 当函数局部变量的生命周期超过函数栈的生命周期时，编译器把该局部变量由栈分配改为堆分配，即变量从栈上逃逸到堆上。 不逃逸分析 只要使用了new()函数就会造成堆分配?\n前面逃逸分析代码示例中将函数的某个局部变量的地址作为返回值返回，或者通过内置函数 new() 动态分配变量并返回其地址。 其中内置函数new()有着非常明显的堆分配的含义，是不是只要使用了new()函数就会造成堆分配呢？ 进一步猜想，如果对局部变量进行取地址操作会被转换为new()函数调用，那就不会进行所谓的逃逸分析了。 先验证new()函数与堆分配是否有必然关系，代码如下： 1 2 3 4 5 //go:noinline func New() int { p := new(int) return *p } 反编译new()函数，得到的汇编代码如下： 即便代码中使用了new()函数，只要变量的生命周期没有超过过当前函数栈的生命周期，编译器就不会进行堆分配。 事实上，只要代码逻辑允许，编译器总是倾向于把变量分配在栈上，因为比配在堆上更高效。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 TEXT main.New(SB) /mnt/hgfs/workspace/helium/main.go func New() int { 0x455240 4883ec20 SUBQ $0x20, SP 0x455244 48896c2418 MOVQ BP, 0x18(SP) 0x455249 488d6c2418 LEAQ 0x18(SP), BP 0x45524e 48c7042400000000 MOVQ $0x0, 0(SP) # 返回地址 int p := new(int) # new 函数直接是在栈上分配的 0x455256 48c744240800000000 MOVQ $0x0, 0x8(SP) # 0x8(SP) 用作int类型存储 0 0x45525f 488d4c2408 LEAQ 0x8(SP), CX # CX=0x8(SP); 也就是 *int 0x455264 48894c2410 MOVQ CX, 0x10(SP) # 0x10(SP); *int return *p 0x455269 8401 TESTB AL, 0(CX) 0x45526b 488b442408 MOVQ 0x8(SP), AX 0x455270 48890424 MOVQ AX, 0(SP) 0x455274 488b6c2418 MOVQ 0x18(SP), BP 0x455279 4883c420 ADDQ $0x20, SP 0x45527d c3 RET 这也就是本节所谓的不逃逸分析，或者说未逃逸分析，这种说法并不严谨，主要是为了突出编译器倾向于让变量不逃逸。 不逃逸判断 包级别指针(1) 本节主要探索编译器进行逃逸分析时追踪的范围，以及在什么情况下就认为变量逃逸了或者确定变量没有逃逸。 前面研究变量逃逸所有的方法，主要通过让函数返回局部变量的地址，使局部变量的生命周期超过对应函数栈帧的生命周期。 按照这个规则来猜想，如果把局部变量的地址赋值给包级别的指针变量，应该也会造成变量逃逸。 准备一个示例，代码如下： 1 2 3 4 5 6 7 var pt *int //go:noinline func setNew() { var a int pt = \u0026a } 反编译 setNew() 函数，代码如下： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 TEXT main.setNew(SB) /mnt/hgfs/workspace/helium/main.go func setNew() { 0x455220 493b6610 CMPQ 0x10(R14), SP # 栈增长判断 0x455224 765d JBE 0x455283 0x455226 4883ec20 SUBQ $0x20, SP 0x45522a 48896c2418 MOVQ BP, 0x18(SP) 0x45522f 488d6c2418 LEAQ 0x18(SP), BP var a int 0x455234 488d05e54a0000 LEAQ 0x4ae5(IP), AX # type.int 元类型 0x45523b 0f1f440000 NOPL 0(AX)(AX*1) # func newobject(typ *_type) unsafe.Pointer # 这里直接调用了 newobject 堆分配了 int 0x455240 e8fb5cfbff CALL runtime.newobject(SB) # *int 0x455245 4889442410 MOVQ AX, 0x10(SP) 0x45524a 48c70000000000 MOVQ $0x0, 0(AX) # a = 0 pt = \u0026a 0x455251 488b4c2410 MOVQ 0x10(SP), CX # CX=0x10(SP)=*int # 判断是否开启写屏障，因为可能在GC阶段，变量的赋值需要写屏障 0x455256 833d0320090000 CMPL $0x0, runtime.writeBarrier(SB) 0x45525d 7403 JE 0x455262 0x45525f 90 NOPL 0x455260 eb09 JMP 0x45526b 0x455262 48890db7320600 MOVQ CX, main.pt(SB) # 给全局变量 pt 赋值 0x455269 eb0e JMP 0x455279 0x45526b 488d3dae320600 LEAQ main.pt(SB), DI # 写屏障开启的时候调用写屏障相关函数，记录指针的变更，已帮助GC 0x455272 e8a9d0ffff CALL runtime.gcWriteBarrierCX(SB) 0x455277 eb00 JMP 0x455279 } 0x455279 488b6c2418 MOVQ 0x18(SP), BP 0x45527e 4883c420 ADDQ $0x20, SP 0x455282 c3 RET func setNew() { 0x455283 e8d8ccffff CALL runtime.morestack_noctxt.abi0(SB) 0x455288 eb96 JMP main.setNew(SB) 通过 runtime.newobject() 函数调用就能确定，变量a逃逸到了堆上，验证了上述猜想。 包级别指针(2) 进一步还可以验证逃逸分析的依赖传递性，准备示例代码如下： 1 2 3 4 5 6 7 8 9 var pp **int //go:noinline func dep() { var a int var p *int p = \u0026a pp = \u0026p } 反编译 dep() 函数： 可以发现，变量 p 和 a 都逃逸了。 p 的地址被赋值给包级别的指针变量 pp，而 a 的地址又被赋值给了 p，因为 p 逃逸造成 a 也逃逸了。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 TEXT main.dep(SB) /mnt/hgfs/workspace/helium/main.go func dep() { 0x455220 493b6610 CMPQ 0x10(R14), SP # 栈增长判断 0x455224 0f86b0000000 JBE 0x4552da 0x45522a 4883ec28 SUBQ $0x28, SP 0x45522e 48896c2420 MOVQ BP, 0x20(SP) 0x455233 488d6c2420 LEAQ 0x20(SP), BP var a int 0x455238 488d05e14a0000 LEAQ 0x4ae1(IP), AX # type.int 元类型; 0x45523f 90 NOPL # func newobject(typ *_type) unsafe.Pointer 0x455240 e8fb5cfbff CALL runtime.newobject(SB) # 堆分配了 a 变量; AX *int 0x455245 4889442418 MOVQ AX, 0x18(SP) # 0x18(SP); 是a的内存空间，指向堆分配数据 0x45524a 48c70000000000 MOVQ $0x0, 0(AX) # 初始化 0 var p *int 0x455251 488d0508320000 LEAQ 0x3208(IP), AX # type *int 元类型 # func newobject(typ *_type) unsafe.Pointer 0x455258 e8e35cfbff CALL runtime.newobject(SB) # **int 0x45525d 4889442410 MOVQ AX, 0x10(SP) 0x455262 833df71f090000 CMPL $0x0, runtime.writeBarrier(SB) 0x455269 7402 JE 0x45526d 0x45526b eb09 JMP 0x455276 0x45526d 48c70000000000 MOVQ $0x0, 0(AX) 0x455274 eb11 JMP 0x455287 0x455276 4889c7 MOVQ AX, DI 0x455279 31c0 XORL AX, AX 0x45527b 0f1f440000 NOPL 0(AX)(AX*1) 0x455280 e89bcfffff CALL runtime.gcWriteBarrier(SB) 0x455285 eb00 JMP 0x455287 p = \u0026a 0x455287 488b7c2410 MOVQ 0x10(SP), DI 0x45528c 488b442418 MOVQ 0x18(SP), AX 0x455291 833dc81f090000 CMPL $0x0, runtime.writeBarrier(SB) 0x455298 7402 JE 0x45529c 0x45529a eb06 JMP 0x4552a2 0x45529c 488907 MOVQ AX, 0(DI) 0x45529f 90 NOPL 0x4552a0 eb07 JMP 0x4552a9 0x4552a2 e879cfffff CALL runtime.gcWriteBarrier(SB) 0x4552a7 eb00 JMP 0x4552a9 pp = \u0026p 0x4552a9 488b442410 MOVQ 0x10(SP), AX 0x4552ae 833dab1f090000 CMPL $0x0, runtime.writeBarrier(SB) 0x4552b5 7402 JE 0x4552b9 0x4552b7 eb09 JMP 0x4552c2 0x4552b9 48890560320600 MOVQ AX, main.pp(SB) 0x4552c0 eb0e JMP 0x4552d0 0x4552c2 488d3d57320600 LEAQ main.pp(SB), DI 0x4552c9 e852cfffff CALL runtime.gcWriteBarrier(SB) 0x4552ce eb00 JMP 0x4552d0 } 0x4552d0 488b6c2420 MOVQ 0x20(SP), BP 0x4552d5 4883c428 ADDQ $0x28, SP 0x4552d9 c3 RET func dep() { 0x4552da e881ccffff CALL runtime.morestack_noctxt.abi0(SB) 0x4552df 90 NOPL 0x4552e0 e93bffffff JMP main.dep(SB) 假如某个函数有一个参数和一个返回值，类型都是整型指针，函数只是简单地把参数作为返回值。 在函数间传递 就像下面的 gom.RetArg() 函数，代码如下： 1 2 3 4 5 6 package gom //go:noinline func RetArg(p *int) *int { return p } 在另一个包中 arg() 函数调用了 inner.RetArg() 函数将局部变量 a 的地址作为参数，并返回了一个 int 类型的返回值。 代码如下： 1 2 3 4 5 6 7 package main //go:noinline func arg() int { var a int return *gom.RetArg(\u0026a) } 在 arg() 函数中并没有把变量 a 的地址作为返回值，也不存在到某个包级别指针变量的依赖链路，所以变量a是否会逃逸的关键就在于inner.RetArg()函数。 inner. RetArg()函数只是把传过去的指针又传了回来，而且作为被调用者来讲，它的生命周期是完全包含在arg()函数的生命周期以内的，所以不应该造成变量 a 逃逸。 事实到底如何呢? 还要通过反编译验证，节选部分关键汇编代码如下： 变量a确实是在栈上分配的，也就说明编译器参考了inner.RetArg()函数的具体实现，基于代码逻辑判定变量 a 没有逃逸。 虽然代码中通过**noinline阻止了内联优化，但是没能阻止编译器参考函数实现**。 假如通过某种方式能够阻止编译器参考函数实现，又会有什么样的结果呢? 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 TEXT main.arg(SB) /mnt/hgfs/workspace/helium/main.go func arg() int { 0x455240 493b6610 CMPQ 0x10(R14), SP # 栈增长判断 0x455244 7643 JBE 0x455289 0x455246 4883ec28 SUBQ $0x28, SP 0x45524a 48896c2420 MOVQ BP, 0x20(SP) 0x45524f 488d6c2420 LEAQ 0x20(SP), BP 0x455254 48c744240800000000 MOVQ $0x0, 0x8(SP) # return int var a int 0x45525d 48c744241000000000 MOVQ $0x0, 0x10(SP) return *gom.RetArg(\u0026a) # 可以看出这里调用gom.RetArg函数时参数直接是在栈上分配的，并没有堆分配 0x455266 488d442410 LEAQ 0x10(SP), AX 0x45526b e870ffffff CALL example.com/helium/gom.RetArg(SB) 0x455270 4889442418 MOVQ AX, 0x18(SP) 0x455275 8400 TESTB AL, 0(AX) 0x455277 488b00 MOVQ 0(AX), AX 0x45527a 4889442408 MOVQ AX, 0x8(SP) 0x45527f 488b6c2420 MOVQ 0x20(SP), BP 0x455284 4883c428 ADDQ $0x28, SP 0x455288 c3 RET func arg() int { 0x455289 e8d2ccffff CALL runtime.morestack_noctxt.abi0(SB) 0x45528e ebb0 JMP main.arg(SB) linkname 机制 可以使用 linkname 机制，连同修改后的 arg() 函数的代码如下： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package main import ( \"example.com/helium/gom\" _ \"unsafe\" // 使用了 go:linkname 必须要引入 unsafe 包 ) func main() { arg() } //go:linkname retArg example.com/helium/gom.RetArg func retArg(p *int) *int //go:noinline func arg() int { var a int var b int return *gom.RetArg(\u0026a) + retArg(\u0026b) } 再次反编译 arg() 函数，节选变量 a 和 b 分配相关的汇编代码如下： 变量 a 依旧是栈分配，变量 b 已经逃逸了。 在上述代码中的 retArg() 函数只是个函数声明没有给出具体实现，通过 linkname 机制让链接器在链接阶段链接到 inner.RetArg() 函数。 retArg() 函数只有声明没有实现，而且编译器不会跟踪 linkname，所以无法根据代码逻辑判定变量 b 到底有没有逃逸。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 TEXT main.arg(SB) /mnt/hgfs/workspace/helium/main.go func arg() int { 0x455240 493b6610 CMPQ 0x10(R14), SP # 栈增长判断 0x455244 7677 JBE 0x4552bd 0x455246 4883ec40 SUBQ $0x40, SP 0x45524a 48896c2438 MOVQ BP, 0x38(SP) 0x45524f 488d6c2438 LEAQ 0x38(SP), BP 0x455254 48c744241000000000 MOVQ $0x0, 0x10(SP) # return int var a int 0x45525d 48c744241800000000 MOVQ $0x0, 0x18(SP) # a,0 var b int 0x455266 488d05b34a0000 LEAQ 0x4ab3(IP), AX # type.int 0x45526d e8ce5cfbff CALL runtime.newobject(SB) # *int 0x455272 4889442430 MOVQ AX, 0x30(SP) # 变量b，堆分配了 0x455277 48c70000000000 MOVQ $0x0, 0(AX) return *gom.RetArg(\u0026a) + *retArg(\u0026b) 0x45527e 488d442418 LEAQ 0x18(SP), AX 0x455283 e858ffffff CALL example.com/helium/gom.RetArg(SB) 0x455288 4889442428 MOVQ AX, 0x28(SP) 0x45528d 488b442430 MOVQ 0x30(SP), AX 0x455292 e849ffffff CALL example.com/helium/gom.RetArg(SB) 0x455297 4889442420 MOVQ AX, 0x20(SP) 0x45529c 488b4c2428 MOVQ 0x28(SP), CX 0x4552a1 8401 TESTB AL, 0(CX) 0x4552a3 8400 TESTB AL, 0(AX) 0x4552a5 488b09 MOVQ 0(CX), CX 0x4552a8 480308 ADDQ 0(AX), CX 0x4552ab 48894c2410 MOVQ CX, 0x10(SP) 0x4552b0 4889c8 MOVQ CX, AX 0x4552b3 488b6c2438 MOVQ 0x38(SP), BP 0x4552b8 4883c440 ADDQ $0x40, SP 0x4552bc c3 RET func arg() int { 0x4552bd 0f1f00 NOPL 0(AX) 0x4552c0 e89bccffff CALL runtime.morestack_noctxt.abi0(SB) 0x4552c5 e976ffffff JMP main.arg(SB) 把逻辑上没有逃逸的变量分配到堆上不会造成错误，只是效率低一些。 但是把逻辑上逃逸了的变量分配到栈上就会造成悬挂指针等问题。 因此编译器只有在能够确定变量没有逃逸的情况下，才会将其分配到栈上，在能够确定变量已经逃逸或无法确定到底有没有逃逸的情况下，都要按照已经逃逸来处理。 这也就解释了为什么在上述代码中的变量 b 逻辑上没逃逸却被分配在了堆上。 函数示例 示例一 1 2 3 4 5 6 7 8 9 10 11 12 13 14 package main func main() { sum(1, 2) } // sum 计算a, b的平方和 func sum(a, b int) int { a2 := a * a b2 := b * b c := a2 + b2 return c } main.main汇编： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 TEXT main.main(SB) /mnt/hgfs/g/hello1/hello.go # 判断栈是否溢出 0x10(R14)指向g.stackguard0位置 hello.go:3 0x45b4a0 493b6610 cmp rsp, qword ptr [r14+0x10] cmp 0x10(R14), rsp # 跳转到0x45b4cf处设置栈信息，在重新调main.main函数 hello.go:3 0x45b4a4 7629 jbe 0x45b4cf jbe 0x45b4cf # 为当前栈预分配参数空间，第一个8B存储runtime.main的rbp，第二个8B存储main.sun的参数b为1，第三个8B存储main.sun的参数a为2 hello.go:3 0x45b4a6 4883ec18 sub rsp, 0x18 sub 0x18, rsp # 把runtime.main的栈rbp存入0x10(rsp)处 hello.go:3 0x45b4aa 48896c2410 mov qword ptr [rsp+0x10], rbp mov rbp, 0x10(rsp) # 从新设置当前main.main的栈rbp值为0x10(rsp)处 hello.go:3 0x45b4af 488d6c2410 lea rbp, ptr [rsp+0x10] lea 0x10(rsp), rbp # 为main.sum准备第一个参数，放入寄存器AX中 hello.go:4 0x45b4b4 b801000000 mov eax, 0x1 mov 0x1, AX # 为main.sum准备第二个参数，放入寄存器BX中 hello.go:4 0x45b4b9 bb02000000 mov ebx, 0x2 mov 0x2, BX hello.go:4 0x45b4be 6690 data16 nop hello.go:4 0x45b4c0 e81b000000 call $main.sum call $main.sum # 把runtime.main的栈rbp值从0x10(rsp)处放入rbp寄存器 hello.go:5 0x45b4c5 488b6c2410 mov rbp, qword ptr [rsp+0x10] mov 0x10(rsp), rbp # rsp寄存器恢复调用main.main之前情况 hello.go:5 0x45b4ca 4883c418 add rsp, 0x18 add 0x18, rsp # 返回，rsp-8弹出返回地址给rip返回的runtime.main继续执行 hello.go:5 0x45b4ce c3 ret ret hello.go:3 0x45b4cf e88ccdffff call $runtime.morestack_noctxt call $runtime.morestack_noctxt .:0 0x45b4d4 ebca jmp $main.main jmp $main.main main.sum汇编： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 TEXT main.sum(SB) /mnt/hgfs/g/hello1/hello.go # 为main.sum栈预分配0x28空间 hello.go:8 0x45b4e0 4883ec28 sub rsp, 0x28 sub 0x28, rsp # 把main.main的rbp存储到0x20(rsp)位置 hello.go:8 0x45b4e4 48896c2420 mov qword ptr [rsp+0x20], rbp mov rbp, 0x20(rsp) # 从新设置main.sum的rbp值 hello.go:8 0x45b4e9 488d6c2420 lea rbp, ptr [rsp+0x20] lea 0x20(rsp), rbp # 把传递的第一个参数入栈，注意看这里参参数栈分配在main.main的栈上 hello.go:8 0x45b4ee 4889442430 mov qword ptr [rsp+0x30], rax mov AX, 0x30(rsp) # a = 1 # 把传递的第二个参数入栈，注意看这里参参数栈分配在main.main的栈上 hello.go:8 0x45b4f3 48895c2438 mov qword ptr [rsp+0x38], rbx mov BX, 0x38(rsp) # b = 2 # 初始化rsp的第一个8字节吗，返回值空间初始化 hello.go:8 0x45b4f8 48c7042400000000 mov qword ptr [rsp], 0x0 mov 0x0, (rsp) # return # 为乘法运算做准备，把变量a的值放入寄存器 hello.go:9 0x45b500 488b4c2430 mov rcx, qword ptr [rsp+0x30] mov 0x30(rsp), CX # 为乘法运算做准备，把变量a的值放入寄存器 hello.go:9 0x45b505 488b542430 mov rdx, qword ptr [rsp+0x30] mov 0x30(rsp), DX # 乘法运算，结果存储在DX中 hello.go:9 0x45b50a 480fafd1 imul rdx, rcx imul CX, DX # a*a # 0X18(rsp)的地址为变量a2 hello.go:9 0x45b50e 4889542418 mov qword ptr [rsp+0x18], rdx mov DX, 0X18(rsp) # a2=a*a # 为乘法运算做准备，把变量b的值放入寄存器 hello.go:10 0x45b513 488b4c2438 mov rcx, qword ptr [rsp+0x38] mov 0x38(rsp), CX # 为乘法运算做准备，把变量b的值放入寄存器 hello.go:10 0x45b518 488b542438 mov rdx, qword ptr [rsp+0x38] mov 0x38(rsp), DX # 乘法运算，结果存储在DX中 hello.go:10 0x45b51d 480fafd1 imul rdx, rcx imul CX, DX # b*b # 0X10(rsp)的地址为变量b2 hello.go:10 0x45b521 4889542410 mov qword ptr [rsp+0x10], rdx mov DX, 0x10(rsp) # b2 = b*b # 把a2值放入CX寄存器 hello.go:11 0x45b526 488b4c2418 mov rcx, qword ptr [rsp+0x18] mov 0x18(rsp), CX # 计算 a2 + b2 hello.go:11 0x45b52b 488d0411 lea rax, ptr [rcx+rdx*1] lea (CX+DX*1), AX # a2+b2 # a2 + b2 值存入0x8(rsp)是变量的值 hello.go:11 0x45b52f 4889442408 mov qword ptr [rsp+0x8], rax mov AX, 0x8(rsp) # c = a2+b2 # a2 + b2 值存入(rsp) 该值是返回值空间 hello.go:13 0x45b534 48890424 mov qword ptr [rsp], rax mov AX, (rsp) # return # 弹出main.main的rbp hello.go:13 0x45b538 488b6c2420 mov rbp, qword ptr [rsp+0x20] mov 0x20(rsp), rbp # 使rsp指向main.main的栈rsp位置 .:0 0x45b53d 4883c428 add rsp, 0x28 add 0x28, rsp # 弹出main.main的下一条指令地址 .:0 0x45b541 c3 ret ret 栈分布情况： // 我们看一下代码在14行时也就是main.sum函数返回前的栈布局情况 // // 栈底 // ---------------------------- 高地址 // | b // ---------------------------- // | a runtime.main函数栈帧 // ---------------------------- // | 返回到runtime.main的地址 +0x48 // -----------\u003e ---------------------------- \u003c------------------------------------- // | 调用函数runtime.main的rbp +0x40 // ---------------------------- // | main.sum的第二个参数 0x2 +0x38 // ---------------------------- main.main函数栈帧 // | main.sum的第一个参数 0x1 +0x30 // ---------------------------- // | 返回到main.main的地址 +0x28 // -----------\u003e ---------------------------- \u003c------------------------------------- // | 调用函数main.main的rbp +0x20 // ---------------------------- // | 变量a2 0x1 +0x18 // ---------------------------- // | 变量b2 0x4 +0x10 main.sum函数栈帧 // ---------------------------- // | 变量c 0x5 +0x8 // ---------------------------- // | main.sum的返回值地址 0x5 +0x0 // -----------\u003e ---------------------------- \u003c------------------------------------- 编译指令 编译指令：go build -gcflags=\"-N -l\" slice1.go。 查看具体方法的汇编指令：go tool objdump -S -s ‘^main.main$’ slice1。 ",
  "wordCount" : "2921",
  "inLanguage": "zh",
  "image": "https://heliu.site/favicon-32x32.png","datePublished": "2024-08-05T00:00:00Z",
  "dateModified": "2024-08-05T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://heliu.site/posts/golang/func/align/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://heliu.site/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://heliu.site/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://heliu.site/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://heliu.site/" title="主页">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/posts" title="文章">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/archives" title="时间轴">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/tags/" title="标签">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/search/" title="搜索 (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/support" title="打赏">
                    <span>🫶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://heliu.site/">主页</a>&nbsp;»&nbsp;<a href="https://heliu.site/posts/">Article</a>&nbsp;»&nbsp;<a href="https://heliu.site/posts/golang/">Golang 合集</a>&nbsp;»&nbsp;<a href="https://heliu.site/posts/golang/func/">第9章 Function</a></div>
    <h1 class="post-title entry-hint-parent">
      内存对齐和逃逸分析
    </h1>
    <div class="post-description">
      💥本文章所有相关go代码参考自go 1.18&#43;版本
    </div>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2024-08-05</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2024-08-05</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>2921字</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>14分钟</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &nbsp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://heliu.site/tags/golang/" target="_blank" rel="noopener">Golang</a>
            <a href="https://heliu.site/tags/%E5%87%BD%E6%95%B0/" target="_blank" rel="noopener">函数</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &nbsp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%86%85%e5%ad%98%e5%af%b9%e9%bd%90" aria-label="内存对齐">内存对齐</a></li>
                    <li>
                        <a href="#%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90" aria-label="逃逸分析">逃逸分析</a><ul>
                            
                    <li>
                        <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90" aria-label="什么是逃逸分析">什么是逃逸分析</a><ul>
                            
                    <li>
                        <a href="#%e5%b1%80%e9%83%a8%e5%8f%98%e9%87%8f%e5%9c%b0%e5%9d%80%e4%bd%9c%e4%b8%ba%e8%bf%94%e5%9b%9e%e5%80%bc1" aria-label="局部变量地址作为返回值(1)">局部变量地址作为返回值(1)</a></li>
                    <li>
                        <a href="#%e5%b1%80%e9%83%a8%e5%8f%98%e9%87%8f%e5%9c%b0%e5%9d%80%e4%bd%9c%e4%b8%ba%e8%bf%94%e5%9b%9e%e5%80%bc2" aria-label="局部变量地址作为返回值(2)">局部变量地址作为返回值(2)</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%b8%8d%e9%80%83%e9%80%b8%e5%88%86%e6%9e%90" aria-label="不逃逸分析">不逃逸分析</a></li>
                    <li>
                        <a href="#%e4%b8%8d%e9%80%83%e9%80%b8%e5%88%a4%e6%96%ad" aria-label="不逃逸判断">不逃逸判断</a><ul>
                            
                    <li>
                        <a href="#%e5%8c%85%e7%ba%a7%e5%88%ab%e6%8c%87%e9%92%881" aria-label="包级别指针(1)">包级别指针(1)</a></li>
                    <li>
                        <a href="#%e5%8c%85%e7%ba%a7%e5%88%ab%e6%8c%87%e9%92%882" aria-label="包级别指针(2)">包级别指针(2)</a></li>
                    <li>
                        <a href="#%e5%9c%a8%e5%87%bd%e6%95%b0%e9%97%b4%e4%bc%a0%e9%80%92" aria-label="在函数间传递">在函数间传递</a></li>
                    <li>
                        <a href="#linkname-%e6%9c%ba%e5%88%b6" aria-label="linkname 机制">linkname 机制</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e5%87%bd%e6%95%b0%e7%a4%ba%e4%be%8b" aria-label="函数示例">函数示例</a><ul>
                            
                    <li>
                        <a href="#%e7%a4%ba%e4%be%8b%e4%b8%80" aria-label="示例一">示例一</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e7%bc%96%e8%af%91%e6%8c%87%e4%bb%a4" aria-label="编译指令">编译指令</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><h2 id="内存对齐">内存对齐<a hidden class="anchor" aria-hidden="true" href="#内存对齐">#</a></h2>
<ol>
<li>在<code>C</code>语言函数调用中，通过栈传递的参数需要<strong>对齐</strong>到平台的位宽。</li>
<li>假如通过栈传递4个<code>char</code>类型的参数，<code>GCC</code>生成的 32 位程序需要 16 字节空间，64 位程序需要 32 字节栈空间。</li>
<li>如果传递大量参数，则这种对齐方式会存在很大的栈空间浪费。</li>
<li><code>Go</code>语言函数栈帧中返回值和参数的对齐方式与 <code>struct</code> 类似，对于有返回值和参数的函数，可以把所有返回值和所有参数等价成两个 <code>struct</code>：
<ul>
<li>一个【返回值 <code>struct</code>】 和一个【参数 <code>struct</code>】。</li>
</ul>
</li>
<li>因为<strong>内存对齐</strong>方式更加紧凑，所以在支持大量参数和返回值时能够做到较高的栈空间利用率。</li>
<li>通过如下示例可以验证函数参数和返回值的对齐方式与 <code>struct</code> 成员的对齐方式是一致的，代码如下：
<ul>
<li>以上的描述都是在函数通过<strong>栈</strong>传递参数和返回值的基础上的。在go1.18后版本中采用了寄存器传参。</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">args</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span> <span class="kt">int8</span>    <span class="c1">// 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">b</span> <span class="kt">int64</span> <span class="c1">// 8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span> <span class="kt">int32</span> <span class="c1">// 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">d</span> <span class="kt">int16</span> <span class="c1">// 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">f1</span><span class="p">(</span><span class="nx">a</span> <span class="nx">args</span><span class="p">)</span> <span class="p">(</span><span class="nx">r</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">println</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">r</span><span class="p">.</span><span class="nx">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">r</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">r</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">r</span><span class="p">.</span><span class="nx">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">a</span><span class="p">.</span><span class="nx">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">a</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">a</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">a</span><span class="p">.</span><span class="nx">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">f2</span><span class="p">(</span><span class="nx">aa</span> <span class="kt">int8</span><span class="p">,</span> <span class="nx">ab</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">ac</span> <span class="kt">int32</span><span class="p">,</span> <span class="nx">ad</span> <span class="kt">int16</span><span class="p">)</span> <span class="p">(</span><span class="nx">ra</span> <span class="kt">int8</span><span class="p">,</span> <span class="nx">rb</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">rc</span> <span class="kt">int32</span><span class="p">,</span> <span class="nx">rd</span> <span class="kt">int16</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">println</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rd</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">rc</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">rb</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">ra</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">ad</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">ac</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">ab</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">aa</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f1</span><span class="p">(</span><span class="nx">args</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 0xc000034744     r.d
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0xc000034740     r.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0xc000034738     r.b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0xc000034730     r.a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0xc00003476c     a.d
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0xc000034768     a.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0xc000034760     a.b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0xc000034758     a.a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="nf">f2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 0xc00003473a     rd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0xc00003473c     rc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0xc000034740     rb
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0xc000034739     ra
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0xc00003476c     ad
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0xc000034768     ac
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0xc000034760     ab
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0xc000034758     aa
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

<p><details >
  <summary markdown="span">汇编代码</summary>
  <blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e0</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4551e4</span>        <span class="mi">7657</span>                <span class="no">JBE</span> <span class="mi">0x45523d</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x4551e6</span>        <span class="mi">4883</span><span class="no">ec38</span>            <span class="no">SUBQ</span> <span class="no">$0x38</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x4551ea</span>        <span class="mi">48896</span><span class="no">c2430</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4551ef</span>        <span class="mi">488</span><span class="no">d6c2430</span>          <span class="no">LEAQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">    <span class="no">f1</span><span class="p">(</span><span class="no">args</span><span class="err">{}</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551f4</span>        <span class="no">c644241800</span>          <span class="no">MOVB</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># a.a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551f9</span>        <span class="mi">48</span><span class="no">c744242000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># a.b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455202</span>        <span class="no">c744242800000000</span>    <span class="no">MOVL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># a.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45520a</span>        <span class="mi">66</span><span class="no">c744242c0000</span>      <span class="no">MOVW</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x2c</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># a.d
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455211</span>        <span class="mi">0</span><span class="no">fb6442418</span>          <span class="no">MOVZX</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>     <span class="c1"># a.a AX    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455216</span>        <span class="mi">488</span><span class="no">b5c2420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BX</span>      <span class="c1"># a.b BX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45521b</span>        <span class="mi">8</span><span class="no">b4c2428</span>            <span class="no">MOVL</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>      <span class="c1"># a.c CX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45521f</span>        <span class="mi">31</span><span class="no">ff</span>                <span class="no">XORL</span> <span class="no">DI</span><span class="p">,</span> <span class="no">DI</span>            <span class="c1"># a.d DI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455221</span>        <span class="no">e83a000000</span>          <span class="no">CALL</span> <span class="no">main.f1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">    <span class="no">f2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455226</span>        <span class="mi">31</span><span class="no">c0</span>                <span class="no">XORL</span> <span class="no">AX</span><span class="p">,</span> <span class="no">AX</span>        <span class="c1"># aa    AX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455228</span>        <span class="mi">31</span><span class="no">db</span>                <span class="no">XORL</span> <span class="no">BX</span><span class="p">,</span> <span class="no">BX</span>        <span class="c1"># ab    BX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45522a</span>        <span class="mi">31</span><span class="no">c9</span>                <span class="no">XORL</span> <span class="no">CX</span><span class="p">,</span> <span class="no">CX</span>        <span class="c1"># ac    CX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45522c</span>        <span class="mi">31</span><span class="no">ff</span>                <span class="no">XORL</span> <span class="no">DI</span><span class="p">,</span> <span class="no">DI</span>        <span class="c1"># ad    DI
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45522e</span>        <span class="no">e8ad010000</span>          <span class="no">CALL</span> <span class="no">main.f2</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455233</span>        <span class="mi">488</span><span class="no">b6c2430</span>          <span class="no">MOVQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455238</span>        <span class="mi">4883</span><span class="no">c438</span>            <span class="no">ADDQ</span> <span class="no">$0x38</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45523c</span>        <span class="no">c3</span>                  <span class="no">RET</span>            
</span></span><span class="line"><span class="cl"><span class="no">func</span> <span class="no">main</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45523d</span>        <span class="mi">0</span><span class="no">f1f00</span>              <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>                
</span></span><span class="line"><span class="cl"><span class="mi">0x455240</span>          <span class="no">e81bcdffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455245</span>        <span class="no">eb99</span>                <span class="no">JMP</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.f1</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">f1</span><span class="p">(</span><span class="no">a</span> <span class="no">args</span><span class="p">)</span> <span class="p">(</span><span class="no">r</span> <span class="no">args</span><span class="p">)</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4551e0</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4551e4</span>        <span class="mi">0</span><span class="no">f8642010000</span>        <span class="no">JBE</span> <span class="mi">0x45532c</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x4551ea</span>        <span class="mi">4883</span><span class="no">ec68</span>            <span class="no">SUBQ</span> <span class="no">$0x68</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x4551ee</span>        <span class="mi">48896</span><span class="no">c2460</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x60</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4551f3</span>        <span class="mi">488</span><span class="no">d6c2460</span>          <span class="no">LEAQ</span> <span class="mi">0x60</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="c1"># 参数分配栈大小空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551f8</span>        <span class="mi">88442470</span>            <span class="no">MOVB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0x70</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># a.a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4551fc</span>        <span class="mi">48895</span><span class="no">c2478</span>          <span class="no">MOVQ</span> <span class="no">BX</span><span class="p">,</span> <span class="mi">0x78</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># a.b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455201</span>        <span class="mi">898</span><span class="no">c2480000000</span>      <span class="no">MOVL</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x80</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># a.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455208</span>        <span class="mi">6689</span><span class="no">bc2484000000</span>    <span class="no">MOVW</span> <span class="no">DI</span><span class="p">,</span> <span class="mi">0x84</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># a.d
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># 返回值分配栈大小空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455210</span>        <span class="no">c644240800</span>          <span class="no">MOVB</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># r.a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455215</span>        <span class="mi">48</span><span class="no">c744241000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>  <span class="c1"># r.b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45521e</span>        <span class="no">c744241800000000</span>    <span class="no">MOVL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>  <span class="c1"># r.c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455226</span>        <span class="mi">66</span><span class="no">c744241c0000</span>      <span class="no">MOVW</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x1c</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>  <span class="c1"># r.d
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">println</span><span class="p">(</span><span class="err">&amp;</span><span class="no">r.d</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">r.c</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">r.b</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">r.a</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">a.d</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">a.c</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">a.b</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">a.a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="na">...</span> <span class="no">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.f2</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">f2</span><span class="p">(</span><span class="no">aa</span> <span class="no">int8</span><span class="p">,</span> <span class="no">ab</span> <span class="no">int64</span><span class="p">,</span> <span class="no">ac</span> <span class="no">int32</span><span class="p">,</span> <span class="no">ad</span> <span class="no">int16</span><span class="p">)</span> <span class="p">(</span><span class="no">ra</span> <span class="no">int8</span><span class="p">,</span> <span class="no">rb</span> <span class="no">int64</span><span class="p">,</span> <span class="no">rc</span> <span class="no">int32</span><span class="p">,</span> <span class="no">rd</span> <span class="no">int16</span><span class="p">)</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455360</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455364</span>        <span class="mi">0</span><span class="no">f8631010000</span>        <span class="no">JBE</span> <span class="mi">0x45549b</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45536a</span>        <span class="mi">4883</span><span class="no">ec60</span>            <span class="no">SUBQ</span> <span class="no">$0x60</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45536e</span>        <span class="mi">48896</span><span class="no">c2458</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x58</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455373</span>        <span class="mi">488</span><span class="no">d6c2458</span>          <span class="no">LEAQ</span> <span class="mi">0x58</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="c1"># 参数传参，使用寄存器，但是参数空间还是没有优化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455378</span>        <span class="mi">88442468</span>            <span class="no">MOVB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0x68</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># aa
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45537c</span>        <span class="mi">48895</span><span class="no">c2470</span>          <span class="no">MOVQ</span> <span class="no">BX</span><span class="p">,</span> <span class="mi">0x70</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># ab
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455381</span>        <span class="mi">894</span><span class="no">c2478</span>            <span class="no">MOVL</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x78</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># ac
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455385</span>        <span class="mi">66897</span><span class="no">c247c</span>          <span class="no">MOVW</span> <span class="no">DI</span><span class="p">,</span> <span class="mi">0x7c</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># ad
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># 返回值分配栈大小空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45538a</span>        <span class="no">c644240900</span>          <span class="no">MOVB</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x9</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># ra
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45538f</span>        <span class="mi">48</span><span class="no">c744241000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>  <span class="c1"># rb
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455398</span>        <span class="no">c744240c00000000</span>    <span class="no">MOVL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0xc</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># rc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4553a0</span>        <span class="mi">66</span><span class="no">c744240a0000</span>      <span class="no">MOVW</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0xa</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># rd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">println</span><span class="p">(</span><span class="err">&amp;</span><span class="no">rd</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">rc</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">rb</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">ra</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">ad</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">ac</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">ab</span><span class="p">,</span> <span class="err">&amp;</span><span class="no">aa</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="na">...</span> <span class="no">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>

</details></p>

<h2 id="逃逸分析">逃逸分析<a hidden class="anchor" aria-hidden="true" href="#逃逸分析">#</a></h2>
<h3 id="什么是逃逸分析">什么是逃逸分析<a hidden class="anchor" aria-hidden="true" href="#什么是逃逸分析">#</a></h3>
<h4 id="局部变量地址作为返回值1">局部变量地址作为返回值(1)<a hidden class="anchor" aria-hidden="true" href="#局部变量地址作为返回值1">#</a></h4>
<ol>
<li>在解释逃逸分析之前，先来思考一个场景，如果一个函数把自已栈帧上某个局部变量的地址作为返回值返回。</li>
<li>会有什么问题？示例代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">println</span><span class="p">(</span><span class="o">*</span><span class="nf">newInt</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newInt</span><span class="p">()</span> <span class="o">*</span><span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">a</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">a</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>前面对函数栈布局的讲解 <code>newInt()</code> 函数的局部变量a应该分配在函数栈的 locals 区间。</li>
<li>在<code>newInt()</code>函数返回后，它的栈随即销毁，返回的变量a的地址就会变成一个<strong>悬挂指针</strong>，caller 中对该地址进行的所有读写都是不合法的，会造成程序逻辑错误甚至崩溃。</li>
<li>事实是这样的吗？上述分析有个前提条件，即变量 a 被分配在栈上。假如编译器能够检测到这种模式，而自动把变量 a 改为堆分配，就不存在上述问题了。</li>
<li>反编译 <code>newInt()</code> 函数，看一下结果，代码如下：
<ol>
<li>重点关注上述汇编代码中 <code>runtime.newobject()</code> 函数调用，该函数是 <code>Go</code> 语言内置函数 <code>new()</code> 的具体实现，用来在运行阶段分配单个对象。</li>
<li><code>CALL</code> 指令 <code>AX</code> 寄存器就是 <code>*int</code> 类型，也是返回的值。</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.newInt</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">newInt</span><span class="p">()</span> <span class="p">*</span><span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455240</span>        <span class="mi">493</span><span class="no">b6610</span>            <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>     <span class="c1"># 栈增长判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455244</span>        <span class="mi">7643</span>                <span class="no">JBE</span> <span class="mi">0x455289</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455246</span>        <span class="mi">4883</span><span class="no">ec28</span>            <span class="no">SUBQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45524a</span>        <span class="mi">48896</span><span class="no">c2420</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45524f</span>        <span class="mi">488</span><span class="no">d6c2420</span>          <span class="no">LEAQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455254</span>        <span class="mi">48</span><span class="no">c744241000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># *int 临时返回值空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">var</span> <span class="no">a</span> <span class="no">int</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45525d</span>        <span class="mi">488</span><span class="no">d05bc4a0000</span>      <span class="no">LEAQ</span> <span class="mi">0x4abc</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>    <span class="c1"># type.int 元类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># func newobject(typ *_type) unsafe.Pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># 这里调用 newobject 函数进行了堆分配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455264</span>        <span class="no">e8d75cfbff</span>          <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># AX=*int 类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455269</span>        <span class="mi">4889442418</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45526e</span>        <span class="mi">48</span><span class="no">c70000000000</span>      <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>     <span class="c1"># *a=0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">return</span> <span class="err">&amp;</span><span class="no">a</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455275</span>        <span class="mi">488</span><span class="no">b442418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45527a</span>        <span class="mi">4889442410</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># 返回值 AX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45527f</span>        <span class="mi">488</span><span class="no">b6c2420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455284</span>        <span class="mi">4883</span><span class="no">c428</span>            <span class="no">ADDQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455288</span>        <span class="no">c3</span>                  <span class="no">RET</span>            
</span></span><span class="line"><span class="cl"><span class="no">func</span> <span class="no">newInt</span><span class="p">()</span> <span class="p">*</span><span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455289</span>        <span class="no">e8d2ccffff</span>          <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45528e</span>        <span class="no">ebb0</span>                <span class="no">JMP</span> <span class="no">main.newInt</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="局部变量地址作为返回值2">局部变量地址作为返回值(2)<a hidden class="anchor" aria-hidden="true" href="#局部变量地址作为返回值2">#</a></h4>
<ol>
<li>如果把 <code>newInt()</code> 函数中的取地址运算改成使用内置函数 <code>new()</code>，效果也是一样的，代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newInt</span><span class="p">()</span> <span class="o">*</span><span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">new</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>相关汇编：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">go</span> <span class="no">build</span> <span class="p">-</span><span class="no">gcflags</span><span class="err">=&#34;</span><span class="p">-</span><span class="no">N</span> <span class="p">-</span><span class="no">l</span><span class="err">&#34;</span> <span class="p">-</span><span class="no">o</span> <span class="p">.</span><span class="err">/</span><span class="no">h1</span> <span class="no">myzx.cn</span><span class="err">/</span><span class="no">helium</span>
</span></span><span class="line"><span class="cl"><span class="nf">$</span> <span class="no">go</span> <span class="no">tool</span> <span class="no">objdump</span> <span class="p">-</span><span class="no">S</span> <span class="p">-</span><span class="no">s</span> <span class="err">&#39;^</span><span class="no">main.newInt$</span><span class="err">&#39;</span> <span class="p">.</span><span class="err">/</span><span class="no">h1</span> 
</span></span><span class="line"><span class="cl"><span class="no">TEXT</span> <span class="no">main.newInt</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">newInt</span><span class="p">()</span> <span class="p">*</span><span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455240</span>        <span class="mi">493</span><span class="no">b6610</span>              <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455244</span>        <span class="mi">7637</span>                  <span class="no">JBE</span> <span class="mi">0x45527d</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455246</span>        <span class="mi">4883</span><span class="no">ec28</span>              <span class="no">SUBQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45524a</span>        <span class="mi">48896</span><span class="no">c2420</span>            <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45524f</span>        <span class="mi">488</span><span class="no">d6c2420</span>            <span class="no">LEAQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455254</span>        <span class="mi">48</span><span class="no">c744241000000000</span>    <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># *int 返回值空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">return</span> <span class="no">new</span><span class="p">(</span><span class="no">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># func newobject(typ *_type) unsafe.Pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45525d</span>        <span class="mi">488</span><span class="no">d05bc4a0000</span>        <span class="no">LEAQ</span> <span class="mi">0x4abc</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>    <span class="c1"># type.int 元类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455264</span>        <span class="no">e8d75cfbff</span>            <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    <span class="c1"># AX=*int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455269</span>        <span class="mi">4889442418</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45526e</span>        <span class="mi">4889442410</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455273</span>        <span class="mi">488</span><span class="no">b6c2420</span>            <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455278</span>        <span class="mi">4883</span><span class="no">c428</span>              <span class="no">ADDQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x45527c</span>        <span class="no">c3</span>                    <span class="no">RET</span>                
</span></span><span class="line"><span class="cl"><span class="no">func</span> <span class="no">newInt</span><span class="p">()</span> <span class="p">*</span><span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45527d</span>        <span class="mi">0</span><span class="no">f1f00</span>                <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x455280</span>        <span class="no">e8dbccffff</span>            <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455285</span>        <span class="no">ebb9</span>                  <span class="no">JMP</span> <span class="no">main.newInt</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>当函数局部变量的生命周期超过函数栈的生命周期时，编译器把该局部变量由<strong>栈</strong>分配改为<strong>堆</strong>分配，即变量从栈上逃逸到堆上。</li>
</ol>
<h3 id="不逃逸分析">不逃逸分析<a hidden class="anchor" aria-hidden="true" href="#不逃逸分析">#</a></h3>
<p>只要使用了new()函数就会造成堆分配?</p>
<ol>
<li>前面逃逸分析代码示例中将函数的某个局部变量的地址作为返回值返回，或者通过内置函数 <code>new()</code> 动态分配变量并返回其地址。</li>
<li>其中内置函数<code>new()</code>有着非常明显的堆分配的含义，<strong>是不是</strong>只要使用了<code>new()</code>函数就会造成堆分配呢？</li>
<li>进一步猜想，如果对局部变量进行取地址操作会被转换为<code>new()</code>函数调用，那就不会进行所谓的逃逸分析了。</li>
<li>先验证<code>new()</code>函数与堆分配是否有必然关系，代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">p</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">*</span><span class="nx">p</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>反编译<code>new()</code>函数，得到的汇编代码如下：
<ol>
<li>即便代码中使用了<code>new()</code>函数，只要<strong>变量的生命周期没有超过过当前函数栈的生命周期</strong>，编译器就<strong>不会进行堆分配</strong>。</li>
<li>事实上，只要代码逻辑允许，<strong>编译器总是倾向于把变量分配在栈上</strong>，因为比配在堆上更高效。</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.New</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">New</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455240</span>        <span class="mi">4883</span><span class="no">ec20</span>            <span class="no">SUBQ</span> <span class="no">$0x20</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455244</span>        <span class="mi">48896</span><span class="no">c2418</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455249</span>        <span class="mi">488</span><span class="no">d6c2418</span>          <span class="no">LEAQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45524e</span>        <span class="mi">48</span><span class="no">c7042400000000</span>    <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># 返回地址 int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">p</span> <span class="p">:</span><span class="err">=</span> <span class="no">new</span><span class="p">(</span><span class="no">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># new 函数直接是在栈上分配的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455256</span>        <span class="mi">48</span><span class="no">c744240800000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span> <span class="c1"># 0x8(SP) 用作int类型存储 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45525f</span>        <span class="mi">488</span><span class="no">d4c2408</span>          <span class="no">LEAQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>   <span class="c1"># CX=0x8(SP); 也就是 *int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455264</span>        <span class="mi">48894</span><span class="no">c2410</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>  <span class="c1"># 0x10(SP); *int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">return</span> <span class="p">*</span><span class="no">p</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455269</span>        <span class="mi">8401</span>                <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45526b</span>        <span class="mi">488</span><span class="no">b442408</span>          <span class="no">MOVQ</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455270</span>        <span class="mi">48890424</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455274</span>        <span class="mi">488</span><span class="no">b6c2418</span>          <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455279</span>        <span class="mi">4883</span><span class="no">c420</span>            <span class="no">ADDQ</span> <span class="no">$0x20</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45527d</span>        <span class="no">c3</span>                  <span class="no">RET</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>这也就是本节所谓的不逃逸分析，或者说未逃逸分析，这种说法并不严谨，主要是为了突出<strong>编译器倾向于让变量不逃逸</strong>。</li>
</ol>
<h3 id="不逃逸判断">不逃逸判断<a hidden class="anchor" aria-hidden="true" href="#不逃逸判断">#</a></h3>
<h4 id="包级别指针1">包级别指针(1)<a hidden class="anchor" aria-hidden="true" href="#包级别指针1">#</a></h4>
<ol>
<li>本节主要探索编译器进行逃逸分析时<strong>追踪的范围</strong>，以及在什么情况下就认为变量逃逸了或者确定变量没有逃逸。</li>
<li>前面研究变量逃逸所有的方法，主要通过让函数返回局部变量的地址，使局部变量的生命周期超过对应函数栈帧的生命周期。</li>
<li>按照这个规则来猜想，如果<strong>把局部变量的地址赋值给包级别的指针变量</strong>，应该也会造成变量逃逸。</li>
<li>准备一个示例，代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">pt</span> <span class="o">*</span><span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">setNew</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">a</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pt</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">a</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>反编译 <code>setNew()</code> 函数，代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.setNew</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">setNew</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>        <span class="mi">493</span><span class="no">b6610</span>              <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>          <span class="c1"># 栈增长判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455224</span>        <span class="mi">765</span><span class="no">d</span>                  <span class="no">JBE</span> <span class="mi">0x455283</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455226</span>        <span class="mi">4883</span><span class="no">ec20</span>              <span class="no">SUBQ</span> <span class="no">$0x20</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45522a</span>        <span class="mi">48896</span><span class="no">c2418</span>            <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45522f</span>        <span class="mi">488</span><span class="no">d6c2418</span>            <span class="no">LEAQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">    <span class="no">var</span> <span class="no">a</span> <span class="no">int</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455234</span>        <span class="mi">488</span><span class="no">d05e54a0000</span>        <span class="no">LEAQ</span> <span class="mi">0x4ae5</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>         <span class="c1"># type.int 元类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45523b</span>        <span class="mi">0</span><span class="no">f1f440000</span>            <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)(</span><span class="no">AX</span><span class="p">*</span><span class="mi">1</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">  <span class="c1"># func newobject(typ *_type) unsafe.Pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># 这里直接调用了 newobject 堆分配了 int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455240</span>        <span class="no">e8fb5cfbff</span>            <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># *int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455245</span>        <span class="mi">4889442410</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45524a</span>        <span class="mi">48</span><span class="no">c70000000000</span>        <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>            <span class="c1"># a = 0    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">pt</span> <span class="err">=</span> <span class="err">&amp;</span><span class="no">a</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455251</span>        <span class="mi">488</span><span class="no">b4c2410</span>            <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>           <span class="c1"># CX=0x10(SP)=*int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># 判断是否开启写屏障，因为可能在GC阶段，变量的赋值需要写屏障
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455256</span>        <span class="mi">833</span><span class="no">d0320090000</span>        <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45525d</span>        <span class="mi">7403</span>                  <span class="no">JE</span> <span class="mi">0x455262</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x45525f</span>        <span class="mi">90</span>                    <span class="no">NOPL</span>                    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455260</span>        <span class="no">eb09</span>                  <span class="no">JMP</span> <span class="mi">0x45526b</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x455262</span>        <span class="mi">48890</span><span class="no">db7320600</span>        <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="no">main.pt</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>        <span class="c1"># 给全局变量 pt 赋值    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455269</span>        <span class="no">eb0e</span>                  <span class="no">JMP</span> <span class="mi">0x455279</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x45526b</span>        <span class="mi">488</span><span class="no">d3dae320600</span>        <span class="no">LEAQ</span> <span class="no">main.pt</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">DI</span>            
</span></span><span class="line"><span class="cl">  <span class="c1"># 写屏障开启的时候调用写屏障相关函数，记录指针的变更，已帮助GC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455272</span>        <span class="no">e8a9d0ffff</span>            <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrierCX</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455277</span>        <span class="no">eb00</span>                  <span class="no">JMP</span> <span class="mi">0x455279</span>                
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455279</span>        <span class="mi">488</span><span class="no">b6c2418</span>            <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45527e</span>        <span class="mi">4883</span><span class="no">c420</span>              <span class="no">ADDQ</span> <span class="no">$0x20</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455282</span>        <span class="no">c3</span>                    <span class="no">RET</span>            
</span></span><span class="line"><span class="cl"><span class="no">func</span> <span class="no">setNew</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455283</span>        <span class="no">e8d8ccffff</span>            <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455288</span>        <span class="no">eb96</span>                  <span class="no">JMP</span> <span class="no">main.setNew</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>通过 <code>runtime.newobject()</code> 函数调用就能确定，变量a逃逸到了堆上，验证了上述猜想。</li>
</ol>
<h4 id="包级别指针2">包级别指针(2)<a hidden class="anchor" aria-hidden="true" href="#包级别指针2">#</a></h4>
<ol>
<li>进一步还可以验证逃逸分析的依赖传递性，准备示例代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">pp</span> <span class="o">**</span><span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">dep</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">a</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">p</span> <span class="o">*</span><span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">p</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">a</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pp</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">p</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>反编译 <code>dep()</code> 函数：
<ol>
<li>可以发现，变量 p 和 a 都逃逸了。</li>
<li>p 的地址被赋值给包级别的指针变量 pp，而 a 的地址又被赋值给了 p，因为 p 逃逸造成 a 也逃逸了。</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.dep</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">dep</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455220</span>        <span class="mi">493</span><span class="no">b6610</span>              <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>          <span class="c1"># 栈增长判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455224</span>        <span class="mi">0</span><span class="no">f86b0000000</span>          <span class="no">JBE</span> <span class="mi">0x4552da</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45522a</span>        <span class="mi">4883</span><span class="no">ec28</span>              <span class="no">SUBQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45522e</span>        <span class="mi">48896</span><span class="no">c2420</span>            <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455233</span>        <span class="mi">488</span><span class="no">d6c2420</span>            <span class="no">LEAQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">    <span class="no">var</span> <span class="no">a</span> <span class="no">int</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455238</span>        <span class="mi">488</span><span class="no">d05e14a0000</span>        <span class="no">LEAQ</span> <span class="mi">0x4ae1</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>         <span class="c1"># type.int 元类型;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45523f</span>        <span class="mi">90</span>            <span class="no">NOPL</span>        
</span></span><span class="line"><span class="cl">  <span class="c1"># func newobject(typ *_type) unsafe.Pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455240</span>        <span class="no">e8fb5cfbff</span>            <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># 堆分配了 a 变量; AX *int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455245</span>        <span class="mi">4889442418</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>           <span class="c1"># 0x18(SP); 是a的内存空间，指向堆分配数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45524a</span>        <span class="mi">48</span><span class="no">c70000000000</span>        <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>            <span class="c1"># 初始化 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">var</span> <span class="no">p</span> <span class="p">*</span><span class="no">int</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455251</span>        <span class="mi">488</span><span class="no">d0508320000</span>        <span class="no">LEAQ</span> <span class="mi">0x3208</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>         <span class="c1"># type *int 元类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1"># func newobject(typ *_type) unsafe.Pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455258</span>        <span class="no">e8e35cfbff</span>            <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>  <span class="c1"># **int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45525d</span>        <span class="mi">4889442410</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x455262</span>        <span class="mi">833</span><span class="no">df71f090000</span>        <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455269</span>        <span class="mi">7402</span>                  <span class="no">JE</span> <span class="mi">0x45526d</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x45526b</span>        <span class="no">eb09</span>                  <span class="no">JMP</span> <span class="mi">0x455276</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x45526d</span>        <span class="mi">48</span><span class="no">c70000000000</span>        <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x455274</span>        <span class="no">eb11</span>                  <span class="no">JMP</span> <span class="mi">0x455287</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x455276</span>        <span class="mi">4889</span><span class="no">c7</span>                <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="no">DI</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x455279</span>        <span class="mi">31</span><span class="no">c0</span>                  <span class="no">XORL</span> <span class="no">AX</span><span class="p">,</span> <span class="no">AX</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x45527b</span>        <span class="mi">0</span><span class="no">f1f440000</span>            <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)(</span><span class="no">AX</span><span class="p">*</span><span class="mi">1</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x455280</span>        <span class="no">e89bcfffff</span>            <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455285</span>        <span class="no">eb00</span>                  <span class="no">JMP</span> <span class="mi">0x455287</span>                
</span></span><span class="line"><span class="cl">    <span class="no">p</span> <span class="err">=</span> <span class="err">&amp;</span><span class="no">a</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455287</span>        <span class="mi">488</span><span class="no">b7c2410</span>            <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DI</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x45528c</span>        <span class="mi">488</span><span class="no">b442418</span>            <span class="no">MOVQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x455291</span>        <span class="mi">833</span><span class="no">dc81f090000</span>        <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455298</span>        <span class="mi">7402</span>                  <span class="no">JE</span> <span class="mi">0x45529c</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x45529a</span>        <span class="no">eb06</span>                  <span class="no">JMP</span> <span class="mi">0x4552a2</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x45529c</span>        <span class="mi">488907</span>                <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">DI</span><span class="p">)</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x45529f</span>        <span class="mi">90</span>                    <span class="no">NOPL</span>                    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552a0</span>        <span class="no">eb07</span>                  <span class="no">JMP</span> <span class="mi">0x4552a9</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552a2</span>        <span class="no">e879cfffff</span>            <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552a7</span>        <span class="no">eb00</span>                  <span class="no">JMP</span> <span class="mi">0x4552a9</span>                
</span></span><span class="line"><span class="cl">    <span class="no">pp</span> <span class="err">=</span> <span class="err">&amp;</span><span class="no">p</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552a9</span>        <span class="mi">488</span><span class="no">b442410</span>            <span class="no">MOVQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552ae</span>        <span class="mi">833</span><span class="no">dab1f090000</span>        <span class="no">CMPL</span> <span class="no">$0x0</span><span class="p">,</span> <span class="no">runtime.writeBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552b5</span>        <span class="mi">7402</span>                  <span class="no">JE</span> <span class="mi">0x4552b9</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552b7</span>        <span class="no">eb09</span>                  <span class="no">JMP</span> <span class="mi">0x4552c2</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552b9</span>        <span class="mi">48890560320600</span>        <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="no">main.pp</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552c0</span>        <span class="no">eb0e</span>                  <span class="no">JMP</span> <span class="mi">0x4552d0</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552c2</span>        <span class="mi">488</span><span class="no">d3d57320600</span>        <span class="no">LEAQ</span> <span class="no">main.pp</span><span class="p">(</span><span class="no">SB</span><span class="p">),</span> <span class="no">DI</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552c9</span>        <span class="no">e852cfffff</span>            <span class="no">CALL</span> <span class="no">runtime.gcWriteBarrier</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552ce</span>        <span class="no">eb00</span>                  <span class="no">JMP</span> <span class="mi">0x4552d0</span>                
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552d0</span>        <span class="mi">488</span><span class="no">b6c2420</span>            <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552d5</span>        <span class="mi">4883</span><span class="no">c428</span>              <span class="no">ADDQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552d9</span>        <span class="no">c3</span>                    <span class="no">RET</span>            
</span></span><span class="line"><span class="cl"><span class="no">func</span> <span class="no">dep</span><span class="p">()</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552da</span>        <span class="no">e881ccffff</span>            <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552df</span>        <span class="mi">90</span>                    <span class="no">NOPL</span>                    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552e0</span>        <span class="no">e93bffffff</span>            <span class="no">JMP</span> <span class="no">main.dep</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>假如某个函数有一个参数和一个返回值，类型都是整型指针，函数只是简单地把参数作为返回值。</li>
</ol>
<h4 id="在函数间传递">在函数间传递<a hidden class="anchor" aria-hidden="true" href="#在函数间传递">#</a></h4>
<ol>
<li>就像下面的 <code>gom.RetArg()</code> 函数，代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">gom</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">RetArg</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">p</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>在另一个包中 <code>arg()</code> 函数调用了 <code>inner.RetArg()</code> 函数将局部变量 a 的地址作为参数，并返回了一个 int 类型的返回值。</li>
<li>代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">arg</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">a</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">*</span><span class="nx">gom</span><span class="p">.</span><span class="nf">RetArg</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>在 arg() 函数中并没有把变量 a 的地址作为返回值，也不存在到某个包级别指针变量的依赖链路，所以变量a是否会逃逸的关键就在于<code>inner.RetArg()</code>函数。</li>
<li><code>inner. RetArg()</code>函数只是把传过去的指针又传了回来，而且作为被调用者来讲，它的生命周期是完全包含在<code>arg()</code>函数的生命周期以内的，所以不应该造成变量 a 逃逸。</li>
<li>事实到底如何呢? 还要通过反编译验证，节选部分关键汇编代码如下：
<ol>
<li>变量a确实是在栈上分配的，也就说明<strong>编译器参考了inner.RetArg()函数的具体实现</strong>，基于代码逻辑判定变量 a 没有逃逸。</li>
<li>虽然代码中通过**<code>noinline</code><strong>阻止了内联优化，但是</strong>没能阻止编译器参考函数实现**。</li>
<li>假如通过某种方式能够阻止编译器参考函数实现，又会有什么样的结果呢?</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.arg</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">arg</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455240</span>        <span class="mi">493</span><span class="no">b6610</span>              <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>    <span class="c1"># 栈增长判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455244</span>        <span class="mi">7643</span>                  <span class="no">JBE</span> <span class="mi">0x455289</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455246</span>        <span class="mi">4883</span><span class="no">ec28</span>              <span class="no">SUBQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45524a</span>        <span class="mi">48896</span><span class="no">c2420</span>            <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45524f</span>        <span class="mi">488</span><span class="no">d6c2420</span>            <span class="no">LEAQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455254</span>        <span class="mi">48</span><span class="no">c744240800000000</span>    <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># return int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">var</span> <span class="no">a</span> <span class="no">int</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45525d</span>        <span class="mi">48</span><span class="no">c744241000000000</span>    <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">    <span class="no">return</span> <span class="p">*</span><span class="no">gom.RetArg</span><span class="p">(</span><span class="err">&amp;</span><span class="no">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 可以看出这里调用gom.RetArg函数时参数直接是在栈上分配的，并没有堆分配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455266</span>        <span class="mi">488</span><span class="no">d442410</span>            <span class="no">LEAQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x45526b</span>        <span class="no">e870ffffff</span>            <span class="no">CALL</span> <span class="no">example.com</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">gom.RetArg</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455270</span>        <span class="mi">4889442418</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x455275</span>        <span class="mi">8400</span>                  <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x455277</span>        <span class="mi">488</span><span class="no">b00</span>                <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">),</span> <span class="no">AX</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x45527a</span>        <span class="mi">4889442408</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x45527f</span>        <span class="mi">488</span><span class="no">b6c2420</span>            <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x455284</span>        <span class="mi">4883</span><span class="no">c428</span>              <span class="no">ADDQ</span> <span class="no">$0x28</span><span class="p">,</span> <span class="no">SP</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x455288</span>        <span class="no">c3</span>                    <span class="no">RET</span>                    
</span></span><span class="line"><span class="cl"><span class="no">func</span> <span class="no">arg</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455289</span>        <span class="no">e8d2ccffff</span>            <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45528e</span>        <span class="no">ebb0</span>                  <span class="no">JMP</span> <span class="no">main.arg</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="linkname-机制">linkname 机制<a hidden class="anchor" aria-hidden="true" href="#linkname-机制">#</a></h4>
<ol>
<li>可以使用 <code>linkname</code> 机制，连同修改后的 <code>arg()</code> 函数的代码如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;example.com/helium/gom&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="s">&#34;unsafe&#34;</span> <span class="c1">// 使用了 go:linkname 必须要引入 unsafe 包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">arg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:linkname retArg example.com/helium/gom.RetArg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">retArg</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//go:noinline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">arg</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">a</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">b</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">*</span><span class="nx">gom</span><span class="p">.</span><span class="nf">RetArg</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">a</span><span class="p">)</span> <span class="o">+</span> <span class="nf">retArg</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>再次反编译 <code>arg()</code> 函数，节选变量 a 和 b 分配相关的汇编代码如下：
<ol>
<li>变量 a 依旧是栈分配，变量 b 已经逃逸了。</li>
<li>在上述代码中的 <code>retArg()</code> 函数只是个函数声明没有给出具体实现，通过 <code>linkname</code> 机制让链接器在链接阶段链接到 <code>inner.RetArg()</code> 函数。</li>
<li><code>retArg()</code> 函数只有声明没有实现，而且编译器不会跟踪 <code>linkname</code>，所以无法根据代码逻辑判定变量 b 到底有没有逃逸。</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.arg</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">workspace</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">main.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">arg</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455240</span>        <span class="mi">493</span><span class="no">b6610</span>              <span class="no">CMPQ</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">SP</span>    <span class="c1"># 栈增长判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455244</span>        <span class="mi">7677</span>                  <span class="no">JBE</span> <span class="mi">0x4552bd</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x455246</span>        <span class="mi">4883</span><span class="no">ec40</span>              <span class="no">SUBQ</span> <span class="no">$0x40</span><span class="p">,</span> <span class="no">SP</span>        
</span></span><span class="line"><span class="cl">  <span class="mi">0x45524a</span>        <span class="mi">48896</span><span class="no">c2438</span>            <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x45524f</span>        <span class="mi">488</span><span class="no">d6c2438</span>            <span class="no">LEAQ</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455254</span>        <span class="mi">48</span><span class="no">c744241000000000</span>    <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># return int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">var</span> <span class="no">a</span> <span class="no">int</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45525d</span>        <span class="mi">48</span><span class="no">c744241800000000</span>    <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>    <span class="c1"># a,0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">var</span> <span class="no">b</span> <span class="no">int</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455266</span>        <span class="mi">488</span><span class="no">d05b34a0000</span>        <span class="no">LEAQ</span> <span class="mi">0x4ab3</span><span class="p">(</span><span class="no">IP</span><span class="p">),</span> <span class="no">AX</span>    <span class="c1"># type.int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45526d</span>        <span class="no">e8ce5cfbff</span>            <span class="no">CALL</span> <span class="no">runtime.newobject</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    <span class="c1"># *int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455272</span>        <span class="mi">4889442430</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span> <span class="c1"># 变量b，堆分配了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455277</span>        <span class="mi">48</span><span class="no">c70000000000</span>        <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">    <span class="no">return</span> <span class="p">*</span><span class="no">gom.RetArg</span><span class="p">(</span><span class="err">&amp;</span><span class="no">a</span><span class="p">)</span> <span class="err">+</span> <span class="p">*</span><span class="no">retArg</span><span class="p">(</span><span class="err">&amp;</span><span class="no">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45527e</span>        <span class="mi">488</span><span class="no">d442418</span>            <span class="no">LEAQ</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x455283</span>        <span class="no">e858ffffff</span>            <span class="no">CALL</span> <span class="no">example.com</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">gom.RetArg</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455288</span>        <span class="mi">4889442428</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x45528d</span>        <span class="mi">488</span><span class="no">b442430</span>            <span class="no">MOVQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">AX</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x455292</span>        <span class="no">e849ffffff</span>            <span class="no">CALL</span> <span class="no">example.com</span><span class="err">/</span><span class="no">helium</span><span class="err">/</span><span class="no">gom.RetArg</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x455297</span>        <span class="mi">4889442420</span>            <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x45529c</span>        <span class="mi">488</span><span class="no">b4c2428</span>            <span class="no">MOVQ</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552a1</span>        <span class="mi">8401</span>                  <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">)</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552a3</span>        <span class="mi">8400</span>                  <span class="no">TESTB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552a5</span>        <span class="mi">488</span><span class="no">b09</span>                <span class="no">MOVQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">CX</span><span class="p">),</span> <span class="no">CX</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552a8</span>        <span class="mi">480308</span>                <span class="no">ADDQ</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">),</span> <span class="no">CX</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552ab</span>        <span class="mi">48894</span><span class="no">c2410</span>            <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552b0</span>        <span class="mi">4889</span><span class="no">c8</span>                <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="no">AX</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552b3</span>        <span class="mi">488</span><span class="no">b6c2438</span>            <span class="no">MOVQ</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>            
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552b8</span>        <span class="mi">4883</span><span class="no">c440</span>              <span class="no">ADDQ</span> <span class="no">$0x40</span><span class="p">,</span> <span class="no">SP</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552bc</span>        <span class="no">c3</span>                    <span class="no">RET</span>                    
</span></span><span class="line"><span class="cl"><span class="no">func</span> <span class="no">arg</span><span class="p">()</span> <span class="no">int</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552bd</span>        <span class="mi">0</span><span class="no">f1f00</span>                <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>                
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552c0</span>        <span class="no">e89bccffff</span>            <span class="no">CALL</span> <span class="no">runtime.morestack_noctxt.abi0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>    
</span></span><span class="line"><span class="cl">  <span class="mi">0x4552c5</span>        <span class="no">e976ffffff</span>            <span class="no">JMP</span> <span class="no">main.arg</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>把逻辑上没有逃逸的变量分配到堆上不会造成错误，只是效率低一些。</li>
<li>但是把逻辑上逃逸了的变量分配到栈上就会造成悬挂指针等问题。</li>
<li>因此编译器只有在能够确定变量没有逃逸的情况下，才会将其分配到栈上，在能够确定变量已经逃逸或无法确定到底有没有逃逸的情况下，都要按照已经逃逸来处理。</li>
<li>这也就解释了为什么在上述代码中的变量 b 逻辑上没逃逸却被分配在了堆上。</li>
</ol>
<h2 id="函数示例">函数示例<a hidden class="anchor" aria-hidden="true" href="#函数示例">#</a></h2>
<h3 id="示例一">示例一<a hidden class="anchor" aria-hidden="true" href="#示例一">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// sum 计算a, b的平方和
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">sum</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a2</span> <span class="o">:=</span> <span class="nx">a</span> <span class="o">*</span> <span class="nx">a</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b2</span> <span class="o">:=</span> <span class="nx">b</span> <span class="o">*</span> <span class="nx">b</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">a2</span> <span class="o">+</span> <span class="nx">b2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li><code>main.main</code>汇编：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">g</span><span class="err">/</span><span class="no">hello1</span><span class="err">/</span><span class="no">hello.go</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 判断栈是否溢出 0x10(R14)指向g.stackguard0位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">3</span>    <span class="err">0</span><span class="nf">x45b4a0</span>    <span class="mi">493</span><span class="no">b6610</span>      <span class="no">cmp</span> <span class="no">rsp</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">r14</span><span class="err">+</span><span class="mi">0x10</span><span class="p">]</span>          <span class="no">cmp</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">R14</span><span class="p">),</span> <span class="no">rsp</span>    
</span></span><span class="line"><span class="cl">    <span class="c1"># 跳转到0x45b4cf处设置栈信息，在重新调main.main函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">3</span>    <span class="err">0</span><span class="nf">x45b4a4</span>    <span class="mi">7629</span>          <span class="no">jbe</span> <span class="mi">0x45b4cf</span>                           <span class="no">jbe</span> <span class="mi">0x45b4cf</span>        
</span></span><span class="line"><span class="cl">    <span class="c1"># 为当前栈预分配参数空间，第一个8B存储runtime.main的rbp，第二个8B存储main.sun的参数b为1，第三个8B存储main.sun的参数a为2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">3</span>    <span class="err">0</span><span class="nf">x45b4a6</span>    <span class="mi">4883</span><span class="no">ec18</span>      <span class="no">sub</span> <span class="no">rsp</span><span class="p">,</span> <span class="mi">0x18</span>                          <span class="no">sub</span> <span class="mi">0x18</span><span class="p">,</span> <span class="no">rsp</span>        
</span></span><span class="line"><span class="cl">    <span class="c1"># 把runtime.main的栈rbp存入0x10(rsp)处
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">3</span>    <span class="err">0</span><span class="nf">x45b4aa</span>    <span class="mi">48896</span><span class="no">c2410</span>    <span class="no">mov</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">0x10</span><span class="p">],</span> <span class="no">rbp</span>          <span class="no">mov</span> <span class="no">rbp</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">rsp</span><span class="p">)</span>        
</span></span><span class="line"><span class="cl">    <span class="c1"># 从新设置当前main.main的栈rbp值为0x10(rsp)处
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">3</span>    <span class="err">0</span><span class="nf">x45b4af</span>    <span class="mi">488</span><span class="no">d6c2410</span>    <span class="no">lea</span> <span class="no">rbp</span><span class="p">,</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">0x10</span><span class="p">]</span>                <span class="no">lea</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">rsp</span><span class="p">),</span> <span class="no">rbp</span>        
</span></span><span class="line"><span class="cl">    <span class="c1"># 为main.sum准备第一个参数，放入寄存器AX中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">4</span>    <span class="err">0</span><span class="nf">x45b4b4</span>    <span class="no">b801000000</span>    <span class="no">mov</span> <span class="no">eax</span><span class="p">,</span> <span class="mi">0x1</span>                           <span class="no">mov</span> <span class="mi">0x1</span><span class="p">,</span> <span class="no">AX</span>            
</span></span><span class="line"><span class="cl">    <span class="c1"># 为main.sum准备第二个参数，放入寄存器BX中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">4</span>    <span class="err">0</span><span class="nf">x45b4b9</span>    <span class="no">bb02000000</span>    <span class="no">mov</span> <span class="no">ebx</span><span class="p">,</span> <span class="mi">0x2</span>                           <span class="no">mov</span> <span class="mi">0x2</span><span class="p">,</span> <span class="no">BX</span>                
</span></span><span class="line"><span class="cl">    <span class="no">hello.go</span><span class="p">:</span><span class="mi">4</span>    <span class="mi">0x45b4be</span>    <span class="mi">6690</span>          <span class="no">data16</span> <span class="no">nop</span>
</span></span><span class="line"><span class="cl">    <span class="nl">hello.go:</span><span class="err">4</span>    <span class="err">0</span><span class="nf">x45b4c0</span>    <span class="no">e81b000000</span>    <span class="no">call</span> <span class="no">$main.sum</span>                         <span class="no">call</span> <span class="no">$main.sum</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 把runtime.main的栈rbp值从0x10(rsp)处放入rbp寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">5</span>    <span class="err">0</span><span class="nf">x45b4c5</span>    <span class="mi">488</span><span class="no">b6c2410</span>    <span class="no">mov</span> <span class="no">rbp</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">0x10</span><span class="p">]</span>          <span class="no">mov</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">rsp</span><span class="p">),</span> <span class="no">rbp</span>        
</span></span><span class="line"><span class="cl">    <span class="c1"># rsp寄存器恢复调用main.main之前情况
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">5</span>    <span class="err">0</span><span class="nf">x45b4ca</span>    <span class="mi">4883</span><span class="no">c418</span>      <span class="no">add</span> <span class="no">rsp</span><span class="p">,</span> <span class="mi">0x18</span>                          <span class="no">add</span> <span class="mi">0x18</span><span class="p">,</span> <span class="no">rsp</span>        
</span></span><span class="line"><span class="cl">    <span class="c1"># 返回，rsp-8弹出返回地址给rip返回的runtime.main继续执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">5</span>    <span class="err">0</span><span class="nf">x45b4ce</span>    <span class="no">c3</span>            <span class="no">ret</span>                                    <span class="no">ret</span>
</span></span><span class="line"><span class="cl">    <span class="nl">hello.go:</span><span class="err">3</span>    <span class="err">0</span><span class="nf">x45b4cf</span>    <span class="no">e88ccdffff</span>    <span class="no">call</span> <span class="no">$runtime.morestack_noctxt</span>         <span class="no">call</span> <span class="no">$runtime.morestack_noctxt</span>
</span></span><span class="line"><span class="cl">    <span class="err">.:0</span>           <span class="err">0</span><span class="nf">x45b4d4</span>    <span class="no">ebca</span>          <span class="no">jmp</span> <span class="no">$main.main</span>                         <span class="no">jmp</span> <span class="no">$main.main</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li><code>main.sum</code>汇编：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.sum</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">g</span><span class="err">/</span><span class="no">hello1</span><span class="err">/</span><span class="no">hello.go</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 为main.sum栈预分配0x28空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">8</span>    <span class="err">0</span><span class="nf">x45b4e0</span>    <span class="mi">4883</span><span class="no">ec28</span>          <span class="no">sub</span> <span class="no">rsp</span><span class="p">,</span> <span class="mi">0x28</span>                        <span class="no">sub</span> <span class="mi">0x28</span><span class="p">,</span> <span class="no">rsp</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 把main.main的rbp存储到0x20(rsp)位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">8</span>    <span class="err">0</span><span class="nf">x45b4e4</span>    <span class="mi">48896</span><span class="no">c2420</span>        <span class="no">mov</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">0x20</span><span class="p">],</span> <span class="no">rbp</span>        <span class="no">mov</span> <span class="no">rbp</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">rsp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 从新设置main.sum的rbp值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">8</span>    <span class="err">0</span><span class="nf">x45b4e9</span>    <span class="mi">488</span><span class="no">d6c2420</span>        <span class="no">lea</span> <span class="no">rbp</span><span class="p">,</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">0x20</span><span class="p">]</span>              <span class="no">lea</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">rsp</span><span class="p">),</span> <span class="no">rbp</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 把传递的第一个参数入栈，注意看这里参参数栈分配在main.main的栈上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">8</span>    <span class="err">0</span><span class="nf">x45b4ee</span>    <span class="mi">4889442430</span>        <span class="no">mov</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">0x30</span><span class="p">],</span> <span class="no">rax</span>        <span class="no">mov</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">rsp</span><span class="p">)</span>    <span class="c1"># a = 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 把传递的第二个参数入栈，注意看这里参参数栈分配在main.main的栈上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">8</span>    <span class="err">0</span><span class="nf">x45b4f3</span>    <span class="mi">48895</span><span class="no">c2438</span>        <span class="no">mov</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">0x38</span><span class="p">],</span> <span class="no">rbx</span>        <span class="no">mov</span> <span class="no">BX</span><span class="p">,</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">rsp</span><span class="p">)</span>    <span class="c1"># b = 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 初始化rsp的第一个8字节吗，返回值空间初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">8</span>    <span class="err">0</span><span class="nf">x45b4f8</span>    <span class="mi">48</span><span class="no">c7042400000000</span>  <span class="no">mov</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="p">],</span> <span class="mi">0x0</span>             <span class="no">mov</span> <span class="mi">0x0</span><span class="p">,</span> <span class="p">(</span><span class="no">rsp</span><span class="p">)</span>       <span class="c1"># return
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 为乘法运算做准备，把变量a的值放入寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">9</span>    <span class="err">0</span><span class="nf">x45b500</span>    <span class="mi">488</span><span class="no">b4c2430</span>        <span class="no">mov</span> <span class="no">rcx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">0x30</span><span class="p">]</span>        <span class="no">mov</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">rsp</span><span class="p">),</span> <span class="no">CX</span>        
</span></span><span class="line"><span class="cl">    <span class="c1"># 为乘法运算做准备，把变量a的值放入寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">9</span>    <span class="err">0</span><span class="nf">x45b505</span>    <span class="mi">488</span><span class="no">b542430</span>        <span class="no">mov</span> <span class="no">rdx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">0x30</span><span class="p">]</span>        <span class="no">mov</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">rsp</span><span class="p">),</span> <span class="no">DX</span>        
</span></span><span class="line"><span class="cl">    <span class="c1"># 乘法运算，结果存储在DX中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">9</span>    <span class="err">0</span><span class="nf">x45b50a</span>    <span class="mi">480</span><span class="no">fafd1</span>          <span class="no">imul</span> <span class="no">rdx</span><span class="p">,</span> <span class="no">rcx</span>                        <span class="no">imul</span> <span class="no">CX</span><span class="p">,</span> <span class="no">DX</span>          <span class="c1"># a*a        
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 0X18(rsp)的地址为变量a2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">9</span>    <span class="err">0</span><span class="nf">x45b50e</span>    <span class="mi">4889542418</span>        <span class="no">mov</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">0x18</span><span class="p">],</span> <span class="no">rdx</span>        <span class="no">mov</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0X18</span><span class="p">(</span><span class="no">rsp</span><span class="p">)</span>    <span class="c1"># a2=a*a    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 为乘法运算做准备，把变量b的值放入寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">10</span>    <span class="err">0</span><span class="nf">x45b513</span>    <span class="mi">488</span><span class="no">b4c2438</span>       <span class="no">mov</span> <span class="no">rcx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">0x38</span><span class="p">]</span>        <span class="no">mov</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">rsp</span><span class="p">),</span> <span class="no">CX</span>    
</span></span><span class="line"><span class="cl">    <span class="c1"># 为乘法运算做准备，把变量b的值放入寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">10</span>    <span class="err">0</span><span class="nf">x45b518</span>    <span class="mi">488</span><span class="no">b542438</span>       <span class="no">mov</span> <span class="no">rdx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">0x38</span><span class="p">]</span>        <span class="no">mov</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">rsp</span><span class="p">),</span> <span class="no">DX</span>        
</span></span><span class="line"><span class="cl">    <span class="c1"># 乘法运算，结果存储在DX中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">10</span>    <span class="err">0</span><span class="nf">x45b51d</span>    <span class="mi">480</span><span class="no">fafd1</span>         <span class="no">imul</span> <span class="no">rdx</span><span class="p">,</span> <span class="no">rcx</span>                        <span class="no">imul</span> <span class="no">CX</span><span class="p">,</span> <span class="no">DX</span>  <span class="c1"># b*b        
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 0X10(rsp)的地址为变量b2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">10</span>    <span class="err">0</span><span class="nf">x45b521</span>    <span class="mi">4889542410</span>       <span class="no">mov</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">0x10</span><span class="p">],</span> <span class="no">rdx</span>        <span class="no">mov</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x10</span><span class="p">(</span><span class="no">rsp</span><span class="p">)</span>    <span class="c1"># b2 = b*b    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 把a2值放入CX寄存器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">11</span>    <span class="err">0</span><span class="nf">x45b526</span>    <span class="mi">488</span><span class="no">b4c2418</span>       <span class="no">mov</span> <span class="no">rcx</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">0x18</span><span class="p">]</span>        <span class="no">mov</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">rsp</span><span class="p">),</span> <span class="no">CX</span>        
</span></span><span class="line"><span class="cl">    <span class="c1"># 计算 a2 + b2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">11</span>    <span class="err">0</span><span class="nf">x45b52b</span>    <span class="mi">488</span><span class="no">d0411</span>         <span class="no">lea</span> <span class="no">rax</span><span class="p">,</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rcx</span><span class="err">+</span><span class="no">rdx</span><span class="p">*</span><span class="mi">1</span><span class="p">]</span>             <span class="no">lea</span> <span class="p">(</span><span class="no">CX</span><span class="err">+</span><span class="no">DX</span><span class="p">*</span><span class="mi">1</span><span class="p">),</span> <span class="no">AX</span>    <span class="c1"># a2+b2    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># a2 + b2 值存入0x8(rsp)是变量的值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">11</span>    <span class="err">0</span><span class="nf">x45b52f</span>    <span class="mi">4889442408</span>       <span class="no">mov</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">0x8</span><span class="p">],</span> <span class="no">rax</span>         <span class="no">mov</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x8</span><span class="p">(</span><span class="no">rsp</span><span class="p">)</span>     <span class="c1"># c = a2+b2    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># a2 + b2 值存入(rsp) 该值是返回值空间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">13</span>    <span class="err">0</span><span class="nf">x45b534</span>    <span class="mi">48890424</span>         <span class="no">mov</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="p">],</span> <span class="no">rax</span>             <span class="no">mov</span> <span class="no">AX</span><span class="p">,</span> <span class="p">(</span><span class="no">rsp</span><span class="p">)</span>        <span class="c1"># return        
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1"># 弹出main.main的rbp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">13</span>    <span class="err">0</span><span class="nf">x45b538</span>    <span class="mi">488</span><span class="no">b6c2420</span>       <span class="no">mov</span> <span class="no">rbp</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">0x20</span><span class="p">]</span>        <span class="no">mov</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">rsp</span><span class="p">),</span> <span class="no">rbp</span>        
</span></span><span class="line"><span class="cl">    <span class="c1"># 使rsp指向main.main的栈rsp位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">.:0</span>            <span class="err">0</span><span class="nf">x45b53d</span>    <span class="mi">4883</span><span class="no">c428</span>         <span class="no">add</span> <span class="no">rsp</span><span class="p">,</span> <span class="mi">0x28</span>                        <span class="no">add</span> <span class="mi">0x28</span><span class="p">,</span> <span class="no">rsp</span>            
</span></span><span class="line"><span class="cl">    <span class="c1"># 弹出main.main的下一条指令地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="err">.:0</span>            <span class="err">0</span><span class="nf">x45b541</span>    <span class="no">c3</span>               <span class="no">ret</span>                                  <span class="no">ret</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>栈分布情况：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">// 我们看一下代码在14行时也就是main.sum函数返回前的栈布局情况
</span></span><span class="line"><span class="cl">//
</span></span><span class="line"><span class="cl">//                            栈底
</span></span><span class="line"><span class="cl">//                ----------------------------    高地址
</span></span><span class="line"><span class="cl">//               | b
</span></span><span class="line"><span class="cl">//                ----------------------------
</span></span><span class="line"><span class="cl">//               | a                                            runtime.main函数栈帧
</span></span><span class="line"><span class="cl">//                ----------------------------
</span></span><span class="line"><span class="cl">//               |   返回到runtime.main的地址        +0x48
</span></span><span class="line"><span class="cl">// -----------&gt; ---------------------------- &lt;-------------------------------------
</span></span><span class="line"><span class="cl">//               |   调用函数runtime.main的rbp       +0x40                
</span></span><span class="line"><span class="cl">//                ----------------------------                          
</span></span><span class="line"><span class="cl">//               |   main.sum的第二个参数 0x2        +0x38                
</span></span><span class="line"><span class="cl">//                ----------------------------                main.main函数栈帧
</span></span><span class="line"><span class="cl">//               |   main.sum的第一个参数 0x1        +0x30                
</span></span><span class="line"><span class="cl">//                 ----------------------------                         
</span></span><span class="line"><span class="cl">//               |   返回到main.main的地址           +0x28                
</span></span><span class="line"><span class="cl">// -----------&gt; ---------------------------- &lt;-------------------------------------
</span></span><span class="line"><span class="cl">//               |   调用函数main.main的rbp          +0x20               
</span></span><span class="line"><span class="cl">//                 ----------------------------                        
</span></span><span class="line"><span class="cl">//               |   变量a2   0x1                   +0x18               
</span></span><span class="line"><span class="cl">//                 ----------------------------                        
</span></span><span class="line"><span class="cl">//               |   变量b2   0x4                   +0x10        main.sum函数栈帧
</span></span><span class="line"><span class="cl">//                 ----------------------------                        
</span></span><span class="line"><span class="cl">//               |   变量c   0x5                    +0x8                
</span></span><span class="line"><span class="cl">//                 ----------------------------                        
</span></span><span class="line"><span class="cl">//               |   main.sum的返回值地址 0x5        +0x0                
</span></span><span class="line"><span class="cl">// -----------&gt; ---------------------------- &lt;-------------------------------------
</span></span></code></pre></div><h2 id="编译指令">编译指令<a hidden class="anchor" aria-hidden="true" href="#编译指令">#</a></h2>
<ol>
<li>编译指令：go build -gcflags=&quot;-N -l&quot; slice1.go。</li>
<li>查看具体方法的汇编指令：go tool objdump -S -s &lsquo;^main.main$&rsquo; slice1。</li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://heliu.site/tags/golang/">Golang</a></li>
      <li><a href="https://heliu.site/tags/%E5%87%BD%E6%95%B0/">函数</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://heliu.site/posts/golang/func/stack/">
    <span class="title">« 上一页</span>
    <br>
    <span>函数调用栈</span>
  </a>
  <a class="next" href="https://heliu.site/posts/golang/func/value/">
    <span class="title">下一页 »</span>
    <br>
    <span>Function Value</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        本站总访问量<span id="busuanzi_value_site_pv"></span>次
    </span>
    <span id="busuanzi_container_site_uv">
        本站访客数<span id="busuanzi_value_site_uv"></span>人次
    </span>
    </div>
        <span>Copyright © 2024 蜀ICP备2024091074号 <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
