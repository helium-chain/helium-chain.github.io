<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>paincã€recover(åŸç†) | Helium</title>
<meta name="keywords" content="golang, å‡½æ•°, panic">
<meta name="description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬">
<meta name="author" content="helium">
<link rel="canonical" href="https://heliu.site/posts/golang/func/painc-theory/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://heliu.site/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://heliu.site/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://heliu.site/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://heliu.site/apple-touch-icon.png">
<link rel="mask-icon" href="https://heliu.site/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://heliu.site/posts/golang/func/painc-theory/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="paincã€recover(åŸç†)" />
<meta property="og:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://heliu.site/posts/golang/func/painc-theory/" />
<meta property="og:image" content="https://heliu.site/favicon-32x32.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-08-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-08-06T00:00:00+00:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://heliu.site/favicon-32x32.png" />
<meta name="twitter:title" content="paincã€recover(åŸç†)"/>
<meta name="twitter:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://heliu.site/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Golang åˆé›†",
      "item": "https://heliu.site/posts/golang/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ç¬¬9ç«  Function",
      "item": "https://heliu.site/posts/golang/func/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "paincã€recover(åŸç†)",
      "item": "https://heliu.site/posts/golang/func/painc-theory/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "paincã€recover(åŸç†)",
  "name": "paincã€recover(åŸç†)",
  "description": "ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18+ç‰ˆæœ¬",
  "keywords": [
    "golang", "å‡½æ•°", "panic"
  ],
  "articleBody": " åªæœ‰åœ¨ defer å‡½æ•°ä¸­è°ƒç”¨ recover() å‡½æ•°æ‰æœ‰æ•ˆï¼Œå› ä¸ºå‘ç”Ÿ panic ä¹‹ååªæœ‰ defer å‡½æ•°èƒ½å¤Ÿå¾—åˆ°æ‰§è¡Œã€‚ Go è¯­è¨€åœ¨è®¾è®¡ä¸Šä¿è¯æ‰€æœ‰çš„ defer å‡½æ•°éƒ½èƒ½å¤Ÿå¾—åˆ°è°ƒç”¨ï¼Œæ‰€ä»¥é€‚åˆç”¨ defer æ¥é‡Šæ”¾èµ„æºï¼Œå³ä½¿å‘ç”Ÿ panic ä¹Ÿä¸ä¼šé€ æˆèµ„æºæ³„éœ²ã€‚ type _panic struct è¯¥ç»“æ„ä½“å­˜å‚¨ç€panicçš„ç›¸å…³ä¿¡æ¯ã€‚ æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/runtime2.goã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 // A _panic holds information about an active panic. // // A _panic value must only ever live on the stack. // // The argp and link fields are stack pointers, but don't need special // handling during stack growth: because they are pointer-typed and // _panic values only live on the stack, regular stack pointer // adjustment takes care of them. type _panic struct { // argp è®¾ç½®ä¸ºå½“å‰gopanic()å‡½æ•°æ ˆå¸§ä¸Šargs to calleeåŒºé—´çš„èµ·å§‹åœ°å€ã€‚ // ä¸»è¦ä½œç”¨ï¼šç”¨äºdefer()å‡½æ•°æ‰§è¡Œæ—¶åˆ¤æ–­recover()å‡½æ•°æ‰€åœ¨èŒƒå›´æ˜¯å¦èƒ½ç”Ÿæ•ˆã€‚ argp unsafe.Pointer // pointer to arguments of deferred call run during panic; cannot move - known to liblink // åˆ™æ˜¯panicå‡½æ•°è‡ªå·±çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯ã€panic(v any)ã€‘è¿™é‡Œçš„ç©ºæ¥å£ã€vã€‘çš„å‚æ•°ã€‚ // ä¸»è¦ä½œç”¨ï¼šç»“æŸæ—¶ç”¨äºæ‰“å°é”™è¯¯ä¿¡æ¯ã€‚ arg any // argument to panic // é€šè¿‡linké“¾æ¥åˆ°å‰ä¸€ä¸ªæ³¨å†Œçš„panicå½¢æˆé“¾è¡¨ï¼Œ // è§£é‡Šï¼šæ–°å¢çš„panicæ€»æ˜¯ä»å·¦è¾¹æ’å…¥ link *_panic // link to earlier panic\tg._painc // pc æ¥è‡ª defer.pc æ‹·è´çš„å€¼ // ä¸»è¦ä½œç”¨ï¼šç”¨äºå½“å‰panicè¢«æ¢å¤æ—¶è¦æ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€åŠIPå¯„å­˜å™¨çš„å€¼ pc uintptr // where to return to in runtime if this panic is bypassed\t// sp æ¥è‡ª defer.sp æ‹·è´çš„å€¼ // ä¸»è¦ä½œç”¨ï¼šç”¨äºå½“å‰panicè¢«æ¢å¤æ—¶è¦æ¢å¤çš„æ ˆé¡¶SPå¯„å­˜å™¨çš„å€¼ sp unsafe.Pointer // where to return to in runtime if this panic is bypassed // è¡¨ç¤ºå½“å‰panicå·²ç»è¢«æŸä¸ªdeferå‡½æ•°é€šè¿‡recoveræ¢å¤ã€‚ã€å·²æ¢å¤ã€‘ // è§£é‡Šï¼šè¯¥å€¼åœ¨recover()å‡½æ•°ä¸­è¢«æ ‡è®° recovered bool // whether this panic is over // è¡¨ç¤ºå‘ç”Ÿäº†åµŒå¥—çš„panicï¼Œæ—§çš„panicè¢«æ–°çš„panicæµç¨‹æ ‡è®°ä¸ºabortedã€‚ã€å·²ä¸­æ­¢ã€‘ // è§£é‡Šï¼šå°±æ˜¯å‘ç”Ÿäº†åµŒå¥—panicäº†ã€‚ aborted bool // the panic was aborted // æ˜¯å¦æ‰§è¡Œruntime.Goexit()å‡½æ•°ï¼Œruntime.Goexit()å‡½æ•°æ˜¯ // goroutineæ‰§è¡Œå®Œåè·³è½¬åˆ°çš„æ¸…ç†é¦–å°¾å·¥ä½œçš„å‡½æ•° // goexitå­—æ®µåœ¨ï¼Œruntime.Goexit()å‡½æ•°ä¸­è¢«æ ‡è®°ä¸ºtrueã€‚ goexit bool } panic 1 2 3 4 5 6 7 8 9 10 11 // The panic built-in function stops normal execution of the current // goroutine. When a function F calls panic, normal execution of F stops // immediately. Any functions whose execution was deferred by F are run in // the usual way, and then F returns to its caller. To the caller G, the // invocation of F then behaves like a call to panic, terminating G's // execution and running any deferred functions. This continues until all // functions in the executing goroutine have stopped, in reverse order. At // that point, the program is terminated with a non-zero exit code. This // termination sequence is called panicking and can be controlled by the // built-in function recover. func panic(v any) gopanic() gopanic() ä¹Ÿå°±æ˜¯ panic() å‘ç”Ÿæ—¶è°ƒç”¨çš„å‡½æ•°ã€‚ gopanic() å‡½æ•°ä¸­å…³é”®çš„ open coded defer éƒ¨åˆ†ï¼š åœ¨ for å¾ªç¯å¼€å§‹ä¹‹å‰ï¼Œå…ˆé€šè¿‡ addOneOpenDeferFrame() å‡½æ•°å°†æœ€è¿‘çš„ä¸€ä¸ª open coded defer æ ˆå¸§æ·»åŠ åˆ° _defer é“¾è¡¨ä¸­ã€‚ åœ¨è°ƒç”¨ defer å‡½æ•°çš„æ—¶å€™ï¼Œå¦‚æœ openDefer ä¸º true ï¼Œåˆ™ä½¿ç”¨ runOpenDeferFrame() å‡½æ•°æ¥æ‰§è¡Œï¼Œé€šè¿‡è¿”å›å€¼æ¥åˆ¤æ–­ç›®æ ‡æ ˆå¸§ä¸Šçš„ open coded defer å·²ç»å®Œå…¨æ‰§è¡Œï¼Œå¹¶ä¸”æ²¡æœ‰ recoverï¼Œå°±å†æ¬¡è°ƒç”¨ addOneOpenDeferFrame() å‡½æ•°æŠŠä¸‹ä¸€ä¸ª open coded defer æ ˆå¸§æ·»åŠ åˆ° _defer é“¾è¡¨ã€‚ æ ¹æ® runOpenDeferFrame() å‡½æ•°çš„è¿”å›å€¼æ¥åˆ¤æ–­ï¼Œåªæœ‰å®Œå…¨æ‰§è¡Œçš„èŠ‚ç‚¹æ‰èƒ½ä» _defer é“¾è¡¨ä¸­ç§»é™¤ã€‚äº‹å®ä¸Šåªæœ‰ openDefer èŠ‚ç‚¹æ‰æœ‰å¯èƒ½å‡ºç°ä¸å®Œå…¨æ‰§è¡Œçš„æƒ…å†µï¼Œå› ä¸ºä¸€ä¸ªæ ˆå¸§ä¸Šå¯èƒ½æœ‰å¤šä¸ª open coded defer å‡½æ•°ï¼Œå‡å¦‚å…¶ä¸­æŸä¸€ä¸ªå‡½æ•°è°ƒç”¨äº† recover() å‡½æ•°ï¼Œåç»­çš„å°±ä¸ä¼šå†è¢«è°ƒç”¨äº†ï¼Œæ‰€ä»¥è¯¥èŠ‚ç‚¹ä¸èƒ½ä» _defer é“¾è¡¨ä¸­ç§»é™¤ï¼Œrecover ä¹‹åçš„é€»è¾‘è´Ÿè´£è°ƒç”¨è¿™äº›å‰©ä½™çš„ open coded deferã€‚ æ£€æŸ¥åˆ°å½“å‰ panic çš„ recover ä¸º true åï¼Œéœ€è¦æŠŠ _defer é“¾è¡¨ä¸­å°šæœªå¼€å§‹æ‰§è¡Œçš„ openDefer èŠ‚ç‚¹ç§»é™¤ï¼Œå› ä¸º recover ä¹‹åè¿™äº› open coded defer ä¼šè¢«æ­£å¸¸è°ƒç”¨ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 // The implementation of the predeclared function panic. func gopanic(e any) { // è·å–å½“å‰æ­£åœ¨è¿è¡Œçš„goroutine gp := getg() // è°ƒç”¨gopanic()åº”è¯¥æ˜¯åœ¨ç”¨æˆ·æ ˆä¸Šå‘ç”Ÿçš„ if gp.m.curg != gp { print(\"panic: \") printany(e) print(\"\\n\") // panic åœ¨ç³»ç»Ÿæ ˆä¸Š throw(\"panic on system stack\") } // ç”³è¯·å†…å­˜æœŸé—´ä¸å…è®¸panic if gp.m.mallocing != 0 { print(\"panic: \") printany(e) print(\"\\n\") // malloc æœŸé—´ panic // malloc æ˜¯åœ¨ç”³è¯·å†…å­˜æœŸé—´ throw(\"panic during malloc\") } // æŠ¢å æœŸé—´ä¸å…è®¸panic if gp.m.preemptoff != \"\" { print(\"panic: \") printany(e) print(\"\\n\") print(\"preempt off reason: \") print(gp.m.preemptoff) print(\"\\n\") throw(\"panic during preemptoff\") } // MæŒæœ‰é”æœŸé—´ä¸å…è®¸panic if gp.m.locks != 0 { print(\"panic: \") printany(e) print(\"\\n\") throw(\"panic holding locks\") } // 1) åˆ›å»ºä¸€ä¸ª_panicç»“æ„å¹¶åˆå§‹åŒ– // å¯ä»¥çœ‹å‡ºpanicå’Œdeferç»“æ„éƒ½æ˜¯ç”¨çš„ç”¨æˆ·å†…å­˜ç©ºé—´ // åˆå§‹åŒ–ä¸€ä¸ªpanicç»“æ„ä½“ï¼Œåœ¨æ ˆä¸Šåˆ†é… var p _panic\tp.arg = e // ä¿å­˜panicçš„å‚æ•°ï¼Œè¯¥å‚æ•°æ˜¯panic(v any) // _panicé€šè¿‡linké“¾æ¥å…¶ä»–panic // è®°å½•goroutineä¸Šçš„æœ€åä¸€ä¸ªpanicï¼Œä¹Ÿå°±æ˜¯å½¢æˆä¸€ä¸ªpanicçš„é“¾è¡¨ p.link = gp._panic\t// g._panic ä¿å­˜çš„æ˜¯æœ€æ–°çš„panic // ç‰¹æ„ä½¿ç”¨noescapeå‡½æ•°æ¥é¿å…pé€ƒé€¸ï¼Œåº”ä¸ºpanicæœ¬èº«å°±æ˜¯ä¸æ ˆçš„çŠ¶æ€å¼ºç›¸å…³çš„ // å½“å‰panicè¿½åŠ åˆ°goroutineçš„panicé“¾è¡¨ä¸Šï¼Œè®°å½•æœ€æ–°çš„ä¸€ä¸ªpanic gp._panic = (*_panic)(noescape(unsafe.Pointer(\u0026p)))\t// ä½¿ç”¨åŸå­é”æ ‡è®°panicæ­£åœ¨å‘ç”Ÿï¼Œç”¨äºruntime.main()å‡½æ•°ç­‰å¾… // å½“runtime.main()å³å°†è¦ç»“æŸæ—¶ï¼Œéœ€è¦å¾ªç¯ç­‰å¾…panicå®Œæˆã€‚ // å…·ä½“ä»£ç å‚çœ‹ runtime.main() å‡½æ•°ã€‚ atomic.Xadd(\u0026runningPanicDefers, 1) // 2) open code defers å½¢å¼æ‰«ææ ˆï¼Œæ”¶é›†ä¿¡æ¯,å·²å¤‡åé¢å¾ªç¯gp.defer // By calculating getcallerpc/getcallersp here, we avoid scanning the // gopanic frame (stack scanning is slow...) // // é€šè¿‡è¿™é‡Œè®¡ç®—getcallerpc/getcallerspï¼Œæˆ‘ä»¬é¿å…æ‰«ægopanicå¸§ï¼ˆå †æ ˆæ‰«æå¾ˆæ…¢......ï¼‰ // å°†æœ€è¿‘çš„ä¸€ä¸ªopen coded deferæ ˆå¸§æ·»åŠ åˆ°_deferé“¾è¡¨ä¸­ï¼Œå¯èƒ½æ˜¯ä¸€ç»„deferå‡½æ•°ç»„æˆçš„ä¸€ä¸ª_deferç»“æ„ã€‚ addOneOpenDeferFrame(gp, getcallerpc(), unsafe.Pointer(getcallersp())) // åœ¨è¿™ä¸ªå¾ªç¯ä¸­é€ä¸ªè°ƒç”¨é“¾è¡¨ä¸­çš„deferå‡½æ•°ï¼Œå¹¶æ£€æµ‹recoverçš„çŠ¶æ€ã€‚ // å¦‚æœæ‰€æœ‰çš„deferå‡½æ•°éƒ½æ‰§è¡Œå®Œåè¿˜æ˜¯æ²¡æœ‰recoverï¼Œåˆ™å¾ªç¯å°±ä¼šç»“æŸï¼Œ // æœ€åçš„fatalpanic()å‡½æ•°å°±ä¼šç»“æŸå½“å‰è¿›ç¨‹ã€‚ for { // å–æœ€æ–°çš„ä¸€ä¸ªdefer // è¿™é‡Œå¯ä»¥çœ‹çœ‹å‡ºå–å‡ºçš„deferä¸ä¸€å®šæ˜¯å½“å‰å‘ç”Ÿpanicæ³¨å†Œçš„deferå¯èƒ½æ˜¯ä¸Šæ¸¸è°ƒç”¨å‡½æ•°æ³¨å†Œçš„ d := gp._defer if d == nil { // deferå·²ç»è¿è¡Œå®Œäº†ï¼Œç»“æŸå¾ªç¯ break } // If defer was started by earlier panic or Goexit (and, since we're back here, that triggered a new panic), // take defer off list. An earlier panic will not continue running, but we will make sure below that an // earlier Goexit does continue running. // // d.startedä¸ºçœŸï¼Œè¡¨æ˜å½“å‰æ˜¯ä¸€ä¸ªåµŒå¥—çš„panicï¼Œ // ä¹Ÿå°±æ˜¯åœ¨åŸæœ‰panicæˆ–Goexit()å‡½æ•°æ‰§è¡Œdeferå‡½æ•°çš„æ—¶å€™åˆè§¦å‘äº†panic // å› ä¸ºè§¦å‘panicçš„deferå‡½æ•°è¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼Œæ‰€ä»¥è¿˜æ²¡æœ‰ä»é“¾è¡¨ä¸­ç§»é™¤ã€‚ // è¿™é‡Œä¼šæŠŠdç›¸å…³çš„æ—§çš„_panicè®¾ç½®ä¸ºabortedï¼Œç„¶åæŠŠdä»é“¾è¡¨ä¸­ç§»é™¤ï¼Œå¹¶é€šè¿‡freedefer()å‡½æ•°é‡Šæ”¾deferã€‚ if d.started { // é¦–æ¬¡è§¦å‘panicè¿™é‡Œä¸º falseï¼Œå¤šæ¬¡è§¦å‘è¿™é‡Œä¸º true // d._panicè®°å½•çš„æ˜¯å‰ä¸€ä¸ªpanicï¼Œ // åœ¨æ‰§è¡Œd.fn()å‡½æ•°çš„æ—¶å€™åˆå‘ç”Ÿäº†panicçš„æƒ…å†µã€‚ if d._panic != nil { // æŠŠå‰ä¸€ä¸ªpanicæ ‡è®°ä¸ºå·²ç»ˆæ­¢çŠ¶æ€ d._panic.aborted = true // å·²ç»ˆæ­¢ } d._panic = nil // ä¸æ˜¯open deferså½¢å¼æ—¶ï¼Œåˆ™ç›´æ¥å›æ”¶å½“å‰deferç»“æ„ä½“å³å¯ï¼Œ // å› ä¸ºå½“å‰gopanic()æ­£æ˜¯å½“å‰deferå‡½æ•°ä¸­è§¦å‘ï¼Œå› æ­¤ç›´æ¥ç»“æŸæœ¬æ¬¡å¾ªç¯å³å¯ã€‚ if !d.openDefer {\t// For open-coded defers, we need to process the // defer again, in case there are any other defers // to call in the frame (not including the defer // call that caused the panic). // // å½“å‰deferå·²æ‰§è¡Œå®Œï¼Œå³å°†è¢«å›æ”¶ã€‚ d.fn = nil gp._defer = d.link // å› ä¸ºå½“å‰deferä¸­å‘ç”Ÿäº†panicï¼Œåç»­ä»£ç ä¸ä¼šè¢«æ‰§è¡Œï¼Œç›´æ¥å›æ”¶deferå³å¯ freedefer(d)\tcontinue } // å¦åˆ™åº”è¯¥å»runOpenDeferFrameå›æ”¶ } // åç»­çš„3å¤§å—é€»è¾‘å°±æ˜¯ï¼šè°ƒç”¨deferå‡½æ•°ã€é‡Šæ”¾_deferç»“æ„å’Œæ£€æµ‹recoverã€‚ // 2.1) è°ƒç”¨deferå‡½æ•° // Mark defer as started, but keep on list, so that traceback // can find and update the defer's argument frame if stack growth // or a garbage collection happens before executing d.fn. // // å¦‚æœdeferå‡½æ•°åˆè§¦å‘äº†panicï¼Œæ–°çš„panicéå†deferé“¾è¡¨æ—¶ï¼Œå°±èƒ½å¤Ÿé€šè¿‡started // çš„å€¼ç¡®å®šç¡®å®šè¯¥deferå‡½æ•°å·²ç»è¢«è°ƒç”¨è¿‡äº†ï¼Œé¿å…é‡å¤è°ƒç”¨ã€‚ d.started = true // æ ‡è®°å½“å‰deferè¢«panicè§¦å‘ // Record the panic that is running the defer. // If there is a new panic during the deferred call, that panic // will find d in the list and will mark d._panic (this panic) aborted. // // ä¸ºd._panicèµ‹å€¼ï¼Œå°†då…³è”åˆ°å½“å‰panicå¯¹è±¡pï¼Œ // ä½¿ç”¨noescapeå‡½æ•°é¿å…pé€ƒé€¸ï¼Œè¿™ä¸€æ­¥æ˜¯ä¸ºäº†åç»­åµŒå¥—çš„panicèƒ½å¤Ÿé€šè¿‡d._panicæ‰¾åˆ°ä¸Šä¸€ä¸ªpanic d._panic = (*_panic)(noescape(unsafe.Pointer(\u0026p))) // å½“å‰deferçš„_panicè®°å½•è§¦å‘çš„panicæ˜¯é‚£ä¸ª done := true if d.openDefer { // å½“å‰æ˜¯open code defersæ¨¡å¼æ—¶ // è¿è¡Œå½“å‰deferçš„fnå‡½æ•°ï¼Œdone=trueè¡¨ç¤ºæ‰€æœ‰çš„deferå·²ç»è¿è¡Œå®Œ // é€šè¿‡è¿”å›å€¼æ¥åˆ¤æ–­ç›®æ ‡æ ˆå¸§ä¸Šçš„open coded deferå·²ç»å®Œå…¨æ‰§è¡Œï¼Œå¹¶ä¸”æ²¡æœ‰recoverï¼Œ // å°±å†æ¬¡è°ƒç”¨addOneOpenDeferFrame()å‡½æ•°æŠŠä¸‹ä¸€ä¸ªopen coded deferæ ˆå¸§æ·»åŠ åˆ°_deferé“¾è¡¨ done = runOpenDeferFrame(gp, d) // è¿™é‡Œè¿è¡Œçš„æ˜¯ä¸€ç»„defer // å› ä¸ºä¸Šé¢è¿è¡Œçš„d.fn()å‡½æ•°ï¼Œå¯èƒ½å…¶ä¸­å­˜åœ¨recover()å‡½æ•°ï¼Œæ‰€ä»¥è¦åˆ¤æ–­recoveredå­—æ®µ if done \u0026\u0026 !d._panic.recovered {\t// done=trueï¼Œå¹¶ä¸”å½“å‰è¿™ä¸ªpanicå¹¶æ²¡æœ‰è¢«æ¢å¤æ—¶ // å†å»å¯»æ‰¾åé¢å‡½æ•°çš„defer // ä»è°ƒç”¨æ ˆçš„æ ˆé¡¶å¼€å§‹å›æº¯æ‰«æï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªå¸¦æœ‰open coded deferçš„æ ˆå¸§ï¼Œ // ä¸ºè¯¥æ ˆå¸§åˆ†é…ä¸€ä¸ª_deferç»“æ„ï¼Œä¸ºå„ä¸ªå­—æ®µèµ‹å€¼åæ·»åŠ åˆ°deferé“¾è¡¨ä¸­åˆé€‚çš„ä½ç½®ã€‚ // ä¸ç®¡ç›®æ ‡æ ˆå¸§ä¸Šæœ‰å‡ ä¸ªopen coded deferå‡½æ•°ï¼Œåªåˆ†é…ä¸€ä¸ª_deferç»“æ„ï¼Œ // å› ä¸ºåç»­é€šè¿‡runOpenDeferFrame()å‡½æ•°æ¥æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šä¸€å¹¶æ‰§è¡Œæ ˆå¸§ä¸Šçš„æ‰€æœ‰ // open coded deferå‡½æ•°ã€‚æ·»åŠ åˆ°_deferé“¾è¡¨ä¸­çš„ä½ç½®æ˜¯æ ¹æ®ç›®æ ‡æ ˆå¸§åœ¨è°ƒç”¨æ ˆä¸­çš„ä½ç½® // è®¡ç®—çš„ï¼Œè€Œä¸æ˜¯æ·»åŠ åˆ°å¤´éƒ¨ã€‚ addOneOpenDeferFrame(gp, 0, nil)\t} } else {\t// deferæ˜¯å †æˆ–æ ˆåˆ†å¸ƒæ—¶ // getargp()ï¼šè®¾ç½®ä¸ºå½“å‰gopanic()å‡½æ•°æ ˆå¸§ä¸Šargs to calleeåŒºé—´çš„èµ·å§‹åœ°å€ï¼Œ // recover()å‡½æ•°é€šè¿‡è¿™ä¸ªå€¼æ¥åˆ¤æ–­è‡ªèº«æ˜¯å¦ç›´æ¥è¢«deferå‡½æ•°è°ƒç”¨ p.argp = unsafe.Pointer(getargp()) // è¯¥å€¼åœ¨fnæ‰§è¡Œå‡½æ•°ä¸­ç”¨äºrecoverå‡½æ•°æ¯”è¾ƒåˆ¤æ–­ // æ‰§è¡Œdeferæ³¨å†Œçš„å‡½æ•°ï¼Œå¦‚æœè¿™é‡Œåˆå‘ç”Ÿäº†panicæ—¶åˆ™å½“å‰deferå¹¶æœªè¢«æ¸…é™¤ï¼Œåˆä¼šä»æ–°gopanic d.fn()\t} // ä¸ºä»€ä¹ˆå‰é¢è®¾ç½®äº†argpå€¼è¿™é‡Œåˆè¦æ¸…é™¤æ‰ï¼Ÿ // å› æ­¤d.fn()æ‰§è¡Œçš„deferå‡½æ•°ä¸­å¯èƒ½ä¼šæœ‰recover()å‡½æ•°ï¼Œéœ€è¦åˆ¤æ–­argpçš„å€¼ p.argp = nil // æ¸…é™¤ // 2.2) é‡Šæ”¾_deferç»“æ„ // Deferred function did not panic. Remove d. // // è°ƒç”¨å®Œd.fn()å‡½æ•°åï¼Œä¸åº”è¯¥ä¼šå‡ºç°gp._deferä¸ç­‰äºdè¿™ç§æƒ…å†µã€‚ // å‡å¦‚åœ¨d.fn()å‡½æ•°æ‰§è¡Œçš„è¿‡ç¨‹ä¸­æ²¡æœ‰é€ æˆæ–°çš„panicï¼Œé‚£ä¹ˆæ‰€æœ‰æ–°æ³¨å†Œçš„deferéƒ½åº”è¯¥åœ¨ // d.fn()å‡½æ•°è¿”å›çš„æ—¶å€™è¢«deferreturn()å‡½æ•°ç§»å‡ºé“¾è¡¨ã€‚ // å‡å¦‚d.fn()å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­é€ æˆäº†æ–°çš„panicï¼Œè‹¥æ²¡æœ‰recoverï¼Œåˆ™ä¸ä¼šå†å›åˆ°è¿™é‡Œï¼Œ // è‹¥ç»recoverä¹‹åå†å›åˆ°è¿™é‡Œï¼Œåˆ™æ‰€æœ‰åœ¨d.fn()å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­æ³¨å†Œçš„deferä¹Ÿ // éƒ½åº”è¯¥åœ¨d.fn()å‡½æ•°è¿”å›ä¹‹å‰è¢«ç§»é™¤é“¾è¡¨ã€‚ if gp._defer != d {\tthrow(\"bad defer entry in panic\") } // å½“å‰deferæ‰§è¡Œå®Œéœ€è¦æŠŠ_panicæ ‡è®°ä¸ºnilï¼Œåé¢ä¼šåˆ é™¤è¿™ä¸ªdefer d._panic = nil\t// trigger shrinkage to test stack copy. See stack_test.go:TestStackPanic //GC() // æŠŠpcå’Œspå­—æ®µä¿å­˜åœ¨å±€éƒ¨å˜é‡ä¸­ï¼Œä¾›æ¥ä¸‹æ¥æ£€æµ‹æ‰§è¡Œrecoveræ—¶ä½¿ç”¨ // æ­¤å¤„é¢spç±»å‹å¿…é¡»æ—¶æŒ‡é’ˆï¼Œå› ä¸ºåç»­å¦‚æœæ ˆè¢«ç§»åŠ¨ï¼Œåªæœ‰æŒ‡é’ˆç±»å‹ä¼šå¾—åˆ°æ›´æ–° pc := d.pc // è¦æ¢å¤çš„PCå’ŒSPçš„å€¼ sp := unsafe.Pointer(d.sp) // must be pointer so it gets adjusted during stack copy if done { // done=trueï¼Œè¿™ä¸€ç»„deferå‡½æ•°å·²æ‰§è¡Œå®Œ // å› æ­¤deferå‡½æ•°å¯ä»¥è¢«é‡Šæ”¾æ‰ d.fn = nil\tgp._defer = d.link // ä»goroutine._deferä¸Šç§»é™¤è‡ªå·± freedefer(d) // å›æ”¶defer } // 2.3)æ£€æµ‹ recover() æ˜¯å¦æ ‡è®°äº†panic // å¦‚æœ d.fn() å‡½æ•°æˆåŠŸåœ°æ‰§è¡Œäº†recover()ï¼Œåˆ™å½“å‰_panicå¯¹è±¡çš„pçš„recoveredå­—æ®µå°±ä¼šè¢«è®¾ç½®ä¸ºtrue // æ­¤å¤„é€šè¿‡æ£€æµ‹åå°±ä¼šæ‰§è¡Œrecoveré€»è¾‘ã€‚è¿™é‡Œæ‰æ˜¯recover()å‡½æ•°çš„å…·ä½“å®ç°åŠŸèƒ½ï¼Œè·³è½¬åˆ°æŒ‡å®šä»£ç å¤„ã€‚ if p.recovered { // 2.3.1) recover()ç”Ÿæ•ˆ // 1. ç§»é™¤å½“å‰_panicï¼Œå› ä¸ºå½“å‰_panicå·²è¢«æ¢å¤ // 2. å‘å‰å¯»æ‰¾ç§»é™¤è¢«æ ‡è®°ä¸ºabortedä¸ºçœŸçš„_panic gp._panic = p.link\t// æŠŠå½“å‰panicä»goroutine._panicä¸Šç§»é™¤æ‰è‡ªå·± // gp._panic != nilï¼šåé¢è¿˜æœ‰ panic // gp._panic.goexitï¼šç”±runtime.Goexit()å‡½æ•°è§¦å‘ // gp._panic.abortedï¼šå½“å‰panicå·²è¢«ç»ˆæ­¢ if gp._panic != nil \u0026\u0026 gp._panic.goexit \u0026\u0026 gp._panic.aborted {\t// A normal recover would bypass/abort the Goexit. Instead, // we return to the processing loop of the Goexit. // // æ­£å¸¸æ¢å¤å°† bypass/abortåˆ° Goexitã€‚ ç›¸åï¼Œæˆ‘ä»¬è¿”å›åˆ° Goexit çš„å¤„ç†å¾ªç¯ã€‚ gp.sigcode0 = uintptr(gp._panic.sp) // å¹¶æ²¡æœ‰å€¼ gp.sigcode1 = uintptr(gp._panic.pc) // mcallå‡½æ•°ä»å½“å‰gæ ˆåˆ‡æ¢åˆ°g0æ ˆï¼Œåœ¨æ‰§è¡Œrecoveryå‡½æ•°ï¼Œæ¢å¤åæ˜¯æ¥åˆ°ä»å½“å‰æœ€æ–°panicçš„å¤„å¾€ä¸‹æ‰§è¡Œ // recoveryå‡½æ•°åˆ¤æ–­æ ˆæº¢å‡ºåï¼Œç›´æ¥æŠŠspå’Œpcå€¼èµ‹å€¼ç»™å½“å‰goroutineçš„schedç„¶åä½¿ç”¨gogoå‡½æ•°å†æ¬¡è¢«è°ƒåº¦èµ·æ¥æ¥åˆ°æ‰§è¡Œ mcall(recovery)\t// è¿™ç§æƒ…å†µåº”è¯¥æŠ¥é”™ // ä»è¿™é‡Œè·³è½¬åˆ°deferreturnå‡½æ•° throw(\"bypassed recovery failed\") // mcall should not return åº”è¯¥æ°¸è¿œä¸ä¼šè¿”å›åˆ°è¿™é‡Œ } // è§£é”panicæ ‡å¿—ï¼Œruntime.main()å¯ä»¥ç»§ç»­æ‰§è¡Œ atomic.Xadd(\u0026runningPanicDefers, -1)\t// After a recover, remove any remaining non-started, // open-coded defer entries, since the corresponding defers // will be executed normally (inline). Any such entry will // become stale once we run the corresponding defers inline // and exit the associated stack frame. We only remove up to // the first started (in-progress) open defer entry, not // including the current frame, since any higher entries will // be from a higher panic in progress, and will still be // needed. d := gp._defer var prev *_defer if !done { // Skip our current frame, if not done. It is // needed to complete any remaining defers in // deferreturn() // // è·³è¿‡å½“å‰å¸§ï¼Œå¦‚æœè¿˜æ²¡æœ‰å®Œæˆã€‚éœ€è¦åœ¨deferreturn()ä¸­å®Œæˆæ‰€æœ‰å‰©ä½™çš„å»¶è¿Ÿ // open coded deferæ—¶å‘ç”Ÿäº†recoveræ—¶ã€‚ prev = d d = d.link } for d != nil { if d.started { // This defer is started but we // are in the middle of a // defer-panic-recover inside of // it, so don't remove it or any // further defer entries // // è¿™ä¸ªdeferå·²ç»å¯åŠ¨ï¼Œä½†æ˜¯æˆ‘ä»¬æ­£åœ¨å®ƒå†…éƒ¨è¿›è¡Œä¸€ä¸ª defer-panic-recovery // æ‰€ä»¥ä¸è¦åˆ é™¤å®ƒæˆ–ä»»ä½•è¿›ä¸€æ­¥çš„deferæ¡ç›® break } if d.openDefer { if prev == nil { gp._defer = d.link } else { prev.link = d.link } newd := d.link freedefer(d) d = newd } else { prev = d d = d.link } } gp._panic = p.link // Aborted panics are marked but remain on the g.panic list. // Remove them from the list. // // å¾ªç¯ç§»é™¤é“¾è¡¨å¤´éƒ¨æ‰€æœ‰å·²ç»æ ‡è®°ä¸ºabortedçš„_panic // è¿™é‡Œå¯ä»¥çœ‹å‡ºå½“æœ€åä¸€ä¸ªpanicè¢«æ¢å¤å‰é¢çš„æ‰€æœ‰å·²æ ‡è®°abortedä¸­æ­¢çš„panicä¼šè¢«ç§»é™¤ã€‚ for gp._panic != nil \u0026\u0026 gp._panic.aborted { gp._panic = gp._panic.link } // å¦‚æœæ²¡æœ‰å‘ç”Ÿpanicï¼Œåˆ™æ­¤æ—¶gp._panicåº”è¯¥ä¸ºnilï¼Œä¸ä¸ºnilå°±è¡¨æ˜å‘ç”Ÿäº†åµŒå¥—çš„panic // è€Œä¸”åªæ˜¯å†…å±‚çš„panicè¢«recover if gp._panic == nil { // must be done with signal gp.sig = 0 } // Pass information about recovering frame to recovery. // è¦æ¢å¤çš„PCå’ŒSPçš„å€¼ï¼Œä¹Ÿå°±æ˜¯å½“å‰deferæ³¨å†Œçš„åä¸€æ¡æŒ‡ä»¤å¤„ï¼Œæ˜¯ä¸€æ¡JMPæŒ‡ä»¤ // è·³è½¬å»æ‰§è¡Œdeferreturn()å‡½æ•°ã€‚ gp.sigcode0 = uintptr(sp) // éœ€è¦æ¢å¤åˆ°çš„SPåœ°å€ï¼Œä¹Ÿå°±æ˜¯æ³¨å†Œdeferå‡½æ•°çš„æ ˆé¡¶å¯„å­˜å™¨ gp.sigcode1 = pc // éœ€è¦æ¢å¤åˆ°IPåœ°å€ï¼Œä¹Ÿå°±æ˜¯æ³¨å†Œdeferå‡½æ•°çš„ä¸‹ä¸€æ¡æŒ‡ä»¤å¤„ // recoveryå‡½æ•°è´Ÿè´£ç”¨å­˜å‚¨åœ¨sigcode0å’Œsigcode1ä¸­çš„spå’Œpcæ¢å¤gpçš„æ‰§è¡ŒçŠ¶æ€ mcall(recovery) // mcallå‡½æ•°åˆ‡æ¢åˆ°ç³»ç»Ÿg0æ ˆå»è°ƒç”¨gogoå‡½æ•°æ‰§è¡Œè·³è½¬ throw(\"recovery failed\") // mcall should not return } } // æ‰€æœ‰çš„deferæ³¨å†Œå‡½æ•°éƒ½æ²¡æœ‰recoverï¼Œæœ€åä¼šåˆ°è¿™é‡Œå»æ‰“å°é”™è¯¯ä¿¡æ¯ // ran out of deferred calls - old-school panic now // Because it is unsafe to call arbitrary user code after freezing // the world, we call preprintpanics to invoke all necessary Error // and String methods to prepare the panic strings before startpanic. // // gp._panicï¼šä¿å­˜çš„æœ€æ–°çš„panic preprintpanics(gp._panic)\t// æŠŠpanicçš„å‚æ•°è§£ææ”¾å…¥arg // æ‰“å°panicä¿¡æ¯ï¼Œå¹¶ç»“æŸå½“å‰è¿›ç¨‹ fatalpanic(gp._panic) // should not return // å‘ä¸€ä¸ªnilçš„åœ°å€å†™å…¥å€¼ï¼Œä¼šæŠ¥é”™ï¼Œä¸‹é¢è¿™è¡Œä»£ç æ˜¯é˜²æ­¢ä¸‡ä¸€ï¼Œä¸åº”è¯¥æ‰§è¡Œåˆ°è¿™é‡Œåœ¨å‰ä¸€ä¸ªå‡½æ•°ä¸­ä¼šç»“æŸè°ƒè¿›ç¨‹ *(*int)(nil) = 0 // not reached } runOpenDeferFrame() å¾ªç¯æ‰§è¡ŒæŒ‡å®šæ ˆå¸§ä¸Šæ‰€æœ‰çš„open coded deferå‡½æ•°ã€‚ è¿”å›å€¼è¡¨ç¤ºæ ˆå¸§ä¸Šæ‰€æœ‰çš„open coded deferå‡½æ•°æ˜¯å¦éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œå¦‚æœå› ä¸ºæŸä¸ªdeferå‡½æ•°æ‰§è¡Œäº†recover è€Œé€ æˆå¾ªç¯ä¸­æ­¢ï¼Œåˆ™è¿”å›å€¼ä¸ºfalseã€‚ addOneOpenDeferFrame()å’ŒrunOpenDeferFrame()å‡½æ•°éƒ½ä¾èµ–ç¬¦å·è¡¨ä¸­ç›®æ ‡æ ˆå¸§çš„OpenCodedDerferInfoã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 // runOpenDeferFrame runs the active open-coded defers in the frame specified by // d. It normally processes all active defers in the frame, but stops immediately // if a defer does a successful recover. It returns true if there are no // remaining defers to run in the frame. func runOpenDeferFrame(gp *g, d *_defer) bool { done := true fd := d.fd deferBitsOffset, fd := readvarintUnsafe(fd) nDefers, fd := readvarintUnsafe(fd) // å½“å‰çš„dfä½ï¼Œè®°å½•ç€deferæ‰§è¡Œä¸å¦çš„ç›¸å…³ä¿¡æ¯ deferBits := *(*uint8)(unsafe.Pointer(d.varp - uintptr(deferBitsOffset))) // éå†å½“å‰å‡½æ•°æ³¨å†Œçš„deferåˆ—è¡¨ for i := int(nDefers) - 1; i \u003e= 0; i-- { // read the funcdata info for this defer var closureOffset uint32 closureOffset, fd = readvarintUnsafe(fd) if deferBits\u0026(1\u003c\u003ci) == 0 { // å½“å‰ä½æ²¡æœ‰æ³¨å†Œdeferç›´æ¥è·³è¿‡ continue } closure := *(*func())(unsafe.Pointer(d.varp - uintptr(closureOffset))) d.fn = closure // deferæ³¨å†Œçš„å‡½æ•° deferBits = deferBits \u0026^ (1 \u003c\u003c i) // æ¸…é™¤å½“å‰æ ‡è®°ä½ *(*uint8)(unsafe.Pointer(d.varp - uintptr(deferBitsOffset))) = deferBits // å›å†™ç»™å†…å­˜ p := d._panic // Call the defer. Note that this can change d.varp if // the stack moves. // å†æ¬¡panicæ—¶ï¼Œç›´æ¥è·³è½¬ï¼Œå…¶ä»–æƒ…å†µç»§ç»­èµ°ä¸‹é¢æµç¨‹ deferCallSave(p, d.fn) // è°ƒç”¨fnå‡½æ•°ï¼Œå¯èƒ½recoverä¹Ÿå¯èƒ½panic // è¿™ç§æƒ…å†µæ˜¯åˆpanic if p != nil \u0026\u0026 p.aborted { break } d.fn = nil // å¸®åŠ©GC // è¯¥panicæ˜¯å¦è¢«æ¢å¤ if d._panic != nil \u0026\u0026 d._panic.recovered { done = deferBits == 0 // deferBits == 0 è¡¨ç¤ºopen code defersçš„deferä»¥è¿è¡Œå®Œ break } } return done } recovery() è¯¥å‡½æ•°è´Ÿè´£ç”¨äºå­˜å‚¨åœ¨sigcode0å’Œsigcode1ä¸­çš„spå’Œpcæ¢å¤gpçš„æ‰§è¡ŒçŠ¶æ€ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 // Unwind the stack after a deferred function calls recover // after a panic. Then arrange to continue running as though // the caller of the deferred function returned normally. func recovery(gp *g) { // Info about defer passed in G struct. sp := gp.sigcode0 pc := gp.sigcode1 // d's arguments need to be in the stack. // // ç¡®ä¿spä¸ä¸º0ï¼Œå¹¶åœ¨åœ¨gpçš„æ ˆä¸­ if sp != 0 \u0026\u0026 (sp \u003c gp.stack.lo || gp.stack.hi \u003c sp) { print(\"recover: \", hex(sp), \" not in [\", hex(gp.stack.lo), \", \", hex(gp.stack.hi), \"]\\n\") throw(\"bad recovery\") } // Make the deferproc for this d return again, // this time returning 1. The calling function will // jump to the standard return epilogue. // // æŠŠspå’Œpcèµ‹å€¼ç»™gp.schedä¸­å¯¹åº”çš„å­—æ®µï¼Œ // å¹¶æŠŠè¿”å›å€¼è®¾ç½®ä¸º1ã€‚ gp.sched.sp = sp // ä¸ºè·³è½¬å‡†å¤‡ SP gp.sched.pc = pc // ä¸ºè·³è½¬å‡†å¤‡ PC gp.sched.lr = 0 gp.sched.ret = 1 // è®¾ç½®è¿”å›å€¼ 1,è¿™é‡Œå°±æ˜¯AX=1çš„ç”±æ¥ // è°ƒç”¨gogo()å‡½æ•°ä¹‹åï¼Œgpçš„æ ˆæŒ‡é’ˆå’ŒæŒ‡ä»¤æŒ‡é’ˆæœºä¼šæ¢å¤åˆ°spå’Œpcçš„ä½ç½®ï¼Œ // è€Œè¿™ä¸ªä½ç½®æ˜¯deferproc()å‡½æ•°é€šè¿‡getcallersp()å‡½æ•°å’Œgetcallerpc()å‡½æ•°è·å¾—çš„ã€‚ gogo(\u0026gp.sched) // è°ƒç”¨gogoå‡½æ•°å»è·³è½¬ } preprintpanics() 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // Call all Error and String methods before freezing the world. // Used when crashing with panicking. func preprintpanics(p *_panic) { // é˜²æ­¢panic defer func() { if recover() != nil { throw(\"panic while printing panic value\") } }() for p != nil { // p.argæ˜¯anyç±»å‹ï¼Œæ¥è‡ªpanic(v any) switch v := p.arg.(type) { case error: // å®ç°äº†erroræ¥å£ p.arg = v.Error() // ä¿å­˜ä¿¡æ¯ string case stringer:\t// å®ç°äº†stringeræ¥å£ p.arg = v.String() // ä¿å­˜ä¿¡æ¯ string } p = p.link // æŒ‡å‘ä¸‹ä¸€ä¸ªpanic } } printpanics() 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // Print all currently active panics. Used when crashing. // Should only be called after preprintpanics. func printpanics(p *_panic) { if p.link != nil { // é€’å½’å›è°ƒä»æ³¨å†Œç¬¬ä¸€ä¸ªpanicå¼€å§‹ printpanics(p.link) // ä¸æ˜¯goexitï¼Œæ‰“å°ç¬¦å· if !p.link.goexit { print(\"\\t\") } } // æ˜¯goexitè§¦å‘ç›´æ¥è¿”å› if p.goexit { return } print(\"panic: \") // æ‰“å°é”™è¯¯ä¿¡æ¯ printany(p.arg) // å¦‚æœå·²ç»recoveredï¼Œåˆ™æ‰“å° [recovered] if p.recovered { print(\" [recovered]\") } print(\"\\n\") } recover() 1 2 3 4 5 6 7 8 9 10 // The recover built-in function allows a program to manage behavior of a // panicking goroutine. Executing a call to recover inside a deferred // function (but not any function called by it) stops the panicking sequence // by restoring normal execution and retrieves the error value passed to the // call of panic. If recover is called outside the deferred function it will // not stop a panicking sequence. In this case, or when the goroutine is not // panicking, or if the argument supplied to panic was nil, recover returns // nil. Thus the return value from recover reports whether the goroutine is // panicking. func recover() any gorecover() è¯¥å‡½æ•°å¿…é¡»åœ¨deferä¸­ä½œä¸ºä¸€éƒ¨åˆ†è¢«ä½¿ç”¨ã€‚ è¯¥å‡½æ•°ä¸»è¦ä½œç”¨æ˜¯è®¾ç½® painc çš„ recovered è¡¨ç¤ºå·²è¢«æ¢å¤ã€‚ è¢«æ¢å¤çš„panicä¼šè·³è½¬åˆ°æ¢å¤çš„deferæ³¨å†Œä¸‹ä¸€è¡ŒæŒ‡ä»¤å¤„é€šè¿‡ifæ¡ä»¶è·³è½¬åˆ°deferreturnå‡½æ•°å¤„å»æ‰§è¡Œå‰©ä½™çš„deferã€‚ gopanic()å‡½æ•°çš„ä¸»è¦é€»è¾‘ï¼Œå…¶ä¸­forå¾ªç¯æ¯è°ƒç”¨å®Œä¸€ä¸ªdeferå‡½æ•°éƒ½ä¼šæ£€æŸ¥p.recoveredå­—æ®µï¼Œå¦‚æœå€¼ä¸ºtrueå°±æ‰§è¡Œ recoveré€»è¾‘ã€‚ä¹Ÿå°±æ˜¯è¯´çœŸæ­£çš„recoveré€»è¾‘æ˜¯åœ¨gopanic()å‡½æ•°ä¸­å®ç°çš„ï¼Œdeferå‡½æ•°ä¸­è°ƒç”¨äº†å†…ç½®å‡½æ•°recover()ï¼Œ å®é™…ä¸Šåªä¼šè®¾ç½®_panicçš„ä¸€ç§çŠ¶æ€ã€‚å†…ç½®å‡½æ•°recover()å¯¹åº”runtimeä¸­gorecover()å‡½æ•°ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 // The implementation of the predeclared function recover. // Cannot split the stack because it needs to reliably // find the stack segment of its caller. // // TODO(rsc): Once we commit to CopyStackAlways, // this doesn't need to be nosplit. //go:nosplit func gorecover(argp uintptr) any { // argp å‚æ•°æ ¹æ®AXå¯„å­˜å™¨ä¼ é€’ // 1. è¯¥å‚æ•°æ˜¯æ¥è‡ªè°ƒç”¨å½“å‰deferå‡½æ•°çš„è°ƒç”¨è€…SPæ ˆ // 2. å› æ­¤é¡¶å±‚çš„deferèƒ½æ•è·ä¸‹å±‚çš„panic // Must be in a function running as part of a deferred call during the panic. // Must be called from the topmost function of the call // (the function used in the defer statement). // p.argp is the argument pointer of that topmost deferred function call. // Compare against argp reported by caller. // If they match, the caller is the one who can recover. // // å¿…é¡»åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°ä½œä¸º panic æœŸé—´ defer è°ƒç”¨çš„ä¸€éƒ¨åˆ†è¿è¡Œ // å¿…é¡»ä»è°ƒç”¨çš„æœ€é¡¶å±‚å‡½æ•°è°ƒç”¨ (åœ¨deferè¯­å¥ä¸­ä½¿ç”¨çš„å‡½æ•°) // p.argp æ˜¯æœ€ä¸Šé¢é‚£ä¸ª defer å‡½æ•°è°ƒç”¨çš„å®å‚æŒ‡é’ˆ // ä¸è°ƒç”¨è€…æŠ¥å‘Šçš„ argp è¿›è¡Œæ¯”è¾ƒ // å¦‚æœå®ƒä»¬åŒ¹é…ï¼Œè°ƒç”¨æ–¹å°±å¯ä»¥æ¢å¤ gp := getg() // è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„g p := gp._panic // æœ€æ–°æ³¨å†Œçš„panic // p != nilï¼šå­˜åœ¨æ³¨å†Œçš„panic // !p.goexitï¼šä¸æ˜¯goexitå‡½æ•°è§¦å‘çš„ // !p.recoveredï¼šè¯¥panicæ²¡æœ‰è¢«æ¢å¤ // argp == uintptr(p.argp)ï¼šå¿…é¡»åœ¨deferå‡½æ•°ä¸­ç›´æ¥è°ƒç”¨recoverå‡½æ•°æ‰æœ‰ç”¨ï¼Œä¸å¯åµŒå¥—åœ¨å…¶ä»–å‡½æ•°ä¸­ // 1. p.argpï¼šå­˜å‚¨çš„æ˜¯è°ƒç”¨panicçš„è°ƒç”¨è€…æ ˆSPä½ç½® if p != nil \u0026\u0026 !p.goexit \u0026\u0026 !p.recovered \u0026\u0026 argp == uintptr(p.argp) { p.recovered = true // æ ‡è¯†å½“å‰è¿™ä¸ªpanicä»å¼‚å¸¸æˆ–é”™è¯¯åœºæ™¯ä¸­æ¢å¤ return p.arg // è¯¥å‚æ•°æ˜¯panic(v any)ä¼ é€’çš„ç©ºæ¥å£å‚æ•°ï¼Œç›´æ¥è¿”å›ç»™recoverå‡½æ•°è°ƒç”¨è€…å³å¯ } return nil } å†…ç½®å‡½æ•°recover()æ˜¯æ²¡æœ‰å‚æ•°çš„ï¼Œä½†æ˜¯gorecover()å‡½æ•°å´æœ‰ä¸€ä¸ªå‚æ•°argpï¼Œè¿™ä¹Ÿæ˜¯ç¼–è¯‘å™¨åšçš„æ‰‹è„šã€‚ ç¼–è¯‘å™¨ä¼šæŠŠè°ƒç”¨è€…çš„args from calleråŒºé—´çš„èµ·å§‹åœ°å€ä½œä¸ºå‚æ•°ä¼ é€’ç»™gorecover()å‡½æ•°ã€‚ 1 2 3 4 5 6 func fn() { defer func(a int) { recover() println(a) }(0) } ç»ç¼–è¯‘è½¬æ¢åçš„ç­‰ä»·ä»£ç å¦‚ä¸‹ï¼š 1 2 3 4 5 6 func fn() { defer func(a int) { gorecover(uintptr(unsafe.Pointer(\u0026a))) println(\u0026a) }(0) } ä¸ºä»€ä¹ˆè¦ä¼ é€’è¿™ä¸ªargpå‚æ•°å‘¢ï¼Ÿ ä»ä»£ç é€»è¾‘æ¥çœ‹ï¼Œgorecover()å‡½æ•°ä¼šæŠŠå®ƒè·Ÿå½“å‰_panicå¯¹è±¡pçš„argpå­—æ®µæ¯”è¾ƒï¼Œåªæœ‰ç›¸ç­‰æ—¶æ‰ä¼šæŠŠp.recoveredè®¾ç½®ä¸ºtrueã€‚ ä»å‚æ•°é€»è¾‘ä¸Šçœ‹argp == uintptr(p.argp)æ˜¯ä¸ç›¸ç­‰çš„ï¼Œç¼–è¯‘å™¨ä¼šåœ¨è°ƒç”¨fn()å‡½æ•°ä¸­æ’å…¥ä»¥ä¸‹ä»£ç é€»è¾‘æ¥ä¿®æ­£argpçš„å€¼ã€‚ å¦‚æœgp._panicä¸ä¸ºnilä¸”gp._panic.argpçš„å€¼ç­‰äºå½“å‰å‡½æ•°æ ˆå¸§args from calleråŒºé—´çš„èµ·å§‹åœ°å€ï¼Œå°±æŠŠå®ƒçš„å€¼æ”¹æˆå½“å‰ å‡½æ•°æ ˆå¸§args to calleeåŒºé—´çš„èµ·å§‹åœ°å€ã€‚ä¸ç¼–è¯‘å™¨æ’å…¥çš„è¿™äº›æŒ‡ä»¤ç­‰ä»·çš„Goä»£ç å¦‚ä¸‹ï¼š 1 2 3 4 5 6 7 gp := getg() if gp._panic != nil { // è¿™ä¸€æ¡é™åˆ¶åªæ˜¯é™åˆ¶äº†recover()å¿…é¡»åœ¨deferå‡½æ•°ä¸­ã€ç›´æ¥è°ƒç”¨ã€‘æ‰èµ·ä½œç”¨ã€‚ if gp._panic.argp == uintptr(unsafe.Pointer(\u0026argtype)) { gp._panic.argp = getargp(0) } } Goè¯­è¨€å¯¹recoverå¼ºåŠ çš„ä¸€æ¡é™åˆ¶ï¼šå¿…é¡»åœ¨deferå‡½æ•°ä¸­ç›´æ¥è°ƒç”¨recover()å‡½æ•°æ‰æœ‰ç”¨ï¼Œä¸å¯åµŒå¥—åœ¨å…¶ä»–å‡½æ•°ä¸­ã€‚ recover()å‡½æ•°è°ƒç”¨æœ‰æ•ˆçš„ç¤ºä¾‹ä»£ç ï¼š 1 2 3 4 5 func fn() { defer func() { recover() }() } recover()å‡½æ•°è°ƒç”¨æ— æ•ˆçš„ç¤ºä¾‹ä»£ç ï¼š 1 2 3 4 5 6 7 8 9 func fn() { defer func() { r() }() } func r() { recover() } Goè¯­è¨€çš„recoverä¸å…¶ä»–è¯­è¨€çš„tryå’Œcatchæœ‰æ˜æ˜¾çš„ä¸åŒï¼Œå³ä¸åƒcatchè¯­å¥é‚£æ ·èƒ½å¤Ÿé™å®šå¼‚å¸¸çš„ç±»å‹ã€‚ å¦‚æœæ²¡æœ‰å¯¹recoverçš„è¿™ç§é™åˆ¶ï¼Œå°±ä¼šä½¿ä»£ç è¡Œä¸ºå˜å¾—ä¸å¯æ§ï¼Œpanicå¯èƒ½ç»å¸¸ä¼šè¢«æŸä¸ªæ·±åº¦åµŒå¥—çš„recoveræ¢å¤ï¼Œç„¶è€Œè¿™å¹¶ä¸æ˜¯å¼€å‘è€…æƒ³è¦çš„ã€‚ panic()æ±‡ç¼– 1 2 3 4 5 package main func main() { panic(\"111111\") } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 TEXT main.main(SB) /mnt/hgfs/g/hello1/hello.go hello.go:3 0x45b4a0 493b6610 cmp rsp, qword ptr [r14+0x10] hello.go:3 0x45b4a4 7622 jbe 0x45b4c8 hello.go:3 0x45b4a6 4883ec18 sub rsp, 0x18 hello.go:3 0x45b4aa 48896c2410 mov qword ptr [rsp+0x10], rbp hello.go:3 0x45b4af 488d6c2410 lea rbp, ptr [rsp+0x10] # å‡†å¤‡ç©ºæ¥å£å‚æ•° AX=rip+0x4c65 etype.type *typeç±»å‹ hello.go:4 0x45b4b4 488d05654c0000 lea rax, ptr [rip+0x4c65] # å‡†å¤‡ç©ºæ¥å£å‚æ•° BX=rip+0x1463e etype.data uintptrç±»å‹ hello.go:4 0x45b4bb 488d1d3e460100 lea rbx, ptr [rip+0x1463e] # gopanicæ ‡è¯†panicå¼€å§‹ï¼ŒAXå’ŒBXå¯„å­˜å™¨å­˜å‚¨çš„æ˜¯è¦ä¼ é€’çš„æ•°æ® hello.go:4 0x45b4c2 e8d946fdff call $runtime.gopanic hello.go:4 0x45b4c7 90 nop hello.go:3 0x45b4c8 e893cdffff call $runtime.morestack_noctxt .:0 0x45b4cd ebd1 jmp $main.main ",
  "wordCount" : "3075",
  "inLanguage": "zh",
  "image": "https://heliu.site/favicon-32x32.png","datePublished": "2024-08-06T00:00:00Z",
  "dateModified": "2024-08-06T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://heliu.site/posts/golang/func/painc-theory/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://heliu.site/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://heliu.site/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://heliu.site/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://heliu.site/" title="ä¸»é¡µ">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/posts" title="æ–‡ç« ">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/archives" title="æ—¶é—´è½´">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/tags/" title="æ ‡ç­¾">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/search/" title="æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/support" title="æ‰“èµ">
                    <span>ğŸ«¶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://heliu.site/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/">Article</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/golang/">Golang åˆé›†</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/golang/func/">ç¬¬9ç«  Function</a></div>
    <h1 class="post-title entry-hint-parent">
      paincã€recover(åŸç†)
    </h1>
    <div class="post-description">
      ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬
    </div>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2024-08-06</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2024-08-06</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>3075å­—</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>15åˆ†é’Ÿ</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &nbsp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://heliu.site/tags/golang/" target="_blank" rel="noopener">Golang</a>
            <a href="https://heliu.site/tags/%E5%87%BD%E6%95%B0/" target="_blank" rel="noopener">å‡½æ•°</a>
            <a href="https://heliu.site/tags/panic/" target="_blank" rel="noopener">Panic</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &nbsp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#type-_panic-struct" aria-label="type _panic struct">type _panic struct</a></li>
                    <li>
                        <a href="#panic" aria-label="panic">panic</a><ul>
                            
                    <li>
                        <a href="#gopanic" aria-label="gopanic()">gopanic()</a></li>
                    <li>
                        <a href="#runopendeferframe" aria-label="runOpenDeferFrame()">runOpenDeferFrame()</a></li>
                    <li>
                        <a href="#recovery" aria-label="recovery()">recovery()</a></li>
                    <li>
                        <a href="#preprintpanics" aria-label="preprintpanics()">preprintpanics()</a></li>
                    <li>
                        <a href="#printpanics" aria-label="printpanics()">printpanics()</a></li></ul>
                    </li>
                    <li>
                        <a href="#recover" aria-label="recover()">recover()</a><ul>
                            
                    <li>
                        <a href="#gorecover" aria-label="gorecover()">gorecover()</a></li></ul>
                    </li>
                    <li>
                        <a href="#panic%e6%b1%87%e7%bc%96" aria-label="panic()æ±‡ç¼–">panic()æ±‡ç¼–</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><ol>
<li>åªæœ‰åœ¨ defer å‡½æ•°ä¸­è°ƒç”¨ recover() å‡½æ•°æ‰æœ‰æ•ˆï¼Œå› ä¸ºå‘ç”Ÿ panic ä¹‹ååªæœ‰ defer å‡½æ•°èƒ½å¤Ÿå¾—åˆ°æ‰§è¡Œã€‚</li>
<li>Go è¯­è¨€åœ¨è®¾è®¡ä¸Šä¿è¯æ‰€æœ‰çš„ defer å‡½æ•°éƒ½èƒ½å¤Ÿå¾—åˆ°è°ƒç”¨ï¼Œæ‰€ä»¥é€‚åˆç”¨ defer æ¥é‡Šæ”¾èµ„æºï¼Œå³ä½¿å‘ç”Ÿ panic ä¹Ÿä¸ä¼šé€ æˆèµ„æºæ³„éœ²ã€‚</li>
</ol>
<h2 id="type-_panic-struct">type _panic struct<a hidden class="anchor" aria-hidden="true" href="#type-_panic-struct">#</a></h2>
<ol>
<li>è¯¥ç»“æ„ä½“å­˜å‚¨ç€panicçš„ç›¸å…³ä¿¡æ¯ã€‚</li>
<li>æ–‡ä»¶ä½ç½®ï¼šgo1.19.3/src/runtime/runtime2.goã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// A _panic holds information about an active panic.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// A _panic value must only ever live on the stack.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// The argp and link fields are stack pointers, but don&#39;t need special
</span></span></span><span class="line"><span class="cl"><span class="c1">// handling during stack growth: because they are pointer-typed and
</span></span></span><span class="line"><span class="cl"><span class="c1">// _panic values only live on the stack, regular stack pointer
</span></span></span><span class="line"><span class="cl"><span class="c1">// adjustment takes care of them.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">_panic</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// argp è®¾ç½®ä¸ºå½“å‰gopanic()å‡½æ•°æ ˆå¸§ä¸Šargs to calleeåŒºé—´çš„èµ·å§‹åœ°å€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸»è¦ä½œç”¨ï¼šç”¨äºdefer()å‡½æ•°æ‰§è¡Œæ—¶åˆ¤æ–­recover()å‡½æ•°æ‰€åœ¨èŒƒå›´æ˜¯å¦èƒ½ç”Ÿæ•ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">argp</span>      <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// pointer to arguments of deferred call run during panic; cannot move - known to liblink
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ™æ˜¯panicå‡½æ•°è‡ªå·±çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯ã€panic(v any)ã€‘è¿™é‡Œçš„ç©ºæ¥å£ã€vã€‘çš„å‚æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸»è¦ä½œç”¨ï¼šç»“æŸæ—¶ç”¨äºæ‰“å°é”™è¯¯ä¿¡æ¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">arg</span>       <span class="nx">any</span>            <span class="c1">// argument to panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// é€šè¿‡linké“¾æ¥åˆ°å‰ä¸€ä¸ªæ³¨å†Œçš„panicå½¢æˆé“¾è¡¨ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è§£é‡Šï¼šæ–°å¢çš„panicæ€»æ˜¯ä»å·¦è¾¹æ’å…¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">link</span>      <span class="o">*</span><span class="nx">_panic</span>        <span class="c1">// link to earlier panic	g._painc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// pc æ¥è‡ª defer.pc æ‹·è´çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸»è¦ä½œç”¨ï¼šç”¨äºå½“å‰panicè¢«æ¢å¤æ—¶è¦æ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€åŠIPå¯„å­˜å™¨çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">pc</span>        <span class="kt">uintptr</span>        <span class="c1">// where to return to in runtime if this panic is bypassed	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// sp æ¥è‡ª defer.sp æ‹·è´çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸»è¦ä½œç”¨ï¼šç”¨äºå½“å‰panicè¢«æ¢å¤æ—¶è¦æ¢å¤çš„æ ˆé¡¶SPå¯„å­˜å™¨çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sp</span>        <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// where to return to in runtime if this panic is bypassed 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¡¨ç¤ºå½“å‰panicå·²ç»è¢«æŸä¸ªdeferå‡½æ•°é€šè¿‡recoveræ¢å¤ã€‚ã€å·²æ¢å¤ã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è§£é‡Šï¼šè¯¥å€¼åœ¨recover()å‡½æ•°ä¸­è¢«æ ‡è®°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">recovered</span> <span class="kt">bool</span>           <span class="c1">// whether this panic is over
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// è¡¨ç¤ºå‘ç”Ÿäº†åµŒå¥—çš„panicï¼Œæ—§çš„panicè¢«æ–°çš„panicæµç¨‹æ ‡è®°ä¸ºabortedã€‚ã€å·²ä¸­æ­¢ã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è§£é‡Šï¼šå°±æ˜¯å‘ç”Ÿäº†åµŒå¥—panicäº†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">aborted</span>   <span class="kt">bool</span>           <span class="c1">// the panic was aborted
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// æ˜¯å¦æ‰§è¡Œruntime.Goexit()å‡½æ•°ï¼Œruntime.Goexit()å‡½æ•°æ˜¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// goroutineæ‰§è¡Œå®Œåè·³è½¬åˆ°çš„æ¸…ç†é¦–å°¾å·¥ä½œçš„å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// goexitå­—æ®µåœ¨ï¼Œruntime.Goexit()å‡½æ•°ä¸­è¢«æ ‡è®°ä¸ºtrueã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">goexit</span>    <span class="kt">bool</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/func-026.png" alt=""  />
</p>
<h2 id="panic">panic<a hidden class="anchor" aria-hidden="true" href="#panic">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// The panic built-in function stops normal execution of the current
</span></span></span><span class="line"><span class="cl"><span class="c1">// goroutine. When a function F calls panic, normal execution of F stops
</span></span></span><span class="line"><span class="cl"><span class="c1">// immediately. Any functions whose execution was deferred by F are run in
</span></span></span><span class="line"><span class="cl"><span class="c1">// the usual way, and then F returns to its caller. To the caller G, the
</span></span></span><span class="line"><span class="cl"><span class="c1">// invocation of F then behaves like a call to panic, terminating G&#39;s
</span></span></span><span class="line"><span class="cl"><span class="c1">// execution and running any deferred functions. This continues until all
</span></span></span><span class="line"><span class="cl"><span class="c1">// functions in the executing goroutine have stopped, in reverse order. At
</span></span></span><span class="line"><span class="cl"><span class="c1">// that point, the program is terminated with a non-zero exit code. This
</span></span></span><span class="line"><span class="cl"><span class="c1">// termination sequence is called panicking and can be controlled by the
</span></span></span><span class="line"><span class="cl"><span class="c1">// built-in function recover.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nb">panic</span><span class="p">(</span><span class="nx">v</span> <span class="nx">any</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="gopanic">gopanic()<a hidden class="anchor" aria-hidden="true" href="#gopanic">#</a></h3>
<ol>
<li>gopanic() ä¹Ÿå°±æ˜¯ panic() å‘ç”Ÿæ—¶è°ƒç”¨çš„å‡½æ•°ã€‚</li>
<li>gopanic() å‡½æ•°ä¸­å…³é”®çš„ open coded defer éƒ¨åˆ†ï¼š
<ol>
<li>åœ¨ for å¾ªç¯å¼€å§‹ä¹‹å‰ï¼Œå…ˆé€šè¿‡ addOneOpenDeferFrame() å‡½æ•°å°†æœ€è¿‘çš„ä¸€ä¸ª open coded defer æ ˆå¸§æ·»åŠ åˆ° _defer é“¾è¡¨ä¸­ã€‚</li>
<li>åœ¨è°ƒç”¨ defer å‡½æ•°çš„æ—¶å€™ï¼Œå¦‚æœ openDefer ä¸º true ï¼Œåˆ™ä½¿ç”¨ runOpenDeferFrame() å‡½æ•°æ¥æ‰§è¡Œï¼Œé€šè¿‡è¿”å›å€¼æ¥åˆ¤æ–­ç›®æ ‡æ ˆå¸§ä¸Šçš„ open coded defer å·²ç»å®Œå…¨æ‰§è¡Œï¼Œå¹¶ä¸”æ²¡æœ‰ recoverï¼Œå°±å†æ¬¡è°ƒç”¨ addOneOpenDeferFrame() å‡½æ•°æŠŠä¸‹ä¸€ä¸ª open coded defer æ ˆå¸§æ·»åŠ åˆ° _defer é“¾è¡¨ã€‚</li>
<li>æ ¹æ® runOpenDeferFrame() å‡½æ•°çš„è¿”å›å€¼æ¥åˆ¤æ–­ï¼Œåªæœ‰å®Œå…¨æ‰§è¡Œçš„èŠ‚ç‚¹æ‰èƒ½ä» _defer é“¾è¡¨ä¸­ç§»é™¤ã€‚äº‹å®ä¸Šåªæœ‰ openDefer èŠ‚ç‚¹æ‰æœ‰å¯èƒ½å‡ºç°ä¸å®Œå…¨æ‰§è¡Œçš„æƒ…å†µï¼Œå› ä¸ºä¸€ä¸ªæ ˆå¸§ä¸Šå¯èƒ½æœ‰å¤šä¸ª open coded defer å‡½æ•°ï¼Œå‡å¦‚å…¶ä¸­æŸä¸€ä¸ªå‡½æ•°è°ƒç”¨äº† recover() å‡½æ•°ï¼Œåç»­çš„å°±ä¸ä¼šå†è¢«è°ƒç”¨äº†ï¼Œæ‰€ä»¥è¯¥èŠ‚ç‚¹ä¸èƒ½ä» _defer é“¾è¡¨ä¸­ç§»é™¤ï¼Œrecover ä¹‹åçš„é€»è¾‘è´Ÿè´£è°ƒç”¨è¿™äº›å‰©ä½™çš„ open coded deferã€‚</li>
<li>æ£€æŸ¥åˆ°å½“å‰ panic çš„ recover ä¸º true åï¼Œéœ€è¦æŠŠ _defer é“¾è¡¨ä¸­å°šæœªå¼€å§‹æ‰§è¡Œçš„ openDefer èŠ‚ç‚¹ç§»é™¤ï¼Œå› ä¸º recover ä¹‹åè¿™äº› open coded defer ä¼šè¢«æ­£å¸¸è°ƒç”¨ã€‚</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// The implementation of the predeclared function panic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">gopanic</span><span class="p">(</span><span class="nx">e</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å–å½“å‰æ­£åœ¨è¿è¡Œçš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒç”¨gopanic()åº”è¯¥æ˜¯åœ¨ç”¨æˆ·æ ˆä¸Šå‘ç”Ÿçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">curg</span> <span class="o">!=</span> <span class="nx">gp</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;panic: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printany</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// panic åœ¨ç³»ç»Ÿæ ˆä¸Š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;panic on system stack&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ç”³è¯·å†…å­˜æœŸé—´ä¸å…è®¸panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">mallocing</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;panic: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printany</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// malloc æœŸé—´ panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// malloc æ˜¯åœ¨ç”³è¯·å†…å­˜æœŸé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;panic during malloc&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// æŠ¢å æœŸé—´ä¸å…è®¸panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">preemptoff</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;panic: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printany</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;preempt off reason: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">preemptoff</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;panic during preemptoff&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// MæŒæœ‰é”æœŸé—´ä¸å…è®¸panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">locks</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;panic: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printany</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;panic holding locks&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) åˆ›å»ºä¸€ä¸ª_panicç»“æ„å¹¶åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯ä»¥çœ‹å‡ºpanicå’Œdeferç»“æ„éƒ½æ˜¯ç”¨çš„ç”¨æˆ·å†…å­˜ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆå§‹åŒ–ä¸€ä¸ªpanicç»“æ„ä½“ï¼Œåœ¨æ ˆä¸Šåˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">p</span> <span class="nx">_panic</span>		
</span></span><span class="line"><span class="cl">    <span class="nx">p</span><span class="p">.</span><span class="nx">arg</span> <span class="p">=</span> <span class="nx">e</span> <span class="c1">// ä¿å­˜panicçš„å‚æ•°ï¼Œè¯¥å‚æ•°æ˜¯panic(v any)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _panicé€šè¿‡linké“¾æ¥å…¶ä»–panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è®°å½•goroutineä¸Šçš„æœ€åä¸€ä¸ªpanicï¼Œä¹Ÿå°±æ˜¯å½¢æˆä¸€ä¸ªpanicçš„é“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">p</span><span class="p">.</span><span class="nx">link</span> <span class="p">=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span>	
</span></span><span class="line"><span class="cl">    <span class="c1">// g._panic ä¿å­˜çš„æ˜¯æœ€æ–°çš„panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç‰¹æ„ä½¿ç”¨noescapeå‡½æ•°æ¥é¿å…pé€ƒé€¸ï¼Œåº”ä¸ºpanicæœ¬èº«å°±æ˜¯ä¸æ ˆçš„çŠ¶æ€å¼ºç›¸å…³çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰panicè¿½åŠ åˆ°goroutineçš„panicé“¾è¡¨ä¸Šï¼Œè®°å½•æœ€æ–°çš„ä¸€ä¸ªpanic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">_panic</span><span class="p">)(</span><span class="nf">noescape</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">)))</span>	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ä½¿ç”¨åŸå­é”æ ‡è®°panicæ­£åœ¨å‘ç”Ÿï¼Œç”¨äºruntime.main()å‡½æ•°ç­‰å¾…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“runtime.main()å³å°†è¦ç»“æŸæ—¶ï¼Œéœ€è¦å¾ªç¯ç­‰å¾…panicå®Œæˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å…·ä½“ä»£ç å‚çœ‹ runtime.main() å‡½æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">runningPanicDefers</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 2) open code defers å½¢å¼æ‰«ææ ˆï¼Œæ”¶é›†ä¿¡æ¯,å·²å¤‡åé¢å¾ªç¯gp.defer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// By calculating getcallerpc/getcallersp here, we avoid scanning the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// gopanic frame (stack scanning is slow...)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é€šè¿‡è¿™é‡Œè®¡ç®—getcallerpc/getcallerspï¼Œæˆ‘ä»¬é¿å…æ‰«ægopanicå¸§ï¼ˆå †æ ˆæ‰«æå¾ˆæ…¢......ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å°†æœ€è¿‘çš„ä¸€ä¸ªopen coded deferæ ˆå¸§æ·»åŠ åˆ°_deferé“¾è¡¨ä¸­ï¼Œå¯èƒ½æ˜¯ä¸€ç»„deferå‡½æ•°ç»„æˆçš„ä¸€ä¸ª_deferç»“æ„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">addOneOpenDeferFrame</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nf">getcallerpc</span><span class="p">(),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nf">getcallersp</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åœ¨è¿™ä¸ªå¾ªç¯ä¸­é€ä¸ªè°ƒç”¨é“¾è¡¨ä¸­çš„deferå‡½æ•°ï¼Œå¹¶æ£€æµ‹recoverçš„çŠ¶æ€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœæ‰€æœ‰çš„deferå‡½æ•°éƒ½æ‰§è¡Œå®Œåè¿˜æ˜¯æ²¡æœ‰recoverï¼Œåˆ™å¾ªç¯å°±ä¼šç»“æŸï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æœ€åçš„fatalpanic()å‡½æ•°å°±ä¼šç»“æŸå½“å‰è¿›ç¨‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å–æœ€æ–°çš„ä¸€ä¸ªdefer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿™é‡Œå¯ä»¥çœ‹çœ‹å‡ºå–å‡ºçš„deferä¸ä¸€å®šæ˜¯å½“å‰å‘ç”Ÿpanicæ³¨å†Œçš„deferå¯èƒ½æ˜¯ä¸Šæ¸¸è°ƒç”¨å‡½æ•°æ³¨å†Œçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">d</span> <span class="o">:=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">_defer</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">d</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// deferå·²ç»è¿è¡Œå®Œäº†ï¼Œç»“æŸå¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// If defer was started by earlier panic or Goexit (and, since we&#39;re back here, that triggered a new panic),
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// take defer off list. An earlier panic will not continue running, but we will make sure below that an
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// earlier Goexit does continue running.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// d.startedä¸ºçœŸï¼Œè¡¨æ˜å½“å‰æ˜¯ä¸€ä¸ªåµŒå¥—çš„panicï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä¹Ÿå°±æ˜¯åœ¨åŸæœ‰panicæˆ–Goexit()å‡½æ•°æ‰§è¡Œdeferå‡½æ•°çš„æ—¶å€™åˆè§¦å‘äº†panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å› ä¸ºè§¦å‘panicçš„deferå‡½æ•°è¿˜æ²¡æœ‰æ‰§è¡Œå®Œï¼Œæ‰€ä»¥è¿˜æ²¡æœ‰ä»é“¾è¡¨ä¸­ç§»é™¤ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿™é‡Œä¼šæŠŠdç›¸å…³çš„æ—§çš„_panicè®¾ç½®ä¸ºabortedï¼Œç„¶åæŠŠdä»é“¾è¡¨ä¸­ç§»é™¤ï¼Œå¹¶é€šè¿‡freedefer()å‡½æ•°é‡Šæ”¾deferã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">started</span> <span class="p">{</span> <span class="c1">// é¦–æ¬¡è§¦å‘panicè¿™é‡Œä¸º falseï¼Œå¤šæ¬¡è§¦å‘è¿™é‡Œä¸º true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// d._panicè®°å½•çš„æ˜¯å‰ä¸€ä¸ªpanicï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// åœ¨æ‰§è¡Œd.fn()å‡½æ•°çš„æ—¶å€™åˆå‘ç”Ÿäº†panicçš„æƒ…å†µã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">_panic</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// æŠŠå‰ä¸€ä¸ªpanicæ ‡è®°ä¸ºå·²ç»ˆæ­¢çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">d</span><span class="p">.</span><span class="nx">_panic</span><span class="p">.</span><span class="nx">aborted</span> <span class="p">=</span> <span class="kc">true</span> <span class="c1">// å·²ç»ˆæ­¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">d</span><span class="p">.</span><span class="nx">_panic</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ä¸æ˜¯open deferså½¢å¼æ—¶ï¼Œåˆ™ç›´æ¥å›æ”¶å½“å‰deferç»“æ„ä½“å³å¯ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å› ä¸ºå½“å‰gopanic()æ­£æ˜¯å½“å‰deferå‡½æ•°ä¸­è§¦å‘ï¼Œå› æ­¤ç›´æ¥ç»“æŸæœ¬æ¬¡å¾ªç¯å³å¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">!</span><span class="nx">d</span><span class="p">.</span><span class="nx">openDefer</span> <span class="p">{</span>		
</span></span><span class="line"><span class="cl">                <span class="c1">// For open-coded defers, we need to process the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// defer again, in case there are any other defers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// to call in the frame (not including the defer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// call that caused the panic).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// å½“å‰deferå·²æ‰§è¡Œå®Œï¼Œå³å°†è¢«å›æ”¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">d</span><span class="p">.</span><span class="nx">fn</span> <span class="p">=</span> <span class="kc">nil</span> 
</span></span><span class="line"><span class="cl">                <span class="nx">gp</span><span class="p">.</span><span class="nx">_defer</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">link</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// å› ä¸ºå½“å‰deferä¸­å‘ç”Ÿäº†panicï¼Œåç»­ä»£ç ä¸ä¼šè¢«æ‰§è¡Œï¼Œç›´æ¥å›æ”¶deferå³å¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">freedefer</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>		
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// å¦åˆ™åº”è¯¥å»runOpenDeferFrameå›æ”¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// åç»­çš„3å¤§å—é€»è¾‘å°±æ˜¯ï¼šè°ƒç”¨deferå‡½æ•°ã€é‡Šæ”¾_deferç»“æ„å’Œæ£€æµ‹recoverã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 2.1) è°ƒç”¨deferå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1">// Mark defer as started, but keep on list, so that traceback
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// can find and update the defer&#39;s argument frame if stack growth
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// or a garbage collection happens before executing d.fn.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å¦‚æœdeferå‡½æ•°åˆè§¦å‘äº†panicï¼Œæ–°çš„panicéå†deferé“¾è¡¨æ—¶ï¼Œå°±èƒ½å¤Ÿé€šè¿‡started
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// çš„å€¼ç¡®å®šç¡®å®šè¯¥deferå‡½æ•°å·²ç»è¢«è°ƒç”¨è¿‡äº†ï¼Œé¿å…é‡å¤è°ƒç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">d</span><span class="p">.</span><span class="nx">started</span> <span class="p">=</span> <span class="kc">true</span>    <span class="c1">// æ ‡è®°å½“å‰deferè¢«panicè§¦å‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Record the panic that is running the defer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// If there is a new panic during the deferred call, that panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// will find d in the list and will mark d._panic (this panic) aborted.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä¸ºd._panicèµ‹å€¼ï¼Œå°†då…³è”åˆ°å½“å‰panicå¯¹è±¡pï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä½¿ç”¨noescapeå‡½æ•°é¿å…pé€ƒé€¸ï¼Œè¿™ä¸€æ­¥æ˜¯ä¸ºäº†åç»­åµŒå¥—çš„panicèƒ½å¤Ÿé€šè¿‡d._panicæ‰¾åˆ°ä¸Šä¸€ä¸ªpanic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">d</span><span class="p">.</span><span class="nx">_panic</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">_panic</span><span class="p">)(</span><span class="nf">noescape</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">)))</span> <span class="c1">// å½“å‰deferçš„_panicè®°å½•è§¦å‘çš„panicæ˜¯é‚£ä¸ª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="nx">done</span> <span class="o">:=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">openDefer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å½“å‰æ˜¯open code defersæ¨¡å¼æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿è¡Œå½“å‰deferçš„fnå‡½æ•°ï¼Œdone=trueè¡¨ç¤ºæ‰€æœ‰çš„deferå·²ç»è¿è¡Œå®Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// é€šè¿‡è¿”å›å€¼æ¥åˆ¤æ–­ç›®æ ‡æ ˆå¸§ä¸Šçš„open coded deferå·²ç»å®Œå…¨æ‰§è¡Œï¼Œå¹¶ä¸”æ²¡æœ‰recoverï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å°±å†æ¬¡è°ƒç”¨addOneOpenDeferFrame()å‡½æ•°æŠŠä¸‹ä¸€ä¸ªopen coded deferæ ˆå¸§æ·»åŠ åˆ°_deferé“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">done</span> <span class="p">=</span> <span class="nf">runOpenDeferFrame</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="c1">// è¿™é‡Œè¿è¡Œçš„æ˜¯ä¸€ç»„defer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å› ä¸ºä¸Šé¢è¿è¡Œçš„d.fn()å‡½æ•°ï¼Œå¯èƒ½å…¶ä¸­å­˜åœ¨recover()å‡½æ•°ï¼Œæ‰€ä»¥è¦åˆ¤æ–­recoveredå­—æ®µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">done</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">d</span><span class="p">.</span><span class="nx">_panic</span><span class="p">.</span><span class="nx">recovered</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">                <span class="c1">// done=trueï¼Œå¹¶ä¸”å½“å‰è¿™ä¸ªpanicå¹¶æ²¡æœ‰è¢«æ¢å¤æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// å†å»å¯»æ‰¾åé¢å‡½æ•°çš„defer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// ä»è°ƒç”¨æ ˆçš„æ ˆé¡¶å¼€å§‹å›æº¯æ‰«æï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªå¸¦æœ‰open coded deferçš„æ ˆå¸§ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// ä¸ºè¯¥æ ˆå¸§åˆ†é…ä¸€ä¸ª_deferç»“æ„ï¼Œä¸ºå„ä¸ªå­—æ®µèµ‹å€¼åæ·»åŠ åˆ°deferé“¾è¡¨ä¸­åˆé€‚çš„ä½ç½®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// ä¸ç®¡ç›®æ ‡æ ˆå¸§ä¸Šæœ‰å‡ ä¸ªopen coded deferå‡½æ•°ï¼Œåªåˆ†é…ä¸€ä¸ª_deferç»“æ„ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// å› ä¸ºåç»­é€šè¿‡runOpenDeferFrame()å‡½æ•°æ¥æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šä¸€å¹¶æ‰§è¡Œæ ˆå¸§ä¸Šçš„æ‰€æœ‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// open coded deferå‡½æ•°ã€‚æ·»åŠ åˆ°_deferé“¾è¡¨ä¸­çš„ä½ç½®æ˜¯æ ¹æ®ç›®æ ‡æ ˆå¸§åœ¨è°ƒç”¨æ ˆä¸­çš„ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// è®¡ç®—çš„ï¼Œè€Œä¸æ˜¯æ·»åŠ åˆ°å¤´éƒ¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">addOneOpenDeferFrame</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">            <span class="c1">// deferæ˜¯å †æˆ–æ ˆåˆ†å¸ƒæ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            
</span></span><span class="line"><span class="cl">            <span class="c1">// getargp()ï¼šè®¾ç½®ä¸ºå½“å‰gopanic()å‡½æ•°æ ˆå¸§ä¸Šargs to calleeåŒºé—´çš„èµ·å§‹åœ°å€ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// recover()å‡½æ•°é€šè¿‡è¿™ä¸ªå€¼æ¥åˆ¤æ–­è‡ªèº«æ˜¯å¦ç›´æ¥è¢«deferå‡½æ•°è°ƒç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">p</span><span class="p">.</span><span class="nx">argp</span> <span class="p">=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nf">getargp</span><span class="p">())</span> <span class="c1">// è¯¥å€¼åœ¨fnæ‰§è¡Œå‡½æ•°ä¸­ç”¨äºrecoverå‡½æ•°æ¯”è¾ƒåˆ¤æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æ‰§è¡Œdeferæ³¨å†Œçš„å‡½æ•°ï¼Œå¦‚æœè¿™é‡Œåˆå‘ç”Ÿäº†panicæ—¶åˆ™å½“å‰deferå¹¶æœªè¢«æ¸…é™¤ï¼Œåˆä¼šä»æ–°gopanic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">d</span><span class="p">.</span><span class="nf">fn</span><span class="p">()</span>	
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä¸ºä»€ä¹ˆå‰é¢è®¾ç½®äº†argpå€¼è¿™é‡Œåˆè¦æ¸…é™¤æ‰ï¼Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å› æ­¤d.fn()æ‰§è¡Œçš„deferå‡½æ•°ä¸­å¯èƒ½ä¼šæœ‰recover()å‡½æ•°ï¼Œéœ€è¦åˆ¤æ–­argpçš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">p</span><span class="p">.</span><span class="nx">argp</span> <span class="p">=</span> <span class="kc">nil</span> <span class="c1">// æ¸…é™¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 2.2) é‡Šæ”¾_deferç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1">// Deferred function did not panic. Remove d.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è°ƒç”¨å®Œd.fn()å‡½æ•°åï¼Œä¸åº”è¯¥ä¼šå‡ºç°gp._deferä¸ç­‰äºdè¿™ç§æƒ…å†µã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å‡å¦‚åœ¨d.fn()å‡½æ•°æ‰§è¡Œçš„è¿‡ç¨‹ä¸­æ²¡æœ‰é€ æˆæ–°çš„panicï¼Œé‚£ä¹ˆæ‰€æœ‰æ–°æ³¨å†Œçš„deferéƒ½åº”è¯¥åœ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// d.fn()å‡½æ•°è¿”å›çš„æ—¶å€™è¢«deferreturn()å‡½æ•°ç§»å‡ºé“¾è¡¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å‡å¦‚d.fn()å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­é€ æˆäº†æ–°çš„panicï¼Œè‹¥æ²¡æœ‰recoverï¼Œåˆ™ä¸ä¼šå†å›åˆ°è¿™é‡Œï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è‹¥ç»recoverä¹‹åå†å›åˆ°è¿™é‡Œï¼Œåˆ™æ‰€æœ‰åœ¨d.fn()å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­æ³¨å†Œçš„deferä¹Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// éƒ½åº”è¯¥åœ¨d.fn()å‡½æ•°è¿”å›ä¹‹å‰è¢«ç§»é™¤é“¾è¡¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">_defer</span> <span class="o">!=</span> <span class="nx">d</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad defer entry in panic&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å½“å‰deferæ‰§è¡Œå®Œéœ€è¦æŠŠ_panicæ ‡è®°ä¸ºnilï¼Œåé¢ä¼šåˆ é™¤è¿™ä¸ªdefer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">d</span><span class="p">.</span><span class="nx">_panic</span> <span class="p">=</span> <span class="kc">nil</span>	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// trigger shrinkage to test stack copy. See stack_test.go:TestStackPanic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//GC()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æŠŠpcå’Œspå­—æ®µä¿å­˜åœ¨å±€éƒ¨å˜é‡ä¸­ï¼Œä¾›æ¥ä¸‹æ¥æ£€æµ‹æ‰§è¡Œrecoveræ—¶ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ­¤å¤„é¢spç±»å‹å¿…é¡»æ—¶æŒ‡é’ˆï¼Œå› ä¸ºåç»­å¦‚æœæ ˆè¢«ç§»åŠ¨ï¼Œåªæœ‰æŒ‡é’ˆç±»å‹ä¼šå¾—åˆ°æ›´æ–°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">pc</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">pc</span> <span class="c1">// è¦æ¢å¤çš„PCå’ŒSPçš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sp</span> <span class="o">:=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">sp</span><span class="p">)</span> <span class="c1">// must be pointer so it gets adjusted during stack copy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">done</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// done=trueï¼Œè¿™ä¸€ç»„deferå‡½æ•°å·²æ‰§è¡Œå®Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å› æ­¤deferå‡½æ•°å¯ä»¥è¢«é‡Šæ”¾æ‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">d</span><span class="p">.</span><span class="nx">fn</span> <span class="p">=</span> <span class="kc">nil</span>			
</span></span><span class="line"><span class="cl">            <span class="nx">gp</span><span class="p">.</span><span class="nx">_defer</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">link</span>  <span class="c1">// ä»goroutine._deferä¸Šç§»é™¤è‡ªå·±
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">freedefer</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>        <span class="c1">// å›æ”¶defer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// 2.3)æ£€æµ‹ recover() æ˜¯å¦æ ‡è®°äº†panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœ d.fn() å‡½æ•°æˆåŠŸåœ°æ‰§è¡Œäº†recover()ï¼Œåˆ™å½“å‰_panicå¯¹è±¡çš„pçš„recoveredå­—æ®µå°±ä¼šè¢«è®¾ç½®ä¸ºtrue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ­¤å¤„é€šè¿‡æ£€æµ‹åå°±ä¼šæ‰§è¡Œrecoveré€»è¾‘ã€‚è¿™é‡Œæ‰æ˜¯recover()å‡½æ•°çš„å…·ä½“å®ç°åŠŸèƒ½ï¼Œè·³è½¬åˆ°æŒ‡å®šä»£ç å¤„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">recovered</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 2.3.1) recover()ç”Ÿæ•ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  1. ç§»é™¤å½“å‰_panicï¼Œå› ä¸ºå½“å‰_panicå·²è¢«æ¢å¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  2. å‘å‰å¯»æ‰¾ç§»é™¤è¢«æ ‡è®°ä¸ºabortedä¸ºçœŸçš„_panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">link</span>	<span class="c1">// æŠŠå½“å‰panicä»goroutine._panicä¸Šç§»é™¤æ‰è‡ªå·±
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// gp._panic != nilï¼šåé¢è¿˜æœ‰ panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// gp._panic.goexitï¼šç”±runtime.Goexit()å‡½æ•°è§¦å‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// gp._panic.abortedï¼šå½“å‰panicå·²è¢«ç»ˆæ­¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span><span class="p">.</span><span class="nx">goexit</span> <span class="o">&amp;&amp;</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span><span class="p">.</span><span class="nx">aborted</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">                <span class="c1">// A normal recover would bypass/abort the Goexit.  Instead,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// we return to the processing loop of the Goexit.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// æ­£å¸¸æ¢å¤å°† bypass/abortåˆ° Goexitã€‚ ç›¸åï¼Œæˆ‘ä»¬è¿”å›åˆ° Goexit çš„å¤„ç†å¾ªç¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">gp</span><span class="p">.</span><span class="nx">sigcode0</span> <span class="p">=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span><span class="p">.</span><span class="nx">sp</span><span class="p">)</span> <span class="c1">// å¹¶æ²¡æœ‰å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">gp</span><span class="p">.</span><span class="nx">sigcode1</span> <span class="p">=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span><span class="p">.</span><span class="nx">pc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// mcallå‡½æ•°ä»å½“å‰gæ ˆåˆ‡æ¢åˆ°g0æ ˆï¼Œåœ¨æ‰§è¡Œrecoveryå‡½æ•°ï¼Œæ¢å¤åæ˜¯æ¥åˆ°ä»å½“å‰æœ€æ–°panicçš„å¤„å¾€ä¸‹æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// recoveryå‡½æ•°åˆ¤æ–­æ ˆæº¢å‡ºåï¼Œç›´æ¥æŠŠspå’Œpcå€¼èµ‹å€¼ç»™å½“å‰goroutineçš„schedç„¶åä½¿ç”¨gogoå‡½æ•°å†æ¬¡è¢«è°ƒåº¦èµ·æ¥æ¥åˆ°æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">mcall</span><span class="p">(</span><span class="nx">recovery</span><span class="p">)</span>	 <span class="c1">// è¿™ç§æƒ…å†µåº”è¯¥æŠ¥é”™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// ä»è¿™é‡Œè·³è½¬åˆ°deferreturnå‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bypassed recovery failed&#34;</span><span class="p">)</span> <span class="c1">// mcall should not return åº”è¯¥æ°¸è¿œä¸ä¼šè¿”å›åˆ°è¿™é‡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// è§£é”panicæ ‡å¿—ï¼Œruntime.main()å¯ä»¥ç»§ç»­æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">atomic</span><span class="p">.</span><span class="nf">Xadd</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">runningPanicDefers</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// After a recover, remove any remaining non-started,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// open-coded defer entries, since the corresponding defers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// will be executed normally (inline). Any such entry will
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// become stale once we run the corresponding defers inline
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// and exit the associated stack frame. We only remove up to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// the first started (in-progress) open defer entry, not
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// including the current frame, since any higher entries will
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// be from a higher panic in progress, and will still be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// needed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">d</span> <span class="o">:=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">_defer</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nx">prev</span> <span class="o">*</span><span class="nx">_defer</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">!</span><span class="nx">done</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Skip our current frame, if not done. It is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// needed to complete any remaining defers in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// deferreturn()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// è·³è¿‡å½“å‰å¸§ï¼Œå¦‚æœè¿˜æ²¡æœ‰å®Œæˆã€‚éœ€è¦åœ¨deferreturn()ä¸­å®Œæˆæ‰€æœ‰å‰©ä½™çš„å»¶è¿Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// open coded deferæ—¶å‘ç”Ÿäº†recoveræ—¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">prev</span> <span class="p">=</span> <span class="nx">d</span>
</span></span><span class="line"><span class="cl">                <span class="nx">d</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">link</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="nx">d</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">started</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// This defer is started but we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// are in the middle of a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// defer-panic-recover inside of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// it, so don&#39;t remove it or any
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// further defer entries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// è¿™ä¸ªdeferå·²ç»å¯åŠ¨ï¼Œä½†æ˜¯æˆ‘ä»¬æ­£åœ¨å®ƒå†…éƒ¨è¿›è¡Œä¸€ä¸ª defer-panic-recovery 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// æ‰€ä»¥ä¸è¦åˆ é™¤å®ƒæˆ–ä»»ä½•è¿›ä¸€æ­¥çš„deferæ¡ç›®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">openDefer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="nx">prev</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">gp</span><span class="p">.</span><span class="nx">_defer</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">link</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nx">prev</span><span class="p">.</span><span class="nx">link</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">link</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">newd</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">link</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">freedefer</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">d</span> <span class="p">=</span> <span class="nx">newd</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">prev</span> <span class="p">=</span> <span class="nx">d</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">d</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">link</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">link</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Aborted panics are marked but remain on the g.panic list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Remove them from the list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¾ªç¯ç§»é™¤é“¾è¡¨å¤´éƒ¨æ‰€æœ‰å·²ç»æ ‡è®°ä¸ºabortedçš„_panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿™é‡Œå¯ä»¥çœ‹å‡ºå½“æœ€åä¸€ä¸ªpanicè¢«æ¢å¤å‰é¢çš„æ‰€æœ‰å·²æ ‡è®°abortedä¸­æ­¢çš„panicä¼šè¢«ç§»é™¤ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span><span class="p">.</span><span class="nx">aborted</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span> <span class="p">=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span><span class="p">.</span><span class="nx">link</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å¦‚æœæ²¡æœ‰å‘ç”Ÿpanicï¼Œåˆ™æ­¤æ—¶gp._panicåº”è¯¥ä¸ºnilï¼Œä¸ä¸ºnilå°±è¡¨æ˜å‘ç”Ÿäº†åµŒå¥—çš„panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è€Œä¸”åªæ˜¯å†…å±‚çš„panicè¢«recover
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span> <span class="c1">// must be done with signal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">gp</span><span class="p">.</span><span class="nx">sig</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Pass information about recovering frame to recovery.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¦æ¢å¤çš„PCå’ŒSPçš„å€¼ï¼Œä¹Ÿå°±æ˜¯å½“å‰deferæ³¨å†Œçš„åä¸€æ¡æŒ‡ä»¤å¤„ï¼Œæ˜¯ä¸€æ¡JMPæŒ‡ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è·³è½¬å»æ‰§è¡Œdeferreturn()å‡½æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">gp</span><span class="p">.</span><span class="nx">sigcode0</span> <span class="p">=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">sp</span><span class="p">)</span>   <span class="c1">// éœ€è¦æ¢å¤åˆ°çš„SPåœ°å€ï¼Œä¹Ÿå°±æ˜¯æ³¨å†Œdeferå‡½æ•°çš„æ ˆé¡¶å¯„å­˜å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">gp</span><span class="p">.</span><span class="nx">sigcode1</span> <span class="p">=</span> <span class="nx">pc</span>            <span class="c1">// éœ€è¦æ¢å¤åˆ°IPåœ°å€ï¼Œä¹Ÿå°±æ˜¯æ³¨å†Œdeferå‡½æ•°çš„ä¸‹ä¸€æ¡æŒ‡ä»¤å¤„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// recoveryå‡½æ•°è´Ÿè´£ç”¨å­˜å‚¨åœ¨sigcode0å’Œsigcode1ä¸­çš„spå’Œpcæ¢å¤gpçš„æ‰§è¡ŒçŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">mcall</span><span class="p">(</span><span class="nx">recovery</span><span class="p">)</span>             <span class="c1">// mcallå‡½æ•°åˆ‡æ¢åˆ°ç³»ç»Ÿg0æ ˆå»è°ƒç”¨gogoå‡½æ•°æ‰§è¡Œè·³è½¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;recovery failed&#34;</span><span class="p">)</span>    <span class="c1">// mcall should not return
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// æ‰€æœ‰çš„deferæ³¨å†Œå‡½æ•°éƒ½æ²¡æœ‰recoverï¼Œæœ€åä¼šåˆ°è¿™é‡Œå»æ‰“å°é”™è¯¯ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ran out of deferred calls - old-school panic now
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Because it is unsafe to call arbitrary user code after freezing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the world, we call preprintpanics to invoke all necessary Error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// and String methods to prepare the panic strings before startpanic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// gp._panicï¼šä¿å­˜çš„æœ€æ–°çš„panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">preprintpanics</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span><span class="p">)</span>	<span class="c1">// æŠŠpanicçš„å‚æ•°è§£ææ”¾å…¥arg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ‰“å°panicä¿¡æ¯ï¼Œå¹¶ç»“æŸå½“å‰è¿›ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">fatalpanic</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span><span class="p">)</span> <span class="c1">// should not return
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å‘ä¸€ä¸ªnilçš„åœ°å€å†™å…¥å€¼ï¼Œä¼šæŠ¥é”™ï¼Œä¸‹é¢è¿™è¡Œä»£ç æ˜¯é˜²æ­¢ä¸‡ä¸€ï¼Œä¸åº”è¯¥æ‰§è¡Œåˆ°è¿™é‡Œåœ¨å‰ä¸€ä¸ªå‡½æ•°ä¸­ä¼šç»“æŸè°ƒè¿›ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">int</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)</span> <span class="p">=</span> <span class="mi">0</span>      <span class="c1">// not reached
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="runopendeferframe">runOpenDeferFrame()<a hidden class="anchor" aria-hidden="true" href="#runopendeferframe">#</a></h3>
<ol>
<li>å¾ªç¯æ‰§è¡ŒæŒ‡å®šæ ˆå¸§ä¸Šæ‰€æœ‰çš„<code>open coded defer</code>å‡½æ•°ã€‚</li>
<li>è¿”å›å€¼è¡¨ç¤ºæ ˆå¸§ä¸Šæ‰€æœ‰çš„<code>open coded defer</code>å‡½æ•°æ˜¯å¦éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œå¦‚æœå› ä¸ºæŸä¸ª<code>defer</code>å‡½æ•°æ‰§è¡Œäº†<code>recover</code></li>
<li>è€Œé€ æˆå¾ªç¯ä¸­æ­¢ï¼Œåˆ™è¿”å›å€¼ä¸º<code>false</code>ã€‚</li>
<li><code>addOneOpenDeferFrame()</code>å’Œ<code>runOpenDeferFrame()</code>å‡½æ•°éƒ½ä¾èµ–ç¬¦å·è¡¨ä¸­ç›®æ ‡æ ˆå¸§çš„<code>OpenCodedDerferInfo</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// runOpenDeferFrame runs the active open-coded defers in the frame specified by
</span></span></span><span class="line"><span class="cl"><span class="c1">// d. It normally processes all active defers in the frame, but stops immediately
</span></span></span><span class="line"><span class="cl"><span class="c1">// if a defer does a successful recover. It returns true if there are no
</span></span></span><span class="line"><span class="cl"><span class="c1">// remaining defers to run in the frame.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">runOpenDeferFrame</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">d</span> <span class="o">*</span><span class="nx">_defer</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">done</span> <span class="o">:=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fd</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">fd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">deferBitsOffset</span><span class="p">,</span> <span class="nx">fd</span> <span class="o">:=</span> <span class="nf">readvarintUnsafe</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nDefers</span><span class="p">,</span> <span class="nx">fd</span> <span class="o">:=</span> <span class="nf">readvarintUnsafe</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰çš„dfä½ï¼Œè®°å½•ç€deferæ‰§è¡Œä¸å¦çš„ç›¸å…³ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">deferBits</span> <span class="o">:=</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">uint8</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">varp</span> <span class="o">-</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">deferBitsOffset</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// éå†å½“å‰å‡½æ•°æ³¨å†Œçš„deferåˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">nDefers</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// read the funcdata info for this defer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">var</span> <span class="nx">closureOffset</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">        <span class="nx">closureOffset</span><span class="p">,</span> <span class="nx">fd</span> <span class="p">=</span> <span class="nf">readvarintUnsafe</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">deferBits</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="nx">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>  <span class="c1">// å½“å‰ä½æ²¡æœ‰æ³¨å†Œdeferç›´æ¥è·³è¿‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">closure</span> <span class="o">:=</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kd">func</span><span class="p">())(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">varp</span> <span class="o">-</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">closureOffset</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">d</span><span class="p">.</span><span class="nx">fn</span> <span class="p">=</span> <span class="nx">closure</span>                      <span class="c1">// deferæ³¨å†Œçš„å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">deferBits</span> <span class="p">=</span> <span class="nx">deferBits</span> <span class="o">&amp;^</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="nx">i</span><span class="p">)</span>   <span class="c1">// æ¸…é™¤å½“å‰æ ‡è®°ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="kt">uint8</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">varp</span> <span class="o">-</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">deferBitsOffset</span><span class="p">)))</span> <span class="p">=</span> <span class="nx">deferBits</span> <span class="c1">// å›å†™ç»™å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">p</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">_panic</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Call the defer. Note that this can change d.varp if
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// the stack moves.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å†æ¬¡panicæ—¶ï¼Œç›´æ¥è·³è½¬ï¼Œå…¶ä»–æƒ…å†µç»§ç»­èµ°ä¸‹é¢æµç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">deferCallSave</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">fn</span><span class="p">)</span> <span class="c1">// è°ƒç”¨fnå‡½æ•°ï¼Œå¯èƒ½recoverä¹Ÿå¯èƒ½panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿™ç§æƒ…å†µæ˜¯åˆpanic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">p</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">aborted</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">d</span><span class="p">.</span><span class="nx">fn</span> <span class="p">=</span> <span class="kc">nil</span> <span class="c1">// å¸®åŠ©GC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¯¥panicæ˜¯å¦è¢«æ¢å¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">_panic</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">_panic</span><span class="p">.</span><span class="nx">recovered</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">done</span> <span class="p">=</span> <span class="nx">deferBits</span> <span class="o">==</span> <span class="mi">0</span> <span class="c1">// deferBits == 0 è¡¨ç¤ºopen code defersçš„deferä»¥è¿è¡Œå®Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">done</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="recovery">recovery()<a hidden class="anchor" aria-hidden="true" href="#recovery">#</a></h3>
<ol>
<li>è¯¥å‡½æ•°è´Ÿè´£ç”¨äºå­˜å‚¨åœ¨<code>sigcode0</code>å’Œ<code>sigcode1</code>ä¸­çš„<code>sp</code>å’Œ<code>pc</code>æ¢å¤<code>gp</code>çš„æ‰§è¡ŒçŠ¶æ€ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Unwind the stack after a deferred function calls recover
</span></span></span><span class="line"><span class="cl"><span class="c1">// after a panic. Then arrange to continue running as though
</span></span></span><span class="line"><span class="cl"><span class="c1">// the caller of the deferred function returned normally.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">recovery</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Info about defer passed in G struct.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sp</span> <span class="o">:=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">sigcode0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pc</span> <span class="o">:=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">sigcode1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// d&#39;s arguments need to be in the stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç¡®ä¿spä¸ä¸º0ï¼Œå¹¶åœ¨åœ¨gpçš„æ ˆä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">sp</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">sp</span> <span class="p">&lt;</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">||</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span> <span class="p">&lt;</span> <span class="nx">sp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;recover: &#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">sp</span><span class="p">),</span> <span class="s">&#34; not in [&#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span><span class="p">),</span> <span class="s">&#34;, &#34;</span><span class="p">,</span> <span class="nf">hex</span><span class="p">(</span><span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span><span class="p">),</span> <span class="s">&#34;]\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad recovery&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Make the deferproc for this d return again,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// this time returning 1. The calling function will
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// jump to the standard return epilogue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æŠŠspå’Œpcèµ‹å€¼ç»™gp.schedä¸­å¯¹åº”çš„å­—æ®µï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¹¶æŠŠè¿”å›å€¼è®¾ç½®ä¸º1ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sp</span> <span class="p">=</span> <span class="nx">sp</span>    <span class="c1">// ä¸ºè·³è½¬å‡†å¤‡ SP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">pc</span> <span class="p">=</span> <span class="nx">pc</span>    <span class="c1">// ä¸ºè·³è½¬å‡†å¤‡ PC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lr</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">ret</span> <span class="p">=</span> <span class="mi">1</span>    <span class="c1">// è®¾ç½®è¿”å›å€¼ 1,è¿™é‡Œå°±æ˜¯AX=1çš„ç”±æ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è°ƒç”¨gogo()å‡½æ•°ä¹‹åï¼Œgpçš„æ ˆæŒ‡é’ˆå’ŒæŒ‡ä»¤æŒ‡é’ˆæœºä¼šæ¢å¤åˆ°spå’Œpcçš„ä½ç½®ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è€Œè¿™ä¸ªä½ç½®æ˜¯deferproc()å‡½æ•°é€šè¿‡getcallersp()å‡½æ•°å’Œgetcallerpc()å‡½æ•°è·å¾—çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">gogo</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">)</span>     <span class="c1">// è°ƒç”¨gogoå‡½æ•°å»è·³è½¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="preprintpanics">preprintpanics()<a hidden class="anchor" aria-hidden="true" href="#preprintpanics">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Call all Error and String methods before freezing the world.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Used when crashing with panicking.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">preprintpanics</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">_panic</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// é˜²æ­¢panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">recover</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;panic while printing panic value&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">p</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// p.argæ˜¯anyç±»å‹ï¼Œæ¥è‡ªpanic(v any)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">switch</span> <span class="nx">v</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">arg</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="kt">error</span><span class="p">:</span>             <span class="c1">// å®ç°äº†erroræ¥å£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">p</span><span class="p">.</span><span class="nx">arg</span> <span class="p">=</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Error</span><span class="p">()</span>   <span class="c1">// ä¿å­˜ä¿¡æ¯ string
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="nx">stringer</span><span class="p">:</span>	<span class="c1">// å®ç°äº†stringeræ¥å£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">p</span><span class="p">.</span><span class="nx">arg</span> <span class="p">=</span> <span class="nx">v</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span>  <span class="c1">// ä¿å­˜ä¿¡æ¯ string
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">p</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">link</span>              <span class="c1">// æŒ‡å‘ä¸‹ä¸€ä¸ªpanic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="printpanics">printpanics()<a hidden class="anchor" aria-hidden="true" href="#printpanics">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Print all currently active panics. Used when crashing.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Should only be called after preprintpanics.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">printpanics</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">_panic</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">link</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// é€’å½’å›è°ƒä»æ³¨å†Œç¬¬ä¸€ä¸ªpanicå¼€å§‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">printpanics</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">link</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä¸æ˜¯goexitï¼Œæ‰“å°ç¬¦å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">link</span><span class="p">.</span><span class="nx">goexit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s">&#34;\t&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ˜¯goexitè§¦å‘ç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">goexit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s">&#34;panic: &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ‰“å°é”™è¯¯ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">printany</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">arg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœå·²ç»recoveredï¼Œåˆ™æ‰“å° [recovered]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">recovered</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34; [recovered]&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="recover">recover()<a hidden class="anchor" aria-hidden="true" href="#recover">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// The recover built-in function allows a program to manage behavior of a
</span></span></span><span class="line"><span class="cl"><span class="c1">// panicking goroutine. Executing a call to recover inside a deferred
</span></span></span><span class="line"><span class="cl"><span class="c1">// function (but not any function called by it) stops the panicking sequence
</span></span></span><span class="line"><span class="cl"><span class="c1">// by restoring normal execution and retrieves the error value passed to the
</span></span></span><span class="line"><span class="cl"><span class="c1">// call of panic. If recover is called outside the deferred function it will
</span></span></span><span class="line"><span class="cl"><span class="c1">// not stop a panicking sequence. In this case, or when the goroutine is not
</span></span></span><span class="line"><span class="cl"><span class="c1">// panicking, or if the argument supplied to panic was nil, recover returns
</span></span></span><span class="line"><span class="cl"><span class="c1">// nil. Thus the return value from recover reports whether the goroutine is
</span></span></span><span class="line"><span class="cl"><span class="c1">// panicking.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nb">recover</span><span class="p">()</span> <span class="nx">any</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="gorecover">gorecover()<a hidden class="anchor" aria-hidden="true" href="#gorecover">#</a></h3>
<ol>
<li>è¯¥å‡½æ•°å¿…é¡»åœ¨deferä¸­ä½œä¸ºä¸€éƒ¨åˆ†è¢«ä½¿ç”¨ã€‚</li>
<li>è¯¥å‡½æ•°ä¸»è¦ä½œç”¨æ˜¯è®¾ç½® <code>painc</code> çš„ <code>recovered</code> è¡¨ç¤ºå·²è¢«æ¢å¤ã€‚</li>
<li>è¢«æ¢å¤çš„<code>panic</code>ä¼šè·³è½¬åˆ°æ¢å¤çš„<code>defer</code>æ³¨å†Œä¸‹ä¸€è¡ŒæŒ‡ä»¤å¤„é€šè¿‡<code>if</code>æ¡ä»¶è·³è½¬åˆ°<code>deferreturn</code>å‡½æ•°å¤„å»æ‰§è¡Œå‰©ä½™çš„<code>defer</code>ã€‚</li>
<li><code>gopanic()</code>å‡½æ•°çš„ä¸»è¦é€»è¾‘ï¼Œå…¶ä¸­<code>for</code>å¾ªç¯æ¯è°ƒç”¨å®Œä¸€ä¸ª<code>defer</code>å‡½æ•°éƒ½ä¼šæ£€æŸ¥<code>p.recovered</code>å­—æ®µï¼Œå¦‚æœå€¼ä¸ºtrueå°±æ‰§è¡Œ</li>
<li><code>recover</code>é€»è¾‘ã€‚ä¹Ÿå°±æ˜¯è¯´çœŸæ­£çš„<code>recover</code>é€»è¾‘æ˜¯åœ¨<code>gopanic()</code>å‡½æ•°ä¸­å®ç°çš„ï¼Œ<code>defer</code>å‡½æ•°ä¸­è°ƒç”¨äº†å†…ç½®å‡½æ•°<code>recover()</code>ï¼Œ</li>
<li>å®é™…ä¸Šåªä¼šè®¾ç½®<code>_panic</code>çš„ä¸€ç§çŠ¶æ€ã€‚å†…ç½®å‡½æ•°<code>recover()</code>å¯¹åº”<code>runtime</code>ä¸­<code>gorecover()</code>å‡½æ•°ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// The implementation of the predeclared function recover.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Cannot split the stack because it needs to reliably
</span></span></span><span class="line"><span class="cl"><span class="c1">// find the stack segment of its caller.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// TODO(rsc): Once we commit to CopyStackAlways,
</span></span></span><span class="line"><span class="cl"><span class="c1">// this doesn&#39;t need to be nosplit.
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">gorecover</span><span class="p">(</span><span class="nx">argp</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="nx">any</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// argp å‚æ•°æ ¹æ®AXå¯„å­˜å™¨ä¼ é€’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 	1. è¯¥å‚æ•°æ˜¯æ¥è‡ªè°ƒç”¨å½“å‰deferå‡½æ•°çš„è°ƒç”¨è€…SPæ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 	2. å› æ­¤é¡¶å±‚çš„deferèƒ½æ•è·ä¸‹å±‚çš„panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// Must be in a function running as part of a deferred call during the panic.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Must be called from the topmost function of the call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// (the function used in the defer statement).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// p.argp is the argument pointer of that topmost deferred function call.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Compare against argp reported by caller.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// If they match, the caller is the one who can recover.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¿…é¡»åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œè¯¥å‡½æ•°ä½œä¸º panic æœŸé—´ defer è°ƒç”¨çš„ä¸€éƒ¨åˆ†è¿è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¿…é¡»ä»è°ƒç”¨çš„æœ€é¡¶å±‚å‡½æ•°è°ƒç”¨ (åœ¨deferè¯­å¥ä¸­ä½¿ç”¨çš„å‡½æ•°)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// p.argp æ˜¯æœ€ä¸Šé¢é‚£ä¸ª defer å‡½æ•°è°ƒç”¨çš„å®å‚æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸è°ƒç”¨è€…æŠ¥å‘Šçš„ argp è¿›è¡Œæ¯”è¾ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœå®ƒä»¬åŒ¹é…ï¼Œè°ƒç”¨æ–¹å°±å¯ä»¥æ¢å¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>    <span class="c1">// è·å–å½“å‰æ­£åœ¨æ‰§è¡Œçš„g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">p</span> <span class="o">:=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span>  <span class="c1">// æœ€æ–°æ³¨å†Œçš„panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// p != nilï¼šå­˜åœ¨æ³¨å†Œçš„panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// !p.goexitï¼šä¸æ˜¯goexitå‡½æ•°è§¦å‘çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// !p.recoveredï¼šè¯¥panicæ²¡æœ‰è¢«æ¢å¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// argp == uintptr(p.argp)ï¼šå¿…é¡»åœ¨deferå‡½æ•°ä¸­ç›´æ¥è°ƒç”¨recoverå‡½æ•°æ‰æœ‰ç”¨ï¼Œä¸å¯åµŒå¥—åœ¨å…¶ä»–å‡½æ•°ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    1. p.argpï¼šå­˜å‚¨çš„æ˜¯è°ƒç”¨panicçš„è°ƒç”¨è€…æ ˆSPä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">p</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">goexit</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">recovered</span> <span class="o">&amp;&amp;</span> <span class="nx">argp</span> <span class="o">==</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">argp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">p</span><span class="p">.</span><span class="nx">recovered</span> <span class="p">=</span> <span class="kc">true</span>  <span class="c1">// æ ‡è¯†å½“å‰è¿™ä¸ªpanicä»å¼‚å¸¸æˆ–é”™è¯¯åœºæ™¯ä¸­æ¢å¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">arg</span>        <span class="c1">// è¯¥å‚æ•°æ˜¯panic(v any)ä¼ é€’çš„ç©ºæ¥å£å‚æ•°ï¼Œç›´æ¥è¿”å›ç»™recoverå‡½æ•°è°ƒç”¨è€…å³å¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="7">
<li>å†…ç½®å‡½æ•°<code>recover()</code>æ˜¯æ²¡æœ‰å‚æ•°çš„ï¼Œä½†æ˜¯<code>gorecover()</code>å‡½æ•°å´æœ‰ä¸€ä¸ªå‚æ•°<code>argp</code>ï¼Œè¿™ä¹Ÿæ˜¯ç¼–è¯‘å™¨åšçš„æ‰‹è„šã€‚</li>
<li>ç¼–è¯‘å™¨ä¼šæŠŠè°ƒç”¨è€…çš„<code>args from caller</code>åŒºé—´çš„èµ·å§‹åœ°å€ä½œä¸ºå‚æ•°ä¼ é€’ç»™<code>gorecover()</code>å‡½æ•°ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">fn</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">recover</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nb">println</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="9">
<li>ç»ç¼–è¯‘è½¬æ¢åçš„ç­‰ä»·ä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">fn</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">gorecover</span><span class="p">(</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">a</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="nb">println</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="10">
<li>ä¸ºä»€ä¹ˆè¦ä¼ é€’è¿™ä¸ª<code>argp</code>å‚æ•°å‘¢ï¼Ÿ
<ul>
<li>ä»ä»£ç é€»è¾‘æ¥çœ‹ï¼Œ<code>gorecover()</code>å‡½æ•°ä¼šæŠŠå®ƒè·Ÿå½“å‰<code>_panic</code>å¯¹è±¡<code>p</code>çš„<code>argp</code>å­—æ®µæ¯”è¾ƒï¼Œåªæœ‰ç›¸ç­‰æ—¶æ‰ä¼šæŠŠ<code>p.recovered</code>è®¾ç½®ä¸ºtrueã€‚</li>
</ul>
</li>
<li>ä»å‚æ•°é€»è¾‘ä¸Šçœ‹<code>argp == uintptr(p.argp)</code>æ˜¯ä¸ç›¸ç­‰çš„ï¼Œç¼–è¯‘å™¨ä¼šåœ¨è°ƒç”¨<code>fn()</code>å‡½æ•°ä¸­æ’å…¥ä»¥ä¸‹ä»£ç é€»è¾‘æ¥ä¿®æ­£<code>argp</code>çš„å€¼ã€‚</li>
<li>å¦‚æœ<code>gp._panic</code>ä¸ä¸º<code>nil</code>ä¸”<code>gp._panic.argp</code>çš„å€¼ç­‰äºå½“å‰å‡½æ•°æ ˆå¸§<code>args from caller</code>åŒºé—´çš„èµ·å§‹åœ°å€ï¼Œå°±æŠŠå®ƒçš„å€¼æ”¹æˆå½“å‰</li>
<li>å‡½æ•°æ ˆå¸§<code>args to callee</code>åŒºé—´çš„èµ·å§‹åœ°å€ã€‚ä¸ç¼–è¯‘å™¨æ’å…¥çš„è¿™äº›æŒ‡ä»¤ç­‰ä»·çš„<code>Go</code>ä»£ç å¦‚ä¸‹ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">gp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿™ä¸€æ¡é™åˆ¶åªæ˜¯é™åˆ¶äº†recover()å¿…é¡»åœ¨deferå‡½æ•°ä¸­ã€ç›´æ¥è°ƒç”¨ã€‘æ‰èµ·ä½œç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span><span class="p">.</span><span class="nx">argp</span> <span class="o">==</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">argtype</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span><span class="p">.</span><span class="nx">_panic</span><span class="p">.</span><span class="nx">argp</span> <span class="p">=</span> <span class="nf">getargp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="14">
<li><code>Go</code>è¯­è¨€å¯¹<code>recover</code>å¼ºåŠ çš„ä¸€æ¡é™åˆ¶ï¼š<strong>å¿…é¡»åœ¨deferå‡½æ•°ä¸­ç›´æ¥è°ƒç”¨recover()å‡½æ•°æ‰æœ‰ç”¨ï¼Œä¸å¯åµŒå¥—åœ¨å…¶ä»–å‡½æ•°ä¸­</strong>ã€‚</li>
<li><code>recover()</code>å‡½æ•°è°ƒç”¨æœ‰æ•ˆçš„ç¤ºä¾‹ä»£ç ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">fn</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">recover</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="16">
<li><code>recover()</code>å‡½æ•°è°ƒç”¨æ— æ•ˆçš„ç¤ºä¾‹ä»£ç ï¼š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">fn</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">r</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">r</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">recover</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="17">
<li><code>Go</code>è¯­è¨€çš„<code>recover</code>ä¸å…¶ä»–è¯­è¨€çš„<code>try</code>å’Œ<code>catch</code>æœ‰æ˜æ˜¾çš„ä¸åŒï¼Œå³ä¸åƒ<code>catch</code>è¯­å¥é‚£æ ·èƒ½å¤Ÿé™å®šå¼‚å¸¸çš„ç±»å‹ã€‚</li>
<li>å¦‚æœæ²¡æœ‰å¯¹<code>recover</code>çš„è¿™ç§é™åˆ¶ï¼Œå°±ä¼šä½¿ä»£ç è¡Œä¸ºå˜å¾—ä¸å¯æ§ï¼Œ<code>panic</code>å¯èƒ½ç»å¸¸ä¼šè¢«æŸä¸ªæ·±åº¦åµŒå¥—çš„<code>recover</code>æ¢å¤ï¼Œç„¶è€Œè¿™å¹¶ä¸æ˜¯å¼€å‘è€…æƒ³è¦çš„ã€‚</li>
</ol>
<h2 id="panicæ±‡ç¼–">panic()æ±‡ç¼–<a hidden class="anchor" aria-hidden="true" href="#panicæ±‡ç¼–">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;111111&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.main</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">g</span><span class="err">/</span><span class="no">hello1</span><span class="err">/</span><span class="no">hello.go</span>
</span></span><span class="line"><span class="cl">    <span class="nl">hello.go:</span><span class="err">3</span>  <span class="err">0</span><span class="nf">x45b4a0</span>    <span class="mi">493</span><span class="no">b6610</span>        <span class="no">cmp</span> <span class="no">rsp</span><span class="p">,</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">r14</span><span class="err">+</span><span class="mi">0x10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nl">hello.go:</span><span class="err">3</span>  <span class="err">0</span><span class="nf">x45b4a4</span>    <span class="mi">7622</span>            <span class="no">jbe</span> <span class="mi">0x45b4c8</span>
</span></span><span class="line"><span class="cl">    <span class="nl">hello.go:</span><span class="err">3</span>  <span class="err">0</span><span class="nf">x45b4a6</span>    <span class="mi">4883</span><span class="no">ec18</span>        <span class="no">sub</span> <span class="no">rsp</span><span class="p">,</span> <span class="mi">0x18</span>
</span></span><span class="line"><span class="cl">    <span class="nl">hello.go:</span><span class="err">3</span>  <span class="err">0</span><span class="nf">x45b4aa</span>    <span class="mi">48896</span><span class="no">c2410</span>      <span class="no">mov</span> <span class="no">qword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">0x10</span><span class="p">],</span> <span class="no">rbp</span>
</span></span><span class="line"><span class="cl">    <span class="nl">hello.go:</span><span class="err">3</span>  <span class="err">0</span><span class="nf">x45b4af</span>    <span class="mi">488</span><span class="no">d6c2410</span>      <span class="no">lea</span> <span class="no">rbp</span><span class="p">,</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rsp</span><span class="err">+</span><span class="mi">0x10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å‡†å¤‡ç©ºæ¥å£å‚æ•° AX=rip+0x4c65  etype.type *typeç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">4</span>  <span class="err">0</span><span class="nf">x45b4b4</span>    <span class="mi">488</span><span class="no">d05654c0000</span>  <span class="no">lea</span> <span class="no">rax</span><span class="p">,</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span><span class="err">+</span><span class="mi">0x4c65</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># å‡†å¤‡ç©ºæ¥å£å‚æ•° BX=rip+0x1463e etype.data uintptrç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">4</span>  <span class="err">0</span><span class="nf">x45b4bb</span>    <span class="mi">488</span><span class="no">d1d3e460100</span>  <span class="no">lea</span> <span class="no">rbx</span><span class="p">,</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">rip</span><span class="err">+</span><span class="mi">0x1463e</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># gopanicæ ‡è¯†panicå¼€å§‹ï¼ŒAXå’ŒBXå¯„å­˜å™¨å­˜å‚¨çš„æ˜¯è¦ä¼ é€’çš„æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nl">hello.go:</span><span class="err">4</span>  <span class="err">0</span><span class="nf">x45b4c2</span>    <span class="no">e8d946fdff</span>      <span class="no">call</span> <span class="no">$runtime.gopanic</span>
</span></span><span class="line"><span class="cl">    <span class="nl">hello.go:</span><span class="err">4</span>  <span class="err">0</span><span class="nf">x45b4c7</span>    <span class="mi">90</span>              <span class="no">nop</span>
</span></span><span class="line"><span class="cl">    <span class="nl">hello.go:</span><span class="err">3</span>  <span class="err">0</span><span class="nf">x45b4c8</span>    <span class="no">e893cdffff</span>      <span class="no">call</span> <span class="no">$runtime.morestack_noctxt</span>
</span></span><span class="line"><span class="cl">    <span class="err">.:0</span>         <span class="err">0</span><span class="nf">x45b4cd</span>    <span class="no">ebd1</span>            <span class="no">jmp</span> <span class="no">$main.main</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://heliu.site/tags/golang/">Golang</a></li>
      <li><a href="https://heliu.site/tags/%E5%87%BD%E6%95%B0/">å‡½æ•°</a></li>
      <li><a href="https://heliu.site/tags/panic/">Panic</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://heliu.site/posts/golang/func/defer-theory/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>defer(åŸç†)</span>
  </a>
  <a class="next" href="https://heliu.site/posts/golang/interface/use/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>æ¥å£(ä½¿ç”¨)</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
    </span>
    <span id="busuanzi_container_site_uv">
        æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
    </span>
    </div>
        <span>Copyright Â© 2024 èœ€ICPå¤‡2024091074å· <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
