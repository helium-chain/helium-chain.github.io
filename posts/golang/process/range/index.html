<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>æµç¨‹æ§åˆ¶(rangeè¿­ä»£) | Helium</title>
<meta name="keywords" content="golang, æµç¨‹æ§åˆ¶">
<meta name="description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬">
<meta name="author" content="helium">
<link rel="canonical" href="https://heliu.site/posts/golang/process/range/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://heliu.site/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://heliu.site/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://heliu.site/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://heliu.site/apple-touch-icon.png">
<link rel="mask-icon" href="https://heliu.site/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://heliu.site/posts/golang/process/range/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="æµç¨‹æ§åˆ¶(rangeè¿­ä»£)" />
<meta property="og:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://heliu.site/posts/golang/process/range/" />
<meta property="og:image" content="https://heliu.site/favicon-32x32.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-10-05T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-07-20T00:00:00+00:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://heliu.site/favicon-32x32.png" />
<meta name="twitter:title" content="æµç¨‹æ§åˆ¶(rangeè¿­ä»£)"/>
<meta name="twitter:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://heliu.site/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Golang",
      "item": "https://heliu.site/posts/golang/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ç¬¬3ç«  æµç¨‹æ§åˆ¶",
      "item": "https://heliu.site/posts/golang/process/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "æµç¨‹æ§åˆ¶(rangeè¿­ä»£)",
      "item": "https://heliu.site/posts/golang/process/range/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "æµç¨‹æ§åˆ¶(rangeè¿­ä»£)",
  "name": "æµç¨‹æ§åˆ¶(rangeè¿­ä»£)",
  "description": "ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18+ç‰ˆæœ¬",
  "keywords": [
    "golang", "æµç¨‹æ§åˆ¶"
  ],
  "articleBody": "è¿­ä»£string rangeè¿­ä»£stringï¼Œkeyä¸ºintç±»å‹ï¼Œvalueä¸ºruneç±»å‹ã€‚ 1 2 3 4 5 str := \"hello world! Gopher\" for i, v := range str { // ã€int, runeã€‘ fmt.Println(i, v) // original body } ä¸Šé¢è¿­ä»£å­—ç¬¦ä¸²ä»£ç ç­‰æ•ˆäºä¸‹é¢ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 // 1) è·å–å­—ç¬¦ä¸²é•¿åº¦ // å­—ç¬¦ä¸²æ€»é•¿åº¦ï¼Œè¯¥é•¿åº¦æ˜¯å­—èŠ‚æ•°é‡ç”¨äºéå†å­—ç¬¦ä¸²çš„æ€»é•¿åº¦ lenTemp := len(str) // ä¸‹ä¸€æ¬¡éå†çš„ä¸‹æ ‡ä½ç½®ï¼Œè¿™æ˜¯ç”±äºutf8æ˜¯ä¸å®šé•¿ç¼–ç éœ€è¦è®°å½•ä¸Šä¸€æ¬¡å¤„ç†åçš„ä½ç½® var nextIndexTemp int\t// 2) key/value // æ³¨æ„ï¼šè¿™é‡Œçš„keyå’Œvalueï¼Œå®šä¹‰åœ¨forå¤–ï¼Œä¹Ÿæ˜¯\u0026iå’Œ\u0026væ˜¯å›ºå®šçš„åŸå›  var i int // éå†ç”¨åˆ°çš„ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯index var v rune // éå†å‡ºæ¥å­˜å‚¨çš„å€¼ï¼Œä¹Ÿå°±æ˜¯value // éå†å­—ç¬¦ä¸² for indexTemp := 0; indexTemp \u003c lenTemp; indexTemp = nextIndexTemp { // è·å–å¼€å¤´8bitçš„å¤§å°ï¼Œå› ä¸ºè¯¥8bitèƒ½åŒºåˆ†å­˜å‚¨çš„æ˜¯ASCII 1bitè¿˜æ˜¯å¤šä¸ªä½¿ç”¨utf8ç¼–ç çš„å­—èŠ‚ valueTemp := rune(str[indexTemp])\t// utf8.RuneSelf = 0x80 = 128 å•å­—ç¬¦æœ€å¤§å€¼ // ASCIIç å­—ç¬¦å 1å­—èŠ‚ï¼Œè¯¥æ¡ä»¶æ»¡è¶³è¯´æ˜ï¼Œå­˜å‚¨çš„æ˜¯ASCIIç å ç”¨ä¸€ä¸ªå­—èŠ‚ if valueTemp \u003c utf8.RuneSelf {\tnextIndexTemp = indexTemp + 1 } else { // è¯¥æ¡ä»¶æ»¡è¶³è¯´æ˜æ˜¯ä½¿ç”¨utf8ç¼–ç çš„å¤šä¸ªå­—èŠ‚å ç”¨ï¼Œ // ä½¿ç”¨decoderuneè·å–è¯¥Unicodeå€¼å’Œåœ¨Utf8ä¸­ç¼–ç å ç”¨çš„å­—èŠ‚å¤§å°æ•°ç›® // decoderuneè§£ç å­—ç¬¦ä¸²strä»indexTempä½ç½®å¼€å§‹ï¼Œå…·ä½“æ–¹æ³•åœ¨runtime/utf8.goæ–‡ä»¶ä¸­ // è¯¥å‡½æ•°ä¸utf8ç¼–ç ç›¸å…³ // valueTempè§£æçš„runeï¼ŒnextIndexTempå½“å‰çš„indexTemp+è§£æçš„runeçš„é•¿åº¦ valueTemp, nextIndexTemp = decoderune(str, indexTemp)\t} // 3) æ‹·è´èµ‹å€¼ // æ³¨æ„ï¼šè¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆfor rangeä¸­å–\u0026iå’Œ\u0026våœ°å€æ˜¯å›ºå®šçš„åŸå›  i = indexTemp // å½“å‰è·å–åˆ°çš„ç´¢å¼• v = valueTemp // å½“å‰è·å–åˆ°çš„å­—ç¬¦ fmt.Println(i, v) // original body } decoderune()ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 // runtime/utf8.go æ–‡ä»¶ä¸­decoderuneæ–¹æ³• // decoderune returns the non-ASCII rune at the start of // s[k:] and the index after the rune in s. // // decoderune assumes that caller has checked that // the to be decoded rune is a non-ASCII rune. // // If the string appears to be incomplete or decoding problems // are encountered (runeerror, k + 1) is returned to ensure // progress when decoderune is used to iterate over a string. func decoderune(s string, k int) (r rune, pos int) { pos = k // è§£æå¼€å§‹ä½ç½® if k \u003e= len(s) { // å·²ç»åˆ°å­—ç¬¦ä¸²çš„æœ€å¤§é•¿åº¦äº† return runeError, k + 1 } s = s[k:] // ä»kä½ç½®åˆ†å‰²å­—ç¬¦ä¸² switch { // [t2, t3) --\u003e [11000000, 11100000) case t2 \u003c= s[0] \u0026\u0026 s[0] \u003c t3: // è¯¥å­—æ®µ2å­—èŠ‚ç¼–ç  // 0080-07FF two byte sequence // [locb, hicb] æ˜¯ç¬¬äºŒä¸ªå­—èŠ‚çš„èŒƒå›´å¤§å° [10000000, 10111111] if len(s) \u003e 1 \u0026\u0026 (locb \u003c= s[1] \u0026\u0026 s[1] \u003c= hicb) { // ä»ç¼–ç ä¸­å–å‡ºç¼–ç çš„æ•°æ®ç»„æˆrune // mask2 = 00011111ï¼Œmaskx = 00111111 r = rune(s[0]\u0026mask2)\u003c\u003c6 | rune(s[1]\u0026maskx) pos += 2 if rune1Max \u003c r { return } } // [t3, t4) --\u003e [11100000, 11110000) case t3 \u003c= s[0] \u0026\u0026 s[0] \u003c t4: // è¯¥å­—æ®µ3å­—èŠ‚ç¼–ç  // 0800-FFFF three byte sequence if len(s) \u003e 2 \u0026\u0026 (locb \u003c= s[1] \u0026\u0026 s[1] \u003c= hicb) \u0026\u0026 (locb \u003c= s[2] \u0026\u0026 s[2] \u003c= hicb) { r = rune(s[0]\u0026mask3)\u003c\u003c12 | rune(s[1]\u0026maskx)\u003c\u003c6 | rune(s[2]\u0026maskx) pos += 3 if rune2Max \u003c r \u0026\u0026 !(surrogateMin \u003c= r \u0026\u0026 r \u003c= surrogateMax) { return } } // [t4, t5) --\u003e [11110000, 11111000) case t4 \u003c= s[0] \u0026\u0026 s[0] \u003c t5: // è¯¥å­—æ®µ4å­—èŠ‚ç¼–ç  // 10000-1FFFFF four byte sequence if len(s) \u003e 3 \u0026\u0026 (locb \u003c= s[1] \u0026\u0026 s[1] \u003c= hicb) \u0026\u0026 (locb \u003c= s[2] \u0026\u0026 s[2] \u003c= hicb) \u0026\u0026 (locb \u003c= s[3] \u0026\u0026 s[3] \u003c= hicb) { r = rune(s[0]\u0026mask4)\u003c\u003c18 | rune(s[1]\u0026maskx)\u003c\u003c12 | rune(s[2]\u0026maskx)\u003c\u003c6 | rune(s[3]\u0026maskx) pos += 4 if rune3Max \u003c r \u0026\u0026 r \u003c= maxRune { return } } } return runeError, k + 1 } for-rangeä¸èƒ½éå†*stringç±»å‹ã€‚ for-rangeå¯¹äºå­—ç¬¦ä¸²å¹¶æ²¡æœ‰å¤åˆ¶ä¸€ä»½å­—ç¬¦ä¸²è¿›è¡Œç¼–ç ï¼Œå…¶å®ä¹Ÿä¸å¿…è¦å› ä¸ºå­—ç¬¦ä¸²çš„è¯­ä¹‰æœ¬æ¥å°±æ˜¯ä¸å¯å˜æ•°æ®ã€‚ è¿­ä»£array rangeè¿­ä»£arrayï¼Œkeyä¸ºintç±»å‹ï¼Œvalueä¸ºæ•°ç»„çš„å…ƒç´ ç±»å‹ã€‚ 1 2 3 4 5 arr := [5]int{0,1,2,3,4} for i, v := range arr { // ã€int, intã€‘ fmt.Println(i, v) // original body } ä¸Šé¢è¿­ä»£æ•°ç»„ä»£ç ç­‰æ•ˆäºä¸‹é¢ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // 1) è·å–æ•°ç»„é•¿åº¦ // æ³¨æ„ï¼šè¿™é‡Œæ”¯æŒæŒ‡é’ˆæ•°ç»„ï¼Œæ¯”å¦‚len(*[2]int) == 2 lenTemp := len(arr) // 2) æ‹·è´æ•°ç»„ // æ³¨æ„ï¼šè¿™é‡Œæ”¯æŒæŒ‡é’ˆæ•°ç»„ï¼Œæ¯”å¦‚arræ˜¯*[2]int // è¿™é‡Œä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä½¿ç”¨æ•°ç»„æŒ‡é’ˆå’Œæ•°ç»„æœ¬èº«çš„æ€§èƒ½å·®å¼‚ï¼Œ // ä½¿ç”¨æ•°ç»„æŒ‡é’ˆè¿™é‡Œçš„èµ‹å€¼æ˜¯æŒ‡é’ˆèµ‹å€¼ï¼Œè€Œä½¿ç”¨æ•°ç»„è¿™é‡Œæ˜¯å€¼å¤åˆ¶å½“æ•°æ®é‡å¤§æ—¶æ€§èƒ½å·®åˆ«è¿˜æ˜¯æ¯”è¾ƒæ˜æ˜¾ rangeArr := arr // å¤åˆ¶ä¸€ä»½éœ€è¦éå†çš„æ•°ç»„ï¼Œæ³¨æ„è¿™é‡Œçš„å‰¯æœ¬æ˜¯ä¸åŸæ•°ç»„æ²¡æœ‰ä»»ä½•è”ç³» // 3) key/value // æ³¨æ„ï¼šè¿™é‡Œçš„keyå’Œvalueï¼Œå®šä¹‰åœ¨forå¤–ï¼Œä¹Ÿæ˜¯\u0026iå’Œ\u0026væ˜¯å›ºå®šçš„åŸå›  var i, v int // å®šä¹‰éå†éœ€è¦æ¥æ”¶çš„keyå’Œvalueå˜é‡ // for rangeçš„ç¼–è¯‘ç­‰åŒä»£ç  for indexTemp := 0; indexTemp \u003c lenTemp; indexTemp++ { // æ³¨æ„ï¼šè¿™é‡Œæ”¯æŒæŒ‡é’ˆæ•°ç»„èµ‹å€¼ valueTemp := rangeArr[indexTemp] // æ•°ç»„æ”¯æŒè¯­æ³•ç³– // 4) æ‹·è´èµ‹å€¼ // æ³¨æ„ï¼šè¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆfor rangeä¸­å–\u0026iå’Œ\u0026våœ°å€æ˜¯å›ºå®šçš„åŸå›  i = indexTemp // æ‹·è´èµ‹å€¼ v = valueTemp // æ‹·è´èµ‹å€¼ fmt.Println(i, v) // original body } æ•°ç»„éå†å’Œåˆ‡ç‰‡éå†æœ€ä¸»è¦çš„åŒºåˆ«å°±æ˜¯éå†å‰¯æœ¬ï¼Œæ•°ç»„çš„å‰¯æœ¬ä¸åŸæ•°ç»„æ²¡æœ‰ä»»ä½•å…³è”åªæ˜¯å€¼å…¨éƒ¨ç›¸åŒè€Œå·²ï¼Œè€Œåˆ‡ç‰‡åˆ™æ˜¯å‰¯æœ¬å’ŒåŸåˆ‡ç‰‡æ•°å…±ç”¨åŒä¸€ä¸ªåº•å±‚æ•°ç»„ã€‚ rangeèƒ½éå†ã€æ•°ç»„æŒ‡é’ˆã€‘è€Œã€ä¸èƒ½ã€‘éå†åˆ‡ç‰‡æŒ‡é’ˆï¼Œè¿™å¾—ç›Šäºæ•°å€¼æŒ‡é’ˆåœ¨èµ‹å€¼å’Œlen()å‡½æ•°ä¸ŠGoæ”¯æŒçš„ã€è¯­æ³•ç³–ã€‘è½¬æ¢ä½¿å¾—rangeå¯¹æ•°ç»„æŒ‡é’ˆåŒæ ·é€‚ç”¨ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 // rangeéå†æŒ‡é’ˆæ•°ç»„æ—¶ï¼Œä¼šè§£å¼•ç”¨æ•°ç»„æŒ‡é’ˆæ‹·è´å‰¯æœ¬éå† package main import \"fmt\" func main() { var aa *[2]string = new([2]string) // 1) è¯­æ³•ç³–1ï¼šèµ‹å€¼ //(*aa)[0] = \"a\" aa[0] = \"a\" // è¯­æ³•ç³– //(*aa)[1] = \"bb\" aa[1] = \"bb\"// è¯­æ³•ç³– // 2) è¯­æ³•ç³–2ï¼šå–å€¼ // c := (*aa)[1] c := aa[1] // è¯­æ³•ç³– // 3) è¯­æ³•ç³–3ï¼šæ±‚é•¿åº¦ // l := len(aa) // len(*aa) // åœ¨Goä¸­æ”¯æŒæ•°ç»„çš„æŒ‡é’ˆç›¸å…³çš„è¯­æ³•ç³–ï¼Œæ‰€ä»¥å¯¼è‡´ä½¿ç”¨æ•°ç»„å’Œæ•°ç»„æŒ‡é’ˆå¥½åƒå¹¶æ²¡æœ‰å¤šå¤§çš„åŒºåˆ« // æ¯”å¦‚æ•°ç»„æŒ‡é’ˆaaèƒ½ä½¿ç”¨aa[0] = \"a\"è¿™ç§å½¢å¼èµ‹å€¼ï¼Œä¹Ÿèƒ½ä½¿ç”¨len(aa)è¿™ç§å½¢å¼æ±‚é•¿åº¦ï¼Œ // å…¶ä»–ç±»å‹çš„æŒ‡é’ˆåˆ™ä¸æ”¯æŒ // è¿™äº›è¯­æ³•ç³–ä¹Ÿå¯¼è‡´äº†èƒ½ä½¿ç”¨rangeéå†æ•°ç»„æŒ‡é’ˆ // range æ‹·è´ *aa å‰¯æœ¬éå† for i, s := range aa { // å½“æ•°ç»„å¾ˆå¤§æ—¶ï¼Œéå†æ•°ç»„æŒ‡é’ˆæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹© if i == 0 { aa[1] = \"cc\" } fmt.Println(i, s) } fmt.Println(aa) // Output: // 0 a // 1 cc // \u0026[a cc] } éªŒè¯æ•°ç»„éå†æ˜¯å€¼æ‹·è´ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 {\tslice1 := [4]int{0,1,2,3} // è¿™é‡Œæ‹·è´çš„æ˜¯æ•°ç»„çš„å‰¯æœ¬ï¼Œå› æ­¤ifæ¡ä»¶æˆç«‹ä¸ä¼šå½±å“å€¼ for i, v := range slice1 { // [4]int if i == 1 { slice1[3] += 10 } fmt.Println(i, v) } fmt.Println(slice1) // Output: // 0 0 // 1 1 // 2 2 // 3 3 // [0 1 2 13] } { slice1 := [4]int{0,1,2,3} // è¿™é‡Œæ‹·è´çš„æ˜¯æ•°ç»„çš„æŒ‡é’ˆï¼Œå› æ­¤ifæ¡ä»¶æˆç«‹ä¼šå½±å“å€¼ for i, v := range \u0026slice1 { // *[4]int if i == 1 { slice1[3] += 10 } fmt.Println(i, v) } // Output: // 0 0 // 1 1 // 2 2 // 3 13 } è¿­ä»£slice éå†sliceå‰ä¼šå…ˆè·å–sliceçš„é•¿åº¦lenTempæ¥ä½œä¸ºå¾ªç¯æ¬¡æ•°ï¼Œå¾ªç¯ä½“ä¸­ï¼Œæ¯æ¬¡å¾ªç¯ä¼šå…ˆè·å–å…ƒç´ å€¼ã€‚ å¦‚æœfor-rangeä¸­æ¥æ”¶indexå’Œvalueçš„è¯ï¼Œåˆ™ä¼šå¯¹indexå’Œvalueè¿›è¡Œä¸€æ¬¡èµ‹å€¼ã€‚ æ•°ç»„ä¸æ•°ç»„æŒ‡é’ˆçš„éå†è¿‡ç¨‹ä¸sliceåŸºæœ¬ä¸€è‡´ï¼Œä½†æ˜¯ä¹Ÿæœ‰åŒºåˆ«ï¼ŒåŒºåˆ«åœ¨äºå‰¯æœ¬å¤åˆ¶çš„æ˜¯ä¸åŸæ•°ç»„æ˜¯ä¸€ä¸ªå®Œå…¨ä¸ç›¸å¹²çš„æ•°ç»„ã€‚ for-rangeè¿­ä»£sliceï¼Œkeyä¸ºintï¼Œvalueä¸ºå­˜å‚¨çš„å…ƒç´ ç±»å‹ã€‚ 1 2 3 4 5 slice1 := []int{0,1,2,3} for i, v := range slice1 { // ã€int, intã€‘ fmt.Println(i, v) // original body } ä¸Šé¢è¿­ä»£åˆ‡ç‰‡ä»£ç ç­‰æ•ˆäºä¸‹é¢ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // 1) æ‹·è´åˆ‡ç‰‡ // æ³¨æ„ï¼šæ‹·è´çš„åˆ‡ç‰‡ä¸åŸåˆ‡ç‰‡å…±ç”¨äº†åŒä¸€ä¸ªåº•å±‚æ•°ç»„ // ä¹Ÿéœ€è¦æ³¨æ„ï¼Œlenå’Œcapä¹Ÿæ‹·è´å…ƒåˆ‡ç‰‡çš„å€¼ï¼Œå› æ­¤for rangeä¿®æ”¹ä¸èµ·ä½œç”¨ï¼Œ rangeSlice := slice1 // 2) è·å–åˆ‡ç‰‡é•¿åº¦ï¼Œä¹Ÿæ˜¯éå†çš„æ¬¡æ•° // éå†çš„æ­¤æ—¶åˆ‡ç‰‡é•¿åº¦æ˜¯å›ºå®šçš„ lenTemp := len(rangeSlice) // æ‹¿åˆ°éœ€è¦éå†çš„åˆ‡ç‰‡æ€»é•¿åº¦ // 3) key/value // æ³¨æ„ï¼šè¿™é‡Œçš„keyå’Œvalueï¼Œå®šä¹‰åœ¨forå¤–ï¼Œä¹Ÿæ˜¯\u0026iå’Œ\u0026væ˜¯å›ºå®šçš„åŸå›  var i, v int // å®šä¹‰éå†éœ€è¦çš„keyå’Œvalueå˜é‡ // for rangeçš„ç¼–è¯‘ç­‰åŒä»£ç  for indexTemp := 0; indexTemp \u003c lenTemp; indexTemp++ { valueTemp := rangeSlice[indexTemp] // 4) æ‹·è´èµ‹å€¼ // æ³¨æ„ï¼šè¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆfor rangeä¸­å–\u0026iå’Œ\u0026våœ°å€æ˜¯å›ºå®šçš„åŸå›  i = indexTemp v = valueTemp fmt.Println(i, v) // original body } ç”±äºå¾ªç¯å¼€å§‹å‰å¾ªç¯æ¬¡æ•°å°±å·²ç»ç¡®å®šäº†ï¼Œæ‰€ä»¥å¾ªç¯è¿‡ç¨‹ä¸­æ–°æ·»åŠ çš„å…ƒç´ æ˜¯æ— æ³•éå†åˆ°çš„ã€‚ ä½†æ˜¯å¾ªç¯è¿‡ç¨‹ä¸­ä¿®æ”¹åé¢è¿˜æœªå¾ªç¯çš„å€¼ï¼Œåˆ™ä¼šå½±å“ï¼Œè¿™æ˜¯ç”±äºåœ¨rangeå¾ªç¯å‰èµ‹å€¼çš„å‰¯æœ¬ä¸åŸåˆ‡ç‰‡å…±ç”¨äº†ä¸€ä¸ªåº•å±‚æ•°ç»„å¯¼è‡´çš„ï¼Œæ‰€ä»¥èƒ½ç›¸äº’å½±å“ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 { slice1 := []int{0,1,2,3} for i, v := range slice1 { // ã€int, intã€‘ if i == 1 { slice1[3] += 10 } fmt.Println(i, v) } // Output: // 0 0 // 1 1 // 2 2 // 3 13 } è¿­ä»£channel channeléå†æ˜¯ä¾æ¬¡ä»channelä¸­è¯»å–æ•°æ®ï¼Œè¯»å–å‰æ˜¯ä¸çŸ¥é“é‡Œé¢æœ‰å¤šå°‘ä¸ªå…ƒç´ çš„ã€‚ å¦‚æœchannelä¸­æ²¡æœ‰å…ƒç´ ï¼Œåˆ™ä¼šé˜»å¡ç­‰å¾…ï¼Œå¦‚æœchannelå·²è¢«å…³é—­ï¼Œåˆ™ä¼šè§£é™¤é˜»å¡å¹¶é€€å‡ºå¾ªç¯ã€‚ for-rangeè¿­ä»£channelï¼Œåªèƒ½è·å–ä¸€ä¸ªå€¼ï¼Œkeyä¸ºchannelå­˜å‚¨çš„å…ƒç´ ç±»å‹ã€‚ 1 2 3 4 5 6 c := make(chan int) // rangeéå†chan for v := range c { // ã€intã€‘ fmt.Println(v) // original body } ä¸Šé¢è¿­ä»£channelä»£ç ç­‰æ•ˆäºä¸‹é¢ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // è¿™é‡Œæ˜¯\u0026vä¸ºä»€ä¹ˆéƒ½æ˜¯åŒä¸€ä¸ªåœ°å€çš„åŸå›  var v int // vå…¶å®å°±æ˜¯å›ºå®šçš„ä¸€ä¸ªå˜é‡ for { // æ³¨æ„å¦‚æœä¸å…³é—­channelè¿™é‡Œä¼šä¸€ç›´é˜»å¡ // æˆ‘ä»¬çŸ¥é“ \u003c- ç¬¦å·ä¼šè°ƒç”¨ç›¸å…³çš„å‡½æ•°ï¼Œå¦‚æœchanå…³é—­äº†ä¼šè¿”å›falseé€€å‡ºå¾ªç¯ value_temp, ok := \u003c- c\t// æœ‰æ•°æ®åˆ™ä¼šç›´æ¥è¿”å›æ•°æ®ï¼Œæ²¡æœ‰æ•°æ®åˆ™ä¼šé˜»å¡ï¼Œé€šè¿‡chançš„å­¦ä¹ çŸ¥é“é˜»å¡æ„å‘³ç€ // å½“å‰goroutineè¢«è°ƒç¦»è°ƒåº¦å¾ªç¯ç­‰å¾…æ•°æ®åˆ°æ¥è¢«é‡æ–°è°ƒèµ· // ok = falseï¼Œé€šé“å·²ç»å…³é—­ã€‚ if !ok { break } // 2) æ‹·è´å€¼ v = value_temp fmt.Println(v) // original body } ç¼–è¯‘åçš„ä¼ªä»£ç ï¼Œä¸ä¸Šé¢ç­‰ä»·ã€‚å…³äºchanrecv2()åœ¨channelä¸­ä»‹ç»ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 var v int for { ok := chanrecv2(c, \u0026value_temp) if !ok { break } v = index_temp fmt.Println(v) // original body } æ³¨æ„ï¼š ä½¿ç”¨for-rangeéå†channelæ—¶åªèƒ½è·å–ä¸€ä¸ªè¿”å›å€¼ã€‚ ã€for-range \u003c-chã€‘æƒ…å†µï¼Œè¯¥æƒ…å†µå¯ä»¥ç”¨åœ¨ ã€channel mapã€channel array|*arrayã€channel sliceã€channel stringã€‘ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func chanTs2() { ch := make(chan map[int]int) // æ³¨æ„ï¼šè¿™é‡Œæ˜¯ \u003c-chï¼Œå‰é¢çš„æ˜¯ ch for k, v := range \u003c-ch { println(k, v) } // --------------------------- // as ç­‰ä»·äºä¸‹é¢ä»£ç  // --------------------------- // æ³¨æ„ï¼šè¿™é‡Œåªä¼šæ‰§è¡Œä¸€æ¬¡ a := \u003c-ch for k, v := range a { println(k, v) } } è¿­ä»£map for-rangeè¿­ä»£mapï¼Œkeyä¸ºmapçš„é”®ï¼Œvalueä¸ºmapçš„å€¼ã€‚ 1 2 3 4 5 map1 := map[string]string{\"one\":\"1\", \"tow\":\"2\"} for i, v := range map1 { // ã€string, stringã€‘ fmt.Println(i, v) // original body } ä¸Šé¢è¿­ä»£mapä»£ç ç­‰æ•ˆäºä¸‹é¢ä»£ç ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // 1) key/value // è¿™é‡Œä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ\u0026iå’Œ\u0026væ˜¯ä¸€ä¸ªå›ºå®šçš„åœ°å€çš„åŸå›  // å®šä¹‰éå†æ‰€éœ€è¦çš„keyå’Œvalueå˜é‡ var i, v string // 2) map_iteration_struct // map_iteration_structæ˜¯ä¸€ä¸ªhiterç»“æ„ä½“ï¼Œå­˜å‚¨ç€mapçš„éå†ç›¸å…³ä¿¡æ¯ var hiter map_iteration_struct\t// mapiterinit åˆå§‹åŒ–mapå‚çœ‹runtime/map.goæ–‡ä»¶ // hiteræ˜¯ä¸€ä¸ªå“ˆå¸Œè¿­ä»£ç»“æ„ï¼Œmapiternextè¿­ä»£ä¸‹ä¸€ä¸ªå“ˆå¸Œ for mapiterinit(type, range, \u0026hiter); hiter.key != nil; mapiternext(\u0026hiter) { index_temp := *hiter.key value_temp := *hiter.val // 3) æ‹·è´æ•°æ® i = index_temp v = value_temp fmt.Println(i, v) // original body } éå†mapæ—¶æ²¡æœ‰æŒ‡å®šå¾ªç¯æ¬¡æ•°ï¼Œå¾ªç¯ä½“ä¸éå†sliceç±»ä¼¼ã€‚ç”±äºmapåº•å±‚å®ç°ä¸sliceä¸åŒï¼Œmapåº•å±‚ä½¿ç”¨ hashè¡¨å®ç°çš„ã€‚ æ’å…¥æ•°æ®ä½ç½®æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥éå†è¿‡ç¨‹ä¸­æ–°æ’å…¥çš„æ•°æ®ä¸èƒ½ä¿è¯éå†åˆ°ã€‚ ä»¥ä¸‹ç›¸å…³çš„å‡½æ•°åœ¨mapç¯‡ä¸­è¿˜ä¼šè¯¦ç»†çš„è®¨è®ºã€‚ type hiter structã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 // A hash iteration structure. // If you modify hiter, also change cmd/compile/internal/reflectdata/reflect.go // and reflect/value.go to match the layout of this structure. type hiter struct { // å½“å‰éå†çš„keyåœ°å€ key unsafe.Pointer // Must be in first position. Write nil to indicate iteration end (see cmd/compile/internal/walk/range.go). // å½“å‰éå†çš„elemåœ°å€ elem unsafe.Pointer // Must be in second position (see cmd/compile/internal/walk/range.go). // å½“å‰mapçš„ç±»å‹ç»“æ„ t *maptype // å½“å‰mapçš„å†…å­˜ç»“æ„ h *hmap\t// å½“å‰mapçš„å¸¸è§„æ¡¶åœ°å€ buckets unsafe.Pointer // bucket ptr at hash_iter initialization time // å½“å‰æ­£åœ¨éå†çš„æ¡¶ bptr *bmap // current bucket å½“å‰å­˜å‚¨æ¡¶ // h.extra.overflow overflow *[]*bmap // keeps overflow buckets of hmap.buckets alive\t// h.extra.oldoverflow oldoverflow *[]*bmap // keeps overflow buckets of hmap.oldbuckets alive // å¼€å§‹éå†çš„æ¡¶å·ï¼Œéšæœºçš„ï¼Œç”¨äºå¼€å§‹éå†çš„èµ·ç‚¹ä»¥åŠç»“æŸéå†çš„ç»ˆç‚¹ startBucket uintptr // bucket iteration started at // tophashåç§»å€¼ï¼Œåœ¨[0,7]ä¸­éšæœºç”Ÿæˆçš„å€¼ï¼Œç”¨äºåç»­ i + offset \u0026 7 ç”¨ä½œåç§»é‡ offset uint8 // intra-bucket offset to start from during iteration (should be big enough to hold bucketCnt-1) // å½“å‰éå†å·²è¿‡æœ€å¤§æ¡¶(1 \u003c\u003c B)æ—¶è¢«è®¾ç½®ä¸ºtrue wrapped bool // already wrapped around from end of bucket array to beginning // åˆå§‹åŒ–æ—¶æ¡¶çš„æ•°é‡ 1 \u003c\u003c B B uint8 // å½“å‰æ¡¶éå†çš„ç´¢å¼•ï¼Œé»˜è®¤å€¼ä»0å¼€å§‹ï¼Œè¯¥å€¼é…åˆoffsetéå†tophashï¼Œi + offset \u0026 7 i uint8 // åˆå§‹åŒ–æ—¶æ˜¯startBucketçš„å€¼ // 1. bptr == nilæ—¶bucketå­˜å‚¨éœ€è¦éå†çš„æ¡¶å· // 2. bptr != nilæ—¶bucketä¸‹ä¸ªæ¡¶çš„æ¡¶å· bucket uintptr // å­˜å‚¨çš„æ˜¯å½“å‰è¿­ä»£å™¨çš„æ¡¶å· // noCheck.ä¸éœ€è¦æ£€æŸ¥ï¼Œæ•°æ®åœ¨bptræ¡¶é‡Œé¢ // å…¶ä»–éœ€è¦æ£€æŸ¥ checkBucket uintptr // éœ€è¦æ£€æŸ¥çš„æ¡¶å· } mapiterinit()ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 // mapiterinit initializes the hiter struct used for ranging over maps. // The hiter struct pointed to by 'it' is allocated on the stack // by the compilers order pass or on the heap by reflect_mapiterinit. // Both need to have zeroed hiter since the struct contains pointers. // mapiterinit åˆå§‹åŒ–ç”¨äºåœ¨mapä¸Šçš„ hiter ç»“æ„ // 'it' æŒ‡å‘çš„ hiter ç»“æ„ç”±ç¼–è¯‘å™¨é¡ºåºä¼ é€’åœ¨å †æ ˆä¸Šåˆ†é…ï¼Œæˆ–è€…ç”± reflect_mapiterinit åœ¨å †ä¸Šåˆ†é…ã€‚ // ç”±äºç»“æ„åŒ…å«æŒ‡é’ˆï¼Œå› æ­¤ä¸¤è€…éƒ½éœ€è¦å°† hiter å½’é›¶ã€‚ // // è¿­ä»£åˆå§‹åŒ– // t *maptypeï¼šå½“å‰mapçš„å…ƒç´ ç±»å‹ // h *hmapï¼šå½“å‰mapçš„å†…å­˜ç»“æ„ // it *hiterï¼šè¿­ä»£å™¨ç»“æ„ func mapiterinit(t *maptype, h *hmap, it *hiter) { if raceenabled \u0026\u0026 h != nil { callerpc := getcallerpc() racereadpc(unsafe.Pointer(h), callerpc, abi.FuncPCABIInternal(mapiterinit)) } it.t = t // å­˜å‚¨å½“å‰mapçš„ç±»å‹ç»“æ„åœ°å€ if h == nil || h.count == 0 { // å¦‚æœå½“å‰mapä¸ºç©ºç›´æ¥è¿”å› return } if unsafe.Sizeof(hiter{})/goarch.PtrSize != 12 { // åˆ¤æ–­hiterç»“æ„æ˜¯å¦æ­£ç¡® throw(\"hash_iter size incorrect\") // see cmd/compile/internal/reflectdata/reflect.go } it.h = h // å­˜å‚¨å½“å‰mapçš„å†…å­˜ç»“æ„åœ°å€ // grab snapshot of bucket state it.B = h.B // è®°å½•å½“å‰mapçš„æ¡¶æ•°é‡ it.buckets = h.buckets // è®°å½•å½“å‰mapçš„å¸¸è§„æ¡¶åœ°å€ if t.bucket.ptrdata == 0 { // åˆ¤æ–­å½“å‰æ¡¶ç±»å‹çš„ptrdataå­—æ®µï¼Œè¯¥å­—æ®µä¸º0è¯´æ˜å­˜å‚¨çš„éƒ½æ˜¯æ ‡é‡æ•°æ® // åˆ†é…å½“å‰åˆ‡ç‰‡å¹¶è®°ä½æŒ‡å‘å½“å‰åˆ‡ç‰‡å’Œæ—§åˆ‡ç‰‡çš„æŒ‡é’ˆã€‚ // å³ä½¿è¡¨å¢é•¿ and/or åœ¨æˆ‘ä»¬è¿­ä»£æ—¶å°†æº¢å‡ºæ¡¶æ·»åŠ åˆ°è¡¨ä¸­ï¼Œè¿™ä¹Ÿä¼šä¿ç•™æ‰€æœ‰ç›¸å…³çš„æº¢å‡ºæ¡¶ã€‚ h.createOverflow() // åˆ›å»ºæº¢å‡ºæ¡¶ it.overflow = h.extra.overflow it.oldoverflow = h.extra.oldoverflow } // decide where to start // å†³å®šä»å“ªé‡Œå¼€å§‹ r := uintptr(fastrand()) // ç”Ÿæˆéšæœºæ•°å†³å®šä»å“ªé‡Œå¼€å§‹ // bucketCntBits = 3 if h.B \u003e 31-bucketCntBits { // å¦‚æœå½“å‰çš„æ¡¶æ•° \u003e 31 - 3 r += uintptr(fastrand()) \u003c\u003c 31 } it.startBucket = r \u0026 bucketMask(h.B) // ç¡®å®šå¼€å§‹çš„æ¡¶å·ï¼Œè¿™é‡Œä¹Ÿæ˜¯for rangeéšæœºçš„åŸå›  it.offset = uint8(r \u003e\u003e h.B \u0026 (bucketCnt - 1)) // å¼€å§‹çš„tophashä½ç½®å¤„ // iterator state it.bucket = it.startBucket // è®°ä½æˆ‘ä»¬æœ‰ä¸€ä¸ªè¿­ä»£å™¨ã€‚ // å¯ä»¥ä¸å¦ä¸€ä¸ª mapiterinit() å¹¶å‘è¿è¡Œã€‚\t// iterator = 1 å­˜åœ¨æ¡¶æ­£åœ¨åœ¨ä½¿ç”¨è¿­ä»£å™¨æ ‡å¿— // oldIterator = 2 å­˜åœ¨æ—§æ¡¶æ­£åœ¨ä½¿ç”¨è¿­ä»£å™¨æ ‡å¿— // è®¾ç½®æ­£åœ¨è¿­ä»£çš„æ ‡å¿—ä½ if old := h.flags; old\u0026(iterator|oldIterator) != iterator|oldIterator { atomic.Or8(\u0026h.flags, iterator|oldIterator) // åŸå­é”è®¾ç½®hmapçš„flagså‚æ•°æ ‡å¿—æ­£åœ¨ä½¿ç”¨è¿­ä»£å™¨ } mapiternext(it) } mapiternext()ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 // å‘ä¸‹å¯»æ‰¾ä¸‹ä¸€ä¸ªkey func mapiternext(it *hiter) { h := it.h // è·å–å½“å‰hmapå†…å­˜ç»“æ„ if raceenabled { callerpc := getcallerpc() racereadpc(unsafe.Pointer(h), callerpc, abi.FuncPCABIInternal(mapiternext)) } // å½“å‰æœ‰hashWritingæ“ä½œæ—¶ï¼Œæ¯”å¦‚m[k]=væˆ–deleteå‡½æ•°æ—¶éƒ½ä¼šæŠ¥é”™ if h.flags\u0026hashWriting != 0 { throw(\"concurrent map iteration and map write\") } t := it.t // è·å–mapçš„ç»“æ„ // æœ¬æ¬¡éœ€è¦éå†çš„æ¡¶å· bucket := it.bucket // å½“å‰çš„æ¡¶å· // æœ¬æ¬¡éœ€è¦éå†çš„æ¡¶ï¼Œå¦‚æœä¸ºnilè¯´æ˜éœ€è¦å»bucketå¯»æ‰¾ b := it.bptr // å½“å‰å­˜å‚¨æ¡¶ // æœ¬æ¬¡åº”è¯¥éå†çš„ç´¢å¼• i := it.i // éå†ç´¢å¼•é»˜è®¤0 checkBucket := it.checkBucket // éå†ä¸€éå½“å‰æ¡¶åŠå…¶æº¢å‡ºæ¡¶ç›´åˆ°b=nil next: // å½“å‰æ¡¶éå†å®Œæ—¶ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ¡¶å»éå† if b == nil { // å½“å‰éå†çš„æ¡¶å’Œå¼€å§‹çš„æ¡¶ç›¸ç­‰ å¹¶ä¸” å·²ç»éå†è¿‡äº†æœ€å¤§æ¡¶æ•°ï¼Œè¯´æ˜éå†äº†ä¸€åœˆäº† if bucket == it.startBucket \u0026\u0026 it.wrapped { // ç»“æŸéå†çš„æ¡ä»¶ // end of iteration it.key = nil it.elem = nil return } // h.growing() å½“å‰æ­£åœ¨æ‰©å®¹ä¸­ if h.growing() \u0026\u0026 it.B == h.B { // h.growing()å½“å‰mapæ­£å¤„äºæ‰©å®¹çŠ¶æ€ // è¿­ä»£å™¨æ˜¯åœ¨å¢é•¿è¿‡ç¨‹ä¸­å¯åŠ¨çš„ï¼Œä½†å¢é•¿å°šæœªå®Œæˆã€‚ // å¦‚æœæˆ‘ä»¬æŸ¥çœ‹çš„bucketå°šæœªå¡«å……ï¼ˆå³ï¼Œæ—§bucketæœªè¢«æ¸…ç©ºï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦éå†æ—§bucketsï¼Œåªè¿”å›å°†è¿ç§»åˆ°æ­¤bucketçš„bucketsã€‚ oldbucket := bucket \u0026 it.h.oldbucketmask() // æ—§æ¡¶çš„æ¡¶å· b = (*bmap)(add(h.oldbuckets, oldbucket*uintptr(t.bucketsize)))\t// è·å–æ¡¶ä½ç½® // å½“å‰æ¡¶çš„tophash[0]ä¸æ˜¯2|3|4æ—¶ï¼Œè¯´æ˜æ•°æ®æ²¡æœ‰è¢«è¿ç§» if !evacuated(b) {\tcheckBucket = bucket // éœ€è¦æ£€æŸ¥çš„æ¡¶å· } else { // è¯´æ˜æ•°æ®åœ¨æ–°æ¡¶é‡Œé¢ï¼Œæ•°æ®å·²è¢«è¿ç§» b = (*bmap)(add(it.buckets, bucket*uintptr(t.bucketsize)))\tcheckBucket = noCheck } } else { // 1.æ²¡æœ‰æ‰©å®¹ 2.æ‰©å®¹äº†ä½†æ˜¯it.B != h.B b = (*bmap)(add(it.buckets, bucket*uintptr(t.bucketsize))) // æ–°æ¡¶ checkBucket = noCheck } bucket++ // æ¡¶å·åŠ ä¸€ // å½“å‰æ¡¶å·ç­‰äºæœ€å¤§æ¡¶å· if bucket == bucketShift(it.B) { // bucketShift(it.B) ç­‰äº 1 \u003e\u003e B bucket = 0 // æ ‡è®°ä»0å·æ¡¶å¼€å§‹ it.wrapped = true // æ ‡è®°å·²ç»è¿‡äº†æœ€å¤§æ¡¶äº† } i = 0 // æ–°æ¡¶é‡ç½®ç´¢å¼•ä¸º0 } // éå†å½“å‰æ¡¶çš„æ‰€æœ‰å…ƒç´ \tbucketCnt = 8 // ä»å½“å‰æ¡¶éå†æ•°æ® for ; i \u003c bucketCnt; i++ { offi := (i + it.offset) \u0026 (bucketCnt - 1) // æ ¹æ®it.offsetåç§»é‡å¼€å§‹éšæœºéå†å…ƒç´ [0,7] // b.tophash[offi] \u003c= 1 æˆ– evacuatedEmpty = 4 è¡¨ç¤ºæ¡¶æ•°æ®ä¸ºç©º if isEmpty(b.tophash[offi]) || b.tophash[offi] == evacuatedEmpty { // å¦‚æœå½“å‰ä½ç½®ä¸º0æˆ–1æˆ–4è¡¨ç¤ºæ¡¶ä¸ºç©º continue } k := add(unsafe.Pointer(b), dataOffset+uintptr(offi)*uintptr(t.keysize)) // åç§»åˆ°å½“å‰keyä½ç½® if t.indirectkey() { // åˆ¤æ–­å½“å‰keyå­˜å‚¨æ˜¯å¦æ˜¯å·²æŒ‡é’ˆå­˜å‚¨è€Œä¸æ˜¯å­˜å‚¨çš„keyæœ¬èº« k = *((*unsafe.Pointer)(k)) } // åç§»åˆ°å½“å‰elemä½ç½® e := add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+uintptr(offi)*uintptr(t.elemsize)) // checkBucket != noCheck æ•°æ®åœ¨æ—§æ¡¶ å¹¶ä¸” !h.sameSizeGrow() ç¿»å€æ‰©å®¹ // éœ€è¦éªŒè¯æ¡¶æ—¶ï¼Œæ—§æ¡¶å­˜åœ¨æ•°æ® if checkBucket != noCheck \u0026\u0026 !h.sameSizeGrow() { // å­˜åœ¨æ²¡æœ‰è¿ç§»å®Œçš„æ—§æ¡¶æ—¶ï¼Œå»æ£€æŸ¥æ—§æ¡¶ // t.reflexivekey() ä¸ºtrueè¡¨ç¤º k == k å§‹ç»ˆæˆç«‹ // t.reflexivekey() || t.key.equal(k, k) -\u003e k == k å§‹ç»ˆæˆç«‹æƒ…å†µ if t.reflexivekey() || t.key.equal(k, k) { // å¦‚æœoldbucketä¸­çš„é¡¹ä¸æ˜¯é’ˆå¯¹è¿­ä»£ä¸­çš„å½“å‰æ–°bucketï¼Œè¯·è·³è¿‡å®ƒ hash := t.hasher(k, uintptr(h.hash0)) if hash\u0026bucketMask(it.B) != checkBucket { // éœ€è¦è·³è¿‡çš„æƒ…å†µ continue } } else { // k == k ä¸æ˜¯å§‹ç»ˆæˆç«‹ // b.tophash[offi]\u00261 çš„æœ€ä½ä½ å‚çœ‹æ•°æ®è¿ç§»éƒ¨åˆ†çš„å»å‘ if checkBucket\u003e\u003e(it.B-1) != uintptr(b.tophash[offi]\u00261) { continue } } } // å°†æ‰¾åˆ°çš„kå’Œeä¿å­˜åˆ°hiterä¸­ // evacuatedX = 2ã€evacuatedY = 3 // b.tophash[offi] != evacuatedX \u0026\u0026 b.tophash[offi] != evacuatedY å­˜åœ¨æœ‰æ•ˆæ•°æ® // !(t.reflexivekey() || t.key.equal(k, k))\t-\u003e x == x ä¸æ˜¯å§‹ç»ˆæˆç«‹ if (b.tophash[offi] != evacuatedX \u0026\u0026 b.tophash[offi] != evacuatedY) || !(t.reflexivekey() || t.key.equal(k, k)) { // è¿™æ˜¯éœ€è¦çš„æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥è¿”å›å®ƒ // æˆ– // key!=keyï¼Œå› æ­¤æ— æ³•åˆ é™¤æˆ–æ›´æ–°æ¡ç›®ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åªè¿”å›å®ƒ // è¿™å¯¹æˆ‘ä»¬æ¥è¯´å¾ˆå¹¸è¿ï¼Œå› ä¸ºå½“key!=keyå…³é”®æ˜¯æˆ‘ä»¬æ‰¾ä¸åˆ°å®ƒ it.key = k if t.indirectelem() { e = *((*unsafe.Pointer)(e)) } it.elem = e } else { // æ•°æ®è¢«è¿ç§»åˆ°å…¶ä»–åœ°æ–¹äº† // è‡ªä»è¿­ä»£å™¨å¯åŠ¨ä»¥æ¥ï¼Œå“ˆå¸Œè¡¨ä¸€ç›´åœ¨å¢é•¿ // è¿™ä¸ªkeyçš„æ•°æ®ç°åœ¨åœ¨å…¶ä»–åœ°æ–¹ // æ£€æŸ¥æ•°æ®çš„å½“å‰å“ˆå¸Œè¡¨ // æ­¤ä»£ç å¤„ç†ä»¥ä¸‹æƒ…å†µï¼š //\tå·²è¢«åˆ é™¤ã€æ›´æ–°æˆ–åˆ é™¤å¹¶é‡æ–°æ’å…¥ //\tæ³¨æ„ï¼šæˆ‘ä»¬éœ€è¦é‡æ–°æ ‡è®°å¯†é’¥ï¼Œå› ä¸ºå®ƒå¯èƒ½å·²æ›´æ–°ä¸ºequal()ï¼Œä½†ä¸æ˜¯ç›¸åŒçš„keyï¼ˆä¾‹å¦‚+0.0 vs-0.0ï¼‰ rk, re := mapaccessK(t, h, k) // æ ¹æ®keyå»å¯»æ‰¾ç›¸åº”çš„æ•°æ®ï¼Œå¯èƒ½æ˜¯æ–°æ¡¶ä¹Ÿå¯èƒ½æ˜¯æ—§æ¡¶ // æ¯å¯»æ‰¾åˆ°ï¼Œå¯èƒ½keyå·²è¢«åˆ é™¤ if rk == nil { continue // key has been deleted } it.key = rk it.elem = re } it.bucket = bucket // å›å†™æ¡¶å· // è®°å½•å½“å‰æ­£åœ¨éå†çš„æ¡¶ if it.bptr != b { // avoid unnecessary write barrier; see issue 14921 it.bptr = b\t// é¿å…ä¸å¿…è¦çš„å†™å…¥éšœç¢ } it.i = i + 1 // iåŠ ä¸€ it.checkBucket = checkBucket return } b = b.overflow(t) // å¦‚æœä¸Šé¢æ¡¶éå†å®Œæ¥åˆ°å»åé¢æ¡¶æ‰¾ i = 0 goto next } mapaccessK()ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 // returns both key and elem. Used by map iterator // æ ¹æ®keyæ‰¾åˆ°ç›¸åº”çš„å€¼ func mapaccessK(t *maptype, h *hmap, key unsafe.Pointer) (unsafe.Pointer, unsafe.Pointer) { if h == nil || h.count == 0 { return nil, nil } hash := t.hasher(key, uintptr(h.hash0)) // å½“å‰keyç”Ÿæˆçš„hashå€¼ m := bucketMask(h.B) // (1 \u003c\u003c B) - 1 b := (*bmap)(add(h.buckets, (hash\u0026m)*uintptr(t.bucketsize))) // keyå­˜å‚¨çš„å½“å‰æ¡¶ // æ˜¯å¦åœ¨æ‰©å®¹ä¸­ if c := h.oldbuckets; c != nil { if !h.sameSizeGrow() {\t// ç¿»å€æ‰©å®¹ // There used to be half as many buckets; mask down one more power of two. m \u003e\u003e= 1 } // å»æ—§æ¡¶é‡Œé¢æŸ¥çœ‹æ•°æ®æ˜¯å¦è¢«è¿ç§»äº† oldb := (*bmap)(add(c, (hash\u0026m)*uintptr(t.bucketsize)))\t// æ•°æ®æ²¡æœ‰è¢«è¿ç§» tophash[0] != [2,3,4] if !evacuated(oldb) { b = oldb } } top := tophash(hash) // tophash bucketloop: // éå†å½“å‰æ¡¶åŠæº¢å‡ºæ¡¶å¯»æ‰¾ key for ; b != nil; b = b.overflow(t) { for i := uintptr(0); i \u003c bucketCnt; i++ { if b.tophash[i] != top { if b.tophash[i] == emptyRest { // emptyRest = 0 break bucketloop } continue } // æ‰¾åˆ°äº†key // 1. å¯èƒ½æ˜¯hashå†²çªåˆ™è¿˜éœ€è¦å‘åå»æŸ¥æ‰¾ // 2. ç¡®å®æ‰¾åˆ°äº†keyç›´æ¥è¿”å›å³å¯ k := add(unsafe.Pointer(b), dataOffset+i*uintptr(t.keysize)) if t.indirectkey() { k = *((*unsafe.Pointer)(k)) } // keyåŒ¹é…æˆåŠŸ if t.key.equal(key, k) { e := add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+i*uintptr(t.elemsize)) if t.indirectelem() { e = *((*unsafe.Pointer)(e)) } return k, e } } } return nil, nil } æ€»ç»“ for-rangeä¸æ”¯æŒã€å­—ç¬¦ä¸²æŒ‡é’ˆã€‘ã€ã€åˆ‡ç‰‡æŒ‡é’ˆã€‘ã€ã€mapæŒ‡é’ˆã€‘ã€ã€channelæŒ‡é’ˆã€‘ï¼Œä½†æ”¯æŒã€æ•°ç»„æŒ‡é’ˆã€‘éå†ã€‚ ",
  "wordCount" : "2902",
  "inLanguage": "zh",
  "image": "https://heliu.site/favicon-32x32.png","datePublished": "2019-10-05T00:00:00Z",
  "dateModified": "2020-07-20T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://heliu.site/posts/golang/process/range/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://heliu.site/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://heliu.site/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://heliu.site/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://heliu.site/" title="ä¸»é¡µ">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/posts" title="æ–‡ç« ">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/archives" title="æ—¶é—´è½´">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/tags/" title="æ ‡ç­¾">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/search/" title="æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/support" title="æ‰“èµ">
                    <span>ğŸ«¶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://heliu.site/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/">Article</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/golang/">Golang</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/golang/process/">ç¬¬3ç«  æµç¨‹æ§åˆ¶</a></div>
    <h1 class="post-title entry-hint-parent">
      æµç¨‹æ§åˆ¶(rangeè¿­ä»£)
    </h1>
    <div class="post-description">
      ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬
    </div>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2019-10-05</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2020-07-20</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>2902å­—</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>14åˆ†é’Ÿ</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &nbsp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://heliu.site/tags/golang/" target="_blank" rel="noopener">Golang</a>
            <a href="https://heliu.site/tags/%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/" target="_blank" rel="noopener">æµç¨‹æ§åˆ¶</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &nbsp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e8%bf%ad%e4%bb%a3string" aria-label="è¿­ä»£string">è¿­ä»£<code>string</code></a></li>
                    <li>
                        <a href="#%e8%bf%ad%e4%bb%a3array" aria-label="è¿­ä»£array">è¿­ä»£<code>array</code></a></li>
                    <li>
                        <a href="#%e8%bf%ad%e4%bb%a3slice" aria-label="è¿­ä»£slice">è¿­ä»£<code>slice</code></a></li>
                    <li>
                        <a href="#%e8%bf%ad%e4%bb%a3channel" aria-label="è¿­ä»£channel">è¿­ä»£<code>channel</code></a></li>
                    <li>
                        <a href="#%e8%bf%ad%e4%bb%a3map" aria-label="è¿­ä»£map">è¿­ä»£<code>map</code></a></li>
                    <li>
                        <a href="#%e6%80%bb%e7%bb%93" aria-label="æ€»ç»“">æ€»ç»“</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><h2 id="è¿­ä»£string">è¿­ä»£<code>string</code><a hidden class="anchor" aria-hidden="true" href="#è¿­ä»£string">#</a></h2>
<ol>
<li><code>range</code>è¿­ä»£<code>string</code>ï¼Œ<code>key</code>ä¸º<code>int</code>ç±»å‹ï¼Œ<code>value</code>ä¸º<code>rune</code>ç±»å‹ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">str</span> <span class="o">:=</span> <span class="s">&#34;hello world! Gopher&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">str</span> <span class="p">{</span> <span class="c1">// ã€int, runeã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// original body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>ä¸Šé¢è¿­ä»£å­—ç¬¦ä¸²ä»£ç ç­‰æ•ˆäºä¸‹é¢ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 1) è·å–å­—ç¬¦ä¸²é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1">// å­—ç¬¦ä¸²æ€»é•¿åº¦ï¼Œè¯¥é•¿åº¦æ˜¯å­—èŠ‚æ•°é‡ç”¨äºéå†å­—ç¬¦ä¸²çš„æ€»é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">lenTemp</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ä¸‹ä¸€æ¬¡éå†çš„ä¸‹æ ‡ä½ç½®ï¼Œè¿™æ˜¯ç”±äºutf8æ˜¯ä¸å®šé•¿ç¼–ç éœ€è¦è®°å½•ä¸Šä¸€æ¬¡å¤„ç†åçš„ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">nextIndexTemp</span> <span class="kt">int</span>	
</span></span><span class="line"><span class="cl"><span class="c1">// 2) key/value
</span></span></span><span class="line"><span class="cl"><span class="c1">// æ³¨æ„ï¼šè¿™é‡Œçš„keyå’Œvalueï¼Œå®šä¹‰åœ¨forå¤–ï¼Œä¹Ÿæ˜¯&amp;iå’Œ&amp;væ˜¯å›ºå®šçš„åŸå› 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">i</span> <span class="kt">int</span>       <span class="c1">// éå†ç”¨åˆ°çš„ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">v</span> <span class="kt">rune</span>      <span class="c1">// éå†å‡ºæ¥å­˜å‚¨çš„å€¼ï¼Œä¹Ÿå°±æ˜¯value
</span></span></span><span class="line"><span class="cl"><span class="c1">// éå†å­—ç¬¦ä¸²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="nx">indexTemp</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">indexTemp</span> <span class="p">&lt;</span> <span class="nx">lenTemp</span><span class="p">;</span> <span class="nx">indexTemp</span> <span class="p">=</span> <span class="nx">nextIndexTemp</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å–å¼€å¤´8bitçš„å¤§å°ï¼Œå› ä¸ºè¯¥8bitèƒ½åŒºåˆ†å­˜å‚¨çš„æ˜¯ASCII 1bitè¿˜æ˜¯å¤šä¸ªä½¿ç”¨utf8ç¼–ç çš„å­—èŠ‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">valueTemp</span> <span class="o">:=</span> <span class="nb">rune</span><span class="p">(</span><span class="nx">str</span><span class="p">[</span><span class="nx">indexTemp</span><span class="p">])</span>	
</span></span><span class="line"><span class="cl">    <span class="c1">// utf8.RuneSelf = 0x80 = 128 å•å­—ç¬¦æœ€å¤§å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ASCIIç å­—ç¬¦å 1å­—èŠ‚ï¼Œè¯¥æ¡ä»¶æ»¡è¶³è¯´æ˜ï¼Œå­˜å‚¨çš„æ˜¯ASCIIç å ç”¨ä¸€ä¸ªå­—èŠ‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">valueTemp</span> <span class="p">&lt;</span> <span class="nx">utf8</span><span class="p">.</span><span class="nx">RuneSelf</span> <span class="p">{</span>		
</span></span><span class="line"><span class="cl">        <span class="nx">nextIndexTemp</span> <span class="p">=</span> <span class="nx">indexTemp</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è¯¥æ¡ä»¶æ»¡è¶³è¯´æ˜æ˜¯ä½¿ç”¨utf8ç¼–ç çš„å¤šä¸ªå­—èŠ‚å ç”¨ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä½¿ç”¨decoderuneè·å–è¯¥Unicodeå€¼å’Œåœ¨Utf8ä¸­ç¼–ç å ç”¨çš„å­—èŠ‚å¤§å°æ•°ç›®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// decoderuneè§£ç å­—ç¬¦ä¸²strä»indexTempä½ç½®å¼€å§‹ï¼Œå…·ä½“æ–¹æ³•åœ¨runtime/utf8.goæ–‡ä»¶ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¯¥å‡½æ•°ä¸utf8ç¼–ç ç›¸å…³
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// valueTempè§£æçš„runeï¼ŒnextIndexTempå½“å‰çš„indexTemp+è§£æçš„runeçš„é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">valueTemp</span><span class="p">,</span> <span class="nx">nextIndexTemp</span> <span class="p">=</span> <span class="nf">decoderune</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="nx">indexTemp</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 3) æ‹·è´èµ‹å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ³¨æ„ï¼šè¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆfor rangeä¸­å–&amp;iå’Œ&amp;våœ°å€æ˜¯å›ºå®šçš„åŸå› 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">i</span> <span class="p">=</span> <span class="nx">indexTemp</span>   <span class="c1">// å½“å‰è·å–åˆ°çš„ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">v</span> <span class="p">=</span> <span class="nx">valueTemp</span>   <span class="c1">// å½“å‰è·å–åˆ°çš„å­—ç¬¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// original body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li><code>decoderune()</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// runtime/utf8.go æ–‡ä»¶ä¸­decoderuneæ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// decoderune returns the non-ASCII rune at the start of
</span></span></span><span class="line"><span class="cl"><span class="c1">// s[k:] and the index after the rune in s.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// decoderune assumes that caller has checked that
</span></span></span><span class="line"><span class="cl"><span class="c1">// the to be decoded rune is a non-ASCII rune.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// If the string appears to be incomplete or decoding problems
</span></span></span><span class="line"><span class="cl"><span class="c1">// are encountered (runeerror, k + 1) is returned to ensure
</span></span></span><span class="line"><span class="cl"><span class="c1">// progress when decoderune is used to iterate over a string.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">decoderune</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">k</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">r</span> <span class="kt">rune</span><span class="p">,</span> <span class="nx">pos</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pos</span> <span class="p">=</span> <span class="nx">k</span> <span class="c1">// è§£æå¼€å§‹ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">k</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// å·²ç»åˆ°å­—ç¬¦ä¸²çš„æœ€å¤§é•¿åº¦äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">runeError</span><span class="p">,</span> <span class="nx">k</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">s</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[</span><span class="nx">k</span><span class="p">:]</span>   <span class="c1">// ä»kä½ç½®åˆ†å‰²å­—ç¬¦ä¸²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// [t2, t3) --&gt; [11000000, 11100000)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="nx">t2</span> <span class="o">&lt;=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">&lt;</span> <span class="nx">t3</span><span class="p">:</span>   <span class="c1">// è¯¥å­—æ®µ2å­—èŠ‚ç¼–ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 0080-07FF two byte sequence
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// [locb, hicb] æ˜¯ç¬¬äºŒä¸ªå­—èŠ‚çš„èŒƒå›´å¤§å° [10000000, 10111111]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">locb</span> <span class="o">&lt;=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">hicb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ä»ç¼–ç ä¸­å–å‡ºç¼–ç çš„æ•°æ®ç»„æˆrune
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// mask2 = 00011111ï¼Œmaskx = 00111111
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">r</span> <span class="p">=</span> <span class="nb">rune</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&amp;</span><span class="nx">mask2</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">6</span> <span class="p">|</span> <span class="nb">rune</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&amp;</span><span class="nx">maskx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">pos</span> <span class="o">+=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">rune1Max</span> <span class="p">&lt;</span> <span class="nx">r</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// [t3, t4) --&gt; [11100000, 11110000)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="nx">t3</span> <span class="o">&lt;=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">&lt;</span> <span class="nx">t4</span><span class="p">:</span>   <span class="c1">// è¯¥å­—æ®µ3å­—èŠ‚ç¼–ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 0800-FFFF three byte sequence
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">locb</span> <span class="o">&lt;=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">hicb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">locb</span> <span class="o">&lt;=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">hicb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">r</span> <span class="p">=</span> <span class="nb">rune</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&amp;</span><span class="nx">mask3</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">12</span> <span class="p">|</span> <span class="nb">rune</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&amp;</span><span class="nx">maskx</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">6</span> <span class="p">|</span> <span class="nb">rune</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&amp;</span><span class="nx">maskx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">pos</span> <span class="o">+=</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">rune2Max</span> <span class="p">&lt;</span> <span class="nx">r</span> <span class="o">&amp;&amp;</span> <span class="p">!(</span><span class="nx">surrogateMin</span> <span class="o">&lt;=</span> <span class="nx">r</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span> <span class="o">&lt;=</span> <span class="nx">surrogateMax</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// [t4, t5) --&gt; [11110000, 11111000)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">case</span> <span class="nx">t4</span> <span class="o">&lt;=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">&lt;</span> <span class="nx">t5</span><span class="p">:</span>   <span class="c1">// è¯¥å­—æ®µ4å­—èŠ‚ç¼–ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 10000-1FFFFF four byte sequence
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">locb</span> <span class="o">&lt;=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">hicb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">locb</span> <span class="o">&lt;=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">hicb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">locb</span> <span class="o">&lt;=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">hicb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">r</span> <span class="p">=</span> <span class="nb">rune</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&amp;</span><span class="nx">mask4</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">18</span> <span class="p">|</span> <span class="nb">rune</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&amp;</span><span class="nx">maskx</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">12</span> <span class="p">|</span> <span class="nb">rune</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&amp;</span><span class="nx">maskx</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">6</span> <span class="p">|</span> <span class="nb">rune</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&amp;</span><span class="nx">maskx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">pos</span> <span class="o">+=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">rune3Max</span> <span class="p">&lt;</span> <span class="nx">r</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span> <span class="o">&lt;=</span> <span class="nx">maxRune</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">runeError</span><span class="p">,</span> <span class="nx">k</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li><code>for-range</code>ä¸èƒ½éå†<code>*string</code>ç±»å‹ã€‚</li>
<li><code>for-range</code>å¯¹äºå­—ç¬¦ä¸²å¹¶æ²¡æœ‰å¤åˆ¶ä¸€ä»½å­—ç¬¦ä¸²è¿›è¡Œç¼–ç ï¼Œå…¶å®ä¹Ÿä¸å¿…è¦å› ä¸ºå­—ç¬¦ä¸²çš„è¯­ä¹‰æœ¬æ¥å°±æ˜¯ä¸å¯å˜æ•°æ®ã€‚</li>
</ol>
<h2 id="è¿­ä»£array">è¿­ä»£<code>array</code><a hidden class="anchor" aria-hidden="true" href="#è¿­ä»£array">#</a></h2>
<ol>
<li><code>range</code>è¿­ä»£<code>array</code>ï¼Œ<code>key</code>ä¸º<code>int</code>ç±»å‹ï¼Œ<code>value</code>ä¸ºæ•°ç»„çš„å…ƒç´ ç±»å‹ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">arr</span> <span class="o">:=</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">arr</span> <span class="p">{</span> <span class="c1">// ã€int, intã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// original body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>ä¸Šé¢è¿­ä»£æ•°ç»„ä»£ç ç­‰æ•ˆäºä¸‹é¢ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 1) è·å–æ•°ç»„é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1">// æ³¨æ„ï¼šè¿™é‡Œæ”¯æŒæŒ‡é’ˆæ•°ç»„ï¼Œæ¯”å¦‚len(*[2]int) == 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">lenTemp</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 2) æ‹·è´æ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1">// æ³¨æ„ï¼šè¿™é‡Œæ”¯æŒæŒ‡é’ˆæ•°ç»„ï¼Œæ¯”å¦‚arræ˜¯*[2]int
</span></span></span><span class="line"><span class="cl"><span class="c1">// è¿™é‡Œä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä½¿ç”¨æ•°ç»„æŒ‡é’ˆå’Œæ•°ç»„æœ¬èº«çš„æ€§èƒ½å·®å¼‚ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1">// ä½¿ç”¨æ•°ç»„æŒ‡é’ˆè¿™é‡Œçš„èµ‹å€¼æ˜¯æŒ‡é’ˆèµ‹å€¼ï¼Œè€Œä½¿ç”¨æ•°ç»„è¿™é‡Œæ˜¯å€¼å¤åˆ¶å½“æ•°æ®é‡å¤§æ—¶æ€§èƒ½å·®åˆ«è¿˜æ˜¯æ¯”è¾ƒæ˜æ˜¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">rangeArr</span> <span class="o">:=</span> <span class="nx">arr</span> <span class="c1">// å¤åˆ¶ä¸€ä»½éœ€è¦éå†çš„æ•°ç»„ï¼Œæ³¨æ„è¿™é‡Œçš„å‰¯æœ¬æ˜¯ä¸åŸæ•°ç»„æ²¡æœ‰ä»»ä½•è”ç³»
</span></span></span><span class="line"><span class="cl"><span class="c1">// 3) key/value
</span></span></span><span class="line"><span class="cl"><span class="c1">// æ³¨æ„ï¼šè¿™é‡Œçš„keyå’Œvalueï¼Œå®šä¹‰åœ¨forå¤–ï¼Œä¹Ÿæ˜¯&amp;iå’Œ&amp;væ˜¯å›ºå®šçš„åŸå› 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span> <span class="kt">int</span>    <span class="c1">// å®šä¹‰éå†éœ€è¦æ¥æ”¶çš„keyå’Œvalueå˜é‡
</span></span></span><span class="line"><span class="cl"><span class="c1">// for rangeçš„ç¼–è¯‘ç­‰åŒä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="nx">indexTemp</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">indexTemp</span> <span class="p">&lt;</span> <span class="nx">lenTemp</span><span class="p">;</span> <span class="nx">indexTemp</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ³¨æ„ï¼šè¿™é‡Œæ”¯æŒæŒ‡é’ˆæ•°ç»„èµ‹å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">valueTemp</span> <span class="o">:=</span> <span class="nx">rangeArr</span><span class="p">[</span><span class="nx">indexTemp</span><span class="p">]</span> <span class="c1">// æ•°ç»„æ”¯æŒè¯­æ³•ç³– 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 4) æ‹·è´èµ‹å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ³¨æ„ï¼šè¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆfor rangeä¸­å–&amp;iå’Œ&amp;våœ°å€æ˜¯å›ºå®šçš„åŸå› 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">i</span> <span class="p">=</span> <span class="nx">indexTemp</span> <span class="c1">// æ‹·è´èµ‹å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">v</span> <span class="p">=</span> <span class="nx">valueTemp</span> <span class="c1">// æ‹·è´èµ‹å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// original body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>æ•°ç»„éå†å’Œåˆ‡ç‰‡éå†æœ€ä¸»è¦çš„åŒºåˆ«å°±æ˜¯éå†å‰¯æœ¬ï¼Œæ•°ç»„çš„å‰¯æœ¬ä¸åŸæ•°ç»„æ²¡æœ‰ä»»ä½•å…³è”åªæ˜¯å€¼å…¨éƒ¨ç›¸åŒè€Œå·²ï¼Œè€Œåˆ‡ç‰‡åˆ™æ˜¯å‰¯æœ¬å’ŒåŸåˆ‡ç‰‡æ•°å…±ç”¨åŒä¸€ä¸ªåº•å±‚æ•°ç»„ã€‚</li>
<li><code>range</code>èƒ½éå†ã€æ•°ç»„æŒ‡é’ˆã€‘è€Œã€<strong>ä¸èƒ½</strong>ã€‘éå†åˆ‡ç‰‡æŒ‡é’ˆï¼Œè¿™å¾—ç›Šäºæ•°å€¼æŒ‡é’ˆåœ¨èµ‹å€¼å’Œ<code>len()</code>å‡½æ•°ä¸ŠGoæ”¯æŒçš„ã€<strong>è¯­æ³•ç³–</strong>ã€‘è½¬æ¢ä½¿å¾—rangeå¯¹æ•°ç»„æŒ‡é’ˆåŒæ ·é€‚ç”¨ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// rangeéå†æŒ‡é’ˆæ•°ç»„æ—¶ï¼Œä¼šè§£å¼•ç”¨æ•°ç»„æŒ‡é’ˆæ‹·è´å‰¯æœ¬éå†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">aa</span> <span class="o">*</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="kt">string</span> <span class="p">=</span> <span class="nb">new</span><span class="p">([</span><span class="mi">2</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) è¯­æ³•ç³–1ï¼šèµ‹å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//(*aa)[0] = &#34;a&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">aa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;a&#34;</span> <span class="c1">// è¯­æ³•ç³–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//(*aa)[1] = &#34;bb&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">aa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;bb&#34;</span><span class="c1">// è¯­æ³•ç³–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// 2) è¯­æ³•ç³–2ï¼šå–å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// c := (*aa)[1]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">aa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1">// è¯­æ³•ç³–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// 3) è¯­æ³•ç³–3ï¼šæ±‚é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// l := len(aa) // len(*aa)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åœ¨Goä¸­æ”¯æŒæ•°ç»„çš„æŒ‡é’ˆç›¸å…³çš„è¯­æ³•ç³–ï¼Œæ‰€ä»¥å¯¼è‡´ä½¿ç”¨æ•°ç»„å’Œæ•°ç»„æŒ‡é’ˆå¥½åƒå¹¶æ²¡æœ‰å¤šå¤§çš„åŒºåˆ«
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ¯”å¦‚æ•°ç»„æŒ‡é’ˆaaèƒ½ä½¿ç”¨aa[0] = &#34;a&#34;è¿™ç§å½¢å¼èµ‹å€¼ï¼Œä¹Ÿèƒ½ä½¿ç”¨len(aa)è¿™ç§å½¢å¼æ±‚é•¿åº¦ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å…¶ä»–ç±»å‹çš„æŒ‡é’ˆåˆ™ä¸æ”¯æŒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™äº›è¯­æ³•ç³–ä¹Ÿå¯¼è‡´äº†èƒ½ä½¿ç”¨rangeéå†æ•°ç»„æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// range æ‹·è´ *aa å‰¯æœ¬éå†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">s</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">aa</span> <span class="p">{</span>  <span class="c1">// å½“æ•°ç»„å¾ˆå¤§æ—¶ï¼Œéå†æ•°ç»„æŒ‡é’ˆæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">aa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;cc&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">aa</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Output:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0 a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 1 cc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// &amp;[a cc]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>éªŒè¯æ•°ç»„éå†æ˜¯å€¼æ‹·è´ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="p">{</span>	
</span></span><span class="line"><span class="cl">    <span class="nx">slice1</span> <span class="o">:=</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿™é‡Œæ‹·è´çš„æ˜¯æ•°ç»„çš„å‰¯æœ¬ï¼Œå› æ­¤ifæ¡ä»¶æˆç«‹ä¸ä¼šå½±å“å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">slice1</span> <span class="p">{</span> <span class="c1">// [4]int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">slice1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">slice1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Output:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 1 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 3 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// [0 1 2 13]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">slice1</span> <span class="o">:=</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿™é‡Œæ‹·è´çš„æ˜¯æ•°ç»„çš„æŒ‡é’ˆï¼Œå› æ­¤ifæ¡ä»¶æˆç«‹ä¼šå½±å“å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="o">&amp;</span><span class="nx">slice1</span> <span class="p">{</span> <span class="c1">// *[4]int
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">slice1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Output:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 1 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 3 13
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="è¿­ä»£slice">è¿­ä»£<code>slice</code><a hidden class="anchor" aria-hidden="true" href="#è¿­ä»£slice">#</a></h2>
<ol>
<li>éå†<code>slice</code>å‰ä¼šå…ˆè·å–<code>slice</code>çš„é•¿åº¦<code>lenTemp</code>æ¥ä½œä¸ºå¾ªç¯æ¬¡æ•°ï¼Œå¾ªç¯ä½“ä¸­ï¼Œæ¯æ¬¡å¾ªç¯ä¼šå…ˆè·å–å…ƒç´ å€¼ã€‚</li>
<li>å¦‚æœ<code>for-range</code>ä¸­æ¥æ”¶<code>index</code>å’Œ<code>value</code>çš„è¯ï¼Œåˆ™ä¼šå¯¹<code>index</code>å’Œ<code>value</code>è¿›è¡Œä¸€æ¬¡èµ‹å€¼ã€‚</li>
<li>æ•°ç»„ä¸æ•°ç»„æŒ‡é’ˆçš„éå†è¿‡ç¨‹ä¸<code>slice</code>åŸºæœ¬ä¸€è‡´ï¼Œä½†æ˜¯ä¹Ÿæœ‰åŒºåˆ«ï¼ŒåŒºåˆ«åœ¨äºå‰¯æœ¬å¤åˆ¶çš„æ˜¯ä¸åŸæ•°ç»„æ˜¯ä¸€ä¸ªå®Œå…¨ä¸ç›¸å¹²çš„æ•°ç»„ã€‚</li>
<li><code>for-range</code>è¿­ä»£<code>slice</code>ï¼Œ<code>key</code>ä¸º<code>int</code>ï¼Œ<code>value</code>ä¸ºå­˜å‚¨çš„å…ƒç´ ç±»å‹ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">slice1</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">slice1</span> <span class="p">{</span> <span class="c1">// ã€int, intã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// original body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>ä¸Šé¢è¿­ä»£åˆ‡ç‰‡ä»£ç ç­‰æ•ˆäºä¸‹é¢ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 1) æ‹·è´åˆ‡ç‰‡
</span></span></span><span class="line"><span class="cl"><span class="c1">// æ³¨æ„ï¼šæ‹·è´çš„åˆ‡ç‰‡ä¸åŸåˆ‡ç‰‡å…±ç”¨äº†åŒä¸€ä¸ªåº•å±‚æ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1">// ä¹Ÿéœ€è¦æ³¨æ„ï¼Œlenå’Œcapä¹Ÿæ‹·è´å…ƒåˆ‡ç‰‡çš„å€¼ï¼Œå› æ­¤for rangeä¿®æ”¹ä¸èµ·ä½œç”¨ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">rangeSlice</span> <span class="o">:=</span> <span class="nx">slice1</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 2) è·å–åˆ‡ç‰‡é•¿åº¦ï¼Œä¹Ÿæ˜¯éå†çš„æ¬¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1">// éå†çš„æ­¤æ—¶åˆ‡ç‰‡é•¿åº¦æ˜¯å›ºå®šçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">lenTemp</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">rangeSlice</span><span class="p">)</span>  <span class="c1">// æ‹¿åˆ°éœ€è¦éå†çš„åˆ‡ç‰‡æ€»é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1">// 3) key/value
</span></span></span><span class="line"><span class="cl"><span class="c1">// æ³¨æ„ï¼šè¿™é‡Œçš„keyå’Œvalueï¼Œå®šä¹‰åœ¨forå¤–ï¼Œä¹Ÿæ˜¯&amp;iå’Œ&amp;væ˜¯å›ºå®šçš„åŸå› 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span> <span class="kt">int</span> <span class="c1">// å®šä¹‰éå†éœ€è¦çš„keyå’Œvalueå˜é‡
</span></span></span><span class="line"><span class="cl"><span class="c1">// for rangeçš„ç¼–è¯‘ç­‰åŒä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="nx">indexTemp</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">indexTemp</span> <span class="p">&lt;</span> <span class="nx">lenTemp</span><span class="p">;</span> <span class="nx">indexTemp</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">valueTemp</span> <span class="o">:=</span> <span class="nx">rangeSlice</span><span class="p">[</span><span class="nx">indexTemp</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 4) æ‹·è´èµ‹å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ³¨æ„ï¼šè¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆfor rangeä¸­å–&amp;iå’Œ&amp;våœ°å€æ˜¯å›ºå®šçš„åŸå› 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">i</span> <span class="p">=</span> <span class="nx">indexTemp</span>
</span></span><span class="line"><span class="cl">    <span class="nx">v</span> <span class="p">=</span> <span class="nx">valueTemp</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// original body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li><strong>ç”±äºå¾ªç¯å¼€å§‹å‰å¾ªç¯æ¬¡æ•°å°±å·²ç»ç¡®å®šäº†ï¼Œæ‰€ä»¥å¾ªç¯è¿‡ç¨‹ä¸­æ–°æ·»åŠ çš„å…ƒç´ æ˜¯æ— æ³•éå†åˆ°çš„ã€‚</strong></li>
<li>ä½†æ˜¯å¾ªç¯è¿‡ç¨‹ä¸­ä¿®æ”¹åé¢è¿˜æœªå¾ªç¯çš„å€¼ï¼Œåˆ™ä¼šå½±å“ï¼Œè¿™æ˜¯ç”±äºåœ¨rangeå¾ªç¯å‰èµ‹å€¼çš„å‰¯æœ¬ä¸åŸåˆ‡ç‰‡å…±ç”¨äº†ä¸€ä¸ªåº•å±‚æ•°ç»„å¯¼è‡´çš„ï¼Œæ‰€ä»¥èƒ½ç›¸äº’å½±å“ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">slice1</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">slice1</span> <span class="p">{</span> <span class="c1">// ã€int, intã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">slice1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Output:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 0 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 1 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 3 13
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="è¿­ä»£channel">è¿­ä»£<code>channel</code><a hidden class="anchor" aria-hidden="true" href="#è¿­ä»£channel">#</a></h2>
<ol>
<li><code>channel</code>éå†æ˜¯ä¾æ¬¡ä»<code>channel</code>ä¸­è¯»å–æ•°æ®ï¼Œè¯»å–å‰æ˜¯ä¸çŸ¥é“é‡Œé¢æœ‰å¤šå°‘ä¸ªå…ƒç´ çš„ã€‚</li>
<li>å¦‚æœ<code>channel</code>ä¸­æ²¡æœ‰å…ƒç´ ï¼Œåˆ™ä¼š<strong>é˜»å¡</strong>ç­‰å¾…ï¼Œå¦‚æœ<code>channel</code>å·²è¢«å…³é—­ï¼Œåˆ™ä¼šè§£é™¤é˜»å¡å¹¶é€€å‡ºå¾ªç¯ã€‚</li>
<li><code>for-range</code>è¿­ä»£<code>channel</code>ï¼Œåªèƒ½è·å–ä¸€ä¸ªå€¼ï¼Œ<code>key</code>ä¸º<code>channel</code>å­˜å‚¨çš„å…ƒç´ ç±»å‹ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// rangeéå†chan
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span> <span class="p">{</span> <span class="c1">// ã€intã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// original body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>ä¸Šé¢è¿­ä»£channelä»£ç ç­‰æ•ˆäºä¸‹é¢ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// è¿™é‡Œæ˜¯&amp;vä¸ºä»€ä¹ˆéƒ½æ˜¯åŒä¸€ä¸ªåœ°å€çš„åŸå› 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">v</span> <span class="kt">int</span> <span class="c1">// vå…¶å®å°±æ˜¯å›ºå®šçš„ä¸€ä¸ªå˜é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ³¨æ„å¦‚æœä¸å…³é—­channelè¿™é‡Œä¼šä¸€ç›´é˜»å¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æˆ‘ä»¬çŸ¥é“ &lt;- ç¬¦å·ä¼šè°ƒç”¨ç›¸å…³çš„å‡½æ•°ï¼Œå¦‚æœchanå…³é—­äº†ä¼šè¿”å›falseé€€å‡ºå¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">value_temp</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span> <span class="nx">c</span>		
</span></span><span class="line"><span class="cl">    <span class="c1">// æœ‰æ•°æ®åˆ™ä¼šç›´æ¥è¿”å›æ•°æ®ï¼Œæ²¡æœ‰æ•°æ®åˆ™ä¼šé˜»å¡ï¼Œé€šè¿‡chançš„å­¦ä¹ çŸ¥é“é˜»å¡æ„å‘³ç€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰goroutineè¢«è°ƒç¦»è°ƒåº¦å¾ªç¯ç­‰å¾…æ•°æ®åˆ°æ¥è¢«é‡æ–°è°ƒèµ·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// ok = falseï¼Œé€šé“å·²ç»å…³é—­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 2) æ‹·è´å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">v</span> <span class="p">=</span> <span class="nx">value_temp</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// original body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>ç¼–è¯‘åçš„ä¼ªä»£ç ï¼Œä¸ä¸Šé¢ç­‰ä»·ã€‚å…³äº<code>chanrecv2()</code>åœ¨channelä¸­ä»‹ç»ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">v</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ok</span> <span class="o">:=</span> <span class="nf">chanrecv2</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">value_temp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">v</span> <span class="p">=</span> <span class="nx">index_temp</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// original body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>æ³¨æ„ï¼š
<ul>
<li>ä½¿ç”¨<code>for-range</code>éå†<code>channel</code>æ—¶åªèƒ½è·å–ä¸€ä¸ªè¿”å›å€¼ã€‚</li>
<li>ã€<code>for-range &lt;-ch</code>ã€‘æƒ…å†µï¼Œè¯¥æƒ…å†µå¯ä»¥ç”¨åœ¨ ã€<code>channel map</code>ã€<code>channel array|*array</code>ã€<code>channel slice</code>ã€<code>channel string</code>ã€‘ã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">chanTs2</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kt">int</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ³¨æ„ï¼šè¿™é‡Œæ˜¯ &lt;-chï¼Œå‰é¢çš„æ˜¯ ch
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="o">&lt;-</span><span class="nx">ch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">println</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ---------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// as   ç­‰ä»·äºä¸‹é¢ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ---------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ³¨æ„ï¼šè¿™é‡Œåªä¼šæ‰§è¡Œä¸€æ¬¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">a</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">ch</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">a</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">println</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="è¿­ä»£map">è¿­ä»£<code>map</code><a hidden class="anchor" aria-hidden="true" href="#è¿­ä»£map">#</a></h2>
<ol>
<li><code>for-range</code>è¿­ä»£<code>map</code>ï¼Œ<code>key</code>ä¸º<code>map</code>çš„é”®ï¼Œ<code>value</code>ä¸º<code>map</code>çš„å€¼ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">map1</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;one&#34;</span><span class="p">:</span><span class="s">&#34;1&#34;</span><span class="p">,</span> <span class="s">&#34;tow&#34;</span><span class="p">:</span><span class="s">&#34;2&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">map1</span> <span class="p">{</span> <span class="c1">// ã€string, stringã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// original body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>ä¸Šé¢è¿­ä»£mapä»£ç ç­‰æ•ˆäºä¸‹é¢ä»£ç ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 1) key/value
</span></span></span><span class="line"><span class="cl"><span class="c1">// è¿™é‡Œä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ&amp;iå’Œ&amp;væ˜¯ä¸€ä¸ªå›ºå®šçš„åœ°å€çš„åŸå› 
</span></span></span><span class="line"><span class="cl"><span class="c1">// å®šä¹‰éå†æ‰€éœ€è¦çš„keyå’Œvalueå˜é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 2) map_iteration_struct
</span></span></span><span class="line"><span class="cl"><span class="c1">// map_iteration_structæ˜¯ä¸€ä¸ªhiterç»“æ„ä½“ï¼Œå­˜å‚¨ç€mapçš„éå†ç›¸å…³ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">hiter</span> <span class="nx">map_iteration_struct</span>	 
</span></span><span class="line"><span class="cl"><span class="c1">// mapiterinit åˆå§‹åŒ–mapå‚çœ‹runtime/map.goæ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1">// hiteræ˜¯ä¸€ä¸ªå“ˆå¸Œè¿­ä»£ç»“æ„ï¼Œmapiternextè¿­ä»£ä¸‹ä¸€ä¸ªå“ˆå¸Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="nf">mapiterinit</span><span class="p">(</span><span class="kd">type</span><span class="p">,</span> <span class="k">range</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">hiter</span><span class="p">);</span> <span class="nx">hiter</span><span class="p">.</span><span class="nx">key</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nf">mapiternext</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">hiter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">index_temp</span> <span class="o">:=</span> <span class="o">*</span><span class="nx">hiter</span><span class="p">.</span><span class="nx">key</span>
</span></span><span class="line"><span class="cl">    <span class="nx">value_temp</span> <span class="o">:=</span> <span class="o">*</span><span class="nx">hiter</span><span class="p">.</span><span class="nx">val</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 3) æ‹·è´æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">i</span> <span class="p">=</span> <span class="nx">index_temp</span>
</span></span><span class="line"><span class="cl">    <span class="nx">v</span> <span class="p">=</span> <span class="nx">value_temp</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// original body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>éå†<code>map</code>æ—¶æ²¡æœ‰æŒ‡å®šå¾ªç¯æ¬¡æ•°ï¼Œå¾ªç¯ä½“ä¸éå†<code>slice</code>ç±»ä¼¼ã€‚ç”±äº<code>map</code>åº•å±‚å®ç°ä¸<code>slice</code>ä¸åŒï¼Œ<code>map</code>åº•å±‚ä½¿ç”¨ <code>hash</code>è¡¨å®ç°çš„ã€‚</li>
<li><strong>æ’å…¥æ•°æ®ä½ç½®æ˜¯éšæœºçš„ï¼Œæ‰€ä»¥éå†è¿‡ç¨‹ä¸­æ–°æ’å…¥çš„æ•°æ®ä¸èƒ½ä¿è¯éå†åˆ°ã€‚</strong></li>
<li>ä»¥ä¸‹ç›¸å…³çš„å‡½æ•°åœ¨<code>map</code>ç¯‡ä¸­è¿˜ä¼šè¯¦ç»†çš„è®¨è®ºã€‚</li>
<li><code>type hiter struct</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// A hash iteration structure.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If you modify hiter, also change cmd/compile/internal/reflectdata/reflect.go
</span></span></span><span class="line"><span class="cl"><span class="c1">// and reflect/value.go to match the layout of this structure.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">hiter</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰éå†çš„keyåœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">key</span>         <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// Must be in first position.  Write nil to indicate iteration end (see cmd/compile/internal/walk/range.go).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰éå†çš„elemåœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">elem</span>        <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// Must be in second position (see cmd/compile/internal/walk/range.go).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰mapçš„ç±»å‹ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">t</span>           <span class="o">*</span><span class="nx">maptype</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰mapçš„å†…å­˜ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">h</span>           <span class="o">*</span><span class="nx">hmap</span>		 
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰mapçš„å¸¸è§„æ¡¶åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">buckets</span>     <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// bucket ptr at hash_iter initialization time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰æ­£åœ¨éå†çš„æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bptr</span>        <span class="o">*</span><span class="nx">bmap</span>          <span class="c1">// current bucket å½“å‰å­˜å‚¨æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// h.extra.overflow
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">overflow</span>    <span class="o">*</span><span class="p">[]</span><span class="o">*</span><span class="nx">bmap</span>       <span class="c1">// keeps overflow buckets of hmap.buckets alive	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// h.extra.oldoverflow
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">oldoverflow</span> <span class="o">*</span><span class="p">[]</span><span class="o">*</span><span class="nx">bmap</span>       <span class="c1">// keeps overflow buckets of hmap.oldbuckets alive 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¼€å§‹éå†çš„æ¡¶å·ï¼Œéšæœºçš„ï¼Œç”¨äºå¼€å§‹éå†çš„èµ·ç‚¹ä»¥åŠç»“æŸéå†çš„ç»ˆç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">startBucket</span> <span class="kt">uintptr</span>        <span class="c1">// bucket iteration started at
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// tophashåç§»å€¼ï¼Œåœ¨[0,7]ä¸­éšæœºç”Ÿæˆçš„å€¼ï¼Œç”¨äºåç»­ i + offset &amp; 7 ç”¨ä½œåç§»é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">offset</span>      <span class="kt">uint8</span>          <span class="c1">// intra-bucket offset to start from during iteration (should be big enough to hold bucketCnt-1) 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰éå†å·²è¿‡æœ€å¤§æ¡¶(1 &lt;&lt; B)æ—¶è¢«è®¾ç½®ä¸ºtrue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">wrapped</span>     <span class="kt">bool</span>           <span class="c1">// already wrapped around from end of bucket array to beginning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åˆå§‹åŒ–æ—¶æ¡¶çš„æ•°é‡ 1 &lt;&lt; B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">B</span>           <span class="kt">uint8</span>   
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰æ¡¶éå†çš„ç´¢å¼•ï¼Œé»˜è®¤å€¼ä»0å¼€å§‹ï¼Œè¯¥å€¼é…åˆoffsetéå†tophashï¼Œi + offset &amp; 7
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">i</span>           <span class="kt">uint8</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆå§‹åŒ–æ—¶æ˜¯startBucketçš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. bptr == nilæ—¶bucketå­˜å‚¨éœ€è¦éå†çš„æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 	2. bptr != nilæ—¶bucketä¸‹ä¸ªæ¡¶çš„æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bucket</span>      <span class="kt">uintptr</span>     <span class="c1">// å­˜å‚¨çš„æ˜¯å½“å‰è¿­ä»£å™¨çš„æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// noCheck.ä¸éœ€è¦æ£€æŸ¥ï¼Œæ•°æ®åœ¨bptræ¡¶é‡Œé¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å…¶ä»–éœ€è¦æ£€æŸ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">checkBucket</span> <span class="kt">uintptr</span>     <span class="c1">// éœ€è¦æ£€æŸ¥çš„æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="7">
<li><code>mapiterinit()</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// mapiterinit initializes the hiter struct used for ranging over maps.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The hiter struct pointed to by &#39;it&#39; is allocated on the stack
</span></span></span><span class="line"><span class="cl"><span class="c1">// by the compilers order pass or on the heap by reflect_mapiterinit.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Both need to have zeroed hiter since the struct contains pointers.
</span></span></span><span class="line"><span class="cl"><span class="c1">// mapiterinit åˆå§‹åŒ–ç”¨äºåœ¨mapä¸Šçš„ hiter ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1">// &#39;it&#39; æŒ‡å‘çš„ hiter ç»“æ„ç”±ç¼–è¯‘å™¨é¡ºåºä¼ é€’åœ¨å †æ ˆä¸Šåˆ†é…ï¼Œæˆ–è€…ç”± reflect_mapiterinit åœ¨å †ä¸Šåˆ†é…ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">// ç”±äºç»“æ„åŒ…å«æŒ‡é’ˆï¼Œå› æ­¤ä¸¤è€…éƒ½éœ€è¦å°† hiter å½’é›¶ã€‚ 
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// è¿­ä»£åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1">// t *maptypeï¼šå½“å‰mapçš„å…ƒç´ ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1">// h *hmapï¼šå½“å‰mapçš„å†…å­˜ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1">// it *hiterï¼šè¿­ä»£å™¨ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mapiterinit</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">it</span> <span class="o">*</span><span class="nx">hiter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">callerpc</span> <span class="o">:=</span> <span class="nf">getcallerpc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nf">racereadpc</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">h</span><span class="p">),</span> <span class="nx">callerpc</span><span class="p">,</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABIInternal</span><span class="p">(</span><span class="nx">mapiterinit</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">it</span><span class="p">.</span><span class="nx">t</span> <span class="p">=</span> <span class="nx">t</span> <span class="c1">// å­˜å‚¨å½“å‰mapçš„ç±»å‹ç»“æ„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">h</span><span class="p">.</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// å¦‚æœå½“å‰mapä¸ºç©ºç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">hiter</span><span class="p">{})</span><span class="o">/</span><span class="nx">goarch</span><span class="p">.</span><span class="nx">PtrSize</span> <span class="o">!=</span> <span class="mi">12</span> <span class="p">{</span> <span class="c1">// åˆ¤æ–­hiterç»“æ„æ˜¯å¦æ­£ç¡®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;hash_iter size incorrect&#34;</span><span class="p">)</span> <span class="c1">// see cmd/compile/internal/reflectdata/reflect.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">it</span><span class="p">.</span><span class="nx">h</span> <span class="p">=</span> <span class="nx">h</span> <span class="c1">// å­˜å‚¨å½“å‰mapçš„å†…å­˜ç»“æ„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// grab snapshot of bucket state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">it</span><span class="p">.</span><span class="nx">B</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span> <span class="c1">// è®°å½•å½“å‰mapçš„æ¡¶æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">it</span><span class="p">.</span><span class="nx">buckets</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span> <span class="c1">// è®°å½•å½“å‰mapçš„å¸¸è§„æ¡¶åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">ptrdata</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// åˆ¤æ–­å½“å‰æ¡¶ç±»å‹çš„ptrdataå­—æ®µï¼Œè¯¥å­—æ®µä¸º0è¯´æ˜å­˜å‚¨çš„éƒ½æ˜¯æ ‡é‡æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åˆ†é…å½“å‰åˆ‡ç‰‡å¹¶è®°ä½æŒ‡å‘å½“å‰åˆ‡ç‰‡å’Œæ—§åˆ‡ç‰‡çš„æŒ‡é’ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å³ä½¿è¡¨å¢é•¿ and/or åœ¨æˆ‘ä»¬è¿­ä»£æ—¶å°†æº¢å‡ºæ¡¶æ·»åŠ åˆ°è¡¨ä¸­ï¼Œè¿™ä¹Ÿä¼šä¿ç•™æ‰€æœ‰ç›¸å…³çš„æº¢å‡ºæ¡¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">h</span><span class="p">.</span><span class="nf">createOverflow</span><span class="p">()</span> <span class="c1">// åˆ›å»ºæº¢å‡ºæ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">it</span><span class="p">.</span><span class="nx">overflow</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">overflow</span>
</span></span><span class="line"><span class="cl">        <span class="nx">it</span><span class="p">.</span><span class="nx">oldoverflow</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">oldoverflow</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// decide where to start
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å†³å®šä»å“ªé‡Œå¼€å§‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">r</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nf">fastrand</span><span class="p">())</span> <span class="c1">// ç”Ÿæˆéšæœºæ•°å†³å®šä»å“ªé‡Œå¼€å§‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// bucketCntBits = 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span> <span class="p">&gt;</span> <span class="mi">31</span><span class="o">-</span><span class="nx">bucketCntBits</span> <span class="p">{</span> <span class="c1">// å¦‚æœå½“å‰çš„æ¡¶æ•° &gt; 31 - 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">r</span> <span class="o">+=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nf">fastrand</span><span class="p">())</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">it</span><span class="p">.</span><span class="nx">startBucket</span> <span class="p">=</span> <span class="nx">r</span> <span class="o">&amp;</span> <span class="nf">bucketMask</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="c1">// ç¡®å®šå¼€å§‹çš„æ¡¶å·ï¼Œè¿™é‡Œä¹Ÿæ˜¯for rangeéšæœºçš„åŸå› 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">it</span><span class="p">.</span><span class="nx">offset</span> <span class="p">=</span> <span class="nb">uint8</span><span class="p">(</span><span class="nx">r</span> <span class="o">&gt;&gt;</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nx">bucketCnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="c1">// å¼€å§‹çš„tophashä½ç½®å¤„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// iterator state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">it</span><span class="p">.</span><span class="nx">bucket</span> <span class="p">=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">startBucket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è®°ä½æˆ‘ä»¬æœ‰ä¸€ä¸ªè¿­ä»£å™¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯ä»¥ä¸å¦ä¸€ä¸ª mapiterinit() å¹¶å‘è¿è¡Œã€‚	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// iterator = 1 å­˜åœ¨æ¡¶æ­£åœ¨åœ¨ä½¿ç”¨è¿­ä»£å™¨æ ‡å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// oldIterator = 2 å­˜åœ¨æ—§æ¡¶æ­£åœ¨ä½¿ç”¨è¿­ä»£å™¨æ ‡å¿—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è®¾ç½®æ­£åœ¨è¿­ä»£çš„æ ‡å¿—ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">old</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="p">;</span> <span class="nx">old</span><span class="o">&amp;</span><span class="p">(</span><span class="nx">iterator</span><span class="p">|</span><span class="nx">oldIterator</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">iterator</span><span class="p">|</span><span class="nx">oldIterator</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">atomic</span><span class="p">.</span><span class="nf">Or8</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">|</span><span class="nx">oldIterator</span><span class="p">)</span> <span class="c1">// åŸå­é”è®¾ç½®hmapçš„flagså‚æ•°æ ‡å¿—æ­£åœ¨ä½¿ç”¨è¿­ä»£å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">mapiternext</span><span class="p">(</span><span class="nx">it</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="8">
<li><code>mapiternext()</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// å‘ä¸‹å¯»æ‰¾ä¸‹ä¸€ä¸ªkey
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mapiternext</span><span class="p">(</span><span class="nx">it</span> <span class="o">*</span><span class="nx">hiter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">h</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">h</span> <span class="c1">// è·å–å½“å‰hmapå†…å­˜ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">callerpc</span> <span class="o">:=</span> <span class="nf">getcallerpc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nf">racereadpc</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">h</span><span class="p">),</span> <span class="nx">callerpc</span><span class="p">,</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABIInternal</span><span class="p">(</span><span class="nx">mapiternext</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰æœ‰hashWritingæ“ä½œæ—¶ï¼Œæ¯”å¦‚m[k]=væˆ–deleteå‡½æ•°æ—¶éƒ½ä¼šæŠ¥é”™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">hashWriting</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;concurrent map iteration and map write&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">t</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">t</span> <span class="c1">// è·å–mapçš„ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æœ¬æ¬¡éœ€è¦éå†çš„æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bucket</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">bucket</span> <span class="c1">// å½“å‰çš„æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æœ¬æ¬¡éœ€è¦éå†çš„æ¡¶ï¼Œå¦‚æœä¸ºnilè¯´æ˜éœ€è¦å»bucketå¯»æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">b</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">bptr</span> <span class="c1">// å½“å‰å­˜å‚¨æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æœ¬æ¬¡åº”è¯¥éå†çš„ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">i</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">i</span> <span class="c1">// éå†ç´¢å¼•é»˜è®¤0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">checkBucket</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">checkBucket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// éå†ä¸€éå½“å‰æ¡¶åŠå…¶æº¢å‡ºæ¡¶ç›´åˆ°b=nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">next</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰æ¡¶éå†å®Œæ—¶ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ¡¶å»éå†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">b</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å½“å‰éå†çš„æ¡¶å’Œå¼€å§‹çš„æ¡¶ç›¸ç­‰ å¹¶ä¸” å·²ç»éå†è¿‡äº†æœ€å¤§æ¡¶æ•°ï¼Œè¯´æ˜éå†äº†ä¸€åœˆäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">bucket</span> <span class="o">==</span> <span class="nx">it</span><span class="p">.</span><span class="nx">startBucket</span> <span class="o">&amp;&amp;</span> <span class="nx">it</span><span class="p">.</span><span class="nx">wrapped</span> <span class="p">{</span> <span class="c1">// ç»“æŸéå†çš„æ¡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// end of iteration
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">it</span><span class="p">.</span><span class="nx">key</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">            <span class="nx">it</span><span class="p">.</span><span class="nx">elem</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// h.growing() å½“å‰æ­£åœ¨æ‰©å®¹ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nf">growing</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">it</span><span class="p">.</span><span class="nx">B</span> <span class="o">==</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span> <span class="p">{</span> <span class="c1">// h.growing()å½“å‰mapæ­£å¤„äºæ‰©å®¹çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿­ä»£å™¨æ˜¯åœ¨å¢é•¿è¿‡ç¨‹ä¸­å¯åŠ¨çš„ï¼Œä½†å¢é•¿å°šæœªå®Œæˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦‚æœæˆ‘ä»¬æŸ¥çœ‹çš„bucketå°šæœªå¡«å……ï¼ˆå³ï¼Œæ—§bucketæœªè¢«æ¸…ç©ºï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦éå†æ—§bucketsï¼Œåªè¿”å›å°†è¿ç§»åˆ°æ­¤bucketçš„bucketsã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">oldbucket</span> <span class="o">:=</span> <span class="nx">bucket</span> <span class="o">&amp;</span> <span class="nx">it</span><span class="p">.</span><span class="nx">h</span><span class="p">.</span><span class="nf">oldbucketmask</span><span class="p">()</span> <span class="c1">// æ—§æ¡¶çš„æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">b</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">oldbuckets</span><span class="p">,</span> <span class="nx">oldbucket</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>	<span class="c1">// è·å–æ¡¶ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å½“å‰æ¡¶çš„tophash[0]ä¸æ˜¯2|3|4æ—¶ï¼Œè¯´æ˜æ•°æ®æ²¡æœ‰è¢«è¿ç§»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">!</span><span class="nf">evacuated</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">                <span class="nx">checkBucket</span> <span class="p">=</span> <span class="nx">bucket</span> <span class="c1">// éœ€è¦æ£€æŸ¥çš„æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// è¯´æ˜æ•°æ®åœ¨æ–°æ¡¶é‡Œé¢ï¼Œæ•°æ®å·²è¢«è¿ç§»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">b</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="nx">bucket</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>	
</span></span><span class="line"><span class="cl">                <span class="nx">checkBucket</span> <span class="p">=</span> <span class="nx">noCheck</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// 1.æ²¡æœ‰æ‰©å®¹ 2.æ‰©å®¹äº†ä½†æ˜¯it.B != h.B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">b</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="nx">bucket</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span> <span class="c1">// æ–°æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">checkBucket</span> <span class="p">=</span> <span class="nx">noCheck</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">bucket</span><span class="o">++</span> <span class="c1">// æ¡¶å·åŠ ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å½“å‰æ¡¶å·ç­‰äºæœ€å¤§æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">bucket</span> <span class="o">==</span> <span class="nf">bucketShift</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// bucketShift(it.B) ç­‰äº 1 &gt;&gt; B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">bucket</span> <span class="p">=</span> <span class="mi">0</span> <span class="c1">// æ ‡è®°ä»0å·æ¡¶å¼€å§‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">it</span><span class="p">.</span><span class="nx">wrapped</span> <span class="p">=</span> <span class="kc">true</span> <span class="c1">// æ ‡è®°å·²ç»è¿‡äº†æœ€å¤§æ¡¶äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span> <span class="c1">// æ–°æ¡¶é‡ç½®ç´¢å¼•ä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// éå†å½“å‰æ¡¶çš„æ‰€æœ‰å…ƒç´ 	bucketCnt = 8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä»å½“å‰æ¡¶éå†æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">bucketCnt</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">offi</span> <span class="o">:=</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">it</span><span class="p">.</span><span class="nx">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nx">bucketCnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// æ ¹æ®it.offsetåç§»é‡å¼€å§‹éšæœºéå†å…ƒç´ [0,7]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// b.tophash[offi] &lt;= 1 æˆ– evacuatedEmpty = 4 è¡¨ç¤ºæ¡¶æ•°æ®ä¸ºç©º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nf">isEmpty</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">offi</span><span class="p">])</span> <span class="o">||</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">offi</span><span class="p">]</span> <span class="o">==</span> <span class="nx">evacuatedEmpty</span> <span class="p">{</span> <span class="c1">// å¦‚æœå½“å‰ä½ç½®ä¸º0æˆ–1æˆ–4è¡¨ç¤ºæ¡¶ä¸ºç©º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">k</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">offi</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span> <span class="c1">// åç§»åˆ°å½“å‰keyä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectkey</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// åˆ¤æ–­å½“å‰keyå­˜å‚¨æ˜¯å¦æ˜¯å·²æŒ‡é’ˆå­˜å‚¨è€Œä¸æ˜¯å­˜å‚¨çš„keyæœ¬èº«
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">k</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">k</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åç§»åˆ°å½“å‰elemä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">e</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">)</span><span class="o">+</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">offi</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elemsize</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">        <span class="c1">// checkBucket != noCheck æ•°æ®åœ¨æ—§æ¡¶ å¹¶ä¸” !h.sameSizeGrow() ç¿»å€æ‰©å®¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// éœ€è¦éªŒè¯æ¡¶æ—¶ï¼Œæ—§æ¡¶å­˜åœ¨æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">checkBucket</span> <span class="o">!=</span> <span class="nx">noCheck</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">h</span><span class="p">.</span><span class="nf">sameSizeGrow</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// å­˜åœ¨æ²¡æœ‰è¿ç§»å®Œçš„æ—§æ¡¶æ—¶ï¼Œå»æ£€æŸ¥æ—§æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// t.reflexivekey() ä¸ºtrueè¡¨ç¤º k == k å§‹ç»ˆæˆç«‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// t.reflexivekey() || t.key.equal(k, k) -&gt; k == k å§‹ç»ˆæˆç«‹æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">reflexivekey</span><span class="p">()</span> <span class="o">||</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nf">equal</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// å¦‚æœoldbucketä¸­çš„é¡¹ä¸æ˜¯é’ˆå¯¹è¿­ä»£ä¸­çš„å½“å‰æ–°bucketï¼Œè¯·è·³è¿‡å®ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">hash</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">hasher</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">hash</span><span class="o">&amp;</span><span class="nf">bucketMask</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">checkBucket</span> <span class="p">{</span> <span class="c1">// éœ€è¦è·³è¿‡çš„æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">//  k == k ä¸æ˜¯å§‹ç»ˆæˆç«‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// b.tophash[offi]&amp;1 çš„æœ€ä½ä½ å‚çœ‹æ•°æ®è¿ç§»éƒ¨åˆ†çš„å»å‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">checkBucket</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">B</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">offi</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// å°†æ‰¾åˆ°çš„kå’Œeä¿å­˜åˆ°hiterä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// evacuatedX = 2ã€evacuatedY = 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// b.tophash[offi] != evacuatedX &amp;&amp; b.tophash[offi] != evacuatedY å­˜åœ¨æœ‰æ•ˆæ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// !(t.reflexivekey() || t.key.equal(k, k))	 -&gt; x == x ä¸æ˜¯å§‹ç»ˆæˆç«‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">offi</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">evacuatedX</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">offi</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">evacuatedY</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="p">!(</span><span class="nx">t</span><span class="p">.</span><span class="nf">reflexivekey</span><span class="p">()</span> <span class="o">||</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nf">equal</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">k</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// è¿™æ˜¯éœ€è¦çš„æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥è¿”å›å®ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æˆ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// key!=keyï¼Œå› æ­¤æ— æ³•åˆ é™¤æˆ–æ›´æ–°æ¡ç›®ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åªè¿”å›å®ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿™å¯¹æˆ‘ä»¬æ¥è¯´å¾ˆå¹¸è¿ï¼Œå› ä¸ºå½“key!=keyå…³é”®æ˜¯æˆ‘ä»¬æ‰¾ä¸åˆ°å®ƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">it</span><span class="p">.</span><span class="nx">key</span> <span class="p">=</span> <span class="nx">k</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectelem</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">e</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">it</span><span class="p">.</span><span class="nx">elem</span> <span class="p">=</span> <span class="nx">e</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// æ•°æ®è¢«è¿ç§»åˆ°å…¶ä»–åœ°æ–¹äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è‡ªä»è¿­ä»£å™¨å¯åŠ¨ä»¥æ¥ï¼Œå“ˆå¸Œè¡¨ä¸€ç›´åœ¨å¢é•¿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿™ä¸ªkeyçš„æ•°æ®ç°åœ¨åœ¨å…¶ä»–åœ°æ–¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æ£€æŸ¥æ•°æ®çš„å½“å‰å“ˆå¸Œè¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æ­¤ä»£ç å¤„ç†ä»¥ä¸‹æƒ…å†µï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//	å·²è¢«åˆ é™¤ã€æ›´æ–°æˆ–åˆ é™¤å¹¶é‡æ–°æ’å…¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//	æ³¨æ„ï¼šæˆ‘ä»¬éœ€è¦é‡æ–°æ ‡è®°å¯†é’¥ï¼Œå› ä¸ºå®ƒå¯èƒ½å·²æ›´æ–°ä¸ºequal()ï¼Œä½†ä¸æ˜¯ç›¸åŒçš„keyï¼ˆä¾‹å¦‚+0.0 vs-0.0ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">rk</span><span class="p">,</span> <span class="nx">re</span> <span class="o">:=</span> <span class="nf">mapaccessK</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="c1">// æ ¹æ®keyå»å¯»æ‰¾ç›¸åº”çš„æ•°æ®ï¼Œå¯èƒ½æ˜¯æ–°æ¡¶ä¹Ÿå¯èƒ½æ˜¯æ—§æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æ¯å¯»æ‰¾åˆ°ï¼Œå¯èƒ½keyå·²è¢«åˆ é™¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">rk</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span> <span class="c1">// key has been deleted
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">it</span><span class="p">.</span><span class="nx">key</span> <span class="p">=</span> <span class="nx">rk</span>
</span></span><span class="line"><span class="cl">            <span class="nx">it</span><span class="p">.</span><span class="nx">elem</span> <span class="p">=</span> <span class="nx">re</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">it</span><span class="p">.</span><span class="nx">bucket</span> <span class="p">=</span> <span class="nx">bucket</span> <span class="c1">// å›å†™æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è®°å½•å½“å‰æ­£åœ¨éå†çš„æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">it</span><span class="p">.</span><span class="nx">bptr</span> <span class="o">!=</span> <span class="nx">b</span> <span class="p">{</span> <span class="c1">// avoid unnecessary write barrier; see issue 14921
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">it</span><span class="p">.</span><span class="nx">bptr</span> <span class="p">=</span> <span class="nx">b</span>	<span class="c1">// é¿å…ä¸å¿…è¦çš„å†™å…¥éšœç¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">it</span><span class="p">.</span><span class="nx">i</span> <span class="p">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1">// iåŠ ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">it</span><span class="p">.</span><span class="nx">checkBucket</span> <span class="p">=</span> <span class="nx">checkBucket</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="c1">// å¦‚æœä¸Šé¢æ¡¶éå†å®Œæ¥åˆ°å»åé¢æ¡¶æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="nx">next</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="9">
<li><code>mapaccessK()</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// returns both key and elem. Used by map iterator
</span></span></span><span class="line"><span class="cl"><span class="c1">// æ ¹æ®keyæ‰¾åˆ°ç›¸åº”çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mapaccessK</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">key</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">h</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">h</span><span class="p">.</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">hash</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">hasher</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span><span class="p">))</span> <span class="c1">// å½“å‰keyç”Ÿæˆçš„hashå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">m</span> <span class="o">:=</span> <span class="nf">bucketMask</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="c1">// (1 &lt;&lt; B) - 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">b</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="p">(</span><span class="nx">hash</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span> <span class="c1">// keyå­˜å‚¨çš„å½“å‰æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ˜¯å¦åœ¨æ‰©å®¹ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">c</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">oldbuckets</span><span class="p">;</span> <span class="nx">c</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nx">h</span><span class="p">.</span><span class="nf">sameSizeGrow</span><span class="p">()</span> <span class="p">{</span>	<span class="c1">// ç¿»å€æ‰©å®¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// There used to be half as many buckets; mask down one more power of two.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">m</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å»æ—§æ¡¶é‡Œé¢æŸ¥çœ‹æ•°æ®æ˜¯å¦è¢«è¿ç§»äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">oldb</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="p">(</span><span class="nx">hash</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>	
</span></span><span class="line"><span class="cl">        <span class="c1">// æ•°æ®æ²¡æœ‰è¢«è¿ç§» tophash[0] != [2,3,4]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nf">evacuated</span><span class="p">(</span><span class="nx">oldb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">b</span> <span class="p">=</span> <span class="nx">oldb</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">top</span> <span class="o">:=</span> <span class="nf">tophash</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span> <span class="c1">// tophash
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">bucketloop</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// éå†å½“å‰æ¡¶åŠæº¢å‡ºæ¡¶å¯»æ‰¾ key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">;</span> <span class="nx">b</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">bucketCnt</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">top</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">emptyRest</span> <span class="p">{</span> <span class="c1">// emptyRest = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">break</span> <span class="nx">bucketloop</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// æ‰¾åˆ°äº†key 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 1. å¯èƒ½æ˜¯hashå†²çªåˆ™è¿˜éœ€è¦å‘åå»æŸ¥æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 2. ç¡®å®æ‰¾åˆ°äº†keyç›´æ¥è¿”å›å³å¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">k</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectkey</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">k</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">k</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// keyåŒ¹é…æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nf">equal</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">e</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">)</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elemsize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectelem</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">e</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">e</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æ€»ç»“">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“">#</a></h2>
<ol>
<li><code>for-range</code>ä¸æ”¯æŒã€<strong>å­—ç¬¦ä¸²æŒ‡é’ˆ</strong>ã€‘ã€ã€<strong>åˆ‡ç‰‡æŒ‡é’ˆ</strong>ã€‘ã€ã€<strong>mapæŒ‡é’ˆ</strong>ã€‘ã€ã€<strong>channelæŒ‡é’ˆ</strong>ã€‘ï¼Œä½†æ”¯æŒã€<strong>æ•°ç»„æŒ‡é’ˆ</strong>ã€‘éå†ã€‚</li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://heliu.site/tags/golang/">Golang</a></li>
      <li><a href="https://heliu.site/tags/%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/">æµç¨‹æ§åˆ¶</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://heliu.site/posts/golang/process/for/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>æµç¨‹æ§åˆ¶(å¾ªç¯è¯­å¥)</span>
  </a>
  <a class="next" href="https://heliu.site/posts/golang/process/switch/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>æµç¨‹æ§åˆ¶(switch)</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
    </span>
    <span id="busuanzi_container_site_uv">
        æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
    </span>
    </div>
        <span>Copyright Â© 2024 èœ€ICPå¤‡2024091074å· <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
