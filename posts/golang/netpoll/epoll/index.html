<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Golang epoll | Helium</title>
<meta name="keywords" content="golang, netpoll">
<meta name="description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬">
<meta name="author" content="helium">
<link rel="canonical" href="https://heliu.site/posts/golang/netpoll/epoll/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://heliu.site/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://heliu.site/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://heliu.site/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://heliu.site/apple-touch-icon.png">
<link rel="mask-icon" href="https://heliu.site/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://heliu.site/posts/golang/netpoll/epoll/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="Golang epoll" />
<meta property="og:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://heliu.site/posts/golang/netpoll/epoll/" />
<meta property="og:image" content="https://heliu.site/favicon-32x32.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-07-20T21:59:40+08:00" />
<meta property="article:modified_time" content="2024-07-20T21:59:40+08:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://heliu.site/favicon-32x32.png" />
<meta name="twitter:title" content="Golang epoll"/>
<meta name="twitter:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://heliu.site/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Golang",
      "item": "https://heliu.site/posts/golang/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ç¬¬16ç«  netpoll",
      "item": "https://heliu.site/posts/golang/netpoll/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Golang epoll",
      "item": "https://heliu.site/posts/golang/netpoll/epoll/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Golang epoll",
  "name": "Golang epoll",
  "description": "ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18+ç‰ˆæœ¬",
  "keywords": [
    "golang", "netpoll"
  ],
  "articleBody": " ä»¥ä¸‹æ¥è‡ªgo1.19.3/src/runtime/netpoll_epoll.goæ–‡ä»¶ã€‚ æœ¬ç¯‡æ–‡ç« æ˜¯é’ˆå¯¹netpoll_epoll.goæ–‡ä»¶çš„æºç èµ°è¯»ã€‚ variables 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 var ( // epoll æè¿°ç¬¦, epollcreate å‡½æ•°åˆ›å»ºè¿”å›çš„æ–‡ä»¶æè¿°ç¬¦ epfd int32 = -1 // epoll descriptor // ä¿å­˜çš„æ˜¯pipe2()æˆ–pip()å‡½æ•°åˆ›å»ºçš„è¯»å†™æè¿°ç¬¦ï¼Œpip2()æˆ–pip()å‡½æ•°åˆ›å»ºçš„readå’Œwriteï¼Œåªè¦ä»»æ„ä¸€æ–¹æ“ä½œå¦ä¸€æ–¹èƒ½è·å–åˆ°æ•°æ® // netpollBreakRdä¼šè¢«æ³¨å†Œåˆ°epollä¸­ï¼Œå½“å†™æè¿°ç¬¦å‘é‡Œå†™æ•°æ®æ—¶ä¼šè§¦å‘waitç›‘å¬å‡½æ•°è¿”å›å°±ç»ªçš„äº‹ä»¶é›† // è¿™å¯¹è¯»å†™æè¿°ç¬¦çš„ä½œç”¨åœ¨äºé€šä¿¡ï¼Œå½“æœ‰å…¶ä»–åç¨‹åœ¨waité˜»å¡ç­‰å¾…æ—¶ï¼Œå¯ä»¥é€šè¿‡å†™æè¿°ç¬¦å†™å…¥æ•°æ®è®©ç­‰å¾…çš„åç¨‹è¿”å› // ä¸»è¦é’ˆå¯¹ epoll_wait() å‡½æ•°é˜»å¡çš„çº¿ç¨‹ï¼Œé€šè¿‡è¿™é‡Œçš„äº‹ä»¶ä½¿è°ƒç”¨ epoll_wait() å‡½æ•°çš„çº¿ç¨‹é™·å…¥å†…æ ¸è¿”å›ã€‚ // å¯¹äº epoll_wait() çš„ timeout å‚æ•°ä¸º0çš„æƒ…å†µï¼Œè¿™é‡Œçš„äº‹ä»¶ä¼šè¢«å¿½ç•¥ netpollBreakRd, netpollBreakWr uintptr // for netpollBreak // ç”¨äºé¿å…é‡å¤è°ƒç”¨ netpollBreak() // åœ¨å‘netpollBreakWrä¸­å†™å…¥æ•°æ®æ—¶ï¼Œè¯¥å€¼ä¼šä»0å˜æˆ1ï¼Œæ§åˆ¶åªå†™ä¸€æ¬¡æ ‡å¿—ç¬¦å· // è¯¥å‚æ•°æ˜¯åŸå­æ€§çš„ netpollWakeSig uint32 // used to avoid duplicate calls of netpollBreak ) netpollGenericInit() åˆå§‹åŒ–netpollã€‚go1.19.3/src/runtime/netpoll.goæ–‡ä»¶ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func netpollGenericInit() { // var netpollInited uint32 // æ˜¯å¦å·²åˆå§‹åŒ–epollæ ‡å¿— 0.æœªåˆå§‹åŒ– 1.å·²åˆå§‹åŒ– if atomic.Load(\u0026netpollInited) == 0 { // var netpollInitLock mutex åˆå§‹åŒ– lockInit(\u0026netpollInitLock, lockRankNetpollInit) lock(\u0026netpollInitLock) // è¿™é‡Œéœ€è¦åˆ¤æ–­ netpollInited == 0ï¼›åŸå› åœ¨äºå¯èƒ½å­˜åœ¨å¤šä¸ªåç¨‹å¹¶å‘åœ¨ç­‰å¾…åˆå§‹åŒ–epoll // å½“è¿™äº›åç¨‹è·å–çš„é”æƒé™æ—¶ï¼Œè¿™é‡Œçš„netpollInitedå·²è¢«è®¾ç½®æˆ1äº†ï¼Œå·²ç»è¢«åˆå§‹åŒ–äº† if netpollInited == 0 { netpollinit() // åˆå§‹åŒ–netpoll atomic.Store(\u0026netpollInited, 1)\t// netpollInited } unlock(\u0026netpollInitLock) } } netpollinit() go1.19.3/src/runtime/netpoll_epoll.goã€‚ è°ƒç”¨epollcreateåˆ›å»ºnetpollerã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 func netpollinit() { // epollcreate å‡½æ•°å†…ä¼šè°ƒç”¨ epollcreate1 // _EPOLL_CLOEXECï¼šå½“å‰è¿›ç¨‹forkå‡ºæ¥çš„ä»»ä½•å­è¿›ç¨‹åœ¨æ‰§è¡Œå‰éƒ½ä¼šå…³é—­epollæè¿°ç¬¦ï¼Œä¹Ÿå› æ­¤ï¼Œå­è¿›ç¨‹ä¸èƒ½å¤Ÿè®¿é—®epollå®ä¾‹ epfd = epollcreate1(_EPOLL_CLOEXEC) // å°äº0è¡¨ç¤ºåˆ›å»ºå‡ºé”™ï¼Œå¤§äº0è¡¨ç¤ºè¿”å›çš„åˆ›å»ºåçš„æ–‡ä»¶å¥æŸ„ID if epfd \u003c 0 {\tepfd = epollcreate(1024) if epfd \u003c 0 { println(\"runtime: epollcreate failed with\", -epfd) throw(\"runtime: netpollinit failed\") } // ç³»ç»Ÿè°ƒç”¨ fcntl è®¾ç½® FD_CLOEXECï¼Œå‚çœ‹ epollcreate1 å‡½æ•°å‚æ•° // fcntlï¼šfd, F_SETFD, FD_CLOEXEC closeonexec(epfd) } // åˆ›å»ºä¸€ä¸ªç”¨äºé€šä¿¡çš„ç®¡é“,è¿”å›è¯»å†™,ä¸»è¦ç”¨äºé‚£äº›ç­‰å¾…åœ¨IOè½®è¯¢ä¸­çš„çº¿ç¨‹é€šä¿¡ // åˆ›å»ºä¸€ä¸ªéé˜»å¡å¼pipeï¼Œç”¨æ¥å”¤é†’é˜»å¡ä¸­çš„ netpollerã€‚ // pipe2(_O_NONBLOCK | _O_CLOEXEC) r, w, errno := nonblockingPipe() // ä¸»è¦ç”¨äºBreakç›¸å…³çš„å‡½æ•°ï¼Œä¸»è¦ç”¨äºç½‘ç»œè½®è¯¢å”¤é†’ä¿¡å· if errno != 0 { println(\"runtime: pipe failed with\", -errno) throw(\"runtime: pipe failed\") } // epollevent æ˜¯äº‹ä»¶ç±»å‹ // type epollevent struct { //\tevents uint32 // äº‹ä»¶ç±»å‹ //\tdata [8]byte // å­˜å‚¨ç”¨æˆ·æ•°æ®ï¼Œåˆšå¥½æ˜¯ä¸€ä¸ªæŒ‡é’ˆå­˜å‚¨çš„å¤§å°ï¼Œè¯¥æ•°æ®ç”¨æˆ·æ˜¯å¯ä»¥ä¿®æ”¹çš„ // } ev := epollevent{ // æ³¨æ„ï¼šè¿™é‡Œé»˜è®¤æ³¨å†Œçš„æ˜¯æ°´å¹³è§¦å‘ï¼Œå› æ­¤ä¼šä¸€ç›´è§¦å‘ events: _EPOLLIN, // EPOLLIN è¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¯»ï¼ˆåŒ…æ‹¬å¯¹ç«¯SOCKETæ­£å¸¸å…³é—­ï¼‰ } // var netpollBreakRd uintptr *(**uintptr)(unsafe.Pointer(\u0026ev.data)) = \u0026netpollBreakRd // ev.data = \u0026netpollBreakRd // å°†è¯»å–æ•°æ®çš„æ–‡ä»¶æè¿°ç¬¦åŠ å…¥ç›‘å¬ï¼Œå½“ä½¿ç”¨wå†™æ•°æ®æ—¶ï¼Œè¯¥rä¼šè¢«è§¦å‘ // func epollctl(epfd, op, fd int32, ev *epollevent) int32 // _EPOLL_CTL_ADD å°†ç›®æ ‡æ–‡ä»¶æè¿°ç¬¦fdæ·»åŠ åˆ°epollæè¿°ç¬¦epfdä¸­ï¼Œå¹¶å°†äº‹ä»¶eventä¸fdé“¾æ¥çš„å†…éƒ¨æ–‡ä»¶å…³è”èµ·æ¥ã€‚ errno = epollctl(epfd, _EPOLL_CTL_ADD, r, \u0026ev) // r è¢«æ·»åŠ åˆ°epollä¸­ if errno != 0 { println(\"runtime: epollctl failed with\", -errno) throw(\"runtime: epollctl failed\") } // netpollBreakRdã€netpollBreakWr æ˜¯éé˜»å¡ç®¡é“ä¸¤ç«¯çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œåˆ†åˆ«è¢«ç”¨ä½œè¯»å–ç«¯å’Œå†™å…¥ç«¯ã€‚ // è¯»å–ç«¯ netpollBreakRd è¢«æ·»åŠ åˆ° epoll ä¸­ç›‘å¬ _EPOLLIN äº‹ä»¶ï¼Œåç»­ä»å†™å…¥ç«¯netpollBreakWr // å†™å…¥æ•°æ®å°±èƒ½å”¤é†’é˜»å¡ä¸­çš„ pollerã€‚ netpollBreakRd = uintptr(r) // netpollBreakRdä¿å­˜pip2çš„read netpollBreakWr = uintptr(w) // netpollBreakRdä¿å­˜pip2çš„write } netpollopen() æŠŠè¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦fdå’Œä¸ä¹‹å…³è”çš„pollDescç»“æ„æ·»åŠ åˆ°pollerå®ä¾‹ä¸­ã€‚ è¯¥æ–¹æ³•å¯¹äºä¸€ä¸ªsocketåªéœ€è°ƒç”¨ä¸€æ¬¡å³å¯ï¼Œè¡¨ç¤ºæ³¨å†Œfdåˆ°epollä¸­ã€‚ å‚æ•°ï¼š fd uintptrï¼šæ–‡ä»¶æè¿°ç¬¦ã€‚ pd *pollDescï¼šç”¨æˆ·æ•°æ®ã€‚ è¿”å›å€¼ï¼šint32ï¼š0-æ³¨å†ŒæˆåŠŸã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func netpollopen(fd uintptr, pd *pollDesc) int32 { // type epollevent struct { // events uint32 // äº‹ä»¶ç±»å‹ // data [8]byte // å­˜å‚¨ç”¨æˆ·æ•°æ®ï¼Œåˆšå¥½æ˜¯ä¸€ä¸ªæŒ‡é’ˆå­˜å‚¨çš„å¤§å°ï¼Œè¯¥æ•°æ®ç”¨æˆ·æ˜¯å¯ä»¥ä¿®æ”¹çš„ // } var ev epollevent // EPOLLINï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¯»ï¼ˆåŒ…æ‹¬å¯¹ç«¯SOCKETæ­£å¸¸å…³é—­ï¼‰ // EPOLLOUTï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥å†™ // EPOLLRDHUPï¼šå¯¹ç«¯æè¿°ç¬¦äº§ç”Ÿä¸€ä¸ªæŒ‚æ–­äº‹ä»¶ï¼Œæ¯”å¦‚æ¥è‡ªå¯¹ç«¯çš„socketæŒ‚æ–­äº‹ä»¶ç­‰ // EPOLLETï¼šå°†EPOLLè®¾ä¸ºè¾¹ç¼˜è§¦å‘(Edge Triggered)æ¨¡å¼ï¼Œè¿™æ˜¯ç›¸å¯¹äºæ°´å¹³è§¦å‘(Level Triggered)æ¥è¯´çš„ // pollDescï¼šç±»å‹çš„æ•°æ®ç»“æ„pdä½œä¸ºä¸fdå…³è”çš„è‡ªå®šæ•°æ®ä¼šè¢«ä¸€åŒæ·»åŠ åˆ°epollä¸­ã€‚ ev.events = _EPOLLIN | _EPOLLOUT | _EPOLLRDHUP | _EPOLLET // epollevent æ˜¯ç”±eventså’Œdataç»„æˆï¼Œdataæ¥è‡ªç”¨æˆ·ç©ºé—´ä¼ å…¥çš„æ•°æ® *(**pollDesc)(unsafe.Pointer(\u0026ev.data)) = pd // ev.data = pd // _EPOLL_CTL_ADD å°†ç›®æ ‡æ–‡ä»¶æè¿°ç¬¦fdæ·»åŠ åˆ°epollæè¿°ç¬¦epfdä¸­ï¼Œå¹¶å°†äº‹ä»¶eventä¸fdé“¾æ¥çš„å†…éƒ¨æ–‡ä»¶å…³è”èµ·æ¥ã€‚ return -epollctl(epfd, _EPOLL_CTL_ADD, int32(fd), \u0026ev) } è§¦å‘æ¨¡å¼LT\\ ETï¼š æ°´å¹³è§¦å‘ï¼šLT å¯¹äºè¯»æ“ä½œï¼Œåªè¦ç¼“å†²å†…å®¹ä¸ä¸ºç©ºï¼ŒLTæ¨¡å¼è¿”å›è¯»å°±ç»ªã€‚ å¯¹äºå†™æ“ä½œï¼Œåªè¦ç¼“å†²åŒºè¿˜ä¸æ»¡ï¼ŒLTæ¨¡å¼ä¼šè¿”å›å†™å°±ç»ªã€‚ æ°´å¹³è§¦å‘æè¿°ï¼š å½“è¢«ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šæœ‰å¯è¯»å†™äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œepoll_wait()ä¼šé€šçŸ¥å¤„ç†ç¨‹åºå»è¯»å†™ã€‚ å¦‚æœè¿™æ¬¡æ²¡æœ‰æŠŠæ•°æ®ä¸€æ¬¡æ€§å…¨éƒ¨è¯»å†™å®Œ(å¦‚è¯»å†™ç¼“å†²åŒºå¤ªå°)ï¼Œé‚£ä¹ˆä¸‹æ¬¡è°ƒç”¨ epoll_wait()æ—¶ï¼Œå®ƒè¿˜ä¼šé€šçŸ¥ä½ åœ¨ä¸Šæ²¡è¯»å†™å®Œçš„æ–‡ä»¶æè¿°ç¬¦ä¸Šç»§ç»­è¯»å†™ï¼Œå½“ç„¶å¦‚æœä½ ä¸€ç›´ä¸å»è¯»å†™ï¼Œå®ƒä¼šä¸€ç›´é€šçŸ¥ä½ ã€‚ å¦‚æœç³»ç»Ÿä¸­æœ‰å¤§é‡ä½ ä¸éœ€è¦è¯»å†™çš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œå®ƒä»¬æ¯æ¬¡éƒ½ä¼šè¿”å›ï¼Œè¿™æ ·ä¼šå¤§å¤§é™ä½å¤„ç†ç¨‹åºæ£€ç´¢è‡ªå·±å…³å¿ƒçš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦çš„æ•ˆç‡ã€‚ è¾¹ç¼˜è§¦å‘ï¼šET å¯¹äºè¯»æ“ä½œï¼š å½“ç¼“å†²åŒºç”±ä¸å¯è¯»å˜ä¸ºå¯è¯»çš„æ—¶å€™ï¼Œå³ç¼“å†²åŒºç”±ç©ºå˜ä¸ºä¸ç©ºçš„æ—¶å€™ã€‚ å½“æœ‰æ–°æ•°æ®åˆ°è¾¾æ—¶ï¼Œå³ç¼“å†²åŒºä¸­çš„å¾…è¯»æ•°æ®å˜å¤šçš„æ—¶å€™ã€‚ å½“ç¼“å†²åŒºæœ‰æ•°æ®å¯è¯»ï¼Œä¸”åº”ç”¨è¿›ç¨‹å¯¹ç›¸åº”çš„æè¿°ç¬¦è¿›è¡ŒEPOLL_CTL_MODä¿®æ”¹EPOLLINäº‹ä»¶æ—¶ã€‚ å¯¹äºå†™æ“ä½œï¼š å½“ç¼“å†²åŒºç”±ä¸å¯å†™å˜ä¸ºå¯å†™æ—¶ã€‚ å½“æœ‰æ—§æ•°æ®è¢«å‘é€èµ°ï¼Œå³ç¼“å†²åŒºä¸­çš„å†…å®¹å˜å°‘çš„æ—¶å€™ã€‚ å½“ç¼“å†²åŒºæœ‰ç©ºé—´å¯å†™ï¼Œä¸”åº”ç”¨è¿›ç¨‹å¯¹ç›¸åº”çš„æè¿°ç¬¦è¿›è¡ŒEPOLL_CTL_MODä¿®æ”¹EPOLLOUTäº‹ä»¶æ—¶ã€‚ è¾¹ç¼˜è§¦å‘æè¿°ï¼š å½“è¢«ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šæœ‰å¯è¯»å†™äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œepoll_wait()ä¼šé€šçŸ¥å¤„ç†ç¨‹åºå»è¯»å†™ã€‚ å¦‚æœè¿™æ¬¡æ²¡æœ‰æŠŠæ•°æ®å…¨éƒ¨è¯»å†™å®Œ(å¦‚è¯»å†™ç¼“å†²åŒºå¤ªå°)ï¼Œé‚£ä¹ˆä¸‹æ¬¡è°ƒç”¨ epoll_wait()æ—¶ï¼Œå®ƒä¸ä¼šé€šçŸ¥ä½ ï¼Œä¹Ÿå°±æ˜¯å®ƒåªä¼šé€šçŸ¥ä½ ä¸€æ¬¡ï¼Œç›´åˆ°è¯¥æ–‡ä»¶æè¿°ç¬¦ä¸Šå‡ºç°ç¬¬äºŒæ¬¡å¯è¯»å†™äº‹ä»¶æ‰ä¼šé€šçŸ¥ä½ ã€‚ è¿™ç§æ¨¡å¼æ¯”æ°´å¹³è§¦å‘æ•ˆç‡é«˜ï¼Œç³»ç»Ÿä¸ä¼šå……æ–¥å¤§é‡ä½ ä¸å…³å¿ƒçš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦ã€‚ åœ¨ETæ¨¡å¼ä¸‹ï¼Œç¼“å†²åŒºä»ä¸å¯è¯»å˜æˆå¯è¯»ï¼Œä¼šå”¤é†’åº”ç”¨è¿›ç¨‹ï¼Œç¼“å†²åŒºæ•°æ®å˜å°‘çš„æƒ…å†µï¼Œåˆ™ä¸ä¼šå†å”¤é†’åº”ç”¨è¿›ç¨‹ã€‚ ä¸¾ä¾‹ï¼š ä¸¾ä¾‹1ï¼š è¯»ç¼“å†²åŒºåˆšå¼€å§‹æ˜¯ç©ºçš„ è¯»ç¼“å†²åŒºå†™å…¥2KBæ•°æ® æ°´å¹³è§¦å‘å’Œè¾¹ç¼˜è§¦å‘æ¨¡å¼æ­¤æ—¶éƒ½ä¼šå‘å‡ºå¯è¯»ä¿¡å· æ”¶åˆ°ä¿¡å·é€šçŸ¥åï¼Œè¯»å–äº†1KBçš„æ•°æ®ï¼Œè¯»ç¼“å†²åŒºè¿˜å‰©ä½™1KBæ•°æ® æ°´å¹³è§¦å‘ä¼šå†æ¬¡è¿›è¡Œé€šçŸ¥ï¼Œè€Œè¾¹ç¼˜è§¦å‘ä¸ä¼šå†è¿›è¡Œé€šçŸ¥ ä¸¾ä¾‹2ï¼š æ°´å¹³è§¦å‘ï¼š0ä¸ºæ— æ•°æ®ï¼Œ1ä¸ºæœ‰æ•°æ®ã€‚ç¼“å†²åŒºæœ‰æ•°æ®åˆ™ä¸€ç›´ä¸º1ï¼Œåˆ™ä¸€ç›´è§¦å‘ã€‚ è¾¹ç¼˜è§¦å‘ï¼š0ä¸ºæ— æ•°æ®ï¼Œ1ä¸ºæœ‰æ•°æ®ï¼Œåªè¦åœ¨0å˜åˆ°1çš„ä¸Šå‡æ²¿æ‰è§¦å‘ã€‚ netpollclose() æŠŠæ–‡ä»¶æè¿°ç¬¦fdä»pollerå®ä¾‹ä¸­ç§»é™¤ï¼Œä¹Ÿå°±æ˜¯ä»epollä¸­åˆ é™¤ã€‚ 1 2 3 4 5 6 func netpollclose(fd uintptr) int32 { var ev epollevent // _EPOLL_CTL_DEL ä»epollæ–‡ä»¶æè¿°ç¬¦epfdä¸­åˆ é™¤ç›®æ ‡æ–‡ä»¶æè¿°ç¬¦fdã€‚ // è¯¥äº‹ä»¶è¢«å¿½ç•¥ï¼Œå¯ä»¥ä¸ºNULLã€‚ return -epollctl(epfd, _EPOLL_CTL_DEL, int32(fd), \u0026ev)\t} netpollIsPollDescriptor() åˆ¤æ–­æ˜¯å¦æ˜¯é¡¶å±‚pollï¼Œä»¥åŠæ˜¯pip2åˆ›å»ºçš„è¯»å’Œå†™æ–‡ä»¶æè¿°ç¬¦ã€‚ åˆ¤æ–­æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦è¢«pollerä½¿ç”¨ã€‚epfdã€netpollBreakRdã€netpollBreakWrå±äºè¢«pollerä½¿ç”¨çš„æè¿°ç¬¦ã€‚ 1 2 3 func netpollIsPollDescriptor(fd uintptr) bool { return fd == uintptr(epfd) || fd == netpollBreakRd || fd == netpollBreakWr } netpollBreak() ç”¨æ¥å”¤é†’é˜»å¡ä¸­çš„netpollï¼Œå®ƒå®é™…ä¸Šå°±æ˜¯å‘netpollBreakWræè¿°ç¬¦ä¸­å†™å…¥æ•°æ®ï¼Œè¿™æ ·ä¸€æ¥epollå°±ä¼šç›‘å¬åˆ°ã€‚ netpollBreakRdçš„EPOLLINäº‹ä»¶(EPOLLINè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¯»ï¼ˆåŒ…æ‹¬å¯¹ç«¯SOCKETæ­£å¸¸å…³é—­ï¼‰)ã€‚netpollBreakä¸­æ–­epollwaitã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 // netpollBreak interrupts an epollwait. func netpollBreak() { // netpollWakeSigä¿¡å·ä¸»è¦ç”¨äºæœ¬è½®å·²ç»é€šçŸ¥è¿‡IOè½®è¯¢ï¼Œä½†æ˜¯è¿˜æ²¡å¤„ç†æœ‰å…¶ä»–çš„è°ƒç”¨æ­¤æ–¹æ³•æ—¶ // ä½¿ç”¨åŸå­æ“ä½œå°†netpollWakeSigç”±0å˜æˆ1ï¼Œè¡¨ç¤ºæ­£åœ¨å”¤é†’epollã€‚ if atomic.Cas(\u0026netpollWakeSig, 0, 1) {\tfor { var b byte // å‘netpollBreakWrä¸­å†™å…¥æ•°æ®ï¼Œä¼šå¯¼è‡´é‚£äº›é˜»å¡åœ¨netpollå‡½æ•°ä¸­çš„çº¿ç¨‹ç›´æ¥è¿”å›å»æ‰§è¡Œåé¢ä»£ç  // netpollBreakWråœ¨pipe2å‡½æ•°ä¸­æ³¨å†Œæ—¶å·²ç»è®¾ç½®äº†éé˜»å¡ã€‚å› æ­¤è¿™é‡Œä¸ä¼šé˜»å¡ã€‚ n := write(netpollBreakWr, unsafe.Pointer(\u0026b), 1) // å†™å…¥æˆåŠŸ if n == 1 { break } // åœ¨å†™å…¥ä»»ä½•æ•°æ®ä¹‹å‰ï¼Œè°ƒç”¨è¢«ä¿¡å·ä¸­æ–­ã€‚ if n == -_EINTR { continue // é‡è¯•ã€‚ } // å·²ä½¿ç”¨ O_NONBLOCK é€‰æ‹©äº†éé˜»å¡ I/Oï¼Œå¹¶ä¸”å†™å…¥å°†é˜»å¡ã€‚ // _EAGAINï¼šè¡¨ç¤ºç›®å‰æ²¡æœ‰å¯ç”¨çš„æ•°æ® if n == -_EAGAIN { return } println(\"runtime: netpollBreak write failed with\", -n) throw(\"runtime: netpollBreak write failed\") } } } netpoll() netpollæ£€æŸ¥å‡†å¤‡å°±ç»ªçš„ç½‘ç»œè¿æ¥ã€‚è¿”å›å¯è¿è¡Œçš„goroutineåˆ—è¡¨ã€‚ å‚æ•°ï¼š delay \u003c 0ï¼šæ— é™æœŸé˜»å¡ã€‚ delay == 0ï¼šä¸é˜»å¡ï¼Œç«‹å³è¿”å›ã€‚ delay \u003e 0ï¼šé˜»å¡é•¿è¾¾delayçº³ç§’ã€‚ è¿”å›å€¼ï¼šgListï¼šä¸€ç»„å°±ç»ªçš„goroutineã€‚ æ ¹æ®å…¥å‚delayè®¾ç½®è°ƒç”¨epoll_waitçš„timeoutå€¼ï¼Œè°ƒç”¨epoll_waitä»epollçš„eventpoll.rdlliståŒå‘åˆ—è¡¨ä¸­è·å–IOå°±ç»ªçš„fdåˆ—è¡¨ï¼Œéå†epoll_waitè¿”å›çš„fdåˆ—è¡¨ï¼Œ æ ¹æ®è°ƒç”¨epoll_ctlæ³¨å†Œfdæ—¶å°è£…çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ç»„è£…å¯è¿è¡Œçš„goroutineå¹¶è¿”å›ã€‚ æ‰§è¡Œå®Œnetpollä¹‹åï¼Œä¼šè¿”å›ä¸€ä¸ªå°±ç»ªfdåˆ—è¡¨å¯¹åº”çš„goroutineåˆ—è¡¨ï¼Œæ¥ä¸‹æ¥å°†å°±ç»ªçš„goroutineåŠ å…¥åˆ°è°ƒåº¦é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è°ƒåº¦è¿è¡Œã€‚ netpollçš„è°ƒç”¨æ—¶æœºï¼š åœ¨è°ƒåº¦å™¨ä¸­æ‰§è¡Œruntime.schedule()ï¼Œè¯¥æ–¹æ³•ä¸­ä¼šæ‰§è¡Œruntime.findrunnable()å‡½æ•°ä¸­è°ƒç”¨äº†runtime.netpollè·å–å¾…æ‰§è¡Œçš„goroutineã€‚ Go runtimeåœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„sysmonç›‘æ§çº¿ç¨‹ï¼Œsysmonæ¯20us~10msè¿è¡Œä¸€æ¬¡ï¼Œæ¯æ¬¡è¿è¡Œä¼šæ£€æŸ¥è·ç¦»ä¸Šä¸€æ¬¡æ‰§è¡Œnetpollæ˜¯å¦è¶…è¿‡10msï¼Œå¦‚æœæ˜¯åˆ™ä¼šè°ƒç”¨ä¸€æ¬¡runtime.netpollã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 // netpoll checks for ready network connections. // Returns list of goroutines that become runnable. // // delay \u003c 0: blocks indefinitely;\t// delay == 0: does not block, just polls; // delay \u003e 0: block for up to that many nanoseconds; func netpoll(delay int64) gList { // 1) epollæ²¡æœ‰åˆå§‹åŒ– if epfd == -1 {\treturn gList{} } // 2) ä¸‹é¢æŠŠçº³ç§’çº§çš„ delay è½¬æ¢æˆæ¯«ç§’çº§çš„ waitmsã€‚ var waitms int32 if delay \u003c 0 { waitms = -1 // æ°¸ä¹…é˜»å¡ï¼Œç›´åˆ°äº‹ä»¶å°±ç»ªè¿”å› } else if delay == 0 { waitms = 0 // ä¸é˜»å¡ï¼Œç«‹å³è¿”å› } else if delay \u003c 1e6 { // å°äº1æ¯«ç§’ï¼Œä¿®æ”¹ä¸ºé˜»å¡1æ¯«ç§’ waitms = 1 // é˜»å¡1æ¯«ç§’ } else if delay \u003c 1e15 { // å°äº 11.5 day // 1e6 è¡¨ç¤º 1æ¯«ç§’ waitms = int32(delay / 1e6) // é˜»å¡æŒ‡å®šæ¯«ç§’ } else { // An arbitrary cap on how long to wait for a timer. // 1e9 ms == ~11.5 days. waitms = 1e9 // æœ€é•¿ 11.5å¤© } // 3) é€šè¿‡epollwaitå‡½æ•°ç­‰å¾…IOäº‹ä»¶ï¼Œç¼“å†²åŒºå¤§å°ä¸º128ä¸ªepolleventã€‚ // è¶…æ—¶æ—¶é—´æ˜¯ waitms æ¯«ç§’ã€‚å¦‚æœ epollwaitå‡½æ•°è¢«ä¸­æ–­æ‰“æ–­ï¼Œå°±é€šè¿‡gotoæ¥é‡è¯•ã€‚ // waitms å¤§äº0æ—¶ä¸ä¼šé‡è¯•ï¼Œå› ä¸ºéœ€è¦è¿”å›è°ƒç”¨è€…ä¸­å»é‡æ–°è®¡ç®—è¶…æ—¶æ—¶é—´ã€‚ // ä¸‹é¢ä¼ å…¥epollwaitçš„æ•°é‡æ˜¯128ï¼Œè¡¨ç¤ºä¸€æ¬¡æœ€å¤§å°±ç»ª128ä¸ªäº‹ä»¶ // è¿™æ ·å¯èƒ½å­˜åœ¨æ­¤æ¬¡å¤§äº128æ•°é‡æ—¶ï¼Œéœ€è¦ç­‰åˆ°ä¸‹ä¸€ä¸ªIOè½®è¯¢æ—¶é—´çª—å£ // type epollevent struct { // events uint32 // äº‹ä»¶ç±»å‹ // data [8]byte // å­˜å‚¨ç”¨æˆ·æ•°æ®ï¼Œåˆšå¥½æ˜¯ä¸€ä¸ªæŒ‡é’ˆå­˜å‚¨çš„å¤§å°ï¼Œè¯¥æ•°æ®ç”¨æˆ·æ˜¯å¯ä»¥ä¿®æ”¹çš„ // } var events [128]epollevent // ç”¨äºå­˜å‚¨å·²ç»å‡†å¤‡å¥½çš„æè¿°ç¬¦çš„äº‹ä»¶æ•°æ® retry: // è°ƒç”¨epollwaitç­‰å¾…æ–‡ä»¶æè¿°ç¬¦è½¬æ¢æˆå¯å†™æˆ–å¯è¯»ï¼Œå¦‚æœæ²¡æœ‰epollwaitä¼šé˜»å¡ n := epollwait(epfd, \u0026events[0], int32(len(events)), waitms) // è¿”å›æ´»è·ƒçš„æ•°é‡n if n \u003c 0 { // EBADFï¼šepfd ä¸æ˜¯æœ‰æ•ˆçš„æ–‡ä»¶æè¿°ç¬¦ã€‚ // EFAULTï¼šäº‹ä»¶æŒ‡å‘çš„å†…å­˜åŒºåŸŸæ— æ³•ç”¨å†™æƒé™è®¿é—®ã€‚ // EINVALï¼šepfd ä¸æ˜¯epollæ–‡ä»¶æè¿°ç¬¦ï¼Œæˆ–è€…maxevents(ç¬¬ä¸‰ä¸ªå‚æ•°)å°äºç­‰äº0ã€‚ if n != -_EINTR { // EINTR è¢«CPUä¸­æ–­ println(\"runtime: epollwait on fd\", epfd, \"failed with\", -n) throw(\"runtime: netpoll failed\") } // If a timed sleep was interrupted, just return to // recalculate how long we should sleep now. // // å¦‚æœå®šæ—¶ç¡çœ è¢«ä¸­æ–­ï¼Œåªéœ€è¿”å›é‡æ–°è®¡ç®—æˆ‘ä»¬ç°åœ¨åº”è¯¥ç¡å¤šä¹…ã€‚ // _EINTR: åœ¨ä»»ä½•è¯·æ±‚çš„äº‹ä»¶å‘ç”Ÿæˆ–è¶…æ—¶åˆ°æœŸä¹‹å‰ï¼Œè¯¥è°ƒç”¨è¢«ä¿¡å·å¤„ç†ç¨‹åºä¸­æ–­ã€‚ if waitms \u003e 0 { return gList{} } // è¢«ä¸­æ–­ AND waitms \u003c= 0 æƒ…å†µé‡è¯• goto retry } // type gList struct { head guintptr } var toRun gList // æ„å‘³ç€è¢«ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦å‡ºç°äº†å¾…å¤„ç†çš„äº‹ä»¶ for i := int32(0); i \u003c n; i++ { // å°±ç»ªçš„IOäº‹ä»¶é›† ev := \u0026events[i] // å½“å‰å°±ç»ªæè¿°ç¬¦æ²¡æœ‰äº‹ä»¶ç±»å‹ï¼Œç›´æ¥è·³è¿‡ if ev.events == 0 { continue } // äº‹ä»¶æ¥æºæ˜¯å¦æ˜¯netpollBreakRdï¼Œè¯¥æè¿°ç¬¦æ¥ä¹‹pipe2å‡½æ•°åˆ›å»º // æ¥è‡ªpipe2å‡½æ•°åˆ›å»ºçš„é€šä¿¡ï¼ŒnetpollBreakRdæ˜¯LTæ°´å¹³è§¦å‘å¦‚æœä¸è¯»å–ä¼šä¸€ç›´è§¦å‘ // è¯¥äº‹ä»¶æ¥è‡ª netpollBreak() æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åªä¼šåœ¨åˆ›å»ºtimeræ—¶å’ŒfindRunnable()å‡½æ•°ä¸­è¢«è°ƒç”¨ã€‚ if *(**uintptr)(unsafe.Pointer(\u0026ev.data)) == \u0026netpollBreakRd { // å¯¹äºæ–‡ä»¶æè¿°ç¬¦ netpollBreakRd è€Œè¨€ï¼Œåªæœ‰ _EPOLLIN äº‹ä»¶æ˜¯æ­£å¸¸çš„ï¼Œå…¶ä»–éƒ½ä¼šè¢«è§†ä¸ºå¼‚å¸¸ã€‚ if ev.events != _EPOLLIN { println(\"runtime: netpoll: break fd ready for\", ev.events) throw(\"runtime: netpoll: break fd ready for something unexpected\") } // è¿™ç§æƒ…å†µä¸‹åªå¤„ç†ä¸æ˜¯ç«‹å³è¿”å›æƒ…å†µä¸‹ï¼Œå¦‚æœæ˜¯ç«‹å³è¿”å›æƒ…å†µæ—¶ï¼Œæ•°æ®å¹¶æœªè¢«è¯»å–ï¼Œä¸‹æ¬¡è¿˜ä¼šè§¦å‘è¯¥ä¿¡å· // è¿™ç§æƒ…å†µä¸‹åªåœ¨runtime.findrunnable()å‡½æ•°ä¸­å­˜åœ¨ï¼Œçº¿ç¨‹åœ¨å¯»æ‰¾gæ— æœæ—¶ï¼Œæœ€ååªèƒ½åœ¨IOè½®è¯¢å¤„ç­‰å¾… // åªæœ‰åœ¨ delay ä¸ä¸º0ï¼Œä¹Ÿå°±æ˜¯é˜»å¡å¼netpollæ—¶ï¼Œæ‰è¯»å–netpollBreakRdä¸­çš„æ•°æ®ã€‚ if delay != 0 { // netpollBreakRd çš„æœ¬æ„ä¹Ÿæ˜¯åªå”¤é†’delay != 0çš„netpollï¼Œå› ä¸ºè¿™äº›åœ¨é˜»å¡éœ€è¦è¿”å› // netpollBreak could be picked up by a // nonblocking poll. Only read the byte // if blocking. // netpollBreak å¯ä»¥é€šè¿‡éé˜»å¡è½®è¯¢æ¥è·å–ã€‚ ä»…åœ¨é˜»å¡æ—¶è¯»å–å­—èŠ‚ã€‚ var tmp [16]byte // æŠŠå†™å…¥çš„æ•°æ®è¯»å–è®©ç¼“å­˜åŒºä¸ºç©º read(int32(netpollBreakRd), noescape(unsafe.Pointer(\u0026tmp[0])), int32(len(tmp)))\t// å°†netpollWakeSigç”±1å˜æˆ0ï¼Œè¡¨ç¤ºå½“å‰äº‹ä»¶å·²è¢«è¯»å– atomic.Store(\u0026netpollWakeSig, 0)\t} continue } // æ ¹æ®epollè¿”å›çš„IOäº‹ä»¶æ ‡å¿—ä½ä¸ºmodeèµ‹å€¼ // r è¡¨ç¤ºå¯è¯»ï¼Œw è¡¨ç¤ºå¯å†™ï¼Œr+w è¡¨ç¤ºæ—¢å¯è¯»åˆå¯å†™ã€‚ // æ£€æµ‹IOäº‹ä»¶ä¸­çš„é”™è¯¯æ ‡å¿—ä½ï¼Œå¹¶ç›¸åº”çš„ä¸ºpd.everrèµ‹å€¼ã€‚ // åˆ¤æ–­å‘ç”Ÿçš„äº‹ä»¶ç±»å‹,è¯»ç±»å‹æˆ–è€…å†™ç±»å‹ var mode int32\t// å­˜å‚¨å½“å‰ç±»å‹ // EPOLLIN ï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¯»ï¼ˆåŒ…æ‹¬å¯¹ç«¯SOCKETæ­£å¸¸å…³é—­ï¼‰ // EPOLLRDHUPï¼šå¯¹ç«¯æè¿°ç¬¦äº§ç”Ÿä¸€ä¸ªæŒ‚æ–­äº‹ä»¶ // EPOLLHUPï¼šæœ¬ç«¯æè¿°ç¬¦äº§ç”Ÿä¸€ä¸ªæŒ‚æ–­äº‹ä»¶ï¼Œé»˜è®¤ç›‘æµ‹äº‹ä»¶ // EPOLLERRï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ if ev.events\u0026(_EPOLLIN|_EPOLLRDHUP|_EPOLLHUP|_EPOLLERR) != 0 { mode += 'r' } // EPOLLOUTï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥å†™ // EPOLLHUPï¼šæœ¬ç«¯æè¿°ç¬¦äº§ç”Ÿä¸€ä¸ªæŒ‚æ–­äº‹ä»¶ï¼Œé»˜è®¤ç›‘æµ‹äº‹ä»¶ // EPOLLERRï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ if ev.events\u0026(_EPOLLOUT|_EPOLLHUP|_EPOLLERR) != 0 { mode += 'w' } // modeä¸ä¸º0ï¼Œè¡¨ç¤ºæœ‰IOäº‹ä»¶ï¼Œéœ€è¦ä»ev.dataå­—æ®µå¾—åˆ°ä¸IOäº‹ä»¶å…³è”çš„pollDescã€‚ if mode != 0 { // å–å‡ºä¿å­˜åœ¨ epollevent é‡Œçš„pollDescï¼Œå› ä¸ºè¦æ ¹æ®è¿™ä¸ªå†…å®¹å»æ¢å¤gå¦‚æœgå·²è¢«æŒ‚èµ·æ—¶ pd := *(**pollDesc)(unsafe.Pointer(\u0026ev.data)) // *pollDesc // å¯¹åº”çš„_EPOLLERRæ–‡ä»¶æè¿°ç¬¦å‡ºç°é”™è¯¯æ—¶ï¼Œæ ‡è®°é”™è¯¯ pd.setEventErr(ev.events == _EPOLLERR)\t// è®¾ç½®pollDescçš„EpollErré”™è¯¯ä½ï¼Œå¦‚æœæ˜¯è¿™ç§çŠ¶æ€ netpollready(\u0026toRun, pd, mode)\t// å¤„ç†å°±ç»ªçš„æè¿°ç¬¦ } } return toRun } netpollready() go1.19.3/src/runtime/runtime/netpoll.goã€‚ netpollreadyç”±ç‰¹å®šäºå¹³å°çš„netpollå‡½æ•°è°ƒç”¨ã€‚å®ƒå£°æ˜ä¸pdç›¸å…³çš„fdå·²ç»ä¸ºI/Oåšå¥½äº†å‡†å¤‡ã€‚ toRunå‚æ•°ç”¨äºæ„å»ºä¸€ä¸ªä»netpollè¿”å›çš„goroutinesåˆ—è¡¨ã€‚modeå‚æ•°æ˜¯'r'ã€'w'æˆ–'r'+'w'ï¼Œè¡¨ç¤ºfdæ˜¯å¦å‡†å¤‡å¥½è¯»ã€å†™æˆ–åŒæ—¶è¯»å’Œå†™ã€‚ è¿™å¯èƒ½ä¼šåœ¨æ•´ä¸ªç³»ç»Ÿåœæ­¢æ—¶è¿è¡Œï¼Œå› æ­¤ä¸å…è®¸è®¾ç½®å†™å±éšœã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // netpollready is called by the platform-specific netpoll function. // It declares that the fd associated with pd is ready for I/O. // The toRun argument is used to build a list of goroutines to return // from netpoll. The mode argument is 'r', 'w', or 'r'+'w' to indicate // whether the fd is ready for reading or writing or both. // // This may run while the world is stopped, so write barriers are not allowed. //go:nowritebarrier func netpollready(toRun *gList, pd *pollDesc, mode int32) { var rg, wg *g if mode == 'r' || mode == 'r'+'w' { // netpollunblock å¯èƒ½è¿”å› goroutine æˆ– nil rg = netpollunblock(pd, 'r', true) } if mode == 'w' || mode == 'r'+'w' { wg = netpollunblock(pd, 'w', true) } if rg != nil { // å¹¶å…¥ toRun ä¸­ï¼Œè¿™éƒ¨åˆ† goroutine ç­‰å¾…æ”¾å…¥è°ƒåº¦æ± ä¸­ toRun.push(rg) } if wg != nil { toRun.push(wg) } } netpollunblock() go1.19.3/src/runtime/runtime/netpoll.goã€‚ netpollunblockè§£é™¤é˜»å¡ã€‚ å‚æ•°ï¼š pd *pollDescï¼špollDescã€‚ mode int32ï¼šè¯»ræˆ–å†™wã€‚ ioready boolï¼štrue-I/Oè¯»ï¼ˆç”¨äºä»pollDescä¸­è·å– goroutineï¼‰ï¼Œfalse-è¯»å†™è¶…æ—¶ä»pollDescä¸­è·å–goroutineã€‚ è¿”å›å€¼ï¼š*gè¿”å›å°±ç»ªçš„goroutineï¼Œå¯èƒ½æ˜¯nilã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 func netpollunblock(pd *pollDesc, mode int32, ioready bool) *g { // æ ¹æ® mode ä»rgæˆ–wgå–å‡º goroutineã€‚ gpp := \u0026pd.rg if mode == 'w' { gpp = \u0026pd.wg } for { // åŸå­è¯»å– old := gpp.Load() // pdReadyï¼šè¡¨ç¤ºfdçš„æ•°æ®å·²ç»å°±ç»ªï¼Œå¯ä¾›è¯»å–æˆ–å†™ã€‚è¯¥å€¼ä»gä¿®æ”¹pdReadyã€‚ // è¿™ç§æƒ…å†µå¯èƒ½ goroutine å·²ç»è¢«è¿”å›ç»™è°ƒç”¨è€…äº†ã€‚ä»€ä¹ˆéƒ½ä¸åšç›´æ¥è¿”å›ã€‚ if old == pdReady { return nil } // nilï¼šæ²¡æœ‰ä»€ä¹ˆå¯åšçš„ if old == 0 \u0026\u0026 !ioready { // Only set pdReady for ioready. runtime_pollWait // will check for timeout/cancel before waiting. // // åªåœ¨ioreadyä¸­è®¾ç½®pdReadyã€‚runtime_pollWaitå°†åœ¨ç­‰å¾…ä¹‹å‰æ£€æŸ¥ timeout/cancelã€‚ return nil } // oldæ˜¯0ã€goroutineã€pdWaitè¿™ä¸‰ç§æƒ…å†µã€‚ var new uintptr if ioready { // ä¿®æ”¹ä¸ºpdReadyï¼Œè¡¨ç¤ºæ•°æ®å·²å°±ç»ªæˆ–å†™ new = pdReady } // CAS äº¤æ¢ if gpp.CompareAndSwap(old, new) { // pdWaitï¼šè¡¨ç¤ºæŸä¸ªgoroutineå³å°†æŒ‚èµ·å¹¶ç­‰å¾…fdçš„å¯è¯»å¯å†™äº‹ä»¶ã€‚ if old == pdWait { old = 0 // nil } return (*g)(unsafe.Pointer(old)) // nil æˆ– *g } } } wakeNetPoller() è¯¥å‡½æ•°åœ¨timeæºç ä¸­è¢«è°ƒç”¨ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦å‘èµ·I/Oç½‘ç»œè½®è¯¢ã€‚ è¯¥æ–¹æ³•æ˜¯ä¸ºäº†é˜²æ­¢å®šæ—¶å™¨è§¦å‘æ—¶é—´åˆ°äº†æ²¡æœ‰çº¿ç¨‹èƒ½è§¦å‘çš„æƒ…å†µï¼Œå½“åªå‰©é˜»å¡åœ¨netpollçš„çº¿ç¨‹æˆ–æ‰€æœ‰çš„çº¿ç¨‹éƒ½å¤„äºç­‰å¾…ä¸­æ—¶ï¼Œtimerå¯èƒ½ä¸èƒ½æŒ‰æ—¶è§¦å‘çš„æƒ…å†µã€‚ wakeenetpollerå”¤é†’åœ¨ç½‘ç»œè½®è¯¢å™¨(network poller)ä¸­ç¡çœ çš„çº¿ç¨‹ï¼Œå¦‚æœå®ƒä¸æ‰“ç®—åœ¨whenå‚æ•°ä¹‹å‰è¢«å”¤é†’; æˆ–è€…å”¤é†’ä¸€ä¸ªç©ºé—²çš„Pæ¥æœåŠ¡è®¡æ—¶å™¨(timers)å’Œç½‘ç»œè½®è¯¢å™¨(network poller)(å¦‚æœè¿˜æ²¡æœ‰çš„è¯)ã€‚ when int64ï¼šè¡¨ç¤ºæœ€è¿‘çš„timerè§¦å‘çš„æ—¶é—´ç‚¹ï¼Œå› æ­¤ä¸ºäº†é¿å…å½“å‰æœ€è¿‘çš„timeråˆ°æ—¶é—´èƒ½å‡†æ—¶è§¦å‘ï¼Œéœ€è¦è°ƒæ•´netpollçš„é˜»å¡äº‹ä»¶ç‚¹ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // wakeNetPoller wakes up the thread sleeping in the network poller if it isn't // going to wake up before the when argument; or it wakes an idle P to service // timers and the network poller if there isn't one already. func wakeNetPoller(when int64) { // sched.lastpollï¼šè®°å½•çš„æ˜¯ä¸Šæ¬¡æ‰§è¡Œnetpollçš„æ—¶é—´ï¼Œå¦‚æœç­‰äº0ï¼Œåˆ™è¡¨ç¤ºæŸä¸ªçº¿ç¨‹æ­£åœ¨é˜»å¡å¼åœ°æ‰§è¡Œnetpollã€‚ // sched.lastpoll è¢«è®¾ç½®ä¸º0åªä¼šåœ¨ findrunnable å‡½æ•°ä¸­ã€‚ if atomic.Load64(\u0026sched.lastpoll) == 0 { // In findrunnable we ensure that when polling the pollUntil // field is either zero or the time to which the current // poll is expected to run. This can have a spurious wakeup // but should never miss a wakeup. // // åœ¨ findrunnable ä¸­ï¼Œæˆ‘ä»¬è¦ç¡®ä¿è½®è¯¢æ—¶ pollUntil å­—æ®µè¦ä¹ˆæ˜¯0ï¼Œè¦ä¹ˆä¸ºå½“å‰pollé¢„æœŸè¿è¡Œçš„æ—¶é—´ã€‚ // è¿™é‡Œå¯èƒ½ä¼šæ˜¯ä¸€ä¸ªè™šå‡çš„å”¤é†’ï¼Œä½†ä¸åº”è¯¥é”™è¿‡å”¤é†’ã€‚ // sched.pollUntilï¼šè¡¨ç¤ºé˜»å¡å¼åœ°netpollå°†åœ¨ä½•æ—¶è¢«å”¤é†’ã€‚è¯¥å€¼åœ¨ findrunnable å‡½æ•°ä¸­è¢«è®¾ç½®ã€‚ // sched.pollUntil å€¼å¤§äº0æ—¶ï¼Œè¡¨ç¤ºæœ€è¿‘çš„timerè§¦å‘æ—¶é—´æ®µã€‚ pollerPollUntil := int64(atomic.Load64(\u0026sched.pollUntil)) // pollerPollUntil \u003e whenï¼šå­˜åœ¨æœ€æ–°çš„è®¡æ—¶å™¨è¢«åŠ å…¥whenæ—¶é—´æ®µåè§¦å‘ if pollerPollUntil == 0 || pollerPollUntil \u003e when { netpollBreak() } } else { // There are no threads in the network poller, try to get // one there so it can handle new timers. if GOOS != \"plan9\" { // Temporary workaround - see issue #42303. wakep() // å°è¯•å”¤é†’ä¸€ä¸ªç©ºé—²çš„Pèµ·æ¥æœåŠ¡timerå’Œnetwork pollerã€‚ } } } netpollarm() è¯¥å‡½æ•°åœ¨linuxä¸Šä¸ä¼šè°ƒç”¨ï¼Œå……å½“ä¸€ä¸ªå ä½ä½œç”¨ã€‚ 1 2 3 func netpollarm(pd *pollDesc, mode int) { throw(\"runtime: unused\") // runtime: æœªä½¿ç”¨çš„ } å‚è€ƒ è¯¦è§£Goè¯­è¨€I/Oå¤šè·¯å¤ç”¨netpolleræ¨¡å‹ epollè¯¦è§£ epollæºç è§£æ(1) epoll_create ",
  "wordCount" : "1886",
  "inLanguage": "zh",
  "image": "https://heliu.site/favicon-32x32.png","datePublished": "2024-07-20T21:59:40+08:00",
  "dateModified": "2024-07-20T21:59:40+08:00",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://heliu.site/posts/golang/netpoll/epoll/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://heliu.site/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://heliu.site/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://heliu.site/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://heliu.site/" title="ä¸»é¡µ">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/posts" title="æ–‡ç« ">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/archives" title="æ—¶é—´è½´">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/tags/" title="æ ‡ç­¾">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/search/" title="æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/support" title="æ‰“èµ">
                    <span>ğŸ«¶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://heliu.site/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/">Article</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/golang/">Golang</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/golang/netpoll/">ç¬¬16ç«  netpoll</a></div>
    <h1 class="post-title entry-hint-parent">
      Golang epoll
    </h1>
    <div class="post-description">
      ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬
    </div>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2024-07-20</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2024-07-20</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>1886å­—</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>9åˆ†é’Ÿ</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &nbsp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://heliu.site/tags/golang/" target="_blank" rel="noopener">Golang</a>
            <a href="https://heliu.site/tags/netpoll/" target="_blank" rel="noopener">Netpoll</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &nbsp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#variables" aria-label="variables">variables</a></li>
                    <li>
                        <a href="#netpollgenericinit" aria-label="netpollGenericInit()"><code>netpollGenericInit()</code></a><ul>
                            
                    <li>
                        <a href="#netpollinit" aria-label="netpollinit()"><code>netpollinit()</code></a></li></ul>
                    </li>
                    <li>
                        <a href="#netpollopen" aria-label="netpollopen()"><code>netpollopen()</code></a></li>
                    <li>
                        <a href="#netpollclose" aria-label="netpollclose()"><code>netpollclose()</code></a></li>
                    <li>
                        <a href="#netpollispolldescriptor" aria-label="netpollIsPollDescriptor()"><code>netpollIsPollDescriptor()</code></a></li>
                    <li>
                        <a href="#netpollbreak" aria-label="netpollBreak()"><code>netpollBreak()</code></a></li>
                    <li>
                        <a href="#netpoll" aria-label="netpoll()"><code>netpoll()</code></a><ul>
                            
                    <li>
                        <a href="#netpollready" aria-label="netpollready()"><code>netpollready()</code></a></li>
                    <li>
                        <a href="#netpollunblock" aria-label="netpollunblock()"><code>netpollunblock()</code></a></li></ul>
                    </li>
                    <li>
                        <a href="#wakenetpoller" aria-label="wakeNetPoller()"><code>wakeNetPoller()</code></a></li>
                    <li>
                        <a href="#netpollarm" aria-label="netpollarm()"><code>netpollarm()</code></a></li>
                    <li>
                        <a href="#%e5%8f%82%e8%80%83" aria-label="å‚è€ƒ">å‚è€ƒ</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><ul>
<li>ä»¥ä¸‹æ¥è‡ª<code>go1.19.3/src/runtime/netpoll_epoll.go</code>æ–‡ä»¶ã€‚</li>
<li>æœ¬ç¯‡æ–‡ç« æ˜¯é’ˆå¯¹<code>netpoll_epoll.go</code>æ–‡ä»¶çš„æºç èµ°è¯»ã€‚</li>
</ul>
<h2 id="variables">variables<a hidden class="anchor" aria-hidden="true" href="#variables">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// epoll æè¿°ç¬¦, epollcreate å‡½æ•°åˆ›å»ºè¿”å›çš„æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">epfd</span> <span class="kt">int32</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">// epoll descriptor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¿å­˜çš„æ˜¯pipe2()æˆ–pip()å‡½æ•°åˆ›å»ºçš„è¯»å†™æè¿°ç¬¦ï¼Œpip2()æˆ–pip()å‡½æ•°åˆ›å»ºçš„readå’Œwriteï¼Œåªè¦ä»»æ„ä¸€æ–¹æ“ä½œå¦ä¸€æ–¹èƒ½è·å–åˆ°æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// netpollBreakRdä¼šè¢«æ³¨å†Œåˆ°epollä¸­ï¼Œå½“å†™æè¿°ç¬¦å‘é‡Œå†™æ•°æ®æ—¶ä¼šè§¦å‘waitç›‘å¬å‡½æ•°è¿”å›å°±ç»ªçš„äº‹ä»¶é›†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™å¯¹è¯»å†™æè¿°ç¬¦çš„ä½œç”¨åœ¨äºé€šä¿¡ï¼Œå½“æœ‰å…¶ä»–åç¨‹åœ¨waité˜»å¡ç­‰å¾…æ—¶ï¼Œå¯ä»¥é€šè¿‡å†™æè¿°ç¬¦å†™å…¥æ•°æ®è®©ç­‰å¾…çš„åç¨‹è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸»è¦é’ˆå¯¹ epoll_wait() å‡½æ•°é˜»å¡çš„çº¿ç¨‹ï¼Œé€šè¿‡è¿™é‡Œçš„äº‹ä»¶ä½¿è°ƒç”¨ epoll_wait() å‡½æ•°çš„çº¿ç¨‹é™·å…¥å†…æ ¸è¿”å›ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯¹äº epoll_wait() çš„ timeout å‚æ•°ä¸º0çš„æƒ…å†µï¼Œè¿™é‡Œçš„äº‹ä»¶ä¼šè¢«å¿½ç•¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">netpollBreakRd</span><span class="p">,</span> <span class="nx">netpollBreakWr</span> <span class="kt">uintptr</span> <span class="c1">// for netpollBreak
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç”¨äºé¿å…é‡å¤è°ƒç”¨ netpollBreak()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨å‘netpollBreakWrä¸­å†™å…¥æ•°æ®æ—¶ï¼Œè¯¥å€¼ä¼šä»0å˜æˆ1ï¼Œæ§åˆ¶åªå†™ä¸€æ¬¡æ ‡å¿—ç¬¦å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¯¥å‚æ•°æ˜¯åŸå­æ€§çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">netpollWakeSig</span> <span class="kt">uint32</span> <span class="c1">// used to avoid duplicate calls of netpollBreak
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/epoll-002.png" alt=""  />
</p>
<h2 id="netpollgenericinit"><code>netpollGenericInit()</code><a hidden class="anchor" aria-hidden="true" href="#netpollgenericinit">#</a></h2>
<ol>
<li>åˆå§‹åŒ–netpollã€‚<code>go1.19.3/src/runtime/netpoll.go</code>æ–‡ä»¶ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">netpollGenericInit</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// var netpollInited uint32 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ˜¯å¦å·²åˆå§‹åŒ–epollæ ‡å¿— 0.æœªåˆå§‹åŒ– 1.å·²åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">netpollInited</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// var netpollInitLock mutex åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">lockInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">netpollInitLock</span><span class="p">,</span> <span class="nx">lockRankNetpollInit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">netpollInitLock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è¿™é‡Œéœ€è¦åˆ¤æ–­ netpollInited == 0ï¼›åŸå› åœ¨äºå¯èƒ½å­˜åœ¨å¤šä¸ªåç¨‹å¹¶å‘åœ¨ç­‰å¾…åˆå§‹åŒ–epoll
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å½“è¿™äº›åç¨‹è·å–çš„é”æƒé™æ—¶ï¼Œè¿™é‡Œçš„netpollInitedå·²è¢«è®¾ç½®æˆ1äº†ï¼Œå·²ç»è¢«åˆå§‹åŒ–äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">netpollInited</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">netpollinit</span><span class="p">()</span>   <span class="c1">// åˆå§‹åŒ–netpoll
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">netpollInited</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>	<span class="c1">// netpollInited
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">netpollInitLock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="netpollinit"><code>netpollinit()</code><a hidden class="anchor" aria-hidden="true" href="#netpollinit">#</a></h3>
<ol>
<li><code>go1.19.3/src/runtime/netpoll_epoll.go</code>ã€‚</li>
<li>è°ƒç”¨epollcreateåˆ›å»ºnetpollerã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">netpollinit</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// epollcreate å‡½æ•°å†…ä¼šè°ƒç”¨ epollcreate1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// _EPOLL_CLOEXECï¼šå½“å‰è¿›ç¨‹forkå‡ºæ¥çš„ä»»ä½•å­è¿›ç¨‹åœ¨æ‰§è¡Œå‰éƒ½ä¼šå…³é—­epollæè¿°ç¬¦ï¼Œä¹Ÿå› æ­¤ï¼Œå­è¿›ç¨‹ä¸èƒ½å¤Ÿè®¿é—®epollå®ä¾‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">epfd</span> <span class="p">=</span> <span class="nf">epollcreate1</span><span class="p">(</span><span class="nx">_EPOLL_CLOEXEC</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å°äº0è¡¨ç¤ºåˆ›å»ºå‡ºé”™ï¼Œå¤§äº0è¡¨ç¤ºè¿”å›çš„åˆ›å»ºåçš„æ–‡ä»¶å¥æŸ„ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">epfd</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">        <span class="nx">epfd</span> <span class="p">=</span> <span class="nf">epollcreate</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">epfd</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nb">println</span><span class="p">(</span><span class="s">&#34;runtime: epollcreate failed with&#34;</span><span class="p">,</span> <span class="o">-</span><span class="nx">epfd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runtime: netpollinit failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ç³»ç»Ÿè°ƒç”¨ fcntl è®¾ç½® FD_CLOEXECï¼Œå‚çœ‹ epollcreate1 å‡½æ•°å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// fcntlï¼šfd, F_SETFD, FD_CLOEXEC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">closeonexec</span><span class="p">(</span><span class="nx">epfd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»ºä¸€ä¸ªç”¨äºé€šä¿¡çš„ç®¡é“,è¿”å›è¯»å†™,ä¸»è¦ç”¨äºé‚£äº›ç­‰å¾…åœ¨IOè½®è¯¢ä¸­çš„çº¿ç¨‹é€šä¿¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åˆ›å»ºä¸€ä¸ªéé˜»å¡å¼pipeï¼Œç”¨æ¥å”¤é†’é˜»å¡ä¸­çš„ netpollerã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// pipe2(_O_NONBLOCK | _O_CLOEXEC)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">r</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">errno</span> <span class="o">:=</span> <span class="nf">nonblockingPipe</span><span class="p">()</span>    <span class="c1">// ä¸»è¦ç”¨äºBreakç›¸å…³çš„å‡½æ•°ï¼Œä¸»è¦ç”¨äºç½‘ç»œè½®è¯¢å”¤é†’ä¿¡å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">errno</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">println</span><span class="p">(</span><span class="s">&#34;runtime: pipe failed with&#34;</span><span class="p">,</span> <span class="o">-</span><span class="nx">errno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runtime: pipe failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// epollevent æ˜¯äº‹ä»¶ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 	type epollevent struct {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//		events uint32   // äº‹ä»¶ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//		data [8]byte    // å­˜å‚¨ç”¨æˆ·æ•°æ®ï¼Œåˆšå¥½æ˜¯ä¸€ä¸ªæŒ‡é’ˆå­˜å‚¨çš„å¤§å°ï¼Œè¯¥æ•°æ®ç”¨æˆ·æ˜¯å¯ä»¥ä¿®æ”¹çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 	}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ev</span> <span class="o">:=</span> <span class="nx">epollevent</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ³¨æ„ï¼šè¿™é‡Œé»˜è®¤æ³¨å†Œçš„æ˜¯æ°´å¹³è§¦å‘ï¼Œå› æ­¤ä¼šä¸€ç›´è§¦å‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">events</span><span class="p">:</span> <span class="nx">_EPOLLIN</span><span class="p">,</span>   <span class="c1">// EPOLLIN è¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¯»ï¼ˆåŒ…æ‹¬å¯¹ç«¯SOCKETæ­£å¸¸å…³é—­ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// var netpollBreakRd uintptr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="o">**</span><span class="kt">uintptr</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ev</span><span class="p">.</span><span class="nx">data</span><span class="p">))</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">netpollBreakRd</span> <span class="c1">// ev.data = &amp;netpollBreakRd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å°†è¯»å–æ•°æ®çš„æ–‡ä»¶æè¿°ç¬¦åŠ å…¥ç›‘å¬ï¼Œå½“ä½¿ç”¨wå†™æ•°æ®æ—¶ï¼Œè¯¥rä¼šè¢«è§¦å‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// func epollctl(epfd, op, fd int32, ev *epollevent) int32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _EPOLL_CTL_ADD å°†ç›®æ ‡æ–‡ä»¶æè¿°ç¬¦fdæ·»åŠ åˆ°epollæè¿°ç¬¦epfdä¸­ï¼Œå¹¶å°†äº‹ä»¶eventä¸fdé“¾æ¥çš„å†…éƒ¨æ–‡ä»¶å…³è”èµ·æ¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">errno</span> <span class="p">=</span> <span class="nf">epollctl</span><span class="p">(</span><span class="nx">epfd</span><span class="p">,</span> <span class="nx">_EPOLL_CTL_ADD</span><span class="p">,</span> <span class="nx">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">ev</span><span class="p">)</span>      <span class="c1">// r è¢«æ·»åŠ åˆ°epollä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">errno</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">println</span><span class="p">(</span><span class="s">&#34;runtime: epollctl failed with&#34;</span><span class="p">,</span> <span class="o">-</span><span class="nx">errno</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runtime: epollctl failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// netpollBreakRdã€netpollBreakWr æ˜¯éé˜»å¡ç®¡é“ä¸¤ç«¯çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œåˆ†åˆ«è¢«ç”¨ä½œè¯»å–ç«¯å’Œå†™å…¥ç«¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¯»å–ç«¯ netpollBreakRd è¢«æ·»åŠ åˆ° epoll ä¸­ç›‘å¬ _EPOLLIN äº‹ä»¶ï¼Œåç»­ä»å†™å…¥ç«¯netpollBreakWr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å†™å…¥æ•°æ®å°±èƒ½å”¤é†’é˜»å¡ä¸­çš„ pollerã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">netpollBreakRd</span> <span class="p">=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="c1">// netpollBreakRdä¿å­˜pip2çš„read
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">netpollBreakWr</span> <span class="p">=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span> <span class="c1">// netpollBreakRdä¿å­˜pip2çš„write
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="netpollopen"><code>netpollopen()</code><a hidden class="anchor" aria-hidden="true" href="#netpollopen">#</a></h2>
<ol>
<li>æŠŠè¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦<code>fd</code>å’Œä¸ä¹‹å…³è”çš„<code>pollDesc</code>ç»“æ„æ·»åŠ åˆ°<code>poller</code>å®ä¾‹ä¸­ã€‚</li>
<li>è¯¥æ–¹æ³•å¯¹äºä¸€ä¸ª<code>socket</code>åªéœ€è°ƒç”¨ä¸€æ¬¡å³å¯ï¼Œè¡¨ç¤ºæ³¨å†Œ<code>fd</code>åˆ°<code>epoll</code>ä¸­ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>fd uintptr</code>ï¼šæ–‡ä»¶æè¿°ç¬¦ã€‚</li>
<li><code>pd *pollDesc</code>ï¼šç”¨æˆ·æ•°æ®ã€‚</li>
</ul>
</li>
<li>è¿”å›å€¼ï¼š<code>int32</code>ï¼š0-æ³¨å†ŒæˆåŠŸã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">netpollopen</span><span class="p">(</span><span class="nx">fd</span> <span class="kt">uintptr</span><span class="p">,</span> <span class="nx">pd</span> <span class="o">*</span><span class="nx">pollDesc</span><span class="p">)</span> <span class="kt">int32</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 	type epollevent struct {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      events uint32   // äº‹ä»¶ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      data [8]byte    // å­˜å‚¨ç”¨æˆ·æ•°æ®ï¼Œåˆšå¥½æ˜¯ä¸€ä¸ªæŒ‡é’ˆå­˜å‚¨çš„å¤§å°ï¼Œè¯¥æ•°æ®ç”¨æˆ·æ˜¯å¯ä»¥ä¿®æ”¹çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 	}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">ev</span> <span class="nx">epollevent</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// EPOLLINï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¯»ï¼ˆåŒ…æ‹¬å¯¹ç«¯SOCKETæ­£å¸¸å…³é—­ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// EPOLLOUTï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥å†™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// EPOLLRDHUPï¼šå¯¹ç«¯æè¿°ç¬¦äº§ç”Ÿä¸€ä¸ªæŒ‚æ–­äº‹ä»¶ï¼Œæ¯”å¦‚æ¥è‡ªå¯¹ç«¯çš„socketæŒ‚æ–­äº‹ä»¶ç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// EPOLLETï¼šå°†EPOLLè®¾ä¸ºè¾¹ç¼˜è§¦å‘(Edge Triggered)æ¨¡å¼ï¼Œè¿™æ˜¯ç›¸å¯¹äºæ°´å¹³è§¦å‘(Level Triggered)æ¥è¯´çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// pollDescï¼šç±»å‹çš„æ•°æ®ç»“æ„pdä½œä¸ºä¸fdå…³è”çš„è‡ªå®šæ•°æ®ä¼šè¢«ä¸€åŒæ·»åŠ åˆ°epollä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ev</span><span class="p">.</span><span class="nx">events</span> <span class="p">=</span> <span class="nx">_EPOLLIN</span> <span class="p">|</span> <span class="nx">_EPOLLOUT</span> <span class="p">|</span> <span class="nx">_EPOLLRDHUP</span> <span class="p">|</span> <span class="nx">_EPOLLET</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// epollevent æ˜¯ç”±eventså’Œdataç»„æˆï¼Œdataæ¥è‡ªç”¨æˆ·ç©ºé—´ä¼ å…¥çš„æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="o">**</span><span class="nx">pollDesc</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ev</span><span class="p">.</span><span class="nx">data</span><span class="p">))</span> <span class="p">=</span> <span class="nx">pd</span> <span class="c1">// ev.data = pd
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _EPOLL_CTL_ADD å°†ç›®æ ‡æ–‡ä»¶æè¿°ç¬¦fdæ·»åŠ åˆ°epollæè¿°ç¬¦epfdä¸­ï¼Œå¹¶å°†äº‹ä»¶eventä¸fdé“¾æ¥çš„å†…éƒ¨æ–‡ä»¶å…³è”èµ·æ¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="o">-</span><span class="nf">epollctl</span><span class="p">(</span><span class="nx">epfd</span><span class="p">,</span> <span class="nx">_EPOLL_CTL_ADD</span><span class="p">,</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">fd</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">ev</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

<p><details >
  <summary markdown="span">è§¦å‘æ¨¡å¼<code>LT</code>\ <code>ET</code>ï¼š</summary>
  <blockquote>
<ul>
<li><strong>æ°´å¹³è§¦å‘</strong>ï¼š<code>LT</code>
<ol>
<li>å¯¹äºè¯»æ“ä½œï¼Œåªè¦ç¼“å†²å†…å®¹ä¸ä¸ºç©ºï¼ŒLTæ¨¡å¼è¿”å›è¯»å°±ç»ªã€‚</li>
<li>å¯¹äºå†™æ“ä½œï¼Œåªè¦ç¼“å†²åŒºè¿˜ä¸æ»¡ï¼ŒLTæ¨¡å¼ä¼šè¿”å›å†™å°±ç»ªã€‚</li>
</ol>
</li>
<li>æ°´å¹³è§¦å‘æè¿°ï¼š
<ol>
<li>å½“è¢«ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šæœ‰å¯è¯»å†™äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œ<code>epoll_wait()</code>ä¼šé€šçŸ¥å¤„ç†ç¨‹åºå»è¯»å†™ã€‚</li>
<li>å¦‚æœè¿™æ¬¡æ²¡æœ‰æŠŠæ•°æ®ä¸€æ¬¡æ€§å…¨éƒ¨è¯»å†™å®Œ(å¦‚è¯»å†™ç¼“å†²åŒºå¤ªå°)ï¼Œé‚£ä¹ˆä¸‹æ¬¡è°ƒç”¨ <code>epoll_wait()</code>æ—¶ï¼Œå®ƒè¿˜ä¼šé€šçŸ¥ä½ åœ¨ä¸Šæ²¡è¯»å†™å®Œçš„æ–‡ä»¶æè¿°ç¬¦ä¸Šç»§ç»­è¯»å†™ï¼Œå½“ç„¶å¦‚æœä½ ä¸€ç›´ä¸å»è¯»å†™ï¼Œå®ƒä¼šä¸€ç›´é€šçŸ¥ä½ ã€‚</li>
<li>å¦‚æœç³»ç»Ÿä¸­æœ‰å¤§é‡ä½ ä¸éœ€è¦è¯»å†™çš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦ï¼Œè€Œå®ƒä»¬æ¯æ¬¡éƒ½ä¼šè¿”å›ï¼Œè¿™æ ·ä¼šå¤§å¤§é™ä½å¤„ç†ç¨‹åºæ£€ç´¢è‡ªå·±å…³å¿ƒçš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦çš„æ•ˆç‡ã€‚</li>
</ol>
</li>
<li><strong>è¾¹ç¼˜è§¦å‘</strong>ï¼š<code>ET</code>
<ol>
<li>å¯¹äºè¯»æ“ä½œï¼š
<ul>
<li>å½“ç¼“å†²åŒºç”±ä¸å¯è¯»å˜ä¸ºå¯è¯»çš„æ—¶å€™ï¼Œå³ç¼“å†²åŒºç”±ç©ºå˜ä¸ºä¸ç©ºçš„æ—¶å€™ã€‚</li>
<li>å½“æœ‰æ–°æ•°æ®åˆ°è¾¾æ—¶ï¼Œå³ç¼“å†²åŒºä¸­çš„å¾…è¯»æ•°æ®å˜å¤šçš„æ—¶å€™ã€‚</li>
<li>å½“ç¼“å†²åŒºæœ‰æ•°æ®å¯è¯»ï¼Œä¸”åº”ç”¨è¿›ç¨‹å¯¹ç›¸åº”çš„æè¿°ç¬¦è¿›è¡ŒEPOLL_CTL_MODä¿®æ”¹EPOLLINäº‹ä»¶æ—¶ã€‚</li>
</ul>
</li>
<li>å¯¹äºå†™æ“ä½œï¼š
<ul>
<li>å½“ç¼“å†²åŒºç”±ä¸å¯å†™å˜ä¸ºå¯å†™æ—¶ã€‚</li>
<li>å½“æœ‰æ—§æ•°æ®è¢«å‘é€èµ°ï¼Œå³ç¼“å†²åŒºä¸­çš„å†…å®¹å˜å°‘çš„æ—¶å€™ã€‚</li>
<li>å½“ç¼“å†²åŒºæœ‰ç©ºé—´å¯å†™ï¼Œä¸”åº”ç”¨è¿›ç¨‹å¯¹ç›¸åº”çš„æè¿°ç¬¦è¿›è¡ŒEPOLL_CTL_MODä¿®æ”¹EPOLLOUTäº‹ä»¶æ—¶ã€‚</li>
</ul>
</li>
</ol>
</li>
<li>è¾¹ç¼˜è§¦å‘æè¿°ï¼š
<ol>
<li>å½“è¢«ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šæœ‰å¯è¯»å†™äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œ<code>epoll_wait()</code>ä¼šé€šçŸ¥å¤„ç†ç¨‹åºå»è¯»å†™ã€‚</li>
<li>å¦‚æœè¿™æ¬¡æ²¡æœ‰æŠŠæ•°æ®å…¨éƒ¨è¯»å†™å®Œ(å¦‚è¯»å†™ç¼“å†²åŒºå¤ªå°)ï¼Œé‚£ä¹ˆä¸‹æ¬¡è°ƒç”¨ <code>epoll_wait()</code>æ—¶ï¼Œå®ƒä¸ä¼šé€šçŸ¥ä½ ï¼Œä¹Ÿå°±æ˜¯å®ƒåªä¼šé€šçŸ¥ä½ ä¸€æ¬¡ï¼Œç›´åˆ°è¯¥æ–‡ä»¶æè¿°ç¬¦ä¸Šå‡ºç°ç¬¬äºŒæ¬¡å¯è¯»å†™äº‹ä»¶æ‰ä¼šé€šçŸ¥ä½ ã€‚</li>
<li>è¿™ç§æ¨¡å¼æ¯”æ°´å¹³è§¦å‘æ•ˆç‡é«˜ï¼Œç³»ç»Ÿä¸ä¼šå……æ–¥å¤§é‡ä½ ä¸å…³å¿ƒçš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦ã€‚</li>
<li>åœ¨ETæ¨¡å¼ä¸‹ï¼Œç¼“å†²åŒºä»ä¸å¯è¯»å˜æˆå¯è¯»ï¼Œä¼šå”¤é†’åº”ç”¨è¿›ç¨‹ï¼Œç¼“å†²åŒºæ•°æ®å˜å°‘çš„æƒ…å†µï¼Œåˆ™ä¸ä¼šå†å”¤é†’åº”ç”¨è¿›ç¨‹ã€‚</li>
</ol>
</li>
<li>ä¸¾ä¾‹ï¼š
<ol>
<li>ä¸¾ä¾‹1ï¼š
<ul>
<li>è¯»ç¼“å†²åŒºåˆšå¼€å§‹æ˜¯ç©ºçš„</li>
<li>è¯»ç¼“å†²åŒºå†™å…¥2KBæ•°æ®</li>
<li>æ°´å¹³è§¦å‘å’Œè¾¹ç¼˜è§¦å‘æ¨¡å¼æ­¤æ—¶éƒ½ä¼šå‘å‡ºå¯è¯»ä¿¡å·</li>
<li>æ”¶åˆ°ä¿¡å·é€šçŸ¥åï¼Œè¯»å–äº†1KBçš„æ•°æ®ï¼Œè¯»ç¼“å†²åŒºè¿˜å‰©ä½™1KBæ•°æ®</li>
<li>æ°´å¹³è§¦å‘ä¼šå†æ¬¡è¿›è¡Œé€šçŸ¥ï¼Œè€Œè¾¹ç¼˜è§¦å‘ä¸ä¼šå†è¿›è¡Œé€šçŸ¥</li>
</ul>
</li>
<li>ä¸¾ä¾‹2ï¼š
<ul>
<li><strong>æ°´å¹³è§¦å‘</strong>ï¼š0ä¸ºæ— æ•°æ®ï¼Œ1ä¸ºæœ‰æ•°æ®ã€‚ç¼“å†²åŒºæœ‰æ•°æ®åˆ™ä¸€ç›´ä¸º1ï¼Œåˆ™ä¸€ç›´è§¦å‘ã€‚</li>
<li><strong>è¾¹ç¼˜è§¦å‘</strong>ï¼š0ä¸ºæ— æ•°æ®ï¼Œ1ä¸ºæœ‰æ•°æ®ï¼Œåªè¦åœ¨0å˜åˆ°1çš„ä¸Šå‡æ²¿æ‰è§¦å‘ã€‚</li>
</ul>
</li>
</ol>
</li>
</ul>
</blockquote>

</details></p>

<h2 id="netpollclose"><code>netpollclose()</code><a hidden class="anchor" aria-hidden="true" href="#netpollclose">#</a></h2>
<ol>
<li>æŠŠæ–‡ä»¶æè¿°ç¬¦<code>fd</code>ä»<code>poller</code>å®ä¾‹ä¸­ç§»é™¤ï¼Œä¹Ÿå°±æ˜¯ä»<code>epoll</code>ä¸­åˆ é™¤ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">netpollclose</span><span class="p">(</span><span class="nx">fd</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="kt">int32</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">ev</span> <span class="nx">epollevent</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _EPOLL_CTL_DEL ä»epollæ–‡ä»¶æè¿°ç¬¦epfdä¸­åˆ é™¤ç›®æ ‡æ–‡ä»¶æè¿°ç¬¦fdã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¯¥äº‹ä»¶è¢«å¿½ç•¥ï¼Œå¯ä»¥ä¸ºNULLã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="o">-</span><span class="nf">epollctl</span><span class="p">(</span><span class="nx">epfd</span><span class="p">,</span> <span class="nx">_EPOLL_CTL_DEL</span><span class="p">,</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">fd</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">ev</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="netpollispolldescriptor"><code>netpollIsPollDescriptor()</code><a hidden class="anchor" aria-hidden="true" href="#netpollispolldescriptor">#</a></h2>
<ol>
<li>åˆ¤æ–­æ˜¯å¦æ˜¯é¡¶å±‚<code>poll</code>ï¼Œä»¥åŠæ˜¯<code>pip2</code>åˆ›å»ºçš„è¯»å’Œå†™æ–‡ä»¶æè¿°ç¬¦ã€‚</li>
<li>åˆ¤æ–­æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦è¢«<code>poller</code>ä½¿ç”¨ã€‚<code>epfd</code>ã€<code>netpollBreakRd</code>ã€<code>netpollBreakWr</code>å±äºè¢«<code>poller</code>ä½¿ç”¨çš„æè¿°ç¬¦ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">netpollIsPollDescriptor</span><span class="p">(</span><span class="nx">fd</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fd</span> <span class="o">==</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">epfd</span><span class="p">)</span> <span class="o">||</span> <span class="nx">fd</span> <span class="o">==</span> <span class="nx">netpollBreakRd</span> <span class="o">||</span> <span class="nx">fd</span> <span class="o">==</span> <span class="nx">netpollBreakWr</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="netpollbreak"><code>netpollBreak()</code><a hidden class="anchor" aria-hidden="true" href="#netpollbreak">#</a></h2>
<ol>
<li>ç”¨æ¥å”¤é†’<strong>é˜»å¡ä¸­</strong>çš„<code>netpoll</code>ï¼Œå®ƒå®é™…ä¸Šå°±æ˜¯å‘<code>netpollBreakWr</code>æè¿°ç¬¦ä¸­å†™å…¥æ•°æ®ï¼Œè¿™æ ·ä¸€æ¥<code>epoll</code>å°±ä¼šç›‘å¬åˆ°ã€‚</li>
<li><code>netpollBreakRd</code>çš„<code>EPOLLIN</code>äº‹ä»¶(<code>EPOLLIN</code>è¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¯»ï¼ˆåŒ…æ‹¬å¯¹ç«¯<code>SOCKET</code>æ­£å¸¸å…³é—­ï¼‰)ã€‚<code>netpollBreak</code>ä¸­æ–­<code>epollwait</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// netpollBreak interrupts an epollwait.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">netpollBreak</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// netpollWakeSigä¿¡å·ä¸»è¦ç”¨äºæœ¬è½®å·²ç»é€šçŸ¥è¿‡IOè½®è¯¢ï¼Œä½†æ˜¯è¿˜æ²¡å¤„ç†æœ‰å…¶ä»–çš„è°ƒç”¨æ­¤æ–¹æ³•æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä½¿ç”¨åŸå­æ“ä½œå°†netpollWakeSigç”±0å˜æˆ1ï¼Œè¡¨ç¤ºæ­£åœ¨å”¤é†’epollã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Cas</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">netpollWakeSig</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">var</span> <span class="nx">b</span> <span class="kt">byte</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å‘netpollBreakWrä¸­å†™å…¥æ•°æ®ï¼Œä¼šå¯¼è‡´é‚£äº›é˜»å¡åœ¨netpollå‡½æ•°ä¸­çš„çº¿ç¨‹ç›´æ¥è¿”å›å»æ‰§è¡Œåé¢ä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// netpollBreakWråœ¨pipe2å‡½æ•°ä¸­æ³¨å†Œæ—¶å·²ç»è®¾ç½®äº†éé˜»å¡ã€‚å› æ­¤è¿™é‡Œä¸ä¼šé˜»å¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">n</span> <span class="o">:=</span> <span class="nf">write</span><span class="p">(</span><span class="nx">netpollBreakWr</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å†™å…¥æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// åœ¨å†™å…¥ä»»ä½•æ•°æ®ä¹‹å‰ï¼Œè°ƒç”¨è¢«ä¿¡å·ä¸­æ–­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="o">-</span><span class="nx">_EINTR</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span> <span class="c1">// é‡è¯•ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å·²ä½¿ç”¨ O_NONBLOCK é€‰æ‹©äº†éé˜»å¡ I/Oï¼Œå¹¶ä¸”å†™å…¥å°†é˜»å¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// _EAGAINï¼šè¡¨ç¤ºç›®å‰æ²¡æœ‰å¯ç”¨çš„æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="o">-</span><span class="nx">_EAGAIN</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nb">println</span><span class="p">(</span><span class="s">&#34;runtime: netpollBreak write failed with&#34;</span><span class="p">,</span> <span class="o">-</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runtime: netpollBreak write failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="netpoll"><code>netpoll()</code><a hidden class="anchor" aria-hidden="true" href="#netpoll">#</a></h2>
<ol>
<li><code>netpoll</code>æ£€æŸ¥å‡†å¤‡å°±ç»ªçš„ç½‘ç»œè¿æ¥ã€‚è¿”å›å¯è¿è¡Œçš„<code>goroutine</code>åˆ—è¡¨ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>delay &lt; 0</code>ï¼šæ— é™æœŸé˜»å¡ã€‚</li>
<li><code>delay == 0</code>ï¼šä¸é˜»å¡ï¼Œç«‹å³è¿”å›ã€‚</li>
<li><code>delay &gt; 0</code>ï¼šé˜»å¡é•¿è¾¾delayçº³ç§’ã€‚</li>
</ul>
</li>
<li>è¿”å›å€¼ï¼š<code>gList</code>ï¼šä¸€ç»„å°±ç»ªçš„goroutineã€‚</li>
<li>æ ¹æ®å…¥å‚delayè®¾ç½®è°ƒç”¨<code>epoll_wait</code>çš„<code>timeout</code>å€¼ï¼Œè°ƒç”¨<code>epoll_wait</code>ä»<code>epoll</code>çš„<code>eventpoll.rdllist</code>åŒå‘åˆ—è¡¨ä¸­è·å–IOå°±ç»ªçš„fdåˆ—è¡¨ï¼Œéå†<code>epoll_wait</code>è¿”å›çš„<code>fd</code>åˆ—è¡¨ï¼Œ æ ¹æ®è°ƒç”¨<code>epoll_ctl</code>æ³¨å†Œ<code>fd</code>æ—¶å°è£…çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ç»„è£…å¯è¿è¡Œçš„<code>goroutine</code>å¹¶è¿”å›ã€‚</li>
<li>æ‰§è¡Œå®Œ<code>netpoll</code>ä¹‹åï¼Œä¼šè¿”å›ä¸€ä¸ªå°±ç»ª<code>fd</code>åˆ—è¡¨å¯¹åº”çš„<code>goroutine</code>åˆ—è¡¨ï¼Œæ¥ä¸‹æ¥å°†å°±ç»ªçš„<code>goroutine</code>åŠ å…¥åˆ°è°ƒåº¦é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è°ƒåº¦è¿è¡Œã€‚</li>
<li><strong>netpollçš„è°ƒç”¨æ—¶æœº</strong>ï¼š
<ul>
<li>åœ¨è°ƒåº¦å™¨ä¸­æ‰§è¡Œ<code>runtime.schedule()</code>ï¼Œè¯¥æ–¹æ³•ä¸­ä¼šæ‰§è¡Œ<code>runtime.findrunnable()</code>å‡½æ•°ä¸­è°ƒç”¨äº†<code>runtime.netpoll</code>è·å–å¾…æ‰§è¡Œçš„goroutineã€‚</li>
<li>Go runtimeåœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„<code>sysmon</code>ç›‘æ§çº¿ç¨‹ï¼Œ<code>sysmon</code>æ¯20us~10msè¿è¡Œä¸€æ¬¡ï¼Œæ¯æ¬¡è¿è¡Œä¼šæ£€æŸ¥è·ç¦»ä¸Šä¸€æ¬¡æ‰§è¡Œ<code>netpoll</code>æ˜¯å¦è¶…è¿‡10msï¼Œå¦‚æœæ˜¯åˆ™ä¼šè°ƒç”¨ä¸€æ¬¡<code>runtime.netpoll</code>ã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// netpoll checks for ready network connections.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Returns list of goroutines that become runnable.
</span></span></span><span class="line"><span class="cl"><span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1">// delay &lt; 0: blocks indefinitely;	
</span></span></span><span class="line"><span class="cl"><span class="c1">// delay == 0: does not block, just polls;
</span></span></span><span class="line"><span class="cl"><span class="c1">// delay &gt; 0: block for up to that many nanoseconds;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">netpoll</span><span class="p">(</span><span class="nx">delay</span> <span class="kt">int64</span><span class="p">)</span> <span class="nx">gList</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) epollæ²¡æœ‰åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">epfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">{</span>		
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">gList</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 2) ä¸‹é¢æŠŠçº³ç§’çº§çš„ delay è½¬æ¢æˆæ¯«ç§’çº§çš„ waitmsã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">waitms</span> <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">delay</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">waitms</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1">// æ°¸ä¹…é˜»å¡ï¼Œç›´åˆ°äº‹ä»¶å°±ç»ªè¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">delay</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">waitms</span> <span class="p">=</span> <span class="mi">0</span> 	<span class="c1">// ä¸é˜»å¡ï¼Œç«‹å³è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">delay</span> <span class="p">&lt;</span> <span class="mf">1e6</span> <span class="p">{</span> <span class="c1">// å°äº1æ¯«ç§’ï¼Œä¿®æ”¹ä¸ºé˜»å¡1æ¯«ç§’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">waitms</span> <span class="p">=</span> <span class="mi">1</span> 	<span class="c1">// é˜»å¡1æ¯«ç§’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">delay</span> <span class="p">&lt;</span> <span class="mf">1e15</span> <span class="p">{</span> <span class="c1">// å°äº 11.5 day
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 1e6 è¡¨ç¤º 1æ¯«ç§’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">waitms</span> <span class="p">=</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">delay</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">)</span> <span class="c1">// é˜»å¡æŒ‡å®šæ¯«ç§’
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// An arbitrary cap on how long to wait for a timer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 1e9 ms == ~11.5 days.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">waitms</span> <span class="p">=</span> <span class="mf">1e9</span>    <span class="c1">// æœ€é•¿ 11.5å¤©
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 3) é€šè¿‡epollwaitå‡½æ•°ç­‰å¾…IOäº‹ä»¶ï¼Œç¼“å†²åŒºå¤§å°ä¸º128ä¸ªepolleventã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¶…æ—¶æ—¶é—´æ˜¯ waitms æ¯«ç§’ã€‚å¦‚æœ epollwaitå‡½æ•°è¢«ä¸­æ–­æ‰“æ–­ï¼Œå°±é€šè¿‡gotoæ¥é‡è¯•ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// waitms å¤§äº0æ—¶ä¸ä¼šé‡è¯•ï¼Œå› ä¸ºéœ€è¦è¿”å›è°ƒç”¨è€…ä¸­å»é‡æ–°è®¡ç®—è¶…æ—¶æ—¶é—´ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¸‹é¢ä¼ å…¥epollwaitçš„æ•°é‡æ˜¯128ï¼Œè¡¨ç¤ºä¸€æ¬¡æœ€å¤§å°±ç»ª128ä¸ªäº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™æ ·å¯èƒ½å­˜åœ¨æ­¤æ¬¡å¤§äº128æ•°é‡æ—¶ï¼Œéœ€è¦ç­‰åˆ°ä¸‹ä¸€ä¸ªIOè½®è¯¢æ—¶é—´çª—å£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  type epollevent struct {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      events uint32   // äº‹ä»¶ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      data [8]byte    // å­˜å‚¨ç”¨æˆ·æ•°æ®ï¼Œåˆšå¥½æ˜¯ä¸€ä¸ªæŒ‡é’ˆå­˜å‚¨çš„å¤§å°ï¼Œè¯¥æ•°æ®ç”¨æˆ·æ˜¯å¯ä»¥ä¿®æ”¹çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">events</span> <span class="p">[</span><span class="mi">128</span><span class="p">]</span><span class="nx">epollevent</span>  <span class="c1">// ç”¨äºå­˜å‚¨å·²ç»å‡†å¤‡å¥½çš„æè¿°ç¬¦çš„äº‹ä»¶æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">retry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è°ƒç”¨epollwaitç­‰å¾…æ–‡ä»¶æè¿°ç¬¦è½¬æ¢æˆå¯å†™æˆ–å¯è¯»ï¼Œå¦‚æœæ²¡æœ‰epollwaitä¼šé˜»å¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">n</span> <span class="o">:=</span> <span class="nf">epollwait</span><span class="p">(</span><span class="nx">epfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">events</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">events</span><span class="p">)),</span> <span class="nx">waitms</span><span class="p">)</span>    <span class="c1">// è¿”å›æ´»è·ƒçš„æ•°é‡n
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// EBADFï¼šepfd ä¸æ˜¯æœ‰æ•ˆçš„æ–‡ä»¶æè¿°ç¬¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// EFAULTï¼šäº‹ä»¶æŒ‡å‘çš„å†…å­˜åŒºåŸŸæ— æ³•ç”¨å†™æƒé™è®¿é—®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// EINVALï¼šepfd ä¸æ˜¯epollæ–‡ä»¶æè¿°ç¬¦ï¼Œæˆ–è€…maxevents(ç¬¬ä¸‰ä¸ªå‚æ•°)å°äºç­‰äº0ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">n</span> <span class="o">!=</span> <span class="o">-</span><span class="nx">_EINTR</span> <span class="p">{</span> <span class="c1">// EINTR è¢«CPUä¸­æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nb">println</span><span class="p">(</span><span class="s">&#34;runtime: epollwait on fd&#34;</span><span class="p">,</span> <span class="nx">epfd</span><span class="p">,</span> <span class="s">&#34;failed with&#34;</span><span class="p">,</span> <span class="o">-</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runtime: netpoll failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// If a timed sleep was interrupted, just return to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// recalculate how long we should sleep now.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å¦‚æœå®šæ—¶ç¡çœ è¢«ä¸­æ–­ï¼Œåªéœ€è¿”å›é‡æ–°è®¡ç®—æˆ‘ä»¬ç°åœ¨åº”è¯¥ç¡å¤šä¹…ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// _EINTR: åœ¨ä»»ä½•è¯·æ±‚çš„äº‹ä»¶å‘ç”Ÿæˆ–è¶…æ—¶åˆ°æœŸä¹‹å‰ï¼Œè¯¥è°ƒç”¨è¢«ä¿¡å·å¤„ç†ç¨‹åºä¸­æ–­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">waitms</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">gList</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è¢«ä¸­æ–­ AND waitms &lt;= 0 æƒ…å†µé‡è¯•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">goto</span> <span class="nx">retry</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// type gList struct { head guintptr }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">toRun</span> <span class="nx">gList</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ„å‘³ç€è¢«ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦å‡ºç°äº†å¾…å¤„ç†çš„äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">int32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å°±ç»ªçš„IOäº‹ä»¶é›†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">ev</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">events</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl">        <span class="c1">// å½“å‰å°±ç»ªæè¿°ç¬¦æ²¡æœ‰äº‹ä»¶ç±»å‹ï¼Œç›´æ¥è·³è¿‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">events</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// äº‹ä»¶æ¥æºæ˜¯å¦æ˜¯netpollBreakRdï¼Œè¯¥æè¿°ç¬¦æ¥ä¹‹pipe2å‡½æ•°åˆ›å»º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ¥è‡ªpipe2å‡½æ•°åˆ›å»ºçš„é€šä¿¡ï¼ŒnetpollBreakRdæ˜¯LTæ°´å¹³è§¦å‘å¦‚æœä¸è¯»å–ä¼šä¸€ç›´è§¦å‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¯¥äº‹ä»¶æ¥è‡ª netpollBreak() æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åªä¼šåœ¨åˆ›å»ºtimeræ—¶å’ŒfindRunnable()å‡½æ•°ä¸­è¢«è°ƒç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="o">*</span><span class="p">(</span><span class="o">**</span><span class="kt">uintptr</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ev</span><span class="p">.</span><span class="nx">data</span><span class="p">))</span> <span class="o">==</span> <span class="o">&amp;</span><span class="nx">netpollBreakRd</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å¯¹äºæ–‡ä»¶æè¿°ç¬¦ netpollBreakRd è€Œè¨€ï¼Œåªæœ‰ _EPOLLIN äº‹ä»¶æ˜¯æ­£å¸¸çš„ï¼Œå…¶ä»–éƒ½ä¼šè¢«è§†ä¸ºå¼‚å¸¸ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">events</span> <span class="o">!=</span> <span class="nx">_EPOLLIN</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nb">println</span><span class="p">(</span><span class="s">&#34;runtime: netpoll: break fd ready for&#34;</span><span class="p">,</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">events</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runtime: netpoll: break fd ready for something unexpected&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// è¿™ç§æƒ…å†µä¸‹åªå¤„ç†ä¸æ˜¯ç«‹å³è¿”å›æƒ…å†µä¸‹ï¼Œå¦‚æœæ˜¯ç«‹å³è¿”å›æƒ…å†µæ—¶ï¼Œæ•°æ®å¹¶æœªè¢«è¯»å–ï¼Œä¸‹æ¬¡è¿˜ä¼šè§¦å‘è¯¥ä¿¡å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿™ç§æƒ…å†µä¸‹åªåœ¨runtime.findrunnable()å‡½æ•°ä¸­å­˜åœ¨ï¼Œçº¿ç¨‹åœ¨å¯»æ‰¾gæ— æœæ—¶ï¼Œæœ€ååªèƒ½åœ¨IOè½®è¯¢å¤„ç­‰å¾…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// åªæœ‰åœ¨ delay ä¸ä¸º0ï¼Œä¹Ÿå°±æ˜¯é˜»å¡å¼netpollæ—¶ï¼Œæ‰è¯»å–netpollBreakRdä¸­çš„æ•°æ®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">delay</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// netpollBreakRd çš„æœ¬æ„ä¹Ÿæ˜¯åªå”¤é†’delay != 0çš„netpollï¼Œå› ä¸ºè¿™äº›åœ¨é˜»å¡éœ€è¦è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// netpollBreak could be picked up by a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// nonblocking poll. Only read the byte
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// if blocking.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// netpollBreak å¯ä»¥é€šè¿‡éé˜»å¡è½®è¯¢æ¥è·å–ã€‚ ä»…åœ¨é˜»å¡æ—¶è¯»å–å­—èŠ‚ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kd">var</span> <span class="nx">tmp</span> <span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// æŠŠå†™å…¥çš„æ•°æ®è¯»å–è®©ç¼“å­˜åŒºä¸ºç©º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">read</span><span class="p">(</span><span class="nb">int32</span><span class="p">(</span><span class="nx">netpollBreakRd</span><span class="p">),</span> <span class="nf">noescape</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="nb">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">tmp</span><span class="p">)))</span>	
</span></span><span class="line"><span class="cl">                <span class="c1">// å°†netpollWakeSigç”±1å˜æˆ0ï¼Œè¡¨ç¤ºå½“å‰äº‹ä»¶å·²è¢«è¯»å–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">netpollWakeSig</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// æ ¹æ®epollè¿”å›çš„IOäº‹ä»¶æ ‡å¿—ä½ä¸ºmodeèµ‹å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  r è¡¨ç¤ºå¯è¯»ï¼Œw è¡¨ç¤ºå¯å†™ï¼Œr+w è¡¨ç¤ºæ—¢å¯è¯»åˆå¯å†™ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ£€æµ‹IOäº‹ä»¶ä¸­çš„é”™è¯¯æ ‡å¿—ä½ï¼Œå¹¶ç›¸åº”çš„ä¸ºpd.everrèµ‹å€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆ¤æ–­å‘ç”Ÿçš„äº‹ä»¶ç±»å‹,è¯»ç±»å‹æˆ–è€…å†™ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">var</span> <span class="nx">mode</span> <span class="kt">int32</span>		<span class="c1">// å­˜å‚¨å½“å‰ç±»å‹ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// EPOLLIN ï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¯»ï¼ˆåŒ…æ‹¬å¯¹ç«¯SOCKETæ­£å¸¸å…³é—­ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// EPOLLRDHUPï¼šå¯¹ç«¯æè¿°ç¬¦äº§ç”Ÿä¸€ä¸ªæŒ‚æ–­äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// EPOLLHUPï¼šæœ¬ç«¯æè¿°ç¬¦äº§ç”Ÿä¸€ä¸ªæŒ‚æ–­äº‹ä»¶ï¼Œé»˜è®¤ç›‘æµ‹äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// EPOLLERRï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">events</span><span class="o">&amp;</span><span class="p">(</span><span class="nx">_EPOLLIN</span><span class="p">|</span><span class="nx">_EPOLLRDHUP</span><span class="p">|</span><span class="nx">_EPOLLHUP</span><span class="p">|</span><span class="nx">_EPOLLERR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">mode</span> <span class="o">+=</span> <span class="sc">&#39;r&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// EPOLLOUTï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯ä»¥å†™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// EPOLLHUPï¼šæœ¬ç«¯æè¿°ç¬¦äº§ç”Ÿä¸€ä¸ªæŒ‚æ–­äº‹ä»¶ï¼Œé»˜è®¤ç›‘æµ‹äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// EPOLLERRï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">events</span><span class="o">&amp;</span><span class="p">(</span><span class="nx">_EPOLLOUT</span><span class="p">|</span><span class="nx">_EPOLLHUP</span><span class="p">|</span><span class="nx">_EPOLLERR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">mode</span> <span class="o">+=</span> <span class="sc">&#39;w&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// modeä¸ä¸º0ï¼Œè¡¨ç¤ºæœ‰IOäº‹ä»¶ï¼Œéœ€è¦ä»ev.dataå­—æ®µå¾—åˆ°ä¸IOäº‹ä»¶å…³è”çš„pollDescã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">mode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å–å‡ºä¿å­˜åœ¨ epollevent é‡Œçš„pollDescï¼Œå› ä¸ºè¦æ ¹æ®è¿™ä¸ªå†…å®¹å»æ¢å¤gå¦‚æœgå·²è¢«æŒ‚èµ·æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">pd</span> <span class="o">:=</span> <span class="o">*</span><span class="p">(</span><span class="o">**</span><span class="nx">pollDesc</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ev</span><span class="p">.</span><span class="nx">data</span><span class="p">))</span> <span class="c1">// *pollDesc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¯¹åº”çš„_EPOLLERRæ–‡ä»¶æè¿°ç¬¦å‡ºç°é”™è¯¯æ—¶ï¼Œæ ‡è®°é”™è¯¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">pd</span><span class="p">.</span><span class="nf">setEventErr</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">events</span> <span class="o">==</span> <span class="nx">_EPOLLERR</span><span class="p">)</span>	<span class="c1">// è®¾ç½®pollDescçš„EpollErré”™è¯¯ä½ï¼Œå¦‚æœæ˜¯è¿™ç§çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">netpollready</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">toRun</span><span class="p">,</span> <span class="nx">pd</span><span class="p">,</span> <span class="nx">mode</span><span class="p">)</span>	<span class="c1">// å¤„ç†å°±ç»ªçš„æè¿°ç¬¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">toRun</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="netpollready"><code>netpollready()</code><a hidden class="anchor" aria-hidden="true" href="#netpollready">#</a></h3>
<ol>
<li><code>go1.19.3/src/runtime/runtime/netpoll.go</code>ã€‚</li>
<li><code>netpollready</code>ç”±ç‰¹å®šäºå¹³å°çš„<code>netpoll</code>å‡½æ•°è°ƒç”¨ã€‚å®ƒå£°æ˜ä¸<code>pd</code>ç›¸å…³çš„<code>fd</code>å·²ç»ä¸ºI/Oåšå¥½äº†å‡†å¤‡ã€‚</li>
<li><code>toRun</code>å‚æ•°ç”¨äºæ„å»ºä¸€ä¸ªä»<code>netpoll</code>è¿”å›çš„<code>goroutines</code>åˆ—è¡¨ã€‚<code>mode</code>å‚æ•°æ˜¯<code>'r'</code>ã€<code>'w'</code>æˆ–<code>'r'+'w'</code>ï¼Œè¡¨ç¤º<code>fd</code>æ˜¯å¦å‡†å¤‡å¥½è¯»ã€å†™æˆ–åŒæ—¶è¯»å’Œå†™ã€‚</li>
<li>è¿™å¯èƒ½ä¼šåœ¨æ•´ä¸ªç³»ç»Ÿåœæ­¢æ—¶è¿è¡Œï¼Œå› æ­¤ä¸å…è®¸è®¾ç½®å†™å±éšœã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// netpollready is called by the platform-specific netpoll function.
</span></span></span><span class="line"><span class="cl"><span class="c1">// It declares that the fd associated with pd is ready for I/O.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The toRun argument is used to build a list of goroutines to return
</span></span></span><span class="line"><span class="cl"><span class="c1">// from netpoll. The mode argument is &#39;r&#39;, &#39;w&#39;, or &#39;r&#39;+&#39;w&#39; to indicate
</span></span></span><span class="line"><span class="cl"><span class="c1">// whether the fd is ready for reading or writing or both.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// This may run while the world is stopped, so write barriers are not allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrier
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">netpollready</span><span class="p">(</span><span class="nx">toRun</span> <span class="o">*</span><span class="nx">gList</span><span class="p">,</span> <span class="nx">pd</span> <span class="o">*</span><span class="nx">pollDesc</span><span class="p">,</span> <span class="nx">mode</span> <span class="kt">int32</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">rg</span><span class="p">,</span> <span class="nx">wg</span> <span class="o">*</span><span class="nx">g</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">mode</span> <span class="o">==</span> <span class="sc">&#39;r&#39;</span> <span class="o">||</span> <span class="nx">mode</span> <span class="o">==</span> <span class="sc">&#39;r&#39;</span><span class="o">+</span><span class="sc">&#39;w&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// netpollunblock å¯èƒ½è¿”å› goroutine æˆ– nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">rg</span> <span class="p">=</span> <span class="nf">netpollunblock</span><span class="p">(</span><span class="nx">pd</span><span class="p">,</span> <span class="sc">&#39;r&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">mode</span> <span class="o">==</span> <span class="sc">&#39;w&#39;</span> <span class="o">||</span> <span class="nx">mode</span> <span class="o">==</span> <span class="sc">&#39;r&#39;</span><span class="o">+</span><span class="sc">&#39;w&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">wg</span> <span class="p">=</span> <span class="nf">netpollunblock</span><span class="p">(</span><span class="nx">pd</span><span class="p">,</span> <span class="sc">&#39;w&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">rg</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¹¶å…¥ toRun ä¸­ï¼Œè¿™éƒ¨åˆ† goroutine ç­‰å¾…æ”¾å…¥è°ƒåº¦æ± ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">toRun</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">rg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">wg</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">toRun</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">wg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="netpollunblock"><code>netpollunblock()</code><a hidden class="anchor" aria-hidden="true" href="#netpollunblock">#</a></h3>
<ol>
<li><code>go1.19.3/src/runtime/runtime/netpoll.go</code>ã€‚</li>
<li>netpollunblockè§£é™¤é˜»å¡ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>pd *pollDesc</code>ï¼špollDescã€‚</li>
<li><code>mode int32</code>ï¼šè¯»<code>r</code>æˆ–å†™<code>w</code>ã€‚</li>
<li><code>ioready bool</code>ï¼š<strong>true</strong>-I/Oè¯»ï¼ˆç”¨äºä»pollDescä¸­è·å– goroutineï¼‰ï¼Œ<strong>false</strong>-è¯»å†™è¶…æ—¶ä»pollDescä¸­è·å–goroutineã€‚</li>
</ul>
</li>
<li>è¿”å›å€¼ï¼š<code>*g</code>è¿”å›å°±ç»ªçš„goroutineï¼Œå¯èƒ½æ˜¯nilã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">netpollunblock</span><span class="p">(</span><span class="nx">pd</span> <span class="o">*</span><span class="nx">pollDesc</span><span class="p">,</span> <span class="nx">mode</span> <span class="kt">int32</span><span class="p">,</span> <span class="nx">ioready</span> <span class="kt">bool</span><span class="p">)</span> <span class="o">*</span><span class="nx">g</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ ¹æ® mode ä»rgæˆ–wgå–å‡º goroutineã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gpp</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">pd</span><span class="p">.</span><span class="nx">rg</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">mode</span> <span class="o">==</span> <span class="sc">&#39;w&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gpp</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">pd</span><span class="p">.</span><span class="nx">wg</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åŸå­è¯»å–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">old</span> <span class="o">:=</span> <span class="nx">gpp</span><span class="p">.</span><span class="nf">Load</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// pdReadyï¼šè¡¨ç¤ºfdçš„æ•°æ®å·²ç»å°±ç»ªï¼Œå¯ä¾›è¯»å–æˆ–å†™ã€‚è¯¥å€¼ä»gä¿®æ”¹pdReadyã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿™ç§æƒ…å†µå¯èƒ½ goroutine å·²ç»è¢«è¿”å›ç»™è°ƒç”¨è€…äº†ã€‚ä»€ä¹ˆéƒ½ä¸åšç›´æ¥è¿”å›ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">old</span> <span class="o">==</span> <span class="nx">pdReady</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// nilï¼šæ²¡æœ‰ä»€ä¹ˆå¯åšçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">old</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">ioready</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Only set pdReady for ioready. runtime_pollWait
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// will check for timeout/cancel before waiting.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// åªåœ¨ioreadyä¸­è®¾ç½®pdReadyã€‚runtime_pollWaitå°†åœ¨ç­‰å¾…ä¹‹å‰æ£€æŸ¥ timeout/cancelã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// oldæ˜¯0ã€goroutineã€pdWaitè¿™ä¸‰ç§æƒ…å†µã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">var</span> <span class="nx">new</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">ioready</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ä¿®æ”¹ä¸ºpdReadyï¼Œè¡¨ç¤ºæ•°æ®å·²å°±ç»ªæˆ–å†™
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">new</span> <span class="p">=</span> <span class="nx">pdReady</span> 
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// CAS äº¤æ¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">gpp</span><span class="p">.</span><span class="nf">CompareAndSwap</span><span class="p">(</span><span class="nx">old</span><span class="p">,</span> <span class="nx">new</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// pdWaitï¼šè¡¨ç¤ºæŸä¸ªgoroutineå³å°†æŒ‚èµ·å¹¶ç­‰å¾…fdçš„å¯è¯»å¯å†™äº‹ä»¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">old</span> <span class="o">==</span> <span class="nx">pdWait</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">old</span> <span class="p">=</span> <span class="mi">0</span> <span class="c1">// nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="nx">g</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">old</span><span class="p">))</span> <span class="c1">// nil æˆ– *g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="wakenetpoller"><code>wakeNetPoller()</code><a hidden class="anchor" aria-hidden="true" href="#wakenetpoller">#</a></h2>
<ol>
<li>è¯¥å‡½æ•°åœ¨<code>time</code>æºç ä¸­è¢«è°ƒç”¨ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦å‘èµ·I/Oç½‘ç»œè½®è¯¢ã€‚</li>
<li>è¯¥æ–¹æ³•æ˜¯ä¸ºäº†é˜²æ­¢å®šæ—¶å™¨è§¦å‘æ—¶é—´åˆ°äº†æ²¡æœ‰çº¿ç¨‹èƒ½è§¦å‘çš„æƒ…å†µï¼Œå½“åªå‰©é˜»å¡åœ¨<code>netpoll</code>çš„çº¿ç¨‹æˆ–æ‰€æœ‰çš„çº¿ç¨‹éƒ½å¤„äºç­‰å¾…ä¸­æ—¶ï¼Œ<code>timer</code>å¯èƒ½ä¸èƒ½æŒ‰æ—¶è§¦å‘çš„æƒ…å†µã€‚</li>
<li><code>wakeenetpoller</code>å”¤é†’åœ¨ç½‘ç»œè½®è¯¢å™¨(<code>network poller</code>)ä¸­ç¡çœ çš„çº¿ç¨‹ï¼Œå¦‚æœå®ƒä¸æ‰“ç®—åœ¨<code>when</code>å‚æ•°ä¹‹å‰è¢«å”¤é†’;</li>
<li>æˆ–è€…å”¤é†’ä¸€ä¸ªç©ºé—²çš„<code>P</code>æ¥æœåŠ¡è®¡æ—¶å™¨(<code>timers</code>)å’Œç½‘ç»œè½®è¯¢å™¨(<code>network poller</code>)(å¦‚æœè¿˜æ²¡æœ‰çš„è¯)ã€‚</li>
<li><code>when int64</code>ï¼šè¡¨ç¤ºæœ€è¿‘çš„<code>timer</code>è§¦å‘çš„æ—¶é—´ç‚¹ï¼Œå› æ­¤ä¸ºäº†é¿å…å½“å‰æœ€è¿‘çš„<code>timer</code>åˆ°æ—¶é—´èƒ½å‡†æ—¶è§¦å‘ï¼Œéœ€è¦è°ƒæ•´<code>netpoll</code>çš„é˜»å¡äº‹ä»¶ç‚¹ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// wakeNetPoller wakes up the thread sleeping in the network poller if it isn&#39;t
</span></span></span><span class="line"><span class="cl"><span class="c1">// going to wake up before the when argument; or it wakes an idle P to service
</span></span></span><span class="line"><span class="cl"><span class="c1">// timers and the network poller if there isn&#39;t one already.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">wakeNetPoller</span><span class="p">(</span><span class="nx">when</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// sched.lastpollï¼šè®°å½•çš„æ˜¯ä¸Šæ¬¡æ‰§è¡Œnetpollçš„æ—¶é—´ï¼Œå¦‚æœç­‰äº0ï¼Œåˆ™è¡¨ç¤ºæŸä¸ªçº¿ç¨‹æ­£åœ¨é˜»å¡å¼åœ°æ‰§è¡Œnetpollã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// sched.lastpoll è¢«è®¾ç½®ä¸º0åªä¼šåœ¨ findrunnable å‡½æ•°ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lastpoll</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// In findrunnable we ensure that when polling the pollUntil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// field is either zero or the time to which the current
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// poll is expected to run. This can have a spurious wakeup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// but should never miss a wakeup.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åœ¨ findrunnable ä¸­ï¼Œæˆ‘ä»¬è¦ç¡®ä¿è½®è¯¢æ—¶ pollUntil å­—æ®µè¦ä¹ˆæ˜¯0ï¼Œè¦ä¹ˆä¸ºå½“å‰pollé¢„æœŸè¿è¡Œçš„æ—¶é—´ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿™é‡Œå¯èƒ½ä¼šæ˜¯ä¸€ä¸ªè™šå‡çš„å”¤é†’ï¼Œä½†ä¸åº”è¯¥é”™è¿‡å”¤é†’ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// sched.pollUntilï¼šè¡¨ç¤ºé˜»å¡å¼åœ°netpollå°†åœ¨ä½•æ—¶è¢«å”¤é†’ã€‚è¯¥å€¼åœ¨ findrunnable å‡½æ•°ä¸­è¢«è®¾ç½®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// sched.pollUntil å€¼å¤§äº0æ—¶ï¼Œè¡¨ç¤ºæœ€è¿‘çš„timerè§¦å‘æ—¶é—´æ®µã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">pollerPollUntil</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">atomic</span><span class="p">.</span><span class="nf">Load64</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">pollUntil</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// pollerPollUntil &gt; whenï¼šå­˜åœ¨æœ€æ–°çš„è®¡æ—¶å™¨è¢«åŠ å…¥whenæ—¶é—´æ®µåè§¦å‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">pollerPollUntil</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">pollerPollUntil</span> <span class="p">&gt;</span> <span class="nx">when</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">netpollBreak</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// There are no threads in the network poller, try to get
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// one there so it can handle new timers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">GOOS</span> <span class="o">!=</span> <span class="s">&#34;plan9&#34;</span> <span class="p">{</span> <span class="c1">// Temporary workaround - see issue #42303.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">wakep</span><span class="p">()</span> <span class="c1">// å°è¯•å”¤é†’ä¸€ä¸ªç©ºé—²çš„Pèµ·æ¥æœåŠ¡timerå’Œnetwork pollerã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="netpollarm"><code>netpollarm()</code><a hidden class="anchor" aria-hidden="true" href="#netpollarm">#</a></h2>
<ol>
<li>è¯¥å‡½æ•°åœ¨linuxä¸Šä¸ä¼šè°ƒç”¨ï¼Œå……å½“ä¸€ä¸ªå ä½ä½œç”¨ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">netpollarm</span><span class="p">(</span><span class="nx">pd</span> <span class="o">*</span><span class="nx">pollDesc</span><span class="p">,</span> <span class="nx">mode</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runtime: unused&#34;</span><span class="p">)</span> <span class="c1">// runtime: æœªä½¿ç”¨çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å‚è€ƒ">å‚è€ƒ<a hidden class="anchor" aria-hidden="true" href="#å‚è€ƒ">#</a></h2>
<ol>
<li><a href="https://www.cnblogs.com/luozhiyun/p/14390824.html" target="_blank" rel="noopener">è¯¦è§£Goè¯­è¨€I/Oå¤šè·¯å¤ç”¨netpolleræ¨¡å‹</a></li>
<li><a href="https://blog.csdn.net/daocaokafei/article/details/117397600" target="_blank" rel="noopener">epollè¯¦è§£</a></li>
<li><a href="https://blog.csdn.net/weixin_43705457/article/details/104522820" target="_blank" rel="noopener">epollæºç è§£æ(1) epoll_create</a></li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://heliu.site/tags/golang/">Golang</a></li>
      <li><a href="https://heliu.site/tags/netpoll/">Netpoll</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://heliu.site/posts/golang/netpoll/linux/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Linux epoll</span>
  </a>
  <a class="next" href="https://heliu.site/posts/vue/component/register/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>æ³¨å†Œ</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
    </span>
    <span id="busuanzi_container_site_uv">
        æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
    </span>
    </div>
        <span>Copyright Â© 2024 èœ€ICPå¤‡2024091074å· <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
