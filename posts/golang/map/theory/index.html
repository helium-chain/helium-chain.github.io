<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Map(åŸç†) | Helium</title>
<meta name="keywords" content="golang, å­—å…¸">
<meta name="description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬">
<meta name="author" content="helium">
<link rel="canonical" href="https://heliu.site/posts/golang/map/theory/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://heliu.site/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://heliu.site/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://heliu.site/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://heliu.site/apple-touch-icon.png">
<link rel="mask-icon" href="https://heliu.site/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://heliu.site/posts/golang/map/theory/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="Map(åŸç†)" />
<meta property="og:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://heliu.site/posts/golang/map/theory/" />
<meta property="og:image" content="https://heliu.site/favicon-32x32.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-04-27T00:00:00+00:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://heliu.site/favicon-32x32.png" />
<meta name="twitter:title" content="Map(åŸç†)"/>
<meta name="twitter:description" content="ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://heliu.site/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Golang åˆé›†",
      "item": "https://heliu.site/posts/golang/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ç¬¬8ç«  Map",
      "item": "https://heliu.site/posts/golang/map/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Map(åŸç†)",
      "item": "https://heliu.site/posts/golang/map/theory/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Map(åŸç†)",
  "name": "Map(åŸç†)",
  "description": "ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18+ç‰ˆæœ¬",
  "keywords": [
    "golang", "å­—å…¸"
  ],
  "articleBody": " æœ¬ç¯‡ä»‹ç»mapçš„golangæºç ï¼Œå…¨ç¯‡ä»£ç è¾ƒå¤šæ¯”è¾ƒæ¯ç‡¥ã€‚ map åŒ…è¯´æ˜ï¼š map åªæ˜¯ä¸€ä¸ª hash è¡¨ã€‚æ•°æ®è¢«å®‰æ’åœ¨æ¡¶æ•°ç»„ä¸­ã€‚æ¯ä¸ªæ¡¶æœ€å¤šåŒ…å«8ä¸ª key/elem å¯¹ã€‚ hash çš„low-order bits(hash\u00261\u003c",
  "wordCount" : "11229",
  "inLanguage": "zh",
  "image": "https://heliu.site/favicon-32x32.png","datePublished": "2021-01-27T00:00:00Z",
  "dateModified": "2024-04-27T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://heliu.site/posts/golang/map/theory/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://heliu.site/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://heliu.site/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://heliu.site/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://heliu.site/" title="ä¸»é¡µ">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/posts" title="æ–‡ç« ">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/archives" title="æ—¶é—´è½´">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/tags/" title="æ ‡ç­¾">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/search/" title="æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/support" title="æ‰“èµ">
                    <span>ğŸ«¶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://heliu.site/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/">Article</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/golang/">Golang åˆé›†</a>&nbsp;Â»&nbsp;<a href="https://heliu.site/posts/golang/map/">ç¬¬8ç«  Map</a></div>
    <h1 class="post-title entry-hint-parent">
      Map(åŸç†)
    </h1>
    <div class="post-description">
      ğŸ’¥æœ¬æ–‡ç« æ‰€æœ‰ç›¸å…³goä»£ç å‚è€ƒè‡ªgo 1.18&#43;ç‰ˆæœ¬
    </div>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2021-01-27</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2024-04-27</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>11229å­—</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>53åˆ†é’Ÿ</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &nbsp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://heliu.site/tags/golang/" target="_blank" rel="noopener">Golang</a>
            <a href="https://heliu.site/tags/%E5%AD%97%E5%85%B8/" target="_blank" rel="noopener">å­—å…¸</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &nbsp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">ç›®å½•</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#hmap-" aria-label="hmap ğŸš€">hmap ğŸš€</a><ul>
                            
                    <li>
                        <a href="#type-hmap-struct" aria-label="type hmap struct">type hmap struct</a><ul>
                            
                    <li>
                        <a href="#createoverflow" aria-label="createOverflow()">createOverflow()</a></li>
                    <li>
                        <a href="#growing" aria-label="growing()">growing()</a></li>
                    <li>
                        <a href="#samesizegrow" aria-label="sameSizeGrow()">sameSizeGrow()</a></li>
                    <li>
                        <a href="#noldbuckets" aria-label="noldbuckets()">noldbuckets()</a></li>
                    <li>
                        <a href="#oldbucketmask" aria-label="oldbucketmask()">oldbucketmask()</a></li>
                    <li>
                        <a href="#incrnoverflow" aria-label="incrnoverflow()">incrnoverflow()</a></li>
                    <li>
                        <a href="#newoverflow" aria-label="newoverflow()">newoverflow()</a></li></ul>
                    </li>
                    <li>
                        <a href="#type-bmap-struct" aria-label="type bmap struct">type bmap struct</a><ul>
                            
                    <li>
                        <a href="#evacuated" aria-label="evacuated()">evacuated()</a></li>
                    <li>
                        <a href="#overflow" aria-label="overflow()">overflow()</a></li>
                    <li>
                        <a href="#setoverflow" aria-label="setoverflow()">setoverflow()</a></li>
                    <li>
                        <a href="#keys" aria-label="keys()">keys()</a></li></ul>
                    </li>
                    <li>
                        <a href="#type-mapextra-struct" aria-label="type mapextra struct">type mapextra struct</a></li>
                    <li>
                        <a href="#constant" aria-label="constant">constant</a></li>
                    <li>
                        <a href="#type-maptype-struct" aria-label="type maptype struct">type maptype struct</a><ul>
                            
                    <li>
                        <a href="#indirectkey" aria-label="indirectkey()">indirectkey()</a></li>
                    <li>
                        <a href="#indirectelem" aria-label="indirectelem()">indirectelem()</a></li>
                    <li>
                        <a href="#reflexivekey" aria-label="reflexivekey()">reflexivekey()</a></li>
                    <li>
                        <a href="#needkeyupdate" aria-label="needkeyupdate()">needkeyupdate()</a></li>
                    <li>
                        <a href="#hashmightpanic" aria-label="hashMightPanic()">hashMightPanic()</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#make-" aria-label="make() ğŸš€">make() ğŸš€</a><ul>
                            
                    <li>
                        <a href="#overloadfactor" aria-label="overLoadFactor()">overLoadFactor()</a></li>
                    <li>
                        <a href="#bucketshift" aria-label="bucketShift()">bucketShift()</a></li>
                    <li>
                        <a href="#makebucketarray" aria-label="makeBucketArray()">makeBucketArray()</a></li>
                    <li>
                        <a href="#newarray" aria-label="newarray()">newarray()</a></li>
                    <li>
                        <a href="#makemap_small" aria-label="makemap_small()">makemap_small()</a></li></ul>
                    </li>
                    <li>
                        <a href="#map-get-" aria-label="map Get ğŸš€">map Get ğŸš€</a><ul>
                            
                    <li>
                        <a href="#v--hkey" aria-label="v := h[key]">v := h[key]</a><ul>
                            
                    <li>
                        <a href="#mapaccess1_fat" aria-label="mapaccess1_fat()">mapaccess1_fat()</a></li>
                    <li>
                        <a href="#mapaccess1" aria-label="mapaccess1()">mapaccess1()</a></li>
                    <li>
                        <a href="#bucketmask" aria-label="bucketMask()">bucketMask()</a></li>
                    <li>
                        <a href="#tophash" aria-label="tophash()">tophash()</a></li>
                    <li>
                        <a href="#evacuated-1" aria-label="evacuated()">evacuated()</a></li></ul>
                    </li>
                    <li>
                        <a href="#v-b--hkey" aria-label="v, b := h[key]">v, b := h[key]</a><ul>
                            
                    <li>
                        <a href="#mapaccess2_fat" aria-label="mapaccess2_fat()">mapaccess2_fat()</a></li>
                    <li>
                        <a href="#mapaccess2" aria-label="mapaccess2()">mapaccess2()</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#map-set-" aria-label="map Set ğŸš€">map Set ğŸš€</a><ul>
                            
                    <li>
                        <a href="#hk--v" aria-label="h[k] = v">h[k] = v</a><ul>
                            
                    <li>
                        <a href="#reflect_mapassign" aria-label="reflect_mapassign()">reflect_mapassign()</a></li>
                    <li>
                        <a href="#mapassign" aria-label="mapassign()">mapassign()</a></li>
                    <li>
                        <a href="#isempty" aria-label="isEmpty()">isEmpty()</a></li>
                    <li>
                        <a href="#overloadfactor-1" aria-label="overLoadFactor()">overLoadFactor()</a></li>
                    <li>
                        <a href="#toomanyoverflowbuckets" aria-label="tooManyOverflowBuckets()">tooManyOverflowBuckets()</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e6%89%a9%e5%ae%b9-" aria-label="æ‰©å®¹ ğŸš€">æ‰©å®¹ ğŸš€</a><ul>
                            
                    <li>
                        <a href="#%e7%bf%bb%e5%80%8d%e6%89%a9%e5%ae%b9%e6%9d%a1%e4%bb%b6" aria-label="ç¿»å€æ‰©å®¹æ¡ä»¶">ç¿»å€æ‰©å®¹æ¡ä»¶</a><ul>
                            
                    <li>
                        <a href="#overloadfactor-2" aria-label="overLoadFactor()">overLoadFactor()</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e7%ad%89%e9%87%8f%e6%89%a9%e5%ae%b9%e6%9d%a1%e4%bb%b6" aria-label="ç­‰é‡æ‰©å®¹æ¡ä»¶">ç­‰é‡æ‰©å®¹æ¡ä»¶</a><ul>
                            
                    <li>
                        <a href="#toomanyoverflowbuckets-1" aria-label="tooManyOverflowBuckets()">tooManyOverflowBuckets()</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%89%a9%e5%ae%b9%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="æ‰©å®¹åˆå§‹åŒ–">æ‰©å®¹åˆå§‹åŒ–</a><ul>
                            
                    <li>
                        <a href="#hashgrow" aria-label="hashGrow()">hashGrow()</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%b8%90%e8%bf%9b%e5%bc%8f%e8%bf%81%e7%a7%bb" aria-label="æ¸è¿›å¼è¿ç§»">æ¸è¿›å¼è¿ç§»</a><ul>
                            
                    <li>
                        <a href="#growwork" aria-label="growWork()">growWork()</a></li>
                    <li>
                        <a href="#evacuate" aria-label="evacuate()">evacuate()</a></li>
                    <li>
                        <a href="#evacuated-2" aria-label="evacuated()">evacuated()</a></li>
                    <li>
                        <a href="#type-evacdst-struct" aria-label="type evacDst struct">type evacDst struct</a></li>
                    <li>
                        <a href="#isempty-1" aria-label="isEmpty()">isEmpty()</a></li>
                    <li>
                        <a href="#advanceevacuationmark" aria-label="advanceEvacuationMark()">advanceEvacuationMark()</a></li>
                    <li>
                        <a href="#bucketevacuated" aria-label="bucketEvacuated()">bucketEvacuated()</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e5%88%a0%e9%99%a4-" aria-label="åˆ é™¤ ğŸš€">åˆ é™¤ ğŸš€</a><ul>
                            
                    <li>
                        <a href="#delete" aria-label="delete()">delete()</a></li>
                    <li>
                        <a href="#mapdelete" aria-label="mapdelete()">mapdelete()</a></li></ul>
                    </li>
                    <li>
                        <a href="#len-" aria-label="len() ğŸš€">len() ğŸš€</a><ul>
                            
                    <li>
                        <a href="#reflect_maplen" aria-label="reflect_maplen()">reflect_maplen()</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e8%bf%ad%e4%bb%a3%e5%99%a8-" aria-label="è¿­ä»£å™¨ ğŸš€">è¿­ä»£å™¨ ğŸš€</a><ul>
                            
                    <li>
                        <a href="#type-hiter-struct" aria-label="type hiter struct">type hiter struct</a></li>
                    <li>
                        <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e8%bf%ad%e4%bb%a3%e5%99%a8" aria-label="åˆå§‹åŒ–è¿­ä»£å™¨">åˆå§‹åŒ–è¿­ä»£å™¨</a><ul>
                            
                    <li>
                        <a href="#mapiterinit" aria-label="mapiterinit()">mapiterinit()</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e8%bf%ad%e4%bb%a3" aria-label="è¿­ä»£">è¿­ä»£</a><ul>
                            
                    <li>
                        <a href="#mapiternext" aria-label="mapiternext()">mapiternext()</a></li>
                    <li>
                        <a href="#mapaccessk" aria-label="mapaccessK()">mapaccessK()</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e4%b8%8d%e8%83%bd%e4%bd%9c%e4%b8%bamap-key%e7%b1%bb%e5%9e%8b" aria-label="ä¸èƒ½ä½œä¸ºmap keyç±»å‹">ä¸èƒ½ä½œä¸ºmap keyç±»å‹</a><ul>
                            
                    <li>
                        <a href="#%e5%ae%98%e6%96%b9%e8%a7%a3%e9%87%8a" aria-label="å®˜æ–¹è§£é‡Š">å®˜æ–¹è§£é‡Š</a></li>
                    <li>
                        <a href="#slice%e4%b8%8d%e8%83%bd%e4%bd%9c%e4%b8%bamap-key" aria-label="sliceä¸èƒ½ä½œä¸ºmap key">sliceä¸èƒ½ä½œä¸ºmap key</a></li>
                    <li>
                        <a href="#map%e4%b8%8d%e8%83%bd%e4%bd%9c%e4%b8%bakey" aria-label="mapä¸èƒ½ä½œä¸ºkey">mapä¸èƒ½ä½œä¸ºkey</a></li>
                    <li>
                        <a href="#function%e4%b8%8d%e8%83%bd%e4%bd%9c%e4%b8%bakey" aria-label="functionä¸èƒ½ä½œä¸ºkey">functionä¸èƒ½ä½œä¸ºkey</a></li></ul>
                    </li>
                    <li>
                        <a href="#for-range" aria-label="for range">for range</a></li>
                    <li>
                        <a href="#map%e7%9b%b8%e5%85%b3%e7%bb%83%e4%b9%a0%e9%a2%98" aria-label="mapç›¸å…³ç»ƒä¹ é¢˜">mapç›¸å…³ç»ƒä¹ é¢˜</a><ul>
                            
                    <li>
                        <a href="#%e7%a4%ba%e4%be%8b%e4%b8%80" aria-label="ç¤ºä¾‹ä¸€">ç¤ºä¾‹ä¸€</a></li>
                    <li>
                        <a href="#%e7%a4%ba%e4%be%8b%e4%ba%8c" aria-label="ç¤ºä¾‹äºŒ">ç¤ºä¾‹äºŒ</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><ol>
<li>æœ¬ç¯‡ä»‹ç»mapçš„golangæºç ï¼Œå…¨ç¯‡ä»£ç è¾ƒå¤šæ¯”è¾ƒæ¯ç‡¥ã€‚</li>
<li>map åŒ…è¯´æ˜ï¼š
<ol>
<li>map åªæ˜¯ä¸€ä¸ª hash è¡¨ã€‚æ•°æ®è¢«å®‰æ’åœ¨æ¡¶æ•°ç»„ä¸­ã€‚æ¯ä¸ªæ¡¶æœ€å¤šåŒ…å«8ä¸ª key/elem å¯¹ã€‚</li>
<li>hash çš„<code>low-order bits(hash&amp;1&lt;&lt;B - 1)</code>ç”¨äºé€‰æ‹©æ¡¶ã€‚æ¯ä¸ªæ¡¶åŒ…å« high-order bitsï¼ˆé«˜8ä½ï¼‰ç”¨äºåŒºåˆ†æ¯ä¸ªæ¡¶ä¸­çš„ entriesï¼ˆå°±æ˜¯tophashï¼‰ã€‚</li>
<li>å¦‚æœæœ‰è¶…è¿‡ 8 ä¸ª keysï¼Œhash åˆ°ä¸€ä¸ªæ¡¶ä¸­ï¼Œæˆ‘ä»¬å°†é¢å¤–çš„ extra æ¡¶é“¾æ¥èµ·æ¥ã€‚</li>
<li>å½“ hashtable å¢é•¿æ—¶ï¼Œæˆ‘ä»¬åˆ†é…ä¸€ä¸ª<strong>ä¸¤å€</strong>å¤§å°çš„æ–°æ¡¶æ•°ç»„ã€‚æ¡¶ä¼šä»æ—§çš„æ¡¶æ•°ç»„<strong>æ¸è¿›å¼</strong>å¤åˆ¶åˆ°æ–°çš„æ¡¶æ•°ç»„ä¸­ã€‚</li>
<li>Map è¿­ä»£å™¨éå†æ¡¶æ•°ç»„ï¼Œå¹¶æŒ‰éå†é¡ºåºè¿”å›keysã€‚ï¼ˆå¸¸è§„æ¡¶åæ˜¯æŒ‰ç…§æº¢å‡ºæ¡¶çš„é¡ºåºè¿”å›æ¡¶ç´¢å¼•ï¼‰</li>
<li>ä¸ºäº†ç»´æŠ¤è¿­ä»£è¯­ä¹‰ï¼Œæˆ‘ä»¬ä»ä¸å°† keys ç§»åŠ¨åˆ°æ¡¶ä¸­(å¦‚æœç§»åŠ¨ï¼Œé”®å¯èƒ½ä¼šè¿”å›0æˆ–2æ¬¡)ã€‚</li>
<li>åœ¨å¢é•¿ table æ—¶ï¼Œè¿­ä»£å™¨ä»ç„¶åœ¨è¿­ä»£æ—§è¡¨ï¼Œå¹¶ä¸”å¿…é¡»æ£€æŸ¥æ–°è¡¨æ˜¯å¦å·²ç»ç§»åŠ¨(â€œevacuatedâ€)åˆ°æ–°è¡¨ã€‚</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// This file contains the implementation of Go&#39;s map type.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// A map is just a hash table. The data is arranged
</span></span></span><span class="line"><span class="cl"><span class="c1">// into an array of buckets. Each bucket contains up to
</span></span></span><span class="line"><span class="cl"><span class="c1">// 8 key/elem pairs. The low-order bits of the hash are
</span></span></span><span class="line"><span class="cl"><span class="c1">// used to select a bucket. Each bucket contains a few
</span></span></span><span class="line"><span class="cl"><span class="c1">// high-order bits of each hash to distinguish the entries
</span></span></span><span class="line"><span class="cl"><span class="c1">// within a single bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// If more than 8 keys hash to a bucket, we chain on
</span></span></span><span class="line"><span class="cl"><span class="c1">// extra buckets.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// When the hashtable grows, we allocate a new array
</span></span></span><span class="line"><span class="cl"><span class="c1">// of buckets twice as big. Buckets are incrementally
</span></span></span><span class="line"><span class="cl"><span class="c1">// copied from the old bucket array to the new bucket array.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Map iterators walk through the array of buckets and
</span></span></span><span class="line"><span class="cl"><span class="c1">// return the keys in walk order (bucket #, then overflow
</span></span></span><span class="line"><span class="cl"><span class="c1">// chain order, then bucket index).  To maintain iteration
</span></span></span><span class="line"><span class="cl"><span class="c1">// semantics, we never move keys within their bucket (if
</span></span></span><span class="line"><span class="cl"><span class="c1">// we did, keys might be returned 0 or 2 times).  When
</span></span></span><span class="line"><span class="cl"><span class="c1">// growing the table, iterators remain iterating through the
</span></span></span><span class="line"><span class="cl"><span class="c1">// old table and must check the new table if the bucket
</span></span></span><span class="line"><span class="cl"><span class="c1">// they are iterating through has been moved (&#34;evacuated&#34;)
</span></span></span><span class="line"><span class="cl"><span class="c1">// to the new table.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Picking loadFactor: too large and we have lots of overflow
</span></span></span><span class="line"><span class="cl"><span class="c1">// buckets, too small and we waste a lot of space. I wrote
</span></span></span><span class="line"><span class="cl"><span class="c1">// a simple program to check some stats for different loads:
</span></span></span><span class="line"><span class="cl"><span class="c1">// (64-bit, 8 byte keys and elems)
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Picking loadFactor: å¤ªå¤§ä¼šæœ‰å¾ˆå¤šæº¢å‡ºçš„æ¡¶ï¼Œå¤ªå°ä¼šæµªè´¹å¾ˆå¤šç©ºé—´ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">// æˆ‘å†™äº†ä¸€ä¸ªç®€å•çš„ç¨‹åºæ¥æ£€æŸ¥ä¸åŒåŠ è½½çš„ä¸€äº›ç»Ÿè®¡ä¿¡æ¯:(64-bit, 8 byte keys and elems)
</span></span></span><span class="line"><span class="cl"><span class="c1">//  loadFactor    %overflow  bytes/entry     hitprobe    missprobe
</span></span></span><span class="line"><span class="cl"><span class="c1">//        4.00         2.13        20.77         3.00         4.00
</span></span></span><span class="line"><span class="cl"><span class="c1">//        4.50         4.05        17.30         3.25         4.50
</span></span></span><span class="line"><span class="cl"><span class="c1">//        5.00         6.85        14.77         3.50         5.00
</span></span></span><span class="line"><span class="cl"><span class="c1">//        5.50        10.55        12.94         3.75         5.50
</span></span></span><span class="line"><span class="cl"><span class="c1">//        6.00        15.27        11.67         4.00         6.00
</span></span></span><span class="line"><span class="cl"><span class="c1">//        6.50        20.90        10.79         4.25         6.50  -- loadFactor = 13/2
</span></span></span><span class="line"><span class="cl"><span class="c1">//        7.00        27.14        10.15         4.50         7.00
</span></span></span><span class="line"><span class="cl"><span class="c1">//        7.50        34.03         9.73         4.75         7.50
</span></span></span><span class="line"><span class="cl"><span class="c1">//        8.00        41.10         9.40         5.00         8.00
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// %overflow   = percentage of buckets which have an overflow bucket # æœ‰æº¢å‡ºæ¡¶çš„æ¡¶çš„ç™¾åˆ†æ¯”
</span></span></span><span class="line"><span class="cl"><span class="c1">// bytes/entry = overhead bytes used per key/elem pair  # æ¯ä¸ª key/elem å¯¹ä½¿ç”¨çš„å¼€é”€å­—èŠ‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1">// hitprobe    = # of entries to check when looking up a present key # åœ¨æŸ¥æ‰¾å½“å‰é”®æ—¶è¦æ£€æŸ¥çš„æ¡ç›®
</span></span></span><span class="line"><span class="cl"><span class="c1">// missprobe   = # of entries to check when looking up an absent key # åœ¨æŸ¥æ‰¾ç¼ºå¤±é”®æ—¶è¦æ£€æŸ¥çš„æ¡ç›®
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Keep in mind this data is for maximally loaded tables, i.e. just
</span></span></span><span class="line"><span class="cl"><span class="c1">// before the table grows. Typical tables will be somewhat less loaded.
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="hmap-">hmap ğŸš€<a hidden class="anchor" aria-hidden="true" href="#hmap-">#</a></h2>
<h3 id="type-hmap-struct">type hmap struct<a hidden class="anchor" aria-hidden="true" href="#type-hmap-struct">#</a></h3>
<p>ç»“æ„è¯´æ˜ï¼šgoçš„mapä¸­å­˜å‚¨çš„æ˜¯hmapçš„æŒ‡é’ˆã€‚mapåˆ†é…çš„æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ï¼ŒåŒ…æ‹¬å¸¸è§„æ¡¶å’Œæº¢å‡ºæ¡¶çš„å†…å­˜ã€‚</p>
<ol>
<li><strong>count</strong>ï¼šè®°å½•mapä¸­å­˜å‚¨çš„é”®å€¼å¯¹æ•°é‡ã€‚è¯¥å€¼ä¹Ÿæ˜¯<code>len(map)</code>è¿”å›å€¼ã€‚<code>cap()</code>å‡½æ•°å¯¹mapæ²¡æœ‰å®é™…ä½œç”¨ã€‚</li>
<li><strong>flags</strong>ï¼šæ‰©å®¹ã€è¿­ä»£ç›¸å…³æ ‡å¿—ä½ã€‚</li>
<li><strong>B</strong>ï¼š<strong>å¸¸è§„æ¡¶</strong>ä¸ªæ•°<code>2^B</code>ï¼Œæ­¤å¤„çš„Bæ˜¯å¹‚æ¬¡æ–¹ã€‚æ³¨æ„è¿™é‡Œ<strong>å¹¶æ²¡</strong>æœ‰åŒ…æ‹¬æº¢å‡ºæ¡¶æ•°é‡ã€‚</li>
<li><strong>noverflow</strong>ï¼šå·²ä½¿ç”¨çš„æº¢å‡ºæ¡¶æ•°é‡ï¼Œè¯¥å€¼ç”¨äº<strong>ç­‰é‡æ‰©å®¹</strong>çš„åˆ¤æ–­å€¼ã€‚</li>
<li><strong>hash0</strong>ï¼šç”Ÿæˆçš„éšæœºå€¼ï¼Œæ‰©å®¹æ—¶å€™è¯¥å€¼ä¸ä¼šè¢«åˆ·æ–°ã€‚ä½†æ˜¯åœ¨åˆ é™¤æ—¶mapä¸ºç©ºæ—¶ä¼šåˆ·æ–°ã€‚</li>
<li><strong>buckets</strong>ï¼šå¸¸è§„æ¡¶èµ·å§‹åœ°å€ã€‚</li>
<li><strong>oldbuckets</strong>ï¼šæ‰©å®¹æ—¶ç”¨äºå­˜å‚¨æ—§å¸¸è§„æ¡¶çš„èµ·å§‹åœ°å€ä¹Ÿå°±æ˜¯bucketsçš„å€¼ï¼Œå½“<code>oldbuckets != nil</code>æ—¶ä¹Ÿæ˜¯æ‰©å®¹æ­£åœ¨è¿›è¡Œçš„æ¡ä»¶ã€‚</li>
<li><strong>nevacuate</strong>ï¼šæ‰©å®¹æ­£åœ¨è¿›è¡Œä¸­ä¸‹ä¸€ä¸ªè¦è¢«è¿ç§»çš„æ—§æ¡¶ç¼–å·ã€‚</li>
<li><strong>extra</strong>ï¼šæº¢å‡ºæ¡¶ç›¸å…³ä¿¡æ¯ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// A header for a Go map.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">hmap</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Make sure this stays in sync with the compiler&#39;s definition.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// 1. å·²ç»å­˜å‚¨çš„é”®å€¼å¯¹ä¸ªæ•°ï¼Œlen(map) == count
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2. mapä¸èƒ½ä½¿ç”¨cap()å‡½æ•°ï¼Œcap()å‡½æ•°æ˜¯è®¡ç®—å®¹é‡ï¼Œå¯¹äºmapæ¥è¯´æ„ä¹‰ä¸å¤§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">count</span>     <span class="kt">int</span> <span class="c1">// # live cells == size of map.  Must be first (used by len() builtin)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">flags</span>     <span class="kt">uint8</span> <span class="c1">// å½“å‰hmapçš„çŠ¶æ€ï¼Œæ¯”å¦‚æ­£å¤„äºå†™å…¥æ•°æ®ä¸­ç­‰ï¼Œå‚çœ‹ä¸‹é¢çš„å¸¸é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ã€å¸¸è§„æ¡¶ã€‘ä¸ªæ•°ç­‰äº 2^Bï¼Œmake()åˆå§‹åŒ–æ—¶è¯¥å€¼ä¼šè¢«è®¾ç½®ï¼Œæ³¨æ„è¿™é‡Œå¹¶ã€æ²¡ç”¨ã€‘åŒ…å«æº¢å‡ºæ¡¶çš„æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">B</span>         <span class="kt">uint8</span>  <span class="c1">// log_2 of # of buckets (æœ€å¤šå¯ä»¥å®¹çº³ loadFactor * 2^B items)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å·²ä½¿ç”¨çš„æº¢å‡ºæ¡¶æ•°é‡ï¼Œç”¨äºæ˜¯å¦ç­‰é‡æ‰©å®¹åˆ¤æ–­ï¼Œåœ¨makeåˆå§‹åŒ–å’Œæ‰©å®¹åˆå§‹åŒ–æ—¶è¢«é‡ç½®ä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å·²ä½¿ç”¨æº¢å‡ºæ¡¶çš„è®¡æ•°è§„åˆ™ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  1. å¸¸è§„æ¡¶ h.B &lt;= 15 æ—¶ï¼Œæ¯ä½¿ç”¨äº†ä¸€ä¸ªæº¢å‡ºæ¡¶ h.noverflow++
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. å¸¸è§„æ¡¶ h.B &gt; 16 æ—¶ï¼ŒæŒ‰ç…§ä¸€å®šæ¦‚ç‡å¢åŠ æº¢å‡ºæ¡¶ 1/((1 &lt;&lt; (h.B-15))-1) çš„æ¦‚ç‡ h.noverflow++
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">noverflow</span> <span class="kt">uint16</span> <span class="c1">// approximate number of overflow buckets; see incrnoverflow for details
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨makeåˆå§‹åŒ–æ—¶æ ¹æ®éšæœºæ•°ç”Ÿæˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// hashéšæœºæ•°ï¼Œç”¨äºç”Ÿæˆkeyçš„hashå€¼ï¼Œmakeåˆå§‹åŒ–æ—¶è¯¥å€¼ä¼šè¢«è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">hash0</span>     <span class="kt">uint32</span> <span class="c1">// hash seed	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¸¸è§„æ¡¶èµ·å§‹åœ°å€ï¼Œmakeåˆå§‹åŒ–æ—¶è¯¥å€¼ä¼šè¢«è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¯¥å€¼ä¹Ÿè®¸ä¸ºnilï¼Œå½“count==0æ—¶ï¼Œåœ¨ã€[key] = elemã€‘æ—¶ä¼šåˆå§‹åŒ–åˆ†é…å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">buckets</span>    <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// array of 2^B Buckets. may be nil if count==0.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å­˜åœ¨æ‰©å®¹æ—¶ä¼šæŠŠhmap.bucketså€¼æ‹·è´åˆ°hmap.oldbuckets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™ä¹Ÿæ˜¯åˆ¤æ–­æ‰©å®¹çš„æ¡ä»¶ hmap.oldbuckets != nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">oldbuckets</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// previous bucket array of half the size, non-nil only when growing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è®°å½•ä¸‹ä¸€ä¸ªè¦è¢«è¿ç§»çš„æ—§æ¡¶ç¼–å·ï¼Œåœ¨æ‰©å®¹åˆå§‹åŒ–æ—¶è¢«é‡ç½®ä¸º0ï¼Œè¢«åˆ†æ‘Šåˆ°åˆ°æ¯æ¬¡mapæ“ä½œä¸­æ¸è¿›è¿ç§»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nevacuate</span>  <span class="kt">uintptr</span>  <span class="c1">// progress counter for evacuation (buckets less than this have been evacuated)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// makeåˆå§‹åŒ–æ—¶extra.nextOverflowæ”¹å€¼ä¼šè¢«è®¾ç½®ï¼Œè®°å½•æº¢å‡ºæ¡¶çš„é¦–åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  æº¢å‡ºæ¡¶åˆ†é…è§„åˆ™å¸¸è§„æ¡¶ ã€h.B &gt;= 4ã€‘ï¼Œå°±ä¼šé¢„åˆ†é… ã€h.B-4ã€‘ ä¸ªæº¢å‡ºæ¡¶å¤‡ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// extra ä¸»è¦æ˜¯è®°å½•åˆ†é…çš„å¤‡ç”¨ç©ºé—²æº¢å‡ºæ¡¶åœ°å€ extra.nextOverflowï¼Œä»¥åŠåˆ†é…è¿‡çš„æ— æŒ‡é’ˆæº¢å‡ºæ¡¶è®°å½•åœ¨extra.overflow
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">extra</span> <span class="o">*</span><span class="nx">mapextra</span> <span class="c1">// optional fields	æº¢å‡ºæ¡¶ä¿¡æ¯ ä»¥åŠ æ‰©å®¹ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="createoverflow">createOverflow()<a hidden class="anchor" aria-hidden="true" href="#createoverflow">#</a></h4>
<ol>
<li>åˆ›å»ºä¸€ä¸ª extra æˆ– extra.overflowã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">)</span> <span class="nf">createOverflow</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">        <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">mapextra</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">overflow</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// sliceå¤šé‡‡ç”¨make()åˆ›å»ºï¼Œè¿™é‡Œé‡‡ç”¨newåˆ›å»º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä¹Ÿå°±æ˜¯åªæ˜¯åˆ›å»º24Bå¤§å°å†…å­˜ï¼Œ&amp;slice{0,0,0}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åç»­overflowå­—æ®µä¼šé€šè¿‡append()å‡½æ•°æ·»åŠ å…ƒç´ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å½“bmapæ˜¯æŒ‡é’ˆç±»å‹æ—¶ï¼Œç”¨äºå­˜å‚¨æº¢å‡ºbmapï¼Œä»¥å…è¢«GCç»™å›æ”¶äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">overflow</span> <span class="p">=</span> <span class="nb">new</span><span class="p">([]</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="growing">growing()<a hidden class="anchor" aria-hidden="true" href="#growing">#</a></h4>
<ol>
<li>åˆ¤æ–­å½“å‰mapæ˜¯å¦å¤„äº<strong>æ‰©å®¹çŠ¶æ€</strong>ï¼Œå¯èƒ½æ˜¯<strong>ç¿»å€æ‰©å®¹</strong>æˆ–<strong>ç­‰é‡æ‰©å®¹</strong>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// growing reports whether h is growing. The growth may be to the same size or bigger.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">)</span> <span class="nf">growing</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">h</span><span class="p">.</span><span class="nx">oldbuckets</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="c1">// true.å¤„äºæ‰©å®¹çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="samesizegrow">sameSizeGrow()<a hidden class="anchor" aria-hidden="true" href="#samesizegrow">#</a></h4>
<ol>
<li>sameSizeGrow è¡¨ç¤ºå½“å‰æ­£åœ¨å¤„äº<strong>ç­‰é‡æ‰©å®¹</strong>çŠ¶æ€ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// sameSizeGrow reports whether the current growth is to a map of the same size.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">)</span> <span class="nf">sameSizeGrow</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">sameSizeGrow</span> <span class="o">!=</span> <span class="mi">0</span> <span class="c1">// true.ç­‰é‡æ‰©å®¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="noldbuckets">noldbuckets()<a hidden class="anchor" aria-hidden="true" href="#noldbuckets">#</a></h4>
<ol>
<li>noldbuckets è®¡ç®—å½“å‰ map æ‰©å®¹ä¹‹å‰çš„å¸¸è§„æ¡¶æ•°ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// noldbuckets calculates the number of buckets prior to the current map growth.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">)</span> <span class="nf">noldbuckets</span><span class="p">()</span> <span class="kt">uintptr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">oldB</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">h</span><span class="p">.</span><span class="nf">sameSizeGrow</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">oldB</span><span class="o">--</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">bucketShift</span><span class="p">(</span><span class="nx">oldB</span><span class="p">)</span> <span class="c1">// 1 &lt;&lt; B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="oldbucketmask">oldbucketmask()<a hidden class="anchor" aria-hidden="true" href="#oldbucketmask">#</a></h4>
<ol>
<li>å¸¸è§„æ¡¶æ‰©å®¹ä¹‹å‰çš„æ©ç æ•°ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// oldbucketmask provides a mask that can be applied to calculate n % noldbuckets().
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">)</span> <span class="nf">oldbucketmask</span><span class="p">()</span> <span class="kt">uintptr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">h</span><span class="p">.</span><span class="nf">noldbuckets</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1">// æ¡¶å¢é•¿ä¹‹å‰çš„æ©ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="incrnoverflow">incrnoverflow()<a hidden class="anchor" aria-hidden="true" href="#incrnoverflow">#</a></h4>
<ol>
<li>Incrnoverflow å¢åŠ  h.noverflowã€‚noverflow ç»Ÿè®¡æº¢å‡ºæ¡¶çš„æ•°é‡ã€‚</li>
<li>è¿™ç”¨äºè§¦å‘ç­‰é‡æ‰©å®¹å¤§å°çš„mapå¢é•¿ã€‚ç­‰é‡æ‰©å®¹æ¡ä»¶å‚çœ‹ tooManyOverflowBuckets æ–¹æ³•ã€‚</li>
<li>ä¸ºäº†ä¿æŒhmapè¾ƒå°ï¼Œnoverflowæ˜¯uint16ç±»å‹ã€‚</li>
<li>å½“æ¡¶å¾ˆå°‘æ—¶ï¼Œnoverflowæ˜¯ä¸€ä¸ªç²¾ç¡®çš„è®¡æ•°ã€‚å½“æœ‰å¾ˆå¤šæ¡¶æ—¶ï¼Œnoverflowæ˜¯ä¸€ä¸ªè¿‘ä¼¼çš„è®¡æ•°ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// incrnoverflow increments h.noverflow.
</span></span></span><span class="line"><span class="cl"><span class="c1">// noverflow counts the number of overflow buckets.
</span></span></span><span class="line"><span class="cl"><span class="c1">// This is used to trigger same-size map growth.
</span></span></span><span class="line"><span class="cl"><span class="c1">// See also tooManyOverflowBuckets.
</span></span></span><span class="line"><span class="cl"><span class="c1">// To keep hmap small, noverflow is a uint16.
</span></span></span><span class="line"><span class="cl"><span class="c1">// When there are few buckets, noverflow is an exact count.
</span></span></span><span class="line"><span class="cl"><span class="c1">// When there are many buckets, noverflow is an approximate count.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">)</span> <span class="nf">incrnoverflow</span><span class="p">()</span> <span class="p">{</span>	<span class="c1">// å¢åŠ ä½¿ç”¨çš„æº¢å‡ºæ¡¶è®¡æ•°å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// We trigger same-size map growth if there are
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// as many overflow buckets as buckets.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// We need to be able to count to 1&lt;&lt;h.B.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœæº¢å‡ºæ¡¶å’Œå¸¸è§„æ¡¶ä¸€æ ·å¤šï¼Œæˆ‘ä»¬å°±ä¼šè§¦å‘ç­‰é‡æ‰©å®¹mapã€‚æˆ‘ä»¬éœ€è¦èƒ½å¤Ÿæ•°åˆ° 1&lt;&lt;h.Bã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span> <span class="p">&lt;</span> <span class="mi">16</span> <span class="p">{</span>       <span class="c1">// å½“æ¡¶çš„æ•°é‡ &lt;= 2^15 æº¢å‡ºæ¡¶åŠ ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">h</span><span class="p">.</span><span class="nx">noverflow</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Increment with probability 1/(1&lt;&lt;(h.B-15)).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// When we reach 1&lt;&lt;15 - 1, we will have approximately
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// as many overflow buckets as buckets.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä»¥1/(1&lt;&lt;(h.B-15))æ¦‚ç‡é€’å¢åŠ ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mask</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="o">-</span><span class="mi">15</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>	
</span></span><span class="line"><span class="cl">    <span class="c1">// Example: if h.B == 18, then mask == 7,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// and fastrand &amp; 7 == 0 with probability 1/8.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nf">fastrand</span><span class="p">()</span><span class="o">&amp;</span><span class="nx">mask</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">h</span><span class="p">.</span><span class="nx">noverflow</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="newoverflow">newoverflow()<a hidden class="anchor" aria-hidden="true" href="#newoverflow">#</a></h4>
<ol>
<li>åˆ†é…æ–°çš„æº¢å‡ºæ¡¶ï¼Œå¦‚æœå½“å‰æ¡¶æ»¡äº†åˆ™éœ€è¦åˆ†é…æº¢å‡ºæ¡¶è°ƒç”¨æ­¤æ–¹æ³•è¿”å›æº¢å‡ºæ¡¶ã€‚</li>
<li>è¯¥æ–¹æ³•æœ‰å¤‡ç”¨çš„æº¢å‡ºæ¡¶å·²ç”¨å®Œé‡æ–°åˆ†é…æº¢å‡ºæ¡¶æƒ…å†µã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">)</span> <span class="nf">newoverflow</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">b</span> <span class="o">*</span><span class="nx">bmap</span><span class="p">)</span> <span class="o">*</span><span class="nx">bmap</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">ovf</span> <span class="o">*</span><span class="nx">bmap</span> <span class="c1">// åˆ†é…çš„æº¢å‡ºæ¡¶ *bmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰æº¢å‡ºæ¡¶ä¿¡æ¯ä¸ä¸ºç©º å¹¶ä¸” ä¸‹ä¸€ä¸ªæº¢å‡ºæ¡¶ä¸ä¸ºç©º ç›´æ¥ä»åé¢è·å–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">nextOverflow</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">        <span class="c1">// We have preallocated overflow buckets available.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// See makeBucketArray for more details.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æˆ‘ä»¬æœ‰é¢„å…ˆåˆ†é…çš„æº¢å‡ºæ¡¶å¯ç”¨ã€‚æ›´å¤šç»†èŠ‚è¯·å‚è§makeBucketArrayæ–¹æ³•ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">ovf</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">nextOverflow</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆ¤æ–­æº¢å‡ºæ¡¶çš„overflowå­—æ®µæ˜¯å¦ä¸ºnilï¼Œç”¨äºåˆ¤æ–­åˆ†é…çš„å¤‡ç”¨æº¢å‡ºæ¡¶ä½¿ç”¨å·²ç”¨å®Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å‚çœ‹makeBucketArrayæ–¹æ³•ä¸­æŠŠæœ€åä¸€ä¸ªæº¢å‡ºæ¡¶overflowæŒ‡å‘äº†ç¬¬ä¸€ä¸ªå¸¸è§„æ¡¶åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">ovf</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// We&#39;re not at the end of the preallocated overflow buckets. Bump the pointer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æˆ‘ä»¬è¿˜æ²¡æœ‰åˆ°è¾¾é¢„åˆ†é…çš„æº¢å‡ºæ¡¶çš„æœ«å°¾ã€‚ç¢°ä¸€ä¸‹æŒ‡é’ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">nextOverflow</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">ovf</span><span class="p">),</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>	<span class="c1">// ä¸‹ä¸€ä¸ªç©ºé—²çš„æº¢å‡ºæ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// å·²ç»æ˜¯æœ€åä¸€ä¸ªå¤‡ç”¨çš„æº¢å‡ºæ¡¶äº†ï¼ˆæœ€åä¸€ä¸ªæº¢å‡ºæ¡¶æŒ‡å‘äº†ç¬¬ä¸€ä¸ªå¸¸è§„æ¡¶ï¼Œå…¶ä»–æº¢å‡ºæ¡¶éƒ½åº”è¯¥æœªnilï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// This is the last preallocated overflow bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Reset the overflow pointer on this bucket,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// which was set to a non-nil sentinel value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿™æ˜¯æœ€åä¸€ä¸ªé¢„åˆ†é…çš„æº¢å‡ºæ¡¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// é‡ç½®æ­¤æ¡¶ä¸Šçš„æº¢å‡ºæŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆè¢«è®¾ç½®ä¸ºénilå“¨å…µå€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">ovf</span><span class="p">.</span><span class="nf">setoverflow</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span> <span class="c1">// ovf.overflow = nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">nextOverflow</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æº¢å‡ºæ¡¶ä»¥åˆ†é…å®Œäº† æˆ–è€… æ²¡æœ‰åˆ†é…æº¢å‡ºæ¡¶æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ³¨æ„ï¼šè¿™é‡Œç›´æ¥è°ƒç”¨new()å‡½æ•°åˆ†é…çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">ovf</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">newobject</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">))</span>	
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// å·²ä½¿ç”¨æº¢å‡ºæ¡¶è®¡æ•°å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">h</span><span class="p">.</span><span class="nf">incrnoverflow</span><span class="p">()</span>	
</span></span><span class="line"><span class="cl">    <span class="c1">// æ¡¶ä¸åŒ…å«æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">ptrdata</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">h</span><span class="p">.</span><span class="nf">createOverflow</span><span class="p">()</span>	<span class="c1">// é˜²æ­¢ h.extra æˆ– h.extra.overflow æ²¡æœ‰åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å°†åˆ†é…çš„æº¢å‡ºæ¡¶ä¿å­˜åœ¨h.extra.overflowä¸­ï¼Œä¸»è¦æ˜¯é˜²æ­¢è¿™éƒ¨åˆ†å†…å­˜ä¸è¯¥è¢«GCæ¸…ç†ï¼Œç»“æœè¢«æ¸…é™¤äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">*</span><span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">overflow</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="o">*</span><span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">overflow</span><span class="p">,</span> <span class="nx">ovf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">.</span><span class="nf">setoverflow</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">ovf</span><span class="p">)</span>   <span class="c1">// b.overflow = ovf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">ovf</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="type-bmap-struct">type bmap struct<a hidden class="anchor" aria-hidden="true" href="#type-bmap-struct">#</a></h3>
<ol>
<li>bmap ç”¨æ¥è£… map çš„æ¡¶ã€‚</li>
<li>bmap å‰8å­—èŠ‚æ˜¯ <code>tophash</code> å€¼ï¼Œåé¢åˆ†åˆ«æ˜¯8ä¸ªè¿ç»­çš„ <code>key</code> å’Œ8ä¸ªè¿ç»­çš„ <code>value</code> ç„¶åæ˜¯ä¸€ä¸ªæº¢å‡ºæ¡¶æŒ‡é’ˆã€‚</li>
<li>ä¹‹æ‰€ä»¥æ¡¶æŒ‰ç…§è¿™ä¸ªç»“æ„è®¾è®¡æ˜¯ä¸ºäº†å†…å­˜ç´§å‡‘ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// A bucket for a Go map.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">bmap</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// tophash generally contains the top byte of the hash value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// for each key in this bucket. If tophash[0] &lt; minTopHash,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// tophash[0] is a bucket evacuation state instead.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Tophashé€šå¸¸åŒ…å«è¯¥æ¡¶ä¸­æ¯ä¸ªé”®çš„æ•£åˆ—å€¼çš„é¡¶éƒ¨å­—èŠ‚ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœtophash[0] &lt; minTopHashï¼Œåˆ™tophash[0]ä¸ºæ¡¶ç–æ•£çŠ¶æ€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// const minTopHash = 5 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// const bucketCnt = 8;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">tophash</span> <span class="p">[</span><span class="nx">bucketCnt</span><span class="p">]</span><span class="kt">uint8</span>    <span class="c1">// [8]uint8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Followed by bucketCnt keys and then bucketCnt elems.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// NOTE: packing all the keys together and then all the elems together makes the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// code a bit more complicated than alternating key/elem/key/elem/... but it allows
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// us to eliminate padding which would be needed for, e.g., map[int64]int8.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Followed by an overflow pointer. 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ¥ä¸‹æ¥æ˜¯bucketCntçš„keysï¼Œç„¶åæ˜¯bucketCntçš„elemsã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ³¨æ„: å°†æ‰€æœ‰keyæ‰“åŒ…åœ¨ä¸€èµ·ï¼Œç„¶åå°†æ‰€æœ‰elemæ‰“åŒ…åœ¨ä¸€èµ·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™æ¯”äº¤æ›¿ä½¿ç”¨key/elem/key/elem/â€¦ä½†å®ƒå…è®¸æˆ‘ä»¬æ¶ˆé™¤æ‰€éœ€çš„å†…è¾¹è·ï¼Œä¾‹å¦‚ map[int64]int8ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åè·Ÿä¸€ä¸ªæº¢å‡ºæŒ‡é’ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li><strong>bmap</strong> ç»“æ„ï¼š
<ol>
<li><strong>h1 - h8</strong>ï¼š8ä¸ªhashå€¼åˆ†åˆ«æ˜¯keyçš„hashé«˜å…«ä½ï¼Œä¸»è¦ç”¨äºå¿«é€ŸæŸ¥æ‰¾keyå’Œbmapæ¡¶çš„ç›¸å…³è¿ç§»çŠ¶æ€æ ‡è®°ã€‚</li>
<li><strong>k1 - k8</strong>ï¼š8ä¸ªkeyçš„å€¼ã€‚</li>
<li><strong>v1 - v8</strong>ï¼š8ä¸ªvalueçš„å€¼ã€‚</li>
<li><strong>overflow</strong>ï¼šæŒ‡å‘åé¢æº¢å‡ºæ¡¶çš„æŒ‡é’ˆã€‚</li>
</ol>
</li>
</ol>
<p><img loading="lazy" src="../images/map-001.png" alt=""  />
</p>
<h4 id="evacuated">evacuated()<a hidden class="anchor" aria-hidden="true" href="#evacuated">#</a></h4>
<ol>
<li>è¯¥ bmap æ¡¶æ˜¯å¦æ˜¯<strong>ç–æ•£çš„</strong>ï¼Œ1 &lt; tophash[0] &lt; 5ï¼Œè¡¨æ˜è¯¥ bmap æ¡¶æ•°æ®å·²è¢«è¿ç§»ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">evacuated</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">bmap</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">h</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å‚çœ‹åé¢ consts ä¸­ç›¸å…³å¸¸é‡å®šä¹‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// const emptyOne = 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// const minTopHash = 5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// return h IN (2,3,4)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">h</span> <span class="p">&gt;</span> <span class="nx">emptyOne</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="p">&lt;</span> <span class="nx">minTopHash</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="overflow">overflow()<a hidden class="anchor" aria-hidden="true" href="#overflow">#</a></h4>
<ol>
<li>è¯¥ bmap æ¡¶çš„ overflow å­—æ®µæŒ‡å‘çš„æº¢å‡ºæ¡¶ <code>*bmap</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">bmap</span><span class="p">)</span> <span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">)</span> <span class="o">*</span><span class="nx">bmap</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// b + bucketsize - goarch.PtrSize
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="o">**</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)</span><span class="o">-</span><span class="nx">goarch</span><span class="p">.</span><span class="nx">PtrSize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="setoverflow">setoverflow()<a hidden class="anchor" aria-hidden="true" href="#setoverflow">#</a></h4>
<ol>
<li>è¯¥ bmap æ¡¶çš„ overflow å­—æ®µæŒ‡å‘ ovf *bmap è¿™ä¸ªæ¡¶ã€‚</li>
<li>ç­‰ä»·äº <strong><code>bmap.overflow = ovf </code></strong>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">bmap</span><span class="p">)</span> <span class="nf">setoverflow</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">ovf</span> <span class="o">*</span><span class="nx">bmap</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// bmap.overflow = ovf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="p">(</span><span class="o">**</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)</span><span class="o">-</span><span class="nx">goarch</span><span class="p">.</span><span class="nx">PtrSize</span><span class="p">))</span> <span class="p">=</span> <span class="nx">ovf</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="keys">keys()<a hidden class="anchor" aria-hidden="true" href="#keys">#</a></h4>
<ol>
<li>è¿”å›è¯¥ bmap æ¡¶çš„ key å¼€å§‹åœ°å€ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">bmap</span><span class="p">)</span> <span class="nf">keys</span><span class="p">()</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// dataOffset å‚çœ‹åé¢ consts ä¸­çš„å¸¸é‡å®šä¹‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// dataOffset -&gt; [8]uint8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="type-mapextra-struct">type mapextra struct<a hidden class="anchor" aria-hidden="true" href="#type-mapextra-struct">#</a></h3>
<ol>
<li>Mapextra æŒæœ‰ä¸€äº›åœ¨æ‰€æœ‰mapä¸­éƒ½ä¸å­˜åœ¨çš„å­—æ®µã€‚ä¸»è¦æ˜¯æº¢å‡ºæ¡¶ç›¸å…³ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// mapextra holds fields that are not present on all maps.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">mapextra</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// If both key and elem do not contain pointers and are inline, then we mark bucket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// type as containing no pointers. This avoids scanning such maps.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// However, bmap.overflow is a pointer. In order to keep overflow buckets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// alive, we store pointers to all overflow buckets in hmap.extra.overflow and hmap.extra.oldoverflow.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// overflow and oldoverflow are only used if key and elem do not contain pointers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// overflow contains overflow buckets for hmap.buckets.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// oldoverflow contains overflow buckets for hmap.oldbuckets.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// The indirection allows to store a pointer to the slice in hiter.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœ key å’Œ elem éƒ½ä¸åŒ…å«æŒ‡é’ˆå¹¶ä¸”æ˜¯å…è®¸å†…è”(inline)çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†bucketç±»å‹æ ‡è®°ä¸ºã€ä¸åŒ…å«æŒ‡é’ˆã€‘ã€‚è¿™æ ·é¿å…äº†æ‰«æè¿™æ ·çš„mapã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç„¶è€Œ bmap.overflow æ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸ºäº†ä¿æŒoverflowæ¡¶æ˜¯alive(æ´»è·ƒçš„ä¸è¢«GCå›æ”¶)ï¼Œæˆ‘ä»¬å°†æŒ‡å‘æ‰€æœ‰overflowæ¡¶çš„æŒ‡é’ˆå­˜å‚¨åœ¨hmap.extra.overflowå’Œhmap.extra.oldoverflowä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ã€ä»…å½“ key å’Œ elem ä¸åŒ…å«æŒ‡é’ˆæ—¶ï¼Œæ‰ä½¿ç”¨ overflow å’Œ oldoverflowã€‚ã€‘å› ä¸ºä¸åŒ…å«æŒ‡é’ˆæ‰å®¹æ˜“è¢«GCå›æ”¶ï¼Œå› æ­¤éœ€è¦ä¿å­˜ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// overflow åŒ…å«ç”¨äº hmap.buckets çš„overflowæ¡¶é›†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// oldoverflow åŒ…å«ç”¨äº hmap.oldbuckets çš„overflowæ¡¶é›†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é—´æ¥å…è®¸åœ¨hiterä¸­å­˜å‚¨ä¸€ä¸ªæŒ‡å‘åˆ‡ç‰‡çš„æŒ‡é’ˆã€‚(hiteræ˜¯éå†ç›¸å…³ç»“æ„)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">overflow</span>    <span class="o">*</span><span class="p">[]</span><span class="o">*</span><span class="nx">bmap</span> <span class="c1">// åœ¨ key å’Œ elem ä¸åŒ…å«æŒ‡é’ˆæ—¶ï¼ŒæŠŠå·²ç»ç”¨åˆ°çš„æº¢å‡ºæ¡¶å­˜å‚¨èµ·æ¥ï¼Œä¸»è¦æ˜¯ä¿å­˜ alive
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">oldoverflow</span> <span class="o">*</span><span class="p">[]</span><span class="o">*</span><span class="nx">bmap</span> <span class="c1">// æ‰©å®¹æ­£åœ¨è¿›è¡Œæ—¶ï¼ŒæŠŠ overflow æ•°æ®æ‹·è´åˆ°è¿™é‡Œ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// nextOverflow holds a pointer to a free overflow bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// nextOverflowä¿å­˜äº†ä¸€ä¸ªæŒ‡å‘ç©ºé—²æº¢å‡ºæ¡¶çš„æŒ‡é’ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸‹ä¸€ä¸ªå°šæœªä½¿ç”¨çš„æº¢å‡ºæ¡¶ï¼Œè¿™é‡Œæ¡¶ä¹‹é—´æ˜¯ä¸€ä¸ªé“¾è¡¨é“¾æ¥æ‰€æœ‰çš„æº¢å‡ºæ¡¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¯¥å€¼åœ¨makeå‡½æ•°ä¸­è¢«è®¾ç½®æˆç”³è¯·çš„é¦–ä¸ªæº¢å‡ºæ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nextOverflow</span> <span class="o">*</span><span class="nx">bmap</span>	
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/map-002.png" alt=""  />
</p>
<h3 id="constant">constant<a hidden class="anchor" aria-hidden="true" href="#constant">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Maximum number of key/elem pairs a bucket can hold.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸€ä¸ªæ¡¶å¯ä»¥å®¹çº³çš„æœ€å¤§ key/elem å¯¹æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bucketCntBits</span> <span class="p">=</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bucketCnt</span>     <span class="p">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="nx">bucketCntBits</span> <span class="c1">// 2^3 = 8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Maximum average load of a bucket that triggers growth is 6.5.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Represent as loadFactorNum/loadFactorDen, to allow integer math.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è§¦å‘å¢é•¿çš„æ¡¶çš„æœ€å¤§å¹³å‡è´Ÿè½½ä¸º13/2 = 6.5ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¡¨ç¤ºä¸º loadFactorNum/loadFactorDen ï¼Œå…è®¸è¿›è¡Œæ•´æ•°è¿ç®—ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">loadFactorNum</span> <span class="p">=</span> <span class="mi">13</span>  <span class="c1">// loadFactorNum/loadFactorDen = 6.5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">loadFactorDen</span> <span class="p">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Maximum key or elem size to keep inline (instead of mallocing per element).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Must fit in a uint8.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Fast versions cannot handle big elems - the cutoff size for
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// fast versions in cmd/compile/internal/gc/walk.go must be at most this elem.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¿å­˜inlineçš„æœ€å¤§ key æˆ– elem å¤§å°(è€Œä¸æ˜¯ä¸ºæ¯ä¸ªå…ƒç´ åˆ†é…å†…å­˜)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¿…é¡»é€‚é…åœ¨uint8ä¸­ã€‚å¿«é€Ÿç‰ˆæœ¬ä¸èƒ½å¤„ç†å¤§å…ƒç´ -åœ¨cmd/compile/internal/gc/walkä¸­å¿«é€Ÿç‰ˆæœ¬çš„æˆªæ­¢å¤§å°ã€‚Goæœ€å¤šåªèƒ½æ˜¯è¿™ä¸ªelemã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">maxKeySize</span>  <span class="p">=</span> <span class="mi">128</span> <span class="c1">// mapé”®æœ€å¤§å†…å­˜å€¼ 128Bï¼Œè¶…è¿‡è¯¥å€¼åˆ™æ˜¯æ¡¶çš„keyæ˜¯é—´æ¥å­˜å‚¨çš„ï¼Œä¹Ÿå°±æ˜¯åªæ˜¯å­˜å‚¨çš„æ˜¯æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">maxElemSize</span> <span class="p">=</span> <span class="mi">128</span> <span class="c1">// mapå€¼æœ€å¤§å†…å­˜å€¼ 128Bï¼Œè¶…è¿‡è¯¥å€¼åˆ™æ˜¯æ¡¶çš„elemæ˜¯é—´æ¥å­˜å‚¨çš„ï¼Œä¹Ÿå°±æ˜¯åªæ˜¯å­˜å‚¨çš„æ˜¯æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// data offset should be the size of the bmap struct, but needs to be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// aligned correctly. For amd64p32 this means 64-bit alignment
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// even though pointers are 32 bit.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// dataOffset æ˜¯bmapç»“æ„ä½“çš„é•¿åº¦ï¼Œä½†éœ€è¦æ­£ç¡®å¯¹é½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯¹äºamd64p32ï¼Œè¿™æ„å‘³ç€å³ä½¿æŒ‡é’ˆæ˜¯32ä½ï¼Œä¹Ÿä¼šè¿›è¡Œ64ä½å¯¹é½ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">dataOffset</span> <span class="p">=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Offsetof</span><span class="p">(</span><span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">b</span> <span class="nx">bmap</span>      <span class="c1">// 8B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">v</span> <span class="kt">int64</span>     <span class="c1">// 8B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}{}.</span><span class="nx">v</span><span class="p">)</span> <span class="c1">// dataOffset = 8B   bmapæ¡¶çš„ç¬¬ä¸€ä¸ªkeyåç§»é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Possible tophash values. We reserve a few possibilities for special marks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Each bucket (including its overflow buckets, if any) will have either all or none of its
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// entries in the evacuated* states (except during the evacuate() method, which only happens
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// during map writes and thus no one else can observe the map during that time).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯èƒ½çš„ tophash å€¼ã€‚æˆ‘ä»¬ä¿ç•™ä¸€äº›ç‰¹æ®Šæ ‡è®°çš„å¯èƒ½æ€§ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ¯ä¸ªæ¡¶(åŒ…æ‹¬å®ƒçš„æº¢å‡ºæ¡¶ï¼Œå¦‚æœæœ‰çš„è¯)çš„æ‰€æœ‰æ¡ç›®éƒ½å°†å¤„äº evacuated* çŠ¶æ€(é™¤éåœ¨ä½¿ç”¨evacuate()æ–¹æ³•æ—¶ï¼Œè¿™ç§æƒ…å†µåªå‘ç”Ÿåœ¨mapå†™æ“ä½œæœŸé—´ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› æ­¤ï¼Œåœ¨è¿™æ®µæ—¶é—´å†…ï¼Œæ²¡æœ‰å…¶ä»–äººå¯ä»¥è§‚å¯Ÿmap)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰æ ¼ä¸ºç©ºçš„é»˜è®¤çŠ¶æ€ï¼Œåé¢æ ¼éƒ½ä¸ºç©ºä¸å­˜åœ¨å…¶ä»–æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">emptyRest</span>      <span class="p">=</span> <span class="mi">0</span> <span class="c1">// this cell is empty, and there are no more non-empty cells at higher indexes or overflows.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰æ ¼ä¸ºç©ºï¼Œåé¢æ ¼è¿˜å­˜åœ¨å…¶ä»–æ•°æ®ã€‚åœ¨å½“å‰æ ¼è¢«åˆ é™¤æ—¶ä¼šè¢«æ ‡è®°ä¸º1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">emptyOne</span>       <span class="p">=</span> <span class="mi">1</span> <span class="c1">// this cell is empty
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// key/elemæ˜¯æœ‰æ•ˆçš„ï¼Œentryå·²è¢«ç–æ•£åˆ°ç¿»å€åçš„æ–°æ¡¶é‡Œï¼ŒåŸæ¥çš„æ¡¶å·å¤„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">evacuatedX</span>     <span class="p">=</span> <span class="mi">2</span> <span class="c1">// key/elem is valid.  Entry has been evacuated to first half of larger table.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// key/elemæ˜¯æœ‰æ•ˆçš„ï¼Œentryå·²è¢«ç–æ•£åˆ°ç¿»å€åçš„æ–°æ¡¶é‡Œï¼ŒåŸæ¥æ¡¶å·çš„2å€å¤„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">evacuatedY</span>     <span class="p">=</span> <span class="mi">3</span> <span class="c1">// same as above, but evacuated to second half of larger table.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å•å…ƒæ ¼æ˜¯ç©ºçš„ã€‚åœ¨æ‰©å®¹è¿›è¡Œä¸­è¢«æ ‡è®°ä» 0æˆ–1æ ‡è®°ä¸º4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">evacuatedEmpty</span> <span class="p">=</span> <span class="mi">4</span> <span class="c1">// cell is empty, bucket is evacuated.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ­£å¸¸å¡«å……å•å…ƒæ ¼çš„æœ€å°å€¼ï¼Œæ¯”å¦‚æŸä¸ªkeyè®¡ç®—åçš„hashå€¼ä¸º0åˆ™å¡«å……ä¸º5ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">minTopHash</span>     <span class="p">=</span> <span class="mi">5</span> <span class="c1">// minimum tophash for a normal filled cell.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// flags
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯èƒ½æœ‰ä¸€ä¸ªä½¿ç”¨bucketsçš„è¿­ä»£å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">iterator</span>     <span class="p">=</span> <span class="mi">1</span> <span class="c1">// there may be an iterator using buckets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯èƒ½æœ‰ä¸€ä¸ªä½¿ç”¨oldbucketsçš„è¿­ä»£å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">oldIterator</span>  <span class="p">=</span> <span class="mi">2</span> <span class="c1">// there may be an iterator using oldbuckets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¸€ä¸ªgoroutineæ­£åœ¨å‘mapå†™å…¥æ•°æ®ï¼Œç”¨äºåˆ¤æ–­mapæ˜¯å¦åœ¨è¯»å†™åˆ é™¤å¹¶å‘æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨m[key] = elemæ—¶è¢«è®¾ç½®æˆ–åœ¨deleteåˆ é™¤keyæ—¶è¢«è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">hashWriting</span>  <span class="p">=</span> <span class="mi">4</span> <span class="c1">// a goroutine is writing to the map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç­‰é‡æ‰©å®¹æ ‡å¿—ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sameSizeGrow</span> <span class="p">=</span> <span class="mi">8</span> <span class="c1">// the current map growth is to a new map of the same size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// sentinel bucket ID for iterator checks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿­ä»£å™¨æ£€æŸ¥çš„å“¨å…µæ¡¶IDï¼Œå¦‚æœæ¡¶å·ä¸ºè¯¥å€¼ä¸éœ€è¦æ£€æŸ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿­ä»£å™¨ç›¸å…³ï¼Œåœ¨æ‰©å®¹è¿›è¡Œä¸­è¿­ä»£å™¨ç”¨äºæ£€æŸ¥çš„æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">noCheck</span> <span class="p">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="nx">goarch</span><span class="p">.</span><span class="nx">PtrSize</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>	
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="type-maptype-struct">type maptype struct<a hidden class="anchor" aria-hidden="true" href="#type-maptype-struct">#</a></h3>
<ol>
<li>map å…ƒç±»å‹ï¼Œ<code>runtime/type.go</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">maptype</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">typ</span>    <span class="nx">_type</span>        <span class="c1">// mapç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">key</span>    <span class="o">*</span><span class="nx">_type</span>       <span class="c1">// keyç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">elem</span>   <span class="o">*</span><span class="nx">_type</span>       <span class="c1">// elemç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">// æ¡¶çš„ç±»å‹ï¼Œæ¡¶åŒ…å«tophashsã€keysã€elemsã€overflowè¿™å››å—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç”±äºkey/elemæ˜¯ä¸ç¡®å®šçš„ç±»å‹ï¼Œæ‰€ä»¥bucketä¹Ÿæ˜¯ä¸åŒçš„ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// bucketæ˜¯å¦åŒ…å«æŒ‡é’ˆç±»å‹ï¼Œæ˜¯å–å†³äºè¯¥ç»“æ„ä¸­æ˜¯å¦å­˜åœ¨æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//	1. tophashs æ˜¯éæŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  2. keysã€elems æ˜¯æ ¹æ®å…·ä½“æƒ…å†µçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  3. overflow æ˜¯ä¸ªæŒ‡é’ˆï¼Œé‚£ä¹ˆæ˜¯å¦æ„å‘³åˆ™bucketæ˜¯å¦åŒ…å«æŒ‡é’ˆç±»å‹?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å…¶å®bucketæ˜¯å¦åŒ…å«æŒ‡é’ˆç±»å‹æ˜¯æ ¹æ®keysã€elemså†³å®šçš„ï¼ŒåŸå› æ˜¯overflowæ˜¯ç”¨æˆ·æ“ä½œä¸åˆ°çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› æ­¤å¤„ç†è¿™ä¸ªç‰¹æ®Šæƒ…å†µæ—¶ï¼Œé‡‡ç”¨äº†éæŒ‡é’ˆå½¢å¼é‡‡ç”¨mapextraç»“æ„ä¿å­˜æº¢å‡ºæ¡¶æ•°æ®ï¼Œä»¥ä¾¿ä¸è¢«GCå›æ”¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bucket</span> <span class="o">*</span><span class="nx">_type</span> <span class="c1">// internal type representing a hash bucket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// function for hashing keys (ptr to key, seed) -&gt; hash
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// hashå‡½æ•°ï¼Œç”¨äº(key, h.hash0)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">hasher</span>     <span class="kd">func</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="kt">uintptr</span>	
</span></span><span class="line"><span class="cl">    <span class="c1">// size of key slot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">keysize</span>    <span class="kt">uint8</span>  <span class="c1">// keyå€¼å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// size of elem slot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">elemsize</span>   <span class="kt">uint8</span>  <span class="c1">// valueå€¼å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// size of bucket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bucketsize</span> <span class="kt">uint16</span> <span class="c1">// æ¡¶å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">flags</span>      <span class="kt">uint32</span> <span class="c1">// mapçš„æ ‡å¿—ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="indirectkey">indirectkey()<a hidden class="anchor" aria-hidden="true" href="#indirectkey">#</a></h4>
<ol>
<li>å½“ key å¤§äº128Bæ—¶keyå­˜çš„æ˜¯å®ƒçš„æŒ‡é’ˆï¼Œkey æ˜¯å¦æ˜¯<strong>é—´æ¥å­˜å‚¨</strong>çš„ã€‚é‡‡ç”¨è¿™ç§é—´æ¥å­˜å‚¨æ˜¯ä¸ºäº†æ»¡è¶³GCçš„ä½å›¾ã€‚</li>
<li>ä¸€ä¸ªæ¡¶æœ€å¤šæ”¯æŒ <code>bucketSize*(1+maxKeySize+maxValSize)+ptrSize</code> å­—èŠ‚ï¼Œå³2064å­—èŠ‚ï¼Œæˆ–258ä¸ªæŒ‡é’ˆå¤§å°çš„å­—ï¼Œæˆ–33å­—èŠ‚çš„æŒ‡é’ˆä½å›¾ã€‚</li>
<li>å› ä¸ºé”®å’Œå€¼éƒ½å°äº128å­—èŠ‚ï¼Œæ‰€ä»¥å¯ä»¥ä¿è¯å®ƒä»¬æœ‰ä½å›¾è€Œä¸æ˜¯GCç¨‹åºã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Note: flag values must match those used in the TMAP case
</span></span></span><span class="line"><span class="cl"><span class="c1">// in ../cmd/compile/internal/reflectdata/reflect.go:writeType.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">mt</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">)</span> <span class="nf">indirectkey</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span> <span class="c1">// store ptr to key instead of key itself
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// flags = 1ï¼škeyå ç”¨å†…å­˜å¤§äº 128B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">mt</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="mi">1</span> <span class="o">!=</span> <span class="mi">0</span>	
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="indirectelem">indirectelem()<a hidden class="anchor" aria-hidden="true" href="#indirectelem">#</a></h4>
<ol>
<li>å½“elemå¤§äº128Bæ—¶keyå­˜çš„æ˜¯å®ƒçš„æŒ‡é’ˆï¼Œelemæ˜¯å¦æ˜¯<strong>é—´æ¥å­˜å‚¨</strong>çš„ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">mt</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">)</span> <span class="nf">indirectelem</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span> <span class="c1">// store ptr to elem instead of elem itself
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// flags = 2ï¼šelemå ç”¨å†…å­˜å¤§äº 128B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">mt</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span>	
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="reflexivekey">reflexivekey()<a hidden class="anchor" aria-hidden="true" href="#reflexivekey">#</a></h4>
<ol>
<li><strong>map keyæ˜¯NaNæ—¶</strong>ï¼Œåˆ¤æ–­ key æ»¡è¶³ <strong>x == x</strong> æˆç«‹?</li>
<li><strong>x != x</strong> æˆç«‹æƒ…å†µï¼š
<ul>
<li>float32ã€float64ã€complex64ã€complex128ï¼ˆå½“ä¸ºNaNæ—¶ï¼‰ã€‚</li>
<li>anyï¼šå­˜å‚¨çš„æ˜¯ NaN æ—¶ã€‚</li>
<li>Array æ—¶åˆ¤æ–­æ•°ç»„çš„å…ƒç´ ç±»å‹ã€‚åˆ‡ç‰‡ä¸èƒ½ä½œä¸ºmapçš„keyå› æ­¤æ’é™¤ã€‚</li>
<li>String æ—¶ï¼Œåˆ¤æ–­å­—æ®µç±»å‹ã€‚</li>
</ul>
</li>
<li>æ ¹æ® IEEE754 æ ‡å‡†ï¼Œå½“æµ®ç‚¹æ•°çš„æŒ‡æ•°ä½å…¨ä¸º1æ—¶ï¼Œè¯¥æ•°å¤„äºéæ­£å¸¸æ˜¯æ ‡å‡†å¤šç”¨äºè¡¨ç¤ºæ­£æ— ç©·å¤§æˆ–è´Ÿæ— ç©·å¤§åŠNaNï¼Œå› æ­¤å…¶ä»–ä½å¯èƒ½æ˜¯ä¸åŒçš„æ•°å€¼ã€‚</li>
<li>x != x æƒ…å†µæ˜¯<strong>ä¼šå½±å“</strong>hashï¼Œå› æ­¤NaNçš„ä½å€¼ä¸ä¸€å®šå…¨éƒ¨ç›¸ç­‰ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">mt</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">)</span> <span class="nf">reflexivekey</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span> <span class="c1">// true if k==k for all keys
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// flags = 4ï¼šè¯´æ˜ x == xå§‹ç»ˆæ˜¯æˆç«‹çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">mt</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span>	
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="needkeyupdate">needkeyupdate()<a hidden class="anchor" aria-hidden="true" href="#needkeyupdate">#</a></h4>
<ol>
<li><strong>map keyçš„å€¼éœ€è¦æ›´æ–°</strong>ï¼Œè¿™ç§æƒ…å†µå‡ºç°åœ¨ key == keyï¼Œä½†æ˜¯ key ç”Ÿæˆçš„ hash å¯èƒ½ä¸ç›¸åŒï¼Œè¿™ä¼šå½±å“åˆ° tophash å­˜å‚¨å€¼ã€‚</li>
<li>éœ€è¦æ›´æ–°çš„ç±»å‹ï¼š
<ul>
<li>float32ã€float64ã€complex64ã€complex128ï¼ˆfloats and complex can be +0/-0ï¼‰ã€‚
<ul>
<li>æµ®ç‚¹æ•°å’Œå¤æ•°å¯ä»¥æ˜¯+0/-0ï¼Œæµ®ç‚¹æ•°ä¸­è¿™ä¸¤ä¸ªæ•°ä¿å­˜çš„ç¬¦å·ä½æ˜¯ä¸åŒå¾—ï¼Œä½†æ˜¯æ¯”è¾ƒè¿™ä¸¤ä¸ªæ•°ç¡®å®æ˜¯ç›¸ç­‰çš„ã€‚</li>
</ul>
</li>
<li>any  ç”±äº any èƒ½å­˜å‚¨ä»»ä½•ç±»å‹ï¼Œæ‰€æœ‰å¯ä»¥å­˜å‚¨æµ®ç‚¹æ•°ç­‰å› æ­¤ä¹Ÿéœ€è¦æ›´æ–°ã€‚</li>
<li>stringï¼šï¼ˆstrings might have smaller backing storesï¼‰
<ul>
<li>å­—ç¬¦ä¸²å¯èƒ½æœ‰è¾ƒå°çš„åå¤‡å­˜å‚¨å™¨</li>
</ul>
</li>
<li>Array ç±»å‹æ—¶åˆ¤æ–­æ•°ç»„å…ƒç´ ï¼Œå¯èƒ½æ˜¯ä¸Šé¢ç±»å‹ã€‚</li>
<li>Struct æ—¶åˆ¤æ–­ç»“æ„ä½“çš„å…ƒç´ ï¼Œå¯èƒ½æ˜¯ä¸Šé¢ç±»å‹ã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">mt</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">)</span> <span class="nf">needkeyupdate</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span> <span class="c1">// true if we need to update key on an overwrite
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// flags = 8ï¼šéœ€è¦æ›´æ–°slotçš„key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">mt</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="mi">8</span> <span class="o">!=</span> <span class="mi">0</span>	
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="hashmightpanic">hashMightPanic()<a hidden class="anchor" aria-hidden="true" href="#hashmightpanic">#</a></h4>
<ol>
<li><strong><code>key</code> ç”Ÿæˆ <code>hash</code> å¯èƒ½å‘ç”Ÿ <code>panic</code></strong>ï¼Œè¿™æ˜¯ç”±äº<code>slice</code>ã€<code>map</code>ã€<code>function</code>ä¸èƒ½ä½œä¸º<code>map key</code>ï¼Œè€Œ<code>any</code>å¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹ã€‚</li>
<li>å­˜åœ¨å¯èƒ½çš„ç±»å‹ï¼š
<ul>
<li><code>any</code>ã€<code>slice</code>ã€<code>map</code>ã€<code>function</code>; å½“<code>any</code>å­˜å‚¨çš„<code>slice</code>æˆ–<code>map</code>æˆ–<code>function</code>æ—¶å°±ä¼š<code>panic</code>ã€‚</li>
<li><code>Array</code> ç±»å‹æ—¶åˆ¤æ–­æ•°ç»„çš„å…ƒç´ ï¼Œè¯¥å…ƒç´ æ—¶<code>slice</code>æˆ–<code>map</code>æˆ–åŒ…å«å®ƒä»¬éƒ½ä¼š<code>panic</code>ã€‚<code>Slice</code> ä¸èƒ½ä½œä¸º<code>key</code>ã€‚</li>
<li><code>Struct</code> ç±»å‹æ—¶åˆ¤æ–­ç»“æ„ä½“çš„å…ƒç´ ï¼Œè¯¥å…ƒç´ æ—¶<code>slice</code>æˆ–<code>map</code>æˆ–åŒ…å«å®ƒä»¬éƒ½ä¼š<code>panic</code>ã€‚</li>
<li>ä½†æ˜¯å¦‚æœæ˜¯å®ƒä»¬ç±»å‹çš„æŒ‡é’ˆåˆ™ä¸ä¼šå‘ç”Ÿ<code>panic</code>ã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">mt</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">)</span> <span class="nf">hashMightPanic</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span> <span class="c1">// true if hash function might panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// flags = 16ï¼škeyç”Ÿæˆhashå¯èƒ½panicçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">mt</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="mi">16</span> <span class="o">!=</span> <span class="mi">0</span>	
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="make-">make() ğŸš€<a hidden class="anchor" aria-hidden="true" href="#make-">#</a></h2>
<ol>
<li>makemap() å®ç°ä¸º <code>make(map[k]v, hint)</code> åˆ›å»º Go mapã€‚</li>
<li>å¦‚æœç¼–è¯‘å™¨å·²ç»ç¡®å®šå¯ä»¥åœ¨æ ˆä¸Šåˆ›å»ºmapæˆ–ç¬¬ä¸€ä¸ªbucketï¼Œh and/or bucket å¯èƒ½æ˜¯ non-nilã€‚</li>
<li>å¦‚æœ h != nilï¼Œåˆ™å¯ä»¥ç›´æ¥åœ¨hä¸­åˆ›å»ºmapã€‚</li>
<li>å¦‚æœ h.buckets != nilï¼Œåˆ™æŒ‡å‘çš„æ¡¶å¯ä»¥ç”¨ä½œç¬¬ä¸€ä¸ªæ¡¶ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><strong><code>t *maptype</code></strong>ï¼šmap çš„å…ƒç±»å‹ã€‚</li>
<li><strong><code>hint int</code></strong>ï¼š<code>key/elem</code>å¯¹çš„æ•°é‡ï¼Œ<strong>ä¸æ˜¯æ¡¶çš„æ•°é‡</strong>ã€‚hintèƒ½ä¿è¯ä¸€å®šèƒ½å­˜å‚¨key/elemå¯¹æ•°æ®è€Œä¸æ‰©å®¹ã€‚</li>
<li><strong><code>h *hmap</code></strong>ï¼šmap æŒ‡é’ˆï¼Œå¯èƒ½æ˜¯ nil æˆ– non-nilã€‚</li>
</ul>
</li>
<li>è¿”å›å€¼ï¼š
<ul>
<li><code>*hmap</code>ï¼šç”Ÿæˆçš„ map çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ <code>*hmap</code>ã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// makemap implements Go map creation for make(map[k]v, hint).
</span></span></span><span class="line"><span class="cl"><span class="c1">// If the compiler has determined that the map or the first bucket
</span></span></span><span class="line"><span class="cl"><span class="c1">// can be created on the stack, h and/or bucket may be non-nil.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If h != nil, the map can be created directly in h.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If h.buckets != nil, bucket pointed to can be used as the first bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">makemap</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">hint</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">)</span> <span class="o">*</span><span class="nx">hmap</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// MulUintptr è¿”å› a * b ä»¥åŠä¹˜æ³•æ˜¯å¦æº¢å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//      mem = uintptr(hint) * t.bucket.size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œä½¿ç”¨ key/elem å¯¹ä¹˜ä¸Š æ¡¶å¤§å° æ˜¾ç¤ºæ˜¯åœ¨æ‰©å¤§è®¡ç®—å†…å­˜ï¼Œå› ä¸º hint ä¸€å®šæ˜¯å¤§äº æ¡¶çš„æ•°é‡çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mem</span><span class="p">,</span> <span class="nx">overflow</span> <span class="o">:=</span> <span class="nx">math</span><span class="p">.</span><span class="nf">MulUintptr</span><span class="p">(</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">hint</span><span class="p">),</span> <span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">overflow</span> <span class="o">||</span> <span class="nx">mem</span> <span class="p">&gt;</span> <span class="nx">maxAlloc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">hint</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// initialize Hmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆå§‹åŒ– hmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ³¨æ„è¿™é‡Œä½¿ç”¨äº†newå‡½æ•°åˆ›å»ºçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">h</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">hmap</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ç”¨äºåç»­keyçš„hashï¼Œè¯¥å€¼åœ¨æ¡¶æ¯æ¬¡æ¸…ç©ºæ—¶è¯¥å€¼ä¼šä»æ–°ç”Ÿæˆéšæœºå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span> <span class="p">=</span> <span class="nf">fastrand</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Find the size parameter B which will hold the requested # of elements.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// For hint &lt; 0 overLoadFactor returns false since hint &lt; bucketCnt.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ‰¾åˆ°å‚æ•°Bçš„å¤§å°ï¼Œå®ƒå°†ä¿å­˜è¯·æ±‚çš„å…ƒç´ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯¹äº hint &lt; 0 overLoadFactor è¿”å› falseï¼Œå› ä¸º hint &lt; bucketCntã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">B</span> <span class="o">:=</span> <span class="nb">uint8</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è®¡ç®—ä¿å­˜hintä¸ªkey/elemå¯¹ä¸æ‰©å®¹æœ€å°éœ€è¦çš„Bçš„æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nf">overLoadFactor</span><span class="p">(</span><span class="nx">hint</span><span class="p">,</span> <span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">B</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">h</span><span class="p">.</span><span class="nx">B</span> <span class="p">=</span> <span class="nx">B</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// allocate initial hash table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// if B == 0, the buckets field is allocated lazily later (in mapassign)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// If hint is large zeroing this memory could take a while.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åˆ†é…åˆå§‹hashè¡¨ï¼Œå¦‚æœB == 0ï¼Œåˆ™ç¨å(åœ¨mapassignä¸­ï¼Œä¹Ÿå°±æ˜¯å­˜å‚¨æ•°æ®è¿‡ç¨‹ä¸­)å»¶è¿Ÿåˆ†é…bucketså­—æ®µï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœhintå¾ˆå¤§ï¼Œåˆ™æ¸…ç©ºè¯¥å†…å­˜å¯èƒ½éœ€è¦ä¸€æ®µæ—¶é—´ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">nextOverflow</span> <span class="o">*</span><span class="nx">bmap</span>  <span class="c1">// ç”¨äºè®°å½• makeBucketArray æ˜¯å¦åˆ†é…äº†æº¢å‡ºæ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// makeBucketArray æ ¹æ®Båˆ†é…å¸¸è§„æ¡¶å’Œæº¢å‡ºæ¡¶ï¼Œå¦‚æœåˆ†é…äº†æº¢å‡ºæ¡¶åˆ™å°†æœ€åä¸€ä¸ªæº¢å‡ºæ¡¶åœ°å€æŒ‡å‘ç¬¬ä¸€ä¸ªå¸¸è§„æ¡¶åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æº¢å‡ºæ¡¶åˆ†é…è§„åˆ™ B &gt;= 4 åˆ†é…æœ€å°‘ B-4 ä¸ªæº¢å‡ºæ¡¶å¤‡ç”¨ï¼Œæº¢å‡ºæ¡¶æ•°é‡ &gt;= 1 &lt;&lt; (B-4)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="nx">nextOverflow</span> <span class="p">=</span> <span class="nf">makeBucketArray</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">nextOverflow</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">mapextra</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// è®°å½•ä¸‹ä¸€ä¸ªå¯ä½¿ç”¨çš„æº¢å‡ºæ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">nextOverflow</span> <span class="p">=</span> <span class="nx">nextOverflow</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">h</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="overloadfactor">overLoadFactor()<a hidden class="anchor" aria-hidden="true" href="#overloadfactor">#</a></h3>
<ol>
<li>overLoadFactor æŠ¥å‘Šæ”¾ç½®åœ¨ 1&laquo;B æ¡¶ä¸­çš„é¡¹ç›®æ•°é‡æ˜¯å¦è¶…è¿‡ loadFactorã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// overLoadFactor reports whether count items placed in 1&lt;&lt;B buckets is over loadFactor.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">overLoadFactor</span><span class="p">(</span><span class="nx">count</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">B</span> <span class="kt">uint8</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// const (
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  bucketCnt = 8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  loadFactorNum = 13
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//  loadFactorDen = 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// )
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// bucketShift(B) == 1 &lt;&lt; B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// uintptr(count)/bucketShift(B) &lt; loadFactorNum/loadFactorDen
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// return count &gt; 8 &amp;&amp; count &gt; 6.5 * (1 &lt;&lt; B)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">count</span> <span class="p">&gt;</span> <span class="nx">bucketCnt</span> <span class="o">&amp;&amp;</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">loadFactorNum</span><span class="o">*</span><span class="p">(</span><span class="nf">bucketShift</span><span class="p">(</span><span class="nx">B</span><span class="p">)</span><span class="o">/</span><span class="nx">loadFactorDen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="bucketshift">bucketShift()<a hidden class="anchor" aria-hidden="true" href="#bucketshift">#</a></h3>
<ol>
<li>bucketShift è¿”å› <code>1&lt;&lt;b</code>ï¼Œä¸ºä»£ç ç”Ÿæˆåšäº†ä¼˜åŒ–ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// bucketShift returns 1&lt;&lt;b, optimized for code generation.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">bucketShift</span><span class="p">(</span><span class="nx">b</span> <span class="kt">uint8</span><span class="p">)</span> <span class="kt">uintptr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Masking the shift amount allows overflow checks to be elided.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å±è”½ç§»ä½é‡å¯ä»¥çœç•¥æº¢å‡ºæ£€æŸ¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// goarch.PtrSize 64ä½ä¸‹ä¸º8ï¼Œ32ä½ä¸‹ä¸º4; goarch.PtrSize*8 - 1 æ©ç ä¸ºäº†é˜²æ­¢æº¢å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nb">uintptr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nx">goarch</span><span class="p">.</span><span class="nx">PtrSize</span><span class="o">*</span><span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>   <span class="c1">// 1 &lt;&lt; b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="makebucketarray">makeBucketArray()<a hidden class="anchor" aria-hidden="true" href="#makebucketarray">#</a></h3>
<ol>
<li><code>makeBucketArray()</code> ä¸º <code>map</code> æ¡¶åˆå§‹åŒ–ä¸€ä¸ªåå¤‡æ•°ç»„ã€‚</li>
<li><code>1&lt;&lt;b</code>æ˜¯è¦åˆ†é…çš„æœ€å°æ¡¶æ•°ã€‚</li>
<li><code>dirtyalloc</code>è¦ä¹ˆæ˜¯<code>nil</code>ï¼Œè¦ä¹ˆæ˜¯<code>makeBucketArray</code>ä¹‹å‰åˆ†é…çš„å…·æœ‰ç›¸åŒ<code>t</code>å’Œ<code>b</code>å‚æ•°çš„æ¡¶æ•°ç»„ã€‚</li>
<li>å¦‚æœ<code>dirtyalloc</code>ä¸º<code>nil</code>ï¼Œå°†åˆ†é…ä¸€ä¸ªæ–°çš„åå¤‡æ•°ç»„ï¼Œå¦åˆ™å°†æ¸…é™¤<code>dirtyalloc</code>å¹¶ä½œä¸ºåå¤‡æ•°ç»„é‡ç”¨ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>t *maptype</code>ï¼š<code>map</code>çš„ç±»å‹ç»“æ„ã€‚</li>
<li><code>b uint8</code>ï¼š<code>h.B</code>çš„å€¼ã€‚</li>
<li><code>dirtyalloc unsafe.Pointer</code>ï¼š<code>nil</code>æ—¶é‡æ–°ç”³è¯·å—å†…å­˜ï¼Œä¸æ˜¯<code>nil</code>æ—¶ï¼Œç»§ç»­ä½¿ç”¨<code>dirtyalloc </code>æŒ‡å‘çš„å†…å­˜åœ°å€ã€‚</li>
</ul>
</li>
<li>è¿”å›å€¼ï¼š
<ul>
<li><code>buckets unsafe.Pointer</code>ï¼šåˆ†é…çš„å¸¸è§„æ¡¶é¦–åœ°å€ã€‚</li>
<li><code>nextOverflow *bmap</code>ï¼šåˆ†é…çš„æº¢å‡ºæ¡¶é¦–åœ°å€ã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// makeBucketArray initializes a backing array for map buckets.
</span></span></span><span class="line"><span class="cl"><span class="c1">// 1&lt;&lt;b is the minimum number of buckets to allocate.
</span></span></span><span class="line"><span class="cl"><span class="c1">// dirtyalloc should either be nil or a bucket array previously
</span></span></span><span class="line"><span class="cl"><span class="c1">// allocated by makeBucketArray with the same t and b parameters.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If dirtyalloc is nil a new backing array will be alloced and
</span></span></span><span class="line"><span class="cl"><span class="c1">// otherwise dirtyalloc will be cleared and reused as backing array.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">makeBucketArray</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">uint8</span><span class="p">,</span> <span class="nx">dirtyalloc</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">(</span><span class="nx">buckets</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">nextOverflow</span> <span class="o">*</span><span class="nx">bmap</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// base := 1 &lt;&lt; b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">base</span> <span class="o">:=</span> <span class="nf">bucketShift</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="c1">// å¸¸è§„æ¡¶æ•°é‡ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nbuckets</span> <span class="o">:=</span> <span class="nx">base</span> <span class="c1">// å­˜å‚¨(å¸¸è§„æ¡¶ + æº¢å‡ºæ¡¶)çš„æ€»æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// For small b, overflow buckets are unlikely.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Avoid the overhead of the calculation.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¯¹äºå°å€¼bæ¥è¯´ï¼Œæº¢å‡ºæ¡¶ä¸å¤ªå¯èƒ½å‡ºç°ã€‚é¿å…è®¡ç®—çš„å¼€é”€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æº¢å‡ºæ¡¶åˆ†é…è§„åˆ™ B &gt;= 4 åˆ†é…æœ€å°‘ B-4 ä¸ªæº¢å‡ºæ¡¶å¤‡ç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">b</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Add on the estimated number of overflow buckets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// required to insert the median number of elements
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// used with this value of b.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å†åŠ ä¸Šç”¨è¯¥å€¼bæ’å…¥å…ƒç´ çš„ä¸­ä½æ•°æ‰€éœ€çš„æº¢å‡ºæ¡¶çš„ä¼°è®¡æ•°é‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// nbuckets += 1 &lt;&lt; (b - 4)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">nbuckets</span> <span class="o">+=</span> <span class="nf">bucketShift</span><span class="p">(</span><span class="nx">b</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="c1">// å¸¸è§„æ¡¶ + æº¢å‡ºæ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">sz</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">size</span> <span class="o">*</span> <span class="nx">nbuckets</span> <span class="c1">// è®¡ç®—å…¨éƒ¨æ¡¶(å¸¸è§„æ¡¶ + æº¢å‡ºæ¡¶)æ‰€éœ€å†…å­˜å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">up</span> <span class="o">:=</span> <span class="nf">roundupsize</span><span class="p">(</span><span class="nx">sz</span><span class="p">)</span> <span class="c1">// åŒ¹é…æœ€æ¥è¿‘szçš„å†…å­˜å¤§å°è§„æ ¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">up</span> <span class="o">!=</span> <span class="nx">sz</span> <span class="p">{</span> <span class="c1">// åŒ¹é…çš„å†…å­˜è§„æ ¼åå¤§	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è°ƒæ•´ nbuckets æ•°é‡ï¼Œè¿™é‡Œåº”è¯¥æ˜¯åå¤§è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å› ä¸ºä¸èƒ½èƒ½åŒ¹é…åå‡ºç°åå°çš„æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">nbuckets</span> <span class="p">=</span> <span class="nx">up</span> <span class="o">/</span> <span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">size</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">dirtyalloc</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ²¡æœ‰å¯é‡æ–°åˆ©ç”¨çš„å†…å­˜å—ï¼Œé‡æ–°å‘å†…å­˜ç®¡ç†ç³»ç»Ÿç”³è¯·å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// buckets ç”³è¯·çš„æ¡¶é¦–åœ°å€ åŒ…å«å¸¸è§„æ¡¶å’Œæº¢å‡ºæ¡¶ï¼Œå› æ­¤å¸¸è§„æ¡¶å’Œæº¢å‡ºæ¡¶æ˜¯ä¸€æ•´å—è¿ç»­çš„å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">buckets</span> <span class="p">=</span> <span class="nf">newarray</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">nbuckets</span><span class="p">))</span>	
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// dirtyalloc was previously generated by
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// the above newarray(t.bucket, int(nbuckets))
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// but may not be empty.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// dirtyallocæ˜¯ç”±ä¸Šè¿° newarray(t.bucket, int(nbuckets)) ç”Ÿæˆçš„ï¼Œä½†ä¸èƒ½ä¸ºç©ºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">buckets</span> <span class="p">=</span> <span class="nx">dirtyalloc</span> <span class="c1">// æ¡¶å†…å­˜å—åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">size</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">size</span> <span class="o">*</span> <span class="nx">nbuckets</span> <span class="c1">// å†…å­˜å—å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">ptrdata</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å½“å‰æ¡¶ä¸­å­˜åœ¨æŒ‡é’ˆæ•°æ®æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// é‡ç½®ä»bucketsåœ°å€å¼€å§‹é•¿åº¦ä¸ºsizeå¤§å°çš„å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">memclrHasPointers</span><span class="p">(</span><span class="nx">buckets</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å½“å‰æ¡¶ä¸­ä¸å­˜åœ¨æŒ‡é’ˆæ•°æ®æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// é‡ç½®ä»bucketsåœ°å€å¼€å§‹é•¿åº¦ä¸ºsizeå¤§å°çš„å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">memclrNoHeapPointers</span><span class="p">(</span><span class="nx">buckets</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ†é…äº†æº¢å‡ºæ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">base</span> <span class="o">!=</span> <span class="nx">nbuckets</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// We preallocated some overflow buckets.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// To keep the overhead of tracking these overflow buckets to a minimum,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// we use the convention that if a preallocated overflow bucket&#39;s overflow
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// pointer is nil, then there are more available by bumping the pointer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// We need a safe non-nil pointer for the last overflow bucket; just use buckets.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æˆ‘ä»¬é¢„å…ˆåˆ†é…äº†ä¸€äº›æº¢å‡ºæ¡¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä¸ºäº†å°†è·Ÿè¸ªè¿™äº›æº¢å‡ºæ¡¶çš„å¼€é”€é™åˆ°æœ€ä½ï¼Œæˆ‘ä»¬ä½¿ç”¨çº¦å®š:å¦‚æœé¢„åˆ†é…çš„æº¢å‡ºæ¡¶çš„overflowæŒ‡é’ˆä¸ºnilï¼Œåˆ™é€šè¿‡ç¢°æ’æŒ‡é’ˆæ¥æä¾›æ›´å¤šå¯ç”¨çš„å†…å­˜ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æˆ‘ä»¬éœ€è¦ä¸ºæœ€åä¸€ä¸ªæº¢å‡ºæ¡¶æä¾›ä¸€ä¸ªå®‰å…¨çš„ non-nil æŒ‡é’ˆ; å°±ç”¨å¸¸è§„æ¡¶å§ã€‚ç”¨äºåœ¨åˆ†é…æº¢å‡ºæ¡¶æ—¶åˆ¤æ–­æº¢å‡ºæ¡¶ä»¥åˆ†é…å®Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">nextOverflow</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">buckets</span><span class="p">,</span> <span class="nx">base</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span> <span class="c1">// é¦–ä¸ªæº¢å‡ºæ¡¶ *bmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">last</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">buckets</span><span class="p">,</span> <span class="p">(</span><span class="nx">nbuckets</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span><span class="c1">// æœ€åä¸€ä¸ªæº¢å‡ºæ¡¶ *bmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä¹‹æ‰€ä»¥å°†æœ€åä¸€ä¸ªæº¢å‡ºæ¡¶overflowæŒ‡å‘ç¬¬ä¸€ä¸ªå¸¸è§„æ¡¶åœ°å€æ˜¯ç”¨äºåˆ†é…æº¢å‡ºæ¡¶æ˜¯åˆ¤æ–­æ˜¯å¦åˆ†é…å®Œå‚çœ‹(*hmap).newoverflow()æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">last</span><span class="p">.</span><span class="nf">setoverflow</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nx">buckets</span><span class="p">))</span>   <span class="c1">// æœ€åä¸€ä¸ªæº¢å‡ºæ¡¶æŒ‡é’ˆæŒ‡å‘é¦–ä¸ªå¸¸è§„æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">buckets</span><span class="p">,</span> <span class="nx">nextOverflow</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="../images/map-003.png" alt=""  />
</p>
<h3 id="newarray">newarray()<a hidden class="anchor" aria-hidden="true" href="#newarray">#</a></h3>
<ol>
<li><code>newarray()</code> åˆ†é…ä¸€ä¸ªåŒ…å« n ä¸ªç±»å‹ä¸º typ çš„å…ƒç´ çš„æ•°ç»„ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>typ *_type</code>ï¼šæ¡¶çš„ç±»å‹ç»“æ„ã€‚</li>
<li><code>n int</code>ï¼šæ¡¶çš„ä¸ªæ•°ï¼ˆå¸¸è§„æ¡¶ + æº¢å‡ºæ¡¶ï¼‰æ€»æ•°ã€‚</li>
</ul>
</li>
<li>è¿”å›å€¼ï¼š
<ul>
<li><code>unsafe.Pointer</code>ï¼šç”³è¯·åˆ°çš„å†…å­˜é¦–åœ°å€ã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// newarray allocates an array of n elements of type typ.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newarray</span><span class="p">(</span><span class="nx">typ</span> <span class="o">*</span><span class="nx">_type</span><span class="p">,</span> <span class="nx">n</span> <span class="kt">int</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åªæœ‰ä¸€ä¸ªæ¡¶ï¼Œç›´æ¥ç”³è¯·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nf">mallocgc</span><span class="p">(</span><span class="nx">typ</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">typ</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æº¢å‡ºåˆ¤æ–­ï¼Œtyp.size * uintptr(n) ä¸ºæ¡¶æ€»å…±å ç”¨çš„å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mem</span><span class="p">,</span> <span class="nx">overflow</span> <span class="o">:=</span> <span class="nx">math</span><span class="p">.</span><span class="nf">MulUintptr</span><span class="p">(</span><span class="nx">typ</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">overflow</span> <span class="o">||</span> <span class="nx">mem</span> <span class="p">&gt;</span> <span class="nx">maxAlloc</span> <span class="o">||</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">panic</span><span class="p">(</span><span class="nf">plainError</span><span class="p">(</span><span class="s">&#34;runtime: allocation size out of range&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">mallocgc</span><span class="p">(</span><span class="nx">mem</span><span class="p">,</span> <span class="nx">typ</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="makemap_small">makemap_small()<a hidden class="anchor" aria-hidden="true" href="#makemap_small">#</a></h3>
<ol>
<li><code>makemap_small()</code> å®ç°äº† <code>make(map[k]v)</code> å’Œ <code>make(map[k]v, hint)</code> çš„<code>Go map</code>åˆ›å»ºã€‚</li>
<li>å½“<code>hint(&lt;= 8)</code>åœ¨ç¼–è¯‘æ—¶å·²çŸ¥æœ€å¤šä¸º <code>bucketCnt</code> (8)ï¼Œå¹¶ä¸”éœ€è¦åœ¨å †ä¸Šåˆ†é…<code>map</code>æ—¶ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// makemap_small implements Go map creation for make(map[k]v) and
</span></span></span><span class="line"><span class="cl"><span class="c1">// make(map[k]v, hint) when hint is known to be at most bucketCnt
</span></span></span><span class="line"><span class="cl"><span class="c1">// at compile time and the map needs to be allocated on the heap.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">makemap_small</span><span class="p">()</span> <span class="o">*</span><span class="nx">hmap</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“ hint &lt;= 8 æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åˆå§‹åŒ– map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">h</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">hmap</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span> <span class="p">=</span> <span class="nf">fastrand</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">h</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="map-get-">map Get ğŸš€<a hidden class="anchor" aria-hidden="true" href="#map-get-">#</a></h2>
<ol>
<li>è·å– map ä¸­æŒ‡å®š key çš„å€¼</li>
</ol>
<h3 id="v--hkey">v := h[key]<a hidden class="anchor" aria-hidden="true" href="#v--hkey">#</a></h3>
<h4 id="mapaccess1_fat">mapaccess1_fat()<a hidden class="anchor" aria-hidden="true" href="#mapaccess1_fat">#</a></h4>
<ol>
<li>å¯ä»¥æŒ‡å®šé»˜è®¤å€¼ <code>zero</code>ï¼Œå½“åˆ†0å†…å­˜æ˜¯è¿”å›<code>zero</code>å€¼ã€‚</li>
<li>è¯¥å‡½æ•°è¿”å›ä¸€ä¸ªåœ°å€ï¼Œåœ°å€æŒ‡å‘çš„å€¼å°±æ˜¯è¦å–å¾—<code>v</code>å€¼ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>t *maptype</code>ï¼š<code>map</code>çš„ç±»å‹ç»“æ„ã€‚</li>
<li><code>h *hmap</code>ï¼š<code>map</code>çš„å†…å­˜ç»“æ„ã€‚</li>
<li><code>key unsafe.Pointer</code>ï¼š<code>key</code>çš„åœ°å€ã€‚</li>
<li><code>zero unsafe.Pointer</code>ï¼šé›¶å€¼åœ°å€ï¼Œç”¨äºè¿”å›å€¼ã€‚</li>
</ul>
</li>
<li>è¿”å›å€¼ï¼š
<ul>
<li><code>unsafe.Pointer</code>ï¼šè·å–åˆ°çš„<code>elem</code>åœ°å€ã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mapaccess1_fat</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">zero</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">e</span> <span class="o">:=</span> <span class="nf">mapaccess1</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">e</span> <span class="o">==</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">zeroVal</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">zero</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">e</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="mapaccess1">mapaccess1()<a hidden class="anchor" aria-hidden="true" href="#mapaccess1">#</a></h4>
<ol>
<li><code>mapaccess1()</code> è¿”å›ä¸€ä¸ªæŒ‡å‘<code>h[key]</code>çš„æŒ‡é’ˆã€‚</li>
<li>æ°¸è¿œä¸è¦è¿”å›nilï¼Œç›¸åï¼Œå¦‚æœ<code>key</code>ä¸åœ¨<code>map</code>ä¸­ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªæŒ‡å‘<code>elem</code>ç±»å‹çš„<code>zero</code>å¯¹è±¡çš„å¼•ç”¨ã€‚
<ul>
<li><code>zero</code>å¯¹è±¡å°±æ˜¯å…¨å±€å˜é‡<code>&amp;zeroVal[0]</code>åœ°å€å€¼ã€‚</li>
</ul>
</li>
<li>æ³¨æ„ï¼šè¿”å›çš„æŒ‡é’ˆå¯èƒ½ä¼šä½¿æ•´ä¸ª<code>map</code>ä¿æŒæ´»åŠ¨çŠ¶æ€ï¼Œæ‰€ä»¥ä¸è¦å ç”¨å®ƒå¤ªé•¿æ—¶é—´ã€‚</li>
<li>go map æ˜¯<strong>ä¸æ”¯æŒ</strong>å¤šçº¿ç¨‹çš„å†™ï¼Œä½†æ˜¯å¤šçº¿ç¨‹çš„è¯»æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// mapaccess1 returns a pointer to h[key].  Never returns nil, instead
</span></span></span><span class="line"><span class="cl"><span class="c1">// it will return a reference to the zero object for the elem type if
</span></span></span><span class="line"><span class="cl"><span class="c1">// the key is not in the map.
</span></span></span><span class="line"><span class="cl"><span class="c1">// NOTE: The returned pointer may keep the whole map live, so don&#39;t
</span></span></span><span class="line"><span class="cl"><span class="c1">// hold onto it for very long.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mapaccess1</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">key</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">callerpc</span> <span class="o">:=</span> <span class="nf">getcallerpc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pc</span> <span class="o">:=</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABIInternal</span><span class="p">(</span><span class="nx">mapaccess1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">racereadpc</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">h</span><span class="p">),</span> <span class="nx">callerpc</span><span class="p">,</span> <span class="nx">pc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">raceReadObjectPC</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">callerpc</span><span class="p">,</span> <span class="nx">pc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">msanenabled</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">msanread</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">asanenabled</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">asanread</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) mapæœªåˆå§‹åŒ– æˆ– æ²¡æœ‰key/elemå¯¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">h</span><span class="p">.</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å½“keyä¸ºanyç±»å‹æ—¶ï¼Œåœ¨keyç»è¿‡hashæ—¶å¯èƒ½ä¼šå‘ç”Ÿpanic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// t.hashMightPanic()åˆ¤æ–­å½“å‰hashå‡½æ•°æ˜¯å¦å¯èƒ½å‘ç”Ÿpanic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿™æ˜¯å› ä¸º any å­˜å‚¨çš„å€¼å¯èƒ½ä¸é€‚åˆä½œä¸º map çš„ key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">hashMightPanic</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å°è¯•hash panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">t</span><span class="p">.</span><span class="nf">hasher</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// see issue 23734
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ç›´æ¥è¿”å› &amp;zeroVal[0]ï¼Œè¿”å›é»˜è®¤å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">zeroVal</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 2) å½“å‰mapå­˜åœ¨å…¶ä»–goroutineæ­£åœ¨å†™æ“ä½œï¼Œç›´æ¥æŠ¥é”™ä¸æ”¯æŒå¹¶å‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// hashWriting æ ‡å¿—åœ¨å†™mapæˆ–delete mapæ—¶è¢«è®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">hashWriting</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fatal</span><span class="p">(</span><span class="s">&#34;concurrent map read and map write&#34;</span><span class="p">)</span>  <span class="c1">// å¹¶å‘çš„mapè¯»å†™æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 3) keyæ ¹æ®h.hash0ç”Ÿæˆhashå€¼ï¼Œæ ¹æ®ä¸Šé¢keyä¸ºanyæ—¶è¿™é‡Œhashå¯èƒ½ä¼španic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">hash</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">hasher</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">m</span> <span class="o">:=</span> <span class="nf">bucketMask</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="c1">// mapå¸¸è§„æ¡¶æ•°é‡; m = (1 &lt;&lt; B) - 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 4) åç§»åˆ°å½“å‰keyå¯¹åº”çš„å¸¸è§„æ¡¶å¤„ *bmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">b</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="p">(</span><span class="nx">hash</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 5) c != nil å½“å‰mapæ­£åœ¨æ‰©å®¹ä¸­ï¼Œéœ€è¦åˆ¤æ–­å½“å‰æ—§æ¡¶æ•°æ®æ˜¯å¦è¿ç§»ï¼Œæ²¡è¿ç§»æ•°æ®è¿˜åœ¨æ—§æ¡¶ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">c</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">oldbuckets</span><span class="p">;</span> <span class="nx">c</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// !h.sameSizeGrow() == true; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ç¿»å€æ‰©å®¹æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nx">h</span><span class="p">.</span><span class="nf">sameSizeGrow</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// There used to be half as many buckets; mask down one more power of two.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿‡å»æ¡¶çš„æ•°é‡åªæœ‰ç°åœ¨çš„ä¸€åŠ;å†é™¤ä¸€ä¸ª2çš„å€æ•°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">m</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span> <span class="c1">// éœ€è¦æŠŠmç¼©å°ä¸¤å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">oldb</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="p">(</span><span class="nx">hash</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// åˆ¤æ–­æ—§æ¡¶æ˜¯å¦å·²ç»è¿ç§»äº†ï¼Œæ²¡æœ‰è¿ç§»åˆ™ä»æ—§æ¡¶é‡Œé¢å–æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ä¸æ˜¯2|3|4æ—¶è¡¨ç¤ºæ•°æ®è¿˜åœ¨æ—§æ¡¶é‡Œé¢ï¼Œtophash[0] NOT IN (2,3,4)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nf">evacuated</span><span class="p">(</span><span class="nx">oldb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">b</span> <span class="p">=</span> <span class="nx">oldb</span>    <span class="c1">// æ›¿æ¢ä¸ºæ—§æ¡¶ *bmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 6) top æ˜¯ hash çš„é«˜å…«ä½å€¼ï¼Œç”¨äºå¿«é€Ÿæ¯”å¯¹ key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// hash &gt;&gt; (8*8 - 8)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">top</span> <span class="o">:=</span> <span class="nf">tophash</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span> <span class="c1">// uint8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">bucketloop</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 7) éå†å½“å‰æ¡¶ä»¥åŠåé¢çš„æº¢å‡ºæ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">;</span> <span class="nx">b</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// éå†å½“å‰æ¡¶; bucketCnt = 8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">bucketCnt</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 7.1) å½“å‰ tophash ä¸ç›¸ç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">top</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// const emptyRest = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// å½“å‰æ¡¶åŒ…æ‹¬æº¢å‡ºæ¡¶åé¢æ²¡æœ‰æ•°æ®äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">emptyRest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span> <span class="nx">bucketloop</span>    <span class="c1">// ç»“æŸéå†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// 7.2) b.tophash[i] == top; å¹¶ä¸ä»£è¡¨ä¸€å®šæ‰¾åˆ°keyï¼Œå¯èƒ½å‡ºç°tophashå†²çªæƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">k</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span> <span class="c1">// æ‰¾åˆ°å½“å‰keyçš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// keyçš„æ•°æ®æ˜¯é—´æ¥å­˜å‚¨çš„ï¼Œå…³äºå¸¸é‡maxKeySizeçš„ç›¸å…³æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectkey</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">k</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">k</span><span class="p">))</span> <span class="c1">// æ‹¿åˆ°keyåœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 7.3) è°ƒç”¨keyçš„æ¯”è¾ƒå‡½æ•°ï¼Œæ¯”è¾ƒkeyå’Œkæ˜¯å¦ç›¸ç­‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿™é‡Œä¹Ÿæ˜¯keyå¿…é¡»æ˜¯å¯æ¯”è¾ƒç±»å‹çš„åŸå› 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ä¸å¯æ¯”è¾ƒçš„ç±»å‹ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  1. mapï¼Œä»¥åŠåŒ…å«mapçš„ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  2. sliceï¼Œä»¥åŠåŒ…å«sliceçš„ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿™é‡Œkeyå¦‚æœæ˜¯ NaN çš„è¯æ¯”å¯¹ä¸é€šè¿‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nf">equal</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// æ¯”å¯¹æˆåŠŸã€‚åç§»åˆ°elemå…ƒç´ åœ°å€å¤„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">e</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">)</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elemsize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// elemçš„æ•°æ®æ˜¯é—´æ¥å­˜å‚¨çš„ï¼Œå…³äºå¸¸é‡maxElemSizeçš„ç›¸å…³æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectelem</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">e</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">e</span><span class="p">))</span> <span class="c1">// æ‹¿åˆ°elemåœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">e</span>    <span class="c1">// æˆåŠŸè¿”å›æ‰¾åˆ°çš„elemåœ°å€æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// æœªåŒ¹é…æˆåŠŸå‡ºç°tophashã€å†²çªã€‘æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// map ä¸­æ²¡æœ‰ keyï¼Œè¿”å›é»˜è®¤å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">zeroVal</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="bucketmask">bucketMask()<a hidden class="anchor" aria-hidden="true" href="#bucketmask">#</a></h4>
<ol>
<li>bucketMask è¿”å›<code>1&lt;&lt;b - 1</code>ï¼Œä¸ºä»£ç ç”Ÿæˆåšäº†ä¼˜åŒ–ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// bucketMask returns 1&lt;&lt;b - 1, optimized for code generation.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">bucketMask</span><span class="p">(</span><span class="nx">b</span> <span class="kt">uint8</span><span class="p">)</span> <span class="kt">uintptr</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">bucketShift</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1">// (1&lt;&lt;b) - 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="tophash">tophash()<a hidden class="anchor" aria-hidden="true" href="#tophash">#</a></h4>
<ol>
<li>tophash è®¡ç®— hash çš„ Tophash å€¼ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// tophash calculates the tophash value for hash.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">tophash</span><span class="p">(</span><span class="nx">hash</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="kt">uint8</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// hash &gt;&gt; (8*8 - 8)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// hashé«˜å…«ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">top</span> <span class="o">:=</span> <span class="nb">uint8</span><span class="p">(</span><span class="nx">hash</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="nx">goarch</span><span class="p">.</span><span class="nx">PtrSize</span><span class="o">*</span><span class="mi">8</span> <span class="o">-</span> <span class="mi">8</span><span class="p">))</span>	
</span></span><span class="line"><span class="cl">    <span class="c1">// top &lt; 5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">top</span> <span class="p">&lt;</span> <span class="nx">minTopHash</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">top</span> <span class="o">+=</span> <span class="nx">minTopHash</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">top</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="evacuated-1">evacuated()<a hidden class="anchor" aria-hidden="true" href="#evacuated-1">#</a></h4>
<ol>
<li>æ¡¶æ•°æ®æ˜¯å¦å·²è¿ç§»ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">evacuated</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">bmap</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">h</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// b.tophash[0] IN (2,3,4)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">h</span> <span class="p">&gt;</span> <span class="nx">emptyOne</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="p">&lt;</span> <span class="nx">minTopHash</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="v-b--hkey">v, b := h[key]<a hidden class="anchor" aria-hidden="true" href="#v-b--hkey">#</a></h3>
<h4 id="mapaccess2_fat">mapaccess2_fat()<a hidden class="anchor" aria-hidden="true" href="#mapaccess2_fat">#</a></h4>
<ol>
<li>å¯ä»¥æŒ‡å®šé»˜è®¤å€¼ zeroã€‚å½“åˆ†0å†…å­˜æ˜¯è¿”å› <code>zero</code> å€¼ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mapaccess2_fat</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">zero</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ²¡çœ‹é”™ï¼Œè¿™é‡Œä¾ç„¶æ˜¯è°ƒç”¨çš„ mapaccess1() å‡½æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› ä¸ºå¦‚æœæ²¡æ‰¾åˆ°keyä¼šè¿”å›&amp;zeroVal[0]ï¼Œæ ¹æ®è¯¥å€¼èƒ½åˆ¤æ–­boolã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">e</span> <span class="o">:=</span> <span class="nf">mapaccess1</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">e</span> <span class="o">==</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">zeroVal</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">zero</span><span class="p">,</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">e</span><span class="p">,</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="mapaccess2">mapaccess2()<a hidden class="anchor" aria-hidden="true" href="#mapaccess2">#</a></h4>
<ol>
<li>mapaccess2() å’Œ mapaccess1() ä»£ç åŸºæœ¬ä¸€æ ·ï¼Œåªå¤šè¿”å›ä¸ªè·å–æˆå¤±è´¥çš„å€¼ã€‚</li>
<li>è¯¥å‡½æ•°åœ¨åå°„ç›¸å…³ä¸­è¢«è°ƒç”¨ï¼Œæ­£å¸¸mapè¿™é‡Œä¸ä¼šè°ƒç”¨è¯¥å‡½æ•°ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mapaccess2</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">key</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">callerpc</span> <span class="o">:=</span> <span class="nf">getcallerpc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pc</span> <span class="o">:=</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABIInternal</span><span class="p">(</span><span class="nx">mapaccess2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">racereadpc</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">h</span><span class="p">),</span> <span class="nx">callerpc</span><span class="p">,</span> <span class="nx">pc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">raceReadObjectPC</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">callerpc</span><span class="p">,</span> <span class="nx">pc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">msanenabled</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">msanread</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">asanenabled</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">asanread</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">h</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">h</span><span class="p">.</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">hashMightPanic</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">t</span><span class="p">.</span><span class="nf">hasher</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// see issue 23734
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">zeroVal</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="kc">false</span> <span class="c1">// è¿™é‡Œè·å–å¤±è´¥è¿”å› false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">hashWriting</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fatal</span><span class="p">(</span><span class="s">&#34;concurrent map read and map write&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">hash</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">hasher</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">m</span> <span class="o">:=</span> <span class="nf">bucketMask</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="p">(</span><span class="nx">hash</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">c</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">oldbuckets</span><span class="p">;</span> <span class="nx">c</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nx">h</span><span class="p">.</span><span class="nf">sameSizeGrow</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// There used to be half as many buckets; mask down one more power of two.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">m</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">oldb</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="p">(</span><span class="nx">hash</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nf">evacuated</span><span class="p">(</span><span class="nx">oldb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">b</span> <span class="p">=</span> <span class="nx">oldb</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">top</span> <span class="o">:=</span> <span class="nf">tophash</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">bucketloop</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">;</span> <span class="nx">b</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">bucketCnt</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">top</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">emptyRest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span> <span class="nx">bucketloop</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">k</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectkey</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">k</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">k</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nf">equal</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">e</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">)</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elemsize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectelem</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">e</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">e</span><span class="p">,</span> <span class="kc">true</span> <span class="c1">// è¿™é‡Œè·å–æˆåŠŸè¿”å› true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">zeroVal</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="kc">false</span> <span class="c1">// è¿™é‡Œè·å–å¤±è´¥è¿”å› false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="map-set-">map Set ğŸš€<a hidden class="anchor" aria-hidden="true" href="#map-set-">#</a></h2>
<h3 id="hk--v">h[k] = v<a hidden class="anchor" aria-hidden="true" href="#hk--v">#</a></h3>
<h4 id="reflect_mapassign">reflect_mapassign()<a hidden class="anchor" aria-hidden="true" href="#reflect_mapassign">#</a></h4>
<ol>
<li><code>key</code>å’Œ<code>elem</code>åˆ†åˆ«ä»£è¡¨çš„æ˜¯å„è‡ªçš„åœ°å€ã€‚</li>
<li>å½“ <code>key != key</code> æ—¶ï¼Œå­˜å…¥çš„æ•°æ®<code>for range</code>æƒ…å†µæ˜¯å–ä¸å‡ºæ¥çš„ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>t *maptype</code>ï¼š<code>map</code>ç±»å‹ç»“æ„ã€‚</li>
<li><code>h *hmap</code>ï¼š<code>map</code>å†…å­˜ç»“æ„ã€‚</li>
<li><code>key unsafe.Pointer</code>ï¼š<code>map</code>çš„<code>key</code>åœ°å€ã€‚</li>
<li><code>elem unsafe.Pointer</code>ï¼š<code>map</code>è¦å†™å…¥çš„<code>v</code>åœ°å€ã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:linkname reflect_mapassign reflect.mapassign
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">reflect_mapassign</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">key</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">elem</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä»mapä¸­æ‰¾åˆ°elemåº”è¯¥æ”¾å…¥æ’æ§½çš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">p</span> <span class="o">:=</span> <span class="nf">mapassign</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">    <span class="c1">// æ‹·è´æ•°æ®ï¼Œä¹Ÿå°±å››æŠŠ&amp;vå¤åˆ¶ç»™mapæ’æ§½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">typedmemmove</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">elem</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="mapassign">mapassign()<a hidden class="anchor" aria-hidden="true" href="#mapassign">#</a></h4>
<ol>
<li>ç±»ä¼¼äºmapaccessï¼Œä½†å¦‚æœkeyåœ¨mapä¸­ä¸å­˜åœ¨ï¼Œåˆ™ä¼šä¸ºé”®åˆ†é…ä¸€ä¸ªä½ç½®ã€‚</li>
<li>å­˜åœ¨ä¸¤ç§æƒ…å†µï¼š
<ul>
<li><strong>æ–°å¢</strong>ï¼šå¯èƒ½<code>k</code>æ˜¯ä»æ¥æ²¡å­˜åœ¨<code>map</code>ä¸­ã€‚</li>
<li><strong>ä¿®æ”¹</strong>ï¼šå¯èƒ½<code>k</code>å·²ç»å­˜å‚¨åœ¨<code>map</code>ä¸­ã€‚</li>
</ul>
</li>
<li><code>map</code> æ˜¯<strong>å¹¶å‘ä¸å®‰å…¨</strong>çš„ã€‚</li>
<li><code>map</code> å¿…é¡»è¦ç»è¿‡<code>make()</code>å‡½æ•°åˆå§‹åŒ–æ‰èƒ½ä½¿ç”¨ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Like mapaccess, but allocates a slot for the key if it is not present in the map.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mapassign</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">key</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) æœªåˆå§‹åŒ–çš„mapä¸å…è®¸å†™æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œå°±æ˜¯ä¸ºä»€ä¹ˆå‘nilçš„mapå†™å…¥æ•°æ®ä¼španicåŸå› 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">panic</span><span class="p">(</span><span class="nf">plainError</span><span class="p">(</span><span class="s">&#34;assignment to entry in nil map&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">callerpc</span> <span class="o">:=</span> <span class="nf">getcallerpc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pc</span> <span class="o">:=</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABIInternal</span><span class="p">(</span><span class="nx">mapassign</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">racewritepc</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">h</span><span class="p">),</span> <span class="nx">callerpc</span><span class="p">,</span> <span class="nx">pc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">raceReadObjectPC</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">callerpc</span><span class="p">,</span> <span class="nx">pc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">msanenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">msanread</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">asanenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">asanread</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 2) æ£€æŸ¥mapæ˜¯å¦å­˜åœ¨å¹¶å‘çš„å†™æ“ä½œï¼Œåˆ é™¤ä¹Ÿæ˜¯å†™æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">hashWriting</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fatal</span><span class="p">(</span><span class="s">&#34;concurrent map writes&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 3) keyæ ¹æ®h.hash0ç”Ÿæˆhashå€¼ï¼Œæ ¹æ®ä¸Šé¢keyä¸ºanyæ—¶è¿™é‡Œhashå¯èƒ½ä¼španicã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">hash</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">hasher</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Set hashWriting after calling t.hasher, since t.hasher may panic,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// in which case we have not actually done a write.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨è°ƒç”¨t.hasherä¹‹åè®¾ç½®hashWritingï¼Œå› ä¸ºt.hasherå¯èƒ½ä¼šå‡ºé”™ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å®é™…ä¸Šå¹¶æ²¡æœ‰å†™å…¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¿™é‡Œä½¿ç”¨ ^= æœ‰ç‚¹å°çªé—¨ï¼Œå› ä¸ºåœ¨å¹¶å‘å†™çš„æƒ…å†µä¸‹å¯èƒ½å­˜åœ¨ä¸Šé¢çš„h.flags&amp;hashWriting != 0æ£€æŸ¥æ—¶è¢«è·³è¿‡äº†ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ‰€ä»¥è¿™ä¸ªå‡½æ•°æœ€åè¿˜éœ€è¦åˆ¤æ–­å¹¶æ˜¯å¦å·²ç»å‘ç”Ÿ ^ å¼‚æˆ– ç›¸åŒå¾—0ï¼Œä¸åŒå¾—1; hashWriting = 4 = 0b100
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æŒ‰ç…§æ­£å¸¸é€»è¾‘ h.flags çš„3bitä½åº”è¯¥æ˜¯0ï¼Œé‚£ä¹ˆ0^1=1ã€‚åœ¨å‡½æ•°çš„æœ€å h.flags&amp;hashWriting == 0 åˆ¤æ–­æ—¶ 1&amp;1=1ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¼‚å¸¸é€»è¾‘ h.flags çš„3bitä½æ˜¯1ï¼Œé‚£ä¹ˆ 1^1=0ã€‚åœ¨å‡½æ•°çš„æœ€å h.flags&amp;hashWriting == 0 åˆ¤æ–­æ—¶ 0&amp;1=0ã€‚å› æ­¤åˆ¤æ–­å¹¶å‘å‘ç”Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span> <span class="p">^=</span> <span class="nx">hashWriting</span>  <span class="c1">// å†™çŠ¶æ€æ ‡è®°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 4) æ²¡æœ‰åˆ†é…å¸¸è§„æ¡¶ï¼Œè¿™ç§æƒ…å†µæ¥è‡ªmakemap_small()å‡½æ•°ï¼Œhint&lt;=8 æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ç”³è¯·ä¸€ä¸ªå¸¸è§„æ¡¶å†…å­˜å—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span> <span class="p">=</span> <span class="nf">newobject</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">)</span> <span class="c1">// newarray(t.bucket, 1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">again</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 5) æ ¹æ® hash æ˜ å°„åˆ°æŒ‡å®šæ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bucket</span> <span class="o">:=</span> <span class="nx">hash</span> <span class="o">&amp;</span> <span class="nf">bucketMask</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="c1">// bucket = hash &amp; ((1 &lt;&lt; B) - 1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 6) æ˜¯å¦æ­£å¤„äºæ‰©å®¹ä¸­ï¼šã€ç­‰é‡æ‰©å®¹ã€‘ æˆ– ã€ç¿»å€æ‰©å®¹ã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nf">growing</span><span class="p">()</span> <span class="p">{</span>    <span class="c1">// h.oldbuckets != nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿ç§»å½“å‰keyå¯¹åº”çš„æ¡¶æ•°æ®åˆ°æ–°æ¡¶å®Œæˆéƒ¨åˆ†æ‰©å®¹ä»»åŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿ç§»åä¼šæŠŠæ—§æ¡¶æ•°æ®è¿ç§»åˆ°æ–°æ¡¶ï¼Œå› æ­¤ä»¥ä¸‹ä»£ç å¤„ç†æ–°æ¡¶å³å¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// growWork() å‡½æ•°åœ¨delete(map)å’Œmap[k]=væ—¶è¢«è°ƒç”¨ï¼Œæ¸è¿›å¼è¿ç§»æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">growWork</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 7) å¯»æ‰¾å¯¹åº”çš„æ¡¶(*bmap)ï¼Œkeyå¯¹åº”çš„æ¡¶ *bmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">b</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="nx">bucket</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// top = uint8( hash &amp; (1&gt;&gt;8*8-8) )
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">top</span> <span class="o">:=</span> <span class="nf">tophash</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span>    <span class="c1">// hash é«˜å…«ä½ï¼Œç”¨äºå¿«é€Ÿåˆ¤æ–­ key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// inserti å¯¹åº”keyåº”è¯¥æ”¾å…¥tophashçš„slotä½ç½®åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">inserti</span> <span class="o">*</span><span class="kt">uint8</span>	
</span></span><span class="line"><span class="cl">    <span class="c1">// insertk å¯¹åº”keyåº”è¯¥æ”¾å…¥keysçš„slotä½ç½®åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">insertk</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// elem å¯¹åº”keyåº”è¯¥æ”¾å…¥elemsçš„slotä½ç½®åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">elem</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>	
</span></span><span class="line"><span class="cl"><span class="nx">bucketloop</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 8) éå†å¸¸è§„æ¡¶å’Œæº¢å‡ºæ¡¶ï¼Œå¯»æ‰¾slotä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¢«åˆ é™¤çš„slotä¼šè¢«ä¼˜å…ˆä½¿ç”¨æ¥å­˜å‚¨æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 8.1) éå†å•ä¸ªæ¡¶; const bucketCnt = 8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">bucketCnt</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 8.1.1) tophash æ¯”å¯¹å¤±è´¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">top</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// isEmpty(b.tophash[i]) --&gt; b.tophash[i] &lt;= 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// inserti == nil; å¯»æ‰¾åˆ°slotåä¸ä¼šå†è¿›å…¥è¿™é‡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// è¿™é‡Œä¹Ÿæ˜¯åˆ¤æ–­å½“å‰å¯èƒ½æ˜¯æ–°å¢çš„æƒ…å†µï¼Œå½“å‰ä½å¯ä»¥æ’å…¥æ•°æ®å¦‚æœæ˜¯æ–°å¢çš„è¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nf">isEmpty</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">inserti</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// è®°å½•å½“å‰æ’æ§½ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nx">inserti</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">insertk</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">elem</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">)</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elemsize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1">// b.tophash[i] == 0; åé¢æ²¡æœ‰æ•°æ®äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">emptyRest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span> <span class="nx">bucketloop</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1">// b.tophash[i] == 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// åé¢æœ‰æ•°æ®éœ€è¦ç»§ç»­éå†åˆ¤æ–­æ˜¯å¦å½“å‰keyå·²ç»å­˜åœ¨åœ¨mapä¸­äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">continue</span>    <span class="c1">// continueçš„ä½œç”¨å°±æ˜¯ç»§ç»­éå†mapå¯»æ‰¾key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// tophashåŒ¹é…æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  1. å¯èƒ½æ˜¯hashå†²çªï¼Œç»§ç»­å‘åå¯»æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  2. å¯èƒ½æ˜¯åŒ¹é…åˆ°äº†keyï¼Œåˆ™æ˜¯æ›´æ–°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            
</span></span><span class="line"><span class="cl">            <span class="c1">// 8.1.2) å½“å‰keyçš„slotåœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">k</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectkey</span><span class="p">()</span> <span class="p">{</span>    <span class="c1">// key é—´æ¥å­˜å‚¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">k</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">k</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 8.1.3) æ¯”è¾ƒkeyå’Œkæ˜¯å¦ç›¸ç­‰ï¼Œä¸ç›¸ç­‰è¯´æ˜ tophashå†²çªäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦‚æœå­˜å‚¨çš„ key æ˜¯ NaN è¿™é‡Œæ¯”å¯¹ä¸é€šè¿‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">!</span><span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nf">equal</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>    <span class="c1">// key != k ç»§ç»­å‘åå¯»æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// key == k; åŒ¹é…æˆåŠŸåˆ™æœ¬æ¬¡æ˜¯æ›´æ–°æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                
</span></span><span class="line"><span class="cl">            <span class="c1">// already have a mapping for key. Update it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å·²ç»æœ‰ä¸€ä¸ªkeyçš„æ˜ å°„ã€‚ã€æ›´æ–°å®ƒã€‘ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// key == keyæˆç«‹ï¼Œä½†æ˜¯å¯èƒ½ç”Ÿæˆçš„hashå€¼ä¸åŒï¼Œæ¯”å¦‚+0å’Œ-0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">needkeyupdate</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">typedmemmove</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="c1">// æŠŠkæ›´æ–°ä¸ºkey
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 8.1.4) æ‰¾åˆ°elemåœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">elem</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">)</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elemsize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="nx">done</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ovf</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>    <span class="c1">// båé¢é“¾æ¥çš„æº¢å‡ºæ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ²¡æœ‰æº¢å‡ºæ¡¶äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">ovf</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">b</span> <span class="p">=</span> <span class="nx">ovf</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Did not find mapping for key. Allocate new cell &amp; add entry.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 9) æ²¡æœ‰æ‰¾åˆ°keyçš„æ˜ å°„ã€‚åˆ†é…æ–°çš„å•å…ƒæ ¼å¹¶æ·»åŠ entryã€‚æ–°å¢ key/elem 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// If we hit the max load factor or we have too many overflow buckets,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// and we&#39;re not already in the middle of growing, start growing.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 10) å¦‚æœæˆ‘ä»¬è¾¾åˆ°äº†æœ€å¤§è´Ÿè½½ç³»æ•°ï¼Œæˆ–è€…æˆ‘ä»¬æœ‰å¤ªå¤šæº¢å‡ºæ¡¶ï¼Œè€Œæˆ‘ä»¬è¿˜æ²¡æœ‰è¾¾åˆ°å¢é•¿çš„ä¸€åŠï¼Œå°±å¼€å§‹å¢é•¿ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// h.growing() -&gt; (h.oldbuckets != nil); æ˜¯å¦æ­£åœ¨æ‰©å®¹ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nx">h</span><span class="p">.</span><span class="nf">growing</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nf">overLoadFactor</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">count</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="o">||</span> <span class="nf">tooManyOverflowBuckets</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">noverflow</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">hashGrow</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span>  <span class="c1">// æ‰©å®¹åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// æ‰©å®¹hash tableä¼šä½¿ä¸Šé¢çš„æ‰€æœ‰æ“ä½œå¤±æ•ˆï¼Œæ‰€ä»¥å†è¯•ä¸€æ¬¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">goto</span> <span class="nx">again</span> <span class="c1">// Growing the table invalidates everything, so try again
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 11) å¸¸è§„æ¡¶å’Œæº¢å‡ºæ¡¶(å¦‚æœå­˜åœ¨)éƒ½æ²¡æ‰¾åˆ°slotï¼Œè¿™æ—¶å€™éœ€è¦åˆ†é…æ–°çš„æº¢å‡ºæ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">inserti</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// The current bucket and all the overflow buckets connected to it are full, allocate a new one.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å½“å‰æ¡¶å’Œè¿æ¥åˆ°å®ƒçš„æ‰€æœ‰æº¢å‡ºæ¡¶å·²æ»¡ï¼Œåˆ†é…ä¸€ä¸ªæ–°çš„æ¡¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">newb</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nf">newoverflow</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="c1">// åˆ†é…ä¸€ä¸ªæº¢å‡ºæ¡¶ *bmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">inserti</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">newb</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nx">insertk</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">newb</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">elem</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">insertk</span><span class="p">,</span> <span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// store new key/elem at insert position
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 12) å°†æ–°çš„é”®/elemå­˜å‚¨åœ¨æ’å…¥ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectkey</span><span class="p">()</span> <span class="p">{</span>    <span class="c1">// key é—´æ¥å­˜å‚¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">kmem</span> <span class="o">:=</span> <span class="nf">newobject</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">insertk</span><span class="p">)</span> <span class="p">=</span> <span class="nx">kmem</span>
</span></span><span class="line"><span class="cl">        <span class="nx">insertk</span> <span class="p">=</span> <span class="nx">kmem</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectelem</span><span class="p">()</span> <span class="p">{</span>   <span class="c1">// elem é—´æ¥å­˜å‚¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">vmem</span> <span class="o">:=</span> <span class="nf">newobject</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elem</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">elem</span><span class="p">)</span> <span class="p">=</span> <span class="nx">vmem</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ç”±äºdoneåé¢æœ‰ t.indirectelem() åˆ¤æ–­æ‰€æœ‰è¿™é‡Œæ²¡æœ‰ elem = vmem è¿™è¡Œä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 13) æ‹·è´æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">typedmemmove</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">insertk</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="c1">// ä¿å­˜keyçš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">*</span><span class="nx">inserti</span> <span class="p">=</span> <span class="nx">top</span> <span class="c1">// tophash ä¿å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">h</span><span class="p">.</span><span class="nx">count</span><span class="o">++</span> <span class="c1">// key/elem å¯¹åŠ ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nx">done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 14) å†æ¬¡åˆ¤æ–­æ˜¯å¦æœ‰å…¶ä»–goroutineæ­£åœ¨å¯¹mapè¿›è¡Œå†™æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">hashWriting</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fatal</span><span class="p">(</span><span class="s">&#34;concurrent map writes&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span> <span class="o">&amp;^=</span> <span class="nx">hashWriting</span> <span class="c1">// æ¸…é™¤hashWritingæ ‡å¿—ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectelem</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// elem é—´æ¥å­˜å‚¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">elem</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">elem</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">elem</span> <span class="c1">// è¿”å›å½“å‰slotçš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="isempty">isEmpty()<a hidden class="anchor" aria-hidden="true" href="#isempty">#</a></h4>
<ol>
<li><code>isEmpty</code>æŠ¥å‘Šç»™å®šçš„<code>tophash</code>æ•°ç»„é¡¹æ˜¯å¦è¡¨ç¤ºç©ºæ¡¶é¡¹ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// isEmpty reports whether the given tophash array entry represents an empty bucket entry.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">isEmpty</span><span class="p">(</span><span class="nx">x</span> <span class="kt">uint8</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">x</span> <span class="o">&lt;=</span> <span class="nx">emptyOne</span>    <span class="c1">// x &lt;= 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="overloadfactor-1">overLoadFactor()<a hidden class="anchor" aria-hidden="true" href="#overloadfactor-1">#</a></h4>
<ol>
<li>ç¿»å€æ‰©å®¹åˆ¤æ–­æ¡ä»¶ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// overLoadFactor reports whether count items placed in 1&lt;&lt;B buckets is over loadFactor.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">overLoadFactor</span><span class="p">(</span><span class="nx">count</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">B</span> <span class="kt">uint8</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// count &gt; 8 &amp;&amp; count &gt; 13*((1&lt;&lt;B) / 2)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">count</span> <span class="p">&gt;</span> <span class="nx">bucketCnt</span> <span class="o">&amp;&amp;</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">loadFactorNum</span><span class="o">*</span><span class="p">(</span><span class="nf">bucketShift</span><span class="p">(</span><span class="nx">B</span><span class="p">)</span><span class="o">/</span><span class="nx">loadFactorDen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="toomanyoverflowbuckets">tooManyOverflowBuckets()<a hidden class="anchor" aria-hidden="true" href="#toomanyoverflowbuckets">#</a></h4>
<ol>
<li>ç­‰é‡æ‰©å®¹åˆ¤æ–­æ¡ä»¶ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// tooManyOverflowBuckets reports whether noverflow buckets is too many for a map with 1&lt;&lt;B buckets.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Note that most of these overflow buckets must be in sparse use;
</span></span></span><span class="line"><span class="cl"><span class="c1">// if use was dense, then we&#39;d have already triggered regular map growth.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">tooManyOverflowBuckets</span><span class="p">(</span><span class="nx">noverflow</span> <span class="kt">uint16</span><span class="p">,</span> <span class="nx">B</span> <span class="kt">uint8</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// If the threshold is too low, we do extraneous work.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// If the threshold is too high, maps that grow and shrink can hold on to lots of unused memory.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// &#34;too many&#34; means (approximately) as many overflow buckets as regular buckets.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// See incrnoverflow for more details.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">B</span> <span class="p">&gt;</span> <span class="mi">15</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">B</span> <span class="p">=</span> <span class="mi">15</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The compiler doesn&#39;t see here that B &lt; 16; mask B to generate shorter shift code.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">noverflow</span> <span class="o">&gt;=</span> <span class="nb">uint16</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="nx">B</span><span class="o">&amp;</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="æ‰©å®¹-">æ‰©å®¹ ğŸš€<a hidden class="anchor" aria-hidden="true" href="#æ‰©å®¹-">#</a></h2>
<h3 id="ç¿»å€æ‰©å®¹æ¡ä»¶">ç¿»å€æ‰©å®¹æ¡ä»¶<a hidden class="anchor" aria-hidden="true" href="#ç¿»å€æ‰©å®¹æ¡ä»¶">#</a></h3>
<ol>
<li><code>h.oldbuckets == nil</code>; æœªå¤„äºæ‰©å®¹è¿‡ç¨‹ä¸­ã€‚</li>
<li>å­˜å‚¨çš„<code>key/elem</code>å¯¹æ•°é‡å¤§äºå¸¸è§„æ¡¶æ•°é‡çš„ 6.5 å€ã€‚</li>
<li><code>key/elem</code>å¯¹æ•°é‡å¤§äº8</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 1) h.oldbuckets != nil; å¤„äºæ‰©å®¹ä¸­ã€‚!h.growing()ï¼šæ²¡æœ‰å¤„äºæ‰©å®¹ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1">// 2) overLoadFactor(h.count+1, h.B)ï¼šæ–°å¢ä¸€ä¸ªå…ƒç´ æ˜¯å¦éœ€è¦æ‰©å®¹åˆ¤æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">!</span><span class="nx">h</span><span class="p">.</span><span class="nf">growing</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nf">overLoadFactor</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">count</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="overloadfactor-2">overLoadFactor()<a hidden class="anchor" aria-hidden="true" href="#overloadfactor-2">#</a></h4>
<ol>
<li><code>overLoadFactor</code> æŠ¥å‘Šæ”¾ç½®åœ¨ <code>1&lt;&lt;B</code> æ¡¶ä¸­çš„é¡¹ç›®æ•°é‡æ˜¯å¦è¶…è¿‡ <code>loadFactor</code>ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// overLoadFactor reports whether count items placed in 1&lt;&lt;B buckets is over loadFactor.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">overLoadFactor</span><span class="p">(</span><span class="nx">count</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">B</span> <span class="kt">uint8</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// count &gt; 8 &amp;&amp; count &gt; 13*( (1&lt;&lt;B) / 2)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// count &gt; 8 &amp;&amp; count &gt; 6.5 * (1&lt;&lt;B)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">count</span> <span class="p">&gt;</span> <span class="nx">bucketCnt</span> <span class="o">&amp;&amp;</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">loadFactorNum</span><span class="o">*</span><span class="p">(</span><span class="nf">bucketShift</span><span class="p">(</span><span class="nx">B</span><span class="p">)</span><span class="o">/</span><span class="nx">loadFactorDen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ç­‰é‡æ‰©å®¹æ¡ä»¶">ç­‰é‡æ‰©å®¹æ¡ä»¶<a hidden class="anchor" aria-hidden="true" href="#ç­‰é‡æ‰©å®¹æ¡ä»¶">#</a></h3>
<ol>
<li>å½“å¸¸è§„æ¡¶(<code>h.B</code>)å°äºç­‰äº15æ—¶ï¼Œæº¢å‡ºæ¡¶æ•°é‡ <strong>å¤§äºç­‰äº</strong> å¸¸è§„æ¡¶æ•°é‡(<code>1 &lt;&lt; h.B</code>) å°±è¦æ‰©å®¹ã€‚</li>
<li>å½“å¸¸è§„æ¡¶(<code>h.B</code>)å¤§äº15æ—¶ï¼Œæº¢å‡ºæ¡¶æ•°é‡ <strong>å¤§äºç­‰äº</strong> (<code>1 &lt;&lt; 15</code>) å°±è¦æ‰©å®¹äº†ã€‚</li>
<li>æº¢å‡ºæ¡¶çš„åˆ†é…è§„åˆ™ï¼š<strong>å½“<code>B&gt;=4</code>æ—¶åˆ™åˆ†é…(<code>B-4</code>)ä¸ªæº¢å‡ºæ¡¶å¤‡ç”¨</strong>ï¼Œå› æ­¤å¸¸è§„æ¡¶æ•°é‡å¤§äºæº¢å‡ºæ¡¶æ•°é‡ã€‚ç­‰é‡æ‰©å®¹æ—¶å¤‡ç”¨çš„æº¢å‡ºæ¡¶ä¸€å®šæ˜¯è¢«ç”¨å®Œäº†ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 1) !h.growing()ï¼šæ²¡æœ‰å¤„äºæ‰©å®¹ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1">// 2) tooManyOverflowBuckets(h.noverflow, h.B)ï¼šæ»¡è¶³ç­‰é‡æ‰©å®¹æ¡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">!</span><span class="nx">h</span><span class="p">.</span><span class="nf">growing</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nf">tooManyOverflowBuckets</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">noverflow</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="toomanyoverflowbuckets-1">tooManyOverflowBuckets()<a hidden class="anchor" aria-hidden="true" href="#toomanyoverflowbuckets-1">#</a></h4>
<ol>
<li><code>tooManyOverflowBuckets</code> æŠ¥å‘Š <code>noverflow</code> æ¡¶å¯¹äºä¸€ä¸ªåŒ…å« <code>1&lt;&lt;B</code> æ¡¶çš„ <code>map</code> æ¥è¯´æ˜¯å¦å¤ªå¤šã€‚</li>
<li>è¯·æ³¨æ„ï¼Œå¤§å¤šæ•°æº¢å‡ºæ¡¶å¿…é¡»ç¨€ç–ä½¿ç”¨;</li>
<li>å¦‚æœä½¿ç”¨æ˜¯å¯†é›†çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å·²ç»è§¦å‘äº†å¸¸è§„çš„ <code>map</code> å¢é•¿ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// tooManyOverflowBuckets reports whether noverflow buckets is too many for a map with 1&lt;&lt;B buckets.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Note that most of these overflow buckets must be in sparse use;
</span></span></span><span class="line"><span class="cl"><span class="c1">// if use was dense, then we&#39;d have already triggered regular map growth.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">tooManyOverflowBuckets</span><span class="p">(</span><span class="nx">noverflow</span> <span class="kt">uint16</span><span class="p">,</span> <span class="nx">B</span> <span class="kt">uint8</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// If the threshold is too low, we do extraneous work.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// If the threshold is too high, maps that grow and shrink can hold on to lots of unused memory.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// &#34;too many&#34; means (approximately) as many overflow buckets as regular buckets.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// See incrnoverflow for more details.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœé˜ˆå€¼å¤ªä½ï¼Œæˆ‘ä»¬åšå¤šä½™çš„å·¥ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¦‚æœé˜ˆå€¼è¿‡é«˜ï¼Œåˆ™å¢å¤§å’Œç¼©å°çš„æ˜ å°„ä¼šå ç”¨å¤§é‡æœªä½¿ç”¨çš„å†…å­˜ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// &#34;too many&#34;æ˜¯æŒ‡æº¢å‡ºæ¡¶çš„æ•°é‡(å¤§çº¦)ä¸æ™®é€šæ¡¶ç›¸åŒã€‚æ›´å¤šç»†èŠ‚è¯·å‚è§h.incnoverflow()ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">B</span> <span class="p">&gt;</span> <span class="mi">15</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">B</span> <span class="p">=</span> <span class="mi">15</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The compiler doesn&#39;t see here that B &lt; 16; mask B to generate shorter shift code.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç¼–è¯‘å™¨æ²¡æœ‰çœ‹åˆ°B &lt; 16;æ©ç Bä»¥ç”Ÿæˆæ›´çŸ­çš„ç§»ä½ç ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// noverflowï¼šè¡¨ç¤ºå·²ä½¿ç”¨çš„æº¢å‡ºæ¡¶æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">noverflow</span> <span class="o">&gt;=</span> <span class="nb">uint16</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="nx">B</span><span class="o">&amp;</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ‰©å®¹åˆå§‹åŒ–">æ‰©å®¹åˆå§‹åŒ–<a hidden class="anchor" aria-hidden="true" href="#æ‰©å®¹åˆå§‹åŒ–">#</a></h3>
<h4 id="hashgrow">hashGrow()<a hidden class="anchor" aria-hidden="true" href="#hashgrow">#</a></h4>
<ol>
<li>æ‰©å®¹åˆå§‹åŒ–å¼€å§‹ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>t *maptype</code>ï¼šå½“å‰ map çš„ç±»å‹ç»“æ„ã€‚</li>
<li><code>h *hmap</code>ï¼šå½“å‰ map çš„å†…å­˜ç»“æ„ã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">hashGrow</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// If we&#39;ve hit the load factor, get bigger.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Otherwise, there are too many overflow buckets,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// so keep the same number of buckets and &#34;grow&#34; laterally.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 1) å¦‚æœæˆ‘ä»¬è¾¾åˆ°äº†æ»¡è½½ç³»æ•°ï¼Œå°±ä¼šå˜å¤§ã€‚å¦åˆ™ï¼Œæº¢å‡ºæ¡¶å¤ªå¤šï¼Œæ‰€ä»¥ä¿æŒç›¸åŒæ•°é‡çš„æ¡¶ï¼Œæ¨ªå‘â€œå¢é•¿â€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bigger</span> <span class="o">:=</span> <span class="nb">uint8</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>	<span class="c1">// biggeræ˜¯ç¿»å€æ‰©å®¹è¿˜æ˜¯ç­‰é‡æ‰©å®¹ 1.ã€ç¿»å€æ‰©å®¹ã€‘ 0.ã€ç­‰é‡æ‰©å®¹ã€‘	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nf">overLoadFactor</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">count</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">bigger</span> <span class="p">=</span> <span class="mi">0</span> <span class="c1">// æ ‡è®°ç­‰é‡æ‰©å®¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span> <span class="o">|=</span> <span class="nx">sameSizeGrow</span>	<span class="c1">// è®¾ç½®ç­‰é‡æ‰©å®¹æ ‡å¿—ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">oldbuckets</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span> <span class="c1">// è®°å½•æ—§æ¡¶åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2) ç”³è¯·ä¸€å—æ–°å†…å­˜ï¼Œå½“åšæ–°æ¡¶åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">newbuckets</span><span class="p">,</span> <span class="nx">nextOverflow</span> <span class="o">:=</span> <span class="nf">makeBucketArray</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="o">+</span><span class="nx">bigger</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 3) æ¸…é™¤iterator å’Œ oldIteratoræ ‡å¿—çš„flags
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">flags</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span> <span class="o">&amp;^</span> <span class="p">(</span><span class="nx">iterator</span> <span class="p">|</span> <span class="nx">oldIterator</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿­ä»£å™¨åœ¨æ‰©å®¹çš„å‰é¢æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">iterator</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>	<span class="c1">// è¿­ä»£å™¨æ­£åœ¨è¿è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">flags</span> <span class="o">|=</span> <span class="nx">oldIterator</span> <span class="c1">// æ ‡è®°è¿­ä»£æ—§æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// 4) è®¾ç½® hmap ç›¸å…³å‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// commit the grow (atomic wrt gc)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">h</span><span class="p">.</span><span class="nx">B</span> <span class="o">+=</span> <span class="nx">bigger</span>       <span class="c1">// æ‰©å®¹åçš„B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span> <span class="p">=</span> <span class="nx">flags</span>     <span class="c1">// æœ€æ–°çš„flagsçŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">h</span><span class="p">.</span><span class="nx">oldbuckets</span> <span class="p">=</span> <span class="nx">oldbuckets</span> <span class="c1">// æ—§æ¡¶åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span> <span class="p">=</span> <span class="nx">newbuckets</span>  <span class="c1">// æ–°æ¡¶åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">h</span><span class="p">.</span><span class="nx">nevacuate</span> <span class="p">=</span> <span class="mi">0</span>	<span class="c1">// ä¸‹ä¸€ä¸ªéœ€è¦è¿ç§»çš„æ—§æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">h</span><span class="p">.</span><span class="nx">noverflow</span> <span class="p">=</span> <span class="mi">0</span> <span class="c1">// å·²ä½¿ç”¨çš„æº¢å‡ºæ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// h.extra.overflow å’Œ h.extra.oldoverflow
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 5) æº¢å‡ºæ¡¶ç›¸å…³è®¾ç½®ï¼ˆä¸»è¦æ˜¯GCç›¸å…³ï¼‰ï¼Œä½œç”¨åœ¨å‰é¢å·²ç»ä»‹ç»äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">overflow</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Promote current overflow buckets to the old generation.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">oldoverflow</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;oldoverflow is not nil&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">oldoverflow</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">overflow</span>
</span></span><span class="line"><span class="cl">        <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">overflow</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 6) åˆ†é…äº†å¤‡ç”¨æº¢å‡ºæ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">nextOverflow</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">mapextra</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">nextOverflow</span> <span class="p">=</span> <span class="nx">nextOverflow</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// the actual copying of the hash table data is done incrementally
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// by growWork() and evacuate().
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å®é™…çš„å“ˆå¸Œè¡¨æ•°æ®å¤åˆ¶æ˜¯é€šè¿‡growWork()å’Œevacuate()å®Œæˆçš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ¸è¿›å¼æ‰©å®¹åˆ†é…åˆ°ã€å†™ã€‘å’Œã€åˆ é™¤ã€‘ä¸­è°ƒç”¨growWork()å’Œevacuate()å®Œæˆçš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ³¨æ„ï¼šè¯»æ“ä½œã€å¹¶æ²¡æœ‰ã€‘æ¸è¿›å¼è¿ç§»éƒ¨åˆ†æ•°æ®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ¸è¿›å¼è¿ç§»">æ¸è¿›å¼è¿ç§»<a hidden class="anchor" aria-hidden="true" href="#æ¸è¿›å¼è¿ç§»">#</a></h3>
<h4 id="growwork">growWork()<a hidden class="anchor" aria-hidden="true" href="#growwork">#</a></h4>
<ol>
<li>æ¸è¿›å¼è¿ç§»æ¡¶æ•°æ®ã€‚<strong>å…ˆè¿ç§»å½“å‰ä¼ å…¥çš„æ¡¶å·ï¼Œå†å»è¿ç§»ä¸‹æ¬¡éœ€è¦è¿ç§»çš„æ¡¶å·</strong>ã€‚</li>
<li>å› ä¸ºå½“å‰ä¼ å…¥çš„æ¡¶å·ä¸€å®šæ˜¯å½“å‰æ­£åœ¨å†™æˆ–åˆ é™¤çš„keyå¯¹åº”çš„æ¡¶å·ï¼Œå› æ­¤å…ˆè¿ç§»è¯¥æ¡¶ï¼Œç„¶åè¿ç§»å›ºå®šå¢é•¿çš„æ¡¶å·ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">growWork</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">bucket</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// make sure we evacuate the oldbucket corresponding
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// to the bucket we&#39;re about to use
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç¡®ä¿æˆ‘ä»¬æ¸…ç©ºäº†å°†è¦ä½¿ç”¨çš„æ¡¶å¯¹åº”çš„oldbucket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">evacuate</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">bucket</span><span class="o">&amp;</span><span class="nx">h</span><span class="p">.</span><span class="nf">oldbucketmask</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// evacuate one more oldbucket to make progress on growing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç–æ•£æ›´å¤šçš„æ—§æ¡¶ï¼Œä»¥å–å¾—è¿›å±•çš„å¢é•¿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nf">growing</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">evacuate</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">nevacuate</span><span class="p">)</span>	<span class="c1">// æ³¨æ„è¿™é‡Œä¼ çš„æ¡¶å·æ˜¯h.nevacuate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="evacuate">evacuate()<a hidden class="anchor" aria-hidden="true" href="#evacuate">#</a></h4>
<ol>
<li>æ‰§è¡Œ<strong>ä¸€æ¬¡</strong>æ¡¶è¿ç§»ï¼Œåœ¨ç–æ•£æ—§æ¡¶æ—¶åªä¿®æ”¹äº†<code>topHash</code>ï¼Œå¹¶ä¸”åœ¨<strong>æ²¡æœ‰è¿­ä»£å™¨</strong>æƒ…å†µä¸‹æ‰æ¸…é™¤<code>key/elem</code>ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>t *maptype</code>ï¼šmap ç±»å‹ç»“æ„ã€‚</li>
<li><code>h *hmap</code>ï¼šmap å†…å­˜ç»“æ„ã€‚</li>
<li><code>oldbucket uintptr</code>ï¼šå½“å‰éœ€è¦è¿ç§»æ¡¶çš„ç¼–å·ã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">evacuate</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">oldbucket</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) oldbucket æ¡¶å·å¯¹åº”çš„ *bmap 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">b</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">oldbuckets</span><span class="p">,</span> <span class="nx">oldbucket</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>    <span class="c1">// *bmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">newbit</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nf">noldbuckets</span><span class="p">()</span> <span class="c1">// æ—§æ¡¶æ•°é‡ï¼Œç­‰é‡æ‰©å®¹å°±æ˜¯ 1&lt;&lt;h.Bï¼Œç¿»å€æ‰©å®¹ä¸º 1&lt;&lt;(h.B-1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2) å½“å‰æ¡¶æ²¡æœ‰è¢«è¿ç§»ï¼Œtophash[0] not in (2,3,4)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nf">evacuated</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO: reuse overflow buckets instead of using new ones, if there
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// is no iterator using the old buckets.  (If !oldIterator.)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// TODO: å¦‚æœæ²¡æœ‰è¿­ä»£å™¨ä½¿ç”¨æ—§çš„æ¡¶ï¼Œåˆ™é‡ç”¨æº¢å‡ºçš„æ¡¶ï¼Œè€Œä¸æ˜¯ä½¿ç”¨æ–°çš„æ¡¶ã€‚(If !oldIterator)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">// xy contains the x and y (low and high) evacuation destinations.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// xyåŒ…å«xå’Œy(low and high)ç–æ•£ç›®çš„åœ°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 2.1) è®°å½•è¿ç§»åæ¡¶çš„å»å‘ï¼Œxä¸æ—§æ¡¶ï¼Œyåˆ™æ˜¯æ–°æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">var</span> <span class="nx">xy</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="nx">evacDst</span>	
</span></span><span class="line"><span class="cl">        <span class="nx">x</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">// æµå‘æ—§æ¡¶æ—¶çš„æ¡¶ä¿¡æ¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">x</span><span class="p">.</span><span class="nx">b</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="nx">oldbucket</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">x</span><span class="p">.</span><span class="nx">k</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">x</span><span class="p">.</span><span class="nx">e</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">k</span><span class="p">,</span> <span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2.2) ç¿»å€æ‰©å®¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nx">h</span><span class="p">.</span><span class="nf">sameSizeGrow</span><span class="p">()</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">            <span class="c1">// Only calculate y pointers if we&#39;re growing bigger.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Otherwise GC can see bad pointers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// åªæœ‰å½“yæŒ‡é’ˆç¿»å€æ‰©å®¹æ—¶æ‰è®¡ç®—ã€‚å¦åˆ™GCä¼šçœ‹åˆ°åæŒ‡é’ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">y</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1">// æµå‘æ–°æ¡¶æ—¶çš„æ¡¶ä¿¡æ¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">y</span><span class="p">.</span><span class="nx">b</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="p">(</span><span class="nx">oldbucket</span><span class="o">+</span><span class="nx">newbit</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="nx">y</span><span class="p">.</span><span class="nx">k</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">y</span><span class="p">.</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">y</span><span class="p">.</span><span class="nx">e</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">y</span><span class="p">.</span><span class="nx">k</span><span class="p">,</span> <span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 2.3) éå†ã€å¸¸è§„æ¡¶ã€‘å’Œåé¢çš„ã€æº¢å‡ºæ¡¶ã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">;</span> <span class="nx">b</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">k</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="p">)</span> <span class="c1">// keyå¼€å§‹é¦–åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">e</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span> <span class="c1">// elemå¼€å§‹é¦–åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 2.4) éå†å½“å‰æ¡¶ iã€kã€e åˆ†åˆ«å¯¹åº”å½“å‰æ¡¶ indexã€keyã€elem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// const bucketCnt = 8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">bucketCnt</span><span class="p">;</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">e</span> <span class="p">=</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nf">add</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">)),</span> <span class="nf">add</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elemsize</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">top</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// 2.4.1) å½“å‰iå¤„ä¸ºç©ºï¼Œtop &lt;= 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nf">isEmpty</span><span class="p">(</span><span class="nx">top</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">                    <span class="c1">// const evacuatedEmpty = 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// 0æˆ–1 æ ‡è®°ä¸º 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">evacuatedEmpty</span>	
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// const minTopHash = 5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">top</span> <span class="p">&lt;</span> <span class="nx">minTopHash</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad map state&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">                <span class="c1">// 2.4.2) æœ‰æ•°æ®éœ€è¦è¿ç§»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">k2</span> <span class="o">:=</span> <span class="nx">k</span>	<span class="c1">// kæ˜¯å½“å‰éå†æ¡¶&amp;key	unsafe.Pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectkey</span><span class="p">()</span> <span class="p">{</span>    <span class="c1">// é—´æ¥å­˜å‚¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nx">k2</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">k2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ç”±äºè®°å½•æ¡¶çš„æµå‘ 0.æ—§æ¡¶ 1.æ–°æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="kd">var</span> <span class="nx">useY</span> <span class="kt">uint8</span>	
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">!</span><span class="nx">h</span><span class="p">.</span><span class="nf">sameSizeGrow</span><span class="p">()</span> <span class="p">{</span>  <span class="c1">// ç¿»å€æ‰©å®¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// Compute hash to make our evacuation decision (whether we need
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// to send this key/elem to bucket x or bucket y).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// è®¡ç®—å“ˆå¸Œå€¼ä»¥åšå‡ºç–æ•£å†³ç­–(æˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªé”®/elemå‘é€åˆ°æ¡¶xè¿˜æ˜¯æ¡¶y)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nx">hash</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">hasher</span><span class="p">(</span><span class="nx">k2</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// !t.reflexivekey() == true è¯´æ˜ k2 != k2 æˆç«‹ï¼Œæ¯”å¦‚ NaN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// h.flags&amp;iterator != 0 è¿­ä»£å™¨åœ¨æ‰©å®¹å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">iterator</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">t</span><span class="p">.</span><span class="nf">reflexivekey</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nf">equal</span><span class="p">(</span><span class="nx">k2</span><span class="p">,</span> <span class="nx">k2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// If key != key (NaNs), then the hash could be (and probably
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// will be) entirely different from the old hash. Moreover,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// it isn&#39;t reproducible. Reproducibility is required in the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// presence of iterators, as our evacuation decision must
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// match whatever decision the iterator made.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// Fortunately, we have the freedom to send these keys either
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// way. Also, tophash is meaningless for these kinds of keys.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// We let the low bit of tophash drive the evacuation decision.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// We recompute a new random tophash for the next level so
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// these keys will get evenly distributed across all buckets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// after multiple grows.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// å¦‚æœ key != key (NaNs)ï¼Œé‚£ä¹ˆè¿™ä¸ªhashå€¼å¯èƒ½(ä¹Ÿå¯èƒ½ä¼š)ä¸æ—§çš„hashå€¼å®Œå…¨ä¸åŒã€‚æ­¤å¤–ï¼Œå®ƒæ˜¯ä¸å¯å¤åˆ¶çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// åœ¨è¿­ä»£å™¨å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œéœ€è¦é‡ç°æ€§ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç–æ•£å†³ç­–å¿…é¡»åŒ¹é…è¿­ä»£å™¨æ‰€åšçš„ä»»ä½•å†³ç­–ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªç”±åœ°ä»¥ä»»ä½•æ–¹å¼å‘é€è¿™äº›keysã€‚è€Œä¸”ï¼Œtophashå¯¹äºè¿™ç§ç±»å‹çš„é”®æ²¡æœ‰æ„ä¹‰ã€‚(å› ä¸ºæ— æ³•å–å‡ºæ¥)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// æˆ‘ä»¬è®©ä½bitä½çš„tophashæ¥å†³å®šç–æ•£ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// æˆ‘ä»¬ä¸ºä¸‹ä¸€å±‚é‡æ–°è®¡ç®—ä¸€ä¸ªæ–°çš„éšæœºtophashå€¼ï¼Œè¿™æ ·è¿™äº›é”®åœ¨å¢é•¿å¤šæ¬¡åå°†å‡åŒ€åˆ†å¸ƒåˆ°æ‰€æœ‰æ¡¶ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="c1">// æ³¨æ„è¿™é‡Œçš„topæ˜¯æ—§æ¡¶çš„tophashåœ¨è®¡ç®—ç–æ•£æ–¹å‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nx">useY</span> <span class="p">=</span> <span class="nx">top</span> <span class="o">&amp;</span> <span class="mi">1</span>  <span class="c1">// topçš„æœ€ä½ä½ç”¨æ¥éšæœºè®¡ç®—ï¼Œä»¥ä¾¿å‡åŒ€çš„åˆ†å¸ƒè¿™äº›keyåˆ°å­˜å‚¨æ¡¶ä¸­å»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nx">top</span> <span class="p">=</span> <span class="nf">tophash</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span> <span class="c1">// ä»æ–°è®¡ç®—tophashï¼Œè¯¥topå­˜å‚¨åœ¨æ–°æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// æ²¡æœ‰è¿­ä»£å™¨åœ¨è¿è¡Œ æˆ– k == kæˆç«‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        
</span></span><span class="line"><span class="cl">                        <span class="c1">// æµå‘æ–°æ¡¶ï¼Œnewbitæ˜¯æ—§æ¡¶æ•°é‡ä¸º2çš„å¹‚æ¬¡æ–¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="k">if</span> <span class="nx">hash</span><span class="o">&amp;</span><span class="nx">newbit</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">                            <span class="nx">useY</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// const evacuatedX = 2 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// const evacuatedY = 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">evacuatedX</span><span class="o">+</span><span class="mi">1</span> <span class="o">!=</span> <span class="nx">evacuatedY</span> <span class="o">||</span> <span class="nx">evacuatedX</span><span class="p">^</span><span class="mi">1</span> <span class="o">!=</span> <span class="nx">evacuatedY</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad evacuatedN&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="c1">// tophash = 2 æˆ– 3ï¼Œæ•°æ®æµå‘; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// æ³¨æ„ä¸Šé¢çš„ useY = top &amp; 1; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// å³ä½¿è¿™é‡Œä¿®æ”¹äº†æ—§æ¡¶çš„topHashä¹Ÿèƒ½çŸ¥é“ç–æ•£æ–¹å‘ï¼Œå› ä¸º2å’Œ3ä»£è¡¨ç–æ•£æ–¹å‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">evacuatedX</span> <span class="o">+</span> <span class="nx">useY</span> <span class="c1">// evacuatedX + 1 == evacuatedY
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// dstç›®æ ‡æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">dst</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">xy</span><span class="p">[</span><span class="nx">useY</span><span class="p">]</span> <span class="c1">// evacuation destination
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">                <span class="c1">// å½“å‰æ¡¶å·²ç»å­˜æ»¡äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// const bucketCnt = 8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">i</span> <span class="o">==</span> <span class="nx">bucketCnt</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">dst</span><span class="p">.</span><span class="nx">b</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nf">newoverflow</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span>	<span class="c1">// å…³è”æ¡¶å¹¶åˆ†é…æ–°çš„æº¢å‡ºæ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nx">dst</span><span class="p">.</span><span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">dst</span><span class="p">.</span><span class="nx">k</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">dst</span><span class="p">.</span><span class="nx">e</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">k</span><span class="p">,</span> <span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// tophash è¿ç§»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">dst</span><span class="p">.</span><span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">dst</span><span class="p">.</span><span class="nx">i</span><span class="o">&amp;</span><span class="p">(</span><span class="nx">bucketCnt</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="p">=</span> <span class="nx">top</span> <span class="c1">// mask dst.i as an optimization, to avoid a bounds check
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectkey</span><span class="p">()</span> <span class="p">{</span>    <span class="c1">// é—´æ¥å­˜å‚¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">k</span><span class="p">)</span> <span class="p">=</span> <span class="nx">k2</span> <span class="c1">// copy pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">typedmemmove</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">k</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="c1">// copy elem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectelem</span><span class="p">()</span> <span class="p">{</span>   <span class="c1">// é—´æ¥å­˜å‚¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">e</span><span class="p">)</span> <span class="p">=</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">typedmemmove</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">e</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="nx">dst</span><span class="p">.</span><span class="nx">i</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// These updates might push these pointers past the end of the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// key or elem arrays.  That&#39;s ok, as we have the overflow pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// at the end of the bucket to protect against pointing past the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// end of the bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">dst</span><span class="p">.</span><span class="nx">k</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">k</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="nx">dst</span><span class="p">.</span><span class="nx">e</span> <span class="p">=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">e</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elemsize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Unlink the overflow buckets &amp; clear key/elem to help GC.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å½“å‰æ¡¶åŠæº¢å‡ºæ¡¶éƒ½è¢«ç–æ•£å®Œæˆåï¼›æ–­å¼€æº¢å‡ºæ¡¶ å¹¶ æ¸…é™¤key/elemä»¥å¸®åŠ©GC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// h.flags&amp;oldIterator == 0ï¼šéå†å™¨æ²¡æœ‰åœ¨éå†æ—§æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// t.bucket.ptrdata != 0ï¼šæ¡¶ç±»å‹ä¸­å­˜åœ¨æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯ key/elem ç±»å‹ä¸­å­˜åœ¨æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">oldIterator</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">ptrdata</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å½“å‰æ¸…é™¤æ—§æ¡¶æ‰€åœ¨æ¡¶åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">b</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">oldbuckets</span><span class="p">,</span> <span class="nx">oldbucket</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Preserve b.tophash because the evacuation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// state is maintained there.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ä¿ç•™b.tophashï¼Œå› ä¸ºç–æ•£çŠ¶æ€åœ¨é‚£é‡Œä¿æŒã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">ptr</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">dataOffset</span><span class="p">)</span> <span class="c1">// keyå¼€å§‹åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">n</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)</span> <span class="o">-</span> <span class="nx">dataOffset</span> <span class="c1">// éœ€è¦æ¸…é™¤çš„å­—èŠ‚é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æ¸…é™¤keysã€elemsã€overflowå¸®åŠ©GC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">memclrHasPointers</span><span class="p">(</span><span class="nx">ptr</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// growWorkæ–¹æ³•åœ¨è¿ç§»äº†æœ¬æ¬¡æ¡¶åä¼šå†è¿ç§»ä¸€æ¬¡h.nevacuateï¼Œå› æ­¤è¿™é‡Œå¾—åˆ°æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">oldbucket</span> <span class="o">==</span> <span class="nx">h</span><span class="p">.</span><span class="nx">nevacuate</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">advanceEvacuationMark</span><span class="p">(</span><span class="nx">h</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">newbit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="evacuated-2">evacuated()<a hidden class="anchor" aria-hidden="true" href="#evacuated-2">#</a></h4>
<ol>
<li>åˆ¤æ–­å½“å‰æ¡¶æ˜¯å¦å·²è¢«è¿ç§»ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">evacuated</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">bmap</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">h</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// const emptyOne = 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// const minTopHash = 5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// b.tophash[0] IN (2,3,4)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">h</span> <span class="p">&gt;</span> <span class="nx">emptyOne</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="p">&lt;</span> <span class="nx">minTopHash</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="type-evacdst-struct">type evacDst struct<a hidden class="anchor" aria-hidden="true" href="#type-evacdst-struct">#</a></h4>
<ol>
<li>evacDst æ˜¯æ¡¶æ•°æ®è¿ç§»æµè½¬çš„ä¸€ä¸ªå­˜å‚¨å™¨ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// evacDst is an evacuation destination.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">evacDst</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å½“å‰æµè½¬çš„ç›®åœ°æ¡¶ *bmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä¹Ÿå°±æ˜¯è¿ç§»åçš„æ–°æ¡¶çš„æ¡¶åœ°å€ï¼Œæ¯”å¦‚ä»Aæ¡¶è¿ç§»åˆ°Bæ¡¶ï¼Œè¿™é‡Œå°±æ˜¯Bæ¡¶çš„æ¡¶åœ°å€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">b</span> <span class="o">*</span><span class="nx">bmap</span>          <span class="c1">// current destination bucket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// key/elem ç´¢å¼•åˆ°b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¯¥å€¼é»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºç¬¬ä¸€ä¸ªç´¢å¼•ä¸‹æ ‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">i</span> <span class="kt">int</span>            <span class="c1">// key/elem index into b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æŒ‡å‘å½“å‰keyå­˜å‚¨çš„æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¯¥å€¼é»˜è®¤æŒ‡å‘ç¬¬ä¸€ä¸ªkeyçš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">k</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// pointer to current key storage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æŒ‡å‘å½“å‰elemå­˜å‚¨çš„æŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¯¥å€¼é»˜è®¤æŒ‡å‘ç¬¬ä¸€ä¸ªelemçš„åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">e</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// pointer to current elem storage
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="isempty-1">isEmpty()<a hidden class="anchor" aria-hidden="true" href="#isempty-1">#</a></h4>
<ol>
<li>åˆ¤æ–­å½“å‰ slot å¤„æ˜¯å¦ä¸ºç©ºã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// isEmpty reports whether the given tophash array entry represents an empty bucket entry.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">isEmpty</span><span class="p">(</span><span class="nx">x</span> <span class="kt">uint8</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// const emptyOne = 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">x</span> <span class="o">&lt;=</span> <span class="nx">emptyOne</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="advanceevacuationmark">advanceEvacuationMark()<a hidden class="anchor" aria-hidden="true" href="#advanceevacuationmark">#</a></h4>
<ol>
<li><code>h.nevacuate</code> æ¡¶å·å¾—åˆ°è¿ç§»åç›¸å…³åˆ¤æ–­è¿ç§»å®Œæ¯•ä»£ç ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>h *hmap</code>ï¼šmap çš„å†…å­˜ç»“æ„ã€‚</li>
<li><code>t *maptype</code>ï¼šmap çš„ç±»å‹ç»“æ„ã€‚</li>
<li><code>newbit uintptr</code>ï¼šæ‰©å®¹åçš„æ€»æ•°é‡ï¼Œç¿»å€æ‰©å®¹æ˜¯ä¹‹å‰å®¹é‡çš„ä¸¤å€ï¼Œç­‰é‡æ‰©å®¹å°±æ˜¯ä¹‹å‰çš„å®¹é‡ã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">advanceEvacuationMark</span><span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">newbit</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">    <span class="nx">h</span><span class="p">.</span><span class="nx">nevacuate</span><span class="o">++</span>   <span class="c1">// ä¸‹ä¸€ä¸ªéœ€è¦è¿ç§»çš„æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Experiments suggest that 1024 is overkill by at least an order of magnitude.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Put it in there as a safeguard anyway, to ensure O(1) behavior.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å®éªŒè¡¨æ˜ï¼Œ1024æ˜¯å¤šä½™çš„ï¼Œè‡³å°‘æ˜¯ä¸€ä¸ªæ•°é‡çº§ã€‚æŠŠå®ƒæ”¾åœ¨é‚£é‡Œä½œä¸ºä¸€ç§ä¿æŠ¤æªæ–½ï¼Œä»¥ç¡®ä¿O(1)è¡Œä¸ºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">stop</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">nevacuate</span> <span class="o">+</span> <span class="mi">1024</span>  <span class="c1">// stopæ˜¯ä¸€ä¸ªå¾ªç¯æ¬¡æ•°æœ€å¤§1024æ¬¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// newbit æœªæ‰©å®¹å‰æ¡¶æ•°é‡ï¼Œstop &gt; newbit å‰©ä½™æ‰©å®¹æ•°é‡åœ¨[0,1024]é—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">stop</span> <span class="p">&gt;</span> <span class="nx">newbit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">stop</span> <span class="p">=</span> <span class="nx">newbit</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¾ªç¯ä¸€å®šçš„æ¬¡æ•°ï¼Œåˆ¤æ–­åé¢çš„æ¡¶æ˜¯å¦å·²ç»è¿ç§»äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">h</span><span class="p">.</span><span class="nx">nevacuate</span> <span class="o">!=</span> <span class="nx">stop</span> <span class="o">&amp;&amp;</span> <span class="nf">bucketEvacuated</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">nevacuate</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">h</span><span class="p">.</span><span class="nx">nevacuate</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ¡¶å·²ç»è¿ç§»å®Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">nevacuate</span> <span class="o">==</span> <span class="nx">newbit</span> <span class="p">{</span> <span class="c1">// newbit == # of oldbuckets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Growing is all done. Free old main bucket array.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">h</span><span class="p">.</span><span class="nx">oldbuckets</span> <span class="p">=</span> <span class="kc">nil</span>  <span class="c1">// é‡Šæ”¾oldbuckets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Can discard old overflow buckets as well.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// If they are still referenced by an iterator,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// then the iterator holds a pointers to the slice.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å¯ä»¥ä¸¢å¼ƒæ—§çš„æº¢å‡ºæ¡¶ã€‚å¦‚æœå®ƒä»¬ä»ç„¶è¢«è¿­ä»£å™¨å¼•ç”¨ï¼Œåˆ™è¿­ä»£å™¨ä¿å­˜ä¸€ä¸ªæŒ‡å‘ç‰‡çš„æŒ‡é’ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">oldoverflow</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span> <span class="o">&amp;^=</span> <span class="nx">sameSizeGrow</span>    <span class="c1">// æ¸…é™¤sameSizeGrowæ ‡å¿—ä½ï¼Œå¦‚æœè®¾ç½®äº†çš„è¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="bucketevacuated">bucketEvacuated()<a hidden class="anchor" aria-hidden="true" href="#bucketevacuated">#</a></h4>
<ol>
<li>åˆ¤æ–­ bucket æ¡¶æ˜¯å¦å·²ç»è¿ç§»äº†ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">bucketEvacuated</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">bucket</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">oldbuckets</span><span class="p">,</span> <span class="nx">bucket</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">evacuated</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="åˆ é™¤-">åˆ é™¤ ğŸš€<a hidden class="anchor" aria-hidden="true" href="#åˆ é™¤-">#</a></h2>
<h3 id="delete">delete()<a hidden class="anchor" aria-hidden="true" href="#delete">#</a></h3>
<ol>
<li>å†…ç½®å‡½æ•°<code>delete()</code>å°†æŒ‡å®šé”®å€¼(<code>m[key]</code>)çš„å…ƒç´ ä»<code>map</code>ä¸­åˆ é™¤ã€‚</li>
<li>å¦‚æœ<code>m</code>ä¸º<code>nil</code>æˆ–ä¸å­˜åœ¨è¿™æ ·çš„å…ƒç´ ï¼Œåˆ™<code>delete()</code>ä¸ºç©ºæ“ä½œã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// The delete built-in function deletes the element with the specified key
</span></span></span><span class="line"><span class="cl"><span class="c1">// (m[key]) from the map. If m is nil or there is no such element, delete
</span></span></span><span class="line"><span class="cl"><span class="c1">// is a no-op.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nb">delete</span><span class="p">(</span><span class="nx">m</span> <span class="kd">map</span><span class="p">[</span><span class="nx">Type</span><span class="p">]</span><span class="nx">Type1</span><span class="p">,</span> <span class="nx">key</span> <span class="nx">Type</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="mapdelete">mapdelete()<a hidden class="anchor" aria-hidden="true" href="#mapdelete">#</a></h3>
<ol>
<li><code>delete</code>åˆ é™¤<code>map</code>ã€‚</li>
<li>å¦‚æœåˆ é™¤çš„æ˜¯ä¸­é—´æ•°æ®ç›´æ¥æ ‡è®°å¹¶æ¸…é™¤<code>key</code>å’Œ<code>elem</code>å³å¯ã€‚</li>
<li>å¦‚æœåˆ é™¤çš„æ˜¯æœ€åä¸€ä¸ªåˆ™éœ€è¦å‘å‰åˆ¤æ–­å‰é¢æ˜¯å¦å·²è¢«åˆ é™¤ä¾æ¬¡æ ‡è®°<code>tophash</code>ä¸º0ã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>t *maptype</code>ï¼šmapç±»å‹ç»“æ„ã€‚</li>
<li><code>h *hmap</code>ï¼šmapå†…å­˜ç»“æ„ã€‚</li>
<li><code>key unsafe.Pointer</code>ï¼šéœ€è¦åˆ é™¤çš„<code>key</code>åœ°å€ã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mapdelete</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">key</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">callerpc</span> <span class="o">:=</span> <span class="nf">getcallerpc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pc</span> <span class="o">:=</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABIInternal</span><span class="p">(</span><span class="nx">mapdelete</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">racewritepc</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">h</span><span class="p">),</span> <span class="nx">callerpc</span><span class="p">,</span> <span class="nx">pc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">raceReadObjectPC</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">callerpc</span><span class="p">,</span> <span class="nx">pc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">msanenabled</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">msanread</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">asanenabled</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">asanread</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) æœªåˆå§‹çš„map æˆ– mapæ²¡æœ‰key/elemå¯¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">h</span><span class="p">.</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å½“keyä¸ºanyç±»å‹æ—¶ï¼Œåœ¨keyç»è¿‡hashæ—¶å¯èƒ½ä¼šå‘ç”Ÿpanic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// t.hashMightPanic()åˆ¤æ–­å½“å‰hashå‡½æ•°æ˜¯å¦å¯èƒ½å‘ç”Ÿpanic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">hashMightPanic</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å°è¯•hash panic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">t</span><span class="p">.</span><span class="nf">hasher</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// see issue 23734
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 2) å½“å‰mapæ­£åœ¨å¹¶å‘å†™æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">hashWriting</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fatal</span><span class="p">(</span><span class="s">&#34;concurrent map writes&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 3) keyæ ¹æ®h.hash0ç”Ÿæˆhashå€¼ï¼Œæ ¹æ®ä¸Šé¢keyä¸ºanyæ—¶è¿™é‡Œhashå¯èƒ½ä¼španic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">hash</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">hasher</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Set hashWriting after calling t.hasher, since t.hasher may panic,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// in which case we have not actually done a write (delete).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨è°ƒç”¨t.hasherä¹‹åè®¾ç½®hashWritingï¼Œå› ä¸ºt.hasherå¯èƒ½ä¼šå‘ç”Ÿé”™è¯¯ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// åœ¨è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å®é™…ä¸Šå¹¶æ²¡æœ‰æ‰§è¡Œå†™å…¥(delete)æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span> <span class="p">^=</span> <span class="nx">hashWriting</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">bucket</span> <span class="o">:=</span> <span class="nx">hash</span> <span class="o">&amp;</span> <span class="nf">bucketMask</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span>    <span class="c1">// å½“å‰keyå¯¹åº”æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 4) æ­£åœ¨æ‰©å®¹è¿›è¡Œä¸­ï¼Œå»è¿ç§»è¯¥æ¡¶çš„æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nf">growing</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">growWork</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">bucket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="nx">bucket</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>  <span class="c1">// *bmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bOrig</span> <span class="o">:=</span> <span class="nx">b</span>	<span class="c1">// å½“å‰å˜é‡å¼€å§‹æ¡¶ï¼Œç”¨äºå‘å‰éå†æ—¶åˆ¤æ–­ç»“æŸç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">top</span> <span class="o">:=</span> <span class="nf">tophash</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">search</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 5) å˜é‡å½“å‰å¸¸è§„æ¡¶ä»¥åŠåé¢æº¢å‡ºæ¡¶(å¦‚æœå­˜åœ¨)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">;</span> <span class="nx">b</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// éå†å½“å‰æ¡¶ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// const bucketCnt = 8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">bucketCnt</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// tophashæ¯”å¯¹å¤±è´¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">top</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// const emptyRest = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// åé¢slotéƒ½æ²¡æœ‰æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">emptyRest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span> <span class="nx">search</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// tophashæ¯”å¯¹æˆåŠŸ; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¯èƒ½æ˜¯ã€tophashå†²çªã€‘ æˆ– ã€åŒ¹é…åˆ°äº†keyã€‘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">k</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span> <span class="c1">// key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">k2</span> <span class="o">:=</span> <span class="nx">k</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectkey</span><span class="p">()</span> <span class="p">{</span>	<span class="c1">// é—´æ¥å­˜å‚¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">k2</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">k2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æ¯”å¯¹å¤±è´¥ tophashå†²çª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// NaN çš„ key æ— æ³•è¢«åˆ é™¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">!</span><span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nf">equal</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">k2</span><span class="p">)</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// key æ¯”å¯¹æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            
</span></span><span class="line"><span class="cl">            <span class="c1">// Only clear key if there are pointers in it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// åªæœ‰åœ¨ key ä¸­æœ‰æŒ‡é’ˆæ—¶æ‰æ¸…é™¤ keyã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectkey</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// é—´æ¥å­˜å‚¨æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">k</span><span class="p">)</span> <span class="p">=</span> <span class="kc">nil</span> <span class="c1">// æ¸…ç©ºkey
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">ptrdata</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// key ä¸­å­˜åœ¨æŒ‡é’ˆç±»å‹æ•°æ®æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">memclrHasPointers</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span> <span class="c1">// æ¸…ç©ºkey
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">e</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">)</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elemsize</span><span class="p">))</span> <span class="c1">// elem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectelem</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ç®€ä»‹å­˜å‚¨æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">e</span><span class="p">)</span> <span class="p">=</span> <span class="kc">nil</span> <span class="c1">// æ¸…ç©ºelem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">ptrdata</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// elem ä¸­å­˜åœ¨æŒ‡é’ˆç±»å‹æ•°æ®æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">memclrHasPointers</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span> <span class="c1">// æ¸…ç©ºelem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// elem ä¸­ä¸å­˜åœ¨æŒ‡é’ˆç±»å‹æ•°æ®æ—¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">memclrNoHeapPointers</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">elem</span><span class="p">.</span><span class="nx">size</span><span class="p">)</span> <span class="c1">// æ¸…ç©ºelem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// æ ‡è®° tophash ä½ä¸º 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">emptyOne</span> <span class="c1">// emptyOne == 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// If the bucket now ends in a bunch of emptyOne states,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// change those to emptyRest states.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// It would be nice to make this a separate function, but
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// for loops are not currently inlineable.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å½“å‰æ¡¶æœ€åä¸€ä¸ª key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="nx">bucketCnt</span><span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">).</span><span class="nx">tophash</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">emptyRest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// å­˜åœ¨æº¢å‡ºæ¡¶å¹¶ä¸”åé¢è¿˜æœ‰æ•°æ®ï¼Œå¤„ç†åç»­åç›´æ¥è¿”å›ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="c1">// å› ä¸ºåé¢æœ‰æ•°æ®ä¸éœ€è¦æ¸…æ¥šå·²è¢«åˆ é™¤çš„å…¶ä»–slotã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">goto</span> <span class="nx">notLast</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// åé¢ä¸€ä¸ªtophash != 0; åé¢è¿˜æœ‰æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// const emptyRest = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">emptyRest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">goto</span> <span class="nx">notLast</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c1">// åé¢æ²¡æœ‰æ•°æ®äº†ï¼Œéœ€è¦å‘å‰éå†å¤„ç†å·²ç»åˆ é™¤çš„slot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// const emptyRest = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// æ ‡è®°å½“å‰tophashä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">emptyRest</span>	
</span></span><span class="line"><span class="cl">                <span class="c1">// å½“å‰æ¡¶çš„ç¬¬ä¸€ä¸ªslot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="nx">b</span> <span class="o">==</span> <span class="nx">bOrig</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// å·²ç»åˆ°æœ€å‰çš„å¸¸è§„æ¡¶äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="k">break</span> <span class="c1">// beginning of initial bucket, we&#39;re done.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// Find previous bucket, continue at its last entry.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">b</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="nx">b</span> <span class="p">=</span> <span class="nx">bOrig</span><span class="p">;</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">c</span><span class="p">;</span> <span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">i</span> <span class="p">=</span> <span class="nx">bucketCnt</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// å‘å‰å›æº¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nx">i</span><span class="o">--</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// const emptyOne = 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// å› ä¸ºåˆ é™¤çš„ç©ºæ ¼å…¨éƒ¨æ ‡è®°ä¸ºäº†1ï¼Œå› æ­¤!=1è¯´æ˜å­˜åœ¨æ•°æ®äº†ç›´æ¥é€€å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">emptyOne</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">notLast</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// key/elemå¯¹æ•°é‡å‡ä¸€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">h</span><span class="p">.</span><span class="nx">count</span><span class="o">--</span>	
</span></span><span class="line"><span class="cl">            <span class="c1">// Reset the hash seed to make it more difficult for attackers to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// repeatedly trigger hash collisions. See issue 25237.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// é‡ç½®hashå€¼ï¼Œä½¿æ”»å‡»è€…æ›´éš¾è§¦å‘hashç¢°æ’ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span> <span class="p">=</span> <span class="nf">fastrand</span><span class="p">()</span>    <span class="c1">// é‡ç½®hash0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span> <span class="nx">search</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å¹¶å‘åˆ¤æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">hashWriting</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">        <span class="nf">fatal</span><span class="p">(</span><span class="s">&#34;concurrent map writes&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span> <span class="o">&amp;^=</span> <span class="nx">hashWriting</span> <span class="c1">// æ¸…é™¤hashWritingæ ‡å¿—ä½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="len-">len() ğŸš€<a hidden class="anchor" aria-hidden="true" href="#len-">#</a></h2>
<h3 id="reflect_maplen">reflect_maplen()<a hidden class="anchor" aria-hidden="true" href="#reflect_maplen">#</a></h3>
<ol>
<li>len() å‡½æ•°å®ç°ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:linkname reflect_maplen reflect.maplen
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">reflect_maplen</span><span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">h</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">callerpc</span> <span class="o">:=</span> <span class="nf">getcallerpc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nf">racereadpc</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">h</span><span class="p">),</span> <span class="nx">callerpc</span><span class="p">,</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABIInternal</span><span class="p">(</span><span class="nx">reflect_maplen</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ç›´æ¥å–å€¼ hmap.count
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">h</span><span class="p">.</span><span class="nx">count</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="è¿­ä»£å™¨-">è¿­ä»£å™¨ ğŸš€<a hidden class="anchor" aria-hidden="true" href="#è¿­ä»£å™¨-">#</a></h2>
<h3 id="type-hiter-struct">type hiter struct<a hidden class="anchor" aria-hidden="true" href="#type-hiter-struct">#</a></h3>
<ol>
<li>hash è¿­ä»£å™¨ã€‚</li>
<li>å¦‚æœä½ ä¿®æ”¹äº†hiterï¼Œä¹Ÿè¦ä¿®æ”¹ cmd/compile/internal/reflectdata/reflect.go å’Œ reflect/value.go æ¥åŒ¹é…è¿™ä¸ªç»“æ„çš„å¸ƒå±€ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// A hash iteration structure.
</span></span></span><span class="line"><span class="cl"><span class="c1">// If you modify hiter, also change cmd/compile/internal/reflectdata/reflect.go
</span></span></span><span class="line"><span class="cl"><span class="c1">// and reflect/value.go to match the layout of this structure.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">hiter</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¿…é¡»åœ¨ç¬¬ä¸€ä½ç½®ã€‚å†™å…¥nilæ¥è¡¨ç¤ºè¿­ä»£ç»“æŸ(å‚è§cmd/compile/internal/walk/range.go)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">key</span>         <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// Must be in first position.  Write nil to indicate iteration end (see cmd/compile/internal/walk/range.go).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¿…é¡»åœ¨ç¬¬äºŒä½ç½®(å‚è§cmd/compile/internal/walk/range.go)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">elem</span>        <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// Must be in second position (see cmd/compile/internal/walk/range.go).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// mapç±»å‹ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">t</span>           <span class="o">*</span><span class="nx">maptype</span>	
</span></span><span class="line"><span class="cl">    <span class="c1">// mapå†…å­˜ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">h</span>           <span class="o">*</span><span class="nx">hmap</span>	
</span></span><span class="line"><span class="cl">    <span class="c1">// å¸¸è§„æ¡¶åœ°å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">buckets</span>     <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// bucket ptr at hash_iter initialization time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// æ­£åœ¨è¿­ä»£çš„æ¡¶ï¼Œå¦‚æœbptr == nilåˆ™ä»bucketè·å–æ¡¶å·è¿­ä»£
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bptr</span>        <span class="o">*</span><span class="nx">bmap</span>          <span class="c1">// current bucket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">overflow</span>    <span class="o">*</span><span class="p">[]</span><span class="o">*</span><span class="nx">bmap</span>       <span class="c1">// keeps overflow buckets of hmap.buckets alive
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">oldoverflow</span> <span class="o">*</span><span class="p">[]</span><span class="o">*</span><span class="nx">bmap</span>       <span class="c1">// keeps overflow buckets of hmap.oldbuckets alive
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å¼€å§‹éå†çš„æ¡¶å·ï¼Œéšæœºçš„ï¼Œç”¨äºå¼€å§‹éå†çš„èµ·ç‚¹ä»¥åŠç»“æŸéå†çš„ç»ˆç‚¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">startBucket</span> <span class="kt">uintptr</span>        <span class="c1">// bucket iteration started at
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// tophashåç§»å€¼ï¼Œåœ¨[0,7]ä¸­éšæœºç”Ÿæˆçš„å€¼ï¼Œç”¨äºåç»­ i + offset &amp; 7 ç”¨ä½œåç§»é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">offset</span>      <span class="kt">uint8</span>          <span class="c1">// intra-bucket offset to start from during iteration (should be big enough to hold bucketCnt-1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰éå†å·²è¿‡æœ€å¤§æ¡¶(1 &lt;&lt; B)æ—¶è¢«è®¾ç½®ä¸ºtrue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">wrapped</span>     <span class="kt">bool</span>           <span class="c1">// already wrapped around from end of bucket array to beginning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">B</span>           <span class="kt">uint8</span>   <span class="c1">// åˆå§‹åŒ–æ—¶æ¡¶çš„æ•°é‡ 1 &lt;&lt; B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å½“å‰æ¡¶éå†çš„ç´¢å¼•ï¼Œé»˜è®¤å€¼ä»0å¼€å§‹ï¼Œè¯¥å€¼é…åˆoffsetéå†tophashï¼Œi + offset &amp; 7
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">i</span>           <span class="kt">uint8</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆå§‹åŒ–æ—¶æ˜¯startBucketçš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   1. bptr == nilæ—¶bucketå­˜å‚¨éœ€è¦éå†çš„æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   2. bptr != nilæ—¶bucketä¸‹ä¸ªæ¡¶çš„æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bucket</span>      <span class="kt">uintptr</span> <span class="c1">// ä¸‹ä¸ªè¿­ä»£å™¨è¿­ä»£çš„æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">checkBucket</span> <span class="kt">uintptr</span> <span class="c1">// éœ€è¦æ£€æŸ¥çš„æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="åˆå§‹åŒ–è¿­ä»£å™¨">åˆå§‹åŒ–è¿­ä»£å™¨<a hidden class="anchor" aria-hidden="true" href="#åˆå§‹åŒ–è¿­ä»£å™¨">#</a></h3>
<h4 id="mapiterinit">mapiterinit()<a hidden class="anchor" aria-hidden="true" href="#mapiterinit">#</a></h4>
<ol>
<li><code>mapiterinit()</code> åˆå§‹åŒ–ç”¨äºåœ¨ <code>map</code> ä¸Šè¿›è¡ŒèŒƒå›´æœç´¢çš„ <code>hiter</code> ç»“æ„ä½“ã€‚</li>
<li><code>'it'</code>æŒ‡å‘çš„<code>hiter</code>ç»“æ„ä½“ç”±ç¼–è¯‘å™¨<code>order pass</code>åˆ†é…åˆ°æ ˆä¸Šï¼Œæˆ–ç”±<code>reflect_mapiterinit</code>åˆ†é…åˆ°å †ä¸Šã€‚</li>
<li>ä¸¤è€…éƒ½éœ€è¦å°†<code>hiter</code>ç½®é›¶ï¼Œå› ä¸ºè¯¥ç»“æ„ä½“åŒ…å«æŒ‡é’ˆã€‚</li>
<li>å‚æ•°ï¼š
<ul>
<li><code>t *maptype</code>ï¼šmap ç±»å‹ç»“æ„ã€‚</li>
<li><code>h *hmap</code>ï¼šmap å†…å­˜ç»“æ„ã€‚</li>
<li><code>it *hiter</code>ï¼šéå†å™¨å­˜å‚¨çš„ç»“æ„ã€‚</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// mapiterinit initializes the hiter struct used for ranging over maps.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The hiter struct pointed to by &#39;it&#39; is allocated on the stack
</span></span></span><span class="line"><span class="cl"><span class="c1">// by the compilers order pass or on the heap by reflect_mapiterinit.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Both need to have zeroed hiter since the struct contains pointers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mapiterinit</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">it</span> <span class="o">*</span><span class="nx">hiter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">callerpc</span> <span class="o">:=</span> <span class="nf">getcallerpc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nf">racereadpc</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">h</span><span class="p">),</span> <span class="nx">callerpc</span><span class="p">,</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABIInternal</span><span class="p">(</span><span class="nx">mapiterinit</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">it</span><span class="p">.</span><span class="nx">t</span> <span class="p">=</span> <span class="nx">t</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 1) æœªåˆå§‹åŒ–çš„map æˆ– key/elemå¯¹ä¸ºç©ºçš„map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">h</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">h</span><span class="p">.</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">hiter</span><span class="p">{})</span><span class="o">/</span><span class="nx">goarch</span><span class="p">.</span><span class="nx">PtrSize</span> <span class="o">!=</span> <span class="mi">12</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;hash_iter size incorrect&#34;</span><span class="p">)</span> <span class="c1">// see cmd/compile/internal/reflectdata/reflect.go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">it</span><span class="p">.</span><span class="nx">h</span> <span class="p">=</span> <span class="nx">h</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// grab snapshot of bucket state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 2) æŠ“å–æ¡¶çŠ¶æ€å¿«ç…§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">it</span><span class="p">.</span><span class="nx">B</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span>
</span></span><span class="line"><span class="cl">    <span class="nx">it</span><span class="p">.</span><span class="nx">buckets</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">ptrdata</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Allocate the current slice and remember pointers to both current and old.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// This preserves all relevant overflow buckets alive even if
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// the table grows and/or overflow buckets are added to the table
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// while we are iterating.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// åˆ†é…å½“å‰åˆ‡ç‰‡å¹¶è®°ä½æŒ‡å‘å½“å‰å’Œæ—§åˆ‡ç‰‡çš„æŒ‡é’ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿™ä½¿å¾—æ‰€æœ‰ç›¸å…³çš„æº¢å‡ºæ¡¶éƒ½ä¿æŒæ´»è·ƒï¼Œå³ä½¿è¡¨å¢é•¿ï¼Œand/or åœ¨è¿­ä»£æ—¶æº¢å‡ºæ¡¶è¢«æ·»åŠ åˆ°è¡¨ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">h</span><span class="p">.</span><span class="nf">createOverflow</span><span class="p">()</span>	<span class="c1">// åˆ¤æ–­h.extraæ˜¯å¦åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">it</span><span class="p">.</span><span class="nx">overflow</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">overflow</span>
</span></span><span class="line"><span class="cl">        <span class="nx">it</span><span class="p">.</span><span class="nx">oldoverflow</span> <span class="p">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">extra</span><span class="p">.</span><span class="nx">oldoverflow</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// decide where to start
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 3) å†³å®šä»å“ªé‡Œå¼€å§‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">var</span> <span class="nx">r</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span> <span class="p">&gt;</span> <span class="mi">31</span><span class="o">-</span><span class="nx">bucketCntBits</span> <span class="p">{</span>	<span class="c1">// h.B &gt; 31 - 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">r</span> <span class="p">=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nf">fastrand64</span><span class="p">())</span>   <span class="c1">// uint64
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">r</span> <span class="p">=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nf">fastrand</span><span class="p">())</span> <span class="c1">// uint32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 4) ç”¨äºç¡®å®šä»é‚£ä¸ªæ¡¶å¼€å§‹éå†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">it</span><span class="p">.</span><span class="nx">startBucket</span> <span class="p">=</span> <span class="nx">r</span> <span class="o">&amp;</span> <span class="nf">bucketMask</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span>    <span class="c1">// éšæœºæ•°ç¡®å®šå¼€å§‹çš„æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 5) ç”¨äºç¡®å®šåœ¨æ¯ä¸ªæ¡¶çš„éšæœºåç§»é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">it</span><span class="p">.</span><span class="nx">offset</span> <span class="p">=</span> <span class="nb">uint8</span><span class="p">(</span><span class="nx">r</span> <span class="o">&gt;&gt;</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nx">bucketCnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>   <span class="c1">// éšæœºçš„åç§»é‡[0,7]ä¸­éšæœºæ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// iterator state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">it</span><span class="p">.</span><span class="nx">bucket</span> <span class="p">=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">startBucket</span>	<span class="c1">// å½“å‰è¿­ä»£æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Remember we have an iterator.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Can run concurrently with another mapiterinit().
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 6) è®°ä½æˆ‘ä»¬æœ‰ä¸€ä¸ªè¿­ä»£å™¨ã€‚å¯ä»¥ä¸å¦ä¸€ä¸ªmapiterinit()å¹¶å‘è¿è¡Œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">old</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="p">;</span> <span class="nx">old</span><span class="o">&amp;</span><span class="p">(</span><span class="nx">iterator</span><span class="p">|</span><span class="nx">oldIterator</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">iterator</span><span class="p">|</span><span class="nx">oldIterator</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">atomic</span><span class="p">.</span><span class="nf">Or8</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">|</span><span class="nx">oldIterator</span><span class="p">)</span>  <span class="c1">// è®¾ç½®è¿­ä»£æ ‡å¿— iteratorå’ŒoldIterator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">mapiternext</span><span class="p">(</span><span class="nx">it</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="è¿­ä»£">è¿­ä»£<a hidden class="anchor" aria-hidden="true" href="#è¿­ä»£">#</a></h3>
<h4 id="mapiternext">mapiternext()<a hidden class="anchor" aria-hidden="true" href="#mapiternext">#</a></h4>
<ol>
<li>æ‰©å®¹å‘ç”Ÿåœ¨è¿­ä»£å™¨ä¹‹å‰ï¼Œæ­¤æ—¶åº”è¯¥å»å˜é‡æ‰©å®¹åçš„æ‰€æœ‰æ¡¶ï¼Œéƒ½æ˜¯ä»æ—§æ¡¶å‡ºå‘ã€‚è¿™ç§æƒ…å†µæ—§æ¡¶é‡Œé¢å¯èƒ½æ²¡key/elemä»¥åŠoverflowä¿¡æ¯ã€‚</li>
<li>æ‰©å®¹å‘ç”Ÿåœ¨è¿­ä»£å™¨ä¹‹åï¼Œæ­¤æ—¶åº”è¯¥éå†æ‰€æœ‰çš„æ—§æ¡¶æ•°é‡ï¼Œä»æ—§æ¡¶å‡ºå‘ã€‚è¿™ç§æƒ…å†µæ—§æ¡¶ä¿ç•™äº†æ‰€æœ‰çš„key/elemä»¥åŠoverflowä¿¡æ¯ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mapiternext</span><span class="p">(</span><span class="nx">it</span> <span class="o">*</span><span class="nx">hiter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">h</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">h</span>	<span class="c1">// *hmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">callerpc</span> <span class="o">:=</span> <span class="nf">getcallerpc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nf">racereadpc</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">h</span><span class="p">),</span> <span class="nx">callerpc</span><span class="p">,</span> <span class="nx">abi</span><span class="p">.</span><span class="nf">FuncPCABIInternal</span><span class="p">(</span><span class="nx">mapiternext</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nx">flags</span><span class="o">&amp;</span><span class="nx">hashWriting</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fatal</span><span class="p">(</span><span class="s">&#34;concurrent map iteration and map write&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">t</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">t</span>   <span class="c1">// *maptype
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">bucket</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">bucket</span>	<span class="c1">// éœ€è¦è¿­ä»£æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">b</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">bptr</span>    <span class="c1">// å½“å‰æ­£åœ¨è¿­ä»£çš„æ¡¶ *bmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">i</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">i</span>   <span class="c1">// å½“å‰éå†bptræ¡¶çš„ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">checkBucket</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">checkBucket</span>   <span class="c1">// éœ€è¦æ£€æŸ¥çš„æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nx">next</span><span class="p">:</span>	
</span></span><span class="line"><span class="cl">    <span class="c1">// æ ¹æ®bucketè·å–*bmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">b</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">        <span class="c1">// mapéå†å®Œäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">bucket</span> <span class="o">==</span> <span class="nx">it</span><span class="p">.</span><span class="nx">startBucket</span> <span class="o">&amp;&amp;</span> <span class="nx">it</span><span class="p">.</span><span class="nx">wrapped</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// end of iteration
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ç»“æŸè¿­ä»£å™¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">it</span><span class="p">.</span><span class="nx">key</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">            <span class="nx">it</span><span class="p">.</span><span class="nx">elem</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// h.growing()ï¼šæ­£åœ¨æ‰©å®¹ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// it.B == h.Bï¼šæ‰©å®¹å‘ç”Ÿåœ¨è¿­ä»£å™¨ä¹‹å‰ï¼Œè¿­ä»£å™¨å¼€å§‹æ—¶å·²ç»åœ¨è¿›è¡Œæ‰©å®¹äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  1. è¿™ç§æƒ…å†µå¯èƒ½å‘ç”Ÿéƒ¨åˆ†æ•°æ®è¿˜åœ¨æ—§æ¡¶é‡Œé¢ï¼Œä¹Ÿå¯èƒ½åœ¨æ–°æ¡¶é‡Œé¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 	2. éšç€æ‰©å®¹åœ¨è¿›è¡Œä¸­ï¼Œå¯èƒ½å‡ºç°éƒ¨åˆ†æ•°æ®åœ¨æ—§æ¡¶éƒ¨åˆ†æ•°æ®åœ¨æ–°æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nf">growing</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">it</span><span class="p">.</span><span class="nx">B</span> <span class="o">==</span> <span class="nx">h</span><span class="p">.</span><span class="nx">B</span> <span class="p">{</span>	<span class="c1">// æ•°æ®å¯èƒ½åœ¨æ—§æ¡¶é‡Œé¢ï¼Œå¯èƒ½åœ¨æ–°æ¡¶é‡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Iterator was started in the middle of a grow, and the grow isn&#39;t done yet.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// If the bucket we&#39;re looking at hasn&#39;t been filled in yet (i.e. the old
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// bucket hasn&#39;t been evacuated) then we need to iterate through the old
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// bucket and only return the ones that will be migrated to this bucket.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿­ä»£å™¨æ˜¯åœ¨æ‰©å®¹è¿‡ç¨‹è¿›è¡Œä¸­å¯åŠ¨çš„ï¼Œè€Œä¸”æ‰©å®¹è¿˜æ²¡æœ‰å®Œæˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å¦‚æœæˆ‘ä»¬æŸ¥çœ‹çš„æ¡¶è¿˜æ²¡æœ‰è¢«å¡«å……ï¼ˆå³æ—§æ¡¶è¿˜æ²¡æœ‰è¢«æ¸…ç©ºï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦è¿­ä»£æ—§æ¡¶ï¼Œå¹¶åªè¿”å›å°†è¦è¿ç§»åˆ°æ­¤æ¡¶çš„é‚£äº›ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">oldbucket</span> <span class="o">:=</span> <span class="nx">bucket</span> <span class="o">&amp;</span> <span class="nx">it</span><span class="p">.</span><span class="nx">h</span><span class="p">.</span><span class="nf">oldbucketmask</span><span class="p">()</span>  <span class="c1">// æ—§æ¡¶ç¼–å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">b</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">oldbuckets</span><span class="p">,</span> <span class="nx">oldbucket</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>	<span class="c1">// æ—§æ¡¶ *bmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// å…¶å®è¿™ç§æƒ…å†µä¸€ç›´æ˜¯åœ¨æ£€æŸ¥æ—§æ¡¶ï¼Œæ—§æ¡¶æ•°æ®æœ‰æ²¡è¢«è¿ç§»è¿ç§»åˆ°å“ªé‡Œäº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">!</span><span class="nf">evacuated</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// æ—§æ¡¶æœ‰æ•°æ®ï¼Œå¯èƒ½ä¸‹é¢æ•°æ®è¢«è¿ç§»åˆ°æ–°æ¡¶äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// éœ€è¦æ£€æŸ¥æ–°æ¡¶çš„æ¡¶å¥½ï¼Œå› æ­¤æ–°æ¡¶æ—§æ¡¶éƒ½è¦æŸ¥çœ‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">checkBucket</span> <span class="p">=</span> <span class="nx">bucket</span>	
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// å¦‚æœæ—§æ¡¶æ²¡æœ‰æ•°æ®åˆ™è¯´æ˜æ•°æ®ä¸€å®šåœ¨æ–°æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">b</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="nx">bucket</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>  <span class="c1">// æ–°æ¡¶ *bmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// å› æ­¤ä¸éœ€è¦å†æ£€æŸ¥å…¶ä»–çš„æ¡¶äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">checkBucket</span> <span class="p">=</span> <span class="nx">noCheck</span> 
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// !h.growing() || h.growing() &amp;&amp; it.B != h.B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  1. !h.growing(): (æ²¡æœ‰æ‰©å®¹)æ•°æ®åœ¨bæ¡¶é‡Œï¼Œéå†bæ¡¶å³å¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  2. h.growing() &amp;&amp; it.B != h.B; (æ‰©å®¹å‘ç”Ÿåœ¨è¿­ä»£ä¹‹å)å¯èƒ½bæ¡¶è¢«è¿ç§»äº†ä½†æ˜¯bæ¡¶ä»ç„¶ä¿æŒç€key/elem;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//  (2)è¿™ç§æƒ…å†µæˆ‘ä»¬ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥æ‹¿å»bæ¡¶çš„elemï¼Œå› ä¸ºå¯èƒ½keyåˆè¢«åˆ é™¤æˆ–æ›´æ–°äº†éœ€è¦æŸ¥çœ‹æ–°æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿™é‡Œå¯ä»¥çœ‹å‡ºè¿­ä»£æ•°æ®æ—¶æ˜¯æŒ‰ç…§ä¿å­˜å¿«ç…§çš„æ•°æ®ä¸ºå‡†çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">b</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="nx">bucket</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">            <span class="nx">checkBucket</span> <span class="p">=</span> <span class="nx">noCheck</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">bucket</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è¿­ä»£è¿‡äº†æœ€å¤§æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  1. æ‰©å®¹å‘ç”Ÿåœ¨è¿­ä»£ä¹‹å‰ï¼Œéœ€è¦éå†æ‰€æœ‰æ‰©å®¹åçš„æ¡¶æ•°é‡ï¼Œè¢«ç–æ•£çš„key/elemä¸ç®¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  2. æ‰©å®¹å‘ç”Ÿåœ¨è¿­ä»£ä¹‹åï¼Œåˆ™åªä¼šè¿­ä»£æ—§æ¡¶æ•°é‡ï¼Œè¢«ç–æ•£çš„key/elemå»æ–°æ¡¶é‡Œé¢æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">bucket</span> <span class="o">==</span> <span class="nf">bucketShift</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>    <span class="c1">// bucket == 1 &lt;&lt; B
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">bucket</span> <span class="p">=</span> <span class="mi">0</span>	<span class="c1">// æ¡¶å·é‡ç½®ä¸º0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">it</span><span class="p">.</span><span class="nx">wrapped</span> <span class="p">=</span> <span class="kc">true</span>   <span class="c1">// æ ‡è®°wrappedå·²è¿‡æœ€å¤§æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿­ä»£æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">bucketCnt</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">offi</span> <span class="o">:=</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">it</span><span class="p">.</span><span class="nx">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nx">bucketCnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// tophash[offi] &lt;= 1 || tophash[offi] == 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å½“å‰slotå¤„æ²¡æœ‰æ•°æ®ï¼Œå› ä¸ºä¸€ç›´éå†çš„æ˜¯æ—§æ¡¶bï¼Œå¦‚æœæ˜¯ä¸‹é¢è¿™ä¸¤ç§æ¡ä»¶ç›´æ¥è·³è¿‡å³å¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nf">isEmpty</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">offi</span><span class="p">])</span> <span class="o">||</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">offi</span><span class="p">]</span> <span class="o">==</span> <span class="nx">evacuatedEmpty</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// TODO: emptyRest is hard to use here, as we start iterating
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// in the middle of a bucket. It&#39;s feasible, just tricky.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">k</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">offi</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectkey</span><span class="p">()</span> <span class="p">{</span>    <span class="c1">// é—´æ¥å­˜å‚¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">k</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">k</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">e</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">)</span><span class="o">+</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">offi</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elemsize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ‰©å®¹å‘ç”Ÿåœ¨è¿­ä»£å™¨ä¹‹å‰; ç¿»å€æ‰©å®¹æ‰éœ€è¦æ£€æŸ¥æ—§æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// checkBucket != noCheckï¼šæœ‰éœ€è¦ç‰¹æ®Šæ£€æŸ¥çš„æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// !h.sameSizeGrow()ï¼šå½“å‰æ˜¯ç¿»å€æ‰©å®¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">checkBucket</span> <span class="o">!=</span> <span class="nx">noCheck</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">h</span><span class="p">.</span><span class="nf">sameSizeGrow</span><span class="p">()</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">            <span class="c1">// Special case: iterator was started during a grow to a larger size
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// and the grow is not done yet. We&#39;re working on a bucket whose
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// oldbucket has not been evacuated yet. Or at least, it wasn&#39;t
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// evacuated when we started the bucket. So we&#39;re iterating
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// through the oldbucket, skipping any keys that will go
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// to the other new bucket (each oldbucket expands to two
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// buckets during a grow).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// ç‰¹æ®Šæƒ…å†µ:è¿­ä»£å™¨åœ¨å¢é•¿åˆ°æ›´å¤§çš„å°ºå¯¸æœŸé—´å¯åŠ¨ï¼Œä½†å¢é•¿è¿˜æ²¡æœ‰å®Œæˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æˆ‘ä»¬æ­£åœ¨å¤„ç†ä¸€ä¸ªæ¡¶ï¼Œå®ƒçš„æ—§æ¡¶è¿˜æ²¡æœ‰è¢«æ¸…ç©ºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è‡³å°‘ï¼Œæˆ‘ä»¬å¯åŠ¨æ°´æ¡¶æ—¶è¿˜æ²¡äººæ’¤ç¦»ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éå†oldbucketï¼Œè·³è¿‡æ‰€æœ‰å°†è¿›å…¥å¦ä¸€ä¸ªæ–°æ¡¶çš„é”®(æ¯ä¸ªoldbucketåœ¨å¢é•¿è¿‡ç¨‹ä¸­ä¼šæ‰©å±•åˆ°ä¸¤ä¸ªæ¡¶)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// k == k æˆç«‹ï¼Œè¿™ç§è¯·æ¬¾å‡ºç°åœ¨ +0å’Œ-0è™½ç„¶ç›¸ç­‰ä½†æ˜¯ç”Ÿæˆçš„hashç¡®å®ä¸ç›¸åŒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">reflexivekey</span><span class="p">()</span> <span class="o">||</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nf">equal</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">                <span class="c1">// If the item in the oldbucket is not destined for
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// the current new bucket in the iteration, skip it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// å¦‚æœæ—§æ¡¶ä¸­çš„é¡¹åœ¨è¿­ä»£ä¸­ä¸æ˜¯ä¸ºå½“å‰çš„æ–°æ¡¶æŒ‡å®šçš„ï¼Œåˆ™è·³è¿‡å®ƒã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">hash</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">hasher</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// hash&amp;bucketMask(it.B) != checkBucket; è¡¨ç¤ºå½“å‰key/elemä¸åº”è¯¥åœ¨checkBucketæ¡¶ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// åˆ™è·³è¿‡åç»­åˆ°ï¼Œåç»­ä¼šå»æ‰¾è¿™ç§æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">hash</span><span class="o">&amp;</span><span class="nf">bucketMask</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">checkBucket</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Hash isn&#39;t repeatable if k != k (NaNs).  We need a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// repeatable and randomish choice of which direction
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// to send NaNs during evacuation. We&#39;ll use the low
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// bit of tophash to decide which way NaNs go.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// NOTE: this case is why we need two evacuate tophash
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// values, evacuatedX and evacuatedY, that differ in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// their low bit.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// å¦‚æœ k != k (NaNs)ï¼Œåˆ™ hash æ˜¯ä¸å¯é‡å¤çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// åœ¨ç–æ•£è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¯é‡å¤ä¸”éšæœºçš„é€‰æ‹©å°†NaNsæ´¾å¾€å“ªä¸ªæ–¹å‘ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// æˆ‘ä»¬å°†ä½¿ç”¨tophashçš„ä½ä½æ¥å†³å®šNaNsçš„æ–¹å‘ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// æ³¨æ„:åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¸¤ä¸ªç–æ•£tophashå€¼evacuatedXå’ŒevacuatedYï¼Œå®ƒä»¬çš„ä½ä½ä¸åŒã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">checkBucket</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="nx">it</span><span class="p">.</span><span class="nx">B</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">offi</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">continue</span>	<span class="c1">// ç–æ•£çš„ä¸æ˜¯å½“å‰æ¡¶åˆ™è·³è¿‡åç»­ä¼šå»æŸ¥æ‰¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// const evacuatedX = 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// const evacuatedY = 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// tophash[offi] != 2æˆ–3 || k != k
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// tophash[offi] != 2æˆ–3; å­˜åœ¨æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// k != kï¼šNaN æƒ…å†µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">offi</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">evacuatedX</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">offi</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">evacuatedY</span><span class="p">)</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="p">!(</span><span class="nx">t</span><span class="p">.</span><span class="nf">reflexivekey</span><span class="p">()</span> <span class="o">||</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nf">equal</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">k</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// This is the golden data, we can return it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// OR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// key!=key, so the entry can&#39;t be deleted or updated, so we can just return it.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// That&#39;s lucky for us because when key!=key we can&#39;t look it up successfully.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿™æ˜¯é»„é‡‘æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥è¿”å›å®ƒã€‚æˆ– key!=keyï¼Œå› æ­¤entryä¸èƒ½è¢«åˆ é™¤æˆ–æ›´æ–°ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥è¿”å›å®ƒã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿™å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯å¹¸è¿çš„ï¼Œå› ä¸ºå½“ key!=key æ— æ³•æˆåŠŸæŸ¥æ‰¾æ—¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">it</span><span class="p">.</span><span class="nx">key</span> <span class="p">=</span> <span class="nx">k</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectelem</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">e</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">it</span><span class="p">.</span><span class="nx">elem</span> <span class="p">=</span> <span class="nx">e</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">// tophash[offi] == 2æˆ–3ï¼›æ•°æ®è¢«è¿ç§»äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// The hash table has grown since the iterator was started.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// The golden data for this key is now somewhere else.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Check the current hash table for the data.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// This code handles the case where the key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// has been deleted, updated, or deleted and reinserted.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// NOTE: we need to regrab the key as it has potentially been
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// updated to an equal() but not identical key (e.g. +0.0 vs -0.0).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è‡ªè¿­ä»£å™¨å¯åŠ¨ä»¥æ¥ï¼Œæ•£åˆ—è¡¨ä¸€ç›´åœ¨å¢é•¿ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿™ä¸ªå¯†é’¥çš„é»„é‡‘æ•°æ®ç°åœ¨åœ¨å…¶ä»–åœ°æ–¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æ£€æŸ¥å½“å‰æ•£åˆ—è¡¨ä¸­çš„æ•°æ®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// è¿™æ®µä»£ç å¤„ç†é”®è¢«åˆ é™¤ã€æ›´æ–°æˆ–åˆ é™¤å¹¶é‡æ–°æ’å…¥çš„æƒ…å†µã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// æ³¨æ„:æˆ‘ä»¬éœ€è¦é‡æ–°è·å–å¯†é’¥ï¼Œå› ä¸ºå®ƒå¯èƒ½å·²ç»æ›´æ–°åˆ°equal()ï¼Œä½†keyä¸ç›¸åŒ(ä¾‹å¦‚+0.0 vs -0.0)ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">rk</span><span class="p">,</span> <span class="nx">re</span> <span class="o">:=</span> <span class="nf">mapaccessK</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span>   <span class="c1">// æ ¹æ®kæŸ¥æ‰¾æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">rk</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span> <span class="c1">// key has been deleted
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">it</span><span class="p">.</span><span class="nx">key</span> <span class="p">=</span> <span class="nx">rk</span>
</span></span><span class="line"><span class="cl">            <span class="nx">it</span><span class="p">.</span><span class="nx">elem</span> <span class="p">=</span> <span class="nx">re</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">it</span><span class="p">.</span><span class="nx">bucket</span> <span class="p">=</span> <span class="nx">bucket</span>  <span class="c1">// è®°å½•å½“å‰æ­£åœ¨è¿­ä»£çš„æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">it</span><span class="p">.</span><span class="nx">bptr</span> <span class="o">!=</span> <span class="nx">b</span> <span class="p">{</span> <span class="c1">// avoid unnecessary write barrier; see issue 14921
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">it</span><span class="p">.</span><span class="nx">bptr</span> <span class="p">=</span> <span class="nx">b</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">it</span><span class="p">.</span><span class="nx">i</span> <span class="p">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span>    <span class="c1">// ä¸‹æ¬¡éœ€è¦è¿­ä»£çš„tophashç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">it</span><span class="p">.</span><span class="nx">checkBucket</span> <span class="p">=</span> <span class="nx">checkBucket</span>    <span class="c1">// éœ€è¦æ£€æŸ¥çš„æ¡¶å·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿­ä»£bæ¡¶çš„æº¢å‡ºæ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">i</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="nx">next</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="mapaccessk">mapaccessK()<a hidden class="anchor" aria-hidden="true" href="#mapaccessk">#</a></h4>
<ol>
<li>åŒæ—¶è¿”å›keyå’Œelemã€‚ç”±mapè¿­ä»£å™¨ä½¿ç”¨</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// returns both key and elem. Used by map iterator
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mapaccessK</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">maptype</span><span class="p">,</span> <span class="nx">h</span> <span class="o">*</span><span class="nx">hmap</span><span class="p">,</span> <span class="nx">key</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">h</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">h</span><span class="p">.</span><span class="nx">count</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">hash</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">hasher</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">hash0</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">m</span> <span class="o">:=</span> <span class="nf">bucketMask</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">buckets</span><span class="p">,</span> <span class="p">(</span><span class="nx">hash</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>    <span class="c1">// *bmap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">c</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">oldbuckets</span><span class="p">;</span> <span class="nx">c</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>    <span class="c1">// æ­£å¤„äºæ‰©å®¹çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nx">h</span><span class="p">.</span><span class="nf">sameSizeGrow</span><span class="p">()</span> <span class="p">{</span>  <span class="c1">// ç¿»å€æ‰©å®¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// There used to be half as many buckets; mask down one more power of two.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">m</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">oldb</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">bmap</span><span class="p">)(</span><span class="nf">add</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="p">(</span><span class="nx">hash</span><span class="o">&amp;</span><span class="nx">m</span><span class="p">)</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">bucketsize</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nf">evacuated</span><span class="p">(</span><span class="nx">oldb</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">// æŸ¥çœ‹æ—§æ¡¶æ˜¯å¦æœ‰æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">b</span> <span class="p">=</span> <span class="nx">oldb</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">top</span> <span class="o">:=</span> <span class="nf">tophash</span><span class="p">(</span><span class="nx">hash</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">bucketloop</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">;</span> <span class="nx">b</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">overflow</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">bucketCnt</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">top</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">tophash</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">emptyRest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span> <span class="nx">bucketloop</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">k</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectkey</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">k</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">k</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">key</span><span class="p">.</span><span class="nf">equal</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">e</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">dataOffset</span><span class="o">+</span><span class="nx">bucketCnt</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">keysize</span><span class="p">)</span><span class="o">+</span><span class="nx">i</span><span class="o">*</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">elemsize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nf">indirectelem</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">e</span> <span class="p">=</span> <span class="o">*</span><span class="p">((</span><span class="o">*</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)(</span><span class="nx">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">e</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ä¸èƒ½ä½œä¸ºmap-keyç±»å‹">ä¸èƒ½ä½œä¸ºmap keyç±»å‹<a hidden class="anchor" aria-hidden="true" href="#ä¸èƒ½ä½œä¸ºmap-keyç±»å‹">#</a></h2>
<h3 id="å®˜æ–¹è§£é‡Š">å®˜æ–¹è§£é‡Š<a hidden class="anchor" aria-hidden="true" href="#å®˜æ–¹è§£é‡Š">#</a></h3>
<ol>
<li><code>map</code>çš„é”®å¯ä»¥æ˜¯ä»»ä½•<strong>å¯æ¯”è¾ƒ</strong>çš„ç±»å‹ã€‚</li>
<li>è¯­è¨€è§„èŒƒç²¾ç¡®åœ°å®šä¹‰äº†è¿™ä¸€ç‚¹ï¼Œç®€è€Œè¨€ä¹‹ï¼Œå¯æ¯”ç±»å‹æ˜¯<code>boolean</code>, <code>numeric</code>, <code>string</code>, <code>pointer</code>, <code>channel</code>, and <code>interface</code>ç±»å‹ï¼Œä»¥åŠåªåŒ…å«è¿™äº›ç±»å‹çš„ç»“æ„ä½“æˆ–æ•°ç»„ã€‚</li>
<li>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåˆ—è¡¨ä¸­æ²¡æœ‰ã€<code>slices</code>ã€‘,ã€ <code>maps</code>ã€‘, and ã€<code>functions</code>ã€‘; è¿™äº›ç±»å‹ä¸èƒ½ä½¿ç”¨<code>==</code>è¿›è¡Œæ¯”è¾ƒï¼Œä¹Ÿä¸èƒ½ç”¨ä½œæ˜ å°„é”®ã€‚</li>
<li>ä½†æ˜¯<code>slice</code>ã€<code>map</code>ã€<code>function</code>èƒ½ä¸<code>nil</code>ä½œä¸ºæ¯”è¾ƒã€‚</li>
</ol>
<h3 id="sliceä¸èƒ½ä½œä¸ºmap-key">sliceä¸èƒ½ä½œä¸ºmap key<a hidden class="anchor" aria-hidden="true" href="#sliceä¸èƒ½ä½œä¸ºmap-key">#</a></h3>
<ol>
<li><code>slice</code> ä¸èƒ½æ¯”è¾ƒï¼Œå› æ­¤ä¹Ÿä¸èƒ½ä½œä¸º<code>map key</code>ã€‚æ›´æ·±å±‚çš„åŸå› åº”è¯¥æ˜¯ <code>Slice</code> ä¸èƒ½ä½œä¸º<code>map key</code>å› æ­¤<code>Slice</code>å®šä¹‰ä¸ºä¸å¯æ¯”è¾ƒç±»å‹ã€‚</li>
<li>æ ¹æœ¬åŸå› æ˜¯ <code>slice</code> æ˜¯ä¸å¯æ¯”è¾ƒç±»å‹ï¼Œåœ¨<code>Go</code>ä¸­<code>Slice</code>ä½œä¸ºåªæ˜¯åº•å±‚æ•°ç»„çš„è¿ç»­çš„æè¿°ç¬¦ï¼Œå¦‚æœæŒ‰ç…§å…ƒç´ çš„æ¯”è¾ƒæ–¹å¼<code>Slice</code>å¯ä»¥åƒ<code>Array</code>ä¸€æ ·è¿›è¡Œæ¯”è¾ƒï¼Œä½†æ˜¯å½“<code>Slice</code>ä½œä¸º<code>map key</code>å€¼åˆ™ä¼šå‡ºç°è¿™ç§æƒ…å†µå½“ä¸€ä¸ª<code>slice</code>ä½œä¸º<code>key</code>ä¿å­˜åœ¨<code>map</code>ä¸­ï¼Œæˆ‘ä»¬ä¿®æ”¹å½“å‰<code>slice</code>çš„å…ƒç´ å€¼ä¼šä¿®æ”¹<code>map</code>ä¸­çš„<code>slice</code>çš„<code>key</code>å€¼ï¼Œè¿™ä¸<code>map</code>çš„å­˜å‚¨æ„ä¹‰ç›¸è¿èƒŒã€‚å› æ­¤<code>Go</code>å¹²è„†ä¸æ”¯æŒ<code>Slice</code>çš„æ¯”è¾ƒï¼Œæ¯”è¾ƒå‡½æ•°ä¸º<code>nil</code>ã€‚å¦å¤–ä¸€æ–¹é¢<code>slice</code>çš„<code>cap</code>åœ¨æ¯”è¾ƒä¸­åˆæ˜¾å¾—ä¸æ˜¯å¾ˆé‡è¦ï¼Œæ¯”å¦‚ <code>make([]int64, 0, 10)</code> å’Œ <code>make([]int64, 0, 9)</code> æ˜¯å¦ç›¸ç­‰å‘¢ï¼Œå› æ­¤<code>Slice</code>ä½œä¸ºå¯æ¯”è¾ƒç±»å‹æ˜¯æœ‰æ­§ä¹‰çš„ã€‚</li>
<li>å¦‚æœArrayä½œä¸ºç”±äºArrayæ˜¯å›ºå®šé•¿åº¦çš„å› æ­¤æ¯”è¾ƒå…ƒç´ å³å¯ï¼Œå¦å¤–arrayä½œä¸ºmap keyæ˜¯å‰¯æœ¬çš„å½¢å¼ä¸å­˜åœ¨sliceçš„æƒ…å†µã€‚</li>
</ol>
<h3 id="mapä¸èƒ½ä½œä¸ºkey">mapä¸èƒ½ä½œä¸ºkey<a hidden class="anchor" aria-hidden="true" href="#mapä¸èƒ½ä½œä¸ºkey">#</a></h3>
<ol>
<li><code>map</code> ä¸èƒ½æ¯”è¾ƒï¼Œå› æ­¤ä¹Ÿä¸èƒ½ä½œä¸º<code>map key</code>ã€‚æ›´æ·±å±‚çš„åŸå› åº”è¯¥æ˜¯ <code>map</code> ä¸èƒ½ä½œä¸º<code>map key</code>å› æ­¤<code>map</code>å®šä¹‰ä¸ºä¸å¯æ¯”è¾ƒç±»å‹ã€‚</li>
<li>å¦‚æœ<code>map</code>èƒ½æ¯”è¾ƒï¼Œé‚£ä¹ˆæ¯”è¾ƒ <code>map</code> çš„æ‰€æœ‰ <code>key/elem</code> å¯¹å³å¯ï¼Œä½†æ˜¯å½“<code>map</code>ä½œä¸º<code>map key</code>æ—¶<code>key</code>ä¸­ä¿å­˜çš„æ˜¯<code>*hmap</code>ï¼Œå› æ­¤å½“æˆ‘ä»¬ä¿®æ”¹è¿™ä¸ªä½œä¸º<code>map key</code>çš„<code>map</code>å€¼ä¹Ÿä¼šä¿®æ”¹åˆ°<code>map</code>ä¸­ç›¸åº”çš„<code>key</code>å€¼ï¼Œè¿™ç§é—®é¢˜å’Œ<code>slice</code>ç±»ä¼¼è¿™ä¸<code>map</code>çš„å­˜å‚¨æ„ä¹‰ç›¸è¿èƒŒã€‚å› æ­¤<code>Go</code>å¹²è„†ä¸æ”¯æŒ<code>Map</code>çš„æ¯”è¾ƒï¼Œæ¯”è¾ƒå‡½æ•°ä¸º<code>nil</code>ã€‚</li>
</ol>
<h3 id="functionä¸èƒ½ä½œä¸ºkey">functionä¸èƒ½ä½œä¸ºkey<a hidden class="anchor" aria-hidden="true" href="#functionä¸èƒ½ä½œä¸ºkey">#</a></h3>
<ol>
<li><code>function</code> ä¸èƒ½æ¯”è¾ƒï¼Œå› æ­¤ä¸èƒ½ä½œä¸º<code>map key</code>ã€‚æ›´æ·±å±‚çš„åŸå› åº”è¯¥æ˜¯ <code>function</code> ä¸èƒ½ä½œä¸º<code>map key</code>å› æ­¤<code>function</code>å®šä¹‰ä¸ºä¸å¯æ¯”è¾ƒç±»å‹ã€‚</li>
<li><code>function</code>ç±»å‹çš„ç»„æˆç”±<code>funcval{fn uintptr}</code>ç»“æ„ä½“ä»¥åŠä¸€ç³»åˆ—æ•è·åˆ—è¡¨ã€‚å¦‚æœç›´æ¥åˆ¤æ–­å‡½æ•°çš„ç­¾åå¯èƒ½å­˜åœ¨ä¸åŒçš„ç­¾åå‡½æ•°å®ç°çš„å‡½æ•°ä½“ä¸åŒï¼Œå› æ­¤å‡½æ•°ç­¾åä¸èƒ½ä½œä¸ºåˆ¤æ–­å‡½æ•°ç›¸ç­‰ä¾æ®ï¼Œå¦‚æœä½¿ç”¨<code>&amp;funcval</code>ä½œä¸º<code>map key</code>ï¼Œä¼šå‡ºç°å¦‚æœç›¸åŒçš„<code>&amp;funcval</code>ä¸åŒçš„æ•è·åˆ—è¡¨å…¶å®å¹¶æ²¡æœ‰æˆåŠŸåŒ¹é…åˆ°<code>key</code>ã€‚</li>
</ol>
<h2 id="for-range">for range<a hidden class="anchor" aria-hidden="true" href="#for-range">#</a></h2>
<ol>
<li><code>range map</code>åªæ˜¯æ­¤æ—¶<code>map</code>çš„ä¸€ä¸ªå¿«ç…§ã€‚</li>
<li>å¯¹äº<code>key</code>ä¸º<code>NaN</code>çš„ï¼Œ<code>for range</code>èƒ½éå†å‡ºæ¥ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">map1</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;one&#34;</span><span class="p">:</span><span class="s">&#34;1&#34;</span><span class="p">,</span> <span class="s">&#34;tow&#34;</span><span class="p">:</span><span class="s">&#34;2&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">map1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// original body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// -------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">// ä¸‹é¢æ˜¯ä¸Šé¢ç¼–è¯‘åä»£ç 
</span></span></span><span class="line"><span class="cl"><span class="c1">// -------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// å®šä¹‰éå†æ‰€éœ€è¦çš„keyå’Œvalueå˜é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">v</span> <span class="kt">string</span>					
</span></span><span class="line"><span class="cl"><span class="c1">// map_iteration_structæ˜¯ä¸€ä¸ªhiterç»“æ„ä½“ï¼Œå­˜å‚¨ç€mapçš„éå†ç›¸å…³ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">hiter</span> <span class="nx">map_iteration_struct</span>	 
</span></span><span class="line"><span class="cl"><span class="c1">// mapiterinit åˆå§‹åŒ–mapå‚çœ‹runtime/map.goæ–‡ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1">// hiteræ˜¯ä¸€ä¸ªå“ˆå¸Œè¿­ä»£ç»“æ„ï¼Œmapiternextè¿­ä»£ä¸‹ä¸€ä¸ªå“ˆå¸Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="nf">mapiterinit</span><span class="p">(</span><span class="kd">type</span><span class="p">,</span> <span class="k">range</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">hiter</span><span class="p">);</span> <span class="nx">hiter</span><span class="p">.</span><span class="nx">key</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">;</span> <span class="nf">mapiternext</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">hiter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">index_temp</span> <span class="o">:=</span> <span class="o">*</span><span class="nx">hiter</span><span class="p">.</span><span class="nx">key</span>
</span></span><span class="line"><span class="cl">    <span class="nx">value_temp</span> <span class="o">:=</span> <span class="o">*</span><span class="nx">hiter</span><span class="p">.</span><span class="nx">val</span>
</span></span><span class="line"><span class="cl">    <span class="nx">i</span> <span class="p">=</span> <span class="nx">index_temp</span>
</span></span><span class="line"><span class="cl">    <span class="nx">v</span> <span class="p">=</span> <span class="nx">value_temp</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// original body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="mapç›¸å…³ç»ƒä¹ é¢˜">mapç›¸å…³ç»ƒä¹ é¢˜<a hidden class="anchor" aria-hidden="true" href="#mapç›¸å…³ç»ƒä¹ é¢˜">#</a></h2>
<h3 id="ç¤ºä¾‹ä¸€">ç¤ºä¾‹ä¸€<a hidden class="anchor" aria-hidden="true" href="#ç¤ºä¾‹ä¸€">#</a></h3>
<ol>
<li><code>map[string]map[string]string</code>ç±»å‹éå†ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">mm</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mm</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æµ‹è¯•éªŒè¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">modifyUser</span><span class="p">(</span><span class="nx">mm</span><span class="p">,</span> <span class="s">&#34;one&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">modifyUser</span><span class="p">(</span><span class="nx">mm</span><span class="p">,</span> <span class="s">&#34;two&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">modifyUser</span><span class="p">(</span><span class="nx">mm</span><span class="p">,</span> <span class="s">&#34;three&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">mm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">modifyUser</span><span class="p">(</span><span class="nx">mm</span><span class="p">,</span> <span class="s">&#34;one&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">mm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 1. ä½¿ç”¨map[string]map[string]stringç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1">// 2. keyï¼šè¡¨ç¤ºç”¨æˆ·åï¼Œæ˜¯å”¯ä¸€çš„ï¼Œä¸å¯ä»¥é‡å¤
</span></span></span><span class="line"><span class="cl"><span class="c1">// 3. å¦‚æœæŸä¸ªç”¨æˆ·åå­˜åœ¨ï¼Œå°±å°†å…¶å¯†ç ä¿®æ”¹&#34;888888&#34;ï¼Œå¦‚æœä¸å­˜åœ¨å°±å¢åŠ è¿™ä¸ªç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…æ‹¬æ˜µç§°nicknameå’Œå¯†ç pwdï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1">// 4. ç¼–å†™ä¸€ä¸ªå‡½æ•°modifyUser(users map[string]map[string]string, name string)å®Œæˆä¸Šè¿°åŠŸèƒ½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">modifyUser</span><span class="p">(</span><span class="nx">user</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">user</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å› ä¸ºvå­˜å‚¨çš„æ—¶*hmapæŒ‡é’ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å› æ­¤ç›´æ¥ä¿®æ”¹v[&#34;pwd&#34;]æ—¶å¯è¡Œçš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">v</span><span class="p">[</span><span class="s">&#34;pwd&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&#34;888888&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">user</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;pwd&#34;</span><span class="p">:</span> <span class="nx">name</span><span class="p">,</span> <span class="s">&#34;nickname&#34;</span><span class="p">:</span> <span class="s">&#34;nickname&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ç¤ºä¾‹äºŒ">ç¤ºä¾‹äºŒ<a hidden class="anchor" aria-hidden="true" href="#ç¤ºä¾‹äºŒ">#</a></h3>
<ol>
<li><code>map</code>ä½œä¸ºé›†åˆä½¿ç”¨ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 1. mapä½œä¸ºé›†åˆä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">mm</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mm</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">struct</span><span class="p">{},</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">mm</span><span class="p">[</span><span class="s">&#34;redis&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="kd">struct</span><span class="p">{}{}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mm</span><span class="p">[</span><span class="s">&#34;mysql&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="kd">struct</span><span class="p">{}{}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mm</span><span class="p">[</span><span class="s">&#34;nginx&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="kd">struct</span><span class="p">{}{}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">mm</span><span class="p">[</span><span class="s">&#34;php&#34;</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æŒ‡å®šå…ƒç´ å­˜åœ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">k</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">mm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://heliu.site/tags/golang/">Golang</a></li>
      <li><a href="https://heliu.site/tags/%E5%AD%97%E5%85%B8/">å­—å…¸</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://heliu.site/posts/golang/map/use/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>Map(ä½¿ç”¨)</span>
  </a>
  <a class="next" href="https://heliu.site/posts/golang/map/meta/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>Map å…ƒç±»å‹</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        æœ¬ç«™æ€»è®¿é—®é‡<span id="busuanzi_value_site_pv"></span>æ¬¡
    </span>
    <span id="busuanzi_container_site_uv">
        æœ¬ç«™è®¿å®¢æ•°<span id="busuanzi_value_site_uv"></span>äººæ¬¡
    </span>
    </div>
        <span>Copyright Â© 2020-2024 <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
