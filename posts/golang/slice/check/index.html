<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>边界检查 | Helium</title>
<meta name="keywords" content="golang, 切片">
<meta name="description" content="💥本文章所有相关go代码参考自go 1.18&#43;版本">
<meta name="author" content="helium">
<link rel="canonical" href="https://heliu.site/posts/golang/slice/check/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://heliu.site/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://heliu.site/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://heliu.site/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://heliu.site/apple-touch-icon.png">
<link rel="mask-icon" href="https://heliu.site/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://heliu.site/posts/golang/slice/check/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="边界检查" />
<meta property="og:description" content="💥本文章所有相关go代码参考自go 1.18&#43;版本" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://heliu.site/posts/golang/slice/check/" />
<meta property="og:image" content="https://heliu.site/favicon-32x32.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-08-22T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-08-21T00:00:00+00:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://heliu.site/favicon-32x32.png" />
<meta name="twitter:title" content="边界检查"/>
<meta name="twitter:description" content="💥本文章所有相关go代码参考自go 1.18&#43;版本"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://heliu.site/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Golang 合集",
      "item": "https://heliu.site/posts/golang/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "第7章 Slice",
      "item": "https://heliu.site/posts/golang/slice/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "边界检查",
      "item": "https://heliu.site/posts/golang/slice/check/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "边界检查",
  "name": "边界检查",
  "description": "💥本文章所有相关go代码参考自go 1.18+版本",
  "keywords": [
    "golang", "切片"
  ],
  "articleBody": "什么是边界检查 边界检查，英文名Bounds Check Elimination，简称为 BCE。 它是Go语言中防止数组、切片越界而导致内存不安全的检查手段。如果检查下标已经越界了，就会产生Panic。 边界检查使得我们的代码能够安全地运行，但是另一方面，也使得我们的代码运行效率略微降低。 比如下面这段代码，会进行三次的边界检查。 1 2 3 4 5 6 7 8 9 package main func f(s []int) { _ = s[0] // 检查第一次 _ = s[1] // 检查第二次 _ = s[2] // 检查第三次 } func main() {} 你可能会好奇了，三次？我是怎么知道它要检查三次的。 实际上，你只要在编译的时候，加上参数-gcflags=\"-d=ssa/check_bce/debug=1\"即可，命令如下： 1 2 3 4 5 $ go build -gcflags=\"-d=ssa/check_bce/debug=1\" main.go # command-line-arguments ./main.go:4:7: Found IsInBounds ./main.go:5:7: Found IsInBounds ./main.go:6:7: Found IsInBounds 边界检查的条件 并不是所有的对数组、切片进行索引操作都需要边界检查。 比如下面这个示例，就不需要进行边界检查，因为编译器根据上下文已经得知，s这个切片的长度是多少，你的终止索引是多少，立马就能判断到底有没有越界，因此是不需要再进行边界检查，因为在编译的时候就已经知道这个地方会不会 panic。 1 2 3 4 5 6 7 8 9 package main func f() { s := []int{1,2,3,4} // panic: runtime error: slice bounds out of range [:9] with capacity 4 _ = s[:9] // 不需要边界检查 } func main() {} 因此可以得出结论，对于在编译阶段无法判断是否会越界的索引操作才会需要边界检查，比如这样子： 1 2 3 4 5 6 7 package main func f(s []int) { _ = s[:9] // 需要边界检查 } func main() {} 边界检查的特殊案例 案例一 在如下示例代码中，由于索引2在最前面已经检查过会不会越界，因此聪明的编译器可以推断出后面的索引0和1不用再检查。 1 2 3 4 5 6 7 8 9 package main func f(s []int) { _ = s[2] // 检查一次 _ = s[1] // 不会检查 _ = s[0] // 不会检查 } func main() {} 案例二 在下面这个示例中，可以在逻辑上保证不会越界的代码，同样是不会进行越界检查的。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 package main // [low:high:max] // len = high - low // cap = max - low // s =\u003e len = 10, cap = 20 func f(s []int) { for index, _ := range s { // 以下操作都是在有效的索引范围 _ = s[index] _ = s[:index+1] // index [0,9] _ = s[index:len(s)] // len(s) = 10 } } func main() {} 案例三 在如下示例代码中，虽然数组的长度和容量可以确定，但是索引是通过rand.Intn()函数取得的随机数，在编译器看来这个索引值是不确定的，它有可能大于数组的长度，也有可能小于数组的长度。 因此第一次是需要进行检查的，有了第一次检查后，第二次索引从逻辑上就能推断，所以不会再进行边界检查。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 package main import ( \"math/rand\" ) func f() { s := make([]int, 3, 5) index := rand.Intn(3) // [0,1,2,3] _ = s[:index] // 第一次检查 _ = s[index:] // 第二次检查 } func main() {} 我们只有当数组的长度和容量相等时，:index成立，才能一定能推出index:也成立，这样的话，只要做一次检查即可。 一旦数组的长度和容量不相等，那么index在编译器看来是有可能大于数组长度的，甚至大于数组的容量。 我们假设index取得的随机数为4，那么它大于数组长度，此时s[:index]虽然可以成功，但是s[index:]是要失败的，因此第二次边界的检查是有必要的。 你可能会说，index不是最大值为3吗？怎么可能是4呢？要知道编译器在编译的时候，并不知道index的最大值是3呢。 总结： 当数组的长度和容量相等时，s[:index]成立能够保证s[index:]也成立，因为只要检查一次即可。 当数组的长度和容量不等时，s[:index]成立不能保证s[index:]也成立，因为要检查两次才可以。 案例四 由于数组是调用者传入的参数，所以编译器编译的时候无法得知数组的长度和容量是否相等，因此只能保险一点，两个都检查。 1 2 3 4 5 6 7 8 9 10 11 12 package main import ( \"math/rand\" ) func f(s []int, index int) { _ = s[:index] // 第一次检查 _ = s[index:] // 第二次检查 } func main() {} 但是如果把两个表达式的顺序反过来，就只要做一次检查就行了。 1 2 3 4 5 6 7 8 9 10 11 12 package main import ( \"math/rand\" ) func f(s []int, index int) { _ = s[index:] // 第一次检查 _ = s[:index] // 不用检查 } func main() {} 主动消除边界检查 虽然编译器已经非常努力去消除一些应该消除的边界检查，但难免会有一些遗漏。 这就需要”警民合作”，对于那些编译器还未考虑到的场景，但开发者又极力追求程序的运行效率的，可以使用一些小技巧给出一些暗示，告诉编译器哪些地方可以不用做边界检查。 比如下面这个示例，从代码的逻辑上来说，是完全没有必要做边界检查的，但是编译器并没有那么智能，实际上每个for循环，它都要做一次边界的检查，非常的浪费性能。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package main func f0(is []int, bs []byte) { if len(is) \u003e= 256 { //is=is[:256] for _, n := range bs { // 每个循环都要边界检查， // 因为编译器并不知道is[n]这里的is的长度是否会超过byte大小 _ = is[n] } } } func main() {} 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 TEXT main.f0(SB) /mnt/hgfs/g/hello1/struct.go func f0(is []int, bs []byte) { 0x4552e0 4883ec50 SUBQ $0x50, SP 0x4552e4 48896c2448 MOVQ BP, 0x48(SP) 0x4552e9 488d6c2448 LEAQ 0x48(SP), BP 0x4552ee 4889442458 MOVQ AX, 0x58(SP) # is.data 0x4552f3 48895c2460 MOVQ BX, 0x60(SP) # is.len 0x4552f8 48894c2468 MOVQ CX, 0x68(SP) # is.cap 0x4552fd 48897c2470 MOVQ DI, 0x70(SP) # bs.data 0x455302 4889742478 MOVQ SI, 0x78(SP) # bs.len 0x455307 4c89842480000000 MOVQ R8, 0x80(SP) # bs.cap if len(is) \u003e= 256 { 0x45530f 48895c2428 MOVQ BX, 0x28(SP) # BX=is.len 0x455314 4881fb00010000 CMPQ $0x100, BX # is.len 与 256比较 0x45531b 7d02 JGE 0x45531f 0x45531d eb36 JMP 0x455355 for _, n := range bs { 0x45531f 488b542470 MOVQ 0x70(SP), DX # DX=bs.data 0x455324 488b5c2478 MOVQ 0x78(SP), BX # BX=bs.len 0x455329 488bb42480000000 MOVQ 0x80(SP), SI # SI=bs.cap 0x455331 4889542430 MOVQ DX, 0x30(SP) 0x455336 48895c2438 MOVQ BX, 0x38(SP) 0x45533b 4889742440 MOVQ SI, 0x40(SP) 0x455340 48c744242000000000 MOVQ $0x0, 0x20(SP) 0x455349 488b542438 MOVQ 0x38(SP), DX\t# DX=bs.len 0x45534e 4889542418 MOVQ DX, 0x18(SP) 0x455353 eb0c JMP 0x455361 } 0x455355 eb00 JMP 0x455357 0x455357 488b6c2448 MOVQ 0x48(SP), BP 0x45535c 4883c450 ADDQ $0x50, SP 0x455360 c3 RET for _, n := range bs { 0x455361 488b542420 MOVQ 0x20(SP), DX # DX=0 0x455366 4839542418 CMPQ DX, 0x18(SP) # DX 与 bs.len 循环判断条件 0x45536b 7f02 JG 0x45536f 0x45536d eb2e JMP 0x45539d 0x45536f 488b542430 MOVQ 0x30(SP), DX 0x455374 4803542420 ADDQ 0x20(SP), DX 0x455379 0fb602 MOVZX 0(DX), AX 0x45537c 88442417 MOVB AL, 0x17(SP) _ = is[n] 0x455380 488b4c2460 MOVQ 0x60(SP), CX 0x455385 4839c1 CMPQ AX, CX # 越界判断 0x455388 7702 JA 0x45538c 0x45538a eb13 JMP 0x45539f 0x45538c eb00 JMP 0x45538e for _, n := range bs { 0x45538e 488b542420 MOVQ 0x20(SP), DX 0x455393 48ffc2 INCQ DX 0x455396 4889542420 MOVQ DX, 0x20(SP) 0x45539b ebc4 JMP 0x455361 } 0x45539d ebb8 JMP 0x455357 _ = is[n] 0x45539f 90 NOPL 0x4553a0 e81bd3ffff CALL runtime.panicIndex(SB) 0x4553a5 90 NOPL 可以试着在for循环前加上这么一句is = is[:256]来告诉编译器新is的长度为256，最大索引值为255，不会超过byte的最大值，因为is[n]从逻辑上来说是一定不会越界的。 1 2 3 4 5 6 7 8 9 10 11 package main func f00(is []int, bs []byte) { if len(is) \u003e= 256 { is = is[:256] for _, n := range bs { _ = is[n] // 不需要做边界检查 } } } func main() {} 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 TEXT main.f00(SB) /mnt/hgfs/g/hello1/t1.go func f00(is []int, bs []byte) { 0x4552e0 4883ec50 SUBQ $0x50, SP 0x4552e4 48896c2448 MOVQ BP, 0x48(SP) 0x4552e9 488d6c2448 LEAQ 0x48(SP), BP 0x4552ee 4889442458 MOVQ AX, 0x58(SP) 0x4552f3 48895c2460 MOVQ BX, 0x60(SP) 0x4552f8 48894c2468 MOVQ CX, 0x68(SP) 0x4552fd 48897c2470 MOVQ DI, 0x70(SP) 0x455302 4889742478 MOVQ SI, 0x78(SP) 0x455307 4c89842480000000 MOVQ R8, 0x80(SP) if len(is) \u003e= 256 { 0x45530f 48895c2428 MOVQ BX, 0x28(SP) 0x455314 4881fb00010000 CMPQ $0x100, BX # 256 与 is.len 比较 0x45531b 7d02 JGE 0x45531f 0x45531d eb54 JMP 0x455373 is = is[:256] // 消除边界检查 0x45531f 488b542468 MOVQ 0x68(SP), DX # DX=is.cap 0x455324 4881fa00010000 CMPQ $0x100, DX # 256 与 is.cap 比较 0x45532b 7305 JAE 0x455332 0x45532d e993000000 JMP 0x4553c5 0x455332 eb00 JMP 0x455334 0x455334 48c744246000010000 MOVQ $0x100, 0x60(SP) # is.len=256 for _, n := range bs { 0x45533d 488b542470 MOVQ 0x70(SP), DX # DX=bs.data 0x455342 488b5c2478 MOVQ 0x78(SP), BX # BX=bs.len 0x455347 488bb42480000000 MOVQ 0x80(SP), SI # SI=bs.cap 0x45534f 4889542430 MOVQ DX, 0x30(SP) 0x455354 48895c2438 MOVQ BX, 0x38(SP) 0x455359 4889742440 MOVQ SI, 0x40(SP) 0x45535e 48c744242000000000 MOVQ $0x0, 0x20(SP) 0x455367 488b542438 MOVQ 0x38(SP), DX # DX=bs.len 0x45536c 4889542418 MOVQ DX, 0x18(SP) 0x455371 eb0c JMP 0x45537f } 0x455373 eb00 JMP 0x455375 0x455375 488b6c2448 MOVQ 0x48(SP), BP 0x45537a 4883c450 ADDQ $0x50, SP 0x45537e c3 RET for _, n := range bs { 0x45537f 488b542420 MOVQ 0x20(SP), DX # DX=0 0x455384 4839542418 CMPQ DX, 0x18(SP) # 0 与 bs.len 比较 0x455389 7f02 JG 0x45538d 0x45538b eb2e JMP 0x4553bb 0x45538d 488b542430 MOVQ 0x30(SP), DX # DX=bs.data 0x455392 4803542420 ADDQ 0x20(SP), DX # DX=0+DX 0x455397 0fb602 MOVZX 0(DX), AX # AX=*bs.data 0x45539a 88442417 MOVB AL, 0x17(SP) _ = is[n] 0x45539e 488b4c2460 MOVQ 0x60(SP), CX # CX=256 0x4553a3 4839c1 CMPQ AX, CX # 越界判断 0x4553a6 7702 JA 0x4553aa 0x4553a8 eb13 JMP 0x4553bd 0x4553aa eb00 JMP 0x4553ac for _, n := range bs { 0x4553ac 488b542420 MOVQ 0x20(SP), DX 0x4553b1 48ffc2 INCQ DX 0x4553b4 4889542420 MOVQ DX, 0x20(SP) 0x4553b9 ebc4 JMP 0x45537f } 0x4553bb ebb8 JMP 0x455375 _ = is[n] 0x4553bd 0f1f00 NOPL 0(AX) 0x4553c0 e8fbd2ffff CALL runtime.panicIndex(SB) is = is[:256] // 消除边界检查 0x4553c5 b900010000 MOVL $0x100, CX 0x4553ca e871d3ffff CALL runtime.panicSliceAcap(SB) 0x4553cf 90 NOPL ",
  "wordCount" : "1259",
  "inLanguage": "zh",
  "image": "https://heliu.site/favicon-32x32.png","datePublished": "2020-08-22T00:00:00Z",
  "dateModified": "2020-08-21T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://heliu.site/posts/golang/slice/check/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://heliu.site/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://heliu.site/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://heliu.site/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://heliu.site/" title="主页">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/posts" title="文章">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/archives" title="时间轴">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/tags/" title="标签">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/search/" title="搜索 (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://heliu.site/support" title="打赏">
                    <span>🫶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://heliu.site/">主页</a>&nbsp;»&nbsp;<a href="https://heliu.site/posts/">Article</a>&nbsp;»&nbsp;<a href="https://heliu.site/posts/golang/">Golang 合集</a>&nbsp;»&nbsp;<a href="https://heliu.site/posts/golang/slice/">第7章 Slice</a></div>
    <h1 class="post-title entry-hint-parent">
      边界检查
    </h1>
    <div class="post-description">
      💥本文章所有相关go代码参考自go 1.18&#43;版本
    </div>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2020-08-22</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2020-08-21</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>1259字</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>6分钟</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &nbsp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://heliu.site/tags/golang/" target="_blank" rel="noopener">Golang</a>
            <a href="https://heliu.site/tags/%E5%88%87%E7%89%87/" target="_blank" rel="noopener">切片</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &nbsp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e4%bb%80%e4%b9%88%e6%98%af%e8%be%b9%e7%95%8c%e6%a3%80%e6%9f%a5" aria-label="什么是边界检查">什么是边界检查</a></li>
                    <li>
                        <a href="#%e8%be%b9%e7%95%8c%e6%a3%80%e6%9f%a5%e7%9a%84%e6%9d%a1%e4%bb%b6" aria-label="边界检查的条件">边界检查的条件</a></li>
                    <li>
                        <a href="#%e8%be%b9%e7%95%8c%e6%a3%80%e6%9f%a5%e7%9a%84%e7%89%b9%e6%ae%8a%e6%a1%88%e4%be%8b" aria-label="边界检查的特殊案例">边界检查的特殊案例</a><ul>
                            
                    <li>
                        <a href="#%e6%a1%88%e4%be%8b%e4%b8%80" aria-label="案例一">案例一</a></li>
                    <li>
                        <a href="#%e6%a1%88%e4%be%8b%e4%ba%8c" aria-label="案例二">案例二</a></li>
                    <li>
                        <a href="#%e6%a1%88%e4%be%8b%e4%b8%89" aria-label="案例三">案例三</a></li>
                    <li>
                        <a href="#%e6%a1%88%e4%be%8b%e5%9b%9b" aria-label="案例四">案例四</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e4%b8%bb%e5%8a%a8%e6%b6%88%e9%99%a4%e8%be%b9%e7%95%8c%e6%a3%80%e6%9f%a5" aria-label="主动消除边界检查">主动消除边界检查</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><h2 id="什么是边界检查">什么是边界检查<a hidden class="anchor" aria-hidden="true" href="#什么是边界检查">#</a></h2>
<ol>
<li>边界检查，英文名<code>Bounds Check Elimination</code>，简称为 BCE。</li>
<li>它是Go语言中防止<strong>数组</strong>、<strong>切片</strong>越界而导致内存不安全的检查手段。如果检查下标已经越界了，就会产生<code>Panic</code>。</li>
<li>边界检查使得我们的代码能够安全地运行，但是另一方面，也使得我们的代码运行效率略微降低。</li>
<li>比如下面这段代码，会进行三次的边界检查。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f</span><span class="p">(</span><span class="nx">s</span> <span class="p">[]</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1">// 检查第一次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1">// 检查第二次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1">// 检查第三次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>你可能会好奇了，三次？我是怎么知道它要检查三次的。</li>
<li>实际上，你只要在编译的时候，加上参数<code>-gcflags=&quot;-d=ssa/check_bce/debug=1&quot;</code>即可，命令如下：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ go build -gcflags<span class="o">=</span><span class="s2">&#34;-d=ssa/check_bce/debug=1&#34;</span> main.go
</span></span><span class="line"><span class="cl"><span class="c1"># command-line-arguments</span>
</span></span><span class="line"><span class="cl">./main.go:4:7: Found IsInBounds
</span></span><span class="line"><span class="cl">./main.go:5:7: Found IsInBounds
</span></span><span class="line"><span class="cl">./main.go:6:7: Found IsInBounds
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="边界检查的条件">边界检查的条件<a hidden class="anchor" aria-hidden="true" href="#边界检查的条件">#</a></h2>
<ol>
<li>并不是所有的对数组、切片进行索引操作都需要边界检查。</li>
<li>比如下面这个示例，就不需要进行边界检查，因为编译器根据上下文已经得知，<code>s</code>这个切片的长度是多少，你的终止索引是多少，立马就能判断到底有没有越界，因此是不需要再进行边界检查，因为在编译的时候就已经知道这个地方会不会 panic。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// panic: runtime error: slice bounds out of range [:9] with capacity 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span>  <span class="c1">// 不需要边界检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span>  <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>因此可以得出结论，对于在<strong>编译阶段无法判断</strong>是否会越界的索引操作才会需要边界检查，比如这样子：</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f</span><span class="p">(</span><span class="nx">s</span> <span class="p">[]</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span>  <span class="c1">// 需要边界检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span>  <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="边界检查的特殊案例">边界检查的特殊案例<a hidden class="anchor" aria-hidden="true" href="#边界检查的特殊案例">#</a></h2>
<h3 id="案例一">案例一<a hidden class="anchor" aria-hidden="true" href="#案例一">#</a></h3>
<ol>
<li>在如下示例代码中，由于索引2在最前面已经检查过会不会越界，因此聪明的编译器可以推断出后面的索引0和1不用再检查。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"> <span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f</span><span class="p">(</span><span class="nx">s</span> <span class="p">[]</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="c1">// 检查一次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1">// 不会检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">// 不会检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="案例二">案例二<a hidden class="anchor" aria-hidden="true" href="#案例二">#</a></h3>
<ol>
<li>在下面这个示例中，可以在逻辑上保证不会越界的代码，同样是不会进行越界检查的。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// [low:high:max]
</span></span></span><span class="line"><span class="cl"><span class="c1">//  len = high - low
</span></span></span><span class="line"><span class="cl"><span class="c1">//  cap = max - low
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// s =&gt; len = 10, cap = 20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f</span><span class="p">(</span><span class="nx">s</span> <span class="p">[]</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 以下操作都是在有效的索引范围
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[:</span><span class="nx">index</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>     <span class="c1">// index [0,9]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">_</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[</span><span class="nx">index</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">)]</span> <span class="c1">// len(s) = 10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span>  <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="案例三">案例三<a hidden class="anchor" aria-hidden="true" href="#案例三">#</a></h3>
<ol>
<li>在如下示例代码中，虽然数组的长度和容量可以确定，但是索引是通过<code>rand.Intn()</code>函数取得的随机数，在编译器看来这个索引值是不确定的，它有可能大于数组的长度，也有可能小于数组的长度。</li>
<li>因此第一次是需要进行检查的，有了第一次检查后，第二次索引从逻辑上就能推断，所以不会再进行边界检查。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;math/rand&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f</span><span class="p">()</span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">s</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">index</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>   <span class="c1">// [0,1,2,3]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="nx">_</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[:</span><span class="nx">index</span><span class="p">]</span>          <span class="c1">// 第一次检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[</span><span class="nx">index</span><span class="p">:]</span>           <span class="c1">// 第二次检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span>  <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>我们只有当数组的长度和容量相等时，<code>:index</code>成立，才能一定能推出<code>index:</code>也成立，这样的话，只要做一次检查即可。</li>
<li>一旦数组的长度和容量不相等，那么<code>index</code>在编译器看来是有可能大于数组长度的，甚至大于数组的容量。</li>
<li>我们假设<code>index</code>取得的随机数为4，那么它大于数组长度，此时<code>s[:index]</code>虽然可以成功，但是<code>s[index:]</code>是要失败的，因此第二次边界的检查是有必要的。</li>
<li>你可能会说，<code>index</code>不是最大值为3吗？怎么可能是4呢？要知道编译器在编译的时候，并不知道index的最大值是3呢。</li>
<li>总结：
<ul>
<li>当数组的长度和容量相等时，<code>s[:index]</code>成立能够保证<code>s[index:]</code>也成立，因为只要检查一次即可。</li>
</ul>
<ol start="2">
<li>当数组的长度和容量不等时，<code>s[:index]</code>成立不能保证<code>s[index:]</code>也成立，因为要检查两次才可以。</li>
</ol>
</li>
</ol>
<h3 id="案例四">案例四<a hidden class="anchor" aria-hidden="true" href="#案例四">#</a></h3>
<ol>
<li>由于数组是调用者传入的参数，所以编译器编译的时候无法得知数组的长度和容量是否相等，因此只能保险一点，两个都检查。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;math/rand&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f</span><span class="p">(</span><span class="nx">s</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">index</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[:</span><span class="nx">index</span><span class="p">]</span> <span class="c1">// 第一次检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[</span><span class="nx">index</span><span class="p">:]</span> <span class="c1">// 第二次检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span>  <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>但是如果把两个表达式的顺序反过来，就只要做一次检查就行了。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;math/rand&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f</span><span class="p">(</span><span class="nx">s</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">index</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[</span><span class="nx">index</span><span class="p">:]</span> <span class="c1">// 第一次检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_</span> <span class="p">=</span> <span class="nx">s</span><span class="p">[:</span><span class="nx">index</span><span class="p">]</span> <span class="c1">// 不用检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span>  <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="主动消除边界检查">主动消除边界检查<a hidden class="anchor" aria-hidden="true" href="#主动消除边界检查">#</a></h2>
<ol>
<li>虽然编译器已经非常努力去消除一些应该消除的边界检查，但难免会有一些遗漏。</li>
<li>这就需要”警民合作”，对于那些编译器还未考虑到的场景，但开发者又极力追求程序的运行效率的，可以使用一些小技巧给出一些暗示，告诉编译器哪些地方可以不用做边界检查。</li>
<li>比如下面这个示例，从代码的逻辑上来说，是完全没有必要做边界检查的，但是编译器并没有那么智能，实际上每个for循环，它都要做一次边界的检查，非常的浪费性能。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f0</span><span class="p">(</span><span class="nx">is</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">bs</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">is</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">256</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//is=is[:256]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">bs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 每个循环都要边界检查，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// 因为编译器并不知道is[n]这里的is的长度是否会超过byte大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">_</span> <span class="p">=</span> <span class="nx">is</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> 
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span>  <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.f0</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">g</span><span class="err">/</span><span class="no">hello1</span><span class="err">/</span><span class="no">struct.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">f0</span><span class="p">(</span><span class="no">is</span> <span class="p">[]</span><span class="no">int</span><span class="p">,</span> <span class="no">bs</span> <span class="p">[]</span><span class="no">byte</span><span class="p">)</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552e0</span>      <span class="mi">4883</span><span class="no">ec50</span>            <span class="no">SUBQ</span> <span class="no">$0x50</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552e4</span>      <span class="mi">48896</span><span class="no">c2448</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x48</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552e9</span>      <span class="mi">488</span><span class="no">d6c2448</span>          <span class="no">LEAQ</span> <span class="mi">0x48</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552ee</span>      <span class="mi">4889442458</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x58</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span> <span class="c1"># is.data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552f3</span>      <span class="mi">48895</span><span class="no">c2460</span>          <span class="no">MOVQ</span> <span class="no">BX</span><span class="p">,</span> <span class="mi">0x60</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span> <span class="c1"># is.len
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552f8</span>      <span class="mi">48894</span><span class="no">c2468</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x68</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span> <span class="c1"># is.cap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4552fd</span>      <span class="mi">48897</span><span class="no">c2470</span>          <span class="no">MOVQ</span> <span class="no">DI</span><span class="p">,</span> <span class="mi">0x70</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span> <span class="c1"># bs.data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455302</span>      <span class="mi">4889742478</span>          <span class="no">MOVQ</span> <span class="no">SI</span><span class="p">,</span> <span class="mi">0x78</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span> <span class="c1"># bs.len
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455307</span>      <span class="mi">4</span><span class="no">c89842480000000</span>    <span class="no">MOVQ</span> <span class="no">R8</span><span class="p">,</span> <span class="mi">0x80</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span> <span class="c1"># bs.cap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">if</span> <span class="no">len</span><span class="p">(</span><span class="no">is</span><span class="p">)</span> <span class="err">&gt;=</span> <span class="mi">256</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45530f</span>      <span class="mi">48895</span><span class="no">c2428</span>          <span class="no">MOVQ</span> <span class="no">BX</span><span class="p">,</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># BX=is.len
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455314</span>      <span class="mi">4881</span><span class="no">fb00010000</span>      <span class="no">CMPQ</span> <span class="no">$0x100</span><span class="p">,</span> <span class="no">BX</span>     <span class="c1"># is.len 与 256比较
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45531b</span>      <span class="mi">7</span><span class="no">d02</span>                <span class="no">JGE</span> <span class="mi">0x45531f</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45531d</span>      <span class="no">eb36</span>                <span class="no">JMP</span> <span class="mi">0x455355</span>
</span></span><span class="line"><span class="cl">        <span class="nf">for</span> <span class="no">_</span><span class="p">,</span> <span class="no">n</span> <span class="p">:</span><span class="err">=</span> <span class="no">range</span> <span class="no">bs</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45531f</span>      <span class="mi">488</span><span class="no">b542470</span>          <span class="no">MOVQ</span> <span class="mi">0x70</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>   <span class="c1"># DX=bs.data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455324</span>      <span class="mi">488</span><span class="no">b5c2478</span>          <span class="no">MOVQ</span> <span class="mi">0x78</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BX</span>   <span class="c1"># BX=bs.len
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455329</span>      <span class="mi">488</span><span class="no">bb42480000000</span>    <span class="no">MOVQ</span> <span class="mi">0x80</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">SI</span>   <span class="c1"># SI=bs.cap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455331</span>      <span class="mi">4889542430</span>          <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455336</span>      <span class="mi">48895</span><span class="no">c2438</span>          <span class="no">MOVQ</span> <span class="no">BX</span><span class="p">,</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45533b</span>      <span class="mi">4889742440</span>          <span class="no">MOVQ</span> <span class="no">SI</span><span class="p">,</span> <span class="mi">0x40</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455340</span>      <span class="mi">48</span><span class="no">c744242000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455349</span>      <span class="mi">488</span><span class="no">b542438</span>          <span class="no">MOVQ</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>	<span class="c1"># DX=bs.len
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45534e</span>      <span class="mi">4889542418</span>          <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455353</span>      <span class="no">eb0c</span>                <span class="no">JMP</span> <span class="mi">0x455361</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455355</span>      <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x455357</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455357</span>      <span class="mi">488</span><span class="no">b6c2448</span>          <span class="no">MOVQ</span> <span class="mi">0x48</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45535c</span>      <span class="mi">4883</span><span class="no">c450</span>            <span class="no">ADDQ</span> <span class="no">$0x50</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455360</span>      <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl">        <span class="nf">for</span> <span class="no">_</span><span class="p">,</span> <span class="no">n</span> <span class="p">:</span><span class="err">=</span> <span class="no">range</span> <span class="no">bs</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455361</span>      <span class="mi">488</span><span class="no">b542420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>   <span class="c1"># DX=0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455366</span>      <span class="mi">4839542418</span>          <span class="no">CMPQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># DX 与 bs.len 循环判断条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45536b</span>      <span class="mi">7</span><span class="no">f02</span>                <span class="no">JG</span> <span class="mi">0x45536f</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45536d</span>      <span class="no">eb2e</span>                <span class="no">JMP</span> <span class="mi">0x45539d</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45536f</span>      <span class="mi">488</span><span class="no">b542430</span>          <span class="no">MOVQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455374</span>      <span class="mi">4803542420</span>          <span class="no">ADDQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455379</span>      <span class="mi">0</span><span class="no">fb602</span>              <span class="no">MOVZX</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">AX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45537c</span>      <span class="mi">88442417</span>            <span class="no">MOVB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0x17</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">_</span> <span class="err">=</span> <span class="no">is</span><span class="p">[</span><span class="no">n</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455380</span>      <span class="mi">488</span><span class="no">b4c2460</span>          <span class="no">MOVQ</span> <span class="mi">0x60</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455385</span>      <span class="mi">4839</span><span class="no">c1</span>              <span class="no">CMPQ</span> <span class="no">AX</span><span class="p">,</span> <span class="no">CX</span>     <span class="c1"># 越界判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455388</span>      <span class="mi">7702</span>                <span class="no">JA</span> <span class="mi">0x45538c</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45538a</span>      <span class="no">eb13</span>                <span class="no">JMP</span> <span class="mi">0x45539f</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45538c</span>      <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x45538e</span>
</span></span><span class="line"><span class="cl">        <span class="nf">for</span> <span class="no">_</span><span class="p">,</span> <span class="no">n</span> <span class="p">:</span><span class="err">=</span> <span class="no">range</span> <span class="no">bs</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45538e</span>      <span class="mi">488</span><span class="no">b542420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455393</span>      <span class="mi">48</span><span class="no">ffc2</span>              <span class="no">INCQ</span> <span class="no">DX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455396</span>      <span class="mi">4889542420</span>          <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45539b</span>      <span class="no">ebc4</span>                <span class="no">JMP</span> <span class="mi">0x455361</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45539d</span>      <span class="no">ebb8</span>                <span class="no">JMP</span> <span class="mi">0x455357</span>
</span></span><span class="line"><span class="cl">            <span class="nf">_</span> <span class="err">=</span> <span class="no">is</span><span class="p">[</span><span class="no">n</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45539f</span>      <span class="mi">90</span>                  <span class="no">NOPL</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4553a0</span>      <span class="no">e81bd3ffff</span>          <span class="no">CALL</span> <span class="no">runtime.panicIndex</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4553a5</span>      <span class="mi">90</span>                  <span class="no">NOPL</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>可以试着在for循环前加上这么一句<code>is = is[:256]</code>来告诉编译器新is的长度为256，最大索引值为255，不会超过byte的最大值，因为<code>is[n]</code>从逻辑上来说是一定不会越界的。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f00</span><span class="p">(</span><span class="nx">is</span> <span class="p">[]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">bs</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">is</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">256</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">is</span> <span class="p">=</span> <span class="nx">is</span><span class="p">[:</span><span class="mi">256</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">bs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">_</span> <span class="p">=</span> <span class="nx">is</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="c1">// 不需要做边界检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span>  <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl"><span class="nf">TEXT</span> <span class="no">main.f00</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span> <span class="err">/</span><span class="no">mnt</span><span class="err">/</span><span class="no">hgfs</span><span class="err">/</span><span class="no">g</span><span class="err">/</span><span class="no">hello1</span><span class="err">/</span><span class="no">t1.go</span>
</span></span><span class="line"><span class="cl"><span class="nf">func</span> <span class="no">f00</span><span class="p">(</span><span class="no">is</span> <span class="p">[]</span><span class="no">int</span><span class="p">,</span> <span class="no">bs</span> <span class="p">[]</span><span class="no">byte</span><span class="p">)</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552e0</span>      <span class="mi">4883</span><span class="no">ec50</span>            <span class="no">SUBQ</span> <span class="no">$0x50</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552e4</span>      <span class="mi">48896</span><span class="no">c2448</span>          <span class="no">MOVQ</span> <span class="no">BP</span><span class="p">,</span> <span class="mi">0x48</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552e9</span>      <span class="mi">488</span><span class="no">d6c2448</span>          <span class="no">LEAQ</span> <span class="mi">0x48</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552ee</span>      <span class="mi">4889442458</span>          <span class="no">MOVQ</span> <span class="no">AX</span><span class="p">,</span> <span class="mi">0x58</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552f3</span>      <span class="mi">48895</span><span class="no">c2460</span>          <span class="no">MOVQ</span> <span class="no">BX</span><span class="p">,</span> <span class="mi">0x60</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552f8</span>      <span class="mi">48894</span><span class="no">c2468</span>          <span class="no">MOVQ</span> <span class="no">CX</span><span class="p">,</span> <span class="mi">0x68</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4552fd</span>      <span class="mi">48897</span><span class="no">c2470</span>          <span class="no">MOVQ</span> <span class="no">DI</span><span class="p">,</span> <span class="mi">0x70</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455302</span>      <span class="mi">4889742478</span>          <span class="no">MOVQ</span> <span class="no">SI</span><span class="p">,</span> <span class="mi">0x78</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455307</span>      <span class="mi">4</span><span class="no">c89842480000000</span>    <span class="no">MOVQ</span> <span class="no">R8</span><span class="p">,</span> <span class="mi">0x80</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">if</span> <span class="no">len</span><span class="p">(</span><span class="no">is</span><span class="p">)</span> <span class="err">&gt;=</span> <span class="mi">256</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45530f</span>      <span class="mi">48895</span><span class="no">c2428</span>          <span class="no">MOVQ</span> <span class="no">BX</span><span class="p">,</span> <span class="mi">0x28</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455314</span>      <span class="mi">4881</span><span class="no">fb00010000</span>      <span class="no">CMPQ</span> <span class="no">$0x100</span><span class="p">,</span> <span class="no">BX</span>     <span class="c1"># 256 与 is.len 比较
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45531b</span>      <span class="mi">7</span><span class="no">d02</span>                <span class="no">JGE</span> <span class="mi">0x45531f</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45531d</span>      <span class="no">eb54</span>                <span class="no">JMP</span> <span class="mi">0x455373</span>
</span></span><span class="line"><span class="cl">        <span class="nf">is</span> <span class="err">=</span> <span class="no">is</span><span class="p">[:</span><span class="mi">256</span><span class="p">]</span>       <span class="c1">// 消除边界检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45531f</span>      <span class="mi">488</span><span class="no">b542468</span>          <span class="no">MOVQ</span> <span class="mi">0x68</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>   <span class="c1"># DX=is.cap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455324</span>      <span class="mi">4881</span><span class="no">fa00010000</span>      <span class="no">CMPQ</span> <span class="no">$0x100</span><span class="p">,</span> <span class="no">DX</span>     <span class="c1"># 256 与 is.cap 比较
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45532b</span>      <span class="mi">7305</span>                <span class="no">JAE</span> <span class="mi">0x455332</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45532d</span>      <span class="no">e993000000</span>          <span class="no">JMP</span> <span class="mi">0x4553c5</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455332</span>      <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x455334</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455334</span>      <span class="mi">48</span><span class="no">c744246000010000</span>  <span class="no">MOVQ</span> <span class="no">$0x100</span><span class="p">,</span> <span class="mi">0x60</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># is.len=256
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">for</span> <span class="no">_</span><span class="p">,</span> <span class="no">n</span> <span class="p">:</span><span class="err">=</span> <span class="no">range</span> <span class="no">bs</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45533d</span>      <span class="mi">488</span><span class="no">b542470</span>          <span class="no">MOVQ</span> <span class="mi">0x70</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>   <span class="c1"># DX=bs.data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455342</span>      <span class="mi">488</span><span class="no">b5c2478</span>          <span class="no">MOVQ</span> <span class="mi">0x78</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BX</span>   <span class="c1"># BX=bs.len
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455347</span>      <span class="mi">488</span><span class="no">bb42480000000</span>    <span class="no">MOVQ</span> <span class="mi">0x80</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">SI</span>   <span class="c1"># SI=bs.cap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45534f</span>      <span class="mi">4889542430</span>          <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455354</span>      <span class="mi">48895</span><span class="no">c2438</span>          <span class="no">MOVQ</span> <span class="no">BX</span><span class="p">,</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455359</span>      <span class="mi">4889742440</span>          <span class="no">MOVQ</span> <span class="no">SI</span><span class="p">,</span> <span class="mi">0x40</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45535e</span>      <span class="mi">48</span><span class="no">c744242000000000</span>  <span class="no">MOVQ</span> <span class="no">$0x0</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455367</span>      <span class="mi">488</span><span class="no">b542438</span>          <span class="no">MOVQ</span> <span class="mi">0x38</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>   <span class="c1"># DX=bs.len
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45536c</span>      <span class="mi">4889542418</span>          <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455371</span>      <span class="no">eb0c</span>                <span class="no">JMP</span> <span class="mi">0x45537f</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455373</span>      <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x455375</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x455375</span>      <span class="mi">488</span><span class="no">b6c2448</span>          <span class="no">MOVQ</span> <span class="mi">0x48</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">BP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45537a</span>      <span class="mi">4883</span><span class="no">c450</span>            <span class="no">ADDQ</span> <span class="no">$0x50</span><span class="p">,</span> <span class="no">SP</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45537e</span>      <span class="no">c3</span>                  <span class="no">RET</span>
</span></span><span class="line"><span class="cl">        <span class="nf">for</span> <span class="no">_</span><span class="p">,</span> <span class="no">n</span> <span class="p">:</span><span class="err">=</span> <span class="no">range</span> <span class="no">bs</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45537f</span>      <span class="mi">488</span><span class="no">b542420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>   <span class="c1"># DX=0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455384</span>      <span class="mi">4839542418</span>          <span class="no">CMPQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x18</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>   <span class="c1"># 0 与 bs.len 比较
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455389</span>      <span class="mi">7</span><span class="no">f02</span>                <span class="no">JG</span> <span class="mi">0x45538d</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45538b</span>      <span class="no">eb2e</span>                <span class="no">JMP</span> <span class="mi">0x4553bb</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45538d</span>      <span class="mi">488</span><span class="no">b542430</span>          <span class="no">MOVQ</span> <span class="mi">0x30</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>   <span class="c1"># DX=bs.data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455392</span>      <span class="mi">4803542420</span>          <span class="no">ADDQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>   <span class="c1"># DX=0+DX
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x455397</span>      <span class="mi">0</span><span class="no">fb602</span>              <span class="no">MOVZX</span> <span class="mi">0</span><span class="p">(</span><span class="no">DX</span><span class="p">),</span> <span class="no">AX</span>     <span class="c1"># AX=*bs.data
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x45539a</span>      <span class="mi">88442417</span>            <span class="no">MOVB</span> <span class="no">AL</span><span class="p">,</span> <span class="mi">0x17</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">_</span> <span class="err">=</span> <span class="no">is</span><span class="p">[</span><span class="no">n</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x45539e</span>      <span class="mi">488</span><span class="no">b4c2460</span>          <span class="no">MOVQ</span> <span class="mi">0x60</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">CX</span>   <span class="c1"># CX=256
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4553a3</span>      <span class="mi">4839</span><span class="no">c1</span>              <span class="no">CMPQ</span> <span class="no">AX</span><span class="p">,</span> <span class="no">CX</span>         <span class="c1"># 越界判断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4553a6</span>      <span class="mi">7702</span>                <span class="no">JA</span> <span class="mi">0x4553aa</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4553a8</span>      <span class="no">eb13</span>                <span class="no">JMP</span> <span class="mi">0x4553bd</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4553aa</span>      <span class="no">eb00</span>                <span class="no">JMP</span> <span class="mi">0x4553ac</span>
</span></span><span class="line"><span class="cl">        <span class="nf">for</span> <span class="no">_</span><span class="p">,</span> <span class="no">n</span> <span class="p">:</span><span class="err">=</span> <span class="no">range</span> <span class="no">bs</span> <span class="err">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4553ac</span>      <span class="mi">488</span><span class="no">b542420</span>          <span class="no">MOVQ</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">),</span> <span class="no">DX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4553b1</span>      <span class="mi">48</span><span class="no">ffc2</span>              <span class="no">INCQ</span> <span class="no">DX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4553b4</span>      <span class="mi">4889542420</span>          <span class="no">MOVQ</span> <span class="no">DX</span><span class="p">,</span> <span class="mi">0x20</span><span class="p">(</span><span class="no">SP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4553b9</span>      <span class="no">ebc4</span>                <span class="no">JMP</span> <span class="mi">0x45537f</span>
</span></span><span class="line"><span class="cl"><span class="err">}</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4553bb</span>      <span class="no">ebb8</span>                <span class="no">JMP</span> <span class="mi">0x455375</span>
</span></span><span class="line"><span class="cl">            <span class="nf">_</span> <span class="err">=</span> <span class="no">is</span><span class="p">[</span><span class="no">n</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4553bd</span>      <span class="mi">0</span><span class="no">f1f00</span>              <span class="no">NOPL</span> <span class="mi">0</span><span class="p">(</span><span class="no">AX</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4553c0</span>      <span class="no">e8fbd2ffff</span>          <span class="no">CALL</span> <span class="no">runtime.panicIndex</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">is</span> <span class="err">=</span> <span class="no">is</span><span class="p">[:</span><span class="mi">256</span><span class="p">]</span>       <span class="c1">// 消除边界检查
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="err">0</span><span class="nf">x4553c5</span>      <span class="no">b900010000</span>          <span class="no">MOVL</span> <span class="no">$0x100</span><span class="p">,</span> <span class="no">CX</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4553ca</span>      <span class="no">e871d3ffff</span>          <span class="no">CALL</span> <span class="no">runtime.panicSliceAcap</span><span class="p">(</span><span class="no">SB</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">x4553cf</span>      <span class="mi">90</span>                  <span class="no">NOPL</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://heliu.site/tags/golang/">Golang</a></li>
      <li><a href="https://heliu.site/tags/%E5%88%87%E7%89%87/">切片</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://heliu.site/posts/golang/slice/theory/">
    <span class="title">« 上一页</span>
    <br>
    <span>Slice(原理)</span>
  </a>
  <a class="next" href="https://heliu.site/posts/golang/slice/append/">
    <span class="title">下一页 »</span>
    <br>
    <span>append()</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        本站总访问量<span id="busuanzi_value_site_pv"></span>次
    </span>
    <span id="busuanzi_container_site_uv">
        本站访客数<span id="busuanzi_value_site_uv"></span>人次
    </span>
    </div>
        <span>Copyright © 2020-2024 <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
