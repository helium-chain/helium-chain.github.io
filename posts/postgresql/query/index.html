<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>查询 | Helium</title>
<meta name="keywords" content="pgsql">
<meta name="description" content="Query">
<meta name="author" content="helium">
<link rel="canonical" href="https://helium.github.io/posts/postgresql/query/">
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<meta name="referrer" content="no-referrer-when-downgrade">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<link rel="icon" href="https://helium.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://helium.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://helium.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://helium.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://helium.github.io/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://helium.github.io/posts/postgresql/query/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jetbrains-mono@1.0.6/css/jetbrains-mono-nl.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css" />
    <link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/style.css" />
    <style>
        body {
            font-family: "LXGW WenKai Lite", sans-serif;
            font-family: "LXGW WenKai Screen", sans-serif;
        }
    </style>
</head>
</html>

  

<meta property="og:title" content="查询" />
<meta property="og:description" content="Query" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://helium.github.io/posts/postgresql/query/" />
<meta property="og:image" content="https://helium.github.io/favicon-32x32.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-09-18T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-09-18T00:00:00+00:00" /><meta property="og:site_name" content="Helium" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://helium.github.io/favicon-32x32.png" />
<meta name="twitter:title" content="查询"/>
<meta name="twitter:description" content="Query"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Article",
      "item": "https://helium.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "PostgreSQL",
      "item": "https://helium.github.io/posts/postgresql/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "查询",
      "item": "https://helium.github.io/posts/postgresql/query/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "查询",
  "name": "查询",
  "description": "Query",
  "keywords": [
    "pgsql"
  ],
  "articleBody": " SQL 语句不分区大小写，但是通常将关键字（SELECT、 FROM 等）进行大写，其他内容使 用小写，便于阅读。 简单查询 单表查询 查询员工姓氏。 SELECT first_name, last_name FROM employees; 查询员工薪水。 SELECT first_name, last_name, salary * 12 AS annual_income FROM employees; 查询所有数据。(在实际项目中，应该避免使用 SELECT *，因为应用程序可能并不需要全部的字段，而且表 结构可能会发生改变，明确指定的字段名称可以减少不确定性。) SELECT * FROM employees; 无表查询 有的时候，我们可能会遇到这样的查询语句： SELECT 2 + 3; 去重 查询员工表中的部门编号(去重)。 注意：NULL 的结果并没有去重。 SELECT DISTINCT department_id FROM employees; 注释 在 PostgreSQL 中，以两个连字符（–）开始，直到这一行结束的内容表示注释： -- 这是标准 SQL 注释方式 SELECT DISTINCT first_name FROM employees; 注释的内容会在语法分析之前替换成空格，因此不会被服务器执行。另外， PostgreSQL 还 支持 C 语言风格的注释方法（/* … */）。例如：(注释允许嵌套) SELECT DISTINCT first_name /* 这是一个多行注释， DISTINCT 表示排除重复值 /* 这是一个嵌套的注释 */ */ FROM employees; 条件查询 WHERE WHERE 子句的语法如下： SELECT column1, column2, ... FROM table WHERE conditions; 查询薪水为 10000 的员工。 SELECT first_name, last_name, salary FROM employees WHERE salary = 10000; PostgreSQL 提供了以下比较运算符。 运算符 描述 示例 = 等于 manager_id = 100 != 不等于 department_id != 50 \u003c\u003e 不等于 job_id \u003c\u003e ‘SA_REP’ \u003e 大于 salary \u003e 10000 \u003e= 大于等于 hire_date \u003e= ‘2007-01-01’ \u003c 小于 salary \u003c 15000 \u003c= 小于等于 employee_id \u003c= 123 BETWEEN 位于范围之内(包含两端的值) salary BETWEEN 10000 AND 15000 IN 属于列表之中 job_id IN (‘AC_MGR’, ‘HR_REP’, ‘IT_PROG’) SELECT first_name, last_name, salary FROM employees WHERE salary BETWEEN 11000 AND 12000; 模式匹配 LIKE 查询姓氏（last_name）以“Kin”开头的员工。 百分号（%）可以匹配零个或者多个任意字符。 下划线（_）可以匹配一个任意字符。 例如： “%en”匹配以“en”结束的字符串。 “%en%”匹配包含“en”的字符串。 “B_g”匹配“Big”、 “Bug”等。 SELECT first_name, last_name FROM employees WHERE last_name LIKE'Kin%'; 如果字符串中存在这两个通配符（%或_），可以在它们前面加上一个反斜杠（\\）进行转义。 SELECT 1 WHERE 'this is 25%' LIKE'%25\\%'; 也可以通过 ESCAPE 子句指定其他的转义字符。 SELECT 1 WHERE 'this is 25%' LIKE'%25@%' ESCAPE'@'; NOT LIKE NOT LIKE 运算符匹配与 LIKE 相反的结果。 SELECT first_name, last_name FROM employees WHERE last_name NOT LIKE'Kin%'; LIKE 运算符区分大小写， PostgreSQL 同时还提供了不区分大小写的 ILIKE 运算符。 SELECT first_name, last_name FROM employees WHERE last_name LIKE'kin%'; 更多参看官方文档：https://www.postgresql.org/docs/current/functions-matching.html 空值判断 根据 SQL 标准，空值使用 NULL 表示。 空值是一个特殊值，代表了未知数据。 如果使用常规的比较运算符与 NULL 进行比较，总是返回空值。 NULL = 0; -- 结果为空值 NULL = NULL; -- 结果为空值 NULL != NULL; -- 结果为空值 IS NULL 查询部门编号为空的员工。 SELECT first_name, last_name, department_id FROM employees WHERE department_id IS NULL; IS NOT NULL 查询部门编号不为空的员工。 SELECT first_name, last_name, department_id FROM employees WHERE department_id IS NOT NULL; 复杂条件 WHERE 子句可以包含多个条件，使用逻辑运算符（AND、 OR、 NOT）将它们进行组合，并根据最终的逻辑值进行过滤。 AND AND（逻辑与）运算符的逻辑真值表如下： 对于 AND 运算符，只有当它两边的结果都为真时，最终结果才为真。 否则最终结果为假，不返回结果。 对于 AND 运算符，只有当它两边的结果都为真时，最终结果才为真；否则最终结果为假，不返回结果。 TRUE FALSE NULL TRUE TRUE FALSE NULL FALSE FALSE FALSE FALSE NULL NULL FALSE NULL 查询返回薪水为 10000，并且姓氏为“King”的员工。 SELECT first_name, last_name, salary FROM employees WHERE salary = 10000 AND last_name = 'King'; OR OR（逻辑或）运算符的逻辑真值表如下： OR 逻辑或运算符只要有一个条件为真，结果就为真。 TRUE FALSE NULL TRUE TRUE TRUE TRUE FALSE TRUE FALSE NULL NULL TRUE NULL NULL 查询返回薪水为 10000，或者姓氏为“King”的员工。 SELECT first_name, last_name, salary FROM employees WHERE salary = 10000 OR last_name = 'King'; NOT NOT（逻辑非） 运算符用于取反操作，它的逻辑真值表如下： NOT TRUE FALSE FALSE TRUE NULL NULL 注意，对于未知的 NULL 值，经过 NOT 处理之后仍然是未知值。 除此之外， NOT 还可以结合前面介绍的运算符一起使用： NOT BETWEEN，位于范围之外。 NOT IN，不在列表之中。 NOT LIKE，不匹配模式。 NOT IS NULL，不为空，等价于 IS NOT NULL。 最后，当查询条件包含复杂逻辑时，它们的运算优先级从高到低排列如下： | 条件运算符 | 描述 | | =, !=, \u003c\u003e, \u003c, \u003c=, \u003e, \u003e= | 比较运算 | | IS [NOT] NULL, [NOT] LIKE, [NOT] BETWEEN, [NOT] IN, [NOT] EXISTS | 比较运算 | | NOT | 逻辑否定 | | AND | 逻辑与 |\n注意 对于逻辑运算符 AND 和 OR，需要注意的是，它们使用短路运算。 也就是说，只要前面的表达式能够决定最终的结果，不进行后面的计算。 这样能够提高运算效率。因此，以下语句不会产生除零错误： SELECT 1 WHERE 1 = 0 AND 1/0 = 1; SELECT 1 WHERE 1 = 1 OR 1/0 = 1; 还需要注意的一个问题是，当我们组合 AND 和 OR 运算符时， AND 运算符优先级更高，总是先执行。 由于 AND 优先级高，查询返回的是薪水为 24000 并且姓氏为“King”的员工，或者薪水为10000 的员工。 SELECT first_name, last_name, salary FROM employees WHERE salary = 10000 OR salary = 24000 AND last_name = 'King'; 如果相要返回姓氏为“King”，并且薪水为 10000 或 24000 的员工，可以使用括号修改优先级。 SELECT first_name, last_name, salary FROM employees WHERE ( salary = 10000 OR salary = 24000 ) AND last_name = 'King'; 排序 单列排序 单列排序是指按照某个字段或者表达式进行排序，用法如下： ORDER BY 表示按照某个字段进行排序， ASC 表示升序排序（Ascending）， DESC 表示降序排序（Descending），默认值为 ASC。 SELECT column1, column2, ... FROM table ORDER BY column1 [ASC | DESC]; 查询部门编号为 60 的员工，并且按照薪水从高到低进行排序显示。 SELECT first_name, last_name, salary FROM employees WHERE department_id = 60 ORDER BY salary DESC; 多列排序 对于单列排序，有可能存在多个数据值相同的情况。此时，可以再指定其他的排序字段进行处理。 首先基于第一个排序字段进行排序，对于可能存在的相同值，再基于第二个字段进行排序，依此类推。 SELECT column1, column2, ... FROM table ORDER BY column1 ASC, column2 DESC, ...; 查询返回部门编号为 60 的员工，并且按照薪水从高到低进行排序显示，如果薪水相同，再按照名字（first_name）降序排列。 SELECT first_name, last_name, salary FROM employees WHERE department_id = 60 ORDER BY salary DESC, first_name DESC; ORDER BY 后的排序字段可以是 SELECT 列表中没有的字段。以下语句返回了员工的姓名和薪水，按照入职先后进行显示。 -- 默认升序 ASC SELECT first_name, last_name, salary FROM employees ORDER BY hire_date; 除了在 ORDER BY 后指定字段名或者表达式之外，也可以简单的使用它们在 SELECT 列表中出现的顺序来表示。 -- 默认升序 ASC SELECT first_name, last_name, salary FROM employees ORDER BY 1, 3; PostgreSQL 对于字符类型的数据进行排序时不区分大小写，“CAT”和“cat”顺序相同。 CREATE TABLE tbl_char(c1 varchar(10)); INSERT INTO tbl_char VALUES('CAT'), ('cat'), ('dog'); SELECT * FROM tbl_char ORDER BY c1; 空值排序 在 SQL 中，空值是一个特殊的值，使用 NULL 表示。 SELECT first_name, last_name, commission_pct FROM employees WHERE first_name = 'Peter' ORDER BY commission_pct; PostgreSQL 支持使用 NULLS FIRST（空值排在最前）和 NULLS LAST（空值排在最后）指定空值的排序位置；升序排序时默认为 NULLS LAST，降序排序时默认为 NULLS FIRST。 我们修改上面的示例，将“Peter Vargas”排在最前，但仍然按照佣金百分比进行升序显示。 SELECT first_name, last_name, commission_pct FROM employees WHERE first_name = 'Peter' ORDER BY commission_pct NULLS FIRST; 限定结果数量 Top-N 这类查询通常是为了找出排名中的前 N 个记录，例如以下语句查询薪水最高的前 10 名员工，使用 FETCH 语法： SELECT first_name, last_name, salary FROM employees ORDER BY salary DESC FETCH FIRST 10 ROWS ONLY; 其中，FIRST 也可以写成 NEXT，ROWS 也可以写成 ROW。结果返回了排序之后的前 10 条记录。 SELECT first_name, last_name, salary FROM employees ORDER BY salary DESC FETCH NEXT 10 ROW ONLY; 使用 LIMIT 语法也可以实现相同的功能。 SELECT first_name, last_name, salary FROM employees ORDER BY salary DESC LIMIT 10; 分页 SQL 实现这种功能需要引入另一个子句：OFFSET。 假设我们的应用提供了分页显示，每页显示 10 条记录。现在用户点击了下一页，需要显示第 11 到第 20 条记录。使用标准 SQL 语法实现如下： OFFSET 表示先忽略掉多少行数据，然后再返回后面的结果。 ROWS 也可以写成 ROW。 对于应用程序而言，只需要传入不同的 OFFSET 偏移量和FETCH 数量，就可以在结果中任意导航。 SELECT first_name, last_name, salary FROM employees ORDER BY salary DESC OFFSET 10 ROWS FETCH FIRST 10 ROWS ONLY; 使用 LIMIT 加上 OFFSET 同样可以实现分页效果。(不支持 LIMIT 10, 10) SELECT first_name, last_name, salary FROM employees ORDER BY salary DESC LIMIT 10 OFFSET 10; 注意 我们先看一下完整的 FETCH 和 LIMIT 语法： SELECT column1, column2, ... FROM table [WHERE conditions] [ORDER BY column1 ASC, column2 DESC, ...] [OFFSET m {ROW | ROWS}] [FETCH { FIRST | NEXT } [ num_rows] { ROW | ROWS } ONLY]; SELECT column1, column2, ... FROM table [WHERE conditions] [ORDER BY column1 ASC, column2 DESC, ...] [LIMIT { num_rows| ALL } ] [OFFSET m {ROW | ROWS}]; 在使用以上功能时需要注意以下问题： FETCH 是标准 SQL 语法， LIMIT 是 PostgreSQL 扩展语法。 如果没有指定 ORDER BY，限定数量之前并没有进行排序，是一个随意的结果。 OFFSET 偏移量必须为 0 或者正整数。默认为 0， NULL 等价于 0。 FETCH 限定的数量必须为 0 或者正整数。默认为 1， NULL 等价于不限定数量。 LIMIT 限定的数量必须为 0 或者正整数， 没有默认值。ALL 或者 NULL 表示不限定数量。 随着 OFFSET 的增加，查询的性能会越来越差。因为服务器需要计算更多的偏移量，即使这些数据不需要被返回前端。 分组 聚合函数 聚合函数（aggregate function）针对一组数据行进行运算，并且返回单个结果。 PostgreSQL支持以下常见的聚合函数： AVG - 计算一组值的平均值。 COUNT - 统计一组值的数量。 MAX - 计算一组值的最大值。 MIN - 计算一组值的最小值。 SUM - 计算一组值的和值。 STRING_AGG - 连接一组字符串。 查询 IT 部门所有员工的平均薪水、员工总数、最高薪水、最低薪水、以及薪水总计： SELECT AVG ( salary ), COUNT ( * ), MAX ( salary ), MIN ( salary ), SUM ( salary ) FROM employees WHERE department_id = 60; 关于聚合函数，需要注意两点： 函数参数前添加 DISTINCT 关键字，可以在计算时排除重复值。 忽略参数中的 NULL 值。 SELECT COUNT ( * ), COUNT ( DISTINCT salary ), COUNT ( commission_pct ) FROM employees WHERE department_id = 60; PostgreSQL 为聚合函数提供了一个 FILTER 扩展选项，可以用于汇总满足特定条件的数据。 其中，FILTER 选项可以指定一个 WHERE 条件，只有满足条件的数据才会进行汇总。 因此，示例中的第一个 COUNT 函数返回了月薪大于等于 10000 的员工数量， 第二个 COUNT 函数返回了月薪小于 10000 的员工数量。 SELECT COUNT ( * ) FILTER ( WHERE salary \u003e= 10000 ) high_sal, COUNT ( * ) FILTER ( WHERE salary \u003c 10000 ) low_sal FROM employees; STRING_AGG 函数将 IT 部门员工的名字使用分号进行分隔，按照薪水从高到低排序后连接成一个字符串。 SELECT STRING_AGG ( first_name, ';' ORDER BY salary DESC ) FROM employees WHERE department_id = 60; 更多聚合函数参看官方文档：https://www.postgresql.org/docs/current/functions-aggregate.html 分组聚合 每个部门内所有员工的平均薪水、员工总数、最高薪水、最低薪水、以及薪水总计。 查询执行时，首先根据 GROUP BY 子句中的列（department_id）进行分组，然后使用聚合函数汇总组内的数据。 最后一条数据是针对部门编号字段为空的数据进行的分组汇总，GROUP BY 将所有的 NULL 分为一组。 SELECT department_id, AVG ( salary ), COUNT ( * ), MAX ( salary ), MIN ( salary ), SUM ( salary ) FROM employees GROUP BY department_id ORDER BY department_id; GROUP BY 并不一定需要与聚合函数一起使用。 SELECT department_id FROM employees GROUP BY department_id ORDER BY department_id; 查询的结果就是不同的部门编号分组，这种查询的结果与 DISTINCT 效果相同。 SELECT DISTINCT department_id FROM employees ORDER BY department_id; GROUP BY 不仅可以按照一个字段进行分组，也可以使用多个字段将数据分成更多的组。 查询将员工按照不同的部门和职位组合进行分组，然后进行汇总。 SELECT department_id, job_id, AVG ( salary ), COUNT ( * ), MAX ( salary ), MIN ( salary ), SUM ( salary ) FROM employees GROUP BY department_id, job_id ORDER BY department_id, job_id; 使用了 GROUP BY 子句进行分组操作之后需要注意一点，就是 SELECT 列表中只能出现分组字段或者聚合函数，不能再出现表中的其他字段。下面是一个错误的示例： SELECT department_id, job_id, AVG ( salary ), COUNT ( * ), MAX ( salary ), MIN ( salary ), SUM ( salary ) FROM employees GROUP BY department_id; 错误的原因在于 job_id 既不是分组的条件，也不是聚合函数。查询要求按照部门进行分组汇总，但是每个部门存在多个不同的职位，数据库无法知道需要显示哪个职位编号。 分组过滤 例如找出平均薪水值大于 10000 的部门，直观的想法就是在 WHERE 子句中增加一个过滤条件，例如： 不过查询并没有返回期望的结果，而是出现了一个错误： WHERE 子句中不允许出现聚合函数。 因为在 SQL 询中，如果同时存在 WHERE 子句和 GROUP BY 子句，WHERE 子句在 GROUP BY 子句之前执行。 因此，WHERE 子句无法对分组后的结果进行过滤。 SELECT department_id, AVG ( salary ), COUNT ( * ), MAX ( salary ), MIN ( salary ), SUM ( salary ) FROM employees WHERE AVG ( salary ) \u003e 10000 GROUP BY department_id ORDER BY department_id; WHERE 子句执行时还没有进行分组计算，它只能基于分组之前的数据进行过滤。如果需要对分组后的结果进行过滤，需要使用 HAVING 子句。以上查询的正确写法如下： HAVING 出现在 GROUP BY 之后，也在它之后执行，因此能够使用聚合函数进行过滤。 SELECT department_id, AVG ( salary ), COUNT ( * ), MAX ( salary ), MIN ( salary ), SUM ( salary ) FROM employees GROUP BY department_id HAVING AVG ( salary ) \u003e 10000 ORDER BY department_id; 我们可以同时使用 WHERE 子句进行数据行的过滤，使用 HAVING 进行分组结果的过滤。 SELECT department_id, COUNT ( * ) AS headcount FROM employees WHERE salary \u003e 10000 GROUP BY department_id HAVING COUNT ( * ) \u003e 2; -- 这里 COUNT(*) 修改为 headcount 报错 高级选项 PostgreSQL 除了支持基本的 GROUP BY 分组操作之外，还支持 3 种高级的分组选项：GROUPING SETS、 ROLLUP 以及 CUBE。 GROUPING SETS 选项 GROUPING SETS 是 GROUP BY 的扩展选项，用于指定自定义的分组集。举例来说，以下是一个销售数据表： CREATE TABLE sales ( item VARCHAR(10), year VARCHAR(4), quantity INT ); INSERT INTO sales VALUES('apple', '2018', 800); INSERT INTO sales VALUES('apple', '2018', 1000); INSERT INTO sales VALUES('banana', '2018', 500); INSERT INTO sales VALUES('banana', '2018', 600); INSERT INTO sales VALUES('apple', '2019', 1200); INSERT INTO sales VALUES('banana', '2019', 1800); 按照产品（item）和年度（year）进行分组汇总时，所有可能的 4 种分组集包括： 按照产品和年度的组合进行分组； 按照产品进行分组； 按照年度进行分组； 所有数据分为一组。 可以通过以下多个查询获取所有分组集的分组结果：(将四种查询结果合并到一起) -- 按照产品和年度的组合进行分组 SELECT item, YEAR, SUM ( quantity ) FROM sales GROUP BY item, YEAR; -- 按照产品进行分组 SELECT item, NULL AS YEAR, SUM ( quantity ) FROM sales GROUP BY item; -- 按照年度进行分组 SELECT NULL AS item, YEAR, SUM ( quantity ) FROM sales GROUP BY YEAR; -- 所有数据分为一组 SELECT NULL AS item, NULL AS YEAR, SUM ( quantity ) FROM sales; 使用集合运算符（UNION ALL）将 4 个查询结果合并到一起。但是这种方法存在一些问题：首先，查询语句比较冗长，查询的次数随着分组字段的增加呈指数增长；其次，多次查询意味着需要多次扫描同一张表，存在性能上的问题。 GROUPING SETS 是 GROUP BY 的扩展选项，能够为这种查询需求提供更加简单有效的解决方法。我们使用分组集改写上面的示例： SELECT item, YEAR, SUM ( quantity ) FROM sales GROUP BY GROUPING SETS ( ( item, YEAR ), ( item ), ( YEAR ), ( ) ); GROUPING SETS 选项用于定义分组集，每个分组集都需要包含在单独的括号中，空白的括号（()）表示将所有数据当作一个组处理。 查询的结果等于前文 4 个查询的合并结果，但是语句更少，可读性更强；而且 PostgreSQL 执行时只需要扫描一次销售表，性能更加优化。 默认的 GROUP BY 使用由所有分组字段构成的一个分组集，本示例中为 ((item, year))。 CUBE 选项 随着分组字段的增加，即使通过 GROUPING SETS 列出所有可能的分组方式也会显得比较麻烦。 设想一下使用 4 个字段进行分组统计的场景，所有可能的分组集共计有 16 个。这种情况下编写查询语句仍然很复杂，为此 PostgreSQL 提供了简写形式的 GROUPING SETS：CUBE和ROLLUP。 CUBE 表示所有可能的分组集，例如： CUBE ( c1, c2, c3 ); -- 等价于： GROUPING SETS ( ( c1, c2, c3 ), ( c1, c2 ), ( c1, c3 ), ( c2, c3 ), ( c1 ), ( c2 ), ( c3 ), ( ) ); 因此，我们可以进一步将上面的示例改写如下： SELECT item, YEAR, SUM ( quantity ) FROM sales GROUP BY CUBE ( item, YEAR ); ROLLUP 选项 GROUPING SETS 第二种简写形式就是 ROLLUP，用于生成按照层级进行汇总的结果，类似于财务报表中的小计、合计和总计。例如： ROLLUP ( c1, c2, c3 ) -- 等价于： GROUPING SETS ( ( c1, c2, c3 ), ( c1, c2 ), ( c1 ), ( ) ) 查询返回按照产品和年度组合进行统计的销量小计，加上按照产品进行统计的销量合计，再加上所有销量的总计： SELECT item, YEAR, SUM ( quantity ) FROM sales GROUP BY ROLLUP ( item, YEAR ); 查看结果时，需要根据每个字段上的空值进行判断。比如第一行的产品和年度都为空，因此它是所有销量的总计。为了便于查看，可以将空值进行转换显示： COALESCE 函数返回第一个非空的参数值。 SELECT COALESCE ( item, '所有产品' ) AS \"产品\", COALESCE ( YEAR, '所有年度' ) AS \"年度\", SUM ( quantity ) AS \"销量\" FROM sales GROUP BY ROLLUP ( item, YEAR ); 可以根据需要返回按照某些组合进行统计的结果，以下查询返回按照产品和年度组合进行统计的销量小计，加上按照产品进行统计的销量合计： SELECT COALESCE ( item, '所有产品' ) AS \"产品\", COALESCE ( YEAR, '所有年度' ) AS \"年度\", SUM ( quantity ) AS \"销量\" FROM sales GROUP BY item, ROLLUP ( YEAR ); 对于 CUBE 和 ROLLUP 而言，每个元素可以是单独的字段或表达式，也可以是使用括号包含的列表。如果是括号中的列表，产生分组集时它们必须作为一个整体。例如： 因为 c1 和 c2 是一个整体， c3 和 c4 是一个整体。 CUBE ( (c1, c2), (c3, c4) ); -- 等价于 GROUPING SETS ( ( c1, c2, c3, c4 ), ( c1, c2 ), ( c3, c4 ), ( ) ); ROLLUP ( c1, (c2, c3), c4 ); -- 等价于 GROUPING SETS ( ( c1, c2, c3, c4 ), ( c1, c2, c3 ), ( c1 ), ( ) ); GROUPING 函数 区分是分组产生的 NULL 还是源数据中的 NULL。PostgreSQL 提供了一个分组函数： GROUPING。 GROUPING 函数如果只有一个参数，返回整数 0 或者 1。 如果某个统计结果使用的分组集包含了函数中的参数字段，该函数返回 0，否则返回 1。 GROUPING 函数如果包含多个参数，针对每个参数返回整数 0 或者 1，然后将它们按照二进制数值连接到一起。比如说，第1行数据中的GROUPING(item, year)结果等于GROUPING(item)和 GROUPING(year)结果的二进制数值连接，也就是 3（二进制的 11） SELECT item AS \"产品\", YEAR AS \"年度\", SUM ( quantity ) AS \"销量\", GROUPING ( item ), GROUPING ( YEAR ), GROUPING ( item, YEAR ) FROM sales GROUP BY ROLLUP ( item, YEAR ); 通过使用 GROUPING 函数，我们可以正确显示分组中的 NULL 值和源数据中的 NULL 值： SELECT CASE GROUPING( item ) WHEN 1 THEN '所有产品' ELSE item END AS \"产品\", CASE GROUPING ( YEAR ) WHEN 1 THEN '所有年度' ELSE YEAR END AS \"年度\", SUM ( quantity ) AS \"销量\" FROM sales GROUP BY ROLLUP ( item, YEAR ); CASE 条件表达式 CASE 表达式的作用就是为 SQL 语句增加类似于 IF-THEN-ELSE 的逻辑处理功能，可以根据不同的条件返回不同的结果。 PostgreSQL 支持两种形式的条件表达式：简单 CASE 表达式和搜索 CASE 表达式。 另外，为了方便空值处理，PostgreSQL 还提供了两个缩写形式的 CASE 表达式（函数）：NULLIF 和 COALEASE。 简单 CASE 表达式 简单 CASE 表达式的语法如下： CASE expression WHEN value1 THEN result1 WHEN value2 THEN result2 [...] [ELSE default_result] END; 表达式的计算过程如下所示。\n首先计算表达式（expression）的值，然后依次与 WHEN 列表中的值（value1， value2， …）进行比较。 找到第一个匹配的值，然后返回对应 THEN 列表中的结果（result1， result2， …）。 如果没有找到匹配的值，返回 ELSE 中的默认值。如果没有指定 ELSE，返回 NULL。 下面的查询使用简单 CASE 表达式统计每个部门的人数，并且转换为列的方式显示。\nSELECT SUM ( CASE department_id WHEN 10 THEN 1 ELSE 0 END ) AS dept_10_count, SUM ( CASE department_id WHEN 20 THEN 1 ELSE 0 END ) AS dept_20_count, SUM ( CASE department_id WHEN 30 THEN 1 ELSE 0 END ) AS dept_30_count FROM employees; -- | dept_10_count|dept_20_count|dept_30_count| -- |--------------|-------------|-------------| -- | 1 | 2 | 6 | 需要注意的是每个分支的结果必须具有相同的数据类型，否则会产生类型错误。 例如，以下示例对于不同条件返回的数据类型不一致： SELECT first_name, last_name, CASE department_id WHEN 10 THEN 'Administration' WHEN 20 THEN 20 WHEN 30 THEN 'Purchasing' ELSE 'Others' END AS department_name FROM employees; -- SQL 错误 [22P02]: ERROR: invalid input syntax for integer: \"Others\" Position: 183 简单 CASE 表达式在进行计算的时候，使用的是等值比较（=），能够支持简单的逻辑处理。 如果想要基于更加复杂的条件进行判断，例如根据某个列的取值范围返回不同的信息，或者判断表达式的值是否为空，都需要使用更加强大的搜索 CASE 表达式。 搜索 CASE 表达式 搜索 CASE 表达式的语法如下： CASE WHEN condition1 THEN result1 WHEN condition2 THEN result2 ... [ELSE default_result] END 表达式的计算过程如下所示。 按照顺序依次计算 WHEN 子句中的条件（condition1, condition2, …），找到第一个结果为真的分支，返回相应的结果。 如果没有任何条件为真，返回 ELSE 中的默认值；如果此时没有指定 ELSE，返回空值。 搜索 CASE 表达式可以在 WHEN 子句中构造复杂的条件，完成各种逻辑处理。首先，所有的简单 CASE 表达式都可以替换称等价的搜索CASE 表达式。我们将前面的示例改写如下： SELECT SUM ( CASE WHEN department_id = 10 THEN 1 ELSE 0 END ) AS dept_10_count, SUM ( CASE WHEN department_id = 20 THEN 1 ELSE 0 END ) AS dept_20_count, SUM ( CASE WHEN department_id = 30 THEN 1 ELSE 0 END ) AS dept_30_count FROM employees; -- | dept_10_count|dept_20_count|dept_30_count| -- |--------------|-------------|-------------| -- | 1 | 2 | 6 | 以下示例根据薪水的范围将员工的收入分为高中低三个档次： SELECT e.first_name, e.last_name, e.salary, CASE WHEN e.salary \u003c 5000 THEN '低' WHEN e.salary \u003c 15000 THEN '中' ELSE'高' END AS salary_level FROM employees e; 既然是表达式， CASE 表达式除了可以用于 SELECT 列表，也可以出现在其他 SQL 子句中，例如 WHERE 条件子句、 GROUP BY 分组子句、 ORDER BY 排序子句等。以下示例除了将薪水显示为三个档次，同时还按照档次和名字进行排序： SELECT e.first_name, e.last_name, e.salary, CASE WHEN e.salary \u003c 5000 THEN '低' WHEN e.salary \u003c 15000 THEN '中' ELSE '高' END AS salary_level FROM employees e ORDER BY CASE WHEN e.salary \u003c 5000 THEN 3 WHEN e.salary \u003c 15000 THEN 2 ELSE 1 END, first_name; 缩写函数 除了以上两种形式的 CASE 表达式之外， PostgreSQL 还提供了两个与 NULL 相关的缩写 CASE 表达式（函数）： NULLIF 和 COALEASE。 NULLIF 函数的用法如下： NULLIF 函数包含 2 个参数，如果第一个参数等于第二个参数，返回 NULL。 否则，返回第一个参数的值。 NULLIF(expression_1, expression_2) 它可以使用等价的 CASE 表达式表示为： CASE WHEN expression_1 = expression_2 THEN NULL ELSE expression_1 END 以下示例说明了 NULLIF 函数的效果： SELECT NULLIF(1, 1), NULLIF('A', 'B'); -- |nullif|nullif(1)| -- |------|---------| -- |NULL |A | NULLIF 函数的一个常见用途是防止除零错误： SELECT 1 / 0; -- 除零错误 SELECT 1 / NULLIF(0 , 0); COALEASE 函数的语法如下： COALESCE 函数接受多个参数，并且返回第一个非空的参数值。 如果所有参数都为空值，返回 NULL 值。 COALESCE(expression_1, expression_2, expression_3, ...) 它可以使用等价的 CASE 表达式表示为： CASE WHEN expression_1 IS NOT NULL THEN expression_1 WHEN expression_2 IS NOT NULL THEN expression_2 WHEN expression_3 IS NOT NULL THEN expression_3 ... END 以下示例将佣金比率为空的数据显示为 0： SELECT e.first_name, e.last_name, e.commission_pct, COALESCE ( e.commission_pct, 0 ) FROM employees e; ",
  "wordCount" : "2376",
  "inLanguage": "zh",
  "image": "https://helium.github.io/favicon-32x32.png","datePublished": "2024-09-18T00:00:00Z",
  "dateModified": "2024-09-18T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "helium"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://helium.github.io/posts/postgresql/query/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Helium",
    "logo": {
      "@type": "ImageObject",
      "url": "https://helium.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://helium.github.io/" accesskey="h" title="Blog (Alt + H)">
                <img src="https://helium.github.io/helium.png" alt="" aria-label="logo"
                    height="35">Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://helium.github.io/" title="主页">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/posts" title="文章">
                    <span>Article</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/archives" title="时间轴">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/tags/" title="标签">
                    <span>Tag</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/search/" title="搜索 (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://helium.github.io/support" title="打赏">
                    <span>🫶Help</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">


<article class="post" autonumbering>
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://helium.github.io/">主页</a>&nbsp;»&nbsp;<a href="https://helium.github.io/posts/">Article</a>&nbsp;»&nbsp;<a href="https://helium.github.io/posts/postgresql/">PostgreSQL</a></div>
    <h1 class="post-title entry-hint-parent">
      查询
    </h1>
    <div class="post-meta">










<span class="x-post-meta-item"><svg t="1720837714681" class="icon" viewBox="0 0 1084 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7520" width="200" height="200"><path d="M123.47509 1023.984942a123.565437 123.565437 0 0 1-123.505206-123.32451V243.863302A123.565437 123.565437 0 0 1 123.47509 120.568908h171.630374V26.06529a26.050232 26.050232 0 0 1 52.070349 0v94.503618h377.592848V26.06529a26.050232 26.050232 0 0 1 52.100464 0v94.503618h183.797189A123.565437 123.565437 0 0 1 1084.171519 243.863302v656.79713A123.565437 123.565437 0 0 1 960.666314 1023.984942H123.47509z m-71.404741-123.32451A71.434857 71.434857 0 0 0 123.47509 971.974825h837.191224a71.434857 71.434857 0 0 0 71.404741-71.314393V442.326922l-946.361273-3.824716a25.598494 25.598494 0 0 1-5.84248-0.692665l-27.796953-6.444798v469.295689zM123.47509 172.579025a71.434857 71.434857 0 0 0-71.404741 71.284277v149.736133l27.796953-6.444797a26.080348 26.080348 0 0 1 5.902712-0.662549l946.301041 3.824716V243.863302a71.404741 71.404741 0 0 0-71.404741-71.284277h-180.183284l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.261043 26.261043 0 0 1-23.520499-14.786895l-6.173754-12.859479H350.819834l-6.173754 12.859479a26.200812 26.200812 0 0 1-23.490383 14.786895 26.230928 26.230928 0 0 1-23.520499-14.786895l-6.173755-12.859479H123.47509z m156.150814 578.827128a26.050232 26.050232 0 0 1-26.050232-25.990001c0-14.335157 11.68496-26.020116 26.050232-26.020116h521.697312c14.365273 0 26.050232 11.68496 26.050233 26.020116a26.050232 26.050232 0 0 1-26.050233 25.990001H279.625904z" fill="#3D3F42" p-id="7521"></path></svg><span>2024-09-18</span></span>&nbsp;<span class="x-post-meta-item"><svg t="1720839329181" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14106" width="200" height="200"><path d="M699.270662 190.485379c-0.411369 0-0.821715 0.011256-1.227967 0.032746H507.034407a23.041786 23.041786 0 0 0-1.221828-0.031723c-12.779048 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.360975 23.141046 23.140023 23.141046v0.032746h193.458083v-0.032746c12.780071 0 23.141046-10.359952 23.141047-23.141046 0-12.780071-10.360975-23.140023-23.141047-23.140023zM979.215516 724.005508c0-142.090159-115.186416-257.277598-257.277598-257.277598-72.245418 0-137.532353 29.777187-184.262654 77.725223l45.868677 31.474852c36.227086-33.873482 84.882226-54.617945 138.393977-54.617945 111.945605 0 202.696492 90.750887 202.696492 202.695468h-43.01263l70.331835 104.289228 70.331835-104.289228H979.215516z" fill="" p-id="14107"></path><path d="M748.885664 588.843132c0-14.881942-12.06785-26.945699-26.947746-26.945698-14.883989 0-26.947745 12.063757-26.947745 26.945698v135.164423c0 14.879895 12.063757 26.945699 26.947745 26.945699h107.786889c14.881942 0 26.945699-12.063757 26.945698-26.945699s-12.063757-26.945699-26.945698-26.945699h-80.839143V588.843132zM721.937918 926.702c-111.947651 0-202.696492-90.74884-202.696492-202.696492 0-0.144286 0.004093-0.285502 0.004094-0.429788h43.004443l-70.330812-104.289228-70.331835 104.289228h43.075051c0 0.144286-0.00307 0.285502-0.00307 0.429788 0 142.091182 115.187439 257.279644 257.278621 257.279645 72.241324 0 137.530306-29.77821 184.260607-77.727269l-45.86663-31.474852c-36.227086 33.873482-84.884272 54.618968-138.393977 54.618968zM694.633039 423.38066c-1.354857-11.487635-11.120268-20.400632-22.972201-20.400632H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.138999 0 12.781094 10.359952 23.141046 23.140023 23.141047H596.949252c30.209022-13.81668 63.104223-22.76754 97.683787-25.879414zM438.548616 623.143333H206.362486c-12.780071 0-23.140023 10.358929-23.140023 23.140023 0 12.780071 10.359952 23.140023 23.140023 23.140023h219.956598a298.463626 298.463626 0 0 1 12.229532-46.280046zM506.934123 513.062192H206.362486c-12.780071 0-23.140023 10.359952-23.140023 23.139 0 12.781094 10.359952 23.140023 23.140023 23.140023H469.936487a302.241672 302.241672 0 0 1 36.997636-46.279023z" fill="" p-id="14108"></path><path d="M442.765661 835.277778a298.531164 298.531164 0 0 1-14.365173-46.150087H146.542052v-0.065491c-33.036417 0-59.81941-26.78197-59.81941-59.819411V329.36031h704.907545v100.905154a298.561863 298.561863 0 0 1 46.150086 14.996552V194.619536h-0.162706c0-53.422723-43.307342-96.728018-96.730065-96.728018h-68.89409V84.418668c0-33.037441-26.782993-59.81941-59.81941-59.81941v-0.361227h-18.87079v0.032745c-33.038464 0-59.820434 26.78197-59.820433 59.819411 0 0.109494 0.008186 0.218988 0.008186 0.328481h-0.339738v13.47285H345.203648V84.418668c0-33.037441-26.782993-59.81941-59.819411-59.81941v-0.361227h-18.872836v0.032745c-33.036417 0-59.81941 26.78197-59.81941 59.819411 0 0.109494 0.007163 0.218988 0.008186 0.328481h-0.339737v13.47285h-69.189826c-53.4217 0-96.729042 43.306318-96.729041 96.728018 0 1.701758 0.045025 3.39226 0.132006 5.071505v533.785166a98.051153 98.051153 0 0 0-0.132006 5.071506c0 53.4217 43.307342 96.728018 96.729041 96.728018v0.001023h305.595047zM86.723665 204.056466c0-33.037441 26.782993-59.81941 59.819411-59.819411 0.044002 0 0.086981 0.00307 0.130983 0.00307v-0.068561h105.968473V94.874811h0.032746a22.807449 22.807449 0 0 1-0.032746-1.215688c0-12.779048 10.360975-23.140023 23.140023-23.140023s23.140023 10.360975 23.140023 23.140023c0 0.408299-0.010233 0.812505-0.031722 1.215688h0.031722v49.297776h280.508696V94.874811h0.032745a22.807449 22.807449 0 0 1-0.032745-1.215688c0-12.779048 10.361999-23.140023 23.140023-23.140023 12.780071 0 23.141046 10.360975 23.141046 23.140023 0 0.408299-0.011256 0.812505-0.032746 1.215688h0.032746v49.297776h106.10048v0.065492c33.035394 0 59.818387 26.780947 59.818387 59.81941h0.130983V283.080264H86.723665v-79.023798z" fill="" p-id="14109"></path></svg><span>2024-09-18</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select: text;">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" style="user-select: text;"></path>
    <polyline points="14 2 14 8 20 8" style="user-select: text;"></polyline>
    <line x1="16" y1="13" x2="8" y2="13" style="user-select: text;"></line>
    <line x1="16" y1="17" x2="8" y2="17" style="user-select: text;"></line>
    <polyline points="10 9 9 9 8 9" style="user-select: text;"></polyline>
</svg><span>2376字</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="12" r="9"></circle>
    <polyline points="12 7 12 12 15 15"></polyline>
</svg><span>12分钟</span></span>&nbsp;<span class="x-post-meta-item"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"
     stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <circle cx="12" cy="7" r="4"></circle>
    <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg><span>helium</span></span>
      <span class="x-post-meta-item">
        &nbsp;<svg t="1720840393161" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18680" width="200" height="200"><path d="M995.125144 559.61812l-415.998603-415.998602A52.986489 52.986489 0 0 0 541.413335 127.99957H338.847348c-3.166656-26.559911-9.286635-51.046495-17.999939-71.333094C299.734146 7.333309 271.154242 0 256.00096 0c-13.939953 0-40.439864 6.339979-61.259794 48.806503-10.473298 21.366595-17.946606 48.966502-21.573261 79.193067H53.334974a53.393154 53.393154 0 0 0-53.333154 53.333154v360.078791a52.986489 52.986489 0 0 0 15.619948 37.713206l415.998602 415.998603a53.333154 53.333154 0 0 0 75.426413 0l26.286579-26.293245 26.286578 26.293245a53.426487 53.426487 0 0 0 16.719944 11.333295 21.333262 21.333262 0 0 0 36.079879 11.293295l382.705381-382.705381a53.399821 53.399821 0 0 0 0-75.426413z m-762.070774-491.998347C241.494342 50.373164 250.667645 42.666523 256.00096 42.666523c5.99998 0 16.573278 9.639968 25.646581 30.806564 6.493312 15.159949 11.333295 33.999886 14.146619 54.526483H216.16776c3.206656-23.419921 9.013303-44.359851 16.88661-60.41313z m243.819181 897.330319a10.666631 10.666631 0 0 1-15.079949 0l-415.998603-415.998603A10.573298 10.573298 0 0 1 42.668343 541.411515V181.332724a10.666631 10.666631 0 0 1 10.666631-10.666631h245.332509c0 47.853173-10.373298 92.15969-27.066575 115.632945-5.926647 8.326639-16.566611 14.186619-22.306592 16.113279C204.041135 314.752276 170.667913 356.218803 170.667913 405.331972c0 58.813136 47.853173 106.666308 106.666309 106.666308s106.666308-47.853173 106.666308-106.666308c0-47.086508-30.666564-87.139707-73.079754-101.246327C330.060711 272.705751 341.334007 223.692582 341.334007 170.666093h72.079758a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603a10.666631 10.666631 0 0 1 0 15.079949zM341.334007 405.331972a63.999785 63.999785 0 1 1-63.999785-63.999785 64.073118 64.073118 0 0 1 63.999785 63.999785z m263.539114 559.61812a10.666631 10.666631 0 0 1-15.079949 0L563.499927 938.663513l303.625647-303.61898a53.399821 53.399821 0 0 0 0-75.426413L478.16688 170.666093h63.246455a10.573298 10.573298 0 0 1 7.539974 3.126656l415.998603 415.998603c0.239999 0.239999 0.466665 0.486665 0.666664 0.746664l0.086667 0.106666a10.666631 10.666631 0 0 1 0 13.373289l-0.086667 0.106666c-0.213333 0.259999-0.439999 0.506665-0.666664 0.746664z" fill="#5C5C66" p-id="18681"></path></svg>
        <ul class="post-tags-meta" style="display: inline-block;font-size: 14px;">
            <a href="https://helium.github.io/tags/pgsql/" target="_blank" rel="noopener">Pgsql</a>
        </ul>
      </span>
      
      <span id="busuanzi_container_page_pv" class="x-post-meta-item">
        &nbsp;<svg t="1720844685710" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="27237" width="200" height="200"><path d="M739.754667 574.08c-121.386667 45.610667-208.469333 169.813333-208.64 316.16 0 33.408 4.693333 65.493333 13.141333 95.914667H94.122667c-26.453333-43.52-41.685333-91.946667-41.685334-143.189334 0-185.173333 192.896-335.104 430.805334-335.104 96.256 0 184.832 24.746667 256.512 66.218667z m-280.490667-114.986667a214.869333 214.869333 0 0 1-214.869333-215.04A215.04 215.04 0 0 1 459.264 28.842667a215.04 215.04 0 0 1 215.04 215.210666 215.04 215.04 0 0 1-215.04 215.04zM974.506667 641.28c9.856 0 17.834667 7.466667 17.834666 16.64v59.989333c-0.341333 8.789333-7.850667 15.786667-17.28 16.085334-9.856 0.341333-18.176-6.826667-18.517333-16.085334v-20.053333l-99.114667 91.093333-0.256 0.256a18.474667 18.474667 0 0 1-14.848 4.352h-0.768a18.176 18.176 0 0 1-9.344-4.608l-0.938666-0.981333-85.930667-80.042667-123.562667 115.072a18.773333 18.773333 0 0 1-25.216 0 15.786667 15.786667 0 0 1 0-23.466666l136.149334-126.848 0.725333-0.597334a18.645333 18.645333 0 0 1 24.362667 0.512l87.253333 81.237334 86.058667-79.232h-21.248c-9.386667-0.298667-16.938667-7.338667-17.28-16.085334-0.341333-9.173333 7.381333-16.896 17.28-17.237333h64.64z m-367.146667 240h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v72.192a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042667-16.042666v-72.192c0-8.874667 7.210667-16.042667 16.042667-16.042667z m110.805333-106.666667h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v178.858667a16.042667 16.042667 0 0 1-16.042667 16.042666h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042666v-178.858667c0-8.874667 7.168-16.042667 16.042666-16.042667z m106.538667 80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v99.413333a16.042667 16.042667 0 0 1-16.042667 16.042667H824.746667a16.042667 16.042667 0 0 1-16.042667-16.042667v-99.413333c0-8.874667 7.168-16.042667 16.042667-16.042667z m110.165333-80h48.128c8.874667 0 16.042667 7.168 16.042667 16.042667v179.413333a16.042667 16.042667 0 0 1-16.042667 16.042667h-48.128a16.042667 16.042667 0 0 1-16.042666-16.042667v-179.413333c0-8.874667 7.210667-16.042667 16.042666-16.042667z" fill="#999999" p-id="27238"></path></svg>
        <span id="busuanzi_value_page_pv"></span>
      </span>

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">目录</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e7%ae%80%e5%8d%95%e6%9f%a5%e8%af%a2" aria-label="简单查询">简单查询</a><ul>
                            
                    <li>
                        <a href="#%e5%8d%95%e8%a1%a8%e6%9f%a5%e8%af%a2" aria-label="单表查询">单表查询</a></li>
                    <li>
                        <a href="#%e6%97%a0%e8%a1%a8%e6%9f%a5%e8%af%a2" aria-label="无表查询">无表查询</a></li>
                    <li>
                        <a href="#%e5%8e%bb%e9%87%8d" aria-label="去重">去重</a></li>
                    <li>
                        <a href="#%e6%b3%a8%e9%87%8a" aria-label="注释">注释</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%9d%a1%e4%bb%b6%e6%9f%a5%e8%af%a2" aria-label="条件查询">条件查询</a><ul>
                            
                    <li>
                        <a href="#where" aria-label="WHERE">WHERE</a></li>
                    <li>
                        <a href="#%e6%a8%a1%e5%bc%8f%e5%8c%b9%e9%85%8d" aria-label="模式匹配">模式匹配</a><ul>
                            
                    <li>
                        <a href="#like" aria-label="LIKE">LIKE</a></li>
                    <li>
                        <a href="#not-like" aria-label="NOT LIKE">NOT LIKE</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e7%a9%ba%e5%80%bc%e5%88%a4%e6%96%ad" aria-label="空值判断">空值判断</a><ul>
                            
                    <li>
                        <a href="#is-null" aria-label="IS NULL">IS NULL</a></li>
                    <li>
                        <a href="#is-not-null" aria-label="IS NOT NULL">IS NOT NULL</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%a4%8d%e6%9d%82%e6%9d%a1%e4%bb%b6" aria-label="复杂条件">复杂条件</a><ul>
                            
                    <li>
                        <a href="#and" aria-label="AND">AND</a></li>
                    <li>
                        <a href="#or" aria-label="OR">OR</a></li>
                    <li>
                        <a href="#not" aria-label="NOT">NOT</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%b3%a8%e6%84%8f" aria-label="注意">注意</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%8e%92%e5%ba%8f" aria-label="排序">排序</a><ul>
                            
                    <li>
                        <a href="#%e5%8d%95%e5%88%97%e6%8e%92%e5%ba%8f" aria-label="单列排序">单列排序</a></li>
                    <li>
                        <a href="#%e5%a4%9a%e5%88%97%e6%8e%92%e5%ba%8f" aria-label="多列排序">多列排序</a></li>
                    <li>
                        <a href="#%e7%a9%ba%e5%80%bc%e6%8e%92%e5%ba%8f" aria-label="空值排序">空值排序</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e9%99%90%e5%ae%9a%e7%bb%93%e6%9e%9c%e6%95%b0%e9%87%8f" aria-label="限定结果数量">限定结果数量</a><ul>
                            
                    <li>
                        <a href="#top-n" aria-label="Top-N">Top-N</a></li>
                    <li>
                        <a href="#%e5%88%86%e9%a1%b5" aria-label="分页">分页</a></li>
                    <li>
                        <a href="#%e6%b3%a8%e6%84%8f-1" aria-label="注意">注意</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%88%86%e7%bb%84" aria-label="分组">分组</a><ul>
                            
                    <li>
                        <a href="#%e8%81%9a%e5%90%88%e5%87%bd%e6%95%b0" aria-label="聚合函数">聚合函数</a></li>
                    <li>
                        <a href="#%e5%88%86%e7%bb%84%e8%81%9a%e5%90%88" aria-label="分组聚合">分组聚合</a></li>
                    <li>
                        <a href="#%e5%88%86%e7%bb%84%e8%bf%87%e6%bb%a4" aria-label="分组过滤">分组过滤</a></li>
                    <li>
                        <a href="#%e9%ab%98%e7%ba%a7%e9%80%89%e9%a1%b9" aria-label="高级选项">高级选项</a><ul>
                            
                    <li>
                        <a href="#grouping-sets-%e9%80%89%e9%a1%b9" aria-label="GROUPING SETS 选项">GROUPING SETS 选项</a></li>
                    <li>
                        <a href="#cube-%e9%80%89%e9%a1%b9" aria-label="CUBE 选项">CUBE 选项</a></li>
                    <li>
                        <a href="#rollup-%e9%80%89%e9%a1%b9" aria-label="ROLLUP 选项">ROLLUP 选项</a></li>
                    <li>
                        <a href="#grouping-%e5%87%bd%e6%95%b0" aria-label="GROUPING 函数">GROUPING 函数</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#case-%e6%9d%a1%e4%bb%b6%e8%a1%a8%e8%be%be%e5%bc%8f" aria-label="CASE 条件表达式">CASE 条件表达式</a><ul>
                            
                    <li>
                        <a href="#%e7%ae%80%e5%8d%95-case-%e8%a1%a8%e8%be%be%e5%bc%8f" aria-label="简单 CASE 表达式">简单 CASE 表达式</a></li>
                    <li>
                        <a href="#%e6%90%9c%e7%b4%a2-case-%e8%a1%a8%e8%be%be%e5%bc%8f" aria-label="搜索 CASE 表达式">搜索 CASE 表达式</a></li>
                    <li>
                        <a href="#%e7%bc%a9%e5%86%99%e5%87%bd%e6%95%b0" aria-label="缩写函数">缩写函数</a><ul>
                            
                    <li>
                        <a href="#nullif" aria-label="NULLIF">NULLIF</a></li>
                    <li>
                        <a href="#coalease" aria-label="COALEASE">COALEASE</a>
                    </li>
                </ul>
                </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>
  <div class="post-content"><ul>
<li>SQL 语句不分区大小写，但是通常将关键字（SELECT、 FROM 等）进行大写，其他内容使
用小写，便于阅读。</li>
</ul>
<h2 id="简单查询">简单查询<a hidden class="anchor" aria-hidden="true" href="#简单查询">#</a></h2>
<h3 id="单表查询">单表查询<a hidden class="anchor" aria-hidden="true" href="#单表查询">#</a></h3>
<ol>
<li>查询员工姓氏。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>查询员工薪水。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">annual_income</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>查询所有数据。(在实际项目中，应该避免使用 SELECT *，因为应用程序可能并不需要全部的字段，而且表
结构可能会发生改变，明确指定的字段名称可以减少不确定性。)</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">*</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="无表查询">无表查询<a hidden class="anchor" aria-hidden="true" href="#无表查询">#</a></h3>
<ol>
<li>有的时候，我们可能会遇到这样的查询语句：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="去重">去重<a hidden class="anchor" aria-hidden="true" href="#去重">#</a></h3>
<ol>
<li>查询员工表中的部门编号(去重)。</li>
<li>注意：NULL 的结果并没有去重。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="注释">注释<a hidden class="anchor" aria-hidden="true" href="#注释">#</a></h3>
<ol>
<li>在 PostgreSQL 中，以两个连字符（&ndash;）开始，直到这一行结束的内容表示注释：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 这是标准 SQL 注释方式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>注释的内容会在语法分析之前替换成空格，因此不会被服务器执行。另外， PostgreSQL 还
支持 C 语言风格的注释方法（/* … */）。例如：(注释允许嵌套)</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="w"> </span><span class="cm">/* 这是一个多行注释，
</span></span></span><span class="line"><span class="cl"><span class="cm">DISTINCT 表示排除重复值
</span></span></span><span class="line"><span class="cl"><span class="cm">/* 这是一个嵌套的注释 */
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h2 id="条件查询">条件查询<a hidden class="anchor" aria-hidden="true" href="#条件查询">#</a></h2>
<h3 id="where">WHERE<a hidden class="anchor" aria-hidden="true" href="#where">#</a></h3>
<ol>
<li>WHERE 子句的语法如下：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">column1</span><span class="p">,</span><span class="w"> </span><span class="n">column2</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="k">table</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">conditions</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>查询薪水为 10000 的员工。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>PostgreSQL 提供了以下比较运算符。</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:center">运算符</th>
<th style="text-align:center">描述</th>
<th style="text-align:center">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">=</td>
<td style="text-align:center">等于</td>
<td style="text-align:center">manager_id = 100</td>
</tr>
<tr>
<td style="text-align:center">!=</td>
<td style="text-align:center">不等于</td>
<td style="text-align:center">department_id != 50</td>
</tr>
<tr>
<td style="text-align:center">&lt;&gt;</td>
<td style="text-align:center">不等于</td>
<td style="text-align:center">job_id &lt;&gt; ‘SA_REP’</td>
</tr>
<tr>
<td style="text-align:center">&gt;</td>
<td style="text-align:center">大于</td>
<td style="text-align:center">salary &gt; 10000</td>
</tr>
<tr>
<td style="text-align:center">&gt;=</td>
<td style="text-align:center">大于等于</td>
<td style="text-align:center">hire_date &gt;= ‘2007-01-01’</td>
</tr>
<tr>
<td style="text-align:center">&lt;</td>
<td style="text-align:center">小于</td>
<td style="text-align:center">salary &lt; 15000</td>
</tr>
<tr>
<td style="text-align:center">&lt;=</td>
<td style="text-align:center">小于等于</td>
<td style="text-align:center">employee_id &lt;= 123</td>
</tr>
<tr>
<td style="text-align:center">BETWEEN</td>
<td style="text-align:center">位于范围之内(包含两端的值)</td>
<td style="text-align:center">salary BETWEEN 10000 AND 15000</td>
</tr>
<tr>
<td style="text-align:center">IN</td>
<td style="text-align:center">属于列表之中</td>
<td style="text-align:center">job_id IN (‘AC_MGR’, ‘HR_REP’, ‘IT_PROG’)</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">11000</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="mi">12000</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="模式匹配">模式匹配<a hidden class="anchor" aria-hidden="true" href="#模式匹配">#</a></h3>
<h4 id="like">LIKE<a hidden class="anchor" aria-hidden="true" href="#like">#</a></h4>
<ol>
<li>查询姓氏（last_name）以“Kin”开头的员工。
<ul>
<li>百分号（%）可以匹配零个或者多个任意字符。</li>
<li>下划线（_）可以匹配一个任意字符。</li>
</ul>
</li>
<li>例如：
<ul>
<li>“%en”匹配以“en”结束的字符串。</li>
<li>“%en%”匹配包含“en”的字符串。</li>
<li>“B_g”匹配“Big”、 “Bug”等。</li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="w"> </span><span class="k">LIKE</span><span class="s1">&#39;Kin%&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>如果字符串中存在这两个通配符（%或_），可以在它们前面加上一个反斜杠（\）进行转义。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="mi">1</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;this is 25%&#39;</span><span class="w"> </span><span class="k">LIKE</span><span class="s1">&#39;%25\%&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="4">
<li>也可以通过 ESCAPE 子句指定其他的转义字符。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="mi">1</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;this is 25%&#39;</span><span class="w"> </span><span class="k">LIKE</span><span class="s1">&#39;%25@%&#39;</span><span class="w"> </span><span class="k">ESCAPE</span><span class="s1">&#39;@&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h4 id="not-like">NOT LIKE<a hidden class="anchor" aria-hidden="true" href="#not-like">#</a></h4>
<ol>
<li>NOT LIKE 运算符匹配与 LIKE 相反的结果。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">LIKE</span><span class="s1">&#39;Kin%&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>LIKE 运算符区分大小写， PostgreSQL 同时还提供了不区分大小写的 ILIKE 运算符。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="w"> </span><span class="k">LIKE</span><span class="s1">&#39;kin%&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>更多参看官方文档：<a href="https://www.postgresql.org/docs/current/functions-matching.html" target="_blank" rel="noopener">https://www.postgresql.org/docs/current/functions-matching.html</a></li>
</ol>
<h3 id="空值判断">空值判断<a hidden class="anchor" aria-hidden="true" href="#空值判断">#</a></h3>
<ol>
<li>根据 SQL 标准，空值使用 NULL 表示。 空值是一个特殊值，代表了未知数据。</li>
<li>如果使用常规的比较运算符与 NULL 进行比较，总是返回空值。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">NULL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">       </span><span class="c1">-- 结果为空值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">NULL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">    </span><span class="c1">-- 结果为空值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">NULL</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">   </span><span class="c1">-- 结果为空值
</span></span></span></code></pre></div><h4 id="is-null">IS NULL<a hidden class="anchor" aria-hidden="true" href="#is-null">#</a></h4>
<ol>
<li>查询部门编号为空的员工。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h4 id="is-not-null">IS NOT NULL<a hidden class="anchor" aria-hidden="true" href="#is-not-null">#</a></h4>
<ol>
<li>查询部门编号不为空的员工。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="复杂条件">复杂条件<a hidden class="anchor" aria-hidden="true" href="#复杂条件">#</a></h3>
<ol>
<li>WHERE 子句可以包含多个条件，使用逻辑运算符（AND、 OR、 NOT）将它们进行组合，并根据最终的逻辑值进行过滤。</li>
</ol>
<h4 id="and">AND<a hidden class="anchor" aria-hidden="true" href="#and">#</a></h4>
<ol>
<li>AND（逻辑与）运算符的逻辑真值表如下：
<ul>
<li>对于 AND 运算符，只有当它两边的结果都为真时，最终结果才为真。</li>
<li>否则最终结果为假，不返回结果。</li>
</ul>
</li>
<li>对于 AND 运算符，只有当它两边的结果都为真时，最终结果才为真；否则最终结果为假，不返回结果。</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">TRUE</th>
<th style="text-align:center">FALSE</th>
<th style="text-align:center">NULL</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">TRUE</td>
<td style="text-align:center">TRUE</td>
<td style="text-align:center">FALSE</td>
<td style="text-align:center">NULL</td>
</tr>
<tr>
<td style="text-align:center">FALSE</td>
<td style="text-align:center">FALSE</td>
<td style="text-align:center">FALSE</td>
<td style="text-align:center">FALSE</td>
</tr>
<tr>
<td style="text-align:center">NULL</td>
<td style="text-align:center">NULL</td>
<td style="text-align:center">FALSE</td>
<td style="text-align:center">NULL</td>
</tr>
</tbody>
</table>
<ol start="3">
<li>查询返回薪水为 10000，并且姓氏为“King”的员工。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;King&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h4 id="or">OR<a hidden class="anchor" aria-hidden="true" href="#or">#</a></h4>
<ol>
<li>OR（逻辑或）运算符的逻辑真值表如下：</li>
<li>OR 逻辑或运算符只要有一个条件为真，结果就为真。</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">TRUE</th>
<th style="text-align:center">FALSE</th>
<th style="text-align:center">NULL</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">TRUE</td>
<td style="text-align:center">TRUE</td>
<td style="text-align:center">TRUE</td>
<td style="text-align:center">TRUE</td>
</tr>
<tr>
<td style="text-align:center">FALSE</td>
<td style="text-align:center">TRUE</td>
<td style="text-align:center">FALSE</td>
<td style="text-align:center">NULL</td>
</tr>
<tr>
<td style="text-align:center">NULL</td>
<td style="text-align:center">TRUE</td>
<td style="text-align:center">NULL</td>
<td style="text-align:center">NULL</td>
</tr>
</tbody>
</table>
<ol start="3">
<li>查询返回薪水为 10000，或者姓氏为“King”的员工。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">OR</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;King&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h4 id="not">NOT<a hidden class="anchor" aria-hidden="true" href="#not">#</a></h4>
<ol>
<li>NOT（逻辑非） 运算符用于取反操作，它的逻辑真值表如下：</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">NOT</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">TRUE</td>
<td style="text-align:center">FALSE</td>
</tr>
<tr>
<td style="text-align:center">FALSE</td>
<td style="text-align:center">TRUE</td>
</tr>
<tr>
<td style="text-align:center">NULL</td>
<td style="text-align:center">NULL</td>
</tr>
</tbody>
</table>
<ol start="2">
<li>注意，对于未知的 NULL 值，经过 NOT 处理之后仍然是未知值。</li>
<li>除此之外， NOT 还可以结合前面介绍的运算符一起使用：
<ul>
<li>NOT BETWEEN，位于范围之外。</li>
<li>NOT IN，不在列表之中。</li>
<li>NOT LIKE，不匹配模式。</li>
<li>NOT IS NULL，不为空，等价于 IS NOT NULL。</li>
</ul>
</li>
<li>最后，当查询条件包含复杂逻辑时，它们的运算优先级从高到低排列如下：</li>
</ol>
<p>| 条件运算符 | 描述 |
| =, !=, &lt;&gt;, &lt;, &lt;=, &gt;, &gt;= | 比较运算 |
| IS [NOT] NULL, [NOT] LIKE, [NOT] BETWEEN, [NOT] IN, [NOT] EXISTS | 比较运算 |
| NOT | 逻辑否定 |
| AND | 逻辑与 |</p>
<h3 id="注意">注意<a hidden class="anchor" aria-hidden="true" href="#注意">#</a></h3>
<ol>
<li>对于逻辑运算符 AND 和 OR，需要注意的是，它们使用短路运算。</li>
<li>也就是说，只要前面的表达式能够决定最终的结果，不进行后面的计算。</li>
<li>这样能够提高运算效率。因此，以下语句不会产生除零错误：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="4">
<li>还需要注意的一个问题是，当我们组合 AND 和 OR 运算符时， AND 运算符优先级更高，总是先执行。</li>
<li>由于 AND 优先级高，查询返回的是薪水为 24000 并且姓氏为“King”的员工，或者薪水为10000 的员工。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">OR</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">24000</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;King&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="6">
<li>如果相要返回姓氏为“King”，并且薪水为 10000 或 24000 的员工，可以使用括号修改优先级。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">24000</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;King&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h2 id="排序">排序<a hidden class="anchor" aria-hidden="true" href="#排序">#</a></h2>
<h3 id="单列排序">单列排序<a hidden class="anchor" aria-hidden="true" href="#单列排序">#</a></h3>
<ol>
<li>单列排序是指按照某个字段或者表达式进行排序，用法如下：</li>
<li>ORDER BY 表示按照某个字段进行排序， ASC 表示升序排序（Ascending）， DESC 表示降序排序（Descending），默认值为 ASC。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">column1</span><span class="p">,</span><span class="w"> </span><span class="n">column2</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="k">table</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">column1</span><span class="w"> </span><span class="p">[</span><span class="k">ASC</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">DESC</span><span class="p">];</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>查询部门编号为 60 的员工，并且按照薪水从高到低进行排序显示。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="多列排序">多列排序<a hidden class="anchor" aria-hidden="true" href="#多列排序">#</a></h3>
<ol>
<li>对于单列排序，有可能存在多个数据值相同的情况。此时，可以再指定其他的排序字段进行处理。</li>
<li>首先基于第一个排序字段进行排序，对于可能存在的相同值，再基于第二个字段进行排序，依此类推。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">column1</span><span class="p">,</span><span class="w"> </span><span class="n">column2</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="k">table</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">column1</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span><span class="w"> </span><span class="n">column2</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="p">...;</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>查询返回部门编号为 60 的员工，并且按照薪水从高到低进行排序显示，如果薪水相同，再按照名字（first_name）降序排列。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="w"> </span><span class="k">DESC</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="4">
<li>ORDER BY 后的排序字段可以是 SELECT 列表中没有的字段。以下语句返回了员工的姓名和薪水，按照入职先后进行显示。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 默认升序 ASC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">hire_date</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="5">
<li>除了在 ORDER BY 后指定字段名或者表达式之外，也可以简单的使用它们在 SELECT 列表中出现的顺序来表示。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 默认升序 ASC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="mi">1</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="mi">3</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="6">
<li>PostgreSQL 对于字符类型的数据进行排序时不区分大小写，“CAT”和“cat”顺序相同。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">tbl_char</span><span class="p">(</span><span class="n">c1</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">tbl_char</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;CAT&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;dog&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">*</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">tbl_char</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">c1</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="空值排序">空值排序<a hidden class="anchor" aria-hidden="true" href="#空值排序">#</a></h3>
<ol>
<li>在 SQL 中，空值是一个特殊的值，使用 NULL 表示。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">commission_pct</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Peter&#39;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">commission_pct</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>PostgreSQL 支持使用 NULLS FIRST（空值排在最前）和 NULLS LAST（空值排在最后）指定空值的排序位置；升序排序时默认为 NULLS LAST，降序排序时默认为 NULLS FIRST。</li>
<li>我们修改上面的示例，将“Peter Vargas”排在最前，但仍然按照佣金百分比进行升序显示。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">commission_pct</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Peter&#39;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">commission_pct</span><span class="w"> </span><span class="n">NULLS</span><span class="w"> </span><span class="k">FIRST</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h2 id="限定结果数量">限定结果数量<a hidden class="anchor" aria-hidden="true" href="#限定结果数量">#</a></h2>
<h3 id="top-n">Top-N<a hidden class="anchor" aria-hidden="true" href="#top-n">#</a></h3>
<ol>
<li>这类查询通常是为了找出排名中的前 N 个记录，例如以下语句查询薪水最高的前 10 名员工，使用 FETCH 语法：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FETCH</span><span class="w"> </span><span class="k">FIRST</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">ROWS</span><span class="w"> </span><span class="k">ONLY</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>其中，FIRST 也可以写成 NEXT，ROWS 也可以写成 ROW。结果返回了排序之后的前 10 条记录。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FETCH</span><span class="w"> </span><span class="k">NEXT</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="k">ONLY</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>使用 LIMIT 语法也可以实现相同的功能。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="分页">分页<a hidden class="anchor" aria-hidden="true" href="#分页">#</a></h3>
<ol>
<li>SQL 实现这种功能需要引入另一个子句：OFFSET。</li>
<li>假设我们的应用提供了分页显示，每页显示 10 条记录。现在用户点击了下一页，需要显示第 11 到第 20 条记录。使用标准 SQL 语法实现如下：
<ul>
<li>OFFSET 表示先忽略掉多少行数据，然后再返回后面的结果。 ROWS 也可以写成 ROW。</li>
<li>对于应用程序而言，只需要传入不同的 OFFSET 偏移量和FETCH 数量，就可以在结果中任意导航。</li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">OFFSET</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">ROWS</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FETCH</span><span class="w"> </span><span class="k">FIRST</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">ROWS</span><span class="w"> </span><span class="k">ONLY</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>使用 LIMIT 加上 OFFSET 同样可以实现分页效果。(不支持 LIMIT 10, 10)</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">OFFSET</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="注意-1">注意<a hidden class="anchor" aria-hidden="true" href="#注意-1">#</a></h3>
<ol>
<li>我们先看一下完整的 FETCH 和 LIMIT 语法：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">column1</span><span class="p">,</span><span class="w"> </span><span class="n">column2</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="k">table</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="k">WHERE</span><span class="w"> </span><span class="n">conditions</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">column1</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span><span class="w"> </span><span class="n">column2</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="p">...]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="k">OFFSET</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="err">{</span><span class="k">ROW</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ROWS</span><span class="err">}</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="k">FETCH</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="k">FIRST</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NEXT</span><span class="w"> </span><span class="err">}</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="n">num_rows</span><span class="p">]</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="k">ROW</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ROWS</span><span class="w"> </span><span class="err">}</span><span class="w"> </span><span class="k">ONLY</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">column1</span><span class="p">,</span><span class="w"> </span><span class="n">column2</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="k">table</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="k">WHERE</span><span class="w"> </span><span class="n">conditions</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">column1</span><span class="w"> </span><span class="k">ASC</span><span class="p">,</span><span class="w"> </span><span class="n">column2</span><span class="w"> </span><span class="k">DESC</span><span class="p">,</span><span class="w"> </span><span class="p">...]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="k">LIMIT</span><span class="w"> </span><span class="err">{</span><span class="w"> </span><span class="n">num_rows</span><span class="o">|</span><span class="w"> </span><span class="k">ALL</span><span class="w"> </span><span class="err">}</span><span class="w"> </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="k">OFFSET</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="err">{</span><span class="k">ROW</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ROWS</span><span class="err">}</span><span class="p">];</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>在使用以上功能时需要注意以下问题：
<ul>
<li>FETCH 是标准 SQL 语法， LIMIT 是 PostgreSQL 扩展语法。</li>
<li>如果没有指定 ORDER BY，限定数量之前并没有进行排序，是一个随意的结果。</li>
<li>OFFSET 偏移量必须为 0 或者正整数。默认为 0， NULL 等价于 0。</li>
<li>FETCH 限定的数量必须为 0 或者正整数。默认为 1， NULL 等价于不限定数量。</li>
<li>LIMIT 限定的数量必须为 0 或者正整数， 没有默认值。ALL 或者 NULL 表示不限定数量。</li>
<li>随着 OFFSET 的增加，查询的性能会越来越差。因为服务器需要计算更多的偏移量，即使这些数据不需要被返回前端。</li>
</ul>
</li>
</ol>
<h2 id="分组">分组<a hidden class="anchor" aria-hidden="true" href="#分组">#</a></h2>
<h3 id="聚合函数">聚合函数<a hidden class="anchor" aria-hidden="true" href="#聚合函数">#</a></h3>
<ol>
<li>聚合函数（aggregate function）针对一组数据行进行运算，并且返回单个结果。</li>
<li>PostgreSQL支持以下常见的聚合函数：
<ul>
<li>AVG - 计算一组值的平均值。</li>
<li>COUNT - 统计一组值的数量。</li>
<li>MAX - 计算一组值的最大值。</li>
<li>MIN - 计算一组值的最小值。</li>
<li>SUM - 计算一组值的和值。</li>
<li>STRING_AGG - 连接一组字符串。</li>
</ul>
</li>
<li>查询 IT 部门所有员工的平均薪水、员工总数、最高薪水、最低薪水、以及薪水总计：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AVG</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MAX</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MIN</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="4">
<li>关于聚合函数，需要注意两点：
<ul>
<li>函数参数前添加 DISTINCT 关键字，可以在计算时排除重复值。</li>
<li>忽略参数中的 NULL 值。</li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">commission_pct</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="5">
<li>PostgreSQL 为聚合函数提供了一个 FILTER 扩展选项，可以用于汇总满足特定条件的数据。
<ul>
<li>其中，FILTER 选项可以指定一个 WHERE 条件，只有满足条件的数据才会进行汇总。</li>
<li>因此，示例中的第一个 COUNT 函数返回了月薪大于等于 10000 的员工数量， 第二个 COUNT 函数返回了月薪小于 10000 的员工数量。</li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">FILTER</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">high_sal</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">FILTER</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">low_sal</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="6">
<li>STRING_AGG 函数将 IT 部门员工的名字使用分号进行分隔，按照薪水从高到低排序后连接成一个字符串。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">STRING_AGG</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">first_name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;;&#39;</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="7">
<li>更多聚合函数参看官方文档：<a href="https://www.postgresql.org/docs/current/functions-aggregate.html" target="_blank" rel="noopener">https://www.postgresql.org/docs/current/functions-aggregate.html</a></li>
</ol>
<h3 id="分组聚合">分组聚合<a hidden class="anchor" aria-hidden="true" href="#分组聚合">#</a></h3>
<ol>
<li>每个部门内所有员工的平均薪水、员工总数、最高薪水、最低薪水、以及薪水总计。
<ul>
<li>查询执行时，首先根据 GROUP BY 子句中的列（department_id）进行分组，然后使用聚合函数汇总组内的数据。</li>
<li>最后一条数据是针对部门编号字段为空的数据进行的分组汇总，GROUP BY 将所有的 NULL 分为一组。</li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AVG</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MAX</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MIN</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>GROUP BY 并不一定需要与聚合函数一起使用。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>查询的结果就是不同的部门编号分组，这种查询的结果与 DISTINCT 效果相同。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="4">
<li>GROUP BY 不仅可以按照一个字段进行分组，也可以使用多个字段将数据分成更多的组。</li>
<li>查询将员工按照不同的部门和职位组合进行分组，然后进行汇总。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">job_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AVG</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MAX</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MIN</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="p">,</span><span class="w"> </span><span class="n">job_id</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="p">,</span><span class="w"> </span><span class="n">job_id</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="6">
<li>使用了 GROUP BY 子句进行分组操作之后需要注意一点，就是 SELECT 列表中只能出现分组字段或者聚合函数，不能再出现表中的其他字段。下面是一个错误的示例：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">job_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AVG</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MAX</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MIN</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="7">
<li>错误的原因在于 job_id 既不是分组的条件，也不是聚合函数。查询要求按照部门进行分组汇总，但是每个部门存在多个不同的职位，数据库无法知道需要显示哪个职位编号。</li>
</ol>
<h3 id="分组过滤">分组过滤<a hidden class="anchor" aria-hidden="true" href="#分组过滤">#</a></h3>
<ol>
<li>例如找出平均薪水值大于 10000 的部门，直观的想法就是在 WHERE 子句中增加一个过滤条件，例如：
<ul>
<li>不过查询并没有返回期望的结果，而是出现了一个错误： WHERE 子句中不允许出现聚合函数。</li>
<li>因为在 SQL 询中，如果同时存在 WHERE 子句和 GROUP BY 子句，WHERE 子句在 GROUP BY 子句之前执行。</li>
<li>因此，WHERE 子句无法对分组后的结果进行过滤。</li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AVG</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MAX</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MIN</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AVG</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10000</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>WHERE 子句执行时还没有进行分组计算，它只能基于分组之前的数据进行过滤。如果需要对分组后的结果进行过滤，需要使用 HAVING 子句。以上查询的正确写法如下：
<ul>
<li>HAVING 出现在 GROUP BY 之后，也在它之后执行，因此能够使用聚合函数进行过滤。</li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AVG</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MAX</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">MIN</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">AVG</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">salary</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10000</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>我们可以同时使用 WHERE 子句进行数据行的过滤，使用 HAVING 进行分组结果的过滤。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">headcount</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">salary</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10000</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">department_id</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">HAVING</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">COUNT</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">-- 这里 COUNT(*) 修改为 headcount 报错
</span></span></span></code></pre></div><h3 id="高级选项">高级选项<a hidden class="anchor" aria-hidden="true" href="#高级选项">#</a></h3>
<ul>
<li>PostgreSQL 除了支持基本的 GROUP BY 分组操作之外，还支持 3 种高级的分组选项：GROUPING SETS、 ROLLUP 以及 CUBE。</li>
</ul>
<h4 id="grouping-sets-选项">GROUPING SETS 选项<a hidden class="anchor" aria-hidden="true" href="#grouping-sets-选项">#</a></h4>
<ol>
<li>GROUPING SETS 是 GROUP BY 的扩展选项，用于指定自定义的分组集。举例来说，以下是一个销售数据表：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">sales</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">item</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">year</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">quantity</span><span class="w"> </span><span class="nb">INT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">sales</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;apple&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2018&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">800</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">sales</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;apple&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2018&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">sales</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;banana&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2018&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">500</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">sales</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;banana&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2018&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">600</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">sales</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;apple&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2019&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1200</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">sales</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;banana&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2019&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1800</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>按照产品（item）和年度（year）进行分组汇总时，所有可能的 4 种分组集包括：
<ul>
<li>按照产品和年度的组合进行分组；</li>
<li>按照产品进行分组；</li>
<li>按照年度进行分组；</li>
<li>所有数据分为一组。</li>
</ul>
</li>
<li>可以通过以下多个查询获取所有分组集的分组结果：(将四种查询结果合并到一起)</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 按照产品和年度的组合进行分组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">item</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">YEAR</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">item</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">YEAR</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 按照产品进行分组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">item</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">NULL</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">YEAR</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">item</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 按照年度进行分组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">item</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">YEAR</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">YEAR</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 所有数据分为一组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">AS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">item</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">NULL</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">YEAR</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="4">
<li>使用集合运算符（UNION ALL）将 4 个查询结果合并到一起。但是这种方法存在一些问题：首先，查询语句比较冗长，查询的次数随着分组字段的增加呈指数增长；其次，多次查询意味着需要多次扫描同一张表，存在性能上的问题。</li>
<li>GROUPING SETS 是 GROUP BY 的扩展选项，能够为这种查询需求提供更加简单有效的解决方法。我们使用分组集改写上面的示例：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">item</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">YEAR</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">GROUPING</span><span class="w"> </span><span class="k">SETS</span><span class="w"> </span><span class="p">(</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="k">YEAR</span><span class="w"> </span><span class="p">),</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="p">),</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="k">YEAR</span><span class="w"> </span><span class="p">),</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><ol start="6">
<li>GROUPING SETS 选项用于定义分组集，每个分组集都需要包含在单独的括号中，空白的括号（()）表示将所有数据当作一个组处理。</li>
<li>查询的结果等于前文 4 个查询的合并结果，但是语句更少，可读性更强；而且 PostgreSQL 执行时只需要扫描一次销售表，性能更加优化。</li>
<li>默认的 GROUP BY 使用由所有分组字段构成的一个分组集，本示例中为 ((item, year))。</li>
</ol>
<h4 id="cube-选项">CUBE 选项<a hidden class="anchor" aria-hidden="true" href="#cube-选项">#</a></h4>
<ol>
<li>随着分组字段的增加，即使通过 GROUPING SETS 列出所有可能的分组方式也会显得比较麻烦。</li>
<li>设想一下使用 4 个字段进行分组统计的场景，所有可能的分组集共计有 16 个。这种情况下编写查询语句仍然很复杂，为此 PostgreSQL 提供了简写形式的 GROUPING SETS：CUBE和ROLLUP。</li>
<li>CUBE 表示所有可能的分组集，例如：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CUBE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="n">c3</span><span class="w"> </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 等价于：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUPING</span><span class="w"> </span><span class="k">SETS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="n">c3</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c3</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="n">c3</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">c3</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><ol start="4">
<li>因此，我们可以进一步将上面的示例改写如下：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">item</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">YEAR</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">CUBE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="k">YEAR</span><span class="w"> </span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><h4 id="rollup-选项">ROLLUP 选项<a hidden class="anchor" aria-hidden="true" href="#rollup-选项">#</a></h4>
<ol>
<li>GROUPING SETS 第二种简写形式就是 ROLLUP，用于生成按照层级进行汇总的结果，类似于财务报表中的小计、合计和总计。例如：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">ROLLUP</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="n">c3</span><span class="w"> </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 等价于：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUPING</span><span class="w"> </span><span class="k">SETS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="n">c3</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="w"> </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>查询返回按照产品和年度组合进行统计的销量小计，加上按照产品进行统计的销量合计，再加上所有销量的总计：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">item</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">YEAR</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">ROLLUP</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="k">YEAR</span><span class="w"> </span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>查看结果时，需要根据每个字段上的空值进行判断。比如第一行的产品和年度都为空，因此它是所有销量的总计。为了便于查看，可以将空值进行转换显示：
<ul>
<li>COALESCE 函数返回第一个非空的参数值。</li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">COALESCE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;所有产品&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s2">&#34;产品&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">COALESCE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">YEAR</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;所有年度&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s2">&#34;年度&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s2">&#34;销量&#34;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">ROLLUP</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="k">YEAR</span><span class="w"> </span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><ol start="4">
<li>可以根据需要返回按照某些组合进行统计的结果，以下查询返回按照产品和年度组合进行统计的销量小计，加上按照产品进行统计的销量合计：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">COALESCE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;所有产品&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s2">&#34;产品&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">COALESCE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">YEAR</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;所有年度&#39;</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s2">&#34;年度&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s2">&#34;销量&#34;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="k">ROLLUP</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">YEAR</span><span class="w"> </span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><ol start="5">
<li>对于 CUBE 和 ROLLUP 而言，每个元素可以是单独的字段或表达式，也可以是使用括号包含的列表。如果是括号中的列表，产生分组集时它们必须作为一个整体。例如：
<ul>
<li>因为 c1 和 c2 是一个整体， c3 和 c4 是一个整体。</li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CUBE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">c3</span><span class="p">,</span><span class="w"> </span><span class="n">c4</span><span class="p">)</span><span class="w"> </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 等价于
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUPING</span><span class="w"> </span><span class="k">SETS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="n">c3</span><span class="p">,</span><span class="w"> </span><span class="n">c4</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">c3</span><span class="p">,</span><span class="w"> </span><span class="n">c4</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">ROLLUP</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="n">c3</span><span class="p">),</span><span class="w"> </span><span class="n">c4</span><span class="w"> </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 等价于
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUPING</span><span class="w"> </span><span class="k">SETS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="n">c3</span><span class="p">,</span><span class="w"> </span><span class="n">c4</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">c1</span><span class="p">,</span><span class="w"> </span><span class="n">c2</span><span class="p">,</span><span class="w"> </span><span class="n">c3</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">c1</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><h4 id="grouping-函数">GROUPING 函数<a hidden class="anchor" aria-hidden="true" href="#grouping-函数">#</a></h4>
<ol>
<li>区分是分组产生的 NULL 还是源数据中的 NULL。PostgreSQL 提供了一个分组函数： GROUPING。
<ul>
<li>GROUPING 函数如果只有一个参数，返回整数 0 或者 1。</li>
<li>如果某个统计结果使用的分组集包含了函数中的参数字段，该函数返回 0，否则返回 1。</li>
</ul>
</li>
<li>GROUPING 函数如果包含多个参数，针对每个参数返回整数 0 或者 1，然后将它们按照二进制数值连接到一起。比如说，第1行数据中的GROUPING(item, year)结果等于GROUPING(item)和 GROUPING(year)结果的二进制数值连接，也就是 3（二进制的 11）</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">item</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s2">&#34;产品&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">YEAR</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s2">&#34;年度&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s2">&#34;销量&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">GROUPING</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">GROUPING</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">YEAR</span><span class="w"> </span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">GROUPING</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="k">YEAR</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">ROLLUP</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="k">YEAR</span><span class="w"> </span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>通过使用 GROUPING 函数，我们可以正确显示分组中的 NULL 值和源数据中的 NULL 值：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">GROUPING</span><span class="p">(</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s1">&#39;所有产品&#39;</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="n">item</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s2">&#34;产品&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">GROUPING</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">YEAR</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s1">&#39;所有年度&#39;</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="k">YEAR</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s2">&#34;年度&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">quantity</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s2">&#34;销量&#34;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sales</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">ROLLUP</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">item</span><span class="p">,</span><span class="w"> </span><span class="k">YEAR</span><span class="w"> </span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><h2 id="case-条件表达式">CASE 条件表达式<a hidden class="anchor" aria-hidden="true" href="#case-条件表达式">#</a></h2>
<ul>
<li>CASE 表达式的作用就是为 SQL 语句增加类似于 IF-THEN-ELSE 的逻辑处理功能，可以根据不同的条件返回不同的结果。</li>
<li>PostgreSQL 支持两种形式的条件表达式：简单 CASE 表达式和搜索 CASE 表达式。</li>
<li>另外，为了方便空值处理，PostgreSQL 还提供了两个缩写形式的 CASE 表达式（函数）：NULLIF 和 COALEASE。</li>
</ul>
<h3 id="简单-case-表达式">简单 CASE 表达式<a hidden class="anchor" aria-hidden="true" href="#简单-case-表达式">#</a></h3>
<ol>
<li>简单 CASE 表达式的语法如下：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CASE</span><span class="w"> </span><span class="n">expression</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">value1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">result1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">value2</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">result2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">[...]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">[</span><span class="k">ELSE</span><span class="w"> </span><span class="n">default_result</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">END</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>
<p>表达式的计算过程如下所示。</p>
<ul>
<li>首先计算表达式（expression）的值，然后依次与 WHEN 列表中的值（value1， value2， …）进行比较。</li>
<li>找到第一个匹配的值，然后返回对应 THEN 列表中的结果（result1， result2， …）。</li>
<li>如果没有找到匹配的值，返回 ELSE 中的默认值。如果没有指定 ELSE，返回 NULL。</li>
</ul>
</li>
<li>
<p>下面的查询使用简单 CASE 表达式统计每个部门的人数，并且转换为列的方式显示。</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">CASE</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dept_10_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">CASE</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dept_20_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">CASE</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dept_30_count</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | dept_10_count|dept_20_count|dept_30_count|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |--------------|-------------|-------------|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |    1         |     2       |   6         |
</span></span></span></code></pre></div><ol start="4">
<li>需要注意的是每个分支的结果必须具有相同的数据类型，否则会产生类型错误。</li>
<li>例如，以下示例对于不同条件返回的数据类型不一致：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">CASE</span><span class="w"> </span><span class="n">department_id</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Administration&#39;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">20</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;Purchasing&#39;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;Others&#39;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">department_name</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- SQL 错误 [22P02]: ERROR: invalid input syntax for integer: &#34;Others&#34; Position: 183
</span></span></span></code></pre></div><ol start="6">
<li>简单 CASE 表达式在进行计算的时候，使用的是等值比较（=），能够支持简单的逻辑处理。</li>
<li>如果想要基于更加复杂的条件进行判断，例如根据某个列的取值范围返回不同的信息，或者判断表达式的值是否为空，都需要使用更加强大的搜索 CASE 表达式。</li>
</ol>
<h3 id="搜索-case-表达式">搜索 CASE 表达式<a hidden class="anchor" aria-hidden="true" href="#搜索-case-表达式">#</a></h3>
<ol>
<li>搜索 CASE 表达式的语法如下：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">condition1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">result1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">condition2</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">result2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">[</span><span class="k">ELSE</span><span class="w"> </span><span class="n">default_result</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">END</span><span class="w"> 
</span></span></span></code></pre></div><ol start="2">
<li>表达式的计算过程如下所示。
<ul>
<li>按照顺序依次计算 WHEN 子句中的条件（condition1, condition2, …），找到第一个结果为真的分支，返回相应的结果。</li>
<li>如果没有任何条件为真，返回 ELSE 中的默认值；如果此时没有指定 ELSE，返回空值。</li>
</ul>
</li>
<li>搜索 CASE 表达式可以在 WHEN 子句中构造复杂的条件，完成各种逻辑处理。首先，所有的简单 CASE 表达式都可以替换称等价的搜索CASE 表达式。我们将前面的示例改写如下：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dept_10_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dept_20_count</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SUM</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">department_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">dept_30_count</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- | dept_10_count|dept_20_count|dept_30_count|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |--------------|-------------|-------------|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |    1         |     2       |   6         |
</span></span></span></code></pre></div><ol start="4">
<li>以下示例根据薪水的范围将员工的收入分为高中低三个档次：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">e</span><span class="p">.</span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;低&#39;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">15000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;中&#39;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ELSE</span><span class="s1">&#39;高&#39;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">salary_level</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><ol start="5">
<li>既然是表达式， CASE 表达式除了可以用于 SELECT 列表，也可以出现在其他 SQL 子句中，例如 WHERE 条件子句、 GROUP BY 分组子句、 ORDER BY 排序子句等。以下示例除了将薪水显示为三个档次，同时还按照档次和名字进行排序：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">e</span><span class="p">.</span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;低&#39;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">15000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="s1">&#39;中&#39;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ELSE</span><span class="w"> </span><span class="s1">&#39;高&#39;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">END</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">salary_level</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">3</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">salary</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">15000</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">2</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">1</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">END</span><span class="p">,</span><span class="w"> </span><span class="n">first_name</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="缩写函数">缩写函数<a hidden class="anchor" aria-hidden="true" href="#缩写函数">#</a></h3>
<ol>
<li>除了以上两种形式的 CASE 表达式之外， PostgreSQL 还提供了两个与 NULL 相关的缩写 CASE 表达式（函数）： NULLIF 和 COALEASE。</li>
</ol>
<h4 id="nullif">NULLIF<a hidden class="anchor" aria-hidden="true" href="#nullif">#</a></h4>
<ol>
<li>函数的用法如下：
<ul>
<li>NULLIF 函数包含 2 个参数，如果第一个参数等于第二个参数，返回 NULL。</li>
<li>否则，返回第一个参数的值。</li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">NULLIF</span><span class="p">(</span><span class="n">expression_1</span><span class="p">,</span><span class="w"> </span><span class="n">expression_2</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>它可以使用等价的 CASE 表达式表示为：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">expression_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expression_2</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">ELSE</span><span class="w"> </span><span class="n">expression_1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">END</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>以下示例说明了 NULLIF 函数的效果：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">NULLIF</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="k">NULLIF</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;B&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- |nullif|nullif(1)|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |------|---------|
</span></span></span><span class="line"><span class="cl"><span class="c1">-- |NULL  |A        |
</span></span></span></code></pre></div><ol start="4">
<li>NULLIF 函数的一个常见用途是防止除零错误：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">-- 除零错误
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="k">NULLIF</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><h4 id="coalease">COALEASE<a hidden class="anchor" aria-hidden="true" href="#coalease">#</a></h4>
<ol>
<li>函数的语法如下：
<ul>
<li>COALESCE 函数接受多个参数，并且返回第一个非空的参数值。</li>
<li>如果所有参数都为空值，返回 NULL 值。</li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">COALESCE</span><span class="p">(</span><span class="n">expression_1</span><span class="p">,</span><span class="w"> </span><span class="n">expression_2</span><span class="p">,</span><span class="w"> </span><span class="n">expression_3</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span><span class="w">
</span></span></span></code></pre></div><ol start="2">
<li>它可以使用等价的 CASE 表达式表示为：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CASE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">expression_1</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">expression_1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">expression_2</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">expression_2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHEN</span><span class="w"> </span><span class="n">expression_3</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="n">expression_3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">END</span><span class="w">
</span></span></span></code></pre></div><ol start="3">
<li>以下示例将佣金比率为空的数据显示为 0：</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">e</span><span class="p">.</span><span class="n">first_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">e</span><span class="p">.</span><span class="n">last_name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">e</span><span class="p">.</span><span class="n">commission_pct</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">COALESCE</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">commission_pct</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">employees</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://helium.github.io/tags/pgsql/">Pgsql</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://helium.github.io/posts/postgresql/database/">
    <span class="title">« 上一页</span>
    <br>
    <span>数据库与模式</span>
  </a>
  <a class="next" href="https://helium.github.io/posts/grpc/mode/">
    <span class="title">下一页 »</span>
    <br>
    <span>通信模式</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    
    <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv">
        本站总访问量<span id="busuanzi_value_site_pv"></span>次
    </span>
    <span id="busuanzi_container_site_uv">
        本站访客数<span id="busuanzi_value_site_uv"></span>人次
    </span>
    </div>
        <span>Copyright © 2024 蜀ICP备2024091074号 <a href="#">heliu's blog</a>. All rights reserved</span>  
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Done';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
